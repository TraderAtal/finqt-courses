<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <title>ML for Finance ‚Äî FinQT</title>
    <style>
/* === Reset & Base === */
*, *::before, *::after {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
}

:root {
    --bg: #0a0a0a;
    --bg-secondary: #111111;
    --bg-sidebar: #0d0d0d;
    --text: #e0e0e0;
    --text-dim: #888888;
    --green: #00c853;
    --green-dim: #1b5e20;
    --green-glow: rgba(0, 200, 83, 0.15);
    --code-bg: #141420;
    --border: #1e1e1e;
    --header-height: 52px;
}

html {
    font-size: 16px;
    -webkit-text-size-adjust: 100%;
}

body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    background: var(--bg);
    color: var(--text);
    line-height: 1.65;
    overflow-x: hidden;
    -webkit-font-smoothing: antialiased;
}

/* === Header === */
.header {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    height: var(--header-height);
    background: var(--bg-secondary);
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    padding: 0 16px;
    z-index: 1000;
    gap: 12px;
}

.hamburger {
    background: none;
    border: none;
    color: var(--text);
    font-size: 22px;
    cursor: pointer;
    padding: 6px;
    border-radius: 6px;
    line-height: 1;
    flex-shrink: 0;
}
.hamburger:hover {
    background: rgba(255,255,255,0.08);
}

.header-title {
    font-size: 15px;
    font-weight: 600;
    color: var(--green);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.header-module {
    font-size: 13px;
    color: var(--text-dim);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    margin-left: auto;
}

/* === Sidebar === */
.sidebar-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.6);
    z-index: 1001;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s;
}
.sidebar-overlay.open {
    opacity: 1;
    pointer-events: auto;
}

.sidebar {
    position: fixed;
    top: 0;
    left: 0;
    bottom: 0;
    width: 280px;
    max-width: 85vw;
    background: var(--bg-sidebar);
    border-right: 1px solid var(--border);
    z-index: 1002;
    transform: translateX(-100%);
    transition: transform 0.25s ease;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
    padding-top: 12px;
    padding-bottom: 24px;
}
.sidebar.open {
    transform: translateX(0);
}

.sidebar-header {
    padding: 12px 16px 16px;
    border-bottom: 1px solid var(--border);
    margin-bottom: 8px;
}
.sidebar-header h2 {
    font-size: 15px;
    color: var(--green);
    font-weight: 600;
}

.sidebar-part {
    padding: 10px 16px 4px;
    font-size: 11px;
    font-weight: 700;
    color: var(--text-dim);
    text-transform: uppercase;
    letter-spacing: 0.6px;
}

.sidebar-item {
    display: block;
    padding: 8px 16px 8px 24px;
    font-size: 13px;
    color: var(--text);
    text-decoration: none;
    cursor: pointer;
    border-left: 3px solid transparent;
    transition: all 0.15s;
}
.sidebar-item:hover {
    background: rgba(255,255,255,0.04);
}
.sidebar-item.active {
    color: var(--green);
    border-left-color: var(--green);
    background: var(--green-glow);
    font-weight: 600;
}

/* === Main Content === */
.main {
    margin-top: var(--header-height);
    padding: 20px 16px 80px;
    max-width: 800px;
    margin-left: auto;
    margin-right: auto;
}

.module-section {
    display: none;
}
.module-section.active {
    display: block;
}

/* === Typography === */
.md-cell h1 {
    font-size: 1.7rem;
    font-weight: 700;
    color: var(--green);
    margin: 1.5em 0 0.5em;
    line-height: 1.25;
}
.md-cell h2 {
    font-size: 1.35rem;
    font-weight: 600;
    color: var(--green);
    margin: 1.4em 0 0.4em;
    padding-bottom: 6px;
    border-bottom: 1px solid var(--border);
}
.md-cell h3 {
    font-size: 1.1rem;
    font-weight: 600;
    color: #cccccc;
    margin: 1.2em 0 0.3em;
}
.md-cell h4, .md-cell h5, .md-cell h6 {
    font-size: 1rem;
    font-weight: 600;
    color: #bbbbbb;
    margin: 1em 0 0.3em;
}

.md-cell p {
    margin: 0.6em 0;
}

.md-cell a {
    color: var(--green);
    text-decoration: none;
}
.md-cell a:hover {
    text-decoration: underline;
}

.md-cell strong {
    color: #f0f0f0;
}

.md-cell ul, .md-cell ol {
    margin: 0.5em 0;
    padding-left: 1.5em;
}
.md-cell li {
    margin: 0.25em 0;
}

.md-cell hr {
    border: none;
    border-top: 1px solid var(--border);
    margin: 1.5em 0;
}

.md-cell blockquote {
    border-left: 3px solid var(--green-dim);
    padding: 0.5em 1em;
    margin: 0.8em 0;
    color: var(--text-dim);
    background: rgba(255,255,255,0.02);
    border-radius: 0 6px 6px 0;
}

/* Inline code (not inside pre blocks) */
.md-cell code {
    background: rgba(255,255,255,0.08);
    padding: 2px 6px;
    border-radius: 3px;
    font-family: "SF Mono", "Fira Code", "Cascadia Code", Menlo, monospace;
    font-size: 0.88em;
    color: #e8e8e8;
}
.md-cell pre code {
    background: transparent !important;
    padding: 0;
    border-radius: 0;
    color: inherit;
}

/* Fenced code blocks inside markdown */
.md-cell pre {
    background: var(--code-bg);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 14px 16px;
    overflow-x: auto;
    margin: 0.8em 0;
    -webkit-overflow-scrolling: touch;
}
.md-cell pre code {
    background: none;
    padding: 0;
    border-radius: 0;
    font-size: 0.85rem;
    line-height: 1.5;
    color: #e8e8e8;
}

/* === Module Header (first cell) === */
.module-header {
    padding-bottom: 0.5em;
    margin-bottom: 0.5em;
}
.module-header h1 {
    font-size: 1.8rem;
    margin-top: 0;
}

/* === Tables === */
.table-wrapper {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    margin: 0.8em 0;
    border-radius: 8px;
    border: 1px solid var(--border);
}

.md-cell table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.88rem;
}
.md-cell th {
    background: var(--bg-secondary);
    color: var(--green);
    font-weight: 600;
    text-align: left;
    padding: 10px 12px;
    border-bottom: 2px solid var(--border);
    white-space: nowrap;
}
.md-cell td {
    padding: 8px 12px;
    border-bottom: 1px solid var(--border);
    vertical-align: top;
}
.md-cell tr:last-child td {
    border-bottom: none;
}

/* === Code Cells === */
.code-cell {
    position: relative;
    background: var(--code-bg);
    border: 1px solid var(--border);
    border-radius: 8px;
    margin: 0.6em 0;
    overflow: hidden;
}
.code-cell pre {
    margin: 0;
    padding: 14px 16px;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
}
.code-cell pre code {
    font-family: "SF Mono", "Fira Code", "Cascadia Code", Menlo, monospace;
    font-size: 0.82rem;
    line-height: 1.55;
    background: transparent !important;
    padding: 0;
    border-radius: 0;
}

.copy-btn {
    position: absolute;
    top: 6px;
    right: 6px;
    background: rgba(255,255,255,0.08);
    border: none;
    border-radius: 4px;
    padding: 4px 7px;
    font-size: 13px;
    cursor: pointer;
    opacity: 0;
    transition: opacity 0.15s;
    z-index: 5;
}
.code-cell:hover .copy-btn {
    opacity: 1;
}
.copy-btn:hover {
    background: rgba(255,255,255,0.15);
}
.copy-btn.copied {
    opacity: 1;
}

/* === Exercise Styling === */
.exercise-header {
    background: rgba(0, 200, 83, 0.04);
    border: 1px solid var(--green-dim);
    border-radius: 8px;
    padding: 12px 16px;
    margin: 1em 0 0.3em;
}
.exercise-header h3 {
    color: var(--green);
    margin-top: 0;
}

.exercise-code {
    border-color: var(--green-dim);
}

/* === Solution (details) blocks === */
.solution-block details {
    border-left: 3px solid var(--green);
    border-radius: 0 8px 8px 0;
    margin: 0.5em 0 1em;
    background: rgba(0, 200, 83, 0.03);
}
.solution-block summary {
    padding: 10px 14px;
    cursor: pointer;
    color: var(--green);
    font-weight: 600;
    font-size: 0.9rem;
    user-select: none;
    -webkit-user-select: none;
}
.solution-block summary:hover {
    background: rgba(0, 200, 83, 0.06);
}
.solution-block details[open] summary {
    border-bottom: 1px solid var(--border);
    margin-bottom: 0;
}
.solution-block details > :not(summary) {
    padding: 0 14px;
}
.solution-block details pre {
    margin: 10px 0;
}

/* === Module Project === */
.module-project {
    border: 1px solid var(--green-dim);
    border-radius: 8px;
    padding: 16px;
    margin: 1.5em 0;
    background: rgba(0, 200, 83, 0.03);
}
.module-project h1 {
    font-size: 1.4rem;
}

/* === Key Takeaways === */
.key-takeaways {
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 16px;
    margin: 1.5em 0;
}
.key-takeaways h1 {
    font-size: 1.3rem;
    margin-top: 0;
}

/* === Prev/Next Navigation === */
.nav-buttons {
    display: flex;
    gap: 12px;
    margin-top: 2em;
    padding-top: 1.5em;
    border-top: 1px solid var(--border);
}
.nav-btn {
    flex: 1;
    padding: 12px 16px;
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text);
    font-family: inherit;
    font-size: 0.9rem;
    cursor: pointer;
    text-align: center;
    transition: all 0.15s;
    text-decoration: none;
    -webkit-appearance: none;
    -webkit-tap-highlight-color: rgba(0, 200, 83, 0.2);
}
.nav-btn:hover {
    border-color: var(--green);
    color: var(--green);
}
.nav-btn.disabled {
    opacity: 0.3;
    pointer-events: none;
}
.nav-btn-label {
    display: block;
    font-size: 0.75rem;
    color: var(--text-dim);
    margin-bottom: 2px;
}

/* === Syntax Highlighting (Pygments Monokai) === */
pre { line-height: 125%; }
td.linenos .normal { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
span.linenos { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
td.linenos .special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
span.linenos.special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
.code-cell pre code .hll { background-color: #49483e }
.code-cell pre code { background: #272822; color: #f8f8f2 }
.code-cell pre code .c { color: #75715e } /* Comment */
.code-cell pre code .err { color: #960050; background-color: #1e0010 } /* Error */
.code-cell pre code .esc { color: #f8f8f2 } /* Escape */
.code-cell pre code .g { color: #f8f8f2 } /* Generic */
.code-cell pre code .k { color: #66d9ef } /* Keyword */
.code-cell pre code .l { color: #ae81ff } /* Literal */
.code-cell pre code .n { color: #f8f8f2 } /* Name */
.code-cell pre code .o { color: #f92672 } /* Operator */
.code-cell pre code .x { color: #f8f8f2 } /* Other */
.code-cell pre code .p { color: #f8f8f2 } /* Punctuation */
.code-cell pre code .ch { color: #75715e } /* Comment.Hashbang */
.code-cell pre code .cm { color: #75715e } /* Comment.Multiline */
.code-cell pre code .cp { color: #75715e } /* Comment.Preproc */
.code-cell pre code .cpf { color: #75715e } /* Comment.PreprocFile */
.code-cell pre code .c1 { color: #75715e } /* Comment.Single */
.code-cell pre code .cs { color: #75715e } /* Comment.Special */
.code-cell pre code .gd { color: #f92672 } /* Generic.Deleted */
.code-cell pre code .ge { color: #f8f8f2; font-style: italic } /* Generic.Emph */
.code-cell pre code .gr { color: #f8f8f2 } /* Generic.Error */
.code-cell pre code .gh { color: #f8f8f2 } /* Generic.Heading */
.code-cell pre code .gi { color: #a6e22e } /* Generic.Inserted */
.code-cell pre code .go { color: #66d9ef } /* Generic.Output */
.code-cell pre code .gp { color: #f92672; font-weight: bold } /* Generic.Prompt */
.code-cell pre code .gs { color: #f8f8f2; font-weight: bold } /* Generic.Strong */
.code-cell pre code .gu { color: #75715e } /* Generic.Subheading */
.code-cell pre code .gt { color: #f8f8f2 } /* Generic.Traceback */
.code-cell pre code .kc { color: #66d9ef } /* Keyword.Constant */
.code-cell pre code .kd { color: #66d9ef } /* Keyword.Declaration */
.code-cell pre code .kn { color: #f92672 } /* Keyword.Namespace */
.code-cell pre code .kp { color: #66d9ef } /* Keyword.Pseudo */
.code-cell pre code .kr { color: #66d9ef } /* Keyword.Reserved */
.code-cell pre code .kt { color: #66d9ef } /* Keyword.Type */
.code-cell pre code .ld { color: #e6db74 } /* Literal.Date */
.code-cell pre code .m { color: #ae81ff } /* Literal.Number */
.code-cell pre code .s { color: #e6db74 } /* Literal.String */
.code-cell pre code .na { color: #a6e22e } /* Name.Attribute */
.code-cell pre code .nb { color: #f8f8f2 } /* Name.Builtin */
.code-cell pre code .nc { color: #a6e22e } /* Name.Class */
.code-cell pre code .no { color: #66d9ef } /* Name.Constant */
.code-cell pre code .nd { color: #a6e22e } /* Name.Decorator */
.code-cell pre code .ni { color: #f8f8f2 } /* Name.Entity */
.code-cell pre code .ne { color: #a6e22e } /* Name.Exception */
.code-cell pre code .nf { color: #a6e22e } /* Name.Function */
.code-cell pre code .nl { color: #f8f8f2 } /* Name.Label */
.code-cell pre code .nn { color: #f8f8f2 } /* Name.Namespace */
.code-cell pre code .nx { color: #a6e22e } /* Name.Other */
.code-cell pre code .py { color: #f8f8f2 } /* Name.Property */
.code-cell pre code .nt { color: #f92672 } /* Name.Tag */
.code-cell pre code .nv { color: #f8f8f2 } /* Name.Variable */
.code-cell pre code .ow { color: #f92672 } /* Operator.Word */
.code-cell pre code .w { color: #f8f8f2 } /* Text.Whitespace */
.code-cell pre code .mb { color: #ae81ff } /* Literal.Number.Bin */
.code-cell pre code .mf { color: #ae81ff } /* Literal.Number.Float */
.code-cell pre code .mh { color: #ae81ff } /* Literal.Number.Hex */
.code-cell pre code .mi { color: #ae81ff } /* Literal.Number.Integer */
.code-cell pre code .mo { color: #ae81ff } /* Literal.Number.Oct */
.code-cell pre code .sa { color: #e6db74 } /* Literal.String.Affix */
.code-cell pre code .sb { color: #e6db74 } /* Literal.String.Backtick */
.code-cell pre code .sc { color: #e6db74 } /* Literal.String.Char */
.code-cell pre code .dl { color: #e6db74 } /* Literal.String.Delimiter */
.code-cell pre code .sd { color: #e6db74 } /* Literal.String.Doc */
.code-cell pre code .s2 { color: #e6db74 } /* Literal.String.Double */
.code-cell pre code .se { color: #ae81ff } /* Literal.String.Escape */
.code-cell pre code .sh { color: #e6db74 } /* Literal.String.Heredoc */
.code-cell pre code .si { color: #e6db74 } /* Literal.String.Interpol */
.code-cell pre code .sx { color: #e6db74 } /* Literal.String.Other */
.code-cell pre code .sr { color: #e6db74 } /* Literal.String.Regex */
.code-cell pre code .s1 { color: #e6db74 } /* Literal.String.Single */
.code-cell pre code .ss { color: #e6db74 } /* Literal.String.Symbol */
.code-cell pre code .bp { color: #f8f8f2 } /* Name.Builtin.Pseudo */
.code-cell pre code .fm { color: #a6e22e } /* Name.Function.Magic */
.code-cell pre code .vc { color: #f8f8f2 } /* Name.Variable.Class */
.code-cell pre code .vg { color: #f8f8f2 } /* Name.Variable.Global */
.code-cell pre code .vi { color: #f8f8f2 } /* Name.Variable.Instance */
.code-cell pre code .vm { color: #f8f8f2 } /* Name.Variable.Magic */
.code-cell pre code .il { color: #ae81ff } /* Literal.Number.Integer.Long */

/* === Responsive === */
@media (min-width: 1024px) {
    .sidebar {
        transform: translateX(0);
        top: var(--header-height);
        padding-top: 8px;
        border-top: none;
    }
    .sidebar-overlay {
        display: none;
    }
    .main {
        margin-left: 296px;
    }
    .hamburger {
        display: none;
    }
}

/* Scrollbar styling */
::-webkit-scrollbar {
    width: 6px;
    height: 6px;
}
::-webkit-scrollbar-track {
    background: transparent;
}
::-webkit-scrollbar-thumb {
    background: rgba(255,255,255,0.15);
    border-radius: 3px;
}
::-webkit-scrollbar-thumb:hover {
    background: rgba(255,255,255,0.25);
}
</style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <button class="hamburger" onclick="toggleSidebar()" aria-label="Menu">‚ò∞</button>
        <span class="header-title">ML for Finance</span>
        <span class="header-module"></span>
    </div>

    <!-- Sidebar Overlay -->
    <div class="sidebar-overlay" onclick="closeSidebar()"></div>

    <!-- Sidebar -->
    <nav class="sidebar">
        <div class="sidebar-header">
            <h2>ML for Finance</h2>
        </div>
        <div class="sidebar-part">Overview</div>
<div class="sidebar-item">Course Overview</div>
<div class="sidebar-part">Part 1: ML Fundamentals</div>
<div class="sidebar-item">Module 1: ML Concepts for Traders</div>
<div class="sidebar-item">Module 2: Data Preparation</div>
<div class="sidebar-item">Module 3: Feature Engineering</div>
<div class="sidebar-item">Module 4: Target Engineering</div>
<div class="sidebar-part">Part 2: Classification Models</div>
<div class="sidebar-item">Module 5: Tree-Based Models</div>
<div class="sidebar-item">Module 6: Other Classification Models</div>
<div class="sidebar-item">Module 7: Model Evaluation</div>
<div class="sidebar-part">Part 3: Advanced Techniques</div>
<div class="sidebar-item">Module 8: Regression Models</div>
<div class="sidebar-item">Module 9: Sentiment Analysis</div>
<div class="sidebar-item">Module 10: Alternative Data</div>
<div class="sidebar-part">Part 4: Deep Learning &amp; Production</div>
<div class="sidebar-item">Module 11: Deep Learning for Finance</div>
<div class="sidebar-item">Module 12: Backtesting ML Strategies</div>
<div class="sidebar-item">Module 13: Production ML Systems</div>
<div class="sidebar-item">Module 14: Advanced ML Topics</div>
<div class="sidebar-part">Capstone</div>
<div class="sidebar-item">Capstone Project</div>
    </nav>

    <!-- Main Content -->
    <main class="main">
        <div class="module-section active" data-idx="0"><div class="md-cell module-header"><h1>Course 4: Machine Learning for Financial Markets</h1>
<h2>Course Overview</h2>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Duration</th>
<th>Modules</th>
<th>Exercises</th>
<th>Level</th>
</tr>
</thead>
<tbody>
<tr>
<td>~45 hours</td>
<td>14 + Capstone</td>
<td>~95</td>
<td>Intermediate to Advanced</td>
</tr>
</tbody>
</table></div>
<h3>What You'll Learn</h3>
<ul>
<li>Apply machine learning to predict market movements</li>
<li>Build robust feature engineering pipelines</li>
<li>Train and evaluate classification and regression models</li>
<li>Analyze sentiment from news and social media</li>
<li>Deploy production ML systems with monitoring</li>
<li>Avoid common pitfalls unique to financial ML</li>
</ul></div>
<div class="md-cell"><hr />
<h2>Course Structure</h2>
<h3>Part 1: ML Fundamentals for Finance</h3>
<p>Build the foundation for financial machine learning.</p>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Module</th>
<th>Title</th>
<th>Key Topics</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>ML Concepts for Traders</td>
<td>Supervised/unsupervised, why finance is different</td>
</tr>
<tr>
<td>2</td>
<td>Data Preparation</td>
<td>Time series splits, cross-validation, imbalanced data</td>
</tr>
<tr>
<td>3</td>
<td>Feature Engineering</td>
<td>Price features, technical indicators, statistical features</td>
</tr>
<tr>
<td>4</td>
<td>Target Engineering</td>
<td>Triple barrier method, meta-labeling, lookahead bias</td>
</tr>
</tbody>
</table></div>
<h3>Part 2: Classification Models</h3>
<p>Master the models used for direction prediction.</p>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Module</th>
<th>Title</th>
<th>Key Topics</th>
</tr>
</thead>
<tbody>
<tr>
<td>5</td>
<td>Tree-Based Models</td>
<td>Decision trees, Random Forest, XGBoost, LightGBM</td>
</tr>
<tr>
<td>6</td>
<td>Other Classification Models</td>
<td>Logistic regression, SVM, neural networks</td>
</tr>
<tr>
<td>7</td>
<td>Model Evaluation</td>
<td>Financial metrics, confusion matrix, ROC curves</td>
</tr>
</tbody>
</table></div>
<h3>Part 3: Advanced Techniques</h3>
<p>Expand beyond classification into specialized domains.</p>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Module</th>
<th>Title</th>
<th>Key Topics</th>
</tr>
</thead>
<tbody>
<tr>
<td>8</td>
<td>Regression Models</td>
<td>Return prediction, volatility forecasting, quantile regression</td>
</tr>
<tr>
<td>9</td>
<td>Sentiment Analysis</td>
<td>Text processing, sentiment scoring, news signals</td>
</tr>
<tr>
<td>10</td>
<td>Alternative Data</td>
<td>Web scraping, social media, multi-source features</td>
</tr>
</tbody>
</table></div>
<h3>Part 4: Deep Learning &amp; Production</h3>
<p>Deploy models to production with proper infrastructure.</p>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Module</th>
<th>Title</th>
<th>Key Topics</th>
</tr>
</thead>
<tbody>
<tr>
<td>11</td>
<td>Deep Learning for Finance</td>
<td>Neural networks, LSTM, transformers</td>
</tr>
<tr>
<td>12</td>
<td>Backtesting ML Strategies</td>
<td>Walk-forward optimization, avoiding pitfalls</td>
</tr>
<tr>
<td>13</td>
<td>Production ML Systems</td>
<td>Model deployment, feature pipelines, monitoring</td>
</tr>
<tr>
<td>14</td>
<td>Advanced ML Topics</td>
<td>Reinforcement learning, ensembles, online learning</td>
</tr>
</tbody>
</table></div></div>
<div class="md-cell"><hr />
<h2>Why Financial ML is Different</h2>
<p>Machine learning in finance faces unique challenges that don't exist in other domains:</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Financial ML Challenges</span>

<span class="n">challenges</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;Low Signal-to-Noise&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">&#39;Financial data is extremely noisy&#39;</span><span class="p">,</span>
        <span class="s1">&#39;implication&#39;</span><span class="p">:</span> <span class="s1">&#39;Models easily overfit to noise instead of signal&#39;</span><span class="p">,</span>
        <span class="s1">&#39;solution&#39;</span><span class="p">:</span> <span class="s1">&#39;Robust validation, regularization, feature selection&#39;</span>
    <span class="p">},</span>
    <span class="s1">&#39;Non-Stationarity&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">&#39;Market dynamics change over time&#39;</span><span class="p">,</span>
        <span class="s1">&#39;implication&#39;</span><span class="p">:</span> <span class="s1">&#39;Models trained on past data may not work on future data&#39;</span><span class="p">,</span>
        <span class="s1">&#39;solution&#39;</span><span class="p">:</span> <span class="s1">&#39;Walk-forward validation, adaptive models, regime detection&#39;</span>
    <span class="p">},</span>
    <span class="s1">&#39;Regime Changes&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">&#39;Markets shift between bull/bear/sideways regimes&#39;</span><span class="p">,</span>
        <span class="s1">&#39;implication&#39;</span><span class="p">:</span> <span class="s1">&#39;A model that works in one regime may fail in another&#39;</span><span class="p">,</span>
        <span class="s1">&#39;solution&#39;</span><span class="p">:</span> <span class="s1">&#39;Regime-aware models, ensemble approaches&#39;</span>
    <span class="p">},</span>
    <span class="s1">&#39;Adversarial Environment&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">&#39;Other traders adapt to profitable strategies&#39;</span><span class="p">,</span>
        <span class="s1">&#39;implication&#39;</span><span class="p">:</span> <span class="s1">&#39;Alpha decays as strategies become crowded&#39;</span><span class="p">,</span>
        <span class="s1">&#39;solution&#39;</span><span class="p">:</span> <span class="s1">&#39;Continuous innovation, unique data sources&#39;</span>
    <span class="p">},</span>
    <span class="s1">&#39;Lookahead Bias&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">&#39;Easy to accidentally use future information&#39;</span><span class="p">,</span>
        <span class="s1">&#39;implication&#39;</span><span class="p">:</span> <span class="s1">&#39;Backtests look great but live trading fails&#39;</span><span class="p">,</span>
        <span class="s1">&#39;solution&#39;</span><span class="p">:</span> <span class="s1">&#39;Strict point-in-time data, purging, embargo&#39;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">for</span> <span class="n">challenge</span><span class="p">,</span> <span class="n">details</span> <span class="ow">in</span> <span class="n">challenges</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">challenge</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Problem: </span><span class="si">{</span><span class="n">details</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Risk: </span><span class="si">{</span><span class="n">details</span><span class="p">[</span><span class="s1">&#39;implication&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Solution: </span><span class="si">{</span><span class="n">details</span><span class="p">[</span><span class="s1">&#39;solution&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><hr />
<h2>The ML Pipeline for Trading</h2></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># The Financial ML Pipeline</span>

<span class="n">pipeline_stages</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê</span>
<span class="s2">‚îÇ                        FINANCIAL ML PIPELINE                                 ‚îÇ</span>
<span class="s2">‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò</span>

<span class="s2">1. DATA COLLECTION</span>
<span class="s2">   ‚îú‚îÄ‚îÄ Price data (OHLCV)</span>
<span class="s2">   ‚îú‚îÄ‚îÄ Fundamental data</span>
<span class="s2">   ‚îú‚îÄ‚îÄ Alternative data (news, social, satellite)</span>
<span class="s2">   ‚îî‚îÄ‚îÄ Point-in-time considerations</span>
<span class="s2">          ‚îÇ</span>
<span class="s2">          ‚ñº</span>
<span class="s2">2. DATA PREPARATION</span>
<span class="s2">   ‚îú‚îÄ‚îÄ Handle missing data</span>
<span class="s2">   ‚îú‚îÄ‚îÄ Adjust for corporate actions</span>
<span class="s2">   ‚îú‚îÄ‚îÄ Time series train/test split</span>
<span class="s2">   ‚îî‚îÄ‚îÄ Avoid lookahead bias</span>
<span class="s2">          ‚îÇ</span>
<span class="s2">          ‚ñº</span>
<span class="s2">3. FEATURE ENGINEERING</span>
<span class="s2">   ‚îú‚îÄ‚îÄ Price-based features (returns, volatility)</span>
<span class="s2">   ‚îú‚îÄ‚îÄ Technical indicators</span>
<span class="s2">   ‚îú‚îÄ‚îÄ Statistical features (z-scores, percentiles)</span>
<span class="s2">   ‚îî‚îÄ‚îÄ Feature selection</span>
<span class="s2">          ‚îÇ</span>
<span class="s2">          ‚ñº</span>
<span class="s2">4. TARGET ENGINEERING</span>
<span class="s2">   ‚îú‚îÄ‚îÄ Define prediction target</span>
<span class="s2">   ‚îú‚îÄ‚îÄ Triple barrier method</span>
<span class="s2">   ‚îú‚îÄ‚îÄ Meta-labeling</span>
<span class="s2">   ‚îî‚îÄ‚îÄ Sample weighting</span>
<span class="s2">          ‚îÇ</span>
<span class="s2">          ‚ñº</span>
<span class="s2">5. MODEL TRAINING</span>
<span class="s2">   ‚îú‚îÄ‚îÄ Select algorithm(s)</span>
<span class="s2">   ‚îú‚îÄ‚îÄ Hyperparameter tuning</span>
<span class="s2">   ‚îú‚îÄ‚îÄ Cross-validation (time series aware)</span>
<span class="s2">   ‚îî‚îÄ‚îÄ Ensemble methods</span>
<span class="s2">          ‚îÇ</span>
<span class="s2">          ‚ñº</span>
<span class="s2">6. EVALUATION</span>
<span class="s2">   ‚îú‚îÄ‚îÄ ML metrics (accuracy, F1, AUC)</span>
<span class="s2">   ‚îú‚îÄ‚îÄ Financial metrics (Sharpe, returns)</span>
<span class="s2">   ‚îú‚îÄ‚îÄ Walk-forward testing</span>
<span class="s2">   ‚îî‚îÄ‚îÄ Statistical significance</span>
<span class="s2">          ‚îÇ</span>
<span class="s2">          ‚ñº</span>
<span class="s2">7. DEPLOYMENT</span>
<span class="s2">   ‚îú‚îÄ‚îÄ Feature pipeline</span>
<span class="s2">   ‚îú‚îÄ‚îÄ Real-time prediction</span>
<span class="s2">   ‚îú‚îÄ‚îÄ Model monitoring</span>
<span class="s2">   ‚îî‚îÄ‚îÄ Retraining triggers</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="nb">print</span><span class="p">(</span><span class="n">pipeline_stages</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><hr />
<h2>Key Libraries</h2></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Core libraries used throughout this course</span>

<span class="c1"># Data manipulation</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="c1"># Visualization</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>

<span class="c1"># Machine Learning</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">TimeSeriesSplit</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">StandardScaler</span>
<span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">RandomForestClassifier</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">classification_report</span>

<span class="c1"># Financial data</span>
<span class="kn">import</span> <span class="nn">yfinance</span> <span class="k">as</span> <span class="nn">yf</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Core libraries imported successfully!&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Versions:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  pandas: </span><span class="si">{</span><span class="n">pd</span><span class="o">.</span><span class="n">__version__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  numpy: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">__version__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><hr />
<h2>Quick Preview: A Simple ML Trading Model</h2></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">RandomForestClassifier</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">TimeSeriesSplit</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">accuracy_score</span><span class="p">,</span> <span class="n">classification_report</span>
<span class="kn">import</span> <span class="nn">yfinance</span> <span class="k">as</span> <span class="nn">yf</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>

<span class="c1"># 1. Get data</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;1. Fetching data...&quot;</span><span class="p">)</span>
<span class="n">ticker</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">Ticker</span><span class="p">(</span><span class="s2">&quot;SPY&quot;</span><span class="p">)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">ticker</span><span class="o">.</span><span class="n">history</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="s2">&quot;2y&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Downloaded </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="si">}</span><span class="s2"> days of SPY data&quot;</span><span class="p">)</span>

<span class="c1"># 2. Create features</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">2. Engineering features...&quot;</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;returns&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;sma_5&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;sma_20&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;volatility&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;returns&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;momentum&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>

<span class="c1"># Feature: distance from moving average</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;dist_sma_5&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;sma_5&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;sma_5&#39;</span><span class="p">]</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;dist_sma_20&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;sma_20&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;sma_20&#39;</span><span class="p">]</span>

<span class="c1"># 3. Create target (next day direction)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;3. Creating target labels...&quot;</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;returns&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="c1"># 4. Prepare data</span>
<span class="n">features</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;dist_sma_5&#39;</span><span class="p">,</span> <span class="s1">&#39;dist_sma_20&#39;</span><span class="p">,</span> <span class="s1">&#39;volatility&#39;</span><span class="p">,</span> <span class="s1">&#39;momentum&#39;</span><span class="p">]</span>
<span class="n">df_clean</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

<span class="n">X</span> <span class="o">=</span> <span class="n">df_clean</span><span class="p">[</span><span class="n">features</span><span class="p">]</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">df_clean</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span>

<span class="c1"># 5. Time series split (respects temporal order)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">4. Splitting data (time series aware)...&quot;</span><span class="p">)</span>
<span class="n">split_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.8</span><span class="p">)</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span> <span class="o">=</span> <span class="n">X</span><span class="p">[:</span><span class="n">split_idx</span><span class="p">],</span> <span class="n">X</span><span class="p">[</span><span class="n">split_idx</span><span class="p">:]</span>
<span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">y</span><span class="p">[:</span><span class="n">split_idx</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">split_idx</span><span class="p">:]</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Training: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span><span class="si">}</span><span class="s2"> samples&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Testing: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span><span class="si">}</span><span class="s2"> samples&quot;</span><span class="p">)</span>

<span class="c1"># 6. Train model</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">5. Training Random Forest...&quot;</span><span class="p">)</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">RandomForestClassifier</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

<span class="c1"># 7. Evaluate</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">6. Evaluating model...&quot;</span><span class="p">)</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
<span class="n">accuracy</span> <span class="o">=</span> <span class="n">accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">   Accuracy: </span><span class="si">{</span><span class="n">accuracy</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   (Random baseline: 50%)&quot;</span><span class="p">)</span>

<span class="c1"># Feature importance</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">7. Feature Importance:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">feat</span><span class="p">,</span> <span class="n">imp</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">feature_importances_</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="o">-</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   </span><span class="si">{</span><span class="n">feat</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">imp</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><hr />
<h2>Prerequisites Check</h2>
<p>Before starting this course, ensure you're comfortable with:</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Prerequisite skills check</span>

<span class="n">prerequisites</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;Python Fundamentals&#39;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s1">&#39;Variables and data types&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Functions and classes&#39;</span><span class="p">,</span>
        <span class="s1">&#39;List comprehensions&#39;</span><span class="p">,</span>
        <span class="s1">&#39;File I/O&#39;</span>
    <span class="p">],</span>
    <span class="s1">&#39;Pandas &amp; NumPy&#39;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s1">&#39;DataFrames and Series&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Indexing and selection&#39;</span><span class="p">,</span>
        <span class="s1">&#39;GroupBy operations&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Vectorized operations&#39;</span>
    <span class="p">],</span>
    <span class="s1">&#39;Basic Statistics&#39;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s1">&#39;Mean, variance, standard deviation&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Correlation and covariance&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Normal distribution&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Hypothesis testing basics&#39;</span>
    <span class="p">],</span>
    <span class="s1">&#39;Financial Concepts&#39;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s1">&#39;Returns calculation&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Risk metrics (volatility)&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Technical indicators basics&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Market order types&#39;</span>
    <span class="p">]</span>
<span class="p">}</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Prerequisites for this course:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">category</span><span class="p">,</span> <span class="n">skills</span> <span class="ow">in</span> <span class="n">prerequisites</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">category</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">skill</span> <span class="ow">in</span> <span class="n">skills</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - </span><span class="si">{</span><span class="n">skill</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">()</span>
</code></pre></div>
<div class="md-cell"><hr />
<h2>Capstone Preview</h2>
<p>By the end of this course, you'll build a <strong>Production ML Trading System</strong> that includes:</p>
<ul>
<li>Multi-source data pipeline (price + sentiment + alternative)</li>
<li>Feature engineering library with 50+ features</li>
<li>Multiple model comparison (tree-based + neural)</li>
<li>Proper walk-forward validation</li>
<li>Sentiment integration from news</li>
<li>Model interpretation &amp; explainability (SHAP)</li>
<li>Production deployment with monitoring</li>
<li>Automated retraining pipeline</li>
</ul>
<hr />
<h2>Let's Begin!</h2>
<p>Start with <strong>Module 1: ML Concepts for Traders</strong> to understand why machine learning in finance requires special considerations.</p>
<p><strong>Next: Module 1 - ML Concepts for Traders</strong></p></div>
        <div class="nav-buttons">
            <button class="nav-btn prev-btn disabled" type="button">
                <span class="nav-btn-label">‚Üê Previous</span>
                <span class="nav-btn-name"></span>
            </button>
            <button class="nav-btn next-btn disabled" type="button">
                <span class="nav-btn-label">Next ‚Üí</span>
                <span class="nav-btn-name"></span>
            </button>
        </div>
        </div>
<div class="module-section" data-idx="1"><div class="md-cell module-header"><h1>Module 1: ML Concepts for Traders</h1>
<h2>Part 1: ML Fundamentals for Finance</h2>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Duration</th>
<th>Exercises</th>
</tr>
</thead>
<tbody>
<tr>
<td>~2.5 hours</td>
<td>6</td>
</tr>
</tbody>
</table></div>
<h3>Learning Objectives</h3>
<p>By the end of this module, you will be able to:</p>
<ul>
<li>Distinguish between supervised and unsupervised learning</li>
<li>Understand why financial ML faces unique challenges</li>
<li>Map the complete ML pipeline for trading applications</li>
<li>Set up your ML development environment</li>
</ul></div>
<div class="md-cell"><hr />
<h2>1.1 What is Machine Learning?</h2>
<p>Machine learning is about building systems that learn patterns from data rather than being explicitly programmed. In trading, we use ML to find patterns that might predict future price movements.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="c1"># Traditional programming vs Machine Learning</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Traditional Programming:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  Input: Data + Rules&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  Output: Answers&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  Example: IF price &gt; SMA(20) THEN buy&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Machine Learning:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  Input: Data + Answers (historical examples)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  Output: Rules (learned patterns)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  Example: Model learns what conditions precede profitable trades&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h3>Supervised vs Unsupervised Learning</h3></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Supervised Learning: We have labeled examples</span>
<span class="c1"># - Classification: Predict categories (up/down, buy/sell/hold)</span>
<span class="c1"># - Regression: Predict continuous values (tomorrow&#39;s return)</span>

<span class="n">supervised_examples</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;Classification&#39;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s1">&#39;Predict if stock goes up or down tomorrow&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Classify trades as profitable or not&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Detect market regime (bull/bear/sideways)&#39;</span>
    <span class="p">],</span>
    <span class="s1">&#39;Regression&#39;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s1">&#39;Predict tomorrow</span><span class="se">\&#39;</span><span class="s1">s return magnitude&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Forecast volatility&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Estimate fair value&#39;</span>
    <span class="p">]</span>
<span class="p">}</span>

<span class="c1"># Unsupervised Learning: No labels, find structure in data</span>
<span class="n">unsupervised_examples</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;Clustering&#39;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s1">&#39;Group similar stocks together&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Identify market regimes&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Segment trading days by behavior&#39;</span>
    <span class="p">],</span>
    <span class="s1">&#39;Dimensionality Reduction&#39;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s1">&#39;Reduce many correlated features to few factors&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Find latent market factors&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Compress feature space&#39;</span>
    <span class="p">]</span>
<span class="p">}</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;SUPERVISED LEARNING (with labels):&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">category</span><span class="p">,</span> <span class="n">examples</span> <span class="ow">in</span> <span class="n">supervised_examples</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">  </span><span class="si">{</span><span class="n">category</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ex</span> <span class="ow">in</span> <span class="n">examples</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    - </span><span class="si">{</span><span class="n">ex</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">UNSUPERVISED LEARNING (no labels):&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">category</span><span class="p">,</span> <span class="n">examples</span> <span class="ow">in</span> <span class="n">unsupervised_examples</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">  </span><span class="si">{</span><span class="n">category</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ex</span> <span class="ow">in</span> <span class="n">examples</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    - </span><span class="si">{</span><span class="n">ex</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h3>Training, Validation, and Testing</h3></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># The fundamental concept: Split your data</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Data Split Strategy:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">1. TRAINING SET (~60-70%)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;   - Model learns patterns from this data&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;   - Like studying for an exam&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">2. VALIDATION SET (~15-20%)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;   - Used to tune hyperparameters&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;   - Like practice tests&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">3. TEST SET (~15-20%)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;   - Final evaluation, NEVER used during training&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;   - Like the final exam&quot;</span><span class="p">)</span>

<span class="c1"># Visual representation</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>

<span class="c1"># Draw the splits</span>
<span class="n">ax</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;steelblue&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Training (70%)&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.15</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Validation (15%)&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.15</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="mf">0.85</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Test (15%)&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Data Timeline&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper center&#39;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">),</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Standard Data Split for Time Series&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
<div class="md-cell"><hr />
<h2>1.2 Why Finance is Different</h2>
<p>Financial markets present unique challenges that make ML much harder than in other domains.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Challenge 1: Low Signal-to-Noise Ratio</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>

<span class="c1"># Simulate a signal buried in noise</span>
<span class="n">days</span> <span class="o">=</span> <span class="mi">252</span>
<span class="n">signal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">days</span><span class="p">))</span> <span class="o">*</span> <span class="mf">0.01</span>  <span class="c1"># Tiny signal</span>
<span class="n">noise</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">,</span> <span class="n">days</span><span class="p">)</span>  <span class="c1"># Much larger noise</span>
<span class="n">observed_returns</span> <span class="o">=</span> <span class="n">signal</span> <span class="o">+</span> <span class="n">noise</span>

<span class="c1"># Calculate signal-to-noise ratio</span>
<span class="n">snr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">signal</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">noise</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Signal-to-Noise Ratio: </span><span class="si">{</span><span class="n">snr</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The true signal is only ~50</span><span class="si">% a</span><span class="s2">s strong as the noise!&quot;</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">signal</span><span class="p">,</span> <span class="s1">&#39;g-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;True Signal (Hidden)&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Return&#39;</span><span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">noise</span><span class="p">,</span> <span class="s1">&#39;r-&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Noise&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Return&#39;</span><span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">observed_returns</span><span class="p">,</span> <span class="s1">&#39;b-&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;What We Observe (Signal + Noise)&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Days&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Return&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Implication: Models easily fit to noise, not signal&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Solution: Regularization, cross-validation, feature selection&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Challenge 2: Non-Stationarity</span>

<span class="c1"># Financial time series properties change over time</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>

<span class="c1"># Simulate changing volatility regimes</span>
<span class="n">low_vol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mf">0.001</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">high_vol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="o">-</span><span class="mf">0.002</span><span class="p">,</span> <span class="mf">0.03</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">medium_vol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mf">0.0005</span><span class="p">,</span> <span class="mf">0.015</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>

<span class="n">returns</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">low_vol</span><span class="p">,</span> <span class="n">high_vol</span><span class="p">,</span> <span class="n">medium_vol</span><span class="p">])</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="c1"># Returns</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">returns</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Returns with Changing Regimes&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Return&#39;</span><span class="p">)</span>

<span class="c1"># Rolling volatility</span>
<span class="n">rolling_vol</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">returns</span><span class="p">)</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">rolling_vol</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Rolling Volatility (20-day)&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Days&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Volatility&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The same strategy that works in one regime may fail in another.&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;A model trained on low-vol data will struggle in high-vol periods.&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Challenge 3: Adversarial Environment</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The Adversarial Nature of Markets&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">Unlike image classification or language translation:</span>

<span class="s2">1. OTHER TRADERS ARE ADAPTING</span>
<span class="s2">   - If you find a profitable pattern, others will too</span>
<span class="s2">   - As more money exploits a pattern, the edge disappears</span>
<span class="s2">   - &quot;Alpha decay&quot; - strategies lose effectiveness over time</span>

<span class="s2">2. THE SYSTEM FIGHTS BACK</span>
<span class="s2">   - Market makers adjust to trading patterns</span>
<span class="s2">   - Large trades move prices against you</span>
<span class="s2">   - Information gets priced in faster</span>

<span class="s2">3. REGIME CHANGES ARE STRUCTURAL</span>
<span class="s2">   - Regulations change market behavior</span>
<span class="s2">   - New instruments (ETFs, derivatives) change dynamics</span>
<span class="s2">   - Technology (HFT) changes market microstructure</span>

<span class="s2">This is fundamentally different from:</span>
<span class="s2">- Cats don&#39;t evolve to avoid being classified as cats</span>
<span class="s2">- Weather patterns don&#39;t adapt to forecasts</span>
<span class="s2">- Medical diagnoses don&#39;t change because you&#39;re predicting them</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Challenge 4: Lookahead Bias - The Silent Killer</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Lookahead Bias Examples&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>

<span class="n">lookahead_examples</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="s1">&#39;mistake&#39;</span><span class="p">:</span> <span class="s1">&#39;Using adjusted close prices for historical signals&#39;</span><span class="p">,</span>
        <span class="s1">&#39;problem&#39;</span><span class="p">:</span> <span class="s1">&#39;Adjustments happen after splits/dividends occur&#39;</span><span class="p">,</span>
        <span class="s1">&#39;solution&#39;</span><span class="p">:</span> <span class="s1">&#39;Use unadjusted prices, apply adjustments at signal time&#39;</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="s1">&#39;mistake&#39;</span><span class="p">:</span> <span class="s1">&#39;Including future data in feature calculation&#39;</span><span class="p">,</span>
        <span class="s1">&#39;problem&#39;</span><span class="p">:</span> <span class="s1">&#39;Rolling window includes today</span><span class="se">\&#39;</span><span class="s1">s close in today</span><span class="se">\&#39;</span><span class="s1">s signal&#39;</span><span class="p">,</span>
        <span class="s1">&#39;solution&#39;</span><span class="p">:</span> <span class="s1">&#39;Use .shift(1) to lag features appropriately&#39;</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="s1">&#39;mistake&#39;</span><span class="p">:</span> <span class="s1">&#39;Survivorship bias in stock universe&#39;</span><span class="p">,</span>
        <span class="s1">&#39;problem&#39;</span><span class="p">:</span> <span class="s1">&#39;Only including stocks that exist today&#39;</span><span class="p">,</span>
        <span class="s1">&#39;solution&#39;</span><span class="p">:</span> <span class="s1">&#39;Use point-in-time constituent lists&#39;</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="s1">&#39;mistake&#39;</span><span class="p">:</span> <span class="s1">&#39;Using final earnings numbers&#39;</span><span class="p">,</span>
        <span class="s1">&#39;problem&#39;</span><span class="p">:</span> <span class="s1">&#39;Earnings are often revised after initial release&#39;</span><span class="p">,</span>
        <span class="s1">&#39;solution&#39;</span><span class="p">:</span> <span class="s1">&#39;Use point-in-time fundamental data&#39;</span>
    <span class="p">}</span>
<span class="p">]</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">example</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lookahead_examples</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">. </span><span class="si">{</span><span class="n">example</span><span class="p">[</span><span class="s1">&#39;mistake&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Problem: </span><span class="si">{</span><span class="n">example</span><span class="p">[</span><span class="s1">&#39;problem&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Solution: </span><span class="si">{</span><span class="n">example</span><span class="p">[</span><span class="s1">&#39;solution&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell exercise-header"><h3>Exercise 1.1: Identify ML Problem Types (Guided)</h3>
<p>Classify financial ML problems as supervised/unsupervised and classification/regression.</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 1.1: Identify ML Problem Types (Guided)</span>

<span class="k">def</span> <span class="nf">classify_ml_problem</span><span class="p">(</span><span class="n">description</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Classify an ML problem based on its description.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        description: Description of the ML problem</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        Dictionary with learning_type and task_type</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">description_lower</span> <span class="o">=</span> <span class="n">description</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    
    <span class="c1"># TODO: Determine if supervised or unsupervised</span>
    <span class="c1"># Keywords for supervised: predict, forecast, classify, whether</span>
    <span class="n">supervised_keywords</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;predict&#39;</span><span class="p">,</span> <span class="s1">&#39;forecast&#39;</span><span class="p">,</span> <span class="s1">&#39;classify&#39;</span><span class="p">,</span> <span class="s1">&#39;whether&#39;</span><span class="p">,</span> <span class="s1">&#39;will&#39;</span><span class="p">]</span>
    <span class="n">is_supervised</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="n">kw</span> <span class="ow">in</span> <span class="n">description_lower</span> <span class="k">for</span> <span class="n">kw</span> <span class="ow">in</span> <span class="n">______</span><span class="p">)</span>
    
    <span class="c1"># TODO: Determine task type</span>
    <span class="c1"># Classification keywords: up/down, category, class, whether, direction</span>
    <span class="c1"># Regression keywords: how much, value, amount, return, price</span>
    <span class="n">classification_keywords</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;up&#39;</span><span class="p">,</span> <span class="s1">&#39;down&#39;</span><span class="p">,</span> <span class="s1">&#39;category&#39;</span><span class="p">,</span> <span class="s1">&#39;direction&#39;</span><span class="p">,</span> <span class="s1">&#39;whether&#39;</span><span class="p">]</span>
    <span class="n">regression_keywords</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;how much&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="s1">&#39;return&#39;</span><span class="p">,</span> <span class="s1">&#39;price&#39;</span><span class="p">,</span> <span class="s1">&#39;amount&#39;</span><span class="p">]</span>
    
    <span class="n">is_classification</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="n">kw</span> <span class="ow">in</span> <span class="n">description_lower</span> <span class="k">for</span> <span class="n">kw</span> <span class="ow">in</span> <span class="n">______</span><span class="p">)</span>
    <span class="n">is_regression</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="n">kw</span> <span class="ow">in</span> <span class="n">description_lower</span> <span class="k">for</span> <span class="n">kw</span> <span class="ow">in</span> <span class="n">______</span><span class="p">)</span>
    
    <span class="c1"># Build result</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;learning_type&#39;</span><span class="p">:</span> <span class="s1">&#39;supervised&#39;</span> <span class="k">if</span> <span class="n">is_supervised</span> <span class="k">else</span> <span class="s1">&#39;unsupervised&#39;</span><span class="p">,</span>
        <span class="s1">&#39;task_type&#39;</span><span class="p">:</span> <span class="s1">&#39;unknown&#39;</span>
    <span class="p">}</span>
    
    <span class="k">if</span> <span class="n">is_supervised</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">is_classification</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_regression</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;task_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">______</span>
        <span class="k">elif</span> <span class="n">is_regression</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_classification</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;task_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">______</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;task_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;could be either&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">result</span><span class="p">[</span><span class="s1">&#39;task_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;clustering or dimensionality reduction&#39;</span>
    
    <span class="k">return</span> <span class="n">result</span>

<span class="c1"># Test problems</span>
<span class="n">problems</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;Predict whether a stock will go up or down tomorrow&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Forecast the return value of SPY next week&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Group stocks into similar clusters based on their behavior&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Classify market regime as bull, bear, or sideways&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Estimate the price of an option&quot;</span>
<span class="p">]</span>

<span class="k">for</span> <span class="n">problem</span> <span class="ow">in</span> <span class="n">problems</span><span class="p">:</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">classify_ml_problem</span><span class="p">(</span><span class="n">problem</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Problem: </span><span class="si">{</span><span class="n">problem</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Type: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;learning_type&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;task_type&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 1.1</summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">classify_ml_problem</span><span class="p">(</span><span class="n">description</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Classify an ML problem based on its description.</span>

<span class="sd">    Args:</span>
<span class="sd">        description: Description of the ML problem</span>

<span class="sd">    Returns:</span>
<span class="sd">        Dictionary with learning_type and task_type</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">description_lower</span> <span class="o">=</span> <span class="n">description</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

    <span class="c1"># Determine if supervised or unsupervised</span>
    <span class="n">supervised_keywords</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;predict&#39;</span><span class="p">,</span> <span class="s1">&#39;forecast&#39;</span><span class="p">,</span> <span class="s1">&#39;classify&#39;</span><span class="p">,</span> <span class="s1">&#39;whether&#39;</span><span class="p">,</span> <span class="s1">&#39;will&#39;</span><span class="p">]</span>
    <span class="n">is_supervised</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="n">kw</span> <span class="ow">in</span> <span class="n">description_lower</span> <span class="k">for</span> <span class="n">kw</span> <span class="ow">in</span> <span class="n">supervised_keywords</span><span class="p">)</span>

    <span class="c1"># Determine task type</span>
    <span class="n">classification_keywords</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;up&#39;</span><span class="p">,</span> <span class="s1">&#39;down&#39;</span><span class="p">,</span> <span class="s1">&#39;category&#39;</span><span class="p">,</span> <span class="s1">&#39;direction&#39;</span><span class="p">,</span> <span class="s1">&#39;whether&#39;</span><span class="p">]</span>
    <span class="n">regression_keywords</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;how much&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="s1">&#39;return&#39;</span><span class="p">,</span> <span class="s1">&#39;price&#39;</span><span class="p">,</span> <span class="s1">&#39;amount&#39;</span><span class="p">]</span>

    <span class="n">is_classification</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="n">kw</span> <span class="ow">in</span> <span class="n">description_lower</span> <span class="k">for</span> <span class="n">kw</span> <span class="ow">in</span> <span class="n">classification_keywords</span><span class="p">)</span>
    <span class="n">is_regression</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="n">kw</span> <span class="ow">in</span> <span class="n">description_lower</span> <span class="k">for</span> <span class="n">kw</span> <span class="ow">in</span> <span class="n">regression_keywords</span><span class="p">)</span>

    <span class="c1"># Build result</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;learning_type&#39;</span><span class="p">:</span> <span class="s1">&#39;supervised&#39;</span> <span class="k">if</span> <span class="n">is_supervised</span> <span class="k">else</span> <span class="s1">&#39;unsupervised&#39;</span><span class="p">,</span>
        <span class="s1">&#39;task_type&#39;</span><span class="p">:</span> <span class="s1">&#39;unknown&#39;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="n">is_supervised</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">is_classification</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_regression</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;task_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;classification&#39;</span>
        <span class="k">elif</span> <span class="n">is_regression</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_classification</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;task_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;regression&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;task_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;could be either&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">result</span><span class="p">[</span><span class="s1">&#39;task_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;clustering or dimensionality reduction&#39;</span>

    <span class="k">return</span> <span class="n">result</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h2>1.3 The ML Pipeline</h2>
<p>A systematic approach to building ML models for trading.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># The Complete ML Pipeline for Trading</span>

<span class="k">class</span> <span class="nc">MLPipelineStage</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Represents a stage in the ML pipeline.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">description</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">key_considerations</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="n">description</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">key_considerations</span> <span class="o">=</span> <span class="n">key_considerations</span>
    
    <span class="k">def</span> <span class="nf">display</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">60</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;STAGE: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">60</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">description</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Key Considerations:&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">consideration</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">key_considerations</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - </span><span class="si">{</span><span class="n">consideration</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="c1"># Define pipeline stages</span>
<span class="n">pipeline</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">MLPipelineStage</span><span class="p">(</span>
        <span class="s2">&quot;1. Data Collection&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Gather all relevant data sources for your trading strategy.&quot;</span><span class="p">,</span>
        <span class="p">[</span>
            <span class="s2">&quot;Price data (OHLCV) at appropriate frequency&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Fundamental data (earnings, ratios)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Alternative data (sentiment, satellite)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Ensure point-in-time accuracy&quot;</span>
        <span class="p">]</span>
    <span class="p">),</span>
    <span class="n">MLPipelineStage</span><span class="p">(</span>
        <span class="s2">&quot;2. Data Preparation&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Clean and prepare data for ML consumption.&quot;</span><span class="p">,</span>
        <span class="p">[</span>
            <span class="s2">&quot;Handle missing values appropriately&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Adjust for corporate actions&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Time series train/test split (no random shuffle!)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Check for lookahead bias&quot;</span>
        <span class="p">]</span>
    <span class="p">),</span>
    <span class="n">MLPipelineStage</span><span class="p">(</span>
        <span class="s2">&quot;3. Feature Engineering&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Create predictive features from raw data.&quot;</span><span class="p">,</span>
        <span class="p">[</span>
            <span class="s2">&quot;Price-based features (returns, volatility)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Technical indicators&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Statistical features (z-scores, percentiles)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Feature selection to avoid overfitting&quot;</span>
        <span class="p">]</span>
    <span class="p">),</span>
    <span class="n">MLPipelineStage</span><span class="p">(</span>
        <span class="s2">&quot;4. Target Engineering&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Define what you&#39;re trying to predict.&quot;</span><span class="p">,</span>
        <span class="p">[</span>
            <span class="s2">&quot;Return-based vs direction-based targets&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Triple barrier method for labeling&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Handle overlapping labels&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Sample weighting for uniqueness&quot;</span>
        <span class="p">]</span>
    <span class="p">),</span>
    <span class="n">MLPipelineStage</span><span class="p">(</span>
        <span class="s2">&quot;5. Model Training&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Train and tune your ML model.&quot;</span><span class="p">,</span>
        <span class="p">[</span>
            <span class="s2">&quot;Select appropriate algorithm&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Hyperparameter tuning with CV&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Use time series cross-validation&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Ensemble methods for robustness&quot;</span>
        <span class="p">]</span>
    <span class="p">),</span>
    <span class="n">MLPipelineStage</span><span class="p">(</span>
        <span class="s2">&quot;6. Evaluation&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Assess model performance rigorously.&quot;</span><span class="p">,</span>
        <span class="p">[</span>
            <span class="s2">&quot;ML metrics (accuracy, precision, recall)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Financial metrics (Sharpe, returns)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Walk-forward validation&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Statistical significance testing&quot;</span>
        <span class="p">]</span>
    <span class="p">),</span>
    <span class="n">MLPipelineStage</span><span class="p">(</span>
        <span class="s2">&quot;7. Deployment&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Put the model into production.&quot;</span><span class="p">,</span>
        <span class="p">[</span>
            <span class="s2">&quot;Real-time feature calculation&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Model serving infrastructure&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Monitoring and alerting&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Retraining schedule&quot;</span>
        <span class="p">]</span>
    <span class="p">)</span>
<span class="p">]</span>

<span class="c1"># Display all stages</span>
<span class="k">for</span> <span class="n">stage</span> <span class="ow">in</span> <span class="n">pipeline</span><span class="p">:</span>
    <span class="n">stage</span><span class="o">.</span><span class="n">display</span><span class="p">()</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Mini Example: Complete Pipeline Demo</span>

<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">RandomForestClassifier</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">accuracy_score</span>
<span class="kn">import</span> <span class="nn">yfinance</span> <span class="k">as</span> <span class="nn">yf</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Mini Pipeline Demo&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>

<span class="c1"># Stage 1: Data Collection</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">1. Collecting data...&quot;</span><span class="p">)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">Ticker</span><span class="p">(</span><span class="s2">&quot;AAPL&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">history</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="s2">&quot;2y&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Downloaded </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="si">}</span><span class="s2"> rows&quot;</span><span class="p">)</span>

<span class="c1"># Stage 2: Data Preparation</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">2. Preparing data...&quot;</span><span class="p">)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s1">&#39;Open&#39;</span><span class="p">,</span> <span class="s1">&#39;High&#39;</span><span class="p">,</span> <span class="s1">&#39;Low&#39;</span><span class="p">,</span> <span class="s1">&#39;Close&#39;</span><span class="p">,</span> <span class="s1">&#39;Volume&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Columns: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Stage 3: Feature Engineering</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">3. Engineering features...&quot;</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;returns&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;volatility&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;returns&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;momentum&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;volume_change&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Volume&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Created 4 features&quot;</span><span class="p">)</span>

<span class="c1"># Stage 4: Target Engineering</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">4. Creating target...&quot;</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;returns&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Target: Next day direction (0=down, 1=up)&quot;</span><span class="p">)</span>

<span class="c1"># Prepare final dataset</span>
<span class="n">features</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;returns&#39;</span><span class="p">,</span> <span class="s1">&#39;volatility&#39;</span><span class="p">,</span> <span class="s1">&#39;momentum&#39;</span><span class="p">,</span> <span class="s1">&#39;volume_change&#39;</span><span class="p">]</span>
<span class="n">df_clean</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

<span class="c1"># Stage 5: Model Training (with time series split)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">5. Training model...&quot;</span><span class="p">)</span>
<span class="n">split_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df_clean</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.8</span><span class="p">)</span>

<span class="n">X_train</span> <span class="o">=</span> <span class="n">df_clean</span><span class="p">[</span><span class="n">features</span><span class="p">][:</span><span class="n">split_idx</span><span class="p">]</span>
<span class="n">y_train</span> <span class="o">=</span> <span class="n">df_clean</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">][:</span><span class="n">split_idx</span><span class="p">]</span>
<span class="n">X_test</span> <span class="o">=</span> <span class="n">df_clean</span><span class="p">[</span><span class="n">features</span><span class="p">][</span><span class="n">split_idx</span><span class="p">:]</span>
<span class="n">y_test</span> <span class="o">=</span> <span class="n">df_clean</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">][</span><span class="n">split_idx</span><span class="p">:]</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">RandomForestClassifier</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Trained on </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span><span class="si">}</span><span class="s2"> samples&quot;</span><span class="p">)</span>

<span class="c1"># Stage 6: Evaluation</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">6. Evaluating model...&quot;</span><span class="p">)</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
<span class="n">accuracy</span> <span class="o">=</span> <span class="n">accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Test accuracy: </span><span class="si">{</span><span class="n">accuracy</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Baseline (random): 50%&quot;</span><span class="p">)</span>

<span class="c1"># Stage 7: Deployment (just a preview)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">7. Ready for deployment!&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Model can predict direction based on 4 features&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell exercise-header"><h3>Exercise 1.2: Pipeline Stage Matcher (Guided)</h3>
<p>Match activities to the correct pipeline stage.</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 1.2: Pipeline Stage Matcher (Guided)</span>

<span class="k">def</span> <span class="nf">match_to_pipeline_stage</span><span class="p">(</span><span class="n">activity</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Match an activity to the correct ML pipeline stage.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        activity: Description of the activity</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        Name of the pipeline stage</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">activity_lower</span> <span class="o">=</span> <span class="n">activity</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    
    <span class="c1"># Define keywords for each stage</span>
    <span class="n">stage_keywords</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;data_collection&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;download&#39;</span><span class="p">,</span> <span class="s1">&#39;fetch&#39;</span><span class="p">,</span> <span class="s1">&#39;api&#39;</span><span class="p">,</span> <span class="s1">&#39;source&#39;</span><span class="p">,</span> <span class="s1">&#39;gather&#39;</span><span class="p">],</span>
        <span class="s1">&#39;data_preparation&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;clean&#39;</span><span class="p">,</span> <span class="s1">&#39;missing&#39;</span><span class="p">,</span> <span class="s1">&#39;split&#39;</span><span class="p">,</span> <span class="s1">&#39;adjust&#39;</span><span class="p">,</span> <span class="s1">&#39;outlier&#39;</span><span class="p">],</span>
        <span class="s1">&#39;feature_engineering&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;indicator&#39;</span><span class="p">,</span> <span class="s1">&#39;feature&#39;</span><span class="p">,</span> <span class="s1">&#39;rolling&#39;</span><span class="p">,</span> <span class="s1">&#39;calculate&#39;</span><span class="p">,</span> <span class="s1">&#39;transform&#39;</span><span class="p">],</span>
        <span class="s1">&#39;target_engineering&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">,</span> <span class="s1">&#39;target&#39;</span><span class="p">,</span> <span class="s1">&#39;predict what&#39;</span><span class="p">,</span> <span class="s1">&#39;direction&#39;</span><span class="p">,</span> <span class="s1">&#39;barrier&#39;</span><span class="p">],</span>
        <span class="s1">&#39;model_training&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;train&#39;</span><span class="p">,</span> <span class="s1">&#39;fit&#39;</span><span class="p">,</span> <span class="s1">&#39;hyperparameter&#39;</span><span class="p">,</span> <span class="s1">&#39;tune&#39;</span><span class="p">,</span> <span class="s1">&#39;algorithm&#39;</span><span class="p">],</span>
        <span class="s1">&#39;evaluation&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">,</span> <span class="s1">&#39;sharpe&#39;</span><span class="p">,</span> <span class="s1">&#39;test&#39;</span><span class="p">,</span> <span class="s1">&#39;metric&#39;</span><span class="p">,</span> <span class="s1">&#39;performance&#39;</span><span class="p">],</span>
        <span class="s1">&#39;deployment&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;production&#39;</span><span class="p">,</span> <span class="s1">&#39;real-time&#39;</span><span class="p">,</span> <span class="s1">&#39;monitor&#39;</span><span class="p">,</span> <span class="s1">&#39;serve&#39;</span><span class="p">,</span> <span class="s1">&#39;deploy&#39;</span><span class="p">]</span>
    <span class="p">}</span>
    
    <span class="c1"># TODO: Find the matching stage</span>
    <span class="k">for</span> <span class="n">stage</span><span class="p">,</span> <span class="n">keywords</span> <span class="ow">in</span> <span class="n">stage_keywords</span><span class="o">.</span><span class="n">______</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">kw</span> <span class="ow">in</span> <span class="n">activity_lower</span> <span class="k">for</span> <span class="n">kw</span> <span class="ow">in</span> <span class="n">______</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">stage</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">title</span><span class="p">()</span>
    
    <span class="k">return</span> <span class="s1">&#39;Unknown Stage&#39;</span>

<span class="c1"># Test activities</span>
<span class="n">activities</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;Download historical price data from Yahoo Finance&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Handle missing values in the dataset&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Calculate RSI and MACD indicators&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Define the target as next-day return direction&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Tune hyperparameters using grid search&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Calculate Sharpe ratio of predictions&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Deploy model to production server&quot;</span>
<span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Activity -&gt; Pipeline Stage Mapping:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">activity</span> <span class="ow">in</span> <span class="n">activities</span><span class="p">:</span>
    <span class="n">stage</span> <span class="o">=</span> <span class="n">match_to_pipeline_stage</span><span class="p">(</span><span class="n">activity</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">activity</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    -&gt; </span><span class="si">{</span><span class="n">stage</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 1.2</summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">match_to_pipeline_stage</span><span class="p">(</span><span class="n">activity</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Match an activity to the correct ML pipeline stage.</span>

<span class="sd">    Args:</span>
<span class="sd">        activity: Description of the activity</span>

<span class="sd">    Returns:</span>
<span class="sd">        Name of the pipeline stage</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">activity_lower</span> <span class="o">=</span> <span class="n">activity</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

    <span class="c1"># Define keywords for each stage</span>
    <span class="n">stage_keywords</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;data_collection&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;download&#39;</span><span class="p">,</span> <span class="s1">&#39;fetch&#39;</span><span class="p">,</span> <span class="s1">&#39;api&#39;</span><span class="p">,</span> <span class="s1">&#39;source&#39;</span><span class="p">,</span> <span class="s1">&#39;gather&#39;</span><span class="p">],</span>
        <span class="s1">&#39;data_preparation&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;clean&#39;</span><span class="p">,</span> <span class="s1">&#39;missing&#39;</span><span class="p">,</span> <span class="s1">&#39;split&#39;</span><span class="p">,</span> <span class="s1">&#39;adjust&#39;</span><span class="p">,</span> <span class="s1">&#39;outlier&#39;</span><span class="p">],</span>
        <span class="s1">&#39;feature_engineering&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;indicator&#39;</span><span class="p">,</span> <span class="s1">&#39;feature&#39;</span><span class="p">,</span> <span class="s1">&#39;rolling&#39;</span><span class="p">,</span> <span class="s1">&#39;calculate&#39;</span><span class="p">,</span> <span class="s1">&#39;transform&#39;</span><span class="p">],</span>
        <span class="s1">&#39;target_engineering&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">,</span> <span class="s1">&#39;target&#39;</span><span class="p">,</span> <span class="s1">&#39;predict what&#39;</span><span class="p">,</span> <span class="s1">&#39;direction&#39;</span><span class="p">,</span> <span class="s1">&#39;barrier&#39;</span><span class="p">],</span>
        <span class="s1">&#39;model_training&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;train&#39;</span><span class="p">,</span> <span class="s1">&#39;fit&#39;</span><span class="p">,</span> <span class="s1">&#39;hyperparameter&#39;</span><span class="p">,</span> <span class="s1">&#39;tune&#39;</span><span class="p">,</span> <span class="s1">&#39;algorithm&#39;</span><span class="p">],</span>
        <span class="s1">&#39;evaluation&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">,</span> <span class="s1">&#39;sharpe&#39;</span><span class="p">,</span> <span class="s1">&#39;test&#39;</span><span class="p">,</span> <span class="s1">&#39;metric&#39;</span><span class="p">,</span> <span class="s1">&#39;performance&#39;</span><span class="p">],</span>
        <span class="s1">&#39;deployment&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;production&#39;</span><span class="p">,</span> <span class="s1">&#39;real-time&#39;</span><span class="p">,</span> <span class="s1">&#39;monitor&#39;</span><span class="p">,</span> <span class="s1">&#39;serve&#39;</span><span class="p">,</span> <span class="s1">&#39;deploy&#39;</span><span class="p">]</span>
    <span class="p">}</span>

    <span class="c1"># Find the matching stage</span>
    <span class="k">for</span> <span class="n">stage</span><span class="p">,</span> <span class="n">keywords</span> <span class="ow">in</span> <span class="n">stage_keywords</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">kw</span> <span class="ow">in</span> <span class="n">activity_lower</span> <span class="k">for</span> <span class="n">kw</span> <span class="ow">in</span> <span class="n">keywords</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">stage</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">title</span><span class="p">()</span>

    <span class="k">return</span> <span class="s1">&#39;Unknown Stage&#39;</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h2>1.4 Tools Setup</h2>
<p>Setting up your ML development environment for financial applications.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Core ML Libraries</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Essential Libraries for Financial ML&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>

<span class="n">libraries</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;Data Manipulation&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;pandas&#39;</span><span class="p">:</span> <span class="s1">&#39;DataFrames for tabular data&#39;</span><span class="p">,</span>
        <span class="s1">&#39;numpy&#39;</span><span class="p">:</span> <span class="s1">&#39;Numerical computing&#39;</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="s1">&#39;Machine Learning&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;scikit-learn&#39;</span><span class="p">:</span> <span class="s1">&#39;Core ML algorithms and utilities&#39;</span><span class="p">,</span>
        <span class="s1">&#39;xgboost&#39;</span><span class="p">:</span> <span class="s1">&#39;Gradient boosting (fast, accurate)&#39;</span><span class="p">,</span>
        <span class="s1">&#39;lightgbm&#39;</span><span class="p">:</span> <span class="s1">&#39;Another gradient boosting option&#39;</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="s1">&#39;Deep Learning&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;torch (PyTorch)&#39;</span><span class="p">:</span> <span class="s1">&#39;Neural networks&#39;</span><span class="p">,</span>
        <span class="s1">&#39;tensorflow&#39;</span><span class="p">:</span> <span class="s1">&#39;Alternative to PyTorch&#39;</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="s1">&#39;Visualization&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;matplotlib&#39;</span><span class="p">:</span> <span class="s1">&#39;Static plots&#39;</span><span class="p">,</span>
        <span class="s1">&#39;seaborn&#39;</span><span class="p">:</span> <span class="s1">&#39;Statistical visualizations&#39;</span><span class="p">,</span>
        <span class="s1">&#39;plotly&#39;</span><span class="p">:</span> <span class="s1">&#39;Interactive plots&#39;</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="s1">&#39;Financial Data&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;yfinance&#39;</span><span class="p">:</span> <span class="s1">&#39;Yahoo Finance data&#39;</span><span class="p">,</span>
        <span class="s1">&#39;pandas-datareader&#39;</span><span class="p">:</span> <span class="s1">&#39;Multiple data sources&#39;</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="s1">&#39;NLP &amp; Sentiment&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;nltk&#39;</span><span class="p">:</span> <span class="s1">&#39;Natural language processing&#39;</span><span class="p">,</span>
        <span class="s1">&#39;transformers&#39;</span><span class="p">:</span> <span class="s1">&#39;Pre-trained language models&#39;</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="s1">&#39;Model Interpretation&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;shap&#39;</span><span class="p">:</span> <span class="s1">&#39;SHAP values for explainability&#39;</span><span class="p">,</span>
        <span class="s1">&#39;lime&#39;</span><span class="p">:</span> <span class="s1">&#39;Local interpretable explanations&#39;</span><span class="p">,</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">for</span> <span class="n">category</span><span class="p">,</span> <span class="n">libs</span> <span class="ow">in</span> <span class="n">libraries</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">category</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">lib</span><span class="p">,</span> <span class="n">desc</span> <span class="ow">in</span> <span class="n">libs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">lib</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">desc</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Check your environment</span>

<span class="k">def</span> <span class="nf">check_library</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Check if a library is installed and get its version.&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">module</span> <span class="o">=</span> <span class="nb">__import__</span><span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">))</span>
        <span class="n">version</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="s1">&#39;__version__&#39;</span><span class="p">,</span> <span class="s1">&#39;unknown&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="n">version</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Environment Check&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>

<span class="n">essential_libs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;pandas&#39;</span><span class="p">,</span> <span class="s1">&#39;numpy&#39;</span><span class="p">,</span> <span class="s1">&#39;sklearn&#39;</span><span class="p">,</span> <span class="s1">&#39;matplotlib&#39;</span><span class="p">,</span> <span class="s1">&#39;yfinance&#39;</span><span class="p">]</span>
<span class="n">optional_libs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;xgboost&#39;</span><span class="p">,</span> <span class="s1">&#39;lightgbm&#39;</span><span class="p">,</span> <span class="s1">&#39;torch&#39;</span><span class="p">,</span> <span class="s1">&#39;shap&#39;</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Essential Libraries:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">lib</span> <span class="ow">in</span> <span class="n">essential_libs</span><span class="p">:</span>
    <span class="n">installed</span><span class="p">,</span> <span class="n">version</span> <span class="o">=</span> <span class="n">check_library</span><span class="p">(</span><span class="n">lib</span><span class="p">)</span>
    <span class="n">status</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;v</span><span class="si">{</span><span class="n">version</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">installed</span> <span class="k">else</span> <span class="s2">&quot;NOT INSTALLED&quot;</span>
    <span class="n">symbol</span> <span class="o">=</span> <span class="s2">&quot;OK&quot;</span> <span class="k">if</span> <span class="n">installed</span> <span class="k">else</span> <span class="s2">&quot;MISSING&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  [</span><span class="si">{</span><span class="n">symbol</span><span class="si">}</span><span class="s2">] </span><span class="si">{</span><span class="n">lib</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">status</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Optional Libraries:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">lib</span> <span class="ow">in</span> <span class="n">optional_libs</span><span class="p">:</span>
    <span class="n">installed</span><span class="p">,</span> <span class="n">version</span> <span class="o">=</span> <span class="n">check_library</span><span class="p">(</span><span class="n">lib</span><span class="p">)</span>
    <span class="n">status</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;v</span><span class="si">{</span><span class="n">version</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">installed</span> <span class="k">else</span> <span class="s2">&quot;not installed&quot;</span>
    <span class="n">symbol</span> <span class="o">=</span> <span class="s2">&quot;OK&quot;</span> <span class="k">if</span> <span class="n">installed</span> <span class="k">else</span> <span class="s2">&quot;--&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  [</span><span class="si">{</span><span class="n">symbol</span><span class="si">}</span><span class="s2">] </span><span class="si">{</span><span class="n">lib</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">status</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Jupyter Notebook Best Practices for ML</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Best Practices for ML in Jupyter&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>

<span class="n">best_practices</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span><span class="s2">&quot;Set random seeds&quot;</span><span class="p">,</span> <span class="s2">&quot;np.random.seed(42) for reproducibility&quot;</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;Suppress warnings carefully&quot;</span><span class="p">,</span> <span class="s2">&quot;warnings.filterwarnings(&#39;ignore&#39;) when appropriate&quot;</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;Use autoreload&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%lo</span><span class="s2">ad_ext autoreload for module development&quot;</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;Track experiments&quot;</span><span class="p">,</span> <span class="s2">&quot;Log hyperparameters and results systematically&quot;</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;Checkpoint models&quot;</span><span class="p">,</span> <span class="s2">&quot;Save model state periodically&quot;</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;Memory management&quot;</span><span class="p">,</span> <span class="s2">&quot;Delete large objects with del, use gc.collect()&quot;</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;Version control&quot;</span><span class="p">,</span> <span class="s2">&quot;Strip outputs before committing notebooks&quot;</span><span class="p">)</span>
<span class="p">]</span>

<span class="k">for</span> <span class="n">practice</span><span class="p">,</span> <span class="n">explanation</span> <span class="ow">in</span> <span class="n">best_practices</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">practice</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">explanation</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell exercise-header"><h3>Exercise 1.3: Environment Validator (Guided)</h3>
<p>Create a function that validates the ML environment is ready.</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 1.3: Environment Validator (Guided)</span>

<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span>

<span class="k">def</span> <span class="nf">validate_ml_environment</span><span class="p">(</span><span class="n">required_libs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">optional_libs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Validate that required ML libraries are installed.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        required_libs: List of required library names</span>
<span class="sd">        optional_libs: List of optional library names</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        Dictionary with validation results</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">optional_libs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">optional_libs</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="n">results</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;required&#39;</span><span class="p">:</span> <span class="p">{},</span>
        <span class="s1">&#39;optional&#39;</span><span class="p">:</span> <span class="p">{},</span>
        <span class="s1">&#39;ready&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="s1">&#39;missing_required&#39;</span><span class="p">:</span> <span class="p">[]</span>
    <span class="p">}</span>
    
    <span class="c1"># TODO: Check required libraries</span>
    <span class="k">for</span> <span class="n">lib</span> <span class="ow">in</span> <span class="n">required_libs</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">module</span> <span class="o">=</span> <span class="n">______</span><span class="p">(</span><span class="n">lib</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">))</span>
            <span class="n">version</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="s1">&#39;__version__&#39;</span><span class="p">,</span> <span class="s1">&#39;installed&#39;</span><span class="p">)</span>
            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;required&#39;</span><span class="p">][</span><span class="n">lib</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;installed&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;version&#39;</span><span class="p">:</span> <span class="n">version</span><span class="p">}</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;required&#39;</span><span class="p">][</span><span class="n">lib</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;installed&#39;</span><span class="p">:</span> <span class="n">______</span><span class="p">,</span> <span class="s1">&#39;version&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>
            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;ready&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">______</span>
            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;missing_required&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">______</span><span class="p">(</span><span class="n">lib</span><span class="p">)</span>
    
    <span class="c1"># Check optional libraries</span>
    <span class="k">for</span> <span class="n">lib</span> <span class="ow">in</span> <span class="n">optional_libs</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">module</span> <span class="o">=</span> <span class="nb">__import__</span><span class="p">(</span><span class="n">lib</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">))</span>
            <span class="n">version</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="s1">&#39;__version__&#39;</span><span class="p">,</span> <span class="s1">&#39;installed&#39;</span><span class="p">)</span>
            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;optional&#39;</span><span class="p">][</span><span class="n">lib</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;installed&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;version&#39;</span><span class="p">:</span> <span class="n">version</span><span class="p">}</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;optional&#39;</span><span class="p">][</span><span class="n">lib</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;installed&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;version&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>
    
    <span class="k">return</span> <span class="n">results</span>

<span class="c1"># Test the validator</span>
<span class="n">required</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;pandas&#39;</span><span class="p">,</span> <span class="s1">&#39;numpy&#39;</span><span class="p">,</span> <span class="s1">&#39;sklearn&#39;</span><span class="p">]</span>
<span class="n">optional</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;xgboost&#39;</span><span class="p">,</span> <span class="s1">&#39;shap&#39;</span><span class="p">,</span> <span class="s1">&#39;nonexistent_lib&#39;</span><span class="p">]</span>

<span class="n">results</span> <span class="o">=</span> <span class="n">validate_ml_environment</span><span class="p">(</span><span class="n">required</span><span class="p">,</span> <span class="n">optional</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Environment Validation Results&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Ready for ML: </span><span class="si">{</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;ready&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Required Libraries:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">lib</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;required&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">status</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;v</span><span class="si">{</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;version&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;installed&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot;MISSING&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">lib</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">status</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Optional Libraries:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">lib</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;optional&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">status</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;v</span><span class="si">{</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;version&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;installed&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot;not installed&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">lib</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">status</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 1.3</summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">validate_ml_environment</span><span class="p">(</span><span class="n">required_libs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">optional_libs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Validate that required ML libraries are installed.</span>

<span class="sd">    Args:</span>
<span class="sd">        required_libs: List of required library names</span>
<span class="sd">        optional_libs: List of optional library names</span>

<span class="sd">    Returns:</span>
<span class="sd">        Dictionary with validation results</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">optional_libs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">optional_libs</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">results</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;required&#39;</span><span class="p">:</span> <span class="p">{},</span>
        <span class="s1">&#39;optional&#39;</span><span class="p">:</span> <span class="p">{},</span>
        <span class="s1">&#39;ready&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="s1">&#39;missing_required&#39;</span><span class="p">:</span> <span class="p">[]</span>
    <span class="p">}</span>

    <span class="c1"># Check required libraries</span>
    <span class="k">for</span> <span class="n">lib</span> <span class="ow">in</span> <span class="n">required_libs</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">module</span> <span class="o">=</span> <span class="nb">__import__</span><span class="p">(</span><span class="n">lib</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">))</span>
            <span class="n">version</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="s1">&#39;__version__&#39;</span><span class="p">,</span> <span class="s1">&#39;installed&#39;</span><span class="p">)</span>
            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;required&#39;</span><span class="p">][</span><span class="n">lib</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;installed&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;version&#39;</span><span class="p">:</span> <span class="n">version</span><span class="p">}</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;required&#39;</span><span class="p">][</span><span class="n">lib</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;installed&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;version&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>
            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;ready&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;missing_required&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lib</span><span class="p">)</span>

    <span class="c1"># Check optional libraries</span>
    <span class="k">for</span> <span class="n">lib</span> <span class="ow">in</span> <span class="n">optional_libs</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">module</span> <span class="o">=</span> <span class="nb">__import__</span><span class="p">(</span><span class="n">lib</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">))</span>
            <span class="n">version</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="s1">&#39;__version__&#39;</span><span class="p">,</span> <span class="s1">&#39;installed&#39;</span><span class="p">)</span>
            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;optional&#39;</span><span class="p">][</span><span class="n">lib</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;installed&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;version&#39;</span><span class="p">:</span> <span class="n">version</span><span class="p">}</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;optional&#39;</span><span class="p">][</span><span class="n">lib</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;installed&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;version&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>

    <span class="k">return</span> <span class="n">results</span>
</code></pre></div>


</details></div>
<div class="md-cell exercise-header"><hr />
<h2>Open-Ended Exercises</h2>
<h3>Exercise 1.4: Financial ML Challenges Analysis (Open-ended)</h3>
<p>Create a comprehensive analysis of why a specific ML model might fail in financial markets.</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 1.4: Financial ML Challenges Analysis (Open-ended)</span>
<span class="c1">#</span>
<span class="c1"># Build a function that analyzes a dataset and identifies potential</span>
<span class="c1"># challenges for ML modeling:</span>
<span class="c1">#</span>
<span class="c1"># Requirements:</span>
<span class="c1"># - Calculate signal-to-noise ratio (return std / mean)</span>
<span class="c1"># - Check for regime changes (compare first/second half volatility)</span>
<span class="c1"># - Identify potential lookahead issues in column names</span>
<span class="c1"># - Return a detailed report dictionary</span>
<span class="c1">#</span>
<span class="c1"># Your implementation:</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 1.4</summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">analyze_ml_challenges</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">return_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;returns&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Analyze a dataset for potential ML challenges.</span>

<span class="sd">    Args:</span>
<span class="sd">        df: DataFrame with financial data</span>
<span class="sd">        return_col: Name of the returns column</span>

<span class="sd">    Returns:</span>
<span class="sd">        Dictionary with challenge analysis</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">report</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;signal_to_noise&#39;</span><span class="p">:</span> <span class="p">{},</span>
        <span class="s1">&#39;regime_stability&#39;</span><span class="p">:</span> <span class="p">{},</span>
        <span class="s1">&#39;potential_lookahead&#39;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s1">&#39;recommendations&#39;</span><span class="p">:</span> <span class="p">[]</span>
    <span class="p">}</span>

    <span class="c1"># Signal-to-noise analysis</span>
    <span class="k">if</span> <span class="n">return_col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">returns</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">return_col</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
        <span class="n">mean_return</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">std_return</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
        <span class="n">snr</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">mean_return</span><span class="p">)</span> <span class="o">/</span> <span class="n">std_return</span> <span class="k">if</span> <span class="n">std_return</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>

        <span class="n">report</span><span class="p">[</span><span class="s1">&#39;signal_to_noise&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;mean_return&#39;</span><span class="p">:</span> <span class="n">mean_return</span><span class="p">,</span>
            <span class="s1">&#39;std_return&#39;</span><span class="p">:</span> <span class="n">std_return</span><span class="p">,</span>
            <span class="s1">&#39;ratio&#39;</span><span class="p">:</span> <span class="n">snr</span><span class="p">,</span>
            <span class="s1">&#39;assessment&#39;</span><span class="p">:</span> <span class="s1">&#39;Low&#39;</span> <span class="k">if</span> <span class="n">snr</span> <span class="o">&lt;</span> <span class="mf">0.1</span> <span class="k">else</span> <span class="s1">&#39;Moderate&#39;</span> <span class="k">if</span> <span class="n">snr</span> <span class="o">&lt;</span> <span class="mf">0.2</span> <span class="k">else</span> <span class="s1">&#39;Good&#39;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="n">snr</span> <span class="o">&lt;</span> <span class="mf">0.1</span><span class="p">:</span>
            <span class="n">report</span><span class="p">[</span><span class="s1">&#39;recommendations&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="s2">&quot;Very low signal-to-noise. Consider strong regularization.&quot;</span>
            <span class="p">)</span>

    <span class="c1"># Regime stability</span>
    <span class="n">mid_point</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
    <span class="n">first_half</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">return_col</span><span class="p">][:</span><span class="n">mid_point</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span> <span class="k">if</span> <span class="n">return_col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="n">second_half</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">return_col</span><span class="p">][</span><span class="n">mid_point</span><span class="p">:]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span> <span class="k">if</span> <span class="n">return_col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">first_half</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">first_half</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">vol_ratio</span> <span class="o">=</span> <span class="n">second_half</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">/</span> <span class="n">first_half</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
        <span class="n">report</span><span class="p">[</span><span class="s1">&#39;regime_stability&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;first_half_vol&#39;</span><span class="p">:</span> <span class="n">first_half</span><span class="o">.</span><span class="n">std</span><span class="p">(),</span>
            <span class="s1">&#39;second_half_vol&#39;</span><span class="p">:</span> <span class="n">second_half</span><span class="o">.</span><span class="n">std</span><span class="p">(),</span>
            <span class="s1">&#39;volatility_ratio&#39;</span><span class="p">:</span> <span class="n">vol_ratio</span><span class="p">,</span>
            <span class="s1">&#39;stable&#39;</span><span class="p">:</span> <span class="mf">0.5</span> <span class="o">&lt;</span> <span class="n">vol_ratio</span> <span class="o">&lt;</span> <span class="mf">2.0</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">report</span><span class="p">[</span><span class="s1">&#39;regime_stability&#39;</span><span class="p">][</span><span class="s1">&#39;stable&#39;</span><span class="p">]:</span>
            <span class="n">report</span><span class="p">[</span><span class="s1">&#39;recommendations&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="s2">&quot;Significant regime change detected. Consider regime-aware models.&quot;</span>
            <span class="p">)</span>

    <span class="c1"># Lookahead bias check</span>
    <span class="n">suspicious_keywords</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;future&#39;</span><span class="p">,</span> <span class="s1">&#39;next&#39;</span><span class="p">,</span> <span class="s1">&#39;forward&#39;</span><span class="p">,</span> <span class="s1">&#39;target&#39;</span><span class="p">,</span> <span class="s1">&#39;label&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">kw</span> <span class="ow">in</span> <span class="n">col</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">kw</span> <span class="ow">in</span> <span class="n">suspicious_keywords</span><span class="p">):</span>
            <span class="n">report</span><span class="p">[</span><span class="s1">&#39;potential_lookahead&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">report</span><span class="p">[</span><span class="s1">&#39;potential_lookahead&#39;</span><span class="p">]:</span>
        <span class="n">report</span><span class="p">[</span><span class="s1">&#39;recommendations&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Columns with potential lookahead: </span><span class="si">{</span><span class="n">report</span><span class="p">[</span><span class="s1">&#39;potential_lookahead&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">. Verify timing.&quot;</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">report</span>

<span class="c1"># Test</span>
<span class="kn">import</span> <span class="nn">yfinance</span> <span class="k">as</span> <span class="nn">yf</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">Ticker</span><span class="p">(</span><span class="s2">&quot;SPY&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">history</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="s2">&quot;2y&quot;</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;returns&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;future_return&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;returns&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># Intentional lookahead</span>

<span class="n">analysis</span> <span class="o">=</span> <span class="n">analyze_ml_challenges</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="s1">&#39;returns&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ML Challenges Analysis&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Signal-to-Noise: </span><span class="si">{</span><span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;signal_to_noise&#39;</span><span class="p">][</span><span class="s1">&#39;assessment&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Ratio: </span><span class="si">{</span><span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;signal_to_noise&#39;</span><span class="p">][</span><span class="s1">&#39;ratio&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Regime Stability: </span><span class="si">{</span><span class="s1">&#39;Stable&#39;</span> <span class="k">if</span> <span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;regime_stability&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;stable&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;Unstable&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Vol Ratio: </span><span class="si">{</span><span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;regime_stability&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;volatility_ratio&#39;</span><span class="p">,</span> <span class="s1">&#39;N/A&#39;</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Potential Lookahead Issues: </span><span class="si">{</span><span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;potential_lookahead&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Recommendations:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">rec</span> <span class="ow">in</span> <span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;recommendations&#39;</span><span class="p">]:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - </span><span class="si">{</span><span class="n">rec</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell exercise-header"><h3>Exercise 1.5: ML Pipeline Builder (Open-ended)</h3>
<p>Create a class that represents and validates an ML pipeline configuration.</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 1.5: ML Pipeline Builder (Open-ended)</span>
<span class="c1">#</span>
<span class="c1"># Create an MLPipelineConfig class that:</span>
<span class="c1">#</span>
<span class="c1"># - Stores configuration for each pipeline stage</span>
<span class="c1"># - Validates that all required stages are present</span>
<span class="c1"># - Checks for common configuration errors</span>
<span class="c1"># - Generates a summary report</span>
<span class="c1">#</span>
<span class="c1"># Required stages: data, features, target, model, evaluation</span>
<span class="c1"># Each stage should have at minimum a &#39;method&#39; key</span>
<span class="c1">#</span>
<span class="c1"># Your implementation:</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 1.5</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">MLPipelineConfig</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Configuration manager for ML pipelines.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">REQUIRED_STAGES</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="s1">&#39;features&#39;</span><span class="p">,</span> <span class="s1">&#39;target&#39;</span><span class="p">,</span> <span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="s1">&#39;evaluation&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validation_errors</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">add_stage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stage_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;MLPipelineConfig&#39;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add a stage configuration.</span>

<span class="sd">        Args:</span>
<span class="sd">            stage_name: Name of the pipeline stage</span>
<span class="sd">            config: Configuration dictionary for the stage</span>

<span class="sd">        Returns:</span>
<span class="sd">            Self for method chaining</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;method&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">config</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">validation_errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Stage &#39;</span><span class="si">{</span><span class="n">stage_name</span><span class="si">}</span><span class="s2">&#39; missing required &#39;method&#39; key&quot;</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="n">stage_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">config</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Validate the pipeline configuration.</span>

<span class="sd">        Returns:</span>
<span class="sd">            True if valid, False otherwise</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validation_errors</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Check required stages</span>
        <span class="k">for</span> <span class="n">stage</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">REQUIRED_STAGES</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">stage</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">validation_errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Missing required stage: </span><span class="si">{</span><span class="n">stage</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Check for common errors</span>
        <span class="k">if</span> <span class="s1">&#39;data&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
            <span class="n">data_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">data_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;test_size&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">validation_errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="s2">&quot;Warning: Test size &gt; 50% may leave insufficient training data&quot;</span>
                <span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;model&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
            <span class="n">model_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">model_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cv_method&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;random&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">validation_errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="s2">&quot;Warning: Random CV is inappropriate for time series. Use TimeSeriesSplit.&quot;</span>
                <span class="p">)</span>

        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">validation_errors</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">get_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate a summary report of the pipeline.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Summary string</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;ML Pipeline Configuration Summary&quot;</span><span class="p">,</span> <span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">40</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">stage</span><span class="p">,</span> <span class="n">config</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">stage</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">is_valid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate</span><span class="p">()</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Validation: </span><span class="si">{</span><span class="s1">&#39;PASSED&#39;</span> <span class="k">if</span> <span class="n">is_valid</span> <span class="k">else</span> <span class="s1">&#39;FAILED&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">validation_errors</span><span class="p">:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Issues:&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">error</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">validation_errors</span><span class="p">:</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - </span><span class="si">{</span><span class="n">error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>

<span class="c1"># Test the pipeline builder</span>
<span class="n">pipeline</span> <span class="o">=</span> <span class="n">MLPipelineConfig</span><span class="p">()</span>
<span class="n">pipeline</span><span class="o">.</span><span class="n">add_stage</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="p">{</span>
    <span class="s1">&#39;method&#39;</span><span class="p">:</span> <span class="s1">&#39;yfinance&#39;</span><span class="p">,</span>
    <span class="s1">&#39;symbols&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;SPY&#39;</span><span class="p">,</span> <span class="s1">&#39;AAPL&#39;</span><span class="p">],</span>
    <span class="s1">&#39;period&#39;</span><span class="p">:</span> <span class="s1">&#39;2y&#39;</span><span class="p">,</span>
    <span class="s1">&#39;test_size&#39;</span><span class="p">:</span> <span class="mf">0.2</span>
<span class="p">})</span>
<span class="n">pipeline</span><span class="o">.</span><span class="n">add_stage</span><span class="p">(</span><span class="s1">&#39;features&#39;</span><span class="p">,</span> <span class="p">{</span>
    <span class="s1">&#39;method&#39;</span><span class="p">:</span> <span class="s1">&#39;technical_indicators&#39;</span><span class="p">,</span>
    <span class="s1">&#39;indicators&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;sma&#39;</span><span class="p">,</span> <span class="s1">&#39;rsi&#39;</span><span class="p">,</span> <span class="s1">&#39;macd&#39;</span><span class="p">]</span>
<span class="p">})</span>
<span class="n">pipeline</span><span class="o">.</span><span class="n">add_stage</span><span class="p">(</span><span class="s1">&#39;target&#39;</span><span class="p">,</span> <span class="p">{</span>
    <span class="s1">&#39;method&#39;</span><span class="p">:</span> <span class="s1">&#39;direction&#39;</span><span class="p">,</span>
    <span class="s1">&#39;horizon&#39;</span><span class="p">:</span> <span class="mi">1</span>
<span class="p">})</span>
<span class="n">pipeline</span><span class="o">.</span><span class="n">add_stage</span><span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="p">{</span>
    <span class="s1">&#39;method&#39;</span><span class="p">:</span> <span class="s1">&#39;random_forest&#39;</span><span class="p">,</span>
    <span class="s1">&#39;cv_method&#39;</span><span class="p">:</span> <span class="s1">&#39;time_series&#39;</span><span class="p">,</span>
    <span class="s1">&#39;n_splits&#39;</span><span class="p">:</span> <span class="mi">5</span>
<span class="p">})</span>
<span class="n">pipeline</span><span class="o">.</span><span class="n">add_stage</span><span class="p">(</span><span class="s1">&#39;evaluation&#39;</span><span class="p">,</span> <span class="p">{</span>
    <span class="s1">&#39;method&#39;</span><span class="p">:</span> <span class="s1">&#39;classification_metrics&#39;</span><span class="p">,</span>
    <span class="s1">&#39;metrics&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">,</span> <span class="s1">&#39;f1&#39;</span><span class="p">,</span> <span class="s1">&#39;sharpe&#39;</span><span class="p">]</span>
<span class="p">})</span>

<span class="nb">print</span><span class="p">(</span><span class="n">pipeline</span><span class="o">.</span><span class="n">get_summary</span><span class="p">())</span>
</code></pre></div>


</details></div>
<div class="md-cell exercise-header"><h3>Exercise 1.6: Complete ML Workflow Skeleton (Open-ended)</h3>
<p>Create a complete but minimal ML workflow for trading that demonstrates all pipeline stages.</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 1.6: Complete ML Workflow Skeleton (Open-ended)</span>
<span class="c1">#</span>
<span class="c1"># Build a complete TradingMLWorkflow class that:</span>
<span class="c1">#</span>
<span class="c1"># - Downloads data for a given symbol</span>
<span class="c1"># - Creates basic features (returns, volatility, momentum)</span>
<span class="c1"># - Creates a direction target</span>
<span class="c1"># - Trains a simple classifier</span>
<span class="c1"># - Evaluates with proper time series split</span>
<span class="c1"># - Returns a comprehensive results dictionary</span>
<span class="c1">#</span>
<span class="c1"># Your implementation:</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 1.6</summary>


<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">RandomForestClassifier</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">accuracy_score</span><span class="p">,</span> <span class="n">precision_score</span><span class="p">,</span> <span class="n">recall_score</span>
<span class="kn">import</span> <span class="nn">yfinance</span> <span class="k">as</span> <span class="nn">yf</span>

<span class="k">class</span> <span class="nc">TradingMLWorkflow</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Complete ML workflow for trading applications.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">period</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;2y&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span> <span class="o">=</span> <span class="n">symbol</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">period</span> <span class="o">=</span> <span class="n">period</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">fetch_data</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Stage 1: Data Collection&quot;&quot;&quot;</span>
        <span class="n">ticker</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">Ticker</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">ticker</span><span class="o">.</span><span class="n">history</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">period</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span>

    <span class="k">def</span> <span class="nf">engineer_features</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Stage 2 &amp; 3: Data Preparation &amp; Feature Engineering&quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># Basic features</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;returns&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;volatility&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;returns&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;momentum_5&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;momentum_20&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;volume_change&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Volume&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span>

        <span class="c1"># Distance from moving averages</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;sma_20&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;dist_sma&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;sma_20&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;sma_20&#39;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">df</span>
        <span class="k">return</span> <span class="n">df</span>

    <span class="k">def</span> <span class="nf">create_target</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">horizon</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Stage 4: Target Engineering&quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;returns&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="n">horizon</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">df</span>
        <span class="k">return</span> <span class="n">df</span>

    <span class="k">def</span> <span class="nf">train_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Stage 5 &amp; 6: Model Training &amp; Evaluation&quot;&quot;&quot;</span>
        <span class="c1"># Prepare data</span>
        <span class="n">feature_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;returns&#39;</span><span class="p">,</span> <span class="s1">&#39;volatility&#39;</span><span class="p">,</span> <span class="s1">&#39;momentum_5&#39;</span><span class="p">,</span> <span class="s1">&#39;momentum_20&#39;</span><span class="p">,</span> 
                       <span class="s1">&#39;volume_change&#39;</span><span class="p">,</span> <span class="s1">&#39;dist_sma&#39;</span><span class="p">]</span>
        <span class="n">df_clean</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

        <span class="n">X</span> <span class="o">=</span> <span class="n">df_clean</span><span class="p">[</span><span class="n">feature_cols</span><span class="p">]</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">df_clean</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span>

        <span class="c1"># Time series split</span>
        <span class="n">split_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">test_size</span><span class="p">))</span>
        <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span> <span class="o">=</span> <span class="n">X</span><span class="p">[:</span><span class="n">split_idx</span><span class="p">],</span> <span class="n">X</span><span class="p">[</span><span class="n">split_idx</span><span class="p">:]</span>
        <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">y</span><span class="p">[:</span><span class="n">split_idx</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">split_idx</span><span class="p">:]</span>

        <span class="c1"># Train</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">RandomForestClassifier</span><span class="p">(</span>
            <span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> 
            <span class="n">max_depth</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> 
            <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

        <span class="c1"># Predict</span>
        <span class="n">y_pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
        <span class="n">y_prob</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">]</span>

        <span class="c1"># Calculate metrics</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;accuracy&#39;</span><span class="p">:</span> <span class="n">accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">),</span>
            <span class="s1">&#39;precision&#39;</span><span class="p">:</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">),</span>
            <span class="s1">&#39;recall&#39;</span><span class="p">:</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">),</span>
            <span class="s1">&#39;train_size&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">X_train</span><span class="p">),</span>
            <span class="s1">&#39;test_size&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">X_test</span><span class="p">),</span>
            <span class="s1">&#39;feature_importance&#39;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">feature_cols</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">feature_importances_</span><span class="p">)),</span>
            <span class="s1">&#39;predictions&#39;</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
                <span class="s1">&#39;actual&#39;</span><span class="p">:</span> <span class="n">y_test</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
                <span class="s1">&#39;predicted&#39;</span><span class="p">:</span> <span class="n">y_pred</span><span class="p">,</span>
                <span class="s1">&#39;probability&#39;</span><span class="p">:</span> <span class="n">y_prob</span>
            <span class="p">},</span> <span class="n">index</span><span class="o">=</span><span class="n">y_test</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span>

    <span class="k">def</span> <span class="nf">run_full_pipeline</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Execute the complete pipeline.&quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Running ML Pipeline for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">1. Fetching data...&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fetch_data</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Downloaded </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span><span class="si">}</span><span class="s2"> rows&quot;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">2. Engineering features...&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">engineer_features</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Created 6 features&quot;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">3. Creating target...&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_target</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Target: next-day direction&quot;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">4. Training and evaluating...&quot;</span><span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_model</span><span class="p">()</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;RESULTS:&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Accuracy: </span><span class="si">{</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Precision: </span><span class="si">{</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Recall: </span><span class="si">{</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;recall&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Top Features:&quot;</span><span class="p">)</span>
        <span class="n">sorted_features</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;feature_importance&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> 
            <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="o">-</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">feat</span><span class="p">,</span> <span class="n">imp</span> <span class="ow">in</span> <span class="n">sorted_features</span><span class="p">[:</span><span class="mi">3</span><span class="p">]:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">feat</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">imp</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">results</span>

<span class="c1"># Run the workflow</span>
<span class="n">workflow</span> <span class="o">=</span> <span class="n">TradingMLWorkflow</span><span class="p">(</span><span class="s1">&#39;SPY&#39;</span><span class="p">,</span> <span class="s1">&#39;2y&#39;</span><span class="p">)</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">workflow</span><span class="o">.</span><span class="n">run_full_pipeline</span><span class="p">()</span>
</code></pre></div>


</details></div>
<div class="md-cell module-project"><hr />
<h2>Module Project: ML Project Template</h2>
<p>Create a reusable project template that sets up the structure for any financial ML project.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Module Project: ML Project Template</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">import</span> <span class="nn">json</span>


<span class="k">class</span> <span class="nc">MLProjectTemplate</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates a standardized project structure for financial ML projects.</span>
<span class="sd">    </span>
<span class="sd">    This template ensures consistent organization and includes</span>
<span class="sd">    all necessary components for reproducible ML experiments.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">description</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize a new ML project template.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            project_name: Name of the project</span>
<span class="sd">            description: Brief description of the project</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">project_name</span> <span class="o">=</span> <span class="n">project_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="n">description</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">created_at</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default_config</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">directory_structure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default_structure</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">_default_config</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Return default project configuration.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="s1">&#39;yfinance&#39;</span><span class="p">,</span>
                <span class="s1">&#39;symbols&#39;</span><span class="p">:</span> <span class="p">[],</span>
                <span class="s1">&#39;period&#39;</span><span class="p">:</span> <span class="s1">&#39;2y&#39;</span><span class="p">,</span>
                <span class="s1">&#39;test_size&#39;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">,</span>
                <span class="s1">&#39;validation_size&#39;</span><span class="p">:</span> <span class="mf">0.1</span>
            <span class="p">},</span>
            <span class="s1">&#39;features&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;price_based&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;returns&#39;</span><span class="p">,</span> <span class="s1">&#39;volatility&#39;</span><span class="p">,</span> <span class="s1">&#39;momentum&#39;</span><span class="p">],</span>
                <span class="s1">&#39;technical&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;sma&#39;</span><span class="p">,</span> <span class="s1">&#39;rsi&#39;</span><span class="p">,</span> <span class="s1">&#39;macd&#39;</span><span class="p">],</span>
                <span class="s1">&#39;scaling&#39;</span><span class="p">:</span> <span class="s1">&#39;standard&#39;</span>
            <span class="p">},</span>
            <span class="s1">&#39;target&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;classification&#39;</span><span class="p">,</span>
                <span class="s1">&#39;method&#39;</span><span class="p">:</span> <span class="s1">&#39;direction&#39;</span><span class="p">,</span>
                <span class="s1">&#39;horizon&#39;</span><span class="p">:</span> <span class="mi">1</span>
            <span class="p">},</span>
            <span class="s1">&#39;model&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;algorithm&#39;</span><span class="p">:</span> <span class="s1">&#39;random_forest&#39;</span><span class="p">,</span>
                <span class="s1">&#39;cv_method&#39;</span><span class="p">:</span> <span class="s1">&#39;time_series&#39;</span><span class="p">,</span>
                <span class="s1">&#39;n_splits&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
                <span class="s1">&#39;hyperparameters&#39;</span><span class="p">:</span> <span class="p">{}</span>
            <span class="p">},</span>
            <span class="s1">&#39;evaluation&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;ml_metrics&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">,</span> <span class="s1">&#39;precision&#39;</span><span class="p">,</span> <span class="s1">&#39;recall&#39;</span><span class="p">,</span> <span class="s1">&#39;f1&#39;</span><span class="p">],</span>
                <span class="s1">&#39;financial_metrics&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;sharpe&#39;</span><span class="p">,</span> <span class="s1">&#39;returns&#39;</span><span class="p">,</span> <span class="s1">&#39;max_drawdown&#39;</span><span class="p">]</span>
            <span class="p">},</span>
            <span class="s1">&#39;random_seed&#39;</span><span class="p">:</span> <span class="mi">42</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">_default_structure</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Return default directory structure.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;raw&#39;</span><span class="p">:</span> <span class="s1">&#39;Original data files&#39;</span><span class="p">,</span>
                <span class="s1">&#39;processed&#39;</span><span class="p">:</span> <span class="s1">&#39;Cleaned and transformed data&#39;</span><span class="p">,</span>
                <span class="s1">&#39;features&#39;</span><span class="p">:</span> <span class="s1">&#39;Engineered features&#39;</span>
            <span class="p">},</span>
            <span class="s1">&#39;notebooks&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;01_data_exploration.ipynb&#39;</span><span class="p">:</span> <span class="s1">&#39;EDA notebook&#39;</span><span class="p">,</span>
                <span class="s1">&#39;02_feature_engineering.ipynb&#39;</span><span class="p">:</span> <span class="s1">&#39;Feature creation&#39;</span><span class="p">,</span>
                <span class="s1">&#39;03_model_training.ipynb&#39;</span><span class="p">:</span> <span class="s1">&#39;Model development&#39;</span><span class="p">,</span>
                <span class="s1">&#39;04_evaluation.ipynb&#39;</span><span class="p">:</span> <span class="s1">&#39;Results analysis&#39;</span>
            <span class="p">},</span>
            <span class="s1">&#39;src&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="s1">&#39;Data loading and processing modules&#39;</span><span class="p">,</span>
                <span class="s1">&#39;features&#39;</span><span class="p">:</span> <span class="s1">&#39;Feature engineering code&#39;</span><span class="p">,</span>
                <span class="s1">&#39;models&#39;</span><span class="p">:</span> <span class="s1">&#39;Model definitions&#39;</span><span class="p">,</span>
                <span class="s1">&#39;evaluation&#39;</span><span class="p">:</span> <span class="s1">&#39;Evaluation utilities&#39;</span>
            <span class="p">},</span>
            <span class="s1">&#39;models&#39;</span><span class="p">:</span> <span class="s1">&#39;Saved model files&#39;</span><span class="p">,</span>
            <span class="s1">&#39;reports&#39;</span><span class="p">:</span> <span class="s1">&#39;Generated reports and visualizations&#39;</span><span class="p">,</span>
            <span class="s1">&#39;config&#39;</span><span class="p">:</span> <span class="s1">&#39;Configuration files&#39;</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">set_symbols</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbols</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="s1">&#39;MLProjectTemplate&#39;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Set the trading symbols for the project.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;symbols&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">symbols</span>
        <span class="k">return</span> <span class="bp">self</span>
    
    <span class="k">def</span> <span class="nf">set_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">algorithm</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;MLProjectTemplate&#39;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Set the model algorithm and hyperparameters.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">][</span><span class="s1">&#39;algorithm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">algorithm</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">][</span><span class="s1">&#39;hyperparameters&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span>
        <span class="k">return</span> <span class="bp">self</span>
    
    <span class="k">def</span> <span class="nf">set_target</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">method</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">horizon</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;MLProjectTemplate&#39;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Set the prediction target configuration.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="n">target_type</span><span class="p">,</span>
            <span class="s1">&#39;method&#39;</span><span class="p">:</span> <span class="n">method</span><span class="p">,</span>
            <span class="s1">&#39;horizon&#39;</span><span class="p">:</span> <span class="n">horizon</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="bp">self</span>
    
    <span class="k">def</span> <span class="nf">validate_config</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Validate the project configuration.</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            Dictionary with validation results and warnings</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;valid&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s1">&#39;errors&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s1">&#39;warnings&#39;</span><span class="p">:</span> <span class="p">[]</span>
        <span class="p">}</span>
        
        <span class="c1"># Check required fields</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;symbols&#39;</span><span class="p">]:</span>
            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;warnings&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;No symbols specified&quot;</span><span class="p">)</span>
        
        <span class="c1"># Check for common mistakes</span>
        <span class="n">test_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;test_size&#39;</span><span class="p">]</span>
        <span class="n">val_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;validation_size&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">test_size</span> <span class="o">+</span> <span class="n">val_size</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">:</span>
            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;warnings&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Test + validation = </span><span class="si">{</span><span class="n">test_size</span> <span class="o">+</span> <span class="n">val_size</span><span class="si">:</span><span class="s2">.0%</span><span class="si">}</span><span class="s2">, leaving only &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="mi">1</span> <span class="o">-</span> <span class="n">test_size</span> <span class="o">-</span> <span class="n">val_size</span><span class="si">:</span><span class="s2">.0%</span><span class="si">}</span><span class="s2"> for training&quot;</span>
            <span class="p">)</span>
        
        <span class="c1"># Check model configuration</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">][</span><span class="s1">&#39;cv_method&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;random&#39;</span><span class="p">:</span>
            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;errors&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="s2">&quot;Random CV is inappropriate for time series data&quot;</span>
            <span class="p">)</span>
            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;valid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        
        <span class="k">return</span> <span class="n">results</span>
    
    <span class="k">def</span> <span class="nf">generate_readme</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Generate a README for the project.&quot;&quot;&quot;</span>
        <span class="n">readme</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2"># </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">project_name</span><span class="si">}</span><span class="s2"></span>

<span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">description</span><span class="si">}</span><span class="s2"></span>

<span class="s2">Created: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">created_at</span><span class="si">}</span><span class="s2"></span>

<span class="s2">## Configuration</span>

<span class="s2">### Data</span>
<span class="s2">- Source: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;source&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"></span>
<span class="s2">- Symbols: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;symbols&#39;</span><span class="p">])</span> <span class="ow">or</span> <span class="s1">&#39;Not specified&#39;</span><span class="si">}</span><span class="s2"></span>
<span class="s2">- Period: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;period&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"></span>

<span class="s2">### Model</span>
<span class="s2">- Algorithm: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">][</span><span class="s1">&#39;algorithm&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"></span>
<span class="s2">- CV Method: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">][</span><span class="s1">&#39;cv_method&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"></span>

<span class="s2">### Target</span>
<span class="s2">- Type: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">][</span><span class="s1">&#39;type&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"></span>
<span class="s2">- Method: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">][</span><span class="s1">&#39;method&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"></span>
<span class="s2">- Horizon: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">][</span><span class="s1">&#39;horizon&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> day(s)</span>

<span class="s2">## Directory Structure</span>

<span class="s2">```</span>
<span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">project_name</span><span class="si">}</span><span class="s2">/</span>
<span class="s2">‚îú‚îÄ‚îÄ data/</span>
<span class="s2">‚îÇ   ‚îú‚îÄ‚îÄ raw/</span>
<span class="s2">‚îÇ   ‚îú‚îÄ‚îÄ processed/</span>
<span class="s2">‚îÇ   ‚îî‚îÄ‚îÄ features/</span>
<span class="s2">‚îú‚îÄ‚îÄ notebooks/</span>
<span class="s2">‚îú‚îÄ‚îÄ src/</span>
<span class="s2">‚îÇ   ‚îú‚îÄ‚îÄ data/</span>
<span class="s2">‚îÇ   ‚îú‚îÄ‚îÄ features/</span>
<span class="s2">‚îÇ   ‚îú‚îÄ‚îÄ models/</span>
<span class="s2">‚îÇ   ‚îî‚îÄ‚îÄ evaluation/</span>
<span class="s2">‚îú‚îÄ‚îÄ models/</span>
<span class="s2">‚îú‚îÄ‚îÄ reports/</span>
<span class="s2">‚îî‚îÄ‚îÄ config/</span>
<span class="s2">```</span>

<span class="s2">## Usage</span>

<span class="s2">1. Start with `notebooks/01_data_exploration.ipynb`</span>
<span class="s2">2. Engineer features in `notebooks/02_feature_engineering.ipynb`</span>
<span class="s2">3. Train models in `notebooks/03_model_training.ipynb`</span>
<span class="s2">4. Evaluate results in `notebooks/04_evaluation.ipynb`</span>
<span class="s2">&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">readme</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">get_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get a summary of the project template.&quot;&quot;&quot;</span>
        <span class="n">validation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_config</span><span class="p">()</span>
        
        <span class="n">summary</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="si">{</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">60</span><span class="si">}</span><span class="s2"></span>
<span class="s2">ML PROJECT TEMPLATE: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">project_name</span><span class="si">}</span><span class="s2"></span>
<span class="si">{</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">60</span><span class="si">}</span><span class="s2"></span>

<span class="s2">Description: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">description</span> <span class="ow">or</span> <span class="s1">&#39;Not provided&#39;</span><span class="si">}</span><span class="s2"></span>
<span class="s2">Created: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">created_at</span><span class="si">}</span><span class="s2"></span>

<span class="s2">CONFIGURATION:</span>
<span class="s2">  Data Source: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;source&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"></span>
<span class="s2">  Symbols: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;symbols&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="s1">&#39;Not set&#39;</span><span class="si">}</span><span class="s2"></span>
<span class="s2">  Model: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">][</span><span class="s1">&#39;algorithm&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"></span>
<span class="s2">  Target: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">][</span><span class="s1">&#39;method&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">][</span><span class="s1">&#39;type&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">)</span>

<span class="s2">VALIDATION: </span><span class="si">{</span><span class="s1">&#39;PASSED&#39;</span> <span class="k">if</span> <span class="n">validation</span><span class="p">[</span><span class="s1">&#39;valid&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;FAILED&#39;</span><span class="si">}</span><span class="s2"></span>
<span class="s2">&quot;&quot;&quot;</span>
        
        <span class="k">if</span> <span class="n">validation</span><span class="p">[</span><span class="s1">&#39;errors&#39;</span><span class="p">]:</span>
            <span class="n">summary</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">ERRORS:</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="k">for</span> <span class="n">error</span> <span class="ow">in</span> <span class="n">validation</span><span class="p">[</span><span class="s1">&#39;errors&#39;</span><span class="p">]:</span>
                <span class="n">summary</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;  - </span><span class="si">{</span><span class="n">error</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        
        <span class="k">if</span> <span class="n">validation</span><span class="p">[</span><span class="s1">&#39;warnings&#39;</span><span class="p">]:</span>
            <span class="n">summary</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">WARNINGS:</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="k">for</span> <span class="n">warning</span> <span class="ow">in</span> <span class="n">validation</span><span class="p">[</span><span class="s1">&#39;warnings&#39;</span><span class="p">]:</span>
                <span class="n">summary</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;  - </span><span class="si">{</span><span class="n">warning</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        
        <span class="k">return</span> <span class="n">summary</span>


<span class="c1"># Demo the project template</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Creating ML Project Template...</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">project</span> <span class="o">=</span> <span class="n">MLProjectTemplate</span><span class="p">(</span>
    <span class="n">project_name</span><span class="o">=</span><span class="s2">&quot;SPY Direction Predictor&quot;</span><span class="p">,</span>
    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Predict next-day direction of SPY using technical features&quot;</span>
<span class="p">)</span>

<span class="c1"># Configure the project</span>
<span class="n">project</span><span class="o">.</span><span class="n">set_symbols</span><span class="p">([</span><span class="s1">&#39;SPY&#39;</span><span class="p">])</span>
<span class="n">project</span><span class="o">.</span><span class="n">set_model</span><span class="p">(</span>
    <span class="s1">&#39;random_forest&#39;</span><span class="p">,</span>
    <span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
    <span class="n">max_depth</span><span class="o">=</span><span class="mi">5</span>
<span class="p">)</span>
<span class="n">project</span><span class="o">.</span><span class="n">set_target</span><span class="p">(</span><span class="s1">&#39;classification&#39;</span><span class="p">,</span> <span class="s1">&#39;direction&#39;</span><span class="p">,</span> <span class="n">horizon</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># Display summary</span>
<span class="nb">print</span><span class="p">(</span><span class="n">project</span><span class="o">.</span><span class="n">get_summary</span><span class="p">())</span>

<span class="c1"># Show README preview</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;README PREVIEW:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">project</span><span class="o">.</span><span class="n">generate_readme</span><span class="p">()[:</span><span class="mi">1000</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;...&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell key-takeaways"><hr />
<h2>Key Takeaways</h2>
<ol>
<li>
<p><strong>ML Types</strong>: Supervised learning (classification/regression) predicts with labels; unsupervised finds patterns without labels</p>
</li>
<li>
<p><strong>Finance is Different</strong>: Low signal-to-noise, non-stationarity, regime changes, and adversarial environment make financial ML uniquely challenging</p>
</li>
<li>
<p><strong>The Pipeline</strong>: Data ‚Üí Features ‚Üí Target ‚Üí Model ‚Üí Evaluation ‚Üí Deployment - each stage requires finance-specific considerations</p>
</li>
<li>
<p><strong>Lookahead Bias</strong>: The most common and deadly mistake - always verify your features don't include future information</p>
</li>
<li>
<p><strong>Time Series Split</strong>: Never randomly shuffle financial data - always maintain temporal order in train/test splits</p>
</li>
<li>
<p><strong>Tool Ecosystem</strong>: scikit-learn, xgboost, and pandas form the core; add specialized tools as needed</p>
</li>
</ol>
<hr />
<p><strong>Next: Module 2 - Data Preparation</strong></p>
<p>Learn how to properly prepare financial data for ML, including handling missing values, train-test splits for time series, and avoiding common data leakage pitfalls.</p></div>
        <div class="nav-buttons">
            <button class="nav-btn prev-btn disabled" type="button">
                <span class="nav-btn-label">‚Üê Previous</span>
                <span class="nav-btn-name"></span>
            </button>
            <button class="nav-btn next-btn disabled" type="button">
                <span class="nav-btn-label">Next ‚Üí</span>
                <span class="nav-btn-name"></span>
            </button>
        </div>
        </div>
<div class="module-section" data-idx="2"><div class="md-cell module-header"><h1>Module 2: Data Preparation</h1>
<h2>Part 1: ML Fundamentals for Finance</h2>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Duration</th>
<th>Exercises</th>
</tr>
</thead>
<tbody>
<tr>
<td>~2.5 hours</td>
<td>6</td>
</tr>
</tbody>
</table></div>
<h3>Learning Objectives</h3>
<p>By the end of this module, you will be able to:</p>
<ul>
<li>Clean financial data while preserving signal integrity</li>
<li>Implement proper train-test splits for time series</li>
<li>Use time series cross-validation techniques</li>
<li>Handle imbalanced class distributions in trading data</li>
</ul></div>
<div class="md-cell"><hr />
<h2>2.1 Financial Data Cleaning</h2>
<p>Financial data has unique cleaning requirements that differ from general data science.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">yfinance</span> <span class="k">as</span> <span class="nn">yf</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>

<span class="c1"># Download sample data</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Downloading sample data...&quot;</span><span class="p">)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">Ticker</span><span class="p">(</span><span class="s2">&quot;AAPL&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">history</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="s2">&quot;2y&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Downloaded </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="si">}</span><span class="s2"> rows&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Columns: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Date range: </span><span class="si">{</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">date</span><span class="p">()</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">date</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Check for missing data</span>

<span class="k">def</span> <span class="nf">analyze_missing_data</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Analyze missing data patterns in a DataFrame.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        df: Input DataFrame</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        DataFrame with missing data statistics</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">missing_stats</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
        <span class="s1">&#39;missing_count&#39;</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span>
        <span class="s1">&#39;missing_pct&#39;</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
        <span class="s1">&#39;dtype&#39;</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">dtypes</span>
    <span class="p">})</span>
    <span class="k">return</span> <span class="n">missing_stats</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;missing_pct&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Missing Data Analysis:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">analyze_missing_data</span><span class="p">(</span><span class="n">df</span><span class="p">))</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Handling missing values in financial data</span>

<span class="k">class</span> <span class="nc">FinancialDataCleaner</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Clean financial time series data with appropriate methods.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cleaning_log</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">def</span> <span class="nf">handle_missing_prices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;ffill&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;FinancialDataCleaner&#39;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Handle missing price data.</span>
<span class="sd">        </span>
<span class="sd">        For OHLC data, forward fill is usually appropriate as it</span>
<span class="sd">        represents &quot;last known price&quot; - what you&#39;d actually trade at.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">price_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Open&#39;</span><span class="p">,</span> <span class="s1">&#39;High&#39;</span><span class="p">,</span> <span class="s1">&#39;Low&#39;</span><span class="p">,</span> <span class="s1">&#39;Close&#39;</span><span class="p">]</span>
        <span class="n">price_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">price_cols</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
        
        <span class="n">before_missing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="n">price_cols</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;ffill&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="n">price_cols</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="n">price_cols</span><span class="p">]</span><span class="o">.</span><span class="n">ffill</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;interpolate&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="n">price_cols</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="n">price_cols</span><span class="p">]</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>
        
        <span class="n">after_missing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="n">price_cols</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cleaning_log</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Filled </span><span class="si">{</span><span class="n">before_missing</span> <span class="o">-</span> <span class="n">after_missing</span><span class="si">}</span><span class="s2"> missing price values using </span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        
        <span class="k">return</span> <span class="bp">self</span>
    
    <span class="k">def</span> <span class="nf">handle_missing_volume</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fill_value</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;FinancialDataCleaner&#39;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Handle missing volume data.</span>
<span class="sd">        </span>
<span class="sd">        Missing volume often means no trades occurred, so filling with 0 is reasonable.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;Volume&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">before_missing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Volume&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Volume&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Volume&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">fill_value</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cleaning_log</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Filled </span><span class="si">{</span><span class="n">before_missing</span><span class="si">}</span><span class="s2"> missing volume values with </span><span class="si">{</span><span class="n">fill_value</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>
    
    <span class="k">def</span> <span class="nf">detect_outliers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">column</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">n_std</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">5</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Detect outliers using standard deviation method.</span>
<span class="sd">        </span>
<span class="sd">        For financial data, 5 std is a reasonable threshold as</span>
<span class="sd">        returns can legitimately be extreme.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">column</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
        
        <span class="n">mean</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="n">column</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">std</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="n">column</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
        
        <span class="n">lower_bound</span> <span class="o">=</span> <span class="n">mean</span> <span class="o">-</span> <span class="n">n_std</span> <span class="o">*</span> <span class="n">std</span>
        <span class="n">upper_bound</span> <span class="o">=</span> <span class="n">mean</span> <span class="o">+</span> <span class="n">n_std</span> <span class="o">*</span> <span class="n">std</span>
        
        <span class="n">is_outlier</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="n">column</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">lower_bound</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="n">column</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">upper_bound</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">cleaning_log</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="n">is_outlier</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="si">}</span><span class="s2"> outliers in </span><span class="si">{</span><span class="n">column</span><span class="si">}</span><span class="s2"> (&gt;</span><span class="si">{</span><span class="n">n_std</span><span class="si">}</span><span class="s2"> std)&quot;</span>
        <span class="p">)</span>
        
        <span class="k">return</span> <span class="n">is_outlier</span>
    
    <span class="k">def</span> <span class="nf">remove_zero_volume_days</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;FinancialDataCleaner&#39;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Remove days with zero volume (likely data errors or holidays).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;Volume&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">before_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Volume&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">removed</span> <span class="o">=</span> <span class="n">before_len</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cleaning_log</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Removed </span><span class="si">{</span><span class="n">removed</span><span class="si">}</span><span class="s2"> zero-volume days&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>
    
    <span class="k">def</span> <span class="nf">get_cleaned_data</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Return the cleaned DataFrame.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span>
    
    <span class="k">def</span> <span class="nf">get_cleaning_report</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Return a report of all cleaning operations.&quot;&quot;&quot;</span>
        <span class="n">report</span> <span class="o">=</span> <span class="s2">&quot;Data Cleaning Report</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">40</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cleaning_log</span><span class="p">:</span>
            <span class="n">report</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;- </span><span class="si">{</span><span class="n">entry</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">return</span> <span class="n">report</span>


<span class="c1"># Apply cleaning</span>
<span class="n">cleaner</span> <span class="o">=</span> <span class="n">FinancialDataCleaner</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
<span class="n">cleaner</span><span class="o">.</span><span class="n">handle_missing_prices</span><span class="p">(</span><span class="s1">&#39;ffill&#39;</span><span class="p">)</span>
<span class="n">cleaner</span><span class="o">.</span><span class="n">handle_missing_volume</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">cleaner</span><span class="o">.</span><span class="n">remove_zero_volume_days</span><span class="p">()</span>

<span class="c1"># Add returns and check for outliers</span>
<span class="n">df_clean</span> <span class="o">=</span> <span class="n">cleaner</span><span class="o">.</span><span class="n">get_cleaned_data</span><span class="p">()</span>
<span class="n">df_clean</span><span class="p">[</span><span class="s1">&#39;returns&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_clean</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span>
<span class="n">cleaner</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="n">df_clean</span>
<span class="n">outliers</span> <span class="o">=</span> <span class="n">cleaner</span><span class="o">.</span><span class="n">detect_outliers</span><span class="p">(</span><span class="s1">&#39;returns&#39;</span><span class="p">,</span> <span class="n">n_std</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">cleaner</span><span class="o">.</span><span class="n">get_cleaning_report</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Final dataset: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df_clean</span><span class="p">)</span><span class="si">}</span><span class="s2"> rows&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell exercise-header"><h3>Exercise 2.1: Data Quality Checker (Guided)</h3>
<p>Build a function to assess data quality for ML readiness.</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 2.1: Data Quality Checker (Guided)</span>

<span class="k">def</span> <span class="nf">check_data_quality</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">price_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;Close&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check data quality for ML readiness.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        df: Input DataFrame with OHLCV data</span>
<span class="sd">        price_col: Name of the price column</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        Dictionary with quality metrics</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">quality</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;row_count&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">),</span>
        <span class="s1">&#39;date_range&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s1">&#39;missing_data&#39;</span><span class="p">:</span> <span class="p">{},</span>
        <span class="s1">&#39;issues&#39;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s1">&#39;ready_for_ml&#39;</span><span class="p">:</span> <span class="kc">True</span>
    <span class="p">}</span>
    
    <span class="c1"># TODO: Calculate date range</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="s1">&#39;min&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="s1">&#39;max&#39;</span><span class="p">):</span>
        <span class="n">quality</span><span class="p">[</span><span class="s1">&#39;date_range&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;start&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">______</span><span class="p">()),</span>
            <span class="s1">&#39;end&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">______</span><span class="p">())</span>
        <span class="p">}</span>
    
    <span class="c1"># TODO: Calculate missing data percentage for each column</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">missing_pct</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">______</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
        <span class="n">quality</span><span class="p">[</span><span class="s1">&#39;missing_data&#39;</span><span class="p">][</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">missing_pct</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">missing_pct</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">:</span>
            <span class="n">quality</span><span class="p">[</span><span class="s1">&#39;issues&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2"> has </span><span class="si">{</span><span class="n">missing_pct</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">% missing data&quot;</span><span class="p">)</span>
            <span class="n">quality</span><span class="p">[</span><span class="s1">&#39;ready_for_ml&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">______</span>
    
    <span class="c1"># Check for minimum data requirements</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">252</span><span class="p">:</span>  <span class="c1"># Less than 1 year of daily data</span>
        <span class="n">quality</span><span class="p">[</span><span class="s1">&#39;issues&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Less than 252 rows (1 year of trading days)&quot;</span><span class="p">)</span>
        <span class="n">quality</span><span class="p">[</span><span class="s1">&#39;ready_for_ml&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    
    <span class="k">return</span> <span class="n">quality</span>

<span class="c1"># Test</span>
<span class="n">quality_report</span> <span class="o">=</span> <span class="n">check_data_quality</span><span class="p">(</span><span class="n">df_clean</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Data Quality Report&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">40</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Rows: </span><span class="si">{</span><span class="n">quality_report</span><span class="p">[</span><span class="s1">&#39;row_count&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Date Range: </span><span class="si">{</span><span class="n">quality_report</span><span class="p">[</span><span class="s1">&#39;date_range&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Ready for ML: </span><span class="si">{</span><span class="n">quality_report</span><span class="p">[</span><span class="s1">&#39;ready_for_ml&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">if</span> <span class="n">quality_report</span><span class="p">[</span><span class="s1">&#39;issues&#39;</span><span class="p">]:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Issues:&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">issue</span> <span class="ow">in</span> <span class="n">quality_report</span><span class="p">[</span><span class="s1">&#39;issues&#39;</span><span class="p">]:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - </span><span class="si">{</span><span class="n">issue</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 2.1</summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">check_data_quality</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">price_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;Close&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check data quality for ML readiness.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">quality</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;row_count&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">),</span>
        <span class="s1">&#39;date_range&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s1">&#39;missing_data&#39;</span><span class="p">:</span> <span class="p">{},</span>
        <span class="s1">&#39;issues&#39;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s1">&#39;ready_for_ml&#39;</span><span class="p">:</span> <span class="kc">True</span>
    <span class="p">}</span>

    <span class="c1"># Calculate date range</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="s1">&#39;min&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="s1">&#39;max&#39;</span><span class="p">):</span>
        <span class="n">quality</span><span class="p">[</span><span class="s1">&#39;date_range&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;start&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">min</span><span class="p">()),</span>
            <span class="s1">&#39;end&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
        <span class="p">}</span>

    <span class="c1"># Calculate missing data percentage for each column</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">missing_pct</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
        <span class="n">quality</span><span class="p">[</span><span class="s1">&#39;missing_data&#39;</span><span class="p">][</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">missing_pct</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">missing_pct</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">:</span>
            <span class="n">quality</span><span class="p">[</span><span class="s1">&#39;issues&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2"> has </span><span class="si">{</span><span class="n">missing_pct</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">% missing data&quot;</span><span class="p">)</span>
            <span class="n">quality</span><span class="p">[</span><span class="s1">&#39;ready_for_ml&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># Check for minimum data requirements</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">252</span><span class="p">:</span>
        <span class="n">quality</span><span class="p">[</span><span class="s1">&#39;issues&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Less than 252 rows (1 year of trading days)&quot;</span><span class="p">)</span>
        <span class="n">quality</span><span class="p">[</span><span class="s1">&#39;ready_for_ml&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">return</span> <span class="n">quality</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h2>2.2 Train-Test Split for Time Series</h2>
<p><strong>Critical</strong>: Never randomly shuffle time series data. Always maintain temporal order.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Why random split fails for time series</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Random Split vs Time Series Split&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">RANDOM SPLIT (WRONG for time series):</span>
<span class="s2">‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê</span>
<span class="s2">‚îÇ Train Train Test Train Test Train Test  ‚îÇ</span>
<span class="s2">‚îÇ   ‚Üë      ‚Üë     ‚Üë     ‚Üë     ‚Üë     ‚Üë   ‚Üë  ‚îÇ</span>
<span class="s2">‚îÇ   Randomly scattered across time        ‚îÇ</span>
<span class="s2">‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò</span>
<span class="s2">Problem: Model can &quot;peek&quot; at future data during training!</span>

<span class="s2">TIME SERIES SPLIT (CORRECT):</span>
<span class="s2">‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê</span>
<span class="s2">‚îÇ Train Train Train Train ‚îÇ Test Test Test‚îÇ</span>
<span class="s2">‚îÇ ‚Üê‚îÄ‚îÄ‚îÄ Earlier ‚îÄ‚îÄ‚Üí        ‚îÇ ‚Üê‚îÄ Later ‚îÄ‚îÄ‚Üí  ‚îÇ</span>
<span class="s2">‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò</span>
<span class="s2">Correct: Model only trained on past, tested on future.</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Proper time series split implementation</span>

<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Tuple</span>

<span class="k">def</span> <span class="nf">time_series_split</span><span class="p">(</span>
    <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">test_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">,</span>
    <span class="n">validation_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Split time series data maintaining temporal order.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        df: DataFrame sorted by date</span>
<span class="sd">        test_size: Proportion for test set (most recent data)</span>
<span class="sd">        validation_size: Proportion for validation set</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        Tuple of (train, validation, test) DataFrames</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    
    <span class="c1"># Calculate split indices</span>
    <span class="n">test_start</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">test_size</span><span class="p">))</span>
    <span class="n">val_start</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">test_size</span> <span class="o">-</span> <span class="n">validation_size</span><span class="p">))</span>
    
    <span class="c1"># Split</span>
    <span class="n">train</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="n">val_start</span><span class="p">]</span>
    <span class="n">validation</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">val_start</span><span class="p">:</span><span class="n">test_start</span><span class="p">]</span>
    <span class="n">test</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">test_start</span><span class="p">:]</span>
    
    <span class="k">return</span> <span class="n">train</span><span class="p">,</span> <span class="n">validation</span><span class="p">,</span> <span class="n">test</span>


<span class="c1"># Apply split</span>
<span class="n">train</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">test</span> <span class="o">=</span> <span class="n">time_series_split</span><span class="p">(</span><span class="n">df_clean</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">validation_size</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Time Series Split Results:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Training:   </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">train</span><span class="p">)</span><span class="si">:</span><span class="s2">4d</span><span class="si">}</span><span class="s2"> rows (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">train</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">df_clean</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Period: </span><span class="si">{</span><span class="n">train</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">date</span><span class="p">()</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">train</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">date</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Validation: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">val</span><span class="p">)</span><span class="si">:</span><span class="s2">4d</span><span class="si">}</span><span class="s2"> rows (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">val</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">df_clean</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Period: </span><span class="si">{</span><span class="n">val</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">date</span><span class="p">()</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">val</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">date</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Test:       </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">test</span><span class="p">)</span><span class="si">:</span><span class="s2">4d</span><span class="si">}</span><span class="s2"> rows (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">test</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">df_clean</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Period: </span><span class="si">{</span><span class="n">test</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">date</span><span class="p">()</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">test</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">date</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Visualize the split</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">train</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">train</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">],</span> <span class="s1">&#39;b-&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Training&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">val</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">val</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">],</span> <span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Validation&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">test</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">test</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">],</span> <span class="s1">&#39;g-&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Test&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># Add vertical lines at split points</span>
<span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">val</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">test</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Time Series Train/Validation/Test Split&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Price&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
<div class="md-cell"><h3>Purging and Embargo</h3>
<p>When features or labels overlap in time, we need additional safeguards.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Purging and Embargo explained</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Purging and Embargo&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">PROBLEM: Labels often span multiple days (e.g., 5-day returns)</span>

<span class="s2">Without purging:</span>
<span class="s2">‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê</span>
<span class="s2">‚îÇ Day 1   Day 2   Day 3 ‚îÇ Day 4   Day 5   Day 6     ‚îÇ</span>
<span class="s2">‚îÇ ‚Üê‚îÄ‚îÄ‚îÄ Training ‚îÄ‚îÄ‚îÄ‚îÄ‚Üí   ‚îÇ ‚Üê‚îÄ‚îÄ‚îÄ‚îÄ Test ‚îÄ‚îÄ‚îÄ‚îÄ‚Üí          ‚îÇ</span>
<span class="s2">‚îÇ        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                          ‚îÇ</span>
<span class="s2">‚îÇ        Label for Day 3 includes Day 4 &amp; 5!        ‚îÇ</span>
<span class="s2">‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò</span>
<span class="s2">LEAKAGE: Training label contains test period info</span>

<span class="s2">With purging (remove overlap):</span>
<span class="s2">‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê</span>
<span class="s2">‚îÇ Day 1   Day 2 ‚îÇ PURGED ‚îÇ Day 4   Day 5   Day 6    ‚îÇ</span>
<span class="s2">‚îÇ ‚Üê‚îÄ Training ‚îÄ‚Üí‚îÇ        ‚îÇ ‚Üê‚îÄ‚îÄ‚îÄ‚îÄ Test ‚îÄ‚îÄ‚îÄ‚îÄ‚Üí         ‚îÇ</span>
<span class="s2">‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò</span>
<span class="s2">SAFE: Gap prevents information leakage</span>

<span class="s2">Embargo adds extra buffer after test start:</span>
<span class="s2">‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê</span>
<span class="s2">‚îÇ Day 1 ‚îÇ PURGED ‚îÇ EMBARGO ‚îÇ Day 5   Day 6   Day 7  ‚îÇ</span>
<span class="s2">‚îÇ Train ‚îÇ        ‚îÇ         ‚îÇ ‚Üê‚îÄ‚îÄ‚îÄ‚îÄ Test ‚îÄ‚îÄ‚îÄ‚îÄ‚Üí       ‚îÇ</span>
<span class="s2">‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">apply_purge_embargo</span><span class="p">(</span>
    <span class="n">train_idx</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DatetimeIndex</span><span class="p">,</span>
    <span class="n">test_idx</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DatetimeIndex</span><span class="p">,</span>
    <span class="n">label_horizon</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
    <span class="n">embargo_days</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DatetimeIndex</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Remove training samples that overlap with test period.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        train_idx: Training data index</span>
<span class="sd">        test_idx: Test data index</span>
<span class="sd">        label_horizon: How many days the label spans</span>
<span class="sd">        embargo_days: Additional buffer days</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        Purged training index</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">test_start</span> <span class="o">=</span> <span class="n">test_idx</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    
    <span class="c1"># Purge: Remove samples whose labels would overlap with test</span>
    <span class="n">purge_cutoff</span> <span class="o">=</span> <span class="n">test_start</span> <span class="o">-</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">label_horizon</span><span class="p">)</span>
    
    <span class="c1"># Embargo: Additional buffer</span>
    <span class="n">embargo_cutoff</span> <span class="o">=</span> <span class="n">purge_cutoff</span> <span class="o">-</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">embargo_days</span><span class="p">)</span>
    
    <span class="n">purged_idx</span> <span class="o">=</span> <span class="n">train_idx</span><span class="p">[</span><span class="n">train_idx</span> <span class="o">&lt;</span> <span class="n">embargo_cutoff</span><span class="p">]</span>
    
    <span class="k">return</span> <span class="n">purged_idx</span>

<span class="c1"># Example</span>
<span class="n">purged_train_idx</span> <span class="o">=</span> <span class="n">apply_purge_embargo</span><span class="p">(</span>
    <span class="n">train</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> 
    <span class="n">test</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> 
    <span class="n">label_horizon</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
    <span class="n">embargo_days</span><span class="o">=</span><span class="mi">1</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Original training samples: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">train</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;After purge + embargo:     </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">purged_train_idx</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Removed:                   </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">train</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">purged_train_idx</span><span class="p">)</span><span class="si">}</span><span class="s2"> samples&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell exercise-header"><h3>Exercise 2.2: Time Series Splitter (Guided)</h3>
<p>Build a comprehensive time series splitter class.</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 2.2: Time Series Splitter (Guided)</span>

<span class="k">class</span> <span class="nc">TimeSeriesSplitter</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Handles time series data splitting with purging and embargo.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">,</span> <span class="n">purge_days</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">embargo_days</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_size</span> <span class="o">=</span> <span class="n">test_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">purge_days</span> <span class="o">=</span> <span class="n">purge_days</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">embargo_days</span> <span class="o">=</span> <span class="n">embargo_days</span>
    
    <span class="k">def</span> <span class="nf">split</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Split data into train and test sets.</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            Dictionary with train and test DataFrames and metadata</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        
        <span class="c1"># TODO: Calculate split index</span>
        <span class="n">split_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">______</span><span class="p">))</span>
        
        <span class="c1"># Initial split</span>
        <span class="n">train</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="n">split_idx</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">test</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">______</span><span class="p">:]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        
        <span class="c1"># Apply purge and embargo</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">purge_days</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">embargo_days</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">total_gap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">purge_days</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">embargo_days</span>
            <span class="n">train</span> <span class="o">=</span> <span class="n">train</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="o">-</span><span class="n">total_gap</span><span class="p">]</span> <span class="k">if</span> <span class="n">total_gap</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">train</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;train&#39;</span><span class="p">:</span> <span class="n">train</span><span class="p">,</span>
            <span class="s1">&#39;test&#39;</span><span class="p">:</span> <span class="n">test</span><span class="p">,</span>
            <span class="s1">&#39;train_size&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">______</span><span class="p">),</span>
            <span class="s1">&#39;test_size&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">______</span><span class="p">),</span>
            <span class="s1">&#39;split_date&#39;</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">split_idx</span><span class="p">]</span>
        <span class="p">}</span>

<span class="c1"># Test</span>
<span class="n">splitter</span> <span class="o">=</span> <span class="n">TimeSeriesSplitter</span><span class="p">(</span><span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">purge_days</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">embargo_days</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">splitter</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">df_clean</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Time Series Split with Purge/Embargo:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Training samples: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;train_size&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Test samples: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;test_size&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Split date: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;split_date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">date</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 2.2</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">TimeSeriesSplitter</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Handles time series data splitting with purging and embargo.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">,</span> <span class="n">purge_days</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">embargo_days</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_size</span> <span class="o">=</span> <span class="n">test_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">purge_days</span> <span class="o">=</span> <span class="n">purge_days</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">embargo_days</span> <span class="o">=</span> <span class="n">embargo_days</span>

    <span class="k">def</span> <span class="nf">split</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Split data into train and test sets.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

        <span class="c1"># Calculate split index</span>
        <span class="n">split_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_size</span><span class="p">))</span>

        <span class="c1"># Initial split</span>
        <span class="n">train</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="n">split_idx</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">test</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">split_idx</span><span class="p">:]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># Apply purge and embargo</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">purge_days</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">embargo_days</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">total_gap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">purge_days</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">embargo_days</span>
            <span class="n">train</span> <span class="o">=</span> <span class="n">train</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="o">-</span><span class="n">total_gap</span><span class="p">]</span> <span class="k">if</span> <span class="n">total_gap</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">train</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;train&#39;</span><span class="p">:</span> <span class="n">train</span><span class="p">,</span>
            <span class="s1">&#39;test&#39;</span><span class="p">:</span> <span class="n">test</span><span class="p">,</span>
            <span class="s1">&#39;train_size&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">train</span><span class="p">),</span>
            <span class="s1">&#39;test_size&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">test</span><span class="p">),</span>
            <span class="s1">&#39;split_date&#39;</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">split_idx</span><span class="p">]</span>
        <span class="p">}</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h2>2.3 Cross-Validation for Finance</h2>
<p>Standard k-fold cross-validation doesn't work for time series.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Time Series Cross-Validation with sklearn</span>

<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">TimeSeriesSplit</span>

<span class="c1"># Create sample feature matrix</span>
<span class="n">df_features</span> <span class="o">=</span> <span class="n">df_clean</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">df_features</span><span class="p">[</span><span class="s1">&#39;returns&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_features</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span>
<span class="n">df_features</span><span class="p">[</span><span class="s1">&#39;volatility&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_features</span><span class="p">[</span><span class="s1">&#39;returns&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
<span class="n">df_features</span><span class="p">[</span><span class="s1">&#39;momentum&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_features</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="n">df_features</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df_features</span><span class="p">[</span><span class="s1">&#39;returns&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="n">df_features</span> <span class="o">=</span> <span class="n">df_features</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

<span class="n">X</span> <span class="o">=</span> <span class="n">df_features</span><span class="p">[[</span><span class="s1">&#39;returns&#39;</span><span class="p">,</span> <span class="s1">&#39;volatility&#39;</span><span class="p">,</span> <span class="s1">&#39;momentum&#39;</span><span class="p">]]</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">df_features</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span>

<span class="c1"># Time series cross-validation</span>
<span class="n">tscv</span> <span class="o">=</span> <span class="n">TimeSeriesSplit</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Time Series Cross-Validation Folds:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>

<span class="k">for</span> <span class="n">fold</span><span class="p">,</span> <span class="p">(</span><span class="n">train_idx</span><span class="p">,</span> <span class="n">test_idx</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tscv</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">X</span><span class="p">),</span> <span class="mi">1</span><span class="p">):</span>
    <span class="n">train_start</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">train_idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
    <span class="n">train_end</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">train_idx</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
    <span class="n">test_start</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">test_idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
    <span class="n">test_end</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">test_idx</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Fold </span><span class="si">{</span><span class="n">fold</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Train: </span><span class="si">{</span><span class="n">train_start</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">train_end</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">train_idx</span><span class="p">)</span><span class="si">}</span><span class="s2"> samples)&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Test:  </span><span class="si">{</span><span class="n">test_start</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">test_end</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">test_idx</span><span class="p">)</span><span class="si">}</span><span class="s2"> samples)&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Visualize the CV folds</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="k">for</span> <span class="n">fold</span><span class="p">,</span> <span class="p">(</span><span class="n">train_idx</span><span class="p">,</span> <span class="n">test_idx</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tscv</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">X</span><span class="p">)):</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">fold</span><span class="p">]</span>
    
    <span class="c1"># Plot training period</span>
    <span class="n">train_dates</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">train_idx</span><span class="p">]</span>
    <span class="n">test_dates</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">test_idx</span><span class="p">]</span>
    
    <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">train_dates</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Train&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">test_dates</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Test&#39;</span><span class="p">)</span>
    
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Fold </span><span class="si">{</span><span class="n">fold</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">X</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    
    <span class="k">if</span> <span class="n">fold</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Time Series Cross-Validation Folds&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Run cross-validation with a model</span>

<span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">RandomForestClassifier</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">accuracy_score</span><span class="p">,</span> <span class="n">f1_score</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">RandomForestClassifier</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
<span class="n">tscv</span> <span class="o">=</span> <span class="n">TimeSeriesSplit</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

<span class="n">cv_results</span> <span class="o">=</span> <span class="p">[]</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Cross-Validation Results:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>

<span class="k">for</span> <span class="n">fold</span><span class="p">,</span> <span class="p">(</span><span class="n">train_idx</span><span class="p">,</span> <span class="n">test_idx</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tscv</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">X</span><span class="p">),</span> <span class="mi">1</span><span class="p">):</span>
    <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_idx</span><span class="p">],</span> <span class="n">X</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">test_idx</span><span class="p">]</span>
    <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_idx</span><span class="p">],</span> <span class="n">y</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">test_idx</span><span class="p">]</span>
    
    <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
    <span class="n">y_pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
    
    <span class="n">acc</span> <span class="o">=</span> <span class="n">accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
    <span class="n">f1</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
    
    <span class="n">cv_results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;fold&#39;</span><span class="p">:</span> <span class="n">fold</span><span class="p">,</span> <span class="s1">&#39;accuracy&#39;</span><span class="p">:</span> <span class="n">acc</span><span class="p">,</span> <span class="s1">&#39;f1&#39;</span><span class="p">:</span> <span class="n">f1</span><span class="p">})</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Fold </span><span class="si">{</span><span class="n">fold</span><span class="si">}</span><span class="s2">: Accuracy=</span><span class="si">{</span><span class="n">acc</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, F1=</span><span class="si">{</span><span class="n">f1</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Summary</span>
<span class="n">results_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">cv_results</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Mean Accuracy: </span><span class="si">{</span><span class="n">results_df</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> (+/- </span><span class="si">{</span><span class="n">results_df</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mean F1:       </span><span class="si">{</span><span class="n">results_df</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> (+/- </span><span class="si">{</span><span class="n">results_df</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell exercise-header"><h3>Exercise 2.3: Custom CV Generator (Guided)</h3>
<p>Build a custom cross-validation generator with gap support.</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 2.3: Custom CV Generator (Guided)</span>

<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Generator</span><span class="p">,</span> <span class="n">Tuple</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="k">def</span> <span class="nf">time_series_cv_with_gap</span><span class="p">(</span>
    <span class="n">n_samples</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">n_splits</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
    <span class="n">gap</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate time series CV indices with a gap between train and test.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        n_samples: Total number of samples</span>
<span class="sd">        n_splits: Number of CV folds</span>
<span class="sd">        gap: Number of samples to skip between train and test</span>
<span class="sd">        </span>
<span class="sd">    Yields:</span>
<span class="sd">        Tuple of (train_indices, test_indices)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Calculate test size per fold</span>
    <span class="n">test_size</span> <span class="o">=</span> <span class="n">n_samples</span> <span class="o">//</span> <span class="p">(</span><span class="n">n_splits</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_splits</span><span class="p">):</span>
        <span class="c1"># TODO: Calculate train end index</span>
        <span class="n">train_end</span> <span class="o">=</span> <span class="n">test_size</span> <span class="o">*</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        
        <span class="c1"># TODO: Calculate test start and end (with gap)</span>
        <span class="n">test_start</span> <span class="o">=</span> <span class="n">train_end</span> <span class="o">+</span> <span class="n">______</span>
        <span class="n">test_end</span> <span class="o">=</span> <span class="n">test_start</span> <span class="o">+</span> <span class="n">______</span>
        
        <span class="c1"># Ensure we don&#39;t exceed array bounds</span>
        <span class="k">if</span> <span class="n">test_end</span> <span class="o">&gt;</span> <span class="n">n_samples</span><span class="p">:</span>
            <span class="n">test_end</span> <span class="o">=</span> <span class="n">n_samples</span>
        
        <span class="c1"># TODO: Create index arrays</span>
        <span class="n">train_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">______</span><span class="p">)</span>
        <span class="n">test_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">______</span><span class="p">,</span> <span class="n">test_end</span><span class="p">)</span>
        
        <span class="k">yield</span> <span class="n">train_indices</span><span class="p">,</span> <span class="n">test_indices</span>

<span class="c1"># Test</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Custom CV with Gap:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>

<span class="k">for</span> <span class="n">fold</span><span class="p">,</span> <span class="p">(</span><span class="n">train_idx</span><span class="p">,</span> <span class="n">test_idx</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">time_series_cv_with_gap</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">),</span> <span class="n">n_splits</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">gap</span><span class="o">=</span><span class="mi">5</span><span class="p">),</span> <span class="mi">1</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Fold </span><span class="si">{</span><span class="n">fold</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Train: indices 0-</span><span class="si">{</span><span class="n">train_idx</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">train_idx</span><span class="p">)</span><span class="si">}</span><span class="s2"> samples)&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Gap: </span><span class="si">{</span><span class="n">train_idx</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">test_idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">test_idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">train_idx</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="si">}</span><span class="s2"> samples)&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Test: indices </span><span class="si">{</span><span class="n">test_idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">test_idx</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">test_idx</span><span class="p">)</span><span class="si">}</span><span class="s2"> samples)&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 2.3</summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">time_series_cv_with_gap</span><span class="p">(</span>
    <span class="n">n_samples</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">n_splits</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
    <span class="n">gap</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate time series CV indices with a gap between train and test.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">test_size</span> <span class="o">=</span> <span class="n">n_samples</span> <span class="o">//</span> <span class="p">(</span><span class="n">n_splits</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_splits</span><span class="p">):</span>
        <span class="c1"># Calculate train end index</span>
        <span class="n">train_end</span> <span class="o">=</span> <span class="n">test_size</span> <span class="o">*</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Calculate test start and end (with gap)</span>
        <span class="n">test_start</span> <span class="o">=</span> <span class="n">train_end</span> <span class="o">+</span> <span class="n">gap</span>
        <span class="n">test_end</span> <span class="o">=</span> <span class="n">test_start</span> <span class="o">+</span> <span class="n">test_size</span>

        <span class="c1"># Ensure we don&#39;t exceed array bounds</span>
        <span class="k">if</span> <span class="n">test_end</span> <span class="o">&gt;</span> <span class="n">n_samples</span><span class="p">:</span>
            <span class="n">test_end</span> <span class="o">=</span> <span class="n">n_samples</span>

        <span class="c1"># Create index arrays</span>
        <span class="n">train_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">train_end</span><span class="p">)</span>
        <span class="n">test_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">test_start</span><span class="p">,</span> <span class="n">test_end</span><span class="p">)</span>

        <span class="k">yield</span> <span class="n">train_indices</span><span class="p">,</span> <span class="n">test_indices</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h2>2.4 Handling Imbalanced Data</h2>
<p>Trading labels are often imbalanced (e.g., more up days than down days).</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Check class balance</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Class Balance Analysis:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>

<span class="n">class_counts</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
<span class="n">class_pcts</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">value_counts</span><span class="p">(</span><span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Class Distribution:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Class 0 (Down): </span><span class="si">{</span><span class="n">class_counts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">class_pcts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Class 1 (Up):   </span><span class="si">{</span><span class="n">class_counts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">class_pcts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>

<span class="n">imbalance_ratio</span> <span class="o">=</span> <span class="n">class_counts</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">/</span> <span class="n">class_counts</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Imbalance Ratio: </span><span class="si">{</span><span class="n">imbalance_ratio</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">:1&quot;</span><span class="p">)</span>

<span class="k">if</span> <span class="n">imbalance_ratio</span> <span class="o">&gt;</span> <span class="mf">1.5</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Warning: Dataset is imbalanced. Consider:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  - Class weights&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  - Oversampling minority class&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  - Undersampling majority class&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  - Using appropriate metrics (F1, precision, recall)&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Techniques for handling imbalanced data</span>

<span class="kn">from</span> <span class="nn">sklearn.utils.class_weight</span> <span class="kn">import</span> <span class="n">compute_class_weight</span>

<span class="c1"># Method 1: Class weights</span>
<span class="n">class_weights</span> <span class="o">=</span> <span class="n">compute_class_weight</span><span class="p">(</span><span class="s1">&#39;balanced&#39;</span><span class="p">,</span> <span class="n">classes</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">y</span><span class="p">),</span> <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">)</span>
<span class="n">weight_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">y</span><span class="p">),</span> <span class="n">class_weights</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Method 1: Class Weights&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Computed weights: </span><span class="si">{</span><span class="n">weight_dict</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  Usage: model.fit(X, y, sample_weight=weights)&quot;</span><span class="p">)</span>

<span class="c1"># Method 2: Sample weights based on class</span>
<span class="n">sample_weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">weight_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">y</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Method 2: Sample Weights&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Shape: </span><span class="si">{</span><span class="n">sample_weights</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Method 3: Using class_weight parameter in sklearn models</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Method 3: Built-in class_weight parameter&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  Usage: RandomForestClassifier(class_weight=&#39;balanced&#39;)&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Compare balanced vs unbalanced training</span>

<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">classification_report</span>

<span class="c1"># Split data</span>
<span class="n">split_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.8</span><span class="p">)</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span> <span class="o">=</span> <span class="n">X</span><span class="p">[:</span><span class="n">split_idx</span><span class="p">],</span> <span class="n">X</span><span class="p">[</span><span class="n">split_idx</span><span class="p">:]</span>
<span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">y</span><span class="p">[:</span><span class="n">split_idx</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">split_idx</span><span class="p">:]</span>

<span class="c1"># Model without class weights</span>
<span class="n">model_unbalanced</span> <span class="o">=</span> <span class="n">RandomForestClassifier</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
<span class="n">model_unbalanced</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="n">y_pred_unbalanced</span> <span class="o">=</span> <span class="n">model_unbalanced</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>

<span class="c1"># Model with class weights</span>
<span class="n">model_balanced</span> <span class="o">=</span> <span class="n">RandomForestClassifier</span><span class="p">(</span>
    <span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> 
    <span class="n">max_depth</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> 
    <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span>
    <span class="n">class_weight</span><span class="o">=</span><span class="s1">&#39;balanced&#39;</span>
<span class="p">)</span>
<span class="n">model_balanced</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="n">y_pred_balanced</span> <span class="o">=</span> <span class="n">model_balanced</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Comparison: Unbalanced vs Balanced Training&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Unbalanced Model:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">classification_report</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_unbalanced</span><span class="p">,</span> <span class="n">target_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Down&#39;</span><span class="p">,</span> <span class="s1">&#39;Up&#39;</span><span class="p">]))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Balanced Model (class_weight=&#39;balanced&#39;):&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">classification_report</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_balanced</span><span class="p">,</span> <span class="n">target_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Down&#39;</span><span class="p">,</span> <span class="s1">&#39;Up&#39;</span><span class="p">]))</span>
</code></pre></div>
<div class="md-cell exercise-header"><hr />
<h2>Open-Ended Exercises</h2>
<h3>Exercise 2.4: Complete Data Pipeline (Open-ended)</h3>
<p>Build a complete data preparation pipeline class.</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 2.4: Complete Data Pipeline (Open-ended)</span>
<span class="c1">#</span>
<span class="c1"># Build a DataPipeline class that:</span>
<span class="c1">#</span>
<span class="c1"># - Downloads data for a given symbol</span>
<span class="c1"># - Cleans missing values</span>
<span class="c1"># - Detects and handles outliers</span>
<span class="c1"># - Performs time series train/test split</span>
<span class="c1"># - Reports data quality metrics</span>
<span class="c1">#</span>
<span class="c1"># Your implementation:</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 2.4</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">DataPipeline</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Complete data preparation pipeline for financial ML.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">period</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;2y&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span> <span class="o">=</span> <span class="n">symbol</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">period</span> <span class="o">=</span> <span class="n">period</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">raw_data</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clean_data</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">quality_report</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">fetch</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;DataPipeline&#39;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Download data.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">raw_data</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">Ticker</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">)</span><span class="o">.</span><span class="n">history</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">period</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">quality_report</span><span class="p">[</span><span class="s1">&#39;rows_downloaded&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">raw_data</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">clean</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fill_method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;ffill&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;DataPipeline&#39;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Clean missing values.&quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># Record missing before</span>
        <span class="n">missing_before</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

        <span class="c1"># Fill prices</span>
        <span class="n">price_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Open&#39;</span><span class="p">,</span> <span class="s1">&#39;High&#39;</span><span class="p">,</span> <span class="s1">&#39;Low&#39;</span><span class="p">,</span> <span class="s1">&#39;Close&#39;</span><span class="p">]</span>
        <span class="n">df</span><span class="p">[</span><span class="n">price_cols</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">price_cols</span><span class="p">]</span><span class="o">.</span><span class="n">ffill</span><span class="p">()</span>

        <span class="c1"># Fill volume</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Volume&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Volume&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Remove remaining NaN rows</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">clean_data</span> <span class="o">=</span> <span class="n">df</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">quality_report</span><span class="p">[</span><span class="s1">&#39;missing_filled&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">missing_before</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">quality_report</span><span class="p">[</span><span class="s1">&#39;rows_after_cleaning&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">handle_outliers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">column</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;returns&#39;</span><span class="p">,</span> <span class="n">n_std</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">5</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;DataPipeline&#39;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Detect and optionally cap outliers.&quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clean_data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># Create returns if not exists</span>
        <span class="k">if</span> <span class="n">column</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;returns&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span>

        <span class="n">mean</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">column</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">std</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">column</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
        <span class="n">lower</span> <span class="o">=</span> <span class="n">mean</span> <span class="o">-</span> <span class="n">n_std</span> <span class="o">*</span> <span class="n">std</span>
        <span class="n">upper</span> <span class="o">=</span> <span class="n">mean</span> <span class="o">+</span> <span class="n">n_std</span> <span class="o">*</span> <span class="n">std</span>

        <span class="n">outliers</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">column</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">lower</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">column</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">upper</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">quality_report</span><span class="p">[</span><span class="s1">&#39;outliers_detected&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">outliers</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

        <span class="c1"># Cap outliers</span>
        <span class="n">df</span><span class="p">[</span><span class="n">column</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">column</span><span class="p">]</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">lower</span><span class="p">,</span> <span class="n">upper</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clean_data</span> <span class="o">=</span> <span class="n">df</span>

        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">split</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;DataPipeline&#39;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Time series train/test split.&quot;&quot;&quot;</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">clean_data</span><span class="p">)</span>
        <span class="n">split_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">test_size</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">train</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clean_data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="n">split_idx</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clean_data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">split_idx</span><span class="p">:]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">quality_report</span><span class="p">[</span><span class="s1">&#39;train_size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">quality_report</span><span class="p">[</span><span class="s1">&#39;test_size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">quality_report</span><span class="p">[</span><span class="s1">&#39;split_date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">clean_data</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">split_idx</span><span class="p">]</span><span class="o">.</span><span class="n">date</span><span class="p">())</span>

        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">get_report</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Return quality report.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">quality_report</span>

<span class="c1"># Test</span>
<span class="n">pipeline</span> <span class="o">=</span> <span class="n">DataPipeline</span><span class="p">(</span><span class="s1">&#39;AAPL&#39;</span><span class="p">,</span> <span class="s1">&#39;2y&#39;</span><span class="p">)</span>
<span class="n">pipeline</span><span class="o">.</span><span class="n">fetch</span><span class="p">()</span><span class="o">.</span><span class="n">clean</span><span class="p">()</span><span class="o">.</span><span class="n">handle_outliers</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Pipeline Report:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">get_report</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell exercise-header"><h3>Exercise 2.5: Walk-Forward Validator (Open-ended)</h3>
<p>Build a walk-forward validation system.</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 2.5: Walk-Forward Validator (Open-ended)</span>
<span class="c1">#</span>
<span class="c1"># Build a WalkForwardValidator class that:</span>
<span class="c1">#</span>
<span class="c1"># - Implements expanding window training</span>
<span class="c1"># - Supports configurable test window size</span>
<span class="c1"># - Tracks metrics across all folds</span>
<span class="c1"># - Returns detailed results with dates</span>
<span class="c1">#</span>
<span class="c1"># Your implementation:</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 2.5</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">WalkForwardValidator</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Walk-forward validation for time series ML.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">initial_train_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">test_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">step_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            initial_train_size: Initial training window size</span>
<span class="sd">            test_size: Size of each test window</span>
<span class="sd">            step_size: How much to move forward (defaults to test_size)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initial_train_size</span> <span class="o">=</span> <span class="n">initial_train_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_size</span> <span class="o">=</span> <span class="n">test_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">step_size</span> <span class="o">=</span> <span class="n">step_size</span> <span class="ow">or</span> <span class="n">test_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">split</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate walk-forward splits.</span>

<span class="sd">        Yields:</span>
<span class="sd">            Tuple of (train_idx, test_idx)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="n">train_end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_train_size</span>

        <span class="k">while</span> <span class="n">train_end</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_size</span> <span class="o">&lt;=</span> <span class="n">n</span><span class="p">:</span>
            <span class="n">train_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">train_end</span><span class="p">)</span>
            <span class="n">test_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">train_end</span><span class="p">,</span> <span class="n">train_end</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_size</span><span class="p">)</span>

            <span class="k">yield</span> <span class="n">train_idx</span><span class="p">,</span> <span class="n">test_idx</span>

            <span class="n">train_end</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step_size</span>

    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">metric_func</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run walk-forward validation.</span>

<span class="sd">        Args:</span>
<span class="sd">            X: Feature DataFrame</span>
<span class="sd">            y: Target Series</span>
<span class="sd">            model: sklearn-compatible model</span>
<span class="sd">            metric_func: Function(y_true, y_pred) -&gt; float</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dictionary with validation results</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">fold</span><span class="p">,</span> <span class="p">(</span><span class="n">train_idx</span><span class="p">,</span> <span class="n">test_idx</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">X</span><span class="p">),</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_idx</span><span class="p">],</span> <span class="n">X</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">test_idx</span><span class="p">]</span>
            <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_idx</span><span class="p">],</span> <span class="n">y</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">test_idx</span><span class="p">]</span>

            <span class="c1"># Train and predict</span>
            <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
            <span class="n">y_pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>

            <span class="c1"># Calculate metric</span>
            <span class="n">score</span> <span class="o">=</span> <span class="n">metric_func</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;fold&#39;</span><span class="p">:</span> <span class="n">fold</span><span class="p">,</span>
                <span class="s1">&#39;train_start&#39;</span><span class="p">:</span> <span class="n">X</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">train_idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
                <span class="s1">&#39;train_end&#39;</span><span class="p">:</span> <span class="n">X</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">train_idx</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span>
                <span class="s1">&#39;test_start&#39;</span><span class="p">:</span> <span class="n">X</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">test_idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
                <span class="s1">&#39;test_end&#39;</span><span class="p">:</span> <span class="n">X</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">test_idx</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span>
                <span class="s1">&#39;train_size&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_idx</span><span class="p">),</span>
                <span class="s1">&#39;test_size&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_idx</span><span class="p">),</span>
                <span class="s1">&#39;score&#39;</span><span class="p">:</span> <span class="n">score</span>
            <span class="p">})</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;folds&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">,</span>
            <span class="s1">&#39;mean_score&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">]),</span>
            <span class="s1">&#39;std_score&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">([</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">])</span>
        <span class="p">}</span>

<span class="c1"># Test</span>
<span class="n">wfv</span> <span class="o">=</span> <span class="n">WalkForwardValidator</span><span class="p">(</span><span class="n">initial_train_size</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">step_size</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">RandomForestClassifier</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>

<span class="n">results</span> <span class="o">=</span> <span class="n">wfv</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">accuracy_score</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Walk-Forward Validation Results:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mean Score: </span><span class="si">{</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;mean_score&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> (+/- </span><span class="si">{</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;std_score&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Folds: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;folds&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">fold</span> <span class="ow">in</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;folds&#39;</span><span class="p">][:</span><span class="mi">3</span><span class="p">]:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Fold </span><span class="si">{</span><span class="n">fold</span><span class="p">[</span><span class="s1">&#39;fold&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">fold</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">fold</span><span class="p">[</span><span class="s1">&#39;test_start&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">date</span><span class="p">()</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">fold</span><span class="p">[</span><span class="s1">&#39;test_end&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">date</span><span class="p">()</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell exercise-header"><h3>Exercise 2.6: Imbalanced Data Handler (Open-ended)</h3>
<p>Create a comprehensive solution for handling imbalanced trading labels.</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 2.6: Imbalanced Data Handler (Open-ended)</span>
<span class="c1">#</span>
<span class="c1"># Create an ImbalancedDataHandler class that:</span>
<span class="c1">#</span>
<span class="c1"># - Analyzes class distribution</span>
<span class="c1"># - Supports multiple rebalancing strategies</span>
<span class="c1"># - Computes appropriate sample weights</span>
<span class="c1"># - Provides before/after comparison</span>
<span class="c1">#</span>
<span class="c1"># Your implementation:</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 2.6</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">ImbalancedDataHandler</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Handle imbalanced classification data in trading.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">y</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">class_counts</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">class_pcts</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">value_counts</span><span class="p">(</span><span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">analyze</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Analyze class distribution.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;counts&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_counts</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(),</span>
            <span class="s1">&#39;percentages&#39;</span><span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">class_pcts</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(),</span>
            <span class="s1">&#39;imbalance_ratio&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_counts</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_counts</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span>
            <span class="s1">&#39;majority_class&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_counts</span><span class="o">.</span><span class="n">idxmax</span><span class="p">(),</span>
            <span class="s1">&#39;minority_class&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_counts</span><span class="o">.</span><span class="n">idxmin</span><span class="p">()</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">compute_class_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">strategy</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;balanced&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute class weights.</span>

<span class="sd">        Strategies:</span>
<span class="sd">            - &#39;balanced&#39;: sklearn&#39;s balanced method</span>
<span class="sd">            - &#39;inverse&#39;: simple inverse frequency</span>
<span class="sd">            - &#39;sqrt_inverse&#39;: square root of inverse frequency</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">classes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">strategy</span> <span class="o">==</span> <span class="s1">&#39;balanced&#39;</span><span class="p">:</span>
            <span class="n">weights</span> <span class="o">=</span> <span class="n">compute_class_weight</span><span class="p">(</span><span class="s1">&#39;balanced&#39;</span><span class="p">,</span> <span class="n">classes</span><span class="o">=</span><span class="n">classes</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">strategy</span> <span class="o">==</span> <span class="s1">&#39;inverse&#39;</span><span class="p">:</span>
            <span class="n">weights</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">classes</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">class_counts</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">classes</span><span class="p">]))</span>
        <span class="k">elif</span> <span class="n">strategy</span> <span class="o">==</span> <span class="s1">&#39;sqrt_inverse&#39;</span><span class="p">:</span>
            <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">classes</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">class_counts</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">classes</span><span class="p">])))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">classes</span><span class="p">))</span>

        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">classes</span><span class="p">,</span> <span class="n">weights</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">compute_sample_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">class_weights</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Compute per-sample weights from class weights.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">class_weights</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">class_weights</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_class_weights</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">class_weights</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">get_report</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Generate analysis report.&quot;&quot;&quot;</span>
        <span class="n">analysis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze</span><span class="p">()</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_class_weights</span><span class="p">()</span>

        <span class="n">report</span> <span class="o">=</span> <span class="s2">&quot;Imbalanced Data Analysis</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">40</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">report</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Class Distribution:</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">for</span> <span class="bp">cls</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> <span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;counts&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">pct</span> <span class="o">=</span> <span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;percentages&#39;</span><span class="p">][</span><span class="bp">cls</span><span class="p">]</span>
            <span class="n">report</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;  Class </span><span class="si">{</span><span class="bp">cls</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">count</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">pct</span><span class="si">}</span><span class="s2">%)</span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="n">report</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Imbalance Ratio: </span><span class="si">{</span><span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;imbalance_ratio&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">:1</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">report</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Recommended Class Weights:</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">for</span> <span class="bp">cls</span><span class="p">,</span> <span class="n">weight</span> <span class="ow">in</span> <span class="n">weights</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">report</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;  Class </span><span class="si">{</span><span class="bp">cls</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">weight</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="k">return</span> <span class="n">report</span>

<span class="c1"># Test</span>
<span class="n">handler</span> <span class="o">=</span> <span class="n">ImbalancedDataHandler</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">handler</span><span class="o">.</span><span class="n">get_report</span><span class="p">())</span>

<span class="c1"># Get sample weights</span>
<span class="n">sample_weights</span> <span class="o">=</span> <span class="n">handler</span><span class="o">.</span><span class="n">compute_sample_weights</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Sample weights shape: </span><span class="si">{</span><span class="n">sample_weights</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sample weights range: </span><span class="si">{</span><span class="n">sample_weights</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">sample_weights</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell module-project"><hr />
<h2>Module Project: Data Preparation Pipeline</h2>
<p>Build a complete, production-ready data preparation pipeline.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Module Project: Complete Data Preparation Pipeline</span>

<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">TimeSeriesSplit</span>
<span class="kn">from</span> <span class="nn">sklearn.utils.class_weight</span> <span class="kn">import</span> <span class="n">compute_class_weight</span>
<span class="kn">import</span> <span class="nn">yfinance</span> <span class="k">as</span> <span class="nn">yf</span>


<span class="k">class</span> <span class="nc">MLDataPipeline</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Production-ready data preparation pipeline for financial ML.</span>
<span class="sd">    </span>
<span class="sd">    This pipeline handles the complete data preparation workflow:</span>
<span class="sd">    1. Data fetching and validation</span>
<span class="sd">    2. Cleaning and outlier handling</span>
<span class="sd">    3. Time series splitting with purge/embargo</span>
<span class="sd">    4. Class balance handling</span>
<span class="sd">    5. Quality reporting</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize pipeline with configuration.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            config: Pipeline configuration dictionary</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default_config</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">raw_data</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">processed_data</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_data</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_data</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">quality_metrics</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">processing_log</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">def</span> <span class="nf">_default_config</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Default pipeline configuration.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="s1">&#39;yfinance&#39;</span><span class="p">,</span>
                <span class="s1">&#39;period&#39;</span><span class="p">:</span> <span class="s1">&#39;2y&#39;</span>
            <span class="p">},</span>
            <span class="s1">&#39;cleaning&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;fill_method&#39;</span><span class="p">:</span> <span class="s1">&#39;ffill&#39;</span><span class="p">,</span>
                <span class="s1">&#39;outlier_std&#39;</span><span class="p">:</span> <span class="mf">5.0</span>
            <span class="p">},</span>
            <span class="s1">&#39;splitting&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;test_size&#39;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">,</span>
                <span class="s1">&#39;purge_days&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
                <span class="s1">&#39;embargo_days&#39;</span><span class="p">:</span> <span class="mi">1</span>
            <span class="p">},</span>
            <span class="s1">&#39;balance&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;strategy&#39;</span><span class="p">:</span> <span class="s1">&#39;balanced&#39;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">_log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add message to processing log.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">processing_log</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">fetch_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;MLDataPipeline&#39;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fetch data for a symbol.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            symbol: Ticker symbol</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            Self for chaining</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">period</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;period&#39;</span><span class="p">]</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Fetching </span><span class="si">{</span><span class="n">symbol</span><span class="si">}</span><span class="s2"> data for </span><span class="si">{</span><span class="n">period</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
        
        <span class="n">ticker</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">Ticker</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">raw_data</span> <span class="o">=</span> <span class="n">ticker</span><span class="o">.</span><span class="n">history</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="n">period</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">quality_metrics</span><span class="p">[</span><span class="s1">&#39;symbol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">symbol</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">quality_metrics</span><span class="p">[</span><span class="s1">&#39;rows_fetched&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">raw_data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">quality_metrics</span><span class="p">[</span><span class="s1">&#39;date_range&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">raw_data</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">date</span><span class="p">()),</span>
            <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">raw_data</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">date</span><span class="p">())</span>
        <span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Fetched </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">raw_data</span><span class="p">)</span><span class="si">}</span><span class="s2"> rows&quot;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="bp">self</span>
    
    <span class="k">def</span> <span class="nf">clean_data</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;MLDataPipeline&#39;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Clean the data by handling missing values and outliers.</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            Self for chaining</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s2">&quot;Cleaning data...&quot;</span><span class="p">)</span>
        
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        
        <span class="c1"># Record initial missing</span>
        <span class="n">missing_before</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        
        <span class="c1"># Fill price data</span>
        <span class="n">price_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Open&#39;</span><span class="p">,</span> <span class="s1">&#39;High&#39;</span><span class="p">,</span> <span class="s1">&#39;Low&#39;</span><span class="p">,</span> <span class="s1">&#39;Close&#39;</span><span class="p">]</span>
        <span class="n">fill_method</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;cleaning&#39;</span><span class="p">][</span><span class="s1">&#39;fill_method&#39;</span><span class="p">]</span>
        <span class="n">df</span><span class="p">[</span><span class="n">price_cols</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">price_cols</span><span class="p">]</span><span class="o">.</span><span class="n">ffill</span><span class="p">()</span>
        
        <span class="c1"># Fill volume</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Volume&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Volume&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        
        <span class="c1"># Remove remaining NaN</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
        
        <span class="c1"># Create returns</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;returns&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span>
        
        <span class="c1"># Handle outliers</span>
        <span class="n">outlier_std</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;cleaning&#39;</span><span class="p">][</span><span class="s1">&#39;outlier_std&#39;</span><span class="p">]</span>
        <span class="n">mean</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;returns&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">std</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;returns&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
        <span class="n">lower</span><span class="p">,</span> <span class="n">upper</span> <span class="o">=</span> <span class="n">mean</span> <span class="o">-</span> <span class="n">outlier_std</span> <span class="o">*</span> <span class="n">std</span><span class="p">,</span> <span class="n">mean</span> <span class="o">+</span> <span class="n">outlier_std</span> <span class="o">*</span> <span class="n">std</span>
        <span class="n">outliers</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;returns&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">lower</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;returns&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">upper</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;returns&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;returns&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">lower</span><span class="p">,</span> <span class="n">upper</span><span class="p">)</span>
        
        <span class="c1"># Drop first row (NaN from pct_change)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">processed_data</span> <span class="o">=</span> <span class="n">df</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">quality_metrics</span><span class="p">[</span><span class="s1">&#39;missing_filled&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">missing_before</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">quality_metrics</span><span class="p">[</span><span class="s1">&#39;outliers_clipped&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">outliers</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">quality_metrics</span><span class="p">[</span><span class="s1">&#39;rows_after_cleaning&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Filled </span><span class="si">{</span><span class="n">missing_before</span><span class="si">}</span><span class="s2"> missing values&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Clipped </span><span class="si">{</span><span class="n">outliers</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="si">}</span><span class="s2"> outliers&quot;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="bp">self</span>
    
    <span class="k">def</span> <span class="nf">split_data</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;MLDataPipeline&#39;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Split data into train and test sets with purge/embargo.</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            Self for chaining</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s2">&quot;Splitting data...&quot;</span><span class="p">)</span>
        
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">processed_data</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        
        <span class="n">test_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;splitting&#39;</span><span class="p">][</span><span class="s1">&#39;test_size&#39;</span><span class="p">]</span>
        <span class="n">purge_days</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;splitting&#39;</span><span class="p">][</span><span class="s1">&#39;purge_days&#39;</span><span class="p">]</span>
        <span class="n">embargo_days</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;splitting&#39;</span><span class="p">][</span><span class="s1">&#39;embargo_days&#39;</span><span class="p">]</span>
        
        <span class="c1"># Calculate split point</span>
        <span class="n">split_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">test_size</span><span class="p">))</span>
        
        <span class="c1"># Apply purge and embargo to training set</span>
        <span class="n">gap</span> <span class="o">=</span> <span class="n">purge_days</span> <span class="o">+</span> <span class="n">embargo_days</span>
        <span class="n">train_end</span> <span class="o">=</span> <span class="n">split_idx</span> <span class="o">-</span> <span class="n">gap</span> <span class="k">if</span> <span class="n">gap</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">split_idx</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">train_data</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="n">train_end</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_data</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">split_idx</span><span class="p">:]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">quality_metrics</span><span class="p">[</span><span class="s1">&#39;train_size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">quality_metrics</span><span class="p">[</span><span class="s1">&#39;test_size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">quality_metrics</span><span class="p">[</span><span class="s1">&#39;gap_size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gap</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">quality_metrics</span><span class="p">[</span><span class="s1">&#39;split_date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">split_idx</span><span class="p">]</span><span class="o">.</span><span class="n">date</span><span class="p">())</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Training set: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_data</span><span class="p">)</span><span class="si">}</span><span class="s2"> rows&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Test set: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_data</span><span class="p">)</span><span class="si">}</span><span class="s2"> rows&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Gap (purge + embargo): </span><span class="si">{</span><span class="n">gap</span><span class="si">}</span><span class="s2"> rows&quot;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="bp">self</span>
    
    <span class="k">def</span> <span class="nf">compute_class_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;target&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute class weights for imbalanced data.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            target_col: Name of target column</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            Dictionary of class weights</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">target_col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_data</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{}</span>
        
        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_data</span><span class="p">[</span><span class="n">target_col</span><span class="p">]</span>
        <span class="n">classes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="n">compute_class_weight</span><span class="p">(</span><span class="s1">&#39;balanced&#39;</span><span class="p">,</span> <span class="n">classes</span><span class="o">=</span><span class="n">classes</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">classes</span><span class="p">,</span> <span class="n">weights</span><span class="p">))</span>
    
    <span class="k">def</span> <span class="nf">get_quality_report</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate a comprehensive quality report.</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            Formatted quality report string</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">report</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>
        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;DATA PIPELINE QUALITY REPORT&quot;</span><span class="p">)</span>
        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>
        
        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Symbol: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">quality_metrics</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;symbol&#39;</span><span class="p">,</span> <span class="s1">&#39;N/A&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Date Range: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">quality_metrics</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;date_range&#39;</span><span class="p">,</span> <span class="s1">&#39;N/A&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Data Volume:&quot;</span><span class="p">)</span>
        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Rows fetched: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">quality_metrics</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;rows_fetched&#39;</span><span class="p">,</span> <span class="s1">&#39;N/A&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Rows after cleaning: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">quality_metrics</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;rows_after_cleaning&#39;</span><span class="p">,</span> <span class="s1">&#39;N/A&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Data Quality:&quot;</span><span class="p">)</span>
        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Missing values filled: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">quality_metrics</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;missing_filled&#39;</span><span class="p">,</span> <span class="s1">&#39;N/A&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Outliers clipped: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">quality_metrics</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;outliers_clipped&#39;</span><span class="p">,</span> <span class="s1">&#39;N/A&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Train/Test Split:&quot;</span><span class="p">)</span>
        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Training samples: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">quality_metrics</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;train_size&#39;</span><span class="p">,</span> <span class="s1">&#39;N/A&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Test samples: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">quality_metrics</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;test_size&#39;</span><span class="p">,</span> <span class="s1">&#39;N/A&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Gap (purge + embargo): </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">quality_metrics</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;gap_size&#39;</span><span class="p">,</span> <span class="s1">&#39;N/A&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Split date: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">quality_metrics</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;split_date&#39;</span><span class="p">,</span> <span class="s1">&#39;N/A&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Processing Log:&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">log_entry</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">processing_log</span><span class="p">:</span>
            <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - </span><span class="si">{</span><span class="n">log_entry</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">report</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;MLDataPipeline&#39;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run the complete pipeline.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            symbol: Ticker symbol to process</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            Self with processed data</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fetch_data</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span><span class="o">.</span><span class="n">clean_data</span><span class="p">()</span><span class="o">.</span><span class="n">split_data</span><span class="p">()</span>


<span class="c1"># Run the complete pipeline</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Running Complete Data Pipeline...&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>

<span class="c1"># Initialize with custom config</span>
<span class="n">config</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="s1">&#39;yfinance&#39;</span><span class="p">,</span> <span class="s1">&#39;period&#39;</span><span class="p">:</span> <span class="s1">&#39;2y&#39;</span><span class="p">},</span>
    <span class="s1">&#39;cleaning&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;fill_method&#39;</span><span class="p">:</span> <span class="s1">&#39;ffill&#39;</span><span class="p">,</span> <span class="s1">&#39;outlier_std&#39;</span><span class="p">:</span> <span class="mf">5.0</span><span class="p">},</span>
    <span class="s1">&#39;splitting&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;test_size&#39;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">,</span> <span class="s1">&#39;purge_days&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;embargo_days&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">},</span>
    <span class="s1">&#39;balance&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;strategy&#39;</span><span class="p">:</span> <span class="s1">&#39;balanced&#39;</span><span class="p">}</span>
<span class="p">}</span>

<span class="n">pipeline</span> <span class="o">=</span> <span class="n">MLDataPipeline</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
<span class="n">pipeline</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s1">&#39;SPY&#39;</span><span class="p">)</span>

<span class="c1"># Print quality report</span>
<span class="nb">print</span><span class="p">(</span><span class="n">pipeline</span><span class="o">.</span><span class="n">get_quality_report</span><span class="p">())</span>

<span class="c1"># Show sample of processed data</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;SAMPLE PROCESSED DATA:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">pipeline</span><span class="o">.</span><span class="n">processed_data</span><span class="o">.</span><span class="n">tail</span><span class="p">())</span>
</code></pre></div>
<div class="md-cell key-takeaways"><hr />
<h2>Key Takeaways</h2>
<ol>
<li>
<p><strong>Data Quality Matters</strong>: Clean missing values appropriately for financial data (forward fill for prices, zero for volume)</p>
</li>
<li>
<p><strong>Never Random Shuffle</strong>: Time series data must maintain temporal order in train/test splits</p>
</li>
<li>
<p><strong>Purge and Embargo</strong>: When labels span multiple days, add gaps between train and test to prevent leakage</p>
</li>
<li>
<p><strong>Time Series CV</strong>: Use TimeSeriesSplit or custom walk-forward validation, never standard k-fold</p>
</li>
<li>
<p><strong>Handle Imbalance</strong>: Use class weights or sample weights to address imbalanced trading labels</p>
</li>
<li>
<p><strong>Document Everything</strong>: Keep a processing log to track all data transformations</p>
</li>
</ol>
<hr />
<p><strong>Next: Module 3 - Feature Engineering</strong></p>
<p>Learn how to create predictive features from price data, technical indicators, and statistical measures.</p></div>
        <div class="nav-buttons">
            <button class="nav-btn prev-btn disabled" type="button">
                <span class="nav-btn-label">‚Üê Previous</span>
                <span class="nav-btn-name"></span>
            </button>
            <button class="nav-btn next-btn disabled" type="button">
                <span class="nav-btn-label">Next ‚Üí</span>
                <span class="nav-btn-name"></span>
            </button>
        </div>
        </div>
<div class="module-section" data-idx="3"><div class="md-cell module-header"><h1>Module 3: Feature Engineering</h1>
<h2>Part 1: ML Fundamentals for Finance</h2>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Duration</th>
<th>Exercises</th>
</tr>
</thead>
<tbody>
<tr>
<td>~2.5 hours</td>
<td>6</td>
</tr>
</tbody>
</table></div>
<h3>Learning Objectives</h3>
<p>By the end of this module, you will be able to:</p>
<ul>
<li>Create price-based features for ML models</li>
<li>Convert technical indicators into ML features</li>
<li>Build statistical features using rolling windows</li>
<li>Apply feature selection techniques</li>
</ul></div>
<div class="md-cell"><hr />
<h2>3.1 Price-Based Features</h2>
<p>The foundation of financial ML features starts with price data transformations.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">yfinance</span> <span class="k">as</span> <span class="nn">yf</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>

<span class="c1"># Download sample data</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Downloading data...&quot;</span><span class="p">)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">Ticker</span><span class="p">(</span><span class="s2">&quot;SPY&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">history</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="s2">&quot;2y&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Downloaded </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="si">}</span><span class="s2"> rows&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Price-based features</span>

<span class="k">def</span> <span class="nf">create_price_features</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create price-based features from OHLCV data.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        df: DataFrame with OHLCV columns</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        DataFrame with added features</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">features</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    
    <span class="c1"># Returns at multiple horizons</span>
    <span class="k">for</span> <span class="n">period</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">]:</span>
        <span class="n">features</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;return_</span><span class="si">{</span><span class="n">period</span><span class="si">}</span><span class="s1">d&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">(</span><span class="n">period</span><span class="p">)</span>
    
    <span class="c1"># Log returns (more stable for ML)</span>
    <span class="n">features</span><span class="p">[</span><span class="s1">&#39;log_return&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">features</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
    
    <span class="c1"># Price ratios</span>
    <span class="n">features</span><span class="p">[</span><span class="s1">&#39;close_to_open&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;Open&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">features</span><span class="p">[</span><span class="s1">&#39;high_to_low&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;High&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;Low&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">features</span><span class="p">[</span><span class="s1">&#39;close_to_high&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;High&#39;</span><span class="p">]</span>
    <span class="n">features</span><span class="p">[</span><span class="s1">&#39;close_to_low&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;Low&#39;</span><span class="p">]</span>
    
    <span class="c1"># Gap features</span>
    <span class="n">features</span><span class="p">[</span><span class="s1">&#39;overnight_gap&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;Open&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
    
    <span class="c1"># Volume features</span>
    <span class="n">features</span><span class="p">[</span><span class="s1">&#39;volume_change&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;Volume&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span>
    <span class="n">features</span><span class="p">[</span><span class="s1">&#39;volume_ma_ratio&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;Volume&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;Volume&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    
    <span class="k">return</span> <span class="n">features</span>

<span class="c1"># Create features</span>
<span class="n">df_features</span> <span class="o">=</span> <span class="n">create_price_features</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

<span class="c1"># Show new features</span>
<span class="n">new_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">df_features</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Created </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">new_cols</span><span class="p">)</span><span class="si">}</span><span class="s2"> price-based features:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">new_cols</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - </span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Volatility features</span>

<span class="k">def</span> <span class="nf">create_volatility_features</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">return_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;return_1d&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create volatility-based features.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        df: DataFrame with returns</span>
<span class="sd">        return_col: Name of returns column</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        DataFrame with volatility features</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">features</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    
    <span class="c1"># Historical volatility at different windows</span>
    <span class="k">for</span> <span class="n">window</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">60</span><span class="p">]:</span>
        <span class="n">features</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;volatility_</span><span class="si">{</span><span class="n">window</span><span class="si">}</span><span class="s1">d&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="n">return_col</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span>
    
    <span class="c1"># Volatility ratio (short-term vs long-term)</span>
    <span class="n">features</span><span class="p">[</span><span class="s1">&#39;vol_ratio_5_20&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;volatility_5d&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;volatility_20d&#39;</span><span class="p">]</span>
    
    <span class="c1"># Parkinson volatility (uses high/low)</span>
    <span class="n">features</span><span class="p">[</span><span class="s1">&#39;parkinson_vol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
        <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">features</span><span class="p">[</span><span class="s1">&#39;High&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;Low&#39;</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">/</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
    <span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span>
    
    <span class="c1"># Garman-Klass volatility</span>
    <span class="n">features</span><span class="p">[</span><span class="s1">&#39;gk_vol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
        <span class="p">(</span>
            <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">features</span><span class="p">[</span><span class="s1">&#39;High&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;Low&#39;</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span>
            <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">features</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;Open&#39;</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
        <span class="p">)</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">features</span>

<span class="c1"># Add volatility features</span>
<span class="n">df_features</span> <span class="o">=</span> <span class="n">create_volatility_features</span><span class="p">(</span><span class="n">df_features</span><span class="p">)</span>

<span class="n">vol_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">df_features</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="s1">&#39;vol&#39;</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Volatility features: </span><span class="si">{</span><span class="n">vol_cols</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell exercise-header"><h3>Exercise 3.1: Price Feature Generator (Guided)</h3>
<p>Build a comprehensive price feature generator.</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 3.1: Price Feature Generator (Guided)</span>

<span class="k">def</span> <span class="nf">generate_return_features</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">horizons</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate return features at multiple horizons.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        df: DataFrame with &#39;Close&#39; column</span>
<span class="sd">        horizons: List of periods for returns calculation</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        DataFrame with return features</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">horizons</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">horizons</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">]</span>
    
    <span class="n">features</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    
    <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">horizons</span><span class="p">:</span>
        <span class="c1"># TODO: Calculate simple returns</span>
        <span class="n">features</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;return_</span><span class="si">{</span><span class="n">h</span><span class="si">}</span><span class="s1">d&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">______</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
        
        <span class="c1"># TODO: Calculate log returns</span>
        <span class="n">features</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;log_return_</span><span class="si">{</span><span class="n">h</span><span class="si">}</span><span class="s1">d&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">features</span><span class="p">[</span><span class="s1">&#39;______&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="n">______</span><span class="p">))</span>
    
    <span class="k">return</span> <span class="n">features</span>

<span class="c1"># Test</span>
<span class="n">test_df</span> <span class="o">=</span> <span class="n">generate_return_features</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">horizons</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">20</span><span class="p">])</span>
<span class="n">return_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">test_df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="s1">&#39;return&#39;</span> <span class="ow">in</span> <span class="n">c</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generated features: </span><span class="si">{</span><span class="n">return_cols</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Sample values:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">test_df</span><span class="p">[</span><span class="n">return_cols</span><span class="p">]</span><span class="o">.</span><span class="n">tail</span><span class="p">())</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 3.1</summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">generate_return_features</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">horizons</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate return features at multiple horizons.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">horizons</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">horizons</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">]</span>

    <span class="n">features</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">horizons</span><span class="p">:</span>
        <span class="c1"># Calculate simple returns</span>
        <span class="n">features</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;return_</span><span class="si">{</span><span class="n">h</span><span class="si">}</span><span class="s1">d&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>

        <span class="c1"># Calculate log returns</span>
        <span class="n">features</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;log_return_</span><span class="si">{</span><span class="n">h</span><span class="si">}</span><span class="s1">d&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">features</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="n">h</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">features</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h2>3.2 Technical Indicator Features</h2>
<p>Converting traditional technical indicators into ML-ready features.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Technical indicator features</span>

<span class="k">def</span> <span class="nf">create_technical_features</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create technical indicator features.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        df: DataFrame with OHLCV data</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        DataFrame with technical features</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">features</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    
    <span class="c1"># Moving Averages</span>
    <span class="k">for</span> <span class="n">period</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">200</span><span class="p">]:</span>
        <span class="n">features</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;sma_</span><span class="si">{</span><span class="n">period</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">period</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">features</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;ema_</span><span class="si">{</span><span class="n">period</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">ewm</span><span class="p">(</span><span class="n">span</span><span class="o">=</span><span class="n">period</span><span class="p">,</span> <span class="n">adjust</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        
        <span class="c1"># Distance from MA (normalized)</span>
        <span class="n">features</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;dist_sma_</span><span class="si">{</span><span class="n">period</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">features</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">features</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;sma_</span><span class="si">{</span><span class="n">period</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="n">features</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;sma_</span><span class="si">{</span><span class="n">period</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span>
    
    <span class="c1"># RSI</span>
    <span class="n">delta</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span>
    <span class="n">gain</span> <span class="o">=</span> <span class="n">delta</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">delta</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">14</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">delta</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">delta</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">14</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">rs</span> <span class="o">=</span> <span class="n">gain</span> <span class="o">/</span> <span class="n">loss</span>
    <span class="n">features</span><span class="p">[</span><span class="s1">&#39;rsi_14&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">-</span> <span class="p">(</span><span class="mi">100</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">rs</span><span class="p">))</span>
    
    <span class="c1"># RSI normalized to [-1, 1] for better ML performance</span>
    <span class="n">features</span><span class="p">[</span><span class="s1">&#39;rsi_normalized&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">features</span><span class="p">[</span><span class="s1">&#39;rsi_14&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">50</span><span class="p">)</span> <span class="o">/</span> <span class="mi">50</span>
    
    <span class="c1"># MACD</span>
    <span class="n">ema12</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">ewm</span><span class="p">(</span><span class="n">span</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">adjust</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">ema26</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">ewm</span><span class="p">(</span><span class="n">span</span><span class="o">=</span><span class="mi">26</span><span class="p">,</span> <span class="n">adjust</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">features</span><span class="p">[</span><span class="s1">&#39;macd&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ema12</span> <span class="o">-</span> <span class="n">ema26</span>
    <span class="n">features</span><span class="p">[</span><span class="s1">&#39;macd_signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;macd&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">ewm</span><span class="p">(</span><span class="n">span</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span> <span class="n">adjust</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">features</span><span class="p">[</span><span class="s1">&#39;macd_hist&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;macd&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;macd_signal&#39;</span><span class="p">]</span>
    
    <span class="c1"># Normalize MACD by price</span>
    <span class="n">features</span><span class="p">[</span><span class="s1">&#39;macd_normalized&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;macd&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span>
    
    <span class="c1"># Bollinger Bands</span>
    <span class="n">sma20</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">std20</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
    <span class="n">features</span><span class="p">[</span><span class="s1">&#39;bb_upper&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sma20</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">std20</span>
    <span class="n">features</span><span class="p">[</span><span class="s1">&#39;bb_lower&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sma20</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">std20</span>
    <span class="n">features</span><span class="p">[</span><span class="s1">&#39;bb_position&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">features</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;bb_lower&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">features</span><span class="p">[</span><span class="s1">&#39;bb_upper&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;bb_lower&#39;</span><span class="p">])</span>
    <span class="n">features</span><span class="p">[</span><span class="s1">&#39;bb_width&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">features</span><span class="p">[</span><span class="s1">&#39;bb_upper&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;bb_lower&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="n">sma20</span>
    
    <span class="c1"># ATR</span>
    <span class="n">high_low</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;High&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;Low&#39;</span><span class="p">]</span>
    <span class="n">high_close</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">features</span><span class="p">[</span><span class="s1">&#39;High&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">())</span>
    <span class="n">low_close</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">features</span><span class="p">[</span><span class="s1">&#39;Low&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">())</span>
    <span class="n">true_range</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">high_low</span><span class="p">,</span> <span class="n">high_close</span><span class="p">,</span> <span class="n">low_close</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">features</span><span class="p">[</span><span class="s1">&#39;atr_14&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">true_range</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">14</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">features</span><span class="p">[</span><span class="s1">&#39;atr_normalized&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;atr_14&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span>
    
    <span class="k">return</span> <span class="n">features</span>

<span class="c1"># Create technical features</span>
<span class="n">df_features</span> <span class="o">=</span> <span class="n">create_technical_features</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

<span class="c1"># Show technical features</span>
<span class="n">tech_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;rsi_14&#39;</span><span class="p">,</span> <span class="s1">&#39;rsi_normalized&#39;</span><span class="p">,</span> <span class="s1">&#39;macd_normalized&#39;</span><span class="p">,</span> <span class="s1">&#39;bb_position&#39;</span><span class="p">,</span> <span class="s1">&#39;bb_width&#39;</span><span class="p">,</span> <span class="s1">&#39;atr_normalized&#39;</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Sample technical features:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">df_features</span><span class="p">[</span><span class="n">tech_cols</span><span class="p">]</span><span class="o">.</span><span class="n">tail</span><span class="p">())</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Crossover and divergence features</span>

<span class="k">def</span> <span class="nf">create_crossover_features</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create features based on indicator crossovers and divergences.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        df: DataFrame with technical indicators</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        DataFrame with crossover features</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">features</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    
    <span class="c1"># Create MAs if not present</span>
    <span class="k">if</span> <span class="s1">&#39;sma_20&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">features</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;sma_20&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="k">if</span> <span class="s1">&#39;sma_50&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">features</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;sma_50&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    
    <span class="c1"># Price above/below MA (binary)</span>
    <span class="n">features</span><span class="p">[</span><span class="s1">&#39;above_sma_20&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">features</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;sma_20&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">features</span><span class="p">[</span><span class="s1">&#39;above_sma_50&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">features</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;sma_50&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    
    <span class="c1"># Days since last crossover</span>
    <span class="n">cross_20</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;above_sma_20&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span>
    <span class="n">features</span><span class="p">[</span><span class="s1">&#39;days_since_sma20_cross&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cross_20</span><span class="o">.</span><span class="n">groupby</span><span class="p">((</span><span class="n">cross_20</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">cumsum</span><span class="p">())</span><span class="o">.</span><span class="n">cumcount</span><span class="p">()</span>
    
    <span class="c1"># MA crossovers</span>
    <span class="n">features</span><span class="p">[</span><span class="s1">&#39;golden_cross&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">(</span><span class="n">features</span><span class="p">[</span><span class="s1">&#39;sma_20&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;sma_50&#39;</span><span class="p">])</span> <span class="o">&amp;</span> 
        <span class="p">(</span><span class="n">features</span><span class="p">[</span><span class="s1">&#39;sma_20&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;sma_50&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
    <span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    
    <span class="n">features</span><span class="p">[</span><span class="s1">&#39;death_cross&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">(</span><span class="n">features</span><span class="p">[</span><span class="s1">&#39;sma_20&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;sma_50&#39;</span><span class="p">])</span> <span class="o">&amp;</span> 
        <span class="p">(</span><span class="n">features</span><span class="p">[</span><span class="s1">&#39;sma_20&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;sma_50&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
    <span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    
    <span class="c1"># RSI oversold/overbought</span>
    <span class="k">if</span> <span class="s1">&#39;rsi_14&#39;</span> <span class="ow">in</span> <span class="n">features</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;rsi_oversold&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">features</span><span class="p">[</span><span class="s1">&#39;rsi_14&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">30</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;rsi_overbought&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">features</span><span class="p">[</span><span class="s1">&#39;rsi_14&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">70</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">features</span>

<span class="c1"># Add crossover features</span>
<span class="n">df_features</span> <span class="o">=</span> <span class="n">create_crossover_features</span><span class="p">(</span><span class="n">df_features</span><span class="p">)</span>

<span class="n">cross_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;above_sma_20&#39;</span><span class="p">,</span> <span class="s1">&#39;above_sma_50&#39;</span><span class="p">,</span> <span class="s1">&#39;golden_cross&#39;</span><span class="p">,</span> <span class="s1">&#39;death_cross&#39;</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Crossover features:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">df_features</span><span class="p">[</span><span class="n">cross_cols</span><span class="p">]</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
</code></pre></div>
<div class="md-cell exercise-header"><h3>Exercise 3.2: Technical Feature Builder (Guided)</h3>
<p>Create an RSI feature with multiple periods and normalizations.</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 3.2: Technical Feature Builder (Guided)</span>

<span class="k">def</span> <span class="nf">build_rsi_features</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">periods</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Build RSI features at multiple periods.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        df: DataFrame with &#39;Close&#39; column</span>
<span class="sd">        periods: List of RSI periods</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        DataFrame with RSI features</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">periods</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">periods</span> <span class="o">=</span> <span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">21</span><span class="p">]</span>
    
    <span class="n">features</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    
    <span class="k">for</span> <span class="n">period</span> <span class="ow">in</span> <span class="n">periods</span><span class="p">:</span>
        <span class="c1"># TODO: Calculate price changes</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">______</span><span class="p">()</span>
        
        <span class="c1"># TODO: Separate gains and losses</span>
        <span class="n">gain</span> <span class="o">=</span> <span class="n">delta</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">delta</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">______</span><span class="p">)</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">period</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">delta</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">delta</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">______</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        
        <span class="c1"># TODO: Calculate RSI</span>
        <span class="n">rs</span> <span class="o">=</span> <span class="n">gain</span> <span class="o">/</span> <span class="n">loss</span>
        <span class="n">features</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;rsi_</span><span class="si">{</span><span class="n">period</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">-</span> <span class="p">(</span><span class="mi">100</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">______</span><span class="p">))</span>
        
        <span class="c1"># Normalized version</span>
        <span class="n">features</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;rsi_</span><span class="si">{</span><span class="n">period</span><span class="si">}</span><span class="s1">_norm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">features</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;rsi_</span><span class="si">{</span><span class="n">period</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">50</span><span class="p">)</span> <span class="o">/</span> <span class="mi">50</span>
    
    <span class="k">return</span> <span class="n">features</span>

<span class="c1"># Test</span>
<span class="n">test_df</span> <span class="o">=</span> <span class="n">build_rsi_features</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
<span class="n">rsi_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">test_df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="s1">&#39;rsi&#39;</span> <span class="ow">in</span> <span class="n">c</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;RSI features: </span><span class="si">{</span><span class="n">rsi_cols</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">test_df</span><span class="p">[</span><span class="n">rsi_cols</span><span class="p">]</span><span class="o">.</span><span class="n">tail</span><span class="p">())</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 3.2</summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">build_rsi_features</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">periods</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Build RSI features at multiple periods.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">periods</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">periods</span> <span class="o">=</span> <span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">21</span><span class="p">]</span>

    <span class="n">features</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">period</span> <span class="ow">in</span> <span class="n">periods</span><span class="p">:</span>
        <span class="c1"># Calculate price changes</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span>

        <span class="c1"># Separate gains and losses</span>
        <span class="n">gain</span> <span class="o">=</span> <span class="n">delta</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">delta</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">period</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">delta</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">delta</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">period</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

        <span class="c1"># Calculate RSI</span>
        <span class="n">rs</span> <span class="o">=</span> <span class="n">gain</span> <span class="o">/</span> <span class="n">loss</span>
        <span class="n">features</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;rsi_</span><span class="si">{</span><span class="n">period</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">-</span> <span class="p">(</span><span class="mi">100</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">rs</span><span class="p">))</span>

        <span class="c1"># Normalized version</span>
        <span class="n">features</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;rsi_</span><span class="si">{</span><span class="n">period</span><span class="si">}</span><span class="s1">_norm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">features</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;rsi_</span><span class="si">{</span><span class="n">period</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">50</span><span class="p">)</span> <span class="o">/</span> <span class="mi">50</span>

    <span class="k">return</span> <span class="n">features</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h2>3.3 Statistical Features</h2>
<p>Statistical transformations that help ML models understand data distribution.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Statistical features</span>

<span class="k">def</span> <span class="nf">create_statistical_features</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">windows</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create statistical features using rolling windows.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        df: DataFrame with price data</span>
<span class="sd">        windows: List of window sizes</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        DataFrame with statistical features</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">windows</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">windows</span> <span class="o">=</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">]</span>
    
    <span class="n">features</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    
    <span class="c1"># Ensure returns exist</span>
    <span class="k">if</span> <span class="s1">&#39;returns&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">features</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;returns&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span>
    
    <span class="k">for</span> <span class="n">window</span> <span class="ow">in</span> <span class="n">windows</span><span class="p">:</span>
        <span class="c1"># Rolling statistics</span>
        <span class="n">features</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;rolling_mean_</span><span class="si">{</span><span class="n">window</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;returns&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">features</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;rolling_std_</span><span class="si">{</span><span class="n">window</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;returns&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
        <span class="n">features</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;rolling_min_</span><span class="si">{</span><span class="n">window</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;returns&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="n">features</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;rolling_max_</span><span class="si">{</span><span class="n">window</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;returns&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        
        <span class="c1"># Z-score of returns</span>
        <span class="n">mean</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;returns&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">std</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;returns&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
        <span class="n">features</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;zscore_</span><span class="si">{</span><span class="n">window</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">features</span><span class="p">[</span><span class="s1">&#39;returns&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">mean</span><span class="p">)</span> <span class="o">/</span> <span class="n">std</span>
        
        <span class="c1"># Percentile rank</span>
        <span class="n">features</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;percentile_rank_</span><span class="si">{</span><span class="n">window</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;returns&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">x</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="mf">0.5</span><span class="p">,</span>
            <span class="n">raw</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        
        <span class="c1"># Skewness and kurtosis</span>
        <span class="n">features</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;skew_</span><span class="si">{</span><span class="n">window</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;returns&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="p">)</span><span class="o">.</span><span class="n">skew</span><span class="p">()</span>
        <span class="n">features</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;kurtosis_</span><span class="si">{</span><span class="n">window</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;returns&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="p">)</span><span class="o">.</span><span class="n">kurt</span><span class="p">()</span>
    
    <span class="k">return</span> <span class="n">features</span>

<span class="c1"># Create statistical features</span>
<span class="n">df_features</span> <span class="o">=</span> <span class="n">create_statistical_features</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

<span class="n">stat_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;zscore_20&#39;</span><span class="p">,</span> <span class="s1">&#39;percentile_rank_20&#39;</span><span class="p">,</span> <span class="s1">&#39;skew_20&#39;</span><span class="p">,</span> <span class="s1">&#39;kurtosis_20&#39;</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Statistical features:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">df_features</span><span class="p">[</span><span class="n">stat_cols</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">tail</span><span class="p">())</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Autocorrelation features</span>

<span class="k">def</span> <span class="nf">create_autocorrelation_features</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">lags</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">window</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">60</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create autocorrelation features.</span>
<span class="sd">    </span>
<span class="sd">    These capture momentum/mean-reversion patterns.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        df: DataFrame with returns</span>
<span class="sd">        lags: List of lags to compute</span>
<span class="sd">        window: Rolling window size</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        DataFrame with autocorrelation features</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">lags</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">lags</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">]</span>
    
    <span class="n">features</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    
    <span class="k">if</span> <span class="s1">&#39;returns&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">features</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;returns&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span>
    
    <span class="k">for</span> <span class="n">lag</span> <span class="ow">in</span> <span class="n">lags</span><span class="p">:</span>
        <span class="c1"># Rolling autocorrelation</span>
        <span class="n">features</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;autocorr_lag</span><span class="si">{</span><span class="n">lag</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;returns&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">autocorr</span><span class="p">(</span><span class="n">lag</span><span class="o">=</span><span class="n">lag</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">lag</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
            <span class="n">raw</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
    
    <span class="k">return</span> <span class="n">features</span>

<span class="c1"># Create autocorrelation features</span>
<span class="n">df_autocorr</span> <span class="o">=</span> <span class="n">create_autocorrelation_features</span><span class="p">(</span><span class="n">df_features</span><span class="p">[[</span><span class="s1">&#39;Close&#39;</span><span class="p">,</span> <span class="s1">&#39;returns&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>

<span class="n">autocorr_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">df_autocorr</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="s1">&#39;autocorr&#39;</span> <span class="ow">in</span> <span class="n">c</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Autocorrelation features:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">df_autocorr</span><span class="p">[</span><span class="n">autocorr_cols</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">tail</span><span class="p">())</span>
</code></pre></div>
<div class="md-cell exercise-header"><h3>Exercise 3.3: Z-Score Feature Builder (Guided)</h3>
<p>Build z-score features for multiple columns.</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 3.3: Z-Score Feature Builder (Guided)</span>

<span class="k">def</span> <span class="nf">create_zscore_features</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">columns</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">window</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create z-score normalized versions of columns.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        df: Input DataFrame</span>
<span class="sd">        columns: Columns to normalize</span>
<span class="sd">        window: Rolling window for statistics</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        DataFrame with z-score features</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">features</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">features</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">continue</span>
        
        <span class="c1"># TODO: Calculate rolling mean</span>
        <span class="n">roll_mean</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">______</span><span class="p">(</span><span class="n">window</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        
        <span class="c1"># TODO: Calculate rolling standard deviation</span>
        <span class="n">roll_std</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">______</span><span class="p">)</span><span class="o">.</span><span class="n">______</span><span class="p">()</span>
        
        <span class="c1"># TODO: Calculate z-score</span>
        <span class="n">features</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s1">_zscore&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">features</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">-</span> <span class="n">______</span><span class="p">)</span> <span class="o">/</span> <span class="n">______</span>
        
        <span class="c1"># Clip extreme values for stability</span>
        <span class="n">features</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s1">_zscore&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s1">_zscore&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">features</span>

<span class="c1"># Test</span>
<span class="n">df_test</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">df_test</span><span class="p">[</span><span class="s1">&#39;returns&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_test</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span>
<span class="n">df_test</span><span class="p">[</span><span class="s1">&#39;volume_change&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_test</span><span class="p">[</span><span class="s1">&#39;Volume&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span>

<span class="n">df_zscore</span> <span class="o">=</span> <span class="n">create_zscore_features</span><span class="p">(</span><span class="n">df_test</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;returns&#39;</span><span class="p">,</span> <span class="s1">&#39;volume_change&#39;</span><span class="p">])</span>
<span class="n">zscore_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">df_zscore</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="s1">&#39;zscore&#39;</span> <span class="ow">in</span> <span class="n">c</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Z-score features: </span><span class="si">{</span><span class="n">zscore_cols</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">df_zscore</span><span class="p">[</span><span class="n">zscore_cols</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">describe</span><span class="p">())</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 3.3</summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">create_zscore_features</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">columns</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">window</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create z-score normalized versions of columns.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">features</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">features</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="c1"># Calculate rolling mean</span>
        <span class="n">roll_mean</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

        <span class="c1"># Calculate rolling standard deviation</span>
        <span class="n">roll_std</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>

        <span class="c1"># Calculate z-score</span>
        <span class="n">features</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s1">_zscore&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">features</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">-</span> <span class="n">roll_mean</span><span class="p">)</span> <span class="o">/</span> <span class="n">roll_std</span>

        <span class="c1"># Clip extreme values for stability</span>
        <span class="n">features</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s1">_zscore&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s1">_zscore&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">features</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h2>3.4 Feature Selection</h2>
<p>Selecting the most predictive features and removing redundant ones.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Feature correlation analysis</span>

<span class="k">def</span> <span class="nf">analyze_feature_correlations</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">feature_cols</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.8</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Analyze correlations between features.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        df: DataFrame with features</span>
<span class="sd">        feature_cols: List of feature columns</span>
<span class="sd">        threshold: Correlation threshold for &quot;high&quot; correlation</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        Dictionary with correlation analysis</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Calculate correlation matrix</span>
    <span class="n">corr_matrix</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">feature_cols</span><span class="p">]</span><span class="o">.</span><span class="n">corr</span><span class="p">()</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span>
    
    <span class="c1"># Find highly correlated pairs</span>
    <span class="n">high_corr_pairs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">feature_cols</span><span class="p">)):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">feature_cols</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">corr_matrix</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">threshold</span><span class="p">:</span>
                <span class="n">high_corr_pairs</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s1">&#39;feature_1&#39;</span><span class="p">:</span> <span class="n">feature_cols</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                    <span class="s1">&#39;feature_2&#39;</span><span class="p">:</span> <span class="n">feature_cols</span><span class="p">[</span><span class="n">j</span><span class="p">],</span>
                    <span class="s1">&#39;correlation&#39;</span><span class="p">:</span> <span class="n">corr_matrix</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
                <span class="p">})</span>
    
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;correlation_matrix&#39;</span><span class="p">:</span> <span class="n">corr_matrix</span><span class="p">,</span>
        <span class="s1">&#39;high_correlation_pairs&#39;</span><span class="p">:</span> <span class="n">high_corr_pairs</span><span class="p">,</span>
        <span class="s1">&#39;n_high_corr&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">high_corr_pairs</span><span class="p">)</span>
    <span class="p">}</span>

<span class="c1"># Create a feature set and analyze</span>
<span class="n">df_full</span> <span class="o">=</span> <span class="n">create_price_features</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
<span class="n">df_full</span> <span class="o">=</span> <span class="n">create_technical_features</span><span class="p">(</span><span class="n">df_full</span><span class="p">)</span>
<span class="n">df_full</span> <span class="o">=</span> <span class="n">df_full</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

<span class="c1"># Select numeric feature columns</span>
<span class="n">feature_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;return_1d&#39;</span><span class="p">,</span> <span class="s1">&#39;return_5d&#39;</span><span class="p">,</span> <span class="s1">&#39;return_20d&#39;</span><span class="p">,</span> <span class="s1">&#39;volatility_5d&#39;</span><span class="p">,</span> <span class="s1">&#39;volatility_20d&#39;</span><span class="p">,</span>
                <span class="s1">&#39;rsi_normalized&#39;</span><span class="p">,</span> <span class="s1">&#39;macd_normalized&#39;</span><span class="p">,</span> <span class="s1">&#39;bb_position&#39;</span><span class="p">,</span> <span class="s1">&#39;atr_normalized&#39;</span><span class="p">]</span>
<span class="n">feature_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">feature_cols</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">df_full</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>

<span class="n">corr_analysis</span> <span class="o">=</span> <span class="n">analyze_feature_correlations</span><span class="p">(</span><span class="n">df_full</span><span class="p">,</span> <span class="n">feature_cols</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;High correlation pairs (&gt;0.8): </span><span class="si">{</span><span class="n">corr_analysis</span><span class="p">[</span><span class="s1">&#39;n_high_corr&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">corr_analysis</span><span class="p">[</span><span class="s1">&#39;high_correlation_pairs&#39;</span><span class="p">][:</span><span class="mi">5</span><span class="p">]:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">pair</span><span class="p">[</span><span class="s1">&#39;feature_1&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> &lt;-&gt; </span><span class="si">{</span><span class="n">pair</span><span class="p">[</span><span class="s1">&#39;feature_2&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">pair</span><span class="p">[</span><span class="s1">&#39;correlation&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Feature importance with Random Forest</span>

<span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">RandomForestClassifier</span>

<span class="k">def</span> <span class="nf">get_feature_importance</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">feature_cols</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">target_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate feature importance using Random Forest.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        df: DataFrame with features and target</span>
<span class="sd">        feature_cols: List of feature columns</span>
<span class="sd">        target_col: Name of target column</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        DataFrame with feature importances</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Prepare data</span>
    <span class="n">df_clean</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">feature_cols</span> <span class="o">+</span> <span class="p">[</span><span class="n">target_col</span><span class="p">]]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">df_clean</span><span class="p">[</span><span class="n">feature_cols</span><span class="p">]</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">df_clean</span><span class="p">[</span><span class="n">target_col</span><span class="p">]</span>
    
    <span class="c1"># Train model</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">RandomForestClassifier</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    
    <span class="c1"># Get importances</span>
    <span class="n">importance_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
        <span class="s1">&#39;feature&#39;</span><span class="p">:</span> <span class="n">feature_cols</span><span class="p">,</span>
        <span class="s1">&#39;importance&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">feature_importances_</span>
    <span class="p">})</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;importance&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">importance_df</span>

<span class="c1"># Create target</span>
<span class="n">df_full</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df_full</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="c1"># Get feature importances</span>
<span class="n">importance_df</span> <span class="o">=</span> <span class="n">get_feature_importance</span><span class="p">(</span><span class="n">df_full</span><span class="p">,</span> <span class="n">feature_cols</span><span class="p">,</span> <span class="s1">&#39;target&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Feature Importances (Random Forest):&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">importance_df</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Recursive feature elimination</span>

<span class="kn">from</span> <span class="nn">sklearn.feature_selection</span> <span class="kn">import</span> <span class="n">RFE</span>

<span class="k">def</span> <span class="nf">select_features_rfe</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">feature_cols</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">target_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">n_features</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Select top features using Recursive Feature Elimination.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        df: DataFrame with features and target</span>
<span class="sd">        feature_cols: List of feature columns</span>
<span class="sd">        target_col: Name of target column</span>
<span class="sd">        n_features: Number of features to select</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        List of selected feature names</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Prepare data</span>
    <span class="n">df_clean</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">feature_cols</span> <span class="o">+</span> <span class="p">[</span><span class="n">target_col</span><span class="p">]]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">df_clean</span><span class="p">[</span><span class="n">feature_cols</span><span class="p">]</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">df_clean</span><span class="p">[</span><span class="n">target_col</span><span class="p">]</span>
    
    <span class="c1"># RFE with Random Forest</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">RandomForestClassifier</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
    <span class="n">rfe</span> <span class="o">=</span> <span class="n">RFE</span><span class="p">(</span><span class="n">estimator</span><span class="o">=</span><span class="n">model</span><span class="p">,</span> <span class="n">n_features_to_select</span><span class="o">=</span><span class="n">n_features</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">rfe</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    
    <span class="c1"># Get selected features</span>
    <span class="n">selected</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">feature_cols</span><span class="p">,</span> <span class="n">rfe</span><span class="o">.</span><span class="n">support_</span><span class="p">)</span> <span class="k">if</span> <span class="n">s</span><span class="p">]</span>
    
    <span class="k">return</span> <span class="n">selected</span>

<span class="c1"># Select top 5 features</span>
<span class="n">selected_features</span> <span class="o">=</span> <span class="n">select_features_rfe</span><span class="p">(</span><span class="n">df_full</span><span class="p">,</span> <span class="n">feature_cols</span><span class="p">,</span> <span class="s1">&#39;target&#39;</span><span class="p">,</span> <span class="n">n_features</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Top 5 features (RFE):&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">feat</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">selected_features</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">. </span><span class="si">{</span><span class="n">feat</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell exercise-header"><hr />
<h2>Open-Ended Exercises</h2>
<h3>Exercise 3.4: Complete Feature Library (Open-ended)</h3>
<p>Build a comprehensive feature engineering library.</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 3.4: Complete Feature Library (Open-ended)</span>
<span class="c1">#</span>
<span class="c1"># Create a FeatureLibrary class that:</span>
<span class="c1">#</span>
<span class="c1"># - Has methods for price, technical, and statistical features</span>
<span class="c1"># - Tracks all created features</span>
<span class="c1"># - Supports feature selection</span>
<span class="c1"># - Returns a clean feature matrix ready for ML</span>
<span class="c1">#</span>
<span class="c1"># Your implementation:</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 3.4</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">FeatureLibrary</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Comprehensive feature engineering library for financial ML.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">original_df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">features_df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_names</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_groups</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">add_price_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">horizons</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;FeatureLibrary&#39;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Add price-based features.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">horizons</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">horizons</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">]</span>

        <span class="n">new_features</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">horizons</span><span class="p">:</span>
            <span class="n">col</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;return_</span><span class="si">{</span><span class="n">h</span><span class="si">}</span><span class="s1">d&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">features_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">features_df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
            <span class="n">new_features</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>

        <span class="c1"># Volatility</span>
        <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">20</span><span class="p">]:</span>
            <span class="n">col</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;volatility_</span><span class="si">{</span><span class="n">w</span><span class="si">}</span><span class="s1">d&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">features_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">features_df</span><span class="p">[</span><span class="s1">&#39;return_1d&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">w</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span>
            <span class="n">new_features</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">feature_names</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">new_features</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_groups</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_features</span>

        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">add_technical_features</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;FeatureLibrary&#39;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Add technical indicator features.&quot;&quot;&quot;</span>
        <span class="n">new_features</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># RSI</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">features_df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span>
        <span class="n">gain</span> <span class="o">=</span> <span class="n">delta</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">delta</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">14</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">delta</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">delta</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">14</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">features_df</span><span class="p">[</span><span class="s1">&#39;rsi_14&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">-</span> <span class="p">(</span><span class="mi">100</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">gain</span> <span class="o">/</span> <span class="n">loss</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">features_df</span><span class="p">[</span><span class="s1">&#39;rsi_normalized&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">features_df</span><span class="p">[</span><span class="s1">&#39;rsi_14&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">50</span><span class="p">)</span> <span class="o">/</span> <span class="mi">50</span>
        <span class="n">new_features</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s1">&#39;rsi_14&#39;</span><span class="p">,</span> <span class="s1">&#39;rsi_normalized&#39;</span><span class="p">])</span>

        <span class="c1"># MACD</span>
        <span class="n">ema12</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">features_df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">ewm</span><span class="p">(</span><span class="n">span</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">ema26</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">features_df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">ewm</span><span class="p">(</span><span class="n">span</span><span class="o">=</span><span class="mi">26</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">features_df</span><span class="p">[</span><span class="s1">&#39;macd_normalized&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">ema12</span> <span class="o">-</span> <span class="n">ema26</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">features_df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span>
        <span class="n">new_features</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;macd_normalized&#39;</span><span class="p">)</span>

        <span class="c1"># Bollinger position</span>
        <span class="n">sma20</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">features_df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">std20</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">features_df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">features_df</span><span class="p">[</span><span class="s1">&#39;bb_position&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">features_df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">sma20</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">std20</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">std20</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">new_features</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;bb_position&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">feature_names</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">new_features</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_groups</span><span class="p">[</span><span class="s1">&#39;technical&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_features</span>

        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">add_statistical_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">window</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;FeatureLibrary&#39;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Add statistical features.&quot;&quot;&quot;</span>
        <span class="n">new_features</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="s1">&#39;return_1d&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">features_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">features_df</span><span class="p">[</span><span class="s1">&#39;return_1d&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">features_df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span>

        <span class="c1"># Z-score</span>
        <span class="n">mean</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">features_df</span><span class="p">[</span><span class="s1">&#39;return_1d&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">std</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">features_df</span><span class="p">[</span><span class="s1">&#39;return_1d&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">features_df</span><span class="p">[</span><span class="s1">&#39;return_zscore&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">features_df</span><span class="p">[</span><span class="s1">&#39;return_1d&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">mean</span><span class="p">)</span> <span class="o">/</span> <span class="n">std</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">features_df</span><span class="p">[</span><span class="s1">&#39;return_zscore&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">features_df</span><span class="p">[</span><span class="s1">&#39;return_zscore&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">new_features</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;return_zscore&#39;</span><span class="p">)</span>

        <span class="c1"># Skewness and kurtosis</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">features_df</span><span class="p">[</span><span class="s1">&#39;skew_20&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">features_df</span><span class="p">[</span><span class="s1">&#39;return_1d&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="p">)</span><span class="o">.</span><span class="n">skew</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">features_df</span><span class="p">[</span><span class="s1">&#39;kurtosis_20&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">features_df</span><span class="p">[</span><span class="s1">&#39;return_1d&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="p">)</span><span class="o">.</span><span class="n">kurt</span><span class="p">()</span>
        <span class="n">new_features</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s1">&#39;skew_20&#39;</span><span class="p">,</span> <span class="s1">&#39;kurtosis_20&#39;</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">feature_names</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">new_features</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_groups</span><span class="p">[</span><span class="s1">&#39;statistical&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_features</span>

        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">select_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">n_features</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Select top features using importance.&quot;&quot;&quot;</span>
        <span class="n">df_clean</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">features_df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">feature_names</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
        <span class="n">target_clean</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_clean</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>

        <span class="n">model</span> <span class="o">=</span> <span class="n">RandomForestClassifier</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">df_clean</span><span class="p">,</span> <span class="n">target_clean</span><span class="p">)</span>

        <span class="n">importance</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">feature_importances_</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">feature_names</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">importance</span><span class="o">.</span><span class="n">nlargest</span><span class="p">(</span><span class="n">n_features</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get_feature_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feature_list</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Return clean feature matrix.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">feature_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">feature_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_names</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">features_df</span><span class="p">[</span><span class="n">feature_list</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Return feature library summary.&quot;&quot;&quot;</span>
        <span class="n">summary</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Feature Library Summary</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">40</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">summary</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;Total features: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">feature_names</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">for</span> <span class="n">group</span><span class="p">,</span> <span class="n">features</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_groups</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">summary</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">features</span><span class="p">)</span><span class="si">}</span><span class="s2"> features</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">return</span> <span class="n">summary</span>

<span class="c1"># Test</span>
<span class="n">library</span> <span class="o">=</span> <span class="n">FeatureLibrary</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
<span class="n">library</span><span class="o">.</span><span class="n">add_price_features</span><span class="p">()</span><span class="o">.</span><span class="n">add_technical_features</span><span class="p">()</span><span class="o">.</span><span class="n">add_statistical_features</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="n">library</span><span class="o">.</span><span class="n">get_summary</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Feature matrix shape: </span><span class="si">{</span><span class="n">library</span><span class="o">.</span><span class="n">get_feature_matrix</span><span class="p">()</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell exercise-header"><h3>Exercise 3.5: Multi-Timeframe Features (Open-ended)</h3>
<p>Create features that combine information from multiple timeframes.</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 3.5: Multi-Timeframe Features (Open-ended)</span>
<span class="c1">#</span>
<span class="c1"># Create a function that generates multi-timeframe features:</span>
<span class="c1">#</span>
<span class="c1"># - Calculate features at daily, weekly, and monthly scales</span>
<span class="c1"># - Create ratios between timeframes (e.g., daily vs weekly momentum)</span>
<span class="c1"># - Include alignment signals (all timeframes trending same direction)</span>
<span class="c1">#</span>
<span class="c1"># Your implementation:</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 3.5</summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">create_multi_timeframe_features</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create features combining multiple timeframes.</span>

<span class="sd">    Args:</span>
<span class="sd">        df: DataFrame with daily OHLCV data</span>

<span class="sd">    Returns:</span>
<span class="sd">        DataFrame with multi-timeframe features</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">features</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="c1"># Daily features (1-5 days)</span>
    <span class="n">features</span><span class="p">[</span><span class="s1">&#39;momentum_daily&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">features</span><span class="p">[</span><span class="s1">&#39;trend_daily&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">features</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

    <span class="c1"># Weekly features (5-20 days)</span>
    <span class="n">features</span><span class="p">[</span><span class="s1">&#39;momentum_weekly&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
    <span class="n">features</span><span class="p">[</span><span class="s1">&#39;trend_weekly&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">features</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

    <span class="c1"># Monthly features (20-60 days)</span>
    <span class="n">features</span><span class="p">[</span><span class="s1">&#39;momentum_monthly&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span>
    <span class="n">features</span><span class="p">[</span><span class="s1">&#39;trend_monthly&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">features</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

    <span class="c1"># Timeframe ratios</span>
    <span class="n">features</span><span class="p">[</span><span class="s1">&#39;momentum_ratio_dw&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;momentum_daily&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;momentum_weekly&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="mf">0.001</span><span class="p">)</span>
    <span class="n">features</span><span class="p">[</span><span class="s1">&#39;momentum_ratio_wm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;momentum_weekly&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;momentum_monthly&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="mf">0.001</span><span class="p">)</span>

    <span class="c1"># Trend alignment</span>
    <span class="n">features</span><span class="p">[</span><span class="s1">&#39;trend_alignment&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;trend_daily&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;trend_weekly&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;trend_monthly&#39;</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">/</span> <span class="mi">3</span>  <span class="c1"># 0 = all bearish, 1 = all bullish</span>

    <span class="c1"># Divergence signals</span>
    <span class="n">features</span><span class="p">[</span><span class="s1">&#39;daily_weekly_divergence&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">(</span><span class="n">features</span><span class="p">[</span><span class="s1">&#39;trend_daily&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">features</span><span class="p">[</span><span class="s1">&#39;trend_weekly&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

    <span class="c1"># Volatility across timeframes</span>
    <span class="n">features</span><span class="p">[</span><span class="s1">&#39;vol_5d&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span>
    <span class="n">features</span><span class="p">[</span><span class="s1">&#39;vol_20d&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span>
    <span class="n">features</span><span class="p">[</span><span class="s1">&#39;vol_ratio&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;vol_5d&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;vol_20d&#39;</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">features</span>

<span class="c1"># Test</span>
<span class="n">df_mtf</span> <span class="o">=</span> <span class="n">create_multi_timeframe_features</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
<span class="n">mtf_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;momentum_daily&#39;</span><span class="p">,</span> <span class="s1">&#39;momentum_weekly&#39;</span><span class="p">,</span> <span class="s1">&#39;momentum_monthly&#39;</span><span class="p">,</span> 
            <span class="s1">&#39;trend_alignment&#39;</span><span class="p">,</span> <span class="s1">&#39;vol_ratio&#39;</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Multi-timeframe features:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">df_mtf</span><span class="p">[</span><span class="n">mtf_cols</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">tail</span><span class="p">())</span>
</code></pre></div>


</details></div>
<div class="md-cell exercise-header"><h3>Exercise 3.6: Feature Pipeline Builder (Open-ended)</h3>
<p>Create a complete feature engineering pipeline that's ready for production.</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 3.6: Feature Pipeline Builder (Open-ended)</span>
<span class="c1">#</span>
<span class="c1"># Build a FeaturePipeline class that:</span>
<span class="c1">#</span>
<span class="c1"># - Combines all feature types (price, technical, statistical)</span>
<span class="c1"># - Handles missing values and outliers</span>
<span class="c1"># - Applies feature selection</span>
<span class="c1"># - Can be fitted on training data and applied to new data</span>
<span class="c1"># - Is serializable (can be saved/loaded)</span>
<span class="c1">#</span>
<span class="c1"># Your implementation:</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 3.6</summary>


<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">StandardScaler</span>

<span class="k">class</span> <span class="nc">FeaturePipeline</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Production-ready feature engineering pipeline.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default_config</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">selected_features</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_stats</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_fitted</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">_default_config</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;return_horizons&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">],</span>
            <span class="s1">&#39;volatility_windows&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">20</span><span class="p">],</span>
            <span class="s1">&#39;rsi_period&#39;</span><span class="p">:</span> <span class="mi">14</span><span class="p">,</span>
            <span class="s1">&#39;macd_params&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mi">9</span><span class="p">),</span>
            <span class="s1">&#39;zscore_window&#39;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
            <span class="s1">&#39;n_features&#39;</span><span class="p">:</span> <span class="mi">10</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">_create_all_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Create all features from raw data.&quot;&quot;&quot;</span>
        <span class="n">features</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># Returns</span>
        <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;return_horizons&#39;</span><span class="p">]:</span>
            <span class="n">features</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;return_</span><span class="si">{</span><span class="n">h</span><span class="si">}</span><span class="s1">d&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>

        <span class="c1"># Volatility</span>
        <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;volatility_windows&#39;</span><span class="p">]:</span>
            <span class="n">features</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;vol_</span><span class="si">{</span><span class="n">w</span><span class="si">}</span><span class="s1">d&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;return_1d&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">w</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span>

        <span class="c1"># RSI</span>
        <span class="n">period</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;rsi_period&#39;</span><span class="p">]</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span>
        <span class="n">gain</span> <span class="o">=</span> <span class="n">delta</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">delta</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">period</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">delta</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">delta</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">period</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;rsi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">-</span> <span class="p">(</span><span class="mi">100</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">gain</span> <span class="o">/</span> <span class="n">loss</span><span class="p">))</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;rsi_norm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">features</span><span class="p">[</span><span class="s1">&#39;rsi&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">50</span><span class="p">)</span> <span class="o">/</span> <span class="mi">50</span>

        <span class="c1"># MACD</span>
        <span class="n">fast</span><span class="p">,</span> <span class="n">slow</span><span class="p">,</span> <span class="n">signal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;macd_params&#39;</span><span class="p">]</span>
        <span class="n">ema_fast</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">ewm</span><span class="p">(</span><span class="n">span</span><span class="o">=</span><span class="n">fast</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">ema_slow</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">ewm</span><span class="p">(</span><span class="n">span</span><span class="o">=</span><span class="n">slow</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;macd_norm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">ema_fast</span> <span class="o">-</span> <span class="n">ema_slow</span><span class="p">)</span> <span class="o">/</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span>

        <span class="c1"># Z-score</span>
        <span class="n">window</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;zscore_window&#39;</span><span class="p">]</span>
        <span class="n">mean</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;return_1d&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">std</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;return_1d&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;return_zscore&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">features</span><span class="p">[</span><span class="s1">&#39;return_1d&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">mean</span><span class="p">)</span> <span class="o">/</span> <span class="n">std</span><span class="p">)</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">features</span>

    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">target</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;FeaturePipeline&#39;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Fit the pipeline on training data.&quot;&quot;&quot;</span>
        <span class="c1"># Create features</span>
        <span class="n">features_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_all_features</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

        <span class="c1"># Get feature columns</span>
        <span class="n">feature_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">features_df</span><span class="o">.</span><span class="n">columns</span> 
                       <span class="k">if</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Open&#39;</span><span class="p">,</span> <span class="s1">&#39;High&#39;</span><span class="p">,</span> <span class="s1">&#39;Low&#39;</span><span class="p">,</span> <span class="s1">&#39;Close&#39;</span><span class="p">,</span> <span class="s1">&#39;Volume&#39;</span><span class="p">,</span> <span class="s1">&#39;Dividends&#39;</span><span class="p">,</span> <span class="s1">&#39;Stock Splits&#39;</span><span class="p">]]</span>

        <span class="c1"># Clean data</span>
        <span class="n">clean_idx</span> <span class="o">=</span> <span class="n">features_df</span><span class="p">[</span><span class="n">feature_cols</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">index</span>
        <span class="n">X_clean</span> <span class="o">=</span> <span class="n">features_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">clean_idx</span><span class="p">,</span> <span class="n">feature_cols</span><span class="p">]</span>
        <span class="n">y_clean</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">clean_idx</span><span class="p">]</span>

        <span class="c1"># Feature selection</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">RandomForestClassifier</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_clean</span><span class="p">,</span> <span class="n">y_clean</span><span class="p">)</span>
        <span class="n">importance</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">feature_importances_</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">feature_cols</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">selected_features</span> <span class="o">=</span> <span class="n">importance</span><span class="o">.</span><span class="n">nlargest</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;n_features&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

        <span class="c1"># Fit scaler</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scaler</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_clean</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">selected_features</span><span class="p">])</span>

        <span class="c1"># Store statistics</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_stats</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;means&#39;</span><span class="p">:</span> <span class="n">X_clean</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">selected_features</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(),</span>
            <span class="s1">&#39;stds&#39;</span><span class="p">:</span> <span class="n">X_clean</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">selected_features</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">is_fitted</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Transform new data using fitted pipeline.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_fitted</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Pipeline not fitted. Call fit() first.&quot;</span><span class="p">)</span>

        <span class="n">features_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_all_features</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">features_df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">selected_features</span><span class="p">]</span>
        <span class="n">X_scaled</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X</span><span class="p">),</span>
            <span class="n">index</span><span class="o">=</span><span class="n">X</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
            <span class="n">columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">selected_features</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">X_scaled</span>

    <span class="k">def</span> <span class="nf">fit_transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">target</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Fit and transform in one step.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Save pipeline to file.&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">filepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;FeaturePipeline&#39;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Load pipeline from file.&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

<span class="c1"># Test</span>
<span class="n">target</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="n">pipeline</span> <span class="o">=</span> <span class="n">FeaturePipeline</span><span class="p">()</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Selected features: </span><span class="si">{</span><span class="n">pipeline</span><span class="o">.</span><span class="n">selected_features</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Transformed shape: </span><span class="si">{</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">tail</span><span class="p">())</span>
</code></pre></div>


</details></div>
<div class="md-cell module-project"><hr />
<h2>Module Project: Feature Engineering Library</h2>
<p>Build a comprehensive, reusable feature engineering library.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Module Project: Feature Engineering Library</span>

<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">RandomForestClassifier</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">StandardScaler</span>


<span class="k">class</span> <span class="nc">FinancialFeatureEngine</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Comprehensive feature engineering library for financial ML.</span>
<span class="sd">    </span>
<span class="sd">    This library provides a complete suite of features commonly used</span>
<span class="sd">    in quantitative trading and financial machine learning.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">features_df</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_catalog</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;FinancialFeatureEngine&#39;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the feature engine with data.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            df: DataFrame with OHLCV data</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            Self for method chaining</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">features_df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span>
    
    <span class="k">def</span> <span class="nf">add_returns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">periods</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;FinancialFeatureEngine&#39;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add return features at multiple horizons.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            periods: List of periods for returns</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">periods</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">periods</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">]</span>
        
        <span class="n">features</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">periods</span><span class="p">:</span>
            <span class="n">col</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;return_</span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s1">d&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">features_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">features_df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="n">features</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
            
            <span class="c1"># Log returns</span>
            <span class="n">col_log</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;log_return_</span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s1">d&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">features_df</span><span class="p">[</span><span class="n">col_log</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">features_df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">features_df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">features</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col_log</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_catalog</span><span class="p">[</span><span class="s1">&#39;returns&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">features</span>
        <span class="k">return</span> <span class="bp">self</span>
    
    <span class="k">def</span> <span class="nf">add_volatility</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">windows</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;FinancialFeatureEngine&#39;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add volatility features.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            windows: List of rolling window sizes</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">windows</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">windows</span> <span class="o">=</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">60</span><span class="p">]</span>
        
        <span class="c1"># Ensure daily returns exist</span>
        <span class="k">if</span> <span class="s1">&#39;return_1d&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">features_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">features_df</span><span class="p">[</span><span class="s1">&#39;return_1d&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">features_df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span>
        
        <span class="n">features</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">windows</span><span class="p">:</span>
            <span class="n">col</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;volatility_</span><span class="si">{</span><span class="n">w</span><span class="si">}</span><span class="s1">d&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">features_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">features_df</span><span class="p">[</span><span class="s1">&#39;return_1d&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">w</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">features</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
        
        <span class="c1"># Volatility ratios</span>
        <span class="k">if</span> <span class="s1">&#39;volatility_5d&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">features_df</span><span class="o">.</span><span class="n">columns</span> <span class="ow">and</span> <span class="s1">&#39;volatility_20d&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">features_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">features_df</span><span class="p">[</span><span class="s1">&#39;vol_ratio_5_20&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">features_df</span><span class="p">[</span><span class="s1">&#39;volatility_5d&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">features_df</span><span class="p">[</span><span class="s1">&#39;volatility_20d&#39;</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="n">features</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;vol_ratio_5_20&#39;</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_catalog</span><span class="p">[</span><span class="s1">&#39;volatility&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">features</span>
        <span class="k">return</span> <span class="bp">self</span>
    
    <span class="k">def</span> <span class="nf">add_momentum</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;FinancialFeatureEngine&#39;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add momentum indicators.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">features</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="c1"># RSI</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">features_df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span>
        <span class="n">gain</span> <span class="o">=</span> <span class="n">delta</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">delta</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">14</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">delta</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">delta</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">14</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">features_df</span><span class="p">[</span><span class="s1">&#39;rsi_14&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">-</span> <span class="p">(</span><span class="mi">100</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">gain</span> <span class="o">/</span> <span class="n">loss</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">features_df</span><span class="p">[</span><span class="s1">&#39;rsi_normalized&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">features_df</span><span class="p">[</span><span class="s1">&#39;rsi_14&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">50</span><span class="p">)</span> <span class="o">/</span> <span class="mi">50</span>
        <span class="n">features</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s1">&#39;rsi_14&#39;</span><span class="p">,</span> <span class="s1">&#39;rsi_normalized&#39;</span><span class="p">])</span>
        
        <span class="c1"># MACD</span>
        <span class="n">ema12</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">features_df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">ewm</span><span class="p">(</span><span class="n">span</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">ema26</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">features_df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">ewm</span><span class="p">(</span><span class="n">span</span><span class="o">=</span><span class="mi">26</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">features_df</span><span class="p">[</span><span class="s1">&#39;macd&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ema12</span> <span class="o">-</span> <span class="n">ema26</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">features_df</span><span class="p">[</span><span class="s1">&#39;macd_signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">features_df</span><span class="p">[</span><span class="s1">&#39;macd&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">ewm</span><span class="p">(</span><span class="n">span</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">features_df</span><span class="p">[</span><span class="s1">&#39;macd_normalized&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">features_df</span><span class="p">[</span><span class="s1">&#39;macd&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">features_df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span>
        <span class="n">features</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s1">&#39;macd_normalized&#39;</span><span class="p">])</span>
        
        <span class="c1"># Stochastic</span>
        <span class="n">low_14</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">features_df</span><span class="p">[</span><span class="s1">&#39;Low&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">14</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="n">high_14</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">features_df</span><span class="p">[</span><span class="s1">&#39;High&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">14</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">features_df</span><span class="p">[</span><span class="s1">&#39;stoch_k&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">features_df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">low_14</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">high_14</span> <span class="o">-</span> <span class="n">low_14</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">features_df</span><span class="p">[</span><span class="s1">&#39;stoch_k_normalized&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">features_df</span><span class="p">[</span><span class="s1">&#39;stoch_k&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">50</span><span class="p">)</span> <span class="o">/</span> <span class="mi">50</span>
        <span class="n">features</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s1">&#39;stoch_k_normalized&#39;</span><span class="p">])</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_catalog</span><span class="p">[</span><span class="s1">&#39;momentum&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">features</span>
        <span class="k">return</span> <span class="bp">self</span>
    
    <span class="k">def</span> <span class="nf">add_trend</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;FinancialFeatureEngine&#39;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add trend-following features.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">features</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="c1"># Distance from moving averages</span>
        <span class="k">for</span> <span class="n">period</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">20</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">200</span><span class="p">]:</span>
            <span class="n">sma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">features_df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">period</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="n">col</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;dist_sma_</span><span class="si">{</span><span class="n">period</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">features_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">features_df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">sma</span><span class="p">)</span> <span class="o">/</span> <span class="n">sma</span>
            <span class="n">features</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
        
        <span class="c1"># Trend direction</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">features_df</span><span class="p">[</span><span class="s1">&#39;above_sma_20&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">features_df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">features_df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">features_df</span><span class="p">[</span><span class="s1">&#39;above_sma_50&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">features_df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">features_df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">features</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s1">&#39;above_sma_20&#39;</span><span class="p">,</span> <span class="s1">&#39;above_sma_50&#39;</span><span class="p">])</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_catalog</span><span class="p">[</span><span class="s1">&#39;trend&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">features</span>
        <span class="k">return</span> <span class="bp">self</span>
    
    <span class="k">def</span> <span class="nf">add_volume</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;FinancialFeatureEngine&#39;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add volume-based features.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">features</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="c1"># Volume change</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">features_df</span><span class="p">[</span><span class="s1">&#39;volume_change&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">features_df</span><span class="p">[</span><span class="s1">&#39;Volume&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span>
        <span class="n">features</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;volume_change&#39;</span><span class="p">)</span>
        
        <span class="c1"># Volume relative to average</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">features_df</span><span class="p">[</span><span class="s1">&#39;volume_ma_ratio&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">features_df</span><span class="p">[</span><span class="s1">&#39;Volume&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">features_df</span><span class="p">[</span><span class="s1">&#39;Volume&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="n">features</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;volume_ma_ratio&#39;</span><span class="p">)</span>
        
        <span class="c1"># Volume z-score</span>
        <span class="n">vol_mean</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">features_df</span><span class="p">[</span><span class="s1">&#39;Volume&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">vol_std</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">features_df</span><span class="p">[</span><span class="s1">&#39;Volume&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">features_df</span><span class="p">[</span><span class="s1">&#39;volume_zscore&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">features_df</span><span class="p">[</span><span class="s1">&#39;Volume&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">vol_mean</span><span class="p">)</span> <span class="o">/</span> <span class="n">vol_std</span>
        <span class="p">)</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">features</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;volume_zscore&#39;</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_catalog</span><span class="p">[</span><span class="s1">&#39;volume&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">features</span>
        <span class="k">return</span> <span class="bp">self</span>
    
    <span class="k">def</span> <span class="nf">add_statistical</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">window</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;FinancialFeatureEngine&#39;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add statistical features.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            window: Rolling window size</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">features</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">if</span> <span class="s1">&#39;return_1d&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">features_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">features_df</span><span class="p">[</span><span class="s1">&#39;return_1d&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">features_df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span>
        
        <span class="c1"># Z-score of returns</span>
        <span class="n">mean</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">features_df</span><span class="p">[</span><span class="s1">&#39;return_1d&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">std</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">features_df</span><span class="p">[</span><span class="s1">&#39;return_1d&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">features_df</span><span class="p">[</span><span class="s1">&#39;return_zscore&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">features_df</span><span class="p">[</span><span class="s1">&#39;return_1d&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">mean</span><span class="p">)</span> <span class="o">/</span> <span class="n">std</span>
        <span class="p">)</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">features</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;return_zscore&#39;</span><span class="p">)</span>
        
        <span class="c1"># Skewness and kurtosis</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">features_df</span><span class="p">[</span><span class="s1">&#39;skew&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">features_df</span><span class="p">[</span><span class="s1">&#39;return_1d&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="p">)</span><span class="o">.</span><span class="n">skew</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">features_df</span><span class="p">[</span><span class="s1">&#39;kurtosis&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">features_df</span><span class="p">[</span><span class="s1">&#39;return_1d&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="p">)</span><span class="o">.</span><span class="n">kurt</span><span class="p">()</span>
        <span class="n">features</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s1">&#39;skew&#39;</span><span class="p">,</span> <span class="s1">&#39;kurtosis&#39;</span><span class="p">])</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_catalog</span><span class="p">[</span><span class="s1">&#39;statistical&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">features</span>
        <span class="k">return</span> <span class="bp">self</span>
    
    <span class="k">def</span> <span class="nf">build_all</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;FinancialFeatureEngine&#39;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Build all available features.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_returns</span><span class="p">()</span>
                <span class="o">.</span><span class="n">add_volatility</span><span class="p">()</span>
                <span class="o">.</span><span class="n">add_momentum</span><span class="p">()</span>
                <span class="o">.</span><span class="n">add_trend</span><span class="p">()</span>
                <span class="o">.</span><span class="n">add_volume</span><span class="p">()</span>
                <span class="o">.</span><span class="n">add_statistical</span><span class="p">()</span>
        <span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">get_feature_names</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">groups</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get list of feature names.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            groups: Optional list of feature groups to include</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            List of feature names</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">groups</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">groups</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">feature_catalog</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        
        <span class="n">features</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">group</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_catalog</span><span class="p">:</span>
                <span class="n">features</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">feature_catalog</span><span class="p">[</span><span class="n">group</span><span class="p">])</span>
        
        <span class="k">return</span> <span class="n">features</span>
    
    <span class="k">def</span> <span class="nf">get_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">groups</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">dropna</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get feature DataFrame.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            groups: Optional list of feature groups to include</span>
<span class="sd">            dropna: Whether to drop rows with missing values</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            DataFrame with selected features</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">feature_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_feature_names</span><span class="p">(</span><span class="n">groups</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">features_df</span><span class="p">[</span><span class="n">feature_names</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="n">dropna</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
        
        <span class="k">return</span> <span class="n">df</span>
    
    <span class="k">def</span> <span class="nf">get_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get a summary of all features.</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            Formatted summary string</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">summary</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Financial Feature Engine Summary&quot;</span><span class="p">,</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">50</span><span class="p">]</span>
        
        <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">group</span><span class="p">,</span> <span class="n">features</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_catalog</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">summary</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">group</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">features</span><span class="p">)</span><span class="si">}</span><span class="s2"> features):&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">features</span><span class="p">:</span>
                <span class="n">summary</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - </span><span class="si">{</span><span class="n">f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">total</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>
        
        <span class="n">summary</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">TOTAL: </span><span class="si">{</span><span class="n">total</span><span class="si">}</span><span class="s2"> features&quot;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">summary</span><span class="p">)</span>


<span class="c1"># Demo the feature engine</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Building Financial Feature Engine...&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>

<span class="c1"># Initialize and build features</span>
<span class="n">engine</span> <span class="o">=</span> <span class="n">FinancialFeatureEngine</span><span class="p">()</span>
<span class="n">engine</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="o">.</span><span class="n">build_all</span><span class="p">()</span>

<span class="c1"># Print summary</span>
<span class="nb">print</span><span class="p">(</span><span class="n">engine</span><span class="o">.</span><span class="n">get_summary</span><span class="p">())</span>

<span class="c1"># Get feature matrix</span>
<span class="n">features</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">get_features</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Feature matrix shape: </span><span class="si">{</span><span class="n">features</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Sample features:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">features</span><span class="o">.</span><span class="n">tail</span><span class="p">())</span>
</code></pre></div>
<div class="md-cell key-takeaways"><hr />
<h2>Key Takeaways</h2>
<ol>
<li>
<p><strong>Normalize Features</strong>: Convert raw indicators to normalized forms (z-scores, percentages) for better ML performance</p>
</li>
<li>
<p><strong>Multiple Horizons</strong>: Create features at different time scales (1, 5, 20, 60 days) to capture patterns at various frequencies</p>
</li>
<li>
<p><strong>Feature Types</strong>: Combine price-based, technical, and statistical features for comprehensive coverage</p>
</li>
<li>
<p><strong>Handle Correlations</strong>: Remove highly correlated features to reduce redundancy and overfitting</p>
</li>
<li>
<p><strong>Feature Selection</strong>: Use importance scores or RFE to identify the most predictive features</p>
</li>
<li>
<p><strong>Clip Outliers</strong>: Z-scores and other features should be clipped (e.g., ¬±3) for stability</p>
</li>
</ol>
<hr />
<p><strong>Next: Module 4 - Target Engineering</strong></p>
<p>Learn how to define prediction targets using the triple barrier method, meta-labeling, and proper handling of overlapping labels.</p></div>
        <div class="nav-buttons">
            <button class="nav-btn prev-btn disabled" type="button">
                <span class="nav-btn-label">‚Üê Previous</span>
                <span class="nav-btn-name"></span>
            </button>
            <button class="nav-btn next-btn disabled" type="button">
                <span class="nav-btn-label">Next ‚Üí</span>
                <span class="nav-btn-name"></span>
            </button>
        </div>
        </div>
<div class="module-section" data-idx="4"><div class="md-cell module-header"><h1>Module 4: Target Engineering</h1>
<h2>Part 1: ML Fundamentals for Finance</h2>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Duration</th>
<th>Exercises</th>
</tr>
</thead>
<tbody>
<tr>
<td>~2.5 hours</td>
<td>6</td>
</tr>
</tbody>
</table></div>
<h3>Learning Objectives</h3>
<p>By the end of this module, you will be able to:</p>
<ul>
<li>Define effective prediction targets for trading</li>
<li>Implement the triple barrier method for labeling</li>
<li>Apply meta-labeling for signal filtering</li>
<li>Avoid lookahead bias in target creation</li>
</ul></div>
<div class="md-cell"><hr />
<h2>4.1 Defining Targets</h2>
<p>The target (what we predict) is just as important as the features.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">yfinance</span> <span class="k">as</span> <span class="nn">yf</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>

<span class="c1"># Download sample data</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Downloading data...&quot;</span><span class="p">)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">Ticker</span><span class="p">(</span><span class="s2">&quot;SPY&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">history</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="s2">&quot;2y&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Downloaded </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="si">}</span><span class="s2"> rows&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Different types of targets</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Types of Prediction Targets&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>

<span class="n">target_types</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;Direction&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">&#39;Up or down (binary classification)&#39;</span><span class="p">,</span>
        <span class="s1">&#39;example&#39;</span><span class="p">:</span> <span class="s1">&#39;1 if tomorrow</span><span class="se">\&#39;</span><span class="s1">s return &gt; 0, else 0&#39;</span><span class="p">,</span>
        <span class="s1">&#39;pros&#39;</span><span class="p">:</span> <span class="s1">&#39;Simple, clear signal&#39;</span><span class="p">,</span>
        <span class="s1">&#39;cons&#39;</span><span class="p">:</span> <span class="s1">&#39;Ignores magnitude, many small movements&#39;</span>
    <span class="p">},</span>
    <span class="s1">&#39;Return Magnitude&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">&#39;Actual return value (regression)&#39;</span><span class="p">,</span>
        <span class="s1">&#39;example&#39;</span><span class="p">:</span> <span class="s1">&#39;Tomorrow</span><span class="se">\&#39;</span><span class="s1">s return = 0.5%&#39;</span><span class="p">,</span>
        <span class="s1">&#39;pros&#39;</span><span class="p">:</span> <span class="s1">&#39;More information, enables position sizing&#39;</span><span class="p">,</span>
        <span class="s1">&#39;cons&#39;</span><span class="p">:</span> <span class="s1">&#39;Harder to predict, noisy&#39;</span>
    <span class="p">},</span>
    <span class="s1">&#39;Multi-class Direction&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">&#39;Strong up, weak up, neutral, weak down, strong down&#39;</span><span class="p">,</span>
        <span class="s1">&#39;example&#39;</span><span class="p">:</span> <span class="s1">&#39;0: &lt; -1%, 1: -1% to 0%, 2: 0% to 1%, 3: &gt; 1%&#39;</span><span class="p">,</span>
        <span class="s1">&#39;pros&#39;</span><span class="p">:</span> <span class="s1">&#39;More nuanced than binary&#39;</span><span class="p">,</span>
        <span class="s1">&#39;cons&#39;</span><span class="p">:</span> <span class="s1">&#39;Class imbalance, harder to train&#39;</span>
    <span class="p">},</span>
    <span class="s1">&#39;Triple Barrier&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">&#39;First barrier hit: profit, loss, or time&#39;</span><span class="p">,</span>
        <span class="s1">&#39;example&#39;</span><span class="p">:</span> <span class="s1">&#39;Label based on which exit occurs first&#39;</span><span class="p">,</span>
        <span class="s1">&#39;pros&#39;</span><span class="p">:</span> <span class="s1">&#39;Most realistic for trading&#39;</span><span class="p">,</span>
        <span class="s1">&#39;cons&#39;</span><span class="p">:</span> <span class="s1">&#39;More complex to implement&#39;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">for</span> <span class="n">target</span><span class="p">,</span> <span class="n">details</span> <span class="ow">in</span> <span class="n">target_types</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">target</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Description: </span><span class="si">{</span><span class="n">details</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Example: </span><span class="si">{</span><span class="n">details</span><span class="p">[</span><span class="s1">&#39;example&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Pros: </span><span class="si">{</span><span class="n">details</span><span class="p">[</span><span class="s1">&#39;pros&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Cons: </span><span class="si">{</span><span class="n">details</span><span class="p">[</span><span class="s1">&#39;cons&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Simple direction target</span>

<span class="k">def</span> <span class="nf">create_direction_target</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">horizon</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a simple binary direction target.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        df: DataFrame with &#39;Close&#39; column</span>
<span class="sd">        horizon: Number of days to look ahead</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        Series with binary labels (1 = up, 0 = down)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">future_return</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">(</span><span class="n">horizon</span><span class="p">)</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="n">horizon</span><span class="p">)</span>
    <span class="n">target</span> <span class="o">=</span> <span class="p">(</span><span class="n">future_return</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">target</span>

<span class="c1"># Create targets at different horizons</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;target_1d&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">create_direction_target</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">horizon</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;target_5d&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">create_direction_target</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">horizon</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;target_20d&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">create_direction_target</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">horizon</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>

<span class="c1"># Check class balance</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Class Balance by Horizon:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;target_1d&#39;</span><span class="p">,</span> <span class="s1">&#39;target_5d&#39;</span><span class="p">,</span> <span class="s1">&#39;target_20d&#39;</span><span class="p">]:</span>
    <span class="n">pct_up</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">*</span> <span class="mi">100</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">pct_up</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">% up, </span><span class="si">{</span><span class="mi">100</span><span class="o">-</span><span class="n">pct_up</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">% down&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Multi-class target based on return magnitude</span>

<span class="k">def</span> <span class="nf">create_multiclass_target</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">horizon</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">thresholds</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create multi-class target based on return magnitude.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        df: DataFrame with &#39;Close&#39; column</span>
<span class="sd">        horizon: Number of days to look ahead</span>
<span class="sd">        thresholds: Return thresholds for classes</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        Series with multi-class labels</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">thresholds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">thresholds</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.02</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.005</span><span class="p">,</span> <span class="mf">0.005</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">]</span>  <span class="c1"># -2%, -0.5%, 0.5%, 2%</span>
    
    <span class="n">future_return</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">(</span><span class="n">horizon</span><span class="p">)</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="n">horizon</span><span class="p">)</span>
    
    <span class="c1"># Create labels: 0 (strong down), 1 (weak down), 2 (neutral), 3 (weak up), 4 (strong up)</span>
    <span class="n">conditions</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">future_return</span> <span class="o">&lt;=</span> <span class="n">thresholds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="p">(</span><span class="n">future_return</span> <span class="o">&gt;</span> <span class="n">thresholds</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">future_return</span> <span class="o">&lt;=</span> <span class="n">thresholds</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
        <span class="p">(</span><span class="n">future_return</span> <span class="o">&gt;</span> <span class="n">thresholds</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">future_return</span> <span class="o">&lt;=</span> <span class="n">thresholds</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
        <span class="p">(</span><span class="n">future_return</span> <span class="o">&gt;</span> <span class="n">thresholds</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">future_return</span> <span class="o">&lt;=</span> <span class="n">thresholds</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span>
        <span class="n">future_return</span> <span class="o">&gt;</span> <span class="n">thresholds</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
    <span class="p">]</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span>
    
    <span class="n">target</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">conditions</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

<span class="c1"># Create multi-class target</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;target_multiclass&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">create_multiclass_target</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">horizon</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Multi-class Target Distribution:&quot;</span><span class="p">)</span>
<span class="n">label_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Strong Down&#39;</span><span class="p">,</span> <span class="s1">&#39;Weak Down&#39;</span><span class="p">,</span> <span class="s1">&#39;Neutral&#39;</span><span class="p">,</span> <span class="s1">&#39;Weak Up&#39;</span><span class="p">,</span> <span class="s1">&#39;Strong Up&#39;</span><span class="p">]</span>
<span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">label_names</span><span class="p">):</span>
    <span class="n">count</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;target_multiclass&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">label</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">pct</span> <span class="o">=</span> <span class="n">count</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">())</span> <span class="o">*</span> <span class="mi">100</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="n">count</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">pct</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell exercise-header"><h3>Exercise 4.1: Target Creator (Guided)</h3>
<p>Build a flexible target creation function.</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 4.1: Target Creator (Guided)</span>

<span class="k">def</span> <span class="nf">create_target</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">target_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;direction&#39;</span><span class="p">,</span> 
                  <span class="n">horizon</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create different types of prediction targets.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        df: DataFrame with &#39;Close&#39; column</span>
<span class="sd">        target_type: &#39;direction&#39;, &#39;return&#39;, or &#39;threshold&#39;</span>
<span class="sd">        horizon: Days to look ahead</span>
<span class="sd">        threshold: Return threshold for &#39;threshold&#39; type</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        Series with target labels</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO: Calculate future return</span>
    <span class="n">future_return</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">______</span><span class="p">(</span><span class="n">horizon</span><span class="p">)</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="n">______</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">target_type</span> <span class="o">==</span> <span class="s1">&#39;direction&#39;</span><span class="p">:</span>
        <span class="c1"># TODO: Binary direction (1 if up, 0 if down)</span>
        <span class="n">target</span> <span class="o">=</span> <span class="p">(</span><span class="n">future_return</span> <span class="o">&gt;</span> <span class="n">______</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        
    <span class="k">elif</span> <span class="n">target_type</span> <span class="o">==</span> <span class="s1">&#39;return&#39;</span><span class="p">:</span>
        <span class="c1"># Return the actual return value</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">future_return</span>
        
    <span class="k">elif</span> <span class="n">target_type</span> <span class="o">==</span> <span class="s1">&#39;threshold&#39;</span><span class="p">:</span>
        <span class="c1"># TODO: Only label significant moves</span>
        <span class="c1"># 1 if return &gt; threshold, -1 if return &lt; -threshold, 0 otherwise</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="n">target</span><span class="p">[</span><span class="n">future_return</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">]</span> <span class="o">=</span> <span class="n">______</span>
        <span class="n">target</span><span class="p">[</span><span class="n">future_return</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">threshold</span><span class="p">]</span> <span class="o">=</span> <span class="n">______</span>
    
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown target_type: </span><span class="si">{</span><span class="n">target_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">target</span>

<span class="c1"># Test different target types</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Target Creation Tests:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>

<span class="c1"># Direction</span>
<span class="n">target_dir</span> <span class="o">=</span> <span class="n">create_target</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="s1">&#39;direction&#39;</span><span class="p">,</span> <span class="n">horizon</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Direction target: </span><span class="si">{</span><span class="n">target_dir</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Return</span>
<span class="n">target_ret</span> <span class="o">=</span> <span class="n">create_target</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="s1">&#39;return&#39;</span><span class="p">,</span> <span class="n">horizon</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Return target range: </span><span class="si">{</span><span class="n">target_ret</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">target_ret</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Threshold</span>
<span class="n">target_thresh</span> <span class="o">=</span> <span class="n">create_target</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="s1">&#39;threshold&#39;</span><span class="p">,</span> <span class="n">horizon</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.02</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Threshold target: </span><span class="si">{</span><span class="n">target_thresh</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 4.1</summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">create_target</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">target_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;direction&#39;</span><span class="p">,</span> 
                  <span class="n">horizon</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create different types of prediction targets.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Calculate future return</span>
    <span class="n">future_return</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">(</span><span class="n">horizon</span><span class="p">)</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="n">horizon</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">target_type</span> <span class="o">==</span> <span class="s1">&#39;direction&#39;</span><span class="p">:</span>
        <span class="c1"># Binary direction (1 if up, 0 if down)</span>
        <span class="n">target</span> <span class="o">=</span> <span class="p">(</span><span class="n">future_return</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">target_type</span> <span class="o">==</span> <span class="s1">&#39;return&#39;</span><span class="p">:</span>
        <span class="c1"># Return the actual return value</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">future_return</span>

    <span class="k">elif</span> <span class="n">target_type</span> <span class="o">==</span> <span class="s1">&#39;threshold&#39;</span><span class="p">:</span>
        <span class="c1"># Only label significant moves</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="n">target</span><span class="p">[</span><span class="n">future_return</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">target</span><span class="p">[</span><span class="n">future_return</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">threshold</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown target_type: </span><span class="si">{</span><span class="n">target_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">target</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h2>4.2 The Triple Barrier Method</h2>
<p>A more realistic labeling approach that mirrors actual trading exits.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Triple Barrier Method explained</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Triple Barrier Method&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">The triple barrier method labels based on which exit occurs first:</span>

<span class="s2">         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê</span>
<span class="s2">         ‚îÇ Take Profit Barrier (upper)         ‚îÇ  ‚Üí Label = +1</span>
<span class="s2">         ‚îÇ ================================    ‚îÇ</span>
<span class="s2">         ‚îÇ                                     ‚îÇ</span>
<span class="s2">    Entry‚îÇ        Price Path                   ‚îÇ</span>
<span class="s2">    Point‚îÇ           /\    /\                  ‚îÇ</span>
<span class="s2">         ‚îÇ          /  \  /  \                 ‚îÇ</span>
<span class="s2">         ‚îÇ         /    \/    \                ‚îÇ</span>
<span class="s2">         ‚îÇ ================================    ‚îÇ</span>
<span class="s2">         ‚îÇ Stop Loss Barrier (lower)          ‚îÇ  ‚Üí Label = -1</span>
<span class="s2">         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò</span>
<span class="s2">                                               ‚îÇ</span>
<span class="s2">                                          Time Barrier ‚Üí Label based on return</span>

<span class="s2">Three possible outcomes:</span>
<span class="s2">1. Price hits UPPER barrier first ‚Üí Label = +1 (profitable)</span>
<span class="s2">2. Price hits LOWER barrier first ‚Üí Label = -1 (loss)</span>
<span class="s2">3. TIME expires first ‚Üí Label based on final return (+1, 0, or -1)</span>

<span class="s2">Benefits:</span>
<span class="s2">- Realistic: Mirrors stop-loss and take-profit orders</span>
<span class="s2">- Balanced: Can adjust barriers for class balance</span>
<span class="s2">- Actionable: Labels correspond to trading decisions</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Implement triple barrier method</span>

<span class="k">def</span> <span class="nf">triple_barrier_labels</span><span class="p">(</span>
    <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">take_profit</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.02</span><span class="p">,</span>
    <span class="n">stop_loss</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.02</span><span class="p">,</span>
    <span class="n">max_holding</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Apply triple barrier method for labeling.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        df: DataFrame with &#39;Close&#39; column</span>
<span class="sd">        take_profit: Upper barrier (e.g., 0.02 = 2%)</span>
<span class="sd">        stop_loss: Lower barrier (e.g., 0.02 = 2%)</span>
<span class="sd">        max_holding: Maximum holding period in days</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        DataFrame with labels and exit info</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">-</span> <span class="n">max_holding</span><span class="p">):</span>
        <span class="n">entry_price</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">entry_date</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        
        <span class="c1"># Calculate barriers</span>
        <span class="n">upper_barrier</span> <span class="o">=</span> <span class="n">entry_price</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">take_profit</span><span class="p">)</span>
        <span class="n">lower_barrier</span> <span class="o">=</span> <span class="n">entry_price</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">stop_loss</span><span class="p">)</span>
        
        <span class="c1"># Look for barrier touches</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_holding</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">+</span> <span class="n">j</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
                <span class="k">break</span>
                
            <span class="n">high</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;High&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">j</span><span class="p">]</span>
            <span class="n">low</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Low&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">j</span><span class="p">]</span>
            <span class="n">close</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">j</span><span class="p">]</span>
            
            <span class="c1"># Check upper barrier (take profit)</span>
            <span class="k">if</span> <span class="n">high</span> <span class="o">&gt;=</span> <span class="n">upper_barrier</span><span class="p">:</span>
                <span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s1">&#39;entry_date&#39;</span><span class="p">:</span> <span class="n">entry_date</span><span class="p">,</span>
                    <span class="s1">&#39;exit_date&#39;</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">j</span><span class="p">],</span>
                    <span class="s1">&#39;holding_period&#39;</span><span class="p">:</span> <span class="n">j</span><span class="p">,</span>
                    <span class="s1">&#39;exit_type&#39;</span><span class="p">:</span> <span class="s1">&#39;take_profit&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="mi">1</span>
                <span class="p">})</span>
                <span class="k">break</span>
                
            <span class="c1"># Check lower barrier (stop loss)</span>
            <span class="k">if</span> <span class="n">low</span> <span class="o">&lt;=</span> <span class="n">lower_barrier</span><span class="p">:</span>
                <span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s1">&#39;entry_date&#39;</span><span class="p">:</span> <span class="n">entry_date</span><span class="p">,</span>
                    <span class="s1">&#39;exit_date&#39;</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">j</span><span class="p">],</span>
                    <span class="s1">&#39;holding_period&#39;</span><span class="p">:</span> <span class="n">j</span><span class="p">,</span>
                    <span class="s1">&#39;exit_type&#39;</span><span class="p">:</span> <span class="s1">&#39;stop_loss&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span>
                <span class="p">})</span>
                <span class="k">break</span>
                
            <span class="c1"># Check time barrier</span>
            <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="n">max_holding</span><span class="p">:</span>
                <span class="n">final_return</span> <span class="o">=</span> <span class="p">(</span><span class="n">close</span> <span class="o">-</span> <span class="n">entry_price</span><span class="p">)</span> <span class="o">/</span> <span class="n">entry_price</span>
                <span class="n">label</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">final_return</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="k">if</span> <span class="n">final_return</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s1">&#39;entry_date&#39;</span><span class="p">:</span> <span class="n">entry_date</span><span class="p">,</span>
                    <span class="s1">&#39;exit_date&#39;</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">j</span><span class="p">],</span>
                    <span class="s1">&#39;holding_period&#39;</span><span class="p">:</span> <span class="n">j</span><span class="p">,</span>
                    <span class="s1">&#39;exit_type&#39;</span><span class="p">:</span> <span class="s1">&#39;time_barrier&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="n">label</span>
                <span class="p">})</span>
    
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>

<span class="c1"># Apply triple barrier</span>
<span class="n">labels_df</span> <span class="o">=</span> <span class="n">triple_barrier_labels</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">take_profit</span><span class="o">=</span><span class="mf">0.02</span><span class="p">,</span> <span class="n">stop_loss</span><span class="o">=</span><span class="mf">0.02</span><span class="p">,</span> <span class="n">max_holding</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Triple Barrier Results:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total labeled samples: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">labels_df</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Exit type distribution:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">labels_df</span><span class="p">[</span><span class="s1">&#39;exit_type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Label distribution:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">labels_df</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Average holding period: </span><span class="si">{</span><span class="n">labels_df</span><span class="p">[</span><span class="s1">&#39;holding_period&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> days&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Visualize triple barrier on a sample</span>

<span class="k">def</span> <span class="nf">visualize_triple_barrier</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">start_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> 
                             <span class="n">take_profit</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.02</span><span class="p">,</span> <span class="n">stop_loss</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.02</span><span class="p">,</span>
                             <span class="n">max_holding</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Visualize triple barrier for a single trade.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">entry_price</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">start_idx</span><span class="p">]</span>
    <span class="n">upper</span> <span class="o">=</span> <span class="n">entry_price</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">take_profit</span><span class="p">)</span>
    <span class="n">lower</span> <span class="o">=</span> <span class="n">entry_price</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">stop_loss</span><span class="p">)</span>
    
    <span class="c1"># Get price path</span>
    <span class="n">end_idx</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">start_idx</span> <span class="o">+</span> <span class="n">max_holding</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">prices</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">start_idx</span><span class="p">:</span><span class="n">end_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
    
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
    
    <span class="c1"># Plot price</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">prices</span><span class="p">)),</span> <span class="n">prices</span><span class="p">,</span> <span class="s1">&#39;b-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Price&#39;</span><span class="p">)</span>
    
    <span class="c1"># Plot barriers</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">upper</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Take Profit (</span><span class="si">{</span><span class="n">take_profit</span><span class="si">:</span><span class="s1">.1%</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">lower</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Stop Loss (</span><span class="si">{</span><span class="n">stop_loss</span><span class="si">:</span><span class="s1">.1%</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">entry_price</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Entry&#39;</span><span class="p">)</span>
    
    <span class="c1"># Mark entry</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="n">entry_price</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">)</span>
    
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Days&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Price&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Triple Barrier Example&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Visualize an example</span>
<span class="n">visualize_triple_barrier</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">start_idx</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">take_profit</span><span class="o">=</span><span class="mf">0.02</span><span class="p">,</span> <span class="n">stop_loss</span><span class="o">=</span><span class="mf">0.02</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell exercise-header"><h3>Exercise 4.2: Triple Barrier Labeler (Guided)</h3>
<p>Create a simplified triple barrier labeling function.</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 4.2: Triple Barrier Labeler (Guided)</span>

<span class="k">def</span> <span class="nf">simple_triple_barrier</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">profit_target</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.02</span><span class="p">,</span> 
                         <span class="n">stop_loss</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.02</span><span class="p">,</span> <span class="n">max_days</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Simplified triple barrier that returns just the labels.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        df: DataFrame with OHLC data</span>
<span class="sd">        profit_target: Take profit threshold</span>
<span class="sd">        stop_loss: Stop loss threshold</span>
<span class="sd">        max_days: Maximum holding period</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        Series with labels (-1, 0, 1)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">-</span> <span class="n">max_days</span><span class="p">):</span>
        <span class="n">entry</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        
        <span class="c1"># TODO: Calculate barrier levels</span>
        <span class="n">upper</span> <span class="o">=</span> <span class="n">entry</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">______</span><span class="p">)</span>
        <span class="n">lower</span> <span class="o">=</span> <span class="n">entry</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">______</span><span class="p">)</span>
        
        <span class="n">label</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Default: time barrier</span>
        
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_days</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="c1"># TODO: Check if upper barrier hit</span>
            <span class="k">if</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;High&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">j</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">______</span><span class="p">:</span>
                <span class="n">label</span> <span class="o">=</span> <span class="n">______</span>
                <span class="k">break</span>
            
            <span class="c1"># TODO: Check if lower barrier hit</span>
            <span class="k">if</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Low&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">j</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">______</span><span class="p">:</span>
                <span class="n">label</span> <span class="o">=</span> <span class="n">______</span>
                <span class="k">break</span>
        
        <span class="n">labels</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">label</span>
    
    <span class="k">return</span> <span class="n">labels</span>

<span class="c1"># Test</span>
<span class="n">tb_labels</span> <span class="o">=</span> <span class="n">simple_triple_barrier</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">profit_target</span><span class="o">=</span><span class="mf">0.02</span><span class="p">,</span> <span class="n">stop_loss</span><span class="o">=</span><span class="mf">0.02</span><span class="p">,</span> <span class="n">max_days</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Triple Barrier Labels:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">tb_labels</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">value_counts</span><span class="p">())</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 4.2</summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">simple_triple_barrier</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">profit_target</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.02</span><span class="p">,</span> 
                         <span class="n">stop_loss</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.02</span><span class="p">,</span> <span class="n">max_days</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Simplified triple barrier that returns just the labels.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">-</span> <span class="n">max_days</span><span class="p">):</span>
        <span class="n">entry</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="c1"># Calculate barrier levels</span>
        <span class="n">upper</span> <span class="o">=</span> <span class="n">entry</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">profit_target</span><span class="p">)</span>
        <span class="n">lower</span> <span class="o">=</span> <span class="n">entry</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">stop_loss</span><span class="p">)</span>

        <span class="n">label</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Default: time barrier</span>

        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_days</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="c1"># Check if upper barrier hit</span>
            <span class="k">if</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;High&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">j</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">upper</span><span class="p">:</span>
                <span class="n">label</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">break</span>

            <span class="c1"># Check if lower barrier hit</span>
            <span class="k">if</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Low&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">j</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">lower</span><span class="p">:</span>
                <span class="n">label</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                <span class="k">break</span>

        <span class="n">labels</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">label</span>

    <span class="k">return</span> <span class="n">labels</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h2>4.3 Meta-Labeling</h2>
<p>Meta-labeling uses ML to filter another model's signals.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Meta-labeling concept</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Meta-Labeling&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">Meta-labeling is a two-model approach:</span>

<span class="s2">‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê</span>
<span class="s2">‚îÇ STEP 1: Primary Model (e.g., trend-following strategy)       ‚îÇ</span>
<span class="s2">‚îÇ         Generates buy/sell signals                           ‚îÇ</span>
<span class="s2">‚îÇ         Example: Buy when price crosses above SMA            ‚îÇ</span>
<span class="s2">‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò</span>
<span class="s2">                            ‚îÇ</span>
<span class="s2">                            ‚ñº</span>
<span class="s2">‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê</span>
<span class="s2">‚îÇ STEP 2: Meta-Model (ML classifier)                          ‚îÇ</span>
<span class="s2">‚îÇ         Filters primary signals: &quot;Should I take this trade?&quot;‚îÇ</span>
<span class="s2">‚îÇ         Target: Was the primary signal profitable?          ‚îÇ</span>
<span class="s2">‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò</span>
<span class="s2">                            ‚îÇ</span>
<span class="s2">                            ‚ñº</span>
<span class="s2">‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê</span>
<span class="s2">‚îÇ FINAL: Only take trades where both models agree             ‚îÇ</span>
<span class="s2">‚îÇ        Primary says &quot;buy&quot; AND Meta says &quot;likely profitable&quot; ‚îÇ</span>
<span class="s2">‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò</span>

<span class="s2">Benefits:</span>
<span class="s2">1. Separates signal generation from signal filtering</span>
<span class="s2">2. Maintains interpretable primary model</span>
<span class="s2">3. Meta-model can consider additional features</span>
<span class="s2">4. Often improves precision at cost of recall</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Implement meta-labeling</span>

<span class="k">def</span> <span class="nf">create_meta_labels</span><span class="p">(</span>
    <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">primary_signal</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span>
    <span class="n">holding_period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create meta-labels for primary model signals.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        df: DataFrame with price data</span>
<span class="sd">        primary_signal: Series with primary model signals (1 for long, -1 for short)</span>
<span class="sd">        holding_period: Days to hold position</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        Series with meta-labels (1 if signal was profitable, 0 if not)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">meta_labels</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    
    <span class="c1"># Calculate forward returns</span>
    <span class="n">forward_return</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">(</span><span class="n">holding_period</span><span class="p">)</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="n">holding_period</span><span class="p">)</span>
    
    <span class="c1"># Only label when primary signal exists</span>
    <span class="n">signal_idx</span> <span class="o">=</span> <span class="n">primary_signal</span><span class="p">[</span><span class="n">primary_signal</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span>
    
    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">signal_idx</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">forward_return</span><span class="o">.</span><span class="n">index</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">forward_return</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">]):</span>
            <span class="n">signal</span> <span class="o">=</span> <span class="n">primary_signal</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="n">forward_return</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
            
            <span class="c1"># Meta-label: Was the signal profitable?</span>
            <span class="c1"># Long signal (1) is profitable if return &gt; 0</span>
            <span class="c1"># Short signal (-1) is profitable if return &lt; 0</span>
            <span class="n">profitable</span> <span class="o">=</span> <span class="p">(</span><span class="n">signal</span> <span class="o">*</span> <span class="n">ret</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="n">meta_labels</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">profitable</span> <span class="k">else</span> <span class="mi">0</span>
    
    <span class="k">return</span> <span class="n">meta_labels</span>

<span class="c1"># Create a simple primary model (MA crossover)</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;sma_20&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;sma_50&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

<span class="c1"># Primary signal: 1 when short MA above long MA</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;primary_signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;sma_20&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;sma_50&#39;</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># Generate meta-labels</span>
<span class="n">meta_labels</span> <span class="o">=</span> <span class="n">create_meta_labels</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;primary_signal&#39;</span><span class="p">],</span> <span class="n">holding_period</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Meta-Label Distribution:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">meta_labels</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">value_counts</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Win rate of primary signals: </span><span class="si">{</span><span class="n">meta_labels</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s2">.1%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Complete meta-labeling example</span>

<span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">RandomForestClassifier</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">classification_report</span><span class="p">,</span> <span class="n">accuracy_score</span>

<span class="k">def</span> <span class="nf">meta_labeling_example</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Complete meta-labeling workflow example.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Step 1: Create features</span>
    <span class="n">features</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
    <span class="n">features</span><span class="p">[</span><span class="s1">&#39;returns_5d&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">features</span><span class="p">[</span><span class="s1">&#39;volatility&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
    <span class="n">features</span><span class="p">[</span><span class="s1">&#39;rsi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">50</span>  <span class="c1"># Placeholder</span>
    <span class="n">delta</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span>
    <span class="n">gain</span> <span class="o">=</span> <span class="n">delta</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">delta</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">14</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">delta</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">delta</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">14</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">features</span><span class="p">[</span><span class="s1">&#39;rsi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">-</span> <span class="p">(</span><span class="mi">100</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">gain</span> <span class="o">/</span> <span class="n">loss</span><span class="p">))</span>
    <span class="n">features</span><span class="p">[</span><span class="s1">&#39;volume_ratio&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Volume&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Volume&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    
    <span class="c1"># Step 2: Create primary signal</span>
    <span class="n">sma_20</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">sma_50</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">primary_signal</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">sma_20</span> <span class="o">&gt;</span> <span class="n">sma_50</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>
        <span class="n">index</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">index</span>
    <span class="p">)</span>
    
    <span class="c1"># Step 3: Create meta-labels</span>
    <span class="n">meta_labels</span> <span class="o">=</span> <span class="n">create_meta_labels</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">primary_signal</span><span class="p">,</span> <span class="n">holding_period</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    
    <span class="c1"># Step 4: Prepare data for meta-model</span>
    <span class="n">feature_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;returns_5d&#39;</span><span class="p">,</span> <span class="s1">&#39;volatility&#39;</span><span class="p">,</span> <span class="s1">&#39;rsi&#39;</span><span class="p">,</span> <span class="s1">&#39;volume_ratio&#39;</span><span class="p">]</span>
    <span class="n">df_ml</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">features</span><span class="p">[</span><span class="n">feature_cols</span><span class="p">],</span> <span class="n">meta_labels</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;meta_label&#39;</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">df_ml</span> <span class="o">=</span> <span class="n">df_ml</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
    
    <span class="c1"># Only use rows where we have a signal</span>
    <span class="n">df_ml</span> <span class="o">=</span> <span class="n">df_ml</span><span class="p">[</span><span class="n">df_ml</span><span class="p">[</span><span class="s1">&#39;meta_label&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">notna</span><span class="p">()]</span>
    
    <span class="n">X</span> <span class="o">=</span> <span class="n">df_ml</span><span class="p">[</span><span class="n">feature_cols</span><span class="p">]</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">df_ml</span><span class="p">[</span><span class="s1">&#39;meta_label&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    
    <span class="c1"># Step 5: Train meta-model (time series split)</span>
    <span class="n">split_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.8</span><span class="p">)</span>
    <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span> <span class="o">=</span> <span class="n">X</span><span class="p">[:</span><span class="n">split_idx</span><span class="p">],</span> <span class="n">X</span><span class="p">[</span><span class="n">split_idx</span><span class="p">:]</span>
    <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">y</span><span class="p">[:</span><span class="n">split_idx</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">split_idx</span><span class="p">:]</span>
    
    <span class="n">meta_model</span> <span class="o">=</span> <span class="n">RandomForestClassifier</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
    <span class="n">meta_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
    
    <span class="c1"># Step 6: Evaluate</span>
    <span class="n">y_pred</span> <span class="o">=</span> <span class="n">meta_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;primary_win_rate&#39;</span><span class="p">:</span> <span class="n">y</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
        <span class="s1">&#39;meta_accuracy&#39;</span><span class="p">:</span> <span class="n">accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">),</span>
        <span class="s1">&#39;test_predictions&#39;</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">y_pred</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">y_test</span><span class="o">.</span><span class="n">index</span><span class="p">),</span>
        <span class="s1">&#39;feature_importance&#39;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">feature_cols</span><span class="p">,</span> <span class="n">meta_model</span><span class="o">.</span><span class="n">feature_importances_</span><span class="p">))</span>
    <span class="p">}</span>

<span class="c1"># Run meta-labeling example</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">meta_labeling_example</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Meta-Labeling Results:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Primary Model Win Rate: </span><span class="si">{</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;primary_win_rate&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.1%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Meta-Model Accuracy: </span><span class="si">{</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;meta_accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.1%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Feature Importance:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">feat</span><span class="p">,</span> <span class="n">imp</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;feature_importance&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="o">-</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">feat</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">imp</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell exercise-header"><h3>Exercise 4.3: Meta-Label Generator (Guided)</h3>
<p>Create a function that generates meta-labels for any primary signal.</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 4.3: Meta-Label Generator (Guided)</span>

<span class="k">def</span> <span class="nf">generate_meta_labels</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">signal_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                         <span class="n">profit_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">,</span>
                         <span class="n">holding_days</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate meta-labels for a given signal column.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        df: DataFrame with price data and signal</span>
<span class="sd">        signal_col: Name of signal column (should have values 1, -1, or 0)</span>
<span class="sd">        profit_threshold: Minimum return to count as profitable</span>
<span class="sd">        holding_days: Days to hold position</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        Series with meta-labels (1 = profitable, 0 = not profitable)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO: Calculate forward return</span>
    <span class="n">forward_return</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">(</span><span class="n">______</span><span class="p">)</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="n">holding_days</span><span class="p">)</span>
    
    <span class="c1"># TODO: Get signal values</span>
    <span class="n">signal</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">______</span><span class="p">]</span>
    
    <span class="c1"># TODO: Calculate actual profit (signal * return)</span>
    <span class="n">actual_profit</span> <span class="o">=</span> <span class="n">signal</span> <span class="o">*</span> <span class="n">______</span>
    
    <span class="c1"># TODO: Create meta-label (1 if profit &gt; threshold, else 0)</span>
    <span class="n">meta_label</span> <span class="o">=</span> <span class="p">(</span><span class="n">actual_profit</span> <span class="o">&gt;</span> <span class="n">______</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    
    <span class="c1"># Only keep labels where signal was non-zero</span>
    <span class="n">meta_label</span> <span class="o">=</span> <span class="n">meta_label</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">signal</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">meta_label</span>

<span class="c1"># Test</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;test_signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">meta</span> <span class="o">=</span> <span class="n">generate_meta_labels</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="s1">&#39;test_signal&#39;</span><span class="p">,</span> <span class="n">profit_threshold</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">holding_days</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Meta-label Distribution:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">meta</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">value_counts</span><span class="p">())</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 4.3</summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">generate_meta_labels</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">signal_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                         <span class="n">profit_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">,</span>
                         <span class="n">holding_days</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate meta-labels for a given signal column.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Calculate forward return</span>
    <span class="n">forward_return</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">(</span><span class="n">holding_days</span><span class="p">)</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="n">holding_days</span><span class="p">)</span>

    <span class="c1"># Get signal values</span>
    <span class="n">signal</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">signal_col</span><span class="p">]</span>

    <span class="c1"># Calculate actual profit (signal * return)</span>
    <span class="n">actual_profit</span> <span class="o">=</span> <span class="n">signal</span> <span class="o">*</span> <span class="n">forward_return</span>

    <span class="c1"># Create meta-label (1 if profit &gt; threshold, else 0)</span>
    <span class="n">meta_label</span> <span class="o">=</span> <span class="p">(</span><span class="n">actual_profit</span> <span class="o">&gt;</span> <span class="n">profit_threshold</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

    <span class="c1"># Only keep labels where signal was non-zero</span>
    <span class="n">meta_label</span> <span class="o">=</span> <span class="n">meta_label</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">signal</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">meta_label</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h2>4.4 Avoiding Lookahead Bias</h2>
<p>The most common and deadly mistake in financial ML.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Lookahead bias examples</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Common Lookahead Bias Mistakes&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>

<span class="n">mistakes</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Using Same-Day Close in Features&#39;</span><span class="p">,</span>
        <span class="s1">&#39;wrong&#39;</span><span class="p">:</span> <span class="s1">&#39;feature = (close - sma) / sma  # close includes today&#39;</span><span class="p">,</span>
        <span class="s1">&#39;right&#39;</span><span class="p">:</span> <span class="s1">&#39;feature = (close.shift(1) - sma.shift(1)) / sma.shift(1)&#39;</span><span class="p">,</span>
        <span class="s1">&#39;explanation&#39;</span><span class="p">:</span> <span class="s1">&#39;Features should only use information available at decision time&#39;</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Scaling with Full Dataset Statistics&#39;</span><span class="p">,</span>
        <span class="s1">&#39;wrong&#39;</span><span class="p">:</span> <span class="s1">&#39;scaler.fit(X)  # Uses future data statistics&#39;</span><span class="p">,</span>
        <span class="s1">&#39;right&#39;</span><span class="p">:</span> <span class="s1">&#39;scaler.fit(X_train)  # Only use training data&#39;</span><span class="p">,</span>
        <span class="s1">&#39;explanation&#39;</span><span class="p">:</span> <span class="s1">&#39;Statistics (mean, std) must come only from past data&#39;</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Feature Selection Using All Data&#39;</span><span class="p">,</span>
        <span class="s1">&#39;wrong&#39;</span><span class="p">:</span> <span class="s1">&#39;Select features using correlation with target on all data&#39;</span><span class="p">,</span>
        <span class="s1">&#39;right&#39;</span><span class="p">:</span> <span class="s1">&#39;Select features only on training data&#39;</span><span class="p">,</span>
        <span class="s1">&#39;explanation&#39;</span><span class="p">:</span> <span class="s1">&#39;Feature selection is part of model fitting&#39;</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Using Adjusted Prices&#39;</span><span class="p">,</span>
        <span class="s1">&#39;wrong&#39;</span><span class="p">:</span> <span class="s1">&#39;Split-adjusted prices for historical signals&#39;</span><span class="p">,</span>
        <span class="s1">&#39;right&#39;</span><span class="p">:</span> <span class="s1">&#39;Use unadjusted prices, adjust at point in time&#39;</span><span class="p">,</span>
        <span class="s1">&#39;explanation&#39;</span><span class="p">:</span> <span class="s1">&#39;Price adjustments are applied retroactively&#39;</span>
    <span class="p">}</span>
<span class="p">]</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">mistake</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">mistakes</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">. </span><span class="si">{</span><span class="n">mistake</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   WRONG: </span><span class="si">{</span><span class="n">mistake</span><span class="p">[</span><span class="s1">&#39;wrong&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   RIGHT: </span><span class="si">{</span><span class="n">mistake</span><span class="p">[</span><span class="s1">&#39;right&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Why: </span><span class="si">{</span><span class="n">mistake</span><span class="p">[</span><span class="s1">&#39;explanation&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Lookahead bias checker</span>

<span class="k">def</span> <span class="nf">check_lookahead_bias</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">feature_cols</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">target_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check for potential lookahead bias in features.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        df: DataFrame with features and target</span>
<span class="sd">        feature_cols: List of feature columns</span>
<span class="sd">        target_col: Name of target column</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        Dictionary with warnings and analysis</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">warnings</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">analysis</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="c1"># Check correlation between features and target</span>
    <span class="c1"># Extremely high correlation might indicate lookahead</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">feature_cols</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="ow">and</span> <span class="n">target_col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">corr</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">corr</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">target_col</span><span class="p">])</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">corr</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;High correlation (</span><span class="si">{</span><span class="n">corr</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">) between &#39;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">&#39; and target - &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;possible lookahead bias&quot;</span>
                <span class="p">)</span>
            <span class="n">analysis</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;correlation&#39;</span><span class="p">:</span> <span class="n">corr</span><span class="p">}</span>
    
    <span class="c1"># Check for suspicious column names</span>
    <span class="n">suspicious_keywords</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;future&#39;</span><span class="p">,</span> <span class="s1">&#39;forward&#39;</span><span class="p">,</span> <span class="s1">&#39;next&#39;</span><span class="p">,</span> <span class="s1">&#39;tomorrow&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">feature_cols</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="n">suspicious_keywords</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="n">col</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Column &#39;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">&#39; contains suspicious keyword &#39;</span><span class="si">{</span><span class="n">keyword</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
                <span class="p">)</span>
    
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;warnings&#39;</span><span class="p">:</span> <span class="n">warnings</span><span class="p">,</span>
        <span class="s1">&#39;analysis&#39;</span><span class="p">:</span> <span class="n">analysis</span><span class="p">,</span>
        <span class="s1">&#39;has_potential_issues&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">warnings</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
    <span class="p">}</span>

<span class="c1"># Create some features with potential issues</span>
<span class="n">test_df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">test_df</span><span class="p">[</span><span class="s1">&#39;future_return&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">test_df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># LOOKAHEAD!</span>
<span class="n">test_df</span><span class="p">[</span><span class="s1">&#39;past_return&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">test_df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span>  <span class="c1"># OK</span>
<span class="n">test_df</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">test_df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="c1"># Check for bias</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">check_lookahead_bias</span><span class="p">(</span>
    <span class="n">test_df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(),</span> 
    <span class="p">[</span><span class="s1">&#39;future_return&#39;</span><span class="p">,</span> <span class="s1">&#39;past_return&#39;</span><span class="p">],</span> 
    <span class="s1">&#39;target&#39;</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Lookahead Bias Check:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Potential issues found: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;has_potential_issues&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;warnings&#39;</span><span class="p">]:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Warnings:&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">warning</span> <span class="ow">in</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;warnings&#39;</span><span class="p">]:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - </span><span class="si">{</span><span class="n">warning</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell exercise-header"><hr />
<h2>Open-Ended Exercises</h2>
<h3>Exercise 4.4: Adaptive Barrier Labels (Open-ended)</h3>
<p>Create triple barrier labels with adaptive barriers based on volatility.</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 4.4: Adaptive Barrier Labels (Open-ended)</span>
<span class="c1">#</span>
<span class="c1"># Create a function that:</span>
<span class="c1">#</span>
<span class="c1"># - Uses ATR or rolling volatility to set barrier widths</span>
<span class="c1"># - Widens barriers in high-volatility periods</span>
<span class="c1"># - Narrows barriers in low-volatility periods</span>
<span class="c1"># - Returns labels with barrier levels used</span>
<span class="c1">#</span>
<span class="c1"># Your implementation:</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 4.4</summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">adaptive_triple_barrier</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">vol_multiplier</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">,</span>
                           <span class="n">vol_window</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span> <span class="n">max_days</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Triple barrier with volatility-adaptive barriers.</span>

<span class="sd">    Args:</span>
<span class="sd">        df: DataFrame with OHLCV data</span>
<span class="sd">        vol_multiplier: Multiplier for volatility to set barriers</span>
<span class="sd">        vol_window: Window for volatility calculation</span>
<span class="sd">        max_days: Maximum holding period</span>

<span class="sd">    Returns:</span>
<span class="sd">        DataFrame with labels and barrier info</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Calculate daily volatility</span>
    <span class="n">returns</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span>
    <span class="n">volatility</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">vol_window</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>

    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">vol_window</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">-</span> <span class="n">max_days</span><span class="p">):</span>
        <span class="n">entry_price</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">entry_date</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="c1"># Adaptive barrier width based on current volatility</span>
        <span class="n">current_vol</span> <span class="o">=</span> <span class="n">volatility</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">barrier_width</span> <span class="o">=</span> <span class="n">current_vol</span> <span class="o">*</span> <span class="n">vol_multiplier</span>

        <span class="n">upper</span> <span class="o">=</span> <span class="n">entry_price</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">barrier_width</span><span class="p">)</span>
        <span class="n">lower</span> <span class="o">=</span> <span class="n">entry_price</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">barrier_width</span><span class="p">)</span>

        <span class="n">label</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">exit_type</span> <span class="o">=</span> <span class="s1">&#39;time&#39;</span>
        <span class="n">exit_day</span> <span class="o">=</span> <span class="n">max_days</span>

        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_days</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;High&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">j</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">upper</span><span class="p">:</span>
                <span class="n">label</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">exit_type</span> <span class="o">=</span> <span class="s1">&#39;profit&#39;</span>
                <span class="n">exit_day</span> <span class="o">=</span> <span class="n">j</span>
                <span class="k">break</span>
            <span class="k">if</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Low&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">j</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">lower</span><span class="p">:</span>
                <span class="n">label</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                <span class="n">exit_type</span> <span class="o">=</span> <span class="s1">&#39;stop&#39;</span>
                <span class="n">exit_day</span> <span class="o">=</span> <span class="n">j</span>
                <span class="k">break</span>

        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;date&#39;</span><span class="p">:</span> <span class="n">entry_date</span><span class="p">,</span>
            <span class="s1">&#39;entry_price&#39;</span><span class="p">:</span> <span class="n">entry_price</span><span class="p">,</span>
            <span class="s1">&#39;volatility&#39;</span><span class="p">:</span> <span class="n">current_vol</span><span class="p">,</span>
            <span class="s1">&#39;barrier_width&#39;</span><span class="p">:</span> <span class="n">barrier_width</span><span class="p">,</span>
            <span class="s1">&#39;upper_barrier&#39;</span><span class="p">:</span> <span class="n">upper</span><span class="p">,</span>
            <span class="s1">&#39;lower_barrier&#39;</span><span class="p">:</span> <span class="n">lower</span><span class="p">,</span>
            <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="n">label</span><span class="p">,</span>
            <span class="s1">&#39;exit_type&#39;</span><span class="p">:</span> <span class="n">exit_type</span><span class="p">,</span>
            <span class="s1">&#39;exit_day&#39;</span><span class="p">:</span> <span class="n">exit_day</span>
        <span class="p">})</span>

    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>

<span class="c1"># Test</span>
<span class="n">adaptive_labels</span> <span class="o">=</span> <span class="n">adaptive_triple_barrier</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">vol_multiplier</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">vol_window</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">max_days</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Adaptive Triple Barrier Results:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Label distribution:</span><span class="se">\n</span><span class="si">{</span><span class="n">adaptive_labels</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Average barrier width: </span><span class="si">{</span><span class="n">adaptive_labels</span><span class="p">[</span><span class="s1">&#39;barrier_width&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Barrier width range: </span><span class="si">{</span><span class="n">adaptive_labels</span><span class="p">[</span><span class="s1">&#39;barrier_width&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">adaptive_labels</span><span class="p">[</span><span class="s1">&#39;barrier_width&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell exercise-header"><h3>Exercise 4.5: Label Quality Analyzer (Open-ended)</h3>
<p>Build a comprehensive label quality analysis tool.</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 4.5: Label Quality Analyzer (Open-ended)</span>
<span class="c1">#</span>
<span class="c1"># Create a LabelAnalyzer class that:</span>
<span class="c1">#</span>
<span class="c1"># - Analyzes class distribution</span>
<span class="c1"># - Checks for label overlap</span>
<span class="c1"># - Calculates label uniqueness</span>
<span class="c1"># - Generates sample weights</span>
<span class="c1">#</span>
<span class="c1"># Your implementation:</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 4.5</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">LabelAnalyzer</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Analyze label quality for financial ML.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">labels</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">holding_period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="n">labels</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">holding_period</span> <span class="o">=</span> <span class="n">holding_period</span>

    <span class="k">def</span> <span class="nf">class_distribution</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Analyze class distribution.&quot;&quot;&quot;</span>
        <span class="n">counts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
        <span class="n">pcts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">value_counts</span><span class="p">(</span><span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;counts&#39;</span><span class="p">:</span> <span class="n">counts</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(),</span>
            <span class="s1">&#39;percentages&#39;</span><span class="p">:</span> <span class="n">pcts</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(),</span>
            <span class="s1">&#39;imbalance_ratio&#39;</span><span class="p">:</span> <span class="n">counts</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">/</span> <span class="n">counts</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">label_overlap</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Check for overlapping labels.&quot;&quot;&quot;</span>
        <span class="c1"># Labels overlap if they&#39;re within holding_period of each other</span>
        <span class="n">label_dates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">index</span>

        <span class="n">overlap_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">date</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">label_dates</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">next_date</span> <span class="o">=</span> <span class="n">label_dates</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">next_date</span> <span class="o">-</span> <span class="n">date</span><span class="p">)</span><span class="o">.</span><span class="n">days</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">holding_period</span><span class="p">:</span>
                <span class="n">overlap_count</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;total_labels&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">),</span>
            <span class="s1">&#39;overlapping&#39;</span><span class="p">:</span> <span class="n">overlap_count</span><span class="p">,</span>
            <span class="s1">&#39;overlap_percentage&#39;</span><span class="p">:</span> <span class="n">overlap_count</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">label_uniqueness</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate uniqueness score for each label.</span>

<span class="sd">        Labels are less unique if they overlap with many others.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">uniqueness</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">date</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">index</span><span class="p">):</span>
            <span class="c1"># Count overlapping labels</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">date</span> <span class="o">-</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">holding_period</span><span class="p">)</span>
            <span class="n">end</span> <span class="o">=</span> <span class="n">date</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">holding_period</span><span class="p">)</span>

            <span class="n">overlapping</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">start</span><span class="p">)</span> <span class="o">&amp;</span> 
                                      <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">index</span> <span class="o">&lt;=</span> <span class="n">end</span><span class="p">)</span> <span class="o">&amp;</span>
                                      <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">index</span> <span class="o">!=</span> <span class="n">date</span><span class="p">)]</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">overlapping</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">uniqueness</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">date</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">overlapping</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">uniqueness</span>

    <span class="k">def</span> <span class="nf">sample_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Generate sample weights based on uniqueness.&quot;&quot;&quot;</span>
        <span class="n">uniqueness</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">label_uniqueness</span><span class="p">()</span>
        <span class="c1"># Normalize to sum to number of samples</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="n">uniqueness</span> <span class="o">/</span> <span class="n">uniqueness</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">uniqueness</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">weights</span>

    <span class="k">def</span> <span class="nf">get_report</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Generate full analysis report.&quot;&quot;&quot;</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_distribution</span><span class="p">()</span>
        <span class="n">overlap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">label_overlap</span><span class="p">()</span>
        <span class="n">uniqueness</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">label_uniqueness</span><span class="p">()</span>

        <span class="n">report</span> <span class="o">=</span> <span class="s2">&quot;Label Quality Report</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">50</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="n">report</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Class Distribution:</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">for</span> <span class="bp">cls</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> <span class="n">dist</span><span class="p">[</span><span class="s1">&#39;counts&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">pct</span> <span class="o">=</span> <span class="n">dist</span><span class="p">[</span><span class="s1">&#39;percentages&#39;</span><span class="p">][</span><span class="bp">cls</span><span class="p">]</span>
            <span class="n">report</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;  Class </span><span class="si">{</span><span class="bp">cls</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">count</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">pct</span><span class="si">}</span><span class="s2">%)</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">report</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;  Imbalance Ratio: </span><span class="si">{</span><span class="n">dist</span><span class="p">[</span><span class="s1">&#39;imbalance_ratio&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="n">report</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Label Overlap:</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">report</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;  Overlapping labels: </span><span class="si">{</span><span class="n">overlap</span><span class="p">[</span><span class="s1">&#39;overlapping&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">overlap</span><span class="p">[</span><span class="s1">&#39;overlap_percentage&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)</span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="n">report</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Label Uniqueness:</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">report</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;  Mean uniqueness: </span><span class="si">{</span><span class="n">uniqueness</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">report</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;  Min uniqueness: </span><span class="si">{</span><span class="n">uniqueness</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="k">return</span> <span class="n">report</span>

<span class="c1"># Test</span>
<span class="n">test_labels</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;target_5d&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
<span class="n">analyzer</span> <span class="o">=</span> <span class="n">LabelAnalyzer</span><span class="p">(</span><span class="n">test_labels</span><span class="p">,</span> <span class="n">holding_period</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">analyzer</span><span class="o">.</span><span class="n">get_report</span><span class="p">())</span>
</code></pre></div>


</details></div>
<div class="md-cell exercise-header"><h3>Exercise 4.6: Complete Labeling System (Open-ended)</h3>
<p>Build a production-ready labeling system.</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 4.6: Complete Labeling System (Open-ended)</span>
<span class="c1">#</span>
<span class="c1"># Build a LabelingSystem class that:</span>
<span class="c1">#</span>
<span class="c1"># - Supports multiple labeling methods</span>
<span class="c1"># - Handles different target horizons</span>
<span class="c1"># - Checks for lookahead bias</span>
<span class="c1"># - Generates sample weights</span>
<span class="c1"># - Returns ready-to-use labels for ML</span>
<span class="c1">#</span>
<span class="c1"># Your implementation:</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 4.6</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">LabelingSystem</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Production-ready labeling system for financial ML.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">METHODS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;direction&#39;</span><span class="p">,</span> <span class="s1">&#39;triple_barrier&#39;</span><span class="p">,</span> <span class="s1">&#39;threshold&#39;</span><span class="p">,</span> <span class="s1">&#39;meta&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sample_weights</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">create_labels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;direction&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;LabelingSystem&#39;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create labels using specified method.</span>

<span class="sd">        Args:</span>
<span class="sd">            method: Labeling method</span>
<span class="sd">            **kwargs: Method-specific parameters</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;method&#39;</span><span class="p">:</span> <span class="n">method</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">}</span>

        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;direction&#39;</span><span class="p">:</span>
            <span class="n">horizon</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;horizon&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">future_return</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">(</span><span class="n">horizon</span><span class="p">)</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="n">horizon</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="p">(</span><span class="n">future_return</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;triple_barrier&#39;</span><span class="p">:</span>
            <span class="n">tp</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;take_profit&#39;</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">)</span>
            <span class="n">sl</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;stop_loss&#39;</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">)</span>
            <span class="n">max_hold</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;max_holding&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">)</span> <span class="o">-</span> <span class="n">max_hold</span><span class="p">):</span>
                <span class="n">entry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">upper</span> <span class="o">=</span> <span class="n">entry</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">tp</span><span class="p">)</span>
                <span class="n">lower</span> <span class="o">=</span> <span class="n">entry</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">sl</span><span class="p">)</span>
                <span class="n">label</span> <span class="o">=</span> <span class="mi">0</span>

                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_hold</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;High&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">j</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">upper</span><span class="p">:</span>
                        <span class="n">label</span> <span class="o">=</span> <span class="mi">1</span>
                        <span class="k">break</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Low&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">j</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">lower</span><span class="p">:</span>
                        <span class="n">label</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                        <span class="k">break</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">label</span>

        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;threshold&#39;</span><span class="p">:</span>
            <span class="n">horizon</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;horizon&#39;</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
            <span class="n">threshold</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;threshold&#39;</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">)</span>
            <span class="n">future_return</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">(</span><span class="n">horizon</span><span class="p">)</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="n">horizon</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="n">future_return</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="n">future_return</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">threshold</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown method: </span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s2">. Use one of </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">METHODS</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">check_bias</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feature_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Check for potential lookahead bias.&quot;&quot;&quot;</span>
        <span class="n">warnings</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">feature_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="c1"># Check suspicious names</span>
            <span class="k">for</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;future&#39;</span><span class="p">,</span> <span class="s1">&#39;forward&#39;</span><span class="p">,</span> <span class="s1">&#39;next&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="n">col</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Suspicious column name: </span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Check high correlation</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">corr</span> <span class="o">=</span> <span class="n">feature_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">corr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">corr</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">:</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;High correlation (</span><span class="si">{</span><span class="n">corr</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;warnings&#39;</span><span class="p">:</span> <span class="n">warnings</span><span class="p">,</span>
            <span class="s1">&#39;has_issues&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">warnings</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">compute_sample_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">holding_period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Compute sample weights based on label uniqueness.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Create labels first&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">holding_period</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">holding_period</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;horizon&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">weights</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">date</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">weights</span><span class="o">.</span><span class="n">index</span><span class="p">):</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">date</span> <span class="o">-</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">holding_period</span><span class="p">)</span>
            <span class="n">end</span> <span class="o">=</span> <span class="n">date</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">holding_period</span><span class="p">)</span>

            <span class="n">concurrent</span> <span class="o">=</span> <span class="n">weights</span><span class="p">[(</span><span class="n">weights</span><span class="o">.</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">start</span><span class="p">)</span> <span class="o">&amp;</span> 
                                <span class="p">(</span><span class="n">weights</span><span class="o">.</span><span class="n">index</span> <span class="o">&lt;=</span> <span class="n">end</span><span class="p">)]</span>
            <span class="n">weights</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">date</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">concurrent</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sample_weights</span> <span class="o">=</span> <span class="n">weights</span> <span class="o">/</span> <span class="n">weights</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_weights</span>

    <span class="k">def</span> <span class="nf">get_labels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dropna</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get the labels.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Create labels first&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span> <span class="k">if</span> <span class="n">dropna</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span>

    <span class="k">def</span> <span class="nf">get_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get labeling summary.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;No labels created yet&quot;</span>

        <span class="n">labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

        <span class="n">summary</span> <span class="o">=</span> <span class="s2">&quot;Labeling System Summary</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">50</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">summary</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;Method: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;method&#39;</span><span class="p">,</span> <span class="s1">&#39;unknown&#39;</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">summary</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;Config: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">summary</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Total labels: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">summary</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;Label distribution:</span><span class="se">\n</span><span class="si">{</span><span class="n">labels</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="k">return</span> <span class="n">summary</span>

<span class="c1"># Test</span>
<span class="n">labeler</span> <span class="o">=</span> <span class="n">LabelingSystem</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
<span class="n">labeler</span><span class="o">.</span><span class="n">create_labels</span><span class="p">(</span><span class="s1">&#39;triple_barrier&#39;</span><span class="p">,</span> <span class="n">take_profit</span><span class="o">=</span><span class="mf">0.02</span><span class="p">,</span> <span class="n">stop_loss</span><span class="o">=</span><span class="mf">0.02</span><span class="p">,</span> <span class="n">max_holding</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">labeler</span><span class="o">.</span><span class="n">get_summary</span><span class="p">())</span>

<span class="c1"># Compute weights</span>
<span class="n">weights</span> <span class="o">=</span> <span class="n">labeler</span><span class="o">.</span><span class="n">compute_sample_weights</span><span class="p">(</span><span class="n">holding_period</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Sample weights computed: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span><span class="si">}</span><span class="s2"> samples&quot;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell module-project"><hr />
<h2>Module Project: Target Labeling System</h2>
<p>Build a comprehensive target engineering system.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Module Project: Target Labeling System</span>

<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Union</span>


<span class="k">class</span> <span class="nc">TargetEngineer</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Complete target engineering system for financial ML.</span>
<span class="sd">    </span>
<span class="sd">    Supports multiple labeling methods and provides quality analysis.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize with price data.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            df: DataFrame with OHLCV columns</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">targets</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">quality_metrics</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="k">def</span> <span class="nf">create_direction_target</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">horizon</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create binary direction target.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            name: Name for this target</span>
<span class="sd">            horizon: Days ahead to predict</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            Series with binary labels</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">future_return</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">(</span><span class="n">horizon</span><span class="p">)</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="n">horizon</span><span class="p">)</span>
        <span class="n">target</span> <span class="o">=</span> <span class="p">(</span><span class="n">future_return</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">targets</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">target</span>
        <span class="k">return</span> <span class="n">target</span>
    
    <span class="k">def</span> <span class="nf">create_triple_barrier_target</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> 
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">profit_target</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.02</span><span class="p">,</span>
        <span class="n">stop_loss</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.02</span><span class="p">,</span>
        <span class="n">max_holding</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create triple barrier target.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            name: Name for this target</span>
<span class="sd">            profit_target: Take profit level</span>
<span class="sd">            stop_loss: Stop loss level</span>
<span class="sd">            max_holding: Maximum holding period</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            Series with labels (-1, 0, 1)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">)</span> <span class="o">-</span> <span class="n">max_holding</span><span class="p">):</span>
            <span class="n">entry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">upper</span> <span class="o">=</span> <span class="n">entry</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">profit_target</span><span class="p">)</span>
            <span class="n">lower</span> <span class="o">=</span> <span class="n">entry</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">stop_loss</span><span class="p">)</span>
            
            <span class="n">label</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_holding</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;High&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">j</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">upper</span><span class="p">:</span>
                    <span class="n">label</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="k">break</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Low&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">j</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">lower</span><span class="p">:</span>
                    <span class="n">label</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                    <span class="k">break</span>
            
            <span class="n">labels</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">label</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">targets</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">labels</span>
        <span class="k">return</span> <span class="n">labels</span>
    
    <span class="k">def</span> <span class="nf">create_threshold_target</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">horizon</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
        <span class="n">threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.02</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create threshold-based target.</span>
<span class="sd">        </span>
<span class="sd">        Only labels significant moves.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            name: Name for this target</span>
<span class="sd">            horizon: Days ahead</span>
<span class="sd">            threshold: Minimum move to label</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            Series with labels (-1, 0, 1)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">future_return</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">(</span><span class="n">horizon</span><span class="p">)</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="n">horizon</span><span class="p">)</span>
        
        <span class="n">target</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="n">target</span><span class="p">[</span><span class="n">future_return</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">target</span><span class="p">[</span><span class="n">future_return</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">threshold</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">targets</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">target</span>
        <span class="k">return</span> <span class="n">target</span>
    
    <span class="k">def</span> <span class="nf">create_meta_target</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">primary_signal</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span>
        <span class="n">holding_period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create meta-labels for a primary signal.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            name: Name for this target</span>
<span class="sd">            primary_signal: Primary model signals (1, -1, 0)</span>
<span class="sd">            holding_period: Period to evaluate profit</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            Series with meta-labels (1 = profitable, 0 = not)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">forward_return</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">(</span><span class="n">holding_period</span><span class="p">)</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="n">holding_period</span><span class="p">)</span>
        <span class="n">profit</span> <span class="o">=</span> <span class="n">primary_signal</span> <span class="o">*</span> <span class="n">forward_return</span>
        
        <span class="n">meta_labels</span> <span class="o">=</span> <span class="p">(</span><span class="n">profit</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">meta_labels</span> <span class="o">=</span> <span class="n">meta_labels</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">primary_signal</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">targets</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">meta_labels</span>
        <span class="k">return</span> <span class="n">meta_labels</span>
    
    <span class="k">def</span> <span class="nf">analyze_target</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Analyze quality of a target.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            name: Target name to analyze</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            Dictionary with quality metrics</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">targets</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Target &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; not found&quot;</span><span class="p">)</span>
        
        <span class="n">target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">targets</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
        
        <span class="n">metrics</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;total_samples&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">target</span><span class="p">),</span>
            <span class="s1">&#39;class_distribution&#39;</span><span class="p">:</span> <span class="n">target</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(),</span>
            <span class="s1">&#39;class_percentages&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">target</span><span class="o">.</span><span class="n">value_counts</span><span class="p">(</span><span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(),</span>
            <span class="s1">&#39;unique_values&#39;</span><span class="p">:</span> <span class="n">target</span><span class="o">.</span><span class="n">nunique</span><span class="p">(),</span>
            <span class="s1">&#39;date_range&#39;</span><span class="p">:</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">target</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">date</span><span class="p">()),</span> <span class="nb">str</span><span class="p">(</span><span class="n">target</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">date</span><span class="p">()))</span>
        <span class="p">}</span>
        
        <span class="c1"># Calculate imbalance</span>
        <span class="n">counts</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
        <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;imbalance_ratio&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">counts</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">/</span> <span class="n">counts</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">quality_metrics</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">metrics</span>
        <span class="k">return</span> <span class="n">metrics</span>
    
    <span class="k">def</span> <span class="nf">compute_sample_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">holding_period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute sample weights based on uniqueness.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            name: Target name</span>
<span class="sd">            holding_period: Period for overlap calculation</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            Series with sample weights</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">targets</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">target</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">date</span> <span class="ow">in</span> <span class="n">target</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">date</span> <span class="o">-</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">holding_period</span><span class="p">)</span>
            <span class="n">end</span> <span class="o">=</span> <span class="n">date</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">holding_period</span><span class="p">)</span>
            <span class="n">concurrent</span> <span class="o">=</span> <span class="n">target</span><span class="p">[(</span><span class="n">target</span><span class="o">.</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">start</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">target</span><span class="o">.</span><span class="n">index</span> <span class="o">&lt;=</span> <span class="n">end</span><span class="p">)]</span>
            <span class="n">weights</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">date</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">concurrent</span><span class="p">)</span>
        
        <span class="c1"># Normalize</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="n">weights</span> <span class="o">/</span> <span class="n">weights</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">weights</span>
    
    <span class="k">def</span> <span class="nf">get_target</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">dropna</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get a target by name.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            name: Target name</span>
<span class="sd">            dropna: Whether to drop NaN values</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            Target Series</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">targets</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Target &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; not found&quot;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">targets</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span> <span class="k">if</span> <span class="n">dropna</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">targets</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
    
    <span class="k">def</span> <span class="nf">list_targets</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;List all created targets.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">targets</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    
    <span class="k">def</span> <span class="nf">get_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get summary of all targets.</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            Formatted summary string</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">summary</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Target Engineering Summary&quot;</span><span class="p">,</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">50</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">targets</span><span class="p">:</span>
            <span class="n">summary</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;No targets created yet.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">summary</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">targets</span><span class="p">:</span>
            <span class="n">metrics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_target</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="n">summary</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
            <span class="n">summary</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Samples: </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;total_samples&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">summary</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Classes: </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;class_distribution&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">summary</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Imbalance: </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;imbalance_ratio&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">summary</span><span class="p">)</span>


<span class="c1"># Demo the target engineering system</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Target Engineering System Demo&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>

<span class="c1"># Initialize</span>
<span class="n">engineer</span> <span class="o">=</span> <span class="n">TargetEngineer</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

<span class="c1"># Create different targets</span>
<span class="n">engineer</span><span class="o">.</span><span class="n">create_direction_target</span><span class="p">(</span><span class="s1">&#39;direction_1d&#39;</span><span class="p">,</span> <span class="n">horizon</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">engineer</span><span class="o">.</span><span class="n">create_direction_target</span><span class="p">(</span><span class="s1">&#39;direction_5d&#39;</span><span class="p">,</span> <span class="n">horizon</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="n">engineer</span><span class="o">.</span><span class="n">create_triple_barrier_target</span><span class="p">(</span><span class="s1">&#39;triple_barrier&#39;</span><span class="p">,</span> <span class="n">profit_target</span><span class="o">=</span><span class="mf">0.02</span><span class="p">,</span> <span class="n">stop_loss</span><span class="o">=</span><span class="mf">0.02</span><span class="p">)</span>
<span class="n">engineer</span><span class="o">.</span><span class="n">create_threshold_target</span><span class="p">(</span><span class="s1">&#39;threshold&#39;</span><span class="p">,</span> <span class="n">horizon</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.02</span><span class="p">)</span>

<span class="c1"># Create meta-label</span>
<span class="n">primary_signal</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span>
    <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>
    <span class="n">index</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">index</span>
<span class="p">)</span>
<span class="n">engineer</span><span class="o">.</span><span class="n">create_meta_target</span><span class="p">(</span><span class="s1">&#39;meta&#39;</span><span class="p">,</span> <span class="n">primary_signal</span><span class="p">,</span> <span class="n">holding_period</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

<span class="c1"># Print summary</span>
<span class="nb">print</span><span class="p">(</span><span class="n">engineer</span><span class="o">.</span><span class="n">get_summary</span><span class="p">())</span>

<span class="c1"># Get sample weights</span>
<span class="n">weights</span> <span class="o">=</span> <span class="n">engineer</span><span class="o">.</span><span class="n">compute_sample_weights</span><span class="p">(</span><span class="s1">&#39;triple_barrier&#39;</span><span class="p">,</span> <span class="n">holding_period</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Sample weights computed for triple_barrier&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Mean weight: </span><span class="si">{</span><span class="n">weights</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Weight range: </span><span class="si">{</span><span class="n">weights</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">weights</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell key-takeaways"><hr />
<h2>Key Takeaways</h2>
<ol>
<li>
<p><strong>Target Choice Matters</strong>: The prediction target determines what the model learns; choose carefully</p>
</li>
<li>
<p><strong>Triple Barrier Method</strong>: More realistic than simple direction labels; mirrors actual trading exits</p>
</li>
<li>
<p><strong>Meta-Labeling</strong>: Separates signal generation from signal filtering; improves precision</p>
</li>
<li>
<p><strong>Lookahead Bias</strong>: The #1 killer of backtests; always verify features don't use future information</p>
</li>
<li>
<p><strong>Sample Weights</strong>: Account for overlapping labels to prevent overweighting similar samples</p>
</li>
<li>
<p><strong>Class Balance</strong>: Trading labels are often imbalanced; monitor and address this</p>
</li>
</ol>
<hr />
<p><strong>Next: Module 5 - Tree-Based Models</strong></p>
<p>Learn how to build powerful prediction models using decision trees, random forests, and gradient boosting.</p></div>
        <div class="nav-buttons">
            <button class="nav-btn prev-btn disabled" type="button">
                <span class="nav-btn-label">‚Üê Previous</span>
                <span class="nav-btn-name"></span>
            </button>
            <button class="nav-btn next-btn disabled" type="button">
                <span class="nav-btn-label">Next ‚Üí</span>
                <span class="nav-btn-name"></span>
            </button>
        </div>
        </div>
<div class="module-section" data-idx="5"><div class="md-cell module-header"><h1>Module 5: Tree-Based Models</h1>
<h2>Part 2: Classification Models</h2>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Duration</th>
<th>Exercises</th>
<th>Prerequisites</th>
</tr>
</thead>
<tbody>
<tr>
<td>~2.5 hours</td>
<td>6</td>
<td>Modules 1-4</td>
</tr>
</tbody>
</table></div>
<h3>Learning Objectives</h3>
<p>By the end of this module, you will be able to:
- Understand decision tree fundamentals and splitting criteria
- Build and tune Random Forest classifiers for trading signals
- Apply XGBoost and LightGBM for enhanced performance
- Handle feature importance and model interpretation
- Apply ensemble methods for robust predictions</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>

<span class="c1"># Scikit-learn</span>
<span class="kn">from</span> <span class="nn">sklearn.tree</span> <span class="kn">import</span> <span class="n">DecisionTreeClassifier</span><span class="p">,</span> <span class="n">plot_tree</span>
<span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">RandomForestClassifier</span><span class="p">,</span> <span class="n">GradientBoostingClassifier</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">TimeSeriesSplit</span><span class="p">,</span> <span class="n">cross_val_score</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">StandardScaler</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">accuracy_score</span><span class="p">,</span> <span class="n">classification_report</span><span class="p">,</span> <span class="n">confusion_matrix</span>

<span class="c1"># Gradient boosting libraries</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">xgboost</span> <span class="k">as</span> <span class="nn">xgb</span>
    <span class="n">HAS_XGBOOST</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">HAS_XGBOOST</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;XGBoost not installed. Install with: pip install xgboost&quot;</span><span class="p">)</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">lightgbm</span> <span class="k">as</span> <span class="nn">lgb</span>
    <span class="n">HAS_LIGHTGBM</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">HAS_LIGHTGBM</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;LightGBM not installed. Install with: pip install lightgbm&quot;</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">yfinance</span> <span class="k">as</span> <span class="nn">yf</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Module 5: Tree-Based Models&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">40</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><hr />
<h2>Section 1: Decision Tree Fundamentals</h2>
<p>Decision trees are the foundation of many powerful ensemble methods. They make predictions by recursively partitioning the feature space.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Decision Tree Concepts</span>

<span class="n">tree_concepts</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">DECISION TREE STRUCTURE</span>
<span class="s2">=======================</span>

<span class="s2">                    [Root Node]</span>
<span class="s2">                   RSI &gt; 70?</span>
<span class="s2">                  /         </span><span class="se">\\</span><span class="s2"></span>
<span class="s2">                Yes          No</span>
<span class="s2">               /               </span><span class="se">\\</span><span class="s2"></span>
<span class="s2">        [Internal]           [Internal]</span>
<span class="s2">       Vol &gt; 0.02?          MACD &gt; 0?</span>
<span class="s2">       /       </span><span class="se">\\</span><span class="s2">             /       </span><span class="se">\\</span><span class="s2"></span>
<span class="s2">    [Leaf]   [Leaf]      [Leaf]    [Leaf]</span>
<span class="s2">    SELL     HOLD        BUY       HOLD</span>


<span class="s2">KEY CONCEPTS:</span>
<span class="s2">-------------</span>
<span class="s2">1. Splitting Criteria</span>
<span class="s2">   - Gini Impurity: How often a randomly chosen element would be incorrectly labeled</span>
<span class="s2">   - Entropy: Measure of randomness/disorder in the data</span>
<span class="s2">   - Information Gain: Reduction in entropy after a split</span>

<span class="s2">2. Tree Parameters</span>
<span class="s2">   - max_depth: How deep the tree can grow</span>
<span class="s2">   - min_samples_split: Minimum samples to create a split</span>
<span class="s2">   - min_samples_leaf: Minimum samples required at leaf node</span>

<span class="s2">3. Advantages for Finance</span>
<span class="s2">   - Interpretable: Can explain why a prediction was made</span>
<span class="s2">   - Non-linear: Captures complex relationships</span>
<span class="s2">   - Feature importance: Ranks feature usefulness</span>

<span class="s2">4. Disadvantages</span>
<span class="s2">   - Prone to overfitting</span>
<span class="s2">   - High variance (small data changes ‚Üí different tree)</span>
<span class="s2">   - Greedy algorithm (locally optimal, not globally)</span>
<span class="s2">&quot;&quot;&quot;</span>
<span class="nb">print</span><span class="p">(</span><span class="n">tree_concepts</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Prepare data for tree models</span>

<span class="k">def</span> <span class="nf">prepare_trading_data</span><span class="p">(</span><span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;SPY&quot;</span><span class="p">,</span> <span class="n">period</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;2y&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;Prepare data with features and target for classification.&quot;&quot;&quot;</span>
    
    <span class="c1"># Fetch data</span>
    <span class="n">ticker</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">Ticker</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">ticker</span><span class="o">.</span><span class="n">history</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="n">period</span><span class="p">)</span>
    
    <span class="c1"># Create features</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;returns&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;volatility&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;returns&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;momentum_5&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;momentum_20&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
    
    <span class="c1"># Moving averages</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;sma_5&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;sma_20&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;sma_50&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    
    <span class="c1"># Distance from MAs</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;dist_sma5&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;sma_5&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;sma_5&#39;</span><span class="p">]</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;dist_sma20&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;sma_20&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;sma_20&#39;</span><span class="p">]</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;dist_sma50&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;sma_50&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;sma_50&#39;</span><span class="p">]</span>
    
    <span class="c1"># RSI</span>
    <span class="n">delta</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span>
    <span class="n">gain</span> <span class="o">=</span> <span class="p">(</span><span class="n">delta</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">delta</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">14</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">delta</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">delta</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">14</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">rs</span> <span class="o">=</span> <span class="n">gain</span> <span class="o">/</span> <span class="n">loss</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;rsi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">-</span> <span class="p">(</span><span class="mi">100</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">rs</span><span class="p">))</span>
    
    <span class="c1"># Volume features</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;volume_ma&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Volume&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;volume_ratio&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Volume&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;volume_ma&#39;</span><span class="p">]</span>
    
    <span class="c1"># Target: next day direction</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;returns&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    
    <span class="c1"># Clean</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
    
    <span class="n">features</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;volatility&#39;</span><span class="p">,</span> <span class="s1">&#39;momentum_5&#39;</span><span class="p">,</span> <span class="s1">&#39;momentum_20&#39;</span><span class="p">,</span> <span class="s1">&#39;dist_sma5&#39;</span><span class="p">,</span> 
                <span class="s1">&#39;dist_sma20&#39;</span><span class="p">,</span> <span class="s1">&#39;dist_sma50&#39;</span><span class="p">,</span> <span class="s1">&#39;rsi&#39;</span><span class="p">,</span> <span class="s1">&#39;volume_ratio&#39;</span><span class="p">]</span>
    
    <span class="n">X</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">features</span><span class="p">]</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span>
    
    <span class="k">return</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span>

<span class="c1"># Prepare data</span>
<span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">prepare_trading_data</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dataset: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="si">}</span><span class="s2"> samples, </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="si">}</span><span class="s2"> features&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Target distribution: </span><span class="si">{</span><span class="n">y</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Build a simple decision tree</span>

<span class="c1"># Time series split</span>
<span class="n">split_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.8</span><span class="p">)</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span> <span class="o">=</span> <span class="n">X</span><span class="p">[:</span><span class="n">split_idx</span><span class="p">],</span> <span class="n">X</span><span class="p">[</span><span class="n">split_idx</span><span class="p">:]</span>
<span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">y</span><span class="p">[:</span><span class="n">split_idx</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">split_idx</span><span class="p">:]</span>

<span class="c1"># Train decision tree with limited depth</span>
<span class="n">dt_model</span> <span class="o">=</span> <span class="n">DecisionTreeClassifier</span><span class="p">(</span>
    <span class="n">max_depth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>  <span class="c1"># Shallow tree to avoid overfitting</span>
    <span class="n">min_samples_split</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
    <span class="n">min_samples_leaf</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
    <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span>
<span class="p">)</span>

<span class="n">dt_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

<span class="c1"># Evaluate</span>
<span class="n">train_acc</span> <span class="o">=</span> <span class="n">dt_model</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="n">test_acc</span> <span class="o">=</span> <span class="n">dt_model</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Decision Tree Results:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Train Accuracy: </span><span class="si">{</span><span class="n">train_acc</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Test Accuracy:  </span><span class="si">{</span><span class="n">test_acc</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Overfit Gap:    </span><span class="si">{</span><span class="n">train_acc</span> <span class="o">-</span> <span class="n">test_acc</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Visualize the decision tree</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="n">plot_tree</span><span class="p">(</span>
    <span class="n">dt_model</span><span class="p">,</span>
    <span class="n">feature_names</span><span class="o">=</span><span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
    <span class="n">class_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Down&#39;</span><span class="p">,</span> <span class="s1">&#39;Up&#39;</span><span class="p">],</span>
    <span class="n">filled</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">rounded</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Decision Tree for Trading Signal Classification&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Feature importance from decision tree</span>

<span class="n">importance_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s1">&#39;feature&#39;</span><span class="p">:</span> <span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span>
    <span class="s1">&#39;importance&#39;</span><span class="p">:</span> <span class="n">dt_model</span><span class="o">.</span><span class="n">feature_importances_</span>
<span class="p">})</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;importance&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="n">importance_df</span><span class="p">[</span><span class="s1">&#39;feature&#39;</span><span class="p">],</span> <span class="n">importance_df</span><span class="p">[</span><span class="s1">&#39;importance&#39;</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Feature Importance&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Decision Tree Feature Importance&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Feature Importance Ranking:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">importance_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;feature&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">15s</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;importance&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><hr />
<h2>Section 2: Random Forest</h2>
<p>Random Forest combines multiple decision trees using bagging and feature randomization to reduce overfitting and variance.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Random Forest Concepts</span>

<span class="n">rf_concepts</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">RANDOM FOREST</span>
<span class="s2">=============</span>

<span class="s2">Key Ideas:</span>
<span class="s2">----------</span>
<span class="s2">1. Bootstrap Aggregating (Bagging)</span>
<span class="s2">   - Train each tree on a random sample of data (with replacement)</span>
<span class="s2">   - Reduces variance without increasing bias</span>

<span class="s2">2. Feature Randomization</span>
<span class="s2">   - Each split considers only a random subset of features</span>
<span class="s2">   - Decorrelates trees, improving ensemble performance</span>

<span class="s2">3. Aggregation</span>
<span class="s2">   - Classification: Majority vote across all trees</span>
<span class="s2">   - Regression: Average of all tree predictions</span>

<span class="s2">Parameters:</span>
<span class="s2">-----------</span>
<span class="s2">- n_estimators: Number of trees (more is usually better, diminishing returns)</span>
<span class="s2">- max_features: Features to consider at each split (&#39;sqrt&#39;, &#39;log2&#39;, or int)</span>
<span class="s2">- max_depth: Maximum tree depth (None = fully grown)</span>
<span class="s2">- min_samples_split: Minimum samples to make a split</span>
<span class="s2">- min_samples_leaf: Minimum samples at leaf nodes</span>

<span class="s2">Advantages:</span>
<span class="s2">-----------</span>
<span class="s2">+ Robust to overfitting (compared to single tree)</span>
<span class="s2">+ Handles missing values well</span>
<span class="s2">+ Provides feature importance</span>
<span class="s2">+ Out-of-bag (OOB) error estimate</span>
<span class="s2">+ Parallelizable</span>

<span class="s2">Disadvantages:</span>
<span class="s2">--------------</span>
<span class="s2">- Less interpretable than single tree</span>
<span class="s2">- Memory intensive (stores all trees)</span>
<span class="s2">- Slower prediction than single tree</span>
<span class="s2">&quot;&quot;&quot;</span>
<span class="nb">print</span><span class="p">(</span><span class="n">rf_concepts</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Build a Random Forest classifier</span>

<span class="n">rf_model</span> <span class="o">=</span> <span class="n">RandomForestClassifier</span><span class="p">(</span>
    <span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>      <span class="c1"># Number of trees</span>
    <span class="n">max_depth</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>           <span class="c1"># Limit depth to prevent overfitting</span>
    <span class="n">min_samples_split</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
    <span class="n">min_samples_leaf</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
    <span class="n">max_features</span><span class="o">=</span><span class="s1">&#39;sqrt&#39;</span><span class="p">,</span>   <span class="c1"># sqrt(n_features) at each split</span>
    <span class="n">oob_score</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>        <span class="c1"># Calculate out-of-bag score</span>
    <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span>
    <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span>              <span class="c1"># Use all cores</span>
<span class="p">)</span>

<span class="n">rf_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

<span class="c1"># Evaluate</span>
<span class="n">train_acc</span> <span class="o">=</span> <span class="n">rf_model</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="n">test_acc</span> <span class="o">=</span> <span class="n">rf_model</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>
<span class="n">oob_acc</span> <span class="o">=</span> <span class="n">rf_model</span><span class="o">.</span><span class="n">oob_score_</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Random Forest Results:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Train Accuracy:   </span><span class="si">{</span><span class="n">train_acc</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Test Accuracy:    </span><span class="si">{</span><span class="n">test_acc</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  OOB Accuracy:     </span><span class="si">{</span><span class="n">oob_acc</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Overfit Gap:      </span><span class="si">{</span><span class="n">train_acc</span> <span class="o">-</span> <span class="n">test_acc</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Compare single tree vs Random Forest</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Comparison:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;Model&#39;</span><span class="si">:</span><span class="s2">&lt;20</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;Train Acc&#39;</span><span class="si">:</span><span class="s2">&lt;12</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;Test Acc&#39;</span><span class="si">:</span><span class="s2">&lt;12</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;Gap&#39;</span><span class="si">:</span><span class="s2">&lt;10</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">54</span><span class="p">)</span>

<span class="n">dt_train</span> <span class="o">=</span> <span class="n">dt_model</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="n">dt_test</span> <span class="o">=</span> <span class="n">dt_model</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;Decision Tree&#39;</span><span class="si">:</span><span class="s2">&lt;20</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">dt_train</span><span class="si">:</span><span class="s2">&lt;12.2%</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">dt_test</span><span class="si">:</span><span class="s2">&lt;12.2%</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">dt_train</span><span class="o">-</span><span class="n">dt_test</span><span class="si">:</span><span class="s2">&lt;10.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">rf_train</span> <span class="o">=</span> <span class="n">rf_model</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="n">rf_test</span> <span class="o">=</span> <span class="n">rf_model</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;Random Forest&#39;</span><span class="si">:</span><span class="s2">&lt;20</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">rf_train</span><span class="si">:</span><span class="s2">&lt;12.2%</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">rf_test</span><span class="si">:</span><span class="s2">&lt;12.2%</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">rf_train</span><span class="o">-</span><span class="n">rf_test</span><span class="si">:</span><span class="s2">&lt;10.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Random Forest feature importance</span>

<span class="n">rf_importance</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s1">&#39;feature&#39;</span><span class="p">:</span> <span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span>
    <span class="s1">&#39;importance&#39;</span><span class="p">:</span> <span class="n">rf_model</span><span class="o">.</span><span class="n">feature_importances_</span>
<span class="p">})</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;importance&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="n">rf_importance</span><span class="p">[</span><span class="s1">&#39;feature&#39;</span><span class="p">],</span> <span class="n">rf_importance</span><span class="p">[</span><span class="s1">&#39;importance&#39;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;forestgreen&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Feature Importance&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Random Forest Feature Importance&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 5.1: Random Forest Tuner (Guided)</span>

<span class="k">def</span> <span class="nf">tune_random_forest</span><span class="p">(</span><span class="n">X_train</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">y_train</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span>
                       <span class="n">n_estimators_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">50</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">200</span><span class="p">],</span>
                       <span class="n">max_depth_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Tune Random Forest hyperparameters using time series cross-validation.</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        Dictionary with best parameters and scores</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO: Create time series cross-validator with 5 splits</span>
    <span class="n">tscv</span> <span class="o">=</span> <span class="n">______</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="n">______</span><span class="p">)</span>
    
    <span class="n">best_score</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">best_params</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">for</span> <span class="n">n_est</span> <span class="ow">in</span> <span class="n">n_estimators_list</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">depth</span> <span class="ow">in</span> <span class="n">max_depth_list</span><span class="p">:</span>
            <span class="c1"># TODO: Create Random Forest with current parameters</span>
            <span class="n">model</span> <span class="o">=</span> <span class="n">______</span><span class="p">(</span>
                <span class="n">n_estimators</span><span class="o">=</span><span class="n">______</span><span class="p">,</span>
                <span class="n">max_depth</span><span class="o">=</span><span class="n">______</span><span class="p">,</span>
                <span class="n">min_samples_leaf</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span>
                <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span>
            <span class="p">)</span>
            
            <span class="c1"># TODO: Get cross-validation scores</span>
            <span class="n">scores</span> <span class="o">=</span> <span class="n">______</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="n">tscv</span><span class="p">,</span> <span class="n">scoring</span><span class="o">=</span><span class="s1">&#39;accuracy&#39;</span><span class="p">)</span>
            <span class="n">mean_score</span> <span class="o">=</span> <span class="n">scores</span><span class="o">.</span><span class="n">______</span><span class="p">()</span>
            
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;n_estimators&#39;</span><span class="p">:</span> <span class="n">n_est</span><span class="p">,</span>
                <span class="s1">&#39;max_depth&#39;</span><span class="p">:</span> <span class="n">depth</span><span class="p">,</span>
                <span class="s1">&#39;mean_cv_score&#39;</span><span class="p">:</span> <span class="n">mean_score</span><span class="p">,</span>
                <span class="s1">&#39;std_cv_score&#39;</span><span class="p">:</span> <span class="n">scores</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
            <span class="p">})</span>
            
            <span class="k">if</span> <span class="n">mean_score</span> <span class="o">&gt;</span> <span class="n">best_score</span><span class="p">:</span>
                <span class="n">best_score</span> <span class="o">=</span> <span class="n">mean_score</span>
                <span class="n">best_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;n_estimators&#39;</span><span class="p">:</span> <span class="n">n_est</span><span class="p">,</span> <span class="s1">&#39;max_depth&#39;</span><span class="p">:</span> <span class="n">depth</span><span class="p">}</span>
    
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;best_params&#39;</span><span class="p">:</span> <span class="n">best_params</span><span class="p">,</span>
        <span class="s1">&#39;best_score&#39;</span><span class="p">:</span> <span class="n">best_score</span><span class="p">,</span>
        <span class="s1">&#39;all_results&#39;</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
    <span class="p">}</span>

<span class="c1"># Test the function</span>
<span class="c1"># tuning_results = tune_random_forest(X_train, y_train)</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 5.1</summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">tune_random_forest</span><span class="p">(</span><span class="n">X_train</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">y_train</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span>
                       <span class="n">n_estimators_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">50</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">200</span><span class="p">],</span>
                       <span class="n">max_depth_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Tune Random Forest hyperparameters using time series cross-validation.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tscv</span> <span class="o">=</span> <span class="n">TimeSeriesSplit</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

    <span class="n">best_score</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">best_params</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">n_est</span> <span class="ow">in</span> <span class="n">n_estimators_list</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">depth</span> <span class="ow">in</span> <span class="n">max_depth_list</span><span class="p">:</span>
            <span class="n">model</span> <span class="o">=</span> <span class="n">RandomForestClassifier</span><span class="p">(</span>
                <span class="n">n_estimators</span><span class="o">=</span><span class="n">n_est</span><span class="p">,</span>
                <span class="n">max_depth</span><span class="o">=</span><span class="n">depth</span><span class="p">,</span>
                <span class="n">min_samples_leaf</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span>
                <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span>
            <span class="p">)</span>

            <span class="n">scores</span> <span class="o">=</span> <span class="n">cross_val_score</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="n">tscv</span><span class="p">,</span> <span class="n">scoring</span><span class="o">=</span><span class="s1">&#39;accuracy&#39;</span><span class="p">)</span>
            <span class="n">mean_score</span> <span class="o">=</span> <span class="n">scores</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;n_estimators&#39;</span><span class="p">:</span> <span class="n">n_est</span><span class="p">,</span>
                <span class="s1">&#39;max_depth&#39;</span><span class="p">:</span> <span class="n">depth</span><span class="p">,</span>
                <span class="s1">&#39;mean_cv_score&#39;</span><span class="p">:</span> <span class="n">mean_score</span><span class="p">,</span>
                <span class="s1">&#39;std_cv_score&#39;</span><span class="p">:</span> <span class="n">scores</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
            <span class="p">})</span>

            <span class="k">if</span> <span class="n">mean_score</span> <span class="o">&gt;</span> <span class="n">best_score</span><span class="p">:</span>
                <span class="n">best_score</span> <span class="o">=</span> <span class="n">mean_score</span>
                <span class="n">best_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;n_estimators&#39;</span><span class="p">:</span> <span class="n">n_est</span><span class="p">,</span> <span class="s1">&#39;max_depth&#39;</span><span class="p">:</span> <span class="n">depth</span><span class="p">}</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;best_params&#39;</span><span class="p">:</span> <span class="n">best_params</span><span class="p">,</span>
        <span class="s1">&#39;best_score&#39;</span><span class="p">:</span> <span class="n">best_score</span><span class="p">,</span>
        <span class="s1">&#39;all_results&#39;</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
    <span class="p">}</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h2>Section 3: Gradient Boosting (XGBoost)</h2>
<p>Gradient Boosting builds trees sequentially, with each tree correcting the errors of the previous ones.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Gradient Boosting Concepts</span>

<span class="n">boosting_concepts</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">GRADIENT BOOSTING</span>
<span class="s2">=================</span>

<span class="s2">Key Idea:</span>
<span class="s2">---------</span>
<span class="s2">Build trees sequentially, where each tree learns from the errors of all previous trees.</span>

<span class="s2">Process:</span>
<span class="s2">--------</span>
<span class="s2">1. Start with initial prediction (e.g., mean)</span>
<span class="s2">2. Calculate residuals (errors)</span>
<span class="s2">3. Fit a tree to predict the residuals</span>
<span class="s2">4. Update predictions by adding tree * learning_rate</span>
<span class="s2">5. Repeat steps 2-4 for n_estimators iterations</span>

<span class="s2">XGBoost Advantages:</span>
<span class="s2">-------------------</span>
<span class="s2">- Regularization: L1 (lasso) and L2 (ridge) to prevent overfitting</span>
<span class="s2">- Parallel processing: Faster training</span>
<span class="s2">- Built-in cross-validation</span>
<span class="s2">- Handles missing values</span>
<span class="s2">- Tree pruning: Removes non-essential branches</span>

<span class="s2">Key Parameters:</span>
<span class="s2">---------------</span>
<span class="s2">- n_estimators: Number of boosting rounds</span>
<span class="s2">- learning_rate (eta): Step size shrinkage (0.01-0.3 typical)</span>
<span class="s2">- max_depth: Maximum tree depth (3-10 typical)</span>
<span class="s2">- subsample: Fraction of samples for each tree</span>
<span class="s2">- colsample_bytree: Fraction of features for each tree</span>
<span class="s2">- reg_alpha: L1 regularization</span>
<span class="s2">- reg_lambda: L2 regularization</span>

<span class="s2">Random Forest vs XGBoost:</span>
<span class="s2">-------------------------</span>
<span class="s2">| Aspect        | Random Forest      | XGBoost           |</span>
<span class="s2">|---------------|--------------------|--------------------|n| Training      | Parallel (bagging) | Sequential (boost) |</span>
<span class="s2">| Trees         | Deep, independent  | Shallow, dependent |</span>
<span class="s2">| Overfitting   | Less prone         | More prone         |</span>
<span class="s2">| Tuning        | Easier             | More parameters    |</span>
<span class="s2">| Performance   | Good baseline      | Often better       |</span>
<span class="s2">&quot;&quot;&quot;</span>
<span class="nb">print</span><span class="p">(</span><span class="n">boosting_concepts</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Scikit-learn&#39;s GradientBoostingClassifier</span>

<span class="n">gbc_model</span> <span class="o">=</span> <span class="n">GradientBoostingClassifier</span><span class="p">(</span>
    <span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
    <span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
    <span class="n">max_depth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
    <span class="n">min_samples_split</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
    <span class="n">min_samples_leaf</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
    <span class="n">subsample</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
    <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span>
<span class="p">)</span>

<span class="n">gbc_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

<span class="n">train_acc</span> <span class="o">=</span> <span class="n">gbc_model</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="n">test_acc</span> <span class="o">=</span> <span class="n">gbc_model</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Gradient Boosting (sklearn) Results:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Train Accuracy: </span><span class="si">{</span><span class="n">train_acc</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Test Accuracy:  </span><span class="si">{</span><span class="n">test_acc</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># XGBoost implementation</span>

<span class="k">if</span> <span class="n">HAS_XGBOOST</span><span class="p">:</span>
    <span class="n">xgb_model</span> <span class="o">=</span> <span class="n">xgb</span><span class="o">.</span><span class="n">XGBClassifier</span><span class="p">(</span>
        <span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
        <span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
        <span class="n">max_depth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
        <span class="n">min_child_weight</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
        <span class="n">subsample</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
        <span class="n">colsample_bytree</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
        <span class="n">reg_alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>       <span class="c1"># L1 regularization</span>
        <span class="n">reg_lambda</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>      <span class="c1"># L2 regularization</span>
        <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span>
        <span class="n">use_label_encoder</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">eval_metric</span><span class="o">=</span><span class="s1">&#39;logloss&#39;</span>
    <span class="p">)</span>
    
    <span class="n">xgb_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
    
    <span class="n">train_acc</span> <span class="o">=</span> <span class="n">xgb_model</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
    <span class="n">test_acc</span> <span class="o">=</span> <span class="n">xgb_model</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;XGBoost Results:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Train Accuracy: </span><span class="si">{</span><span class="n">train_acc</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Test Accuracy:  </span><span class="si">{</span><span class="n">test_acc</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;XGBoost not available. Install with: pip install xgboost&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># XGBoost with early stopping</span>

<span class="k">if</span> <span class="n">HAS_XGBOOST</span><span class="p">:</span>
    <span class="c1"># Create validation set for early stopping</span>
    <span class="n">val_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.8</span><span class="p">)</span>
    <span class="n">X_train_sub</span><span class="p">,</span> <span class="n">X_val</span> <span class="o">=</span> <span class="n">X_train</span><span class="p">[:</span><span class="n">val_idx</span><span class="p">],</span> <span class="n">X_train</span><span class="p">[</span><span class="n">val_idx</span><span class="p">:]</span>
    <span class="n">y_train_sub</span><span class="p">,</span> <span class="n">y_val</span> <span class="o">=</span> <span class="n">y_train</span><span class="p">[:</span><span class="n">val_idx</span><span class="p">],</span> <span class="n">y_train</span><span class="p">[</span><span class="n">val_idx</span><span class="p">:]</span>
    
    <span class="n">xgb_early</span> <span class="o">=</span> <span class="n">xgb</span><span class="o">.</span><span class="n">XGBClassifier</span><span class="p">(</span>
        <span class="n">n_estimators</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>  <span class="c1"># High number, will stop early</span>
        <span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>
        <span class="n">max_depth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
        <span class="n">min_child_weight</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
        <span class="n">subsample</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
        <span class="n">colsample_bytree</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
        <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span>
        <span class="n">use_label_encoder</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">eval_metric</span><span class="o">=</span><span class="s1">&#39;logloss&#39;</span><span class="p">,</span>
        <span class="n">early_stopping_rounds</span><span class="o">=</span><span class="mi">20</span>
    <span class="p">)</span>
    
    <span class="n">xgb_early</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
        <span class="n">X_train_sub</span><span class="p">,</span> <span class="n">y_train_sub</span><span class="p">,</span>
        <span class="n">eval_set</span><span class="o">=</span><span class="p">[(</span><span class="n">X_val</span><span class="p">,</span> <span class="n">y_val</span><span class="p">)],</span>
        <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Early Stopping Results:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Best iteration: </span><span class="si">{</span><span class="n">xgb_early</span><span class="o">.</span><span class="n">best_iteration</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Test Accuracy:  </span><span class="si">{</span><span class="n">xgb_early</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 5.2: XGBoost Feature Importance Analyzer (Guided)</span>

<span class="k">def</span> <span class="nf">analyze_xgb_importance</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">feature_names</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> 
                           <span class="n">importance_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;gain&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Analyze XGBoost feature importance using different metrics.</span>
<span class="sd">    </span>
<span class="sd">    importance_type: &#39;weight&#39;, &#39;gain&#39;, or &#39;cover&#39;</span>
<span class="sd">      - weight: Number of times feature is used in trees</span>
<span class="sd">      - gain: Average improvement in accuracy when feature is used</span>
<span class="sd">      - cover: Average number of samples affected by feature splits</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO: Get importance scores from the model&#39;s booster</span>
    <span class="n">importance_dict</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get_booster</span><span class="p">()</span><span class="o">.</span><span class="n">______</span><span class="p">(</span><span class="n">importance_type</span><span class="o">=</span><span class="n">______</span><span class="p">)</span>
    
    <span class="c1"># Create dataframe with feature names and importance</span>
    <span class="n">importance_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span>
        <span class="p">{</span><span class="s1">&#39;feature&#39;</span><span class="p">:</span> <span class="n">f</span><span class="p">,</span> <span class="s1">&#39;importance&#39;</span><span class="p">:</span> <span class="n">importance_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="mi">0</span><span class="p">)}</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">feature_names</span>
    <span class="p">])</span>
    
    <span class="c1"># TODO: Sort by importance descending</span>
    <span class="n">importance_df</span> <span class="o">=</span> <span class="n">importance_df</span><span class="o">.</span><span class="n">______</span><span class="p">(</span><span class="n">______</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="n">______</span><span class="p">)</span>
    
    <span class="c1"># Normalize to percentages</span>
    <span class="n">total</span> <span class="o">=</span> <span class="n">importance_df</span><span class="p">[</span><span class="s1">&#39;importance&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">total</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">importance_df</span><span class="p">[</span><span class="s1">&#39;pct&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">importance_df</span><span class="p">[</span><span class="s1">&#39;importance&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">total</span> <span class="o">*</span> <span class="mi">100</span>
    
    <span class="k">return</span> <span class="n">importance_df</span>

<span class="c1"># Test the function</span>
<span class="c1"># if HAS_XGBOOST:</span>
<span class="c1">#     importance = analyze_xgb_importance(xgb_model, X.columns.tolist())</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 5.2</summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">analyze_xgb_importance</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">feature_names</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> 
                           <span class="n">importance_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;gain&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Analyze XGBoost feature importance using different metrics.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">importance_dict</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get_booster</span><span class="p">()</span><span class="o">.</span><span class="n">get_score</span><span class="p">(</span><span class="n">importance_type</span><span class="o">=</span><span class="n">importance_type</span><span class="p">)</span>

    <span class="n">importance_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span>
        <span class="p">{</span><span class="s1">&#39;feature&#39;</span><span class="p">:</span> <span class="n">f</span><span class="p">,</span> <span class="s1">&#39;importance&#39;</span><span class="p">:</span> <span class="n">importance_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="mi">0</span><span class="p">)}</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">feature_names</span>
    <span class="p">])</span>

    <span class="n">importance_df</span> <span class="o">=</span> <span class="n">importance_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;importance&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">total</span> <span class="o">=</span> <span class="n">importance_df</span><span class="p">[</span><span class="s1">&#39;importance&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">total</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">importance_df</span><span class="p">[</span><span class="s1">&#39;pct&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">importance_df</span><span class="p">[</span><span class="s1">&#39;importance&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">total</span> <span class="o">*</span> <span class="mi">100</span>

    <span class="k">return</span> <span class="n">importance_df</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h2>Section 4: LightGBM</h2>
<p>LightGBM is a highly efficient gradient boosting implementation that uses histogram-based learning.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># LightGBM Concepts</span>

<span class="n">lgbm_concepts</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">LIGHTGBM</span>
<span class="s2">========</span>

<span class="s2">Key Innovations:</span>
<span class="s2">----------------</span>
<span class="s2">1. Histogram-based Learning</span>
<span class="s2">   - Bins continuous features into discrete buckets</span>
<span class="s2">   - Much faster than exact split finding</span>
<span class="s2">   - Reduces memory usage</span>

<span class="s2">2. Leaf-wise Tree Growth</span>
<span class="s2">   - Grows tree by splitting leaf with max gain</span>
<span class="s2">   - More complex trees, better accuracy</span>
<span class="s2">   - Prone to overfitting (use max_depth limit)</span>

<span class="s2">3. Gradient-based One-Side Sampling (GOSS)</span>
<span class="s2">   - Keeps samples with large gradients</span>
<span class="s2">   - Randomly samples from small gradients</span>
<span class="s2">   - Faster training with minimal accuracy loss</span>

<span class="s2">XGBoost vs LightGBM:</span>
<span class="s2">--------------------</span>
<span class="s2">| Aspect        | XGBoost          | LightGBM         |</span>
<span class="s2">|---------------|------------------|-------------------|</span>
<span class="s2">| Tree Growth   | Level-wise       | Leaf-wise        |</span>
<span class="s2">| Speed         | Good             | Faster           |</span>
<span class="s2">| Memory        | Higher           | Lower            |</span>
<span class="s2">| Categoricals  | Needs encoding   | Native support   |</span>
<span class="s2">| Overfitting   | Less prone       | More prone       |</span>

<span class="s2">Key Parameters:</span>
<span class="s2">---------------</span>
<span class="s2">- num_leaves: Max leaves per tree (default 31)</span>
<span class="s2">- max_depth: Limit tree depth (-1 = unlimited)</span>
<span class="s2">- learning_rate: Step size (0.01-0.3)</span>
<span class="s2">- feature_fraction: Features per tree (like colsample_bytree)</span>
<span class="s2">- bagging_fraction: Samples per tree (like subsample)</span>
<span class="s2">&quot;&quot;&quot;</span>
<span class="nb">print</span><span class="p">(</span><span class="n">lgbm_concepts</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># LightGBM implementation</span>

<span class="k">if</span> <span class="n">HAS_LIGHTGBM</span><span class="p">:</span>
    <span class="n">lgb_model</span> <span class="o">=</span> <span class="n">lgb</span><span class="o">.</span><span class="n">LGBMClassifier</span><span class="p">(</span>
        <span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
        <span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
        <span class="n">num_leaves</span><span class="o">=</span><span class="mi">31</span><span class="p">,</span>
        <span class="n">max_depth</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
        <span class="n">min_child_samples</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
        <span class="n">subsample</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
        <span class="n">colsample_bytree</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
        <span class="n">reg_alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
        <span class="n">reg_lambda</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
        <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span>
        <span class="n">verbose</span><span class="o">=-</span><span class="mi">1</span>
    <span class="p">)</span>
    
    <span class="n">lgb_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
    
    <span class="n">train_acc</span> <span class="o">=</span> <span class="n">lgb_model</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
    <span class="n">test_acc</span> <span class="o">=</span> <span class="n">lgb_model</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;LightGBM Results:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Train Accuracy: </span><span class="si">{</span><span class="n">train_acc</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Test Accuracy:  </span><span class="si">{</span><span class="n">test_acc</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;LightGBM not available. Install with: pip install lightgbm&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Compare all tree-based models</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;TREE-BASED MODEL COMPARISON&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>

<span class="n">models</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;Decision Tree&#39;</span><span class="p">:</span> <span class="n">dt_model</span><span class="p">,</span>
    <span class="s1">&#39;Random Forest&#39;</span><span class="p">:</span> <span class="n">rf_model</span><span class="p">,</span>
    <span class="s1">&#39;GradientBoosting&#39;</span><span class="p">:</span> <span class="n">gbc_model</span>
<span class="p">}</span>

<span class="k">if</span> <span class="n">HAS_XGBOOST</span><span class="p">:</span>
    <span class="n">models</span><span class="p">[</span><span class="s1">&#39;XGBoost&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xgb_model</span>
<span class="k">if</span> <span class="n">HAS_LIGHTGBM</span><span class="p">:</span>
    <span class="n">models</span><span class="p">[</span><span class="s1">&#39;LightGBM&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lgb_model</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="s1">&#39;Model&#39;</span><span class="si">:</span><span class="s2">&lt;20</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;Train Acc&#39;</span><span class="si">:</span><span class="s2">&lt;12</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;Test Acc&#39;</span><span class="si">:</span><span class="s2">&lt;12</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;Gap&#39;</span><span class="si">:</span><span class="s2">&lt;10</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">54</span><span class="p">)</span>

<span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">models</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">train_acc</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
    <span class="n">test_acc</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">:</span><span class="s2">&lt;20</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">train_acc</span><span class="si">:</span><span class="s2">&lt;12.2%</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">test_acc</span><span class="si">:</span><span class="s2">&lt;12.2%</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">train_acc</span><span class="o">-</span><span class="n">test_acc</span><span class="si">:</span><span class="s2">&lt;10.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 5.3: LightGBM Trainer with Callbacks (Guided)</span>

<span class="k">def</span> <span class="nf">train_lgb_with_callbacks</span><span class="p">(</span><span class="n">X_train</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">y_train</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span>
                              <span class="n">X_val</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">y_val</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span>
                              <span class="n">params</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Train LightGBM with early stopping and logging.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">HAS_LIGHTGBM</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s2">&quot;LightGBM not installed&quot;</span><span class="p">)</span>
    
    <span class="n">default_params</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;n_estimators&#39;</span><span class="p">:</span> <span class="mi">500</span><span class="p">,</span>
        <span class="s1">&#39;learning_rate&#39;</span><span class="p">:</span> <span class="mf">0.05</span><span class="p">,</span>
        <span class="s1">&#39;num_leaves&#39;</span><span class="p">:</span> <span class="mi">31</span><span class="p">,</span>
        <span class="s1">&#39;max_depth&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
        <span class="s1">&#39;random_state&#39;</span><span class="p">:</span> <span class="mi">42</span><span class="p">,</span>
        <span class="s1">&#39;verbose&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span>
    <span class="p">}</span>
    
    <span class="k">if</span> <span class="n">params</span><span class="p">:</span>
        <span class="n">default_params</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
    
    <span class="c1"># TODO: Create LightGBM classifier with parameters</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">lgb</span><span class="o">.</span><span class="n">______</span><span class="p">(</span><span class="o">**</span><span class="n">default_params</span><span class="p">)</span>
    
    <span class="c1"># TODO: Fit with evaluation set and early stopping</span>
    <span class="n">model</span><span class="o">.</span><span class="n">______</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span>
                 <span class="n">eval_set</span><span class="o">=</span><span class="p">[(</span><span class="n">______</span><span class="p">,</span> <span class="n">______</span><span class="p">)],</span>
                 <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">lgb</span><span class="o">.</span><span class="n">early_stopping</span><span class="p">(</span><span class="n">stopping_rounds</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)])</span>
    
    <span class="c1"># Get best iteration</span>
    <span class="n">best_iter</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">best_iteration_</span>
    
    <span class="k">return</span> <span class="n">model</span><span class="p">,</span> <span class="n">best_iter</span>

<span class="c1"># Test the function</span>
<span class="c1"># model, best_iter = train_lgb_with_callbacks(X_train_sub, y_train_sub, X_val, y_val)</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 5.3</summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">train_lgb_with_callbacks</span><span class="p">(</span><span class="n">X_train</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">y_train</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span>
                              <span class="n">X_val</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">y_val</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span>
                              <span class="n">params</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Train LightGBM with early stopping and logging.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">HAS_LIGHTGBM</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s2">&quot;LightGBM not installed&quot;</span><span class="p">)</span>

    <span class="n">default_params</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;n_estimators&#39;</span><span class="p">:</span> <span class="mi">500</span><span class="p">,</span>
        <span class="s1">&#39;learning_rate&#39;</span><span class="p">:</span> <span class="mf">0.05</span><span class="p">,</span>
        <span class="s1">&#39;num_leaves&#39;</span><span class="p">:</span> <span class="mi">31</span><span class="p">,</span>
        <span class="s1">&#39;max_depth&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
        <span class="s1">&#39;random_state&#39;</span><span class="p">:</span> <span class="mi">42</span><span class="p">,</span>
        <span class="s1">&#39;verbose&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="n">params</span><span class="p">:</span>
        <span class="n">default_params</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

    <span class="n">model</span> <span class="o">=</span> <span class="n">lgb</span><span class="o">.</span><span class="n">LGBMClassifier</span><span class="p">(</span><span class="o">**</span><span class="n">default_params</span><span class="p">)</span>

    <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span>
              <span class="n">eval_set</span><span class="o">=</span><span class="p">[(</span><span class="n">X_val</span><span class="p">,</span> <span class="n">y_val</span><span class="p">)],</span>
              <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">lgb</span><span class="o">.</span><span class="n">early_stopping</span><span class="p">(</span><span class="n">stopping_rounds</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)])</span>

    <span class="n">best_iter</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">best_iteration_</span>

    <span class="k">return</span> <span class="n">model</span><span class="p">,</span> <span class="n">best_iter</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h2>Section 5: Ensemble Methods</h2>
<p>Combining multiple models can produce more robust predictions than any single model.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Ensemble Methods Overview</span>

<span class="n">ensemble_concepts</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">ENSEMBLE METHODS</span>
<span class="s2">================</span>

<span class="s2">1. VOTING ENSEMBLES</span>
<span class="s2">   - Hard Voting: Majority vote from all models</span>
<span class="s2">   - Soft Voting: Average probabilities, then predict</span>

<span class="s2">2. STACKING</span>
<span class="s2">   - Train base models on data</span>
<span class="s2">   - Use base model predictions as features for meta-model</span>
<span class="s2">   - Meta-model learns to combine predictions optimally</span>

<span class="s2">3. BLENDING</span>
<span class="s2">   - Similar to stacking but uses holdout set</span>
<span class="s2">   - Base models trained on training set</span>
<span class="s2">   - Meta-model trained on holdout predictions</span>

<span class="s2">Why Ensembles Work:</span>
<span class="s2">-------------------</span>
<span class="s2">- Different models capture different patterns</span>
<span class="s2">- Errors from different models tend to cancel out</span>
<span class="s2">- More robust to overfitting</span>
<span class="s2">- Reduced variance in predictions</span>

<span class="s2">Best Practices:</span>
<span class="s2">---------------</span>
<span class="s2">- Use diverse base models (different algorithms)</span>
<span class="s2">- Each model should be better than random</span>
<span class="s2">- Models should make different types of errors</span>
<span class="s2">- Keep ensemble simple to avoid complexity</span>
<span class="s2">&quot;&quot;&quot;</span>
<span class="nb">print</span><span class="p">(</span><span class="n">ensemble_concepts</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Voting Ensemble</span>

<span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">VotingClassifier</span>

<span class="c1"># Create base estimators</span>
<span class="n">estimators</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;rf&#39;</span><span class="p">,</span> <span class="n">RandomForestClassifier</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;gbc&#39;</span><span class="p">,</span> <span class="n">GradientBoostingClassifier</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">))</span>
<span class="p">]</span>

<span class="c1"># Add XGBoost and LightGBM if available</span>
<span class="k">if</span> <span class="n">HAS_XGBOOST</span><span class="p">:</span>
    <span class="n">estimators</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;xgb&#39;</span><span class="p">,</span> <span class="n">xgb</span><span class="o">.</span><span class="n">XGBClassifier</span><span class="p">(</span>
        <span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span>
        <span class="n">use_label_encoder</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">eval_metric</span><span class="o">=</span><span class="s1">&#39;logloss&#39;</span>
    <span class="p">)))</span>

<span class="k">if</span> <span class="n">HAS_LIGHTGBM</span><span class="p">:</span>
    <span class="n">estimators</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;lgb&#39;</span><span class="p">,</span> <span class="n">lgb</span><span class="o">.</span><span class="n">LGBMClassifier</span><span class="p">(</span>
        <span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=-</span><span class="mi">1</span>
    <span class="p">)))</span>

<span class="c1"># Create voting classifier</span>
<span class="n">voting_clf</span> <span class="o">=</span> <span class="n">VotingClassifier</span><span class="p">(</span>
    <span class="n">estimators</span><span class="o">=</span><span class="n">estimators</span><span class="p">,</span>
    <span class="n">voting</span><span class="o">=</span><span class="s1">&#39;soft&#39;</span>  <span class="c1"># Use predicted probabilities</span>
<span class="p">)</span>

<span class="n">voting_clf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

<span class="n">train_acc</span> <span class="o">=</span> <span class="n">voting_clf</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="n">test_acc</span> <span class="o">=</span> <span class="n">voting_clf</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Voting Ensemble Results:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Train Accuracy: </span><span class="si">{</span><span class="n">train_acc</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Test Accuracy:  </span><span class="si">{</span><span class="n">test_acc</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Custom weighted ensemble</span>

<span class="k">class</span> <span class="nc">WeightedEnsemble</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Custom weighted ensemble classifier.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">models</span><span class="p">:</span> <span class="n">List</span><span class="p">,</span> <span class="n">weights</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">models</span> <span class="o">=</span> <span class="n">models</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="n">weights</span> <span class="ow">or</span> <span class="p">[</span><span class="mi">1</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">models</span><span class="p">)]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">models</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Fit all base models.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">:</span>
            <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>
    
    <span class="k">def</span> <span class="nf">predict_proba</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Weighted average of predicted probabilities.&quot;&quot;&quot;</span>
        <span class="n">probas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">),</span> <span class="mi">2</span><span class="p">))</span>
        
        <span class="k">for</span> <span class="n">model</span><span class="p">,</span> <span class="n">weight</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">):</span>
            <span class="n">probas</span> <span class="o">+=</span> <span class="n">weight</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
            
        <span class="k">return</span> <span class="n">probas</span> <span class="o">/</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Predict class labels.&quot;&quot;&quot;</span>
        <span class="n">probas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">probas</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">score</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate accuracy.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">accuracy_score</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">))</span>

<span class="c1"># Create weighted ensemble</span>
<span class="n">base_models</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">RandomForestClassifier</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">),</span>
    <span class="n">GradientBoostingClassifier</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
<span class="p">]</span>

<span class="k">if</span> <span class="n">HAS_XGBOOST</span><span class="p">:</span>
    <span class="n">base_models</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xgb</span><span class="o">.</span><span class="n">XGBClassifier</span><span class="p">(</span>
        <span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span>
        <span class="n">use_label_encoder</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">eval_metric</span><span class="o">=</span><span class="s1">&#39;logloss&#39;</span>
    <span class="p">))</span>

<span class="c1"># Weight models (higher weight for better performers)</span>
<span class="n">weights</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">]</span> <span class="k">if</span> <span class="n">HAS_XGBOOST</span> <span class="k">else</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">]</span>

<span class="n">weighted_ensemble</span> <span class="o">=</span> <span class="n">WeightedEnsemble</span><span class="p">(</span><span class="n">base_models</span><span class="p">,</span> <span class="n">weights</span><span class="p">)</span>
<span class="n">weighted_ensemble</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Weighted Ensemble Results:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Test Accuracy: </span><span class="si">{</span><span class="n">weighted_ensemble</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 5.4: Complete Tree-Based Classifier System (Open-ended)</span>
<span class="c1">#</span>
<span class="c1"># Build a TreeBasedClassifier class that:</span>
<span class="c1"># - Supports multiple model types: &#39;dt&#39;, &#39;rf&#39;, &#39;xgb&#39;, &#39;lgb&#39;</span>
<span class="c1"># - Has a tune() method for hyperparameter optimization</span>
<span class="c1"># - Has a fit() method that trains the selected model</span>
<span class="c1"># - Has a predict() and predict_proba() method</span>
<span class="c1"># - Has a get_feature_importance() method returning DataFrame</span>
<span class="c1"># - Handles missing XGBoost/LightGBM gracefully</span>
<span class="c1">#</span>
<span class="c1"># Your implementation:</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 5.4</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">TreeBasedClassifier</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Unified interface for tree-based classifiers.&quot;&quot;&quot;</span>

    <span class="n">SUPPORTED_MODELS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;dt&#39;</span><span class="p">,</span> <span class="s1">&#39;rf&#39;</span><span class="p">,</span> <span class="s1">&#39;gbc&#39;</span><span class="p">,</span> <span class="s1">&#39;xgb&#39;</span><span class="p">,</span> <span class="s1">&#39;lgb&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;rf&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">model_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">SUPPORTED_MODELS</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported model: </span><span class="si">{</span><span class="n">model_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model_type</span> <span class="o">=</span> <span class="n">model_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">kwargs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_names</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_create_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="n">Dict</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create model instance based on type.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;dt&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">DecisionTreeClassifier</span><span class="p">(</span><span class="o">**</span><span class="n">params</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;rf&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">RandomForestClassifier</span><span class="p">(</span><span class="o">**</span><span class="n">params</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;gbc&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">GradientBoostingClassifier</span><span class="p">(</span><span class="o">**</span><span class="n">params</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;xgb&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">HAS_XGBOOST</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s2">&quot;XGBoost not installed&quot;</span><span class="p">)</span>
            <span class="n">params</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;use_label_encoder&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="n">params</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;eval_metric&#39;</span><span class="p">,</span> <span class="s1">&#39;logloss&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">xgb</span><span class="o">.</span><span class="n">XGBClassifier</span><span class="p">(</span><span class="o">**</span><span class="n">params</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;lgb&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">HAS_LIGHTGBM</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s2">&quot;LightGBM not installed&quot;</span><span class="p">)</span>
            <span class="n">params</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;verbose&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">lgb</span><span class="o">.</span><span class="n">LGBMClassifier</span><span class="p">(</span><span class="o">**</span><span class="n">params</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">tune</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> 
             <span class="n">param_grid</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">cv</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Tune hyperparameters using cross-validation.&quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">GridSearchCV</span>

        <span class="k">if</span> <span class="n">param_grid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">param_grid</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;max_depth&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">],</span>
                <span class="s1">&#39;n_estimators&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">50</span><span class="p">,</span> <span class="mi">100</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_type</span> <span class="o">!=</span> <span class="s1">&#39;dt&#39;</span> <span class="k">else</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span>
            <span class="p">}</span>

        <span class="n">base_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_model</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
        <span class="n">tscv</span> <span class="o">=</span> <span class="n">TimeSeriesSplit</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="n">cv</span><span class="p">)</span>

        <span class="n">grid_search</span> <span class="o">=</span> <span class="n">GridSearchCV</span><span class="p">(</span>
            <span class="n">base_model</span><span class="p">,</span> <span class="n">param_grid</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="n">tscv</span><span class="p">,</span> <span class="n">scoring</span><span class="o">=</span><span class="s1">&#39;accuracy&#39;</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span>
        <span class="p">)</span>
        <span class="n">grid_search</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">grid_search</span><span class="o">.</span><span class="n">best_params_</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">grid_search</span><span class="o">.</span><span class="n">best_params_</span>

    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Fit the model.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_names</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_model</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Predict class labels.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">predict_proba</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Predict class probabilities.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_feature_importance</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get feature importance as DataFrame.&quot;&quot;&quot;</span>
        <span class="n">importance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">feature_importances_</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
            <span class="s1">&#39;feature&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_names</span><span class="p">,</span>
            <span class="s1">&#39;importance&#39;</span><span class="p">:</span> <span class="n">importance</span>
        <span class="p">})</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;importance&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;pct&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;importance&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;importance&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">*</span> <span class="mi">100</span>
        <span class="k">return</span> <span class="n">df</span>

    <span class="k">def</span> <span class="nf">score</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate accuracy.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">accuracy_score</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">))</span>
</code></pre></div>


</details></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 5.5: Stacking Ensemble Builder (Open-ended)</span>
<span class="c1">#</span>
<span class="c1"># Build a StackingEnsemble class that:</span>
<span class="c1"># - Takes a list of base models and a meta-model</span>
<span class="c1"># - Uses cross-validation to generate base model predictions</span>
<span class="c1"># - Trains meta-model on stacked predictions</span>
<span class="c1"># - Implements fit(), predict(), and predict_proba()</span>
<span class="c1"># - Returns individual model contributions</span>
<span class="c1">#</span>
<span class="c1"># Your implementation:</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 5.5</summary>


<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">sklearn.base</span> <span class="kn">import</span> <span class="n">clone</span>

<span class="k">class</span> <span class="nc">StackingEnsemble</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Stacking ensemble with customizable base and meta models.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base_models</span><span class="p">:</span> <span class="n">List</span><span class="p">,</span> <span class="n">meta_model</span><span class="p">,</span> <span class="n">n_folds</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_models</span> <span class="o">=</span> <span class="p">[</span><span class="n">clone</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">base_models</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meta_model</span> <span class="o">=</span> <span class="n">clone</span><span class="p">(</span><span class="n">meta_model</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_folds</span> <span class="o">=</span> <span class="n">n_folds</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fitted_base_models</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Fit stacking ensemble.&quot;&quot;&quot;</span>
        <span class="n">X_arr</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">values</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="k">else</span> <span class="n">X</span>
        <span class="n">y_arr</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">values</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="k">else</span> <span class="n">y</span>

        <span class="n">n_samples</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">X_arr</span><span class="p">)</span>
        <span class="n">n_models</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_models</span><span class="p">)</span>

        <span class="c1"># Out-of-fold predictions for meta features</span>
        <span class="n">meta_features</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_samples</span><span class="p">,</span> <span class="n">n_models</span><span class="p">))</span>

        <span class="n">tscv</span> <span class="o">=</span> <span class="n">TimeSeriesSplit</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n_folds</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">model_idx</span><span class="p">,</span> <span class="n">model</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_models</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">train_idx</span><span class="p">,</span> <span class="n">val_idx</span> <span class="ow">in</span> <span class="n">tscv</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">X_arr</span><span class="p">):</span>
                <span class="n">cloned</span> <span class="o">=</span> <span class="n">clone</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
                <span class="n">cloned</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_arr</span><span class="p">[</span><span class="n">train_idx</span><span class="p">],</span> <span class="n">y_arr</span><span class="p">[</span><span class="n">train_idx</span><span class="p">])</span>

                <span class="c1"># Store probability for positive class</span>
                <span class="n">meta_features</span><span class="p">[</span><span class="n">val_idx</span><span class="p">,</span> <span class="n">model_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">cloned</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_arr</span><span class="p">[</span><span class="n">val_idx</span><span class="p">])[:,</span> <span class="mi">1</span><span class="p">]</span>

        <span class="c1"># Train meta-model on stacked predictions</span>
        <span class="c1"># Use only samples that have meta predictions (after first fold)</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">meta_features</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meta_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">meta_features</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span> <span class="n">y_arr</span><span class="p">[</span><span class="n">mask</span><span class="p">])</span>

        <span class="c1"># Refit base models on full data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fitted_base_models</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_models</span><span class="p">:</span>
            <span class="n">fitted</span> <span class="o">=</span> <span class="n">clone</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
            <span class="n">fitted</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_arr</span><span class="p">,</span> <span class="n">y_arr</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fitted_base_models</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fitted</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">_get_meta_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Generate meta features from base model predictions.&quot;&quot;&quot;</span>
        <span class="n">X_arr</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">values</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="k">else</span> <span class="n">X</span>
        <span class="n">meta_features</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">([</span>
            <span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_arr</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitted_base_models</span>
        <span class="p">])</span>
        <span class="k">return</span> <span class="n">meta_features</span>

    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Predict class labels.&quot;&quot;&quot;</span>
        <span class="n">meta_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_meta_features</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">meta_features</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">predict_proba</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Predict class probabilities.&quot;&quot;&quot;</span>
        <span class="n">meta_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_meta_features</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta_model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">meta_features</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_base_contributions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get predictions from each base model.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_get_meta_features</span><span class="p">(</span><span class="n">X</span><span class="p">),</span>
            <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;model_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fitted_base_models</span><span class="p">))]</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">score</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate accuracy.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">accuracy_score</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">))</span>
</code></pre></div>


</details></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 5.6: Model Selection Framework (Open-ended)</span>
<span class="c1">#</span>
<span class="c1"># Build a TreeModelSelector class that:</span>
<span class="c1"># - Automatically trains and compares multiple tree-based models</span>
<span class="c1"># - Uses proper time series cross-validation</span>
<span class="c1"># - Tracks training time, accuracy, and feature importance</span>
<span class="c1"># - Generates a comparison report</span>
<span class="c1"># - Recommends the best model based on test performance</span>
<span class="c1"># - Provides a plot comparing all models</span>
<span class="c1">#</span>
<span class="c1"># Your implementation:</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 5.6</summary>


<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">time</span>

<span class="k">class</span> <span class="nc">TreeModelSelector</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Automated tree-based model selection.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">models</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">best_model</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">best_model_name</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_get_default_models</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get default set of tree-based models.&quot;&quot;&quot;</span>
        <span class="n">models</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;DecisionTree&#39;</span><span class="p">:</span> <span class="n">DecisionTreeClassifier</span><span class="p">(</span><span class="n">max_depth</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">),</span>
            <span class="s1">&#39;RandomForest&#39;</span><span class="p">:</span> <span class="n">RandomForestClassifier</span><span class="p">(</span>
                <span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span>
            <span class="p">),</span>
            <span class="s1">&#39;GradientBoosting&#39;</span><span class="p">:</span> <span class="n">GradientBoostingClassifier</span><span class="p">(</span>
                <span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span>
            <span class="p">)</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="n">HAS_XGBOOST</span><span class="p">:</span>
            <span class="n">models</span><span class="p">[</span><span class="s1">&#39;XGBoost&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xgb</span><span class="o">.</span><span class="n">XGBClassifier</span><span class="p">(</span>
                <span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span>
                <span class="n">use_label_encoder</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">eval_metric</span><span class="o">=</span><span class="s1">&#39;logloss&#39;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">HAS_LIGHTGBM</span><span class="p">:</span>
            <span class="n">models</span><span class="p">[</span><span class="s1">&#39;LightGBM&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lgb</span><span class="o">.</span><span class="n">LGBMClassifier</span><span class="p">(</span>
                <span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=-</span><span class="mi">1</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">models</span>

    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X_train</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">y_train</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span>
            <span class="n">X_test</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">y_test</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span>
            <span class="n">custom_models</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Train and evaluate all models.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">models</span> <span class="o">=</span> <span class="n">custom_models</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_default_models</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_names</span> <span class="o">=</span> <span class="n">X_train</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">model</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Training </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>

            <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
            <span class="n">train_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>

            <span class="n">train_acc</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
            <span class="n">test_acc</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>

            <span class="c1"># Get feature importance</span>
            <span class="n">importance</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
                <span class="s1">&#39;feature&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_names</span><span class="p">,</span>
                <span class="s1">&#39;importance&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">feature_importances_</span>
            <span class="p">})</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;importance&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;model&#39;</span><span class="p">:</span> <span class="n">model</span><span class="p">,</span>
                <span class="s1">&#39;train_accuracy&#39;</span><span class="p">:</span> <span class="n">train_acc</span><span class="p">,</span>
                <span class="s1">&#39;test_accuracy&#39;</span><span class="p">:</span> <span class="n">test_acc</span><span class="p">,</span>
                <span class="s1">&#39;overfit_gap&#39;</span><span class="p">:</span> <span class="n">train_acc</span> <span class="o">-</span> <span class="n">test_acc</span><span class="p">,</span>
                <span class="s1">&#39;train_time&#39;</span><span class="p">:</span> <span class="n">train_time</span><span class="p">,</span>
                <span class="s1">&#39;feature_importance&#39;</span><span class="p">:</span> <span class="n">importance</span>
            <span class="p">}</span>

        <span class="c1"># Find best model by test accuracy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">best_model_name</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span>
            <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="s1">&#39;test_accuracy&#39;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">best_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">best_model_name</span><span class="p">][</span><span class="s1">&#39;model&#39;</span><span class="p">]</span>

        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">get_comparison_report</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Generate comparison DataFrame.&quot;&quot;&quot;</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;Model&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                <span class="s1">&#39;Train Acc&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;train_accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="s1">&#39;Test Acc&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;test_accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="s1">&#39;Overfit Gap&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;overfit_gap&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="s1">&#39;Train Time (s)&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;train_time&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">})</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;Test Acc&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">plot_comparison</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Plot model comparison.&quot;&quot;&quot;</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

        <span class="c1"># Accuracy comparison</span>
        <span class="n">models</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">train_accs</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">m</span><span class="p">][</span><span class="s1">&#39;train_accuracy&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">models</span><span class="p">]</span>
        <span class="n">test_accs</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">m</span><span class="p">][</span><span class="s1">&#39;test_accuracy&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">models</span><span class="p">]</span>

        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">models</span><span class="p">))</span>
        <span class="n">width</span> <span class="o">=</span> <span class="mf">0.35</span>

        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">train_accs</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Train&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">test_accs</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Test&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Accuracy&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">models</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Train vs Test Accuracy&#39;</span><span class="p">)</span>

        <span class="c1"># Training time</span>
        <span class="n">times</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">m</span><span class="p">][</span><span class="s1">&#39;train_time&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">models</span><span class="p">]</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">models</span><span class="p">,</span> <span class="n">times</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Training Time (seconds)&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">models</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Training Time&#39;</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">recommend</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Return recommendation string.&quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">best_model_name</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Recommended: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">best_model_name</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;  Test Accuracy: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;test_accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;  Overfit Gap: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;overfit_gap&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;  Top Features: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;feature_importance&#39;</span><span class="p">][</span><span class="s1">&#39;feature&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell module-project"><hr />
<h2>Module Project: Complete Tree-Based Trading Signal System</h2>
<p>Build a comprehensive system that uses tree-based models for trading signal generation.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">TreeBasedTradingSystem</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Complete trading signal system using tree-based models.</span>
<span class="sd">    </span>
<span class="sd">    Features:</span>
<span class="sd">    - Multiple model support (RF, XGBoost, LightGBM)</span>
<span class="sd">    - Ensemble predictions</span>
<span class="sd">    - Feature importance analysis</span>
<span class="sd">    - Signal generation with confidence</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;ensemble&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize trading system.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            model_type: &#39;rf&#39;, &#39;xgb&#39;, &#39;lgb&#39;, or &#39;ensemble&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_type</span> <span class="o">=</span> <span class="n">model_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_names</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
        
    <span class="k">def</span> <span class="nf">create_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Create trading features from OHLCV data.&quot;&quot;&quot;</span>
        <span class="n">features</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        
        <span class="c1"># Price features</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;returns&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;volatility&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;returns&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
        
        <span class="c1"># Momentum</span>
        <span class="k">for</span> <span class="n">period</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">]:</span>
            <span class="n">features</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;momentum_</span><span class="si">{</span><span class="n">period</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">(</span><span class="n">period</span><span class="p">)</span>
        
        <span class="c1"># Moving average distances</span>
        <span class="k">for</span> <span class="n">period</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">50</span><span class="p">]:</span>
            <span class="n">ma</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">period</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="n">features</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;dist_ma</span><span class="si">{</span><span class="n">period</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">ma</span><span class="p">)</span> <span class="o">/</span> <span class="n">ma</span>
        
        <span class="c1"># RSI</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span>
        <span class="n">gain</span> <span class="o">=</span> <span class="p">(</span><span class="n">delta</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">delta</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">14</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">delta</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">delta</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">14</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">rs</span> <span class="o">=</span> <span class="n">gain</span> <span class="o">/</span> <span class="n">loss</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;rsi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">-</span> <span class="p">(</span><span class="mi">100</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">rs</span><span class="p">))</span>
        
        <span class="c1"># Bollinger Band position</span>
        <span class="n">ma20</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">std20</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;bb_position&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">ma20</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">std20</span><span class="p">)</span>
        
        <span class="c1"># Volume features</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;volume_ratio&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Volume&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Volume&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        
        <span class="k">return</span> <span class="n">features</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">_create_model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create model based on type.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;rf&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">RandomForestClassifier</span><span class="p">(</span>
                <span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">min_samples_leaf</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;xgb&#39;</span> <span class="ow">and</span> <span class="n">HAS_XGBOOST</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">xgb</span><span class="o">.</span><span class="n">XGBClassifier</span><span class="p">(</span>
                <span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
                <span class="n">min_child_weight</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span>
                <span class="n">use_label_encoder</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">eval_metric</span><span class="o">=</span><span class="s1">&#39;logloss&#39;</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;lgb&#39;</span> <span class="ow">and</span> <span class="n">HAS_LIGHTGBM</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">lgb</span><span class="o">.</span><span class="n">LGBMClassifier</span><span class="p">(</span>
                <span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
                <span class="n">min_child_samples</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=-</span><span class="mi">1</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;ensemble&#39;</span><span class="p">:</span>
            <span class="n">estimators</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">(</span><span class="s1">&#39;rf&#39;</span><span class="p">,</span> <span class="n">RandomForestClassifier</span><span class="p">(</span>
                    <span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span>
                <span class="p">)),</span>
                <span class="p">(</span><span class="s1">&#39;gbc&#39;</span><span class="p">,</span> <span class="n">GradientBoostingClassifier</span><span class="p">(</span>
                    <span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span>
                <span class="p">))</span>
            <span class="p">]</span>
            <span class="k">if</span> <span class="n">HAS_XGBOOST</span><span class="p">:</span>
                <span class="n">estimators</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;xgb&#39;</span><span class="p">,</span> <span class="n">xgb</span><span class="o">.</span><span class="n">XGBClassifier</span><span class="p">(</span>
                    <span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span>
                    <span class="n">use_label_encoder</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">eval_metric</span><span class="o">=</span><span class="s1">&#39;logloss&#39;</span>
                <span class="p">)))</span>
            <span class="k">return</span> <span class="n">VotingClassifier</span><span class="p">(</span><span class="n">estimators</span><span class="o">=</span><span class="n">estimators</span><span class="p">,</span> <span class="n">voting</span><span class="o">=</span><span class="s1">&#39;soft&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">RandomForestClassifier</span><span class="p">(</span>
                <span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span>
            <span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">test_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fit the trading system.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            df: OHLCV DataFrame</span>
<span class="sd">            test_size: Fraction for testing</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Create features</span>
        <span class="n">features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_features</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        
        <span class="c1"># Align with original data and create target</span>
        <span class="n">aligned_df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">features</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
        <span class="n">target</span> <span class="o">=</span> <span class="p">(</span><span class="n">aligned_df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        
        <span class="c1"># Remove last row (no target)</span>
        <span class="n">features</span> <span class="o">=</span> <span class="n">features</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">target</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_names</span> <span class="o">=</span> <span class="n">features</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        
        <span class="c1"># Split</span>
        <span class="n">split_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">features</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">test_size</span><span class="p">))</span>
        <span class="n">X_train</span> <span class="o">=</span> <span class="n">features</span><span class="p">[:</span><span class="n">split_idx</span><span class="p">]</span>
        <span class="n">X_test</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="n">split_idx</span><span class="p">:]</span>
        <span class="n">y_train</span> <span class="o">=</span> <span class="n">target</span><span class="p">[:</span><span class="n">split_idx</span><span class="p">]</span>
        <span class="n">y_test</span> <span class="o">=</span> <span class="n">target</span><span class="p">[</span><span class="n">split_idx</span><span class="p">:]</span>
        
        <span class="c1"># Scale features</span>
        <span class="n">X_train_scaled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
        <span class="n">X_test_scaled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
        
        <span class="c1"># Train model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_model</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_scaled</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
        
        <span class="c1"># Evaluate</span>
        <span class="n">train_acc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_train_scaled</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
        <span class="n">test_acc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_test_scaled</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Training Complete (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model_type</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Train Accuracy: </span><span class="si">{</span><span class="n">train_acc</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Test Accuracy:  </span><span class="si">{</span><span class="n">test_acc</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="bp">self</span>
    
    <span class="k">def</span> <span class="nf">predict_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate trading signals with confidence.</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            DataFrame with signal and confidence</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_features</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="n">X_scaled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>
        
        <span class="c1"># Get predictions and probabilities</span>
        <span class="n">predictions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_scaled</span><span class="p">)</span>
        <span class="n">probabilities</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_scaled</span><span class="p">)</span>
        
        <span class="c1"># Create signals DataFrame</span>
        <span class="n">signals</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">features</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="n">signals</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">predictions</span>
        <span class="n">signals</span><span class="p">[</span><span class="s1">&#39;confidence&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">probabilities</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">signals</span><span class="p">[</span><span class="s1">&#39;signal_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">signals</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">({</span><span class="mi">0</span><span class="p">:</span> <span class="s1">&#39;SELL&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="s1">&#39;BUY&#39;</span><span class="p">})</span>
        
        <span class="k">return</span> <span class="n">signals</span>
    
    <span class="k">def</span> <span class="nf">get_feature_importance</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get feature importance (works for non-ensemble models).&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;feature_importances_&#39;</span><span class="p">):</span>
            <span class="n">importance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">feature_importances_</span>
        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;estimators_&#39;</span><span class="p">):</span>
            <span class="c1"># For VotingClassifier, average importance from tree-based estimators</span>
            <span class="n">importances</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">est</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">named_estimators_</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">est</span><span class="p">,</span> <span class="s1">&#39;feature_importances_&#39;</span><span class="p">):</span>
                    <span class="n">importances</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">est</span><span class="o">.</span><span class="n">feature_importances_</span><span class="p">)</span>
            <span class="n">importance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">importances</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
            <span class="s1">&#39;feature&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_names</span><span class="p">,</span>
            <span class="s1">&#39;importance&#39;</span><span class="p">:</span> <span class="n">importance</span>
        <span class="p">})</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;importance&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">backtest_signals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Simple backtest of trading signals.&quot;&quot;&quot;</span>
        <span class="n">signals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict_signal</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        
        <span class="c1"># Align returns</span>
        <span class="n">returns</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">aligned_returns</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">signals</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
        
        <span class="c1"># Strategy returns</span>
        <span class="n">signals</span><span class="p">[</span><span class="s1">&#39;next_return&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">aligned_returns</span>
        <span class="n">signals</span><span class="p">[</span><span class="s1">&#39;strategy_return&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">signals</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">signals</span><span class="p">[</span><span class="s1">&#39;next_return&#39;</span><span class="p">]</span>
        
        <span class="c1"># Cumulative returns</span>
        <span class="n">signals</span><span class="p">[</span><span class="s1">&#39;cumulative_strategy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">signals</span><span class="p">[</span><span class="s1">&#39;strategy_return&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span>
        <span class="n">signals</span><span class="p">[</span><span class="s1">&#39;cumulative_bh&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">signals</span><span class="p">[</span><span class="s1">&#39;next_return&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span>
        
        <span class="k">return</span> <span class="n">signals</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Test the complete system</span>

<span class="c1"># Fetch data</span>
<span class="n">ticker</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">Ticker</span><span class="p">(</span><span class="s2">&quot;SPY&quot;</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">ticker</span><span class="o">.</span><span class="n">history</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="s2">&quot;2y&quot;</span><span class="p">)</span>

<span class="c1"># Create and train system</span>
<span class="n">trading_system</span> <span class="o">=</span> <span class="n">TreeBasedTradingSystem</span><span class="p">(</span><span class="n">model_type</span><span class="o">=</span><span class="s1">&#39;ensemble&#39;</span><span class="p">)</span>
<span class="n">trading_system</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

<span class="c1"># Get feature importance</span>
<span class="n">importance</span> <span class="o">=</span> <span class="n">trading_system</span><span class="o">.</span><span class="n">get_feature_importance</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Top Features:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">importance</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Generate signals and backtest</span>

<span class="n">backtest_results</span> <span class="o">=</span> <span class="n">trading_system</span><span class="o">.</span><span class="n">backtest_signals</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

<span class="c1"># Plot cumulative returns</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">backtest_results</span><span class="p">[</span><span class="s1">&#39;cumulative_strategy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">(),</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Strategy&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">backtest_results</span><span class="p">[</span><span class="s1">&#39;cumulative_bh&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">(),</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Buy &amp; Hold&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Cumulative Return&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Tree-Based Trading Strategy Performance&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Calculate metrics</span>
<span class="n">strategy_return</span> <span class="o">=</span> <span class="n">backtest_results</span><span class="p">[</span><span class="s1">&#39;cumulative_strategy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
<span class="n">bh_return</span> <span class="o">=</span> <span class="n">backtest_results</span><span class="p">[</span><span class="s1">&#39;cumulative_bh&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Performance Summary:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Strategy Return: </span><span class="si">{</span><span class="n">strategy_return</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Buy &amp; Hold Return: </span><span class="si">{</span><span class="n">bh_return</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Outperformance: </span><span class="si">{</span><span class="n">strategy_return</span> <span class="o">-</span> <span class="n">bh_return</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell key-takeaways"><hr />
<h2>Key Takeaways</h2>
<ol>
<li>
<p><strong>Decision Trees</strong> are interpretable but prone to overfitting; limit depth and use regularization</p>
</li>
<li>
<p><strong>Random Forest</strong> reduces variance through bagging and feature randomization; a solid baseline for financial ML</p>
</li>
<li>
<p><strong>XGBoost</strong> offers regularization and speed improvements; excellent for structured data</p>
</li>
<li>
<p><strong>LightGBM</strong> is faster with histogram-based learning; watch for overfitting with leaf-wise growth</p>
</li>
<li>
<p><strong>Ensemble methods</strong> (voting, stacking) often outperform single models by combining diverse predictions</p>
</li>
<li>
<p><strong>Feature importance</strong> helps understand what drives predictions and can guide feature engineering</p>
</li>
<li>
<p><strong>Always use time series cross-validation</strong> for financial data to prevent lookahead bias</p>
</li>
</ol>
<hr />
<p><strong>Next: Module 6 - Other Classification Models</strong> (Logistic Regression, SVM, Neural Networks)</p></div>
        <div class="nav-buttons">
            <button class="nav-btn prev-btn disabled" type="button">
                <span class="nav-btn-label">‚Üê Previous</span>
                <span class="nav-btn-name"></span>
            </button>
            <button class="nav-btn next-btn disabled" type="button">
                <span class="nav-btn-label">Next ‚Üí</span>
                <span class="nav-btn-name"></span>
            </button>
        </div>
        </div>
<div class="module-section" data-idx="6"><div class="md-cell module-header"><h1>Module 6: Other Classification Models</h1>
<h2>Part 2: Classification Models</h2>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Duration</th>
<th>Exercises</th>
<th>Prerequisites</th>
</tr>
</thead>
<tbody>
<tr>
<td>~2.5 hours</td>
<td>6</td>
<td>Modules 1-5</td>
</tr>
</tbody>
</table></div>
<h3>Learning Objectives</h3>
<p>By the end of this module, you will be able to:
- Apply logistic regression for probabilistic trading signals
- Use Support Vector Machines for classification
- Build neural network classifiers with sklearn and keras
- Understand when to use each model type
- Compare model performance on financial data</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>

<span class="c1"># Scikit-learn models</span>
<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LogisticRegression</span>
<span class="kn">from</span> <span class="nn">sklearn.svm</span> <span class="kn">import</span> <span class="n">SVC</span>
<span class="kn">from</span> <span class="nn">sklearn.neural_network</span> <span class="kn">import</span> <span class="n">MLPClassifier</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">StandardScaler</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">TimeSeriesSplit</span><span class="p">,</span> <span class="n">cross_val_score</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">accuracy_score</span><span class="p">,</span> <span class="n">classification_report</span><span class="p">,</span> <span class="n">confusion_matrix</span>
<span class="kn">from</span> <span class="nn">sklearn.pipeline</span> <span class="kn">import</span> <span class="n">Pipeline</span>

<span class="kn">import</span> <span class="nn">yfinance</span> <span class="k">as</span> <span class="nn">yf</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Module 6: Other Classification Models&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">40</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Prepare data for classification</span>

<span class="k">def</span> <span class="nf">prepare_classification_data</span><span class="p">(</span><span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;SPY&quot;</span><span class="p">,</span> <span class="n">period</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;2y&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;Prepare features and target for classification.&quot;&quot;&quot;</span>
    
    <span class="n">ticker</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">Ticker</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">ticker</span><span class="o">.</span><span class="n">history</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="n">period</span><span class="p">)</span>
    
    <span class="c1"># Features</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;returns&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;volatility&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;returns&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;momentum_5&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;momentum_20&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
    
    <span class="c1"># Moving averages</span>
    <span class="k">for</span> <span class="n">period</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">50</span><span class="p">]:</span>
        <span class="n">ma</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">period</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;dist_ma</span><span class="si">{</span><span class="n">period</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">ma</span><span class="p">)</span> <span class="o">/</span> <span class="n">ma</span>
    
    <span class="c1"># RSI</span>
    <span class="n">delta</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span>
    <span class="n">gain</span> <span class="o">=</span> <span class="p">(</span><span class="n">delta</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">delta</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">14</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">delta</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">delta</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">14</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">rs</span> <span class="o">=</span> <span class="n">gain</span> <span class="o">/</span> <span class="n">loss</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;rsi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">-</span> <span class="p">(</span><span class="mi">100</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">rs</span><span class="p">))</span>
    
    <span class="c1"># Volume</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;volume_ratio&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Volume&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Volume&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    
    <span class="c1"># Target</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;returns&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
    
    <span class="n">features</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;volatility&#39;</span><span class="p">,</span> <span class="s1">&#39;momentum_5&#39;</span><span class="p">,</span> <span class="s1">&#39;momentum_20&#39;</span><span class="p">,</span> <span class="s1">&#39;dist_ma5&#39;</span><span class="p">,</span>
                <span class="s1">&#39;dist_ma20&#39;</span><span class="p">,</span> <span class="s1">&#39;dist_ma50&#39;</span><span class="p">,</span> <span class="s1">&#39;rsi&#39;</span><span class="p">,</span> <span class="s1">&#39;volume_ratio&#39;</span><span class="p">]</span>
    
    <span class="k">return</span> <span class="n">df</span><span class="p">[</span><span class="n">features</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span>

<span class="c1"># Load data</span>
<span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">prepare_classification_data</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Data shape: </span><span class="si">{</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Target distribution: </span><span class="si">{</span><span class="n">y</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Train/test split (time series)</span>
<span class="n">split_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.8</span><span class="p">)</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span> <span class="o">=</span> <span class="n">X</span><span class="p">[:</span><span class="n">split_idx</span><span class="p">],</span> <span class="n">X</span><span class="p">[</span><span class="n">split_idx</span><span class="p">:]</span>
<span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">y</span><span class="p">[:</span><span class="n">split_idx</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">split_idx</span><span class="p">:]</span>

<span class="c1"># Scale features</span>
<span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
<span class="n">X_train_scaled</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
<span class="n">X_test_scaled</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><hr />
<h2>Section 1: Logistic Regression</h2>
<p>Logistic regression is a linear model for classification that outputs probabilities. Despite its simplicity, it often works well for financial data.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Logistic Regression Concepts</span>

<span class="n">logreg_concepts</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">LOGISTIC REGRESSION</span>
<span class="s2">===================</span>

<span class="s2">How It Works:</span>
<span class="s2">-------------</span>
<span class="s2">1. Compute linear combination: z = w0 + w1*x1 + w2*x2 + ...</span>
<span class="s2">2. Apply sigmoid function: P(y=1) = 1 / (1 + e^(-z))</span>
<span class="s2">3. Classify: y = 1 if P(y=1) &gt; threshold else 0</span>

<span class="s2">Sigmoid Function:</span>
<span class="s2">-----------------</span>
<span class="s2">           1.0 ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</span>
<span class="s2">               ‚îÇ              ‚ï±</span>
<span class="s2">           0.5 ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ï≥</span>
<span class="s2">               ‚îÇ        ‚ï±</span>
<span class="s2">           0.0 ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</span>
<span class="s2">              -5    0    5</span>

<span class="s2">Key Features:</span>
<span class="s2">-------------</span>
<span class="s2">- Outputs probabilities (interpretable)</span>
<span class="s2">- Coefficients indicate feature importance and direction</span>
<span class="s2">- Can be regularized (L1/L2) to prevent overfitting</span>
<span class="s2">- Fast to train and predict</span>

<span class="s2">Regularization:</span>
<span class="s2">---------------</span>
<span class="s2">- L1 (Lasso): penalty=&#39;l1&#39;, leads to sparse coefficients</span>
<span class="s2">- L2 (Ridge): penalty=&#39;l2&#39;, shrinks coefficients (default)</span>
<span class="s2">- C parameter: Inverse of regularization strength (smaller = more regularization)</span>

<span class="s2">Advantages for Finance:</span>
<span class="s2">-----------------------</span>
<span class="s2">+ Probabilistic output (good for position sizing)</span>
<span class="s2">+ Interpretable coefficients</span>
<span class="s2">+ Fast and simple</span>
<span class="s2">+ Regularization handles multicollinearity</span>

<span class="s2">Limitations:</span>
<span class="s2">------------</span>
<span class="s2">- Assumes linear decision boundary</span>
<span class="s2">- May underfit complex patterns</span>
<span class="s2">- Sensitive to outliers</span>
<span class="s2">&quot;&quot;&quot;</span>
<span class="nb">print</span><span class="p">(</span><span class="n">logreg_concepts</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Basic Logistic Regression</span>

<span class="n">logreg</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">(</span>
    <span class="n">penalty</span><span class="o">=</span><span class="s1">&#39;l2&#39;</span><span class="p">,</span>       <span class="c1"># L2 regularization</span>
    <span class="n">C</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>              <span class="c1"># Regularization strength</span>
    <span class="n">solver</span><span class="o">=</span><span class="s1">&#39;lbfgs&#39;</span><span class="p">,</span>     <span class="c1"># Optimization algorithm</span>
    <span class="n">max_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
    <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span>
<span class="p">)</span>

<span class="n">logreg</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_scaled</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

<span class="c1"># Evaluate</span>
<span class="n">train_acc</span> <span class="o">=</span> <span class="n">logreg</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_train_scaled</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="n">test_acc</span> <span class="o">=</span> <span class="n">logreg</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_test_scaled</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Logistic Regression Results:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Train Accuracy: </span><span class="si">{</span><span class="n">train_acc</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Test Accuracy:  </span><span class="si">{</span><span class="n">test_acc</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Analyze coefficients</span>

<span class="n">coef_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s1">&#39;feature&#39;</span><span class="p">:</span> <span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span>
    <span class="s1">&#39;coefficient&#39;</span><span class="p">:</span> <span class="n">logreg</span><span class="o">.</span><span class="n">coef_</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
    <span class="s1">&#39;abs_coefficient&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">logreg</span><span class="o">.</span><span class="n">coef_</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="p">})</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;abs_coefficient&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Feature Coefficients:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;(Positive = increases probability of UP, Negative = decreases)&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">coef_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
    <span class="n">direction</span> <span class="o">=</span> <span class="s2">&quot;‚Üë&quot;</span> <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;coefficient&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;‚Üì&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">direction</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;feature&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">15s</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;coefficient&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">+.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Intercept: </span><span class="si">{</span><span class="n">logreg</span><span class="o">.</span><span class="n">intercept_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Visualize coefficients</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;green&#39;</span> <span class="k">if</span> <span class="n">c</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;red&#39;</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">coef_df</span><span class="p">[</span><span class="s1">&#39;coefficient&#39;</span><span class="p">]]</span>
<span class="n">plt</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="n">coef_df</span><span class="p">[</span><span class="s1">&#39;feature&#39;</span><span class="p">],</span> <span class="n">coef_df</span><span class="p">[</span><span class="s1">&#39;coefficient&#39;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Coefficient Value&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Logistic Regression Coefficients&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Probability predictions</span>

<span class="n">probabilities</span> <span class="o">=</span> <span class="n">logreg</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test_scaled</span><span class="p">)</span>

<span class="c1"># Show distribution of probabilities</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">probabilities</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Decision Boundary&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;P(UP)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Frequency&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Distribution of Predicted Probabilities&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="c1"># Separate by actual class</span>
<span class="n">prob_up</span> <span class="o">=</span> <span class="n">probabilities</span><span class="p">[</span><span class="n">y_test</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
<span class="n">prob_down</span> <span class="o">=</span> <span class="n">probabilities</span><span class="p">[</span><span class="n">y_test</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">prob_up</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Actual UP&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">prob_down</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Actual DOWN&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;P(UP)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Frequency&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Probabilities by Actual Class&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 6.1: Regularization Comparison (Guided)</span>

<span class="k">def</span> <span class="nf">compare_regularization</span><span class="p">(</span><span class="n">X_train</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">y_train</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span>
                           <span class="n">X_test</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">y_test</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span>
                           <span class="n">C_values</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.001</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compare logistic regression with different regularization strengths.</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        DataFrame with C value, train accuracy, test accuracy, and coefficient stats</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">for</span> <span class="n">C</span> <span class="ow">in</span> <span class="n">C_values</span><span class="p">:</span>
        <span class="c1"># TODO: Create logistic regression with given C value</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">______</span><span class="p">(</span>
            <span class="n">penalty</span><span class="o">=</span><span class="s1">&#39;l2&#39;</span><span class="p">,</span>
            <span class="n">C</span><span class="o">=</span><span class="n">______</span><span class="p">,</span>
            <span class="n">max_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
            <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span>
        <span class="p">)</span>
        
        <span class="c1"># TODO: Fit the model</span>
        <span class="n">model</span><span class="o">.</span><span class="n">______</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
        
        <span class="c1"># TODO: Get train and test accuracy</span>
        <span class="n">train_acc</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">______</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
        <span class="n">test_acc</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">______</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>
        
        <span class="c1"># Coefficient statistics</span>
        <span class="n">coef_sum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">coef_</span><span class="p">))</span>
        
        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;C&#39;</span><span class="p">:</span> <span class="n">C</span><span class="p">,</span>
            <span class="s1">&#39;train_accuracy&#39;</span><span class="p">:</span> <span class="n">train_acc</span><span class="p">,</span>
            <span class="s1">&#39;test_accuracy&#39;</span><span class="p">:</span> <span class="n">test_acc</span><span class="p">,</span>
            <span class="s1">&#39;coef_sum&#39;</span><span class="p">:</span> <span class="n">coef_sum</span>
        <span class="p">})</span>
    
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>

<span class="c1"># Test the function</span>
<span class="c1"># reg_results = compare_regularization(X_train_scaled, y_train, X_test_scaled, y_test)</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 6.1</summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">compare_regularization</span><span class="p">(</span><span class="n">X_train</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">y_train</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span>
                           <span class="n">X_test</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">y_test</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span>
                           <span class="n">C_values</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.001</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compare logistic regression with different regularization strengths.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">C</span> <span class="ow">in</span> <span class="n">C_values</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">(</span>
            <span class="n">penalty</span><span class="o">=</span><span class="s1">&#39;l2&#39;</span><span class="p">,</span>
            <span class="n">C</span><span class="o">=</span><span class="n">C</span><span class="p">,</span>
            <span class="n">max_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
            <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span>
        <span class="p">)</span>

        <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

        <span class="n">train_acc</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
        <span class="n">test_acc</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>

        <span class="n">coef_sum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">coef_</span><span class="p">))</span>

        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;C&#39;</span><span class="p">:</span> <span class="n">C</span><span class="p">,</span>
            <span class="s1">&#39;train_accuracy&#39;</span><span class="p">:</span> <span class="n">train_acc</span><span class="p">,</span>
            <span class="s1">&#39;test_accuracy&#39;</span><span class="p">:</span> <span class="n">test_acc</span><span class="p">,</span>
            <span class="s1">&#39;coef_sum&#39;</span><span class="p">:</span> <span class="n">coef_sum</span>
        <span class="p">})</span>

    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h2>Section 2: Support Vector Machines (SVM)</h2>
<p>SVMs find the optimal hyperplane that separates classes with maximum margin.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># SVM Concepts</span>

<span class="n">svm_concepts</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">SUPPORT VECTOR MACHINES</span>
<span class="s2">=======================</span>

<span class="s2">Key Concepts:</span>
<span class="s2">-------------</span>
<span class="s2">1. Maximum Margin Classifier</span>
<span class="s2">   - Finds hyperplane that maximizes distance to nearest points</span>
<span class="s2">   - Support vectors: Points closest to the decision boundary</span>

<span class="s2">2. Kernel Trick</span>
<span class="s2">   - Maps data to higher dimension for non-linear separation</span>
<span class="s2">   - Common kernels: linear, poly, rbf (Gaussian), sigmoid</span>

<span class="s2">Visualization (2D):</span>
<span class="s2">-------------------</span>
<span class="s2">                 ‚óã  ‚óã           ‚Üê Class 1</span>
<span class="s2">              ‚óã  ‚óã</span>
<span class="s2">           ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ    ‚Üê Decision boundary</span>
<span class="s2">         ‚óè  ‚óè</span>
<span class="s2">           ‚óè  ‚óè  ‚óè              ‚Üê Class 0</span>

<span class="s2">Key Parameters:</span>
<span class="s2">---------------</span>
<span class="s2">- C: Regularization (higher = less regularization)</span>
<span class="s2">- kernel: &#39;linear&#39;, &#39;rbf&#39;, &#39;poly&#39;, &#39;sigmoid&#39;</span>
<span class="s2">- gamma: Kernel coefficient for &#39;rbf&#39; (higher = more complex)</span>

<span class="s2">Advantages:</span>
<span class="s2">-----------</span>
<span class="s2">+ Effective in high dimensions</span>
<span class="s2">+ Works well with clear margins</span>
<span class="s2">+ Versatile with different kernels</span>

<span class="s2">Disadvantages:</span>
<span class="s2">--------------</span>
<span class="s2">- Slow for large datasets</span>
<span class="s2">- Sensitive to feature scaling</span>
<span class="s2">- Probability estimates can be unreliable</span>
<span class="s2">- Memory intensive</span>
<span class="s2">&quot;&quot;&quot;</span>
<span class="nb">print</span><span class="p">(</span><span class="n">svm_concepts</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Linear SVM</span>

<span class="n">svm_linear</span> <span class="o">=</span> <span class="n">SVC</span><span class="p">(</span>
    <span class="n">kernel</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span>
    <span class="n">C</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
    <span class="n">probability</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># Enable probability estimates</span>
    <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span>
<span class="p">)</span>

<span class="n">svm_linear</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_scaled</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

<span class="n">train_acc</span> <span class="o">=</span> <span class="n">svm_linear</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_train_scaled</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="n">test_acc</span> <span class="o">=</span> <span class="n">svm_linear</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_test_scaled</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Linear SVM Results:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Train Accuracy: </span><span class="si">{</span><span class="n">train_acc</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Test Accuracy:  </span><span class="si">{</span><span class="n">test_acc</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Support Vectors: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">svm_linear</span><span class="o">.</span><span class="n">support_</span><span class="p">)</span><span class="si">}</span><span class="s2"> / </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># RBF (Gaussian) SVM</span>

<span class="n">svm_rbf</span> <span class="o">=</span> <span class="n">SVC</span><span class="p">(</span>
    <span class="n">kernel</span><span class="o">=</span><span class="s1">&#39;rbf&#39;</span><span class="p">,</span>
    <span class="n">C</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
    <span class="n">gamma</span><span class="o">=</span><span class="s1">&#39;scale&#39;</span><span class="p">,</span>  <span class="c1"># 1 / (n_features * X.var())</span>
    <span class="n">probability</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span>
<span class="p">)</span>

<span class="n">svm_rbf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_scaled</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

<span class="n">train_acc</span> <span class="o">=</span> <span class="n">svm_rbf</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_train_scaled</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="n">test_acc</span> <span class="o">=</span> <span class="n">svm_rbf</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_test_scaled</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;RBF SVM Results:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Train Accuracy: </span><span class="si">{</span><span class="n">train_acc</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Test Accuracy:  </span><span class="si">{</span><span class="n">test_acc</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Support Vectors: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">svm_rbf</span><span class="o">.</span><span class="n">support_</span><span class="p">)</span><span class="si">}</span><span class="s2"> / </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Compare different kernels</span>

<span class="n">kernels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="s1">&#39;rbf&#39;</span><span class="p">,</span> <span class="s1">&#39;poly&#39;</span><span class="p">,</span> <span class="s1">&#39;sigmoid&#39;</span><span class="p">]</span>
<span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">kernel</span> <span class="ow">in</span> <span class="n">kernels</span><span class="p">:</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">SVC</span><span class="p">(</span><span class="n">kernel</span><span class="o">=</span><span class="n">kernel</span><span class="p">,</span> <span class="n">C</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">probability</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_scaled</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
    
    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
        <span class="s1">&#39;kernel&#39;</span><span class="p">:</span> <span class="n">kernel</span><span class="p">,</span>
        <span class="s1">&#39;train_acc&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_train_scaled</span><span class="p">,</span> <span class="n">y_train</span><span class="p">),</span>
        <span class="s1">&#39;test_acc&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_test_scaled</span><span class="p">,</span> <span class="n">y_test</span><span class="p">),</span>
        <span class="s1">&#39;n_sv&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">support_</span><span class="p">)</span>
    <span class="p">})</span>

<span class="n">kernel_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Kernel Comparison:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">kernel_df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 6.2: SVM Hyperparameter Tuner (Guided)</span>

<span class="k">def</span> <span class="nf">tune_svm</span><span class="p">(</span><span class="n">X_train</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">y_train</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span>
             <span class="n">C_values</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">],</span>
             <span class="n">gamma_values</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;scale&#39;</span><span class="p">,</span> <span class="s1">&#39;auto&#39;</span><span class="p">],</span>
             <span class="n">cv_folds</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Tune SVM hyperparameters using time series cross-validation.</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        Dictionary with best parameters and all results</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO: Create time series cross-validator</span>
    <span class="n">tscv</span> <span class="o">=</span> <span class="n">______</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="n">cv_folds</span><span class="p">)</span>
    
    <span class="n">best_score</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">best_params</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">all_results</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">for</span> <span class="n">C</span> <span class="ow">in</span> <span class="n">C_values</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">gamma</span> <span class="ow">in</span> <span class="n">gamma_values</span><span class="p">:</span>
            <span class="c1"># TODO: Create SVC with RBF kernel and current parameters</span>
            <span class="n">model</span> <span class="o">=</span> <span class="n">______</span><span class="p">(</span>
                <span class="n">kernel</span><span class="o">=</span><span class="s1">&#39;rbf&#39;</span><span class="p">,</span>
                <span class="n">C</span><span class="o">=</span><span class="n">______</span><span class="p">,</span>
                <span class="n">gamma</span><span class="o">=</span><span class="n">______</span><span class="p">,</span>
                <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span>
            <span class="p">)</span>
            
            <span class="c1"># TODO: Get cross-validation scores</span>
            <span class="n">scores</span> <span class="o">=</span> <span class="n">______</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="n">tscv</span><span class="p">,</span> <span class="n">scoring</span><span class="o">=</span><span class="s1">&#39;accuracy&#39;</span><span class="p">)</span>
            <span class="n">mean_score</span> <span class="o">=</span> <span class="n">scores</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            
            <span class="n">all_results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;C&#39;</span><span class="p">:</span> <span class="n">C</span><span class="p">,</span>
                <span class="s1">&#39;gamma&#39;</span><span class="p">:</span> <span class="n">gamma</span><span class="p">,</span>
                <span class="s1">&#39;mean_score&#39;</span><span class="p">:</span> <span class="n">mean_score</span><span class="p">,</span>
                <span class="s1">&#39;std_score&#39;</span><span class="p">:</span> <span class="n">scores</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
            <span class="p">})</span>
            
            <span class="k">if</span> <span class="n">mean_score</span> <span class="o">&gt;</span> <span class="n">best_score</span><span class="p">:</span>
                <span class="n">best_score</span> <span class="o">=</span> <span class="n">mean_score</span>
                <span class="n">best_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;C&#39;</span><span class="p">:</span> <span class="n">C</span><span class="p">,</span> <span class="s1">&#39;gamma&#39;</span><span class="p">:</span> <span class="n">gamma</span><span class="p">}</span>
    
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;best_params&#39;</span><span class="p">:</span> <span class="n">best_params</span><span class="p">,</span>
        <span class="s1">&#39;best_score&#39;</span><span class="p">:</span> <span class="n">best_score</span><span class="p">,</span>
        <span class="s1">&#39;all_results&#39;</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">all_results</span><span class="p">)</span>
    <span class="p">}</span>

<span class="c1"># Test the function</span>
<span class="c1"># svm_results = tune_svm(X_train_scaled, y_train)</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 6.2</summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">tune_svm</span><span class="p">(</span><span class="n">X_train</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">y_train</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span>
             <span class="n">C_values</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">],</span>
             <span class="n">gamma_values</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;scale&#39;</span><span class="p">,</span> <span class="s1">&#39;auto&#39;</span><span class="p">],</span>
             <span class="n">cv_folds</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Tune SVM hyperparameters using time series cross-validation.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tscv</span> <span class="o">=</span> <span class="n">TimeSeriesSplit</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="n">cv_folds</span><span class="p">)</span>

    <span class="n">best_score</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">best_params</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">all_results</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">C</span> <span class="ow">in</span> <span class="n">C_values</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">gamma</span> <span class="ow">in</span> <span class="n">gamma_values</span><span class="p">:</span>
            <span class="n">model</span> <span class="o">=</span> <span class="n">SVC</span><span class="p">(</span>
                <span class="n">kernel</span><span class="o">=</span><span class="s1">&#39;rbf&#39;</span><span class="p">,</span>
                <span class="n">C</span><span class="o">=</span><span class="n">C</span><span class="p">,</span>
                <span class="n">gamma</span><span class="o">=</span><span class="n">gamma</span><span class="p">,</span>
                <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span>
            <span class="p">)</span>

            <span class="n">scores</span> <span class="o">=</span> <span class="n">cross_val_score</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="n">tscv</span><span class="p">,</span> <span class="n">scoring</span><span class="o">=</span><span class="s1">&#39;accuracy&#39;</span><span class="p">)</span>
            <span class="n">mean_score</span> <span class="o">=</span> <span class="n">scores</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

            <span class="n">all_results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;C&#39;</span><span class="p">:</span> <span class="n">C</span><span class="p">,</span>
                <span class="s1">&#39;gamma&#39;</span><span class="p">:</span> <span class="n">gamma</span><span class="p">,</span>
                <span class="s1">&#39;mean_score&#39;</span><span class="p">:</span> <span class="n">mean_score</span><span class="p">,</span>
                <span class="s1">&#39;std_score&#39;</span><span class="p">:</span> <span class="n">scores</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
            <span class="p">})</span>

            <span class="k">if</span> <span class="n">mean_score</span> <span class="o">&gt;</span> <span class="n">best_score</span><span class="p">:</span>
                <span class="n">best_score</span> <span class="o">=</span> <span class="n">mean_score</span>
                <span class="n">best_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;C&#39;</span><span class="p">:</span> <span class="n">C</span><span class="p">,</span> <span class="s1">&#39;gamma&#39;</span><span class="p">:</span> <span class="n">gamma</span><span class="p">}</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;best_params&#39;</span><span class="p">:</span> <span class="n">best_params</span><span class="p">,</span>
        <span class="s1">&#39;best_score&#39;</span><span class="p">:</span> <span class="n">best_score</span><span class="p">,</span>
        <span class="s1">&#39;all_results&#39;</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">all_results</span><span class="p">)</span>
    <span class="p">}</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h2>Section 3: Neural Networks (MLP)</h2>
<p>Multi-Layer Perceptrons (MLPs) are feedforward neural networks that can learn complex non-linear patterns.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Neural Network Concepts</span>

<span class="n">nn_concepts</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">NEURAL NETWORKS (MLP)</span>
<span class="s2">=====================</span>

<span class="s2">Architecture:</span>
<span class="s2">-------------</span>
<span class="s2">    Input Layer     Hidden Layers      Output Layer</span>
<span class="s2">    </span>
<span class="s2">       (x1) ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚Üí (h1) ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚Üí (h3) ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚Üí (y)</span>
<span class="s2">              ‚îÇ          ‚ï≥           ‚îÇ</span>
<span class="s2">       (x2) ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚Üí (h2) ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚Üí (h4) ‚îÄ‚îÄ‚î§</span>
<span class="s2">              ‚îÇ          ‚îÇ           ‚îÇ</span>
<span class="s2">       (x3) ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚Üí ...  ‚îÄ‚î¥‚îÄ‚îÄ‚Üí ...  ‚îÄ‚îÄ‚îò</span>

<span class="s2">Key Components:</span>
<span class="s2">---------------</span>
<span class="s2">1. Neurons: Apply weights, bias, and activation</span>
<span class="s2">2. Activation Functions: ReLU, tanh, sigmoid, softmax</span>
<span class="s2">3. Backpropagation: Update weights based on error</span>
<span class="s2">4. Optimizer: SGD, Adam, etc.</span>

<span class="s2">Activation Functions:</span>
<span class="s2">---------------------</span>
<span class="s2">- ReLU: max(0, x) - most common for hidden layers</span>
<span class="s2">- Sigmoid: 1/(1+e^-x) - for binary output</span>
<span class="s2">- Softmax: exp(x_i)/sum(exp(x)) - for multi-class</span>
<span class="s2">- Tanh: (e^x - e^-x)/(e^x + e^-x)</span>

<span class="s2">Key Parameters:</span>
<span class="s2">---------------</span>
<span class="s2">- hidden_layer_sizes: Tuple, e.g., (100, 50) for 2 layers</span>
<span class="s2">- activation: &#39;relu&#39;, &#39;tanh&#39;, &#39;logistic&#39;</span>
<span class="s2">- solver: &#39;adam&#39;, &#39;sgd&#39;, &#39;lbfgs&#39;</span>
<span class="s2">- alpha: L2 regularization</span>
<span class="s2">- learning_rate_init: Initial learning rate</span>
<span class="s2">- batch_size: Samples per gradient update</span>

<span class="s2">Advantages:</span>
<span class="s2">-----------</span>
<span class="s2">+ Learns complex non-linear patterns</span>
<span class="s2">+ Universal approximator</span>
<span class="s2">+ Can handle large feature spaces</span>

<span class="s2">Disadvantages:</span>
<span class="s2">--------------</span>
<span class="s2">- Prone to overfitting</span>
<span class="s2">- Requires careful tuning</span>
<span class="s2">- Black box (less interpretable)</span>
<span class="s2">- Needs more data than simpler models</span>
<span class="s2">&quot;&quot;&quot;</span>
<span class="nb">print</span><span class="p">(</span><span class="n">nn_concepts</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Basic MLP Classifier</span>

<span class="n">mlp</span> <span class="o">=</span> <span class="n">MLPClassifier</span><span class="p">(</span>
    <span class="n">hidden_layer_sizes</span><span class="o">=</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">32</span><span class="p">),</span>  <span class="c1"># Two hidden layers</span>
    <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">,</span>
    <span class="n">solver</span><span class="o">=</span><span class="s1">&#39;adam&#39;</span><span class="p">,</span>
    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span>  <span class="c1"># L2 regularization</span>
    <span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span>
    <span class="n">learning_rate_init</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span>
    <span class="n">max_iter</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
    <span class="n">early_stopping</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">validation_fraction</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
    <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span>
<span class="p">)</span>

<span class="n">mlp</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_scaled</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

<span class="n">train_acc</span> <span class="o">=</span> <span class="n">mlp</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_train_scaled</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="n">test_acc</span> <span class="o">=</span> <span class="n">mlp</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_test_scaled</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;MLP Classifier Results:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Train Accuracy: </span><span class="si">{</span><span class="n">train_acc</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Test Accuracy:  </span><span class="si">{</span><span class="n">test_acc</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Iterations: </span><span class="si">{</span><span class="n">mlp</span><span class="o">.</span><span class="n">n_iter_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Final Loss: </span><span class="si">{</span><span class="n">mlp</span><span class="o">.</span><span class="n">loss_</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Training loss curve</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">mlp</span><span class="o">.</span><span class="n">loss_curve_</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Iteration&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Loss&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;MLP Training Loss Curve&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Compare different architectures</span>

<span class="n">architectures</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span><span class="mi">32</span><span class="p">,),</span>           <span class="c1"># Shallow</span>
    <span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">32</span><span class="p">),</span>        <span class="c1"># Two layers</span>
    <span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">32</span><span class="p">),</span>   <span class="c1"># Three layers</span>
    <span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">64</span><span class="p">),</span>  <span class="c1"># Wider</span>
<span class="p">]</span>

<span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">hidden_sizes</span> <span class="ow">in</span> <span class="n">architectures</span><span class="p">:</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">MLPClassifier</span><span class="p">(</span>
        <span class="n">hidden_layer_sizes</span><span class="o">=</span><span class="n">hidden_sizes</span><span class="p">,</span>
        <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">,</span>
        <span class="n">solver</span><span class="o">=</span><span class="s1">&#39;adam&#39;</span><span class="p">,</span>
        <span class="n">alpha</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span>
        <span class="n">max_iter</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
        <span class="n">early_stopping</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span>
    <span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_scaled</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
    
    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
        <span class="s1">&#39;architecture&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">hidden_sizes</span><span class="p">),</span>
        <span class="s1">&#39;train_acc&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_train_scaled</span><span class="p">,</span> <span class="n">y_train</span><span class="p">),</span>
        <span class="s1">&#39;test_acc&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_test_scaled</span><span class="p">,</span> <span class="n">y_test</span><span class="p">),</span>
        <span class="s1">&#39;iterations&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">n_iter_</span>
    <span class="p">})</span>

<span class="n">arch_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Architecture Comparison:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">arch_df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 6.3: Neural Network Builder (Guided)</span>

<span class="k">def</span> <span class="nf">build_nn_classifier</span><span class="p">(</span><span class="n">X_train</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">y_train</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span>
                        <span class="n">hidden_sizes</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">32</span><span class="p">),</span>
                        <span class="n">dropout_rate</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">,</span>
                        <span class="n">learning_rate</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.001</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MLPClassifier</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Build and train a neural network classifier.</span>
<span class="sd">    </span>
<span class="sd">    Note: sklearn&#39;s MLP doesn&#39;t support dropout directly,</span>
<span class="sd">    so we use alpha for regularization instead.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Approximate dropout effect with alpha</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="n">dropout_rate</span> <span class="o">*</span> <span class="mf">0.01</span>
    
    <span class="c1"># TODO: Create MLP classifier with the given parameters</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">______</span><span class="p">(</span>
        <span class="n">hidden_layer_sizes</span><span class="o">=</span><span class="n">______</span><span class="p">,</span>
        <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">,</span>
        <span class="n">solver</span><span class="o">=</span><span class="s1">&#39;adam&#39;</span><span class="p">,</span>
        <span class="n">alpha</span><span class="o">=</span><span class="n">______</span><span class="p">,</span>
        <span class="n">learning_rate_init</span><span class="o">=</span><span class="n">______</span><span class="p">,</span>
        <span class="n">max_iter</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
        <span class="n">early_stopping</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">validation_fraction</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
        <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span>
    <span class="p">)</span>
    
    <span class="c1"># TODO: Fit the model</span>
    <span class="n">model</span><span class="o">.</span><span class="n">______</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">model</span>

<span class="c1"># Test the function</span>
<span class="c1"># nn_model = build_nn_classifier(X_train_scaled, y_train)</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 6.3</summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">build_nn_classifier</span><span class="p">(</span><span class="n">X_train</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">y_train</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span>
                        <span class="n">hidden_sizes</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">32</span><span class="p">),</span>
                        <span class="n">dropout_rate</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">,</span>
                        <span class="n">learning_rate</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.001</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MLPClassifier</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Build and train a neural network classifier.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="n">dropout_rate</span> <span class="o">*</span> <span class="mf">0.01</span>

    <span class="n">model</span> <span class="o">=</span> <span class="n">MLPClassifier</span><span class="p">(</span>
        <span class="n">hidden_layer_sizes</span><span class="o">=</span><span class="n">hidden_sizes</span><span class="p">,</span>
        <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">,</span>
        <span class="n">solver</span><span class="o">=</span><span class="s1">&#39;adam&#39;</span><span class="p">,</span>
        <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span>
        <span class="n">learning_rate_init</span><span class="o">=</span><span class="n">learning_rate</span><span class="p">,</span>
        <span class="n">max_iter</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
        <span class="n">early_stopping</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">validation_fraction</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
        <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span>
    <span class="p">)</span>

    <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">model</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h2>Section 4: Model Comparison</h2>
<p>Systematically compare all classification models on trading data.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Comprehensive model comparison</span>

<span class="k">def</span> <span class="nf">get_all_models</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Get dictionary of all classification models.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;Logistic (L2)&#39;</span><span class="p">:</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">penalty</span><span class="o">=</span><span class="s1">&#39;l2&#39;</span><span class="p">,</span> <span class="n">C</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">),</span>
        <span class="s1">&#39;Logistic (L1)&#39;</span><span class="p">:</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">penalty</span><span class="o">=</span><span class="s1">&#39;l1&#39;</span><span class="p">,</span> <span class="n">C</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">solver</span><span class="o">=</span><span class="s1">&#39;saga&#39;</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">),</span>
        <span class="s1">&#39;SVM (Linear)&#39;</span><span class="p">:</span> <span class="n">SVC</span><span class="p">(</span><span class="n">kernel</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="n">C</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">probability</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">),</span>
        <span class="s1">&#39;SVM (RBF)&#39;</span><span class="p">:</span> <span class="n">SVC</span><span class="p">(</span><span class="n">kernel</span><span class="o">=</span><span class="s1">&#39;rbf&#39;</span><span class="p">,</span> <span class="n">C</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">probability</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">),</span>
        <span class="s1">&#39;MLP (Small)&#39;</span><span class="p">:</span> <span class="n">MLPClassifier</span><span class="p">(</span><span class="n">hidden_layer_sizes</span><span class="o">=</span><span class="p">(</span><span class="mi">32</span><span class="p">,),</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">early_stopping</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">),</span>
        <span class="s1">&#39;MLP (Medium)&#39;</span><span class="p">:</span> <span class="n">MLPClassifier</span><span class="p">(</span><span class="n">hidden_layer_sizes</span><span class="o">=</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">32</span><span class="p">),</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">early_stopping</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">),</span>
    <span class="p">}</span>

<span class="n">models</span> <span class="o">=</span> <span class="n">get_all_models</span><span class="p">()</span>
<span class="n">comparison_results</span> <span class="o">=</span> <span class="p">[]</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Training and evaluating models...</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">models</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_scaled</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
    
    <span class="n">train_acc</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_train_scaled</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
    <span class="n">test_acc</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_test_scaled</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>
    
    <span class="n">comparison_results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
        <span class="s1">&#39;Model&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
        <span class="s1">&#39;Train Acc&#39;</span><span class="p">:</span> <span class="n">train_acc</span><span class="p">,</span>
        <span class="s1">&#39;Test Acc&#39;</span><span class="p">:</span> <span class="n">test_acc</span><span class="p">,</span>
        <span class="s1">&#39;Overfit Gap&#39;</span><span class="p">:</span> <span class="n">train_acc</span> <span class="o">-</span> <span class="n">test_acc</span>
    <span class="p">})</span>

<span class="n">comparison_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">comparison_results</span><span class="p">)</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;Test Acc&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">comparison_df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Visualize comparison</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

<span class="c1"># Accuracy comparison</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">comparison_df</span><span class="p">))</span>
<span class="n">width</span> <span class="o">=</span> <span class="mf">0.35</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">comparison_df</span><span class="p">[</span><span class="s1">&#39;Train Acc&#39;</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Train&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">comparison_df</span><span class="p">[</span><span class="s1">&#39;Test Acc&#39;</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Test&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Accuracy&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">comparison_df</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">],</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Random&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Train vs Test Accuracy&#39;</span><span class="p">)</span>

<span class="c1"># Overfitting comparison</span>
<span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;red&#39;</span> <span class="k">if</span> <span class="n">g</span> <span class="o">&gt;</span> <span class="mf">0.05</span> <span class="k">else</span> <span class="s1">&#39;green&#39;</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">comparison_df</span><span class="p">[</span><span class="s1">&#39;Overfit Gap&#39;</span><span class="p">]]</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">comparison_df</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">],</span> <span class="n">comparison_df</span><span class="p">[</span><span class="s1">&#39;Overfit Gap&#39;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Overfit Gap (Train - Test)&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">comparison_df</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">],</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Overfitting Analysis&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 6.4: Complete Classifier Comparison System (Open-ended)</span>
<span class="c1">#</span>
<span class="c1"># Build a ClassifierCompare class that:</span>
<span class="c1"># - Takes a dictionary of sklearn classifiers</span>
<span class="c1"># - Uses time series cross-validation to evaluate each</span>
<span class="c1"># - Tracks accuracy, precision, recall, and F1 score</span>
<span class="c1"># - Generates a comparison report DataFrame</span>
<span class="c1"># - Provides a plot_comparison() method for visualization</span>
<span class="c1"># - Recommends the best model with reasoning</span>
<span class="c1">#</span>
<span class="c1"># Your implementation:</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 6.4</summary>


<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">precision_score</span><span class="p">,</span> <span class="n">recall_score</span><span class="p">,</span> <span class="n">f1_score</span>

<span class="k">class</span> <span class="nc">ClassifierCompare</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Compare multiple classifiers systematically.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">classifiers</span><span class="p">:</span> <span class="n">Dict</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifiers</span> <span class="o">=</span> <span class="n">classifiers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fitted_models</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X_train</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">y_train</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span>
                 <span class="n">X_test</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">y_test</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span>
                 <span class="n">cv_folds</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Evaluate all classifiers.&quot;&quot;&quot;</span>
        <span class="n">tscv</span> <span class="o">=</span> <span class="n">TimeSeriesSplit</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="n">cv_folds</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">clf</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">classifiers</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Evaluating </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>

            <span class="c1"># Cross-validation</span>
            <span class="n">cv_scores</span> <span class="o">=</span> <span class="n">cross_val_score</span><span class="p">(</span><span class="n">clf</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="n">tscv</span><span class="p">,</span> <span class="n">scoring</span><span class="o">=</span><span class="s1">&#39;accuracy&#39;</span><span class="p">)</span>

            <span class="c1"># Fit on full training set</span>
            <span class="n">clf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fitted_models</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">clf</span>

            <span class="c1"># Predictions</span>
            <span class="n">y_pred</span> <span class="o">=</span> <span class="n">clf</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>

            <span class="c1"># Metrics</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;cv_accuracy_mean&#39;</span><span class="p">:</span> <span class="n">cv_scores</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
                <span class="s1">&#39;cv_accuracy_std&#39;</span><span class="p">:</span> <span class="n">cv_scores</span><span class="o">.</span><span class="n">std</span><span class="p">(),</span>
                <span class="s1">&#39;train_accuracy&#39;</span><span class="p">:</span> <span class="n">clf</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">),</span>
                <span class="s1">&#39;test_accuracy&#39;</span><span class="p">:</span> <span class="n">clf</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">),</span>
                <span class="s1">&#39;precision&#39;</span><span class="p">:</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
                <span class="s1">&#39;recall&#39;</span><span class="p">:</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
                <span class="s1">&#39;f1&#39;</span><span class="p">:</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="p">}</span>

        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">get_report</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Generate comparison report.&quot;&quot;&quot;</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">metrics</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;Model&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                <span class="s1">&#39;CV Acc&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;cv_accuracy_mean&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2"> +/- </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;cv_accuracy_std&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="s1">&#39;Train Acc&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;train_accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="s1">&#39;Test Acc&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;test_accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="s1">&#39;Precision&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="s1">&#39;Recall&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;recall&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="s1">&#39;F1&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">})</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">plot_comparison</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Visualize comparison.&quot;&quot;&quot;</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

        <span class="n">models</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">test_accs</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">m</span><span class="p">][</span><span class="s1">&#39;test_accuracy&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">models</span><span class="p">]</span>
        <span class="n">f1_scores</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">m</span><span class="p">][</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">models</span><span class="p">]</span>

        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">models</span><span class="p">))</span>

        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">test_accs</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;steelblue&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Test Accuracy&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">models</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Test Accuracy Comparison&#39;</span><span class="p">)</span>

        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">f1_scores</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;forestgreen&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;F1 Score&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">models</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;F1 Score Comparison&#39;</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">recommend</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Recommend best model.&quot;&quot;&quot;</span>
        <span class="n">best_name</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span>
                       <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="s1">&#39;test_accuracy&#39;</span><span class="p">])</span>
        <span class="n">best</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">best_name</span><span class="p">]</span>

        <span class="n">overfit</span> <span class="o">=</span> <span class="n">best</span><span class="p">[</span><span class="s1">&#39;train_accuracy&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">best</span><span class="p">[</span><span class="s1">&#39;test_accuracy&#39;</span><span class="p">]</span>

        <span class="n">reasoning</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">best</span><span class="p">[</span><span class="s1">&#39;test_accuracy&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.52</span><span class="p">:</span>
            <span class="n">reasoning</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Shows predictive signal above random&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">overfit</span> <span class="o">&lt;</span> <span class="mf">0.05</span><span class="p">:</span>
            <span class="n">reasoning</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Low overfitting gap&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">best</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">:</span>
            <span class="n">reasoning</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Balanced precision/recall&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;Recommended: </span><span class="si">{</span><span class="n">best_name</span><span class="si">}</span><span class="s2"></span>
<span class="s2">Test Accuracy: </span><span class="si">{</span><span class="n">best</span><span class="p">[</span><span class="s1">&#39;test_accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2"></span>
<span class="s2">F1 Score: </span><span class="si">{</span><span class="n">best</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2"></span>
<span class="s2">Reasoning: </span><span class="si">{</span><span class="s1">&#39;; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">reasoning</span><span class="p">)</span> <span class="k">if</span> <span class="n">reasoning</span> <span class="k">else</span> <span class="s1">&#39;Best among options&#39;</span><span class="si">}</span><span class="s2">&quot;&quot;&quot;</span>
</code></pre></div>


</details></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 6.5: Probability Calibration Analyzer (Open-ended)</span>
<span class="c1">#</span>
<span class="c1"># Build a ProbabilityCalibrator class that:</span>
<span class="c1"># - Takes a fitted classifier with predict_proba</span>
<span class="c1"># - Analyzes calibration using bins (reliability diagram)</span>
<span class="c1"># - Calculates Brier score</span>
<span class="c1"># - Implements isotonic or Platt scaling calibration</span>
<span class="c1"># - Compares calibrated vs uncalibrated probabilities</span>
<span class="c1">#</span>
<span class="c1"># Your implementation:</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 6.5</summary>


<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">sklearn.calibration</span> <span class="kn">import</span> <span class="n">CalibratedClassifierCV</span><span class="p">,</span> <span class="n">calibration_curve</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">brier_score_loss</span>

<span class="k">class</span> <span class="nc">ProbabilityCalibrator</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Analyze and improve probability calibration.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">classifier</span><span class="p">,</span> <span class="n">n_bins</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span> <span class="o">=</span> <span class="n">classifier</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_bins</span> <span class="o">=</span> <span class="n">n_bins</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calibrated_clf</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">analyze_calibration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Analyze probability calibration.&quot;&quot;&quot;</span>
        <span class="n">probas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">]</span>

        <span class="c1"># Calibration curve</span>
        <span class="n">prob_true</span><span class="p">,</span> <span class="n">prob_pred</span> <span class="o">=</span> <span class="n">calibration_curve</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">probas</span><span class="p">,</span> <span class="n">n_bins</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n_bins</span><span class="p">)</span>

        <span class="c1"># Brier score</span>
        <span class="n">brier</span> <span class="o">=</span> <span class="n">brier_score_loss</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">probas</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;prob_true&#39;</span><span class="p">:</span> <span class="n">prob_true</span><span class="p">,</span>
            <span class="s1">&#39;prob_pred&#39;</span><span class="p">:</span> <span class="n">prob_pred</span><span class="p">,</span>
            <span class="s1">&#39;brier_score&#39;</span><span class="p">:</span> <span class="n">brier</span><span class="p">,</span>
            <span class="s1">&#39;probabilities&#39;</span><span class="p">:</span> <span class="n">probas</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">calibrate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span>
                  <span class="n">method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;isotonic&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;ProbabilityCalibrator&#39;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Apply calibration to the classifier.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calibrated_clf</span> <span class="o">=</span> <span class="n">CalibratedClassifierCV</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="p">,</span>
            <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span>  <span class="c1"># &#39;isotonic&#39; or &#39;sigmoid&#39;</span>
            <span class="n">cv</span><span class="o">=</span><span class="mi">3</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calibrated_clf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">compare</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Compare calibrated vs uncalibrated.&quot;&quot;&quot;</span>
        <span class="n">uncal_probas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">cal_probas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calibrated_clf</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">]</span>

        <span class="n">uncal_brier</span> <span class="o">=</span> <span class="n">brier_score_loss</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">uncal_probas</span><span class="p">)</span>
        <span class="n">cal_brier</span> <span class="o">=</span> <span class="n">brier_score_loss</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">cal_probas</span><span class="p">)</span>

        <span class="n">uncal_acc</span> <span class="o">=</span> <span class="n">accuracy_score</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="p">(</span><span class="n">uncal_probas</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">))</span>
        <span class="n">cal_acc</span> <span class="o">=</span> <span class="n">accuracy_score</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="p">(</span><span class="n">cal_probas</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
            <span class="s1">&#39;Metric&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Brier Score&#39;</span><span class="p">,</span> <span class="s1">&#39;Accuracy&#39;</span><span class="p">],</span>
            <span class="s1">&#39;Uncalibrated&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">uncal_brier</span><span class="p">,</span> <span class="n">uncal_acc</span><span class="p">],</span>
            <span class="s1">&#39;Calibrated&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">cal_brier</span><span class="p">,</span> <span class="n">cal_acc</span><span class="p">],</span>
            <span class="s1">&#39;Improvement&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">uncal_brier</span> <span class="o">-</span> <span class="n">cal_brier</span><span class="p">,</span> <span class="n">cal_acc</span> <span class="o">-</span> <span class="n">uncal_acc</span><span class="p">]</span>
        <span class="p">})</span>

    <span class="k">def</span> <span class="nf">plot_calibration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Plot calibration curves.&quot;&quot;&quot;</span>
        <span class="n">uncal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_calibration</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

        <span class="c1"># Perfect calibration line</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;k--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Perfect calibration&#39;</span><span class="p">)</span>

        <span class="c1"># Uncalibrated</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">uncal</span><span class="p">[</span><span class="s1">&#39;prob_pred&#39;</span><span class="p">],</span> <span class="n">uncal</span><span class="p">[</span><span class="s1">&#39;prob_true&#39;</span><span class="p">],</span>
                <span class="s1">&#39;s-&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Uncalibrated (Brier: </span><span class="si">{</span><span class="n">uncal</span><span class="p">[</span><span class="s1">&#39;brier_score&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

        <span class="c1"># Calibrated</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">calibrated_clf</span><span class="p">:</span>
            <span class="n">cal_probas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calibrated_clf</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">cal_true</span><span class="p">,</span> <span class="n">cal_pred</span> <span class="o">=</span> <span class="n">calibration_curve</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">cal_probas</span><span class="p">,</span> <span class="n">n_bins</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n_bins</span><span class="p">)</span>
            <span class="n">cal_brier</span> <span class="o">=</span> <span class="n">brier_score_loss</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">cal_probas</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">cal_pred</span><span class="p">,</span> <span class="n">cal_true</span><span class="p">,</span> <span class="s1">&#39;o-&#39;</span><span class="p">,</span>
                    <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Calibrated (Brier: </span><span class="si">{</span><span class="n">cal_brier</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Mean Predicted Probability&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Fraction of Positives&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Probability Calibration Curve&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>


</details></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 6.6: Trading Signal Pipeline Builder (Open-ended)</span>
<span class="c1">#</span>
<span class="c1"># Build a TradingSignalPipeline class that:</span>
<span class="c1"># - Combines preprocessing, feature scaling, and classification</span>
<span class="c1"># - Supports multiple classifier backends (logreg, svm, mlp)</span>
<span class="c1"># - Generates signals with confidence levels</span>
<span class="c1"># - Implements fit(), predict(), and predict_proba()</span>
<span class="c1"># - Has a get_signal_strength() method returning -1 to +1</span>
<span class="c1"># - Provides interpretability info (coefficients or feature importance)</span>
<span class="c1">#</span>
<span class="c1"># Your implementation:</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 6.6</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">TradingSignalPipeline</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Complete pipeline for trading signal generation.&quot;&quot;&quot;</span>

    <span class="n">CLASSIFIERS</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;logreg&#39;</span><span class="p">:</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">max_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">),</span>
        <span class="s1">&#39;svm&#39;</span><span class="p">:</span> <span class="n">SVC</span><span class="p">(</span><span class="n">kernel</span><span class="o">=</span><span class="s1">&#39;rbf&#39;</span><span class="p">,</span> <span class="n">probability</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">),</span>
        <span class="s1">&#39;mlp&#39;</span><span class="p">:</span> <span class="n">MLPClassifier</span><span class="p">(</span><span class="n">hidden_layer_sizes</span><span class="o">=</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">32</span><span class="p">),</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
                            <span class="n">early_stopping</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">classifier_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;logreg&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">classifier_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">CLASSIFIERS</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown classifier: </span><span class="si">{</span><span class="n">classifier_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">classifier_type</span> <span class="o">=</span> <span class="n">classifier_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">CLASSIFIERS</span><span class="p">[</span><span class="n">classifier_type</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_names</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Fit the pipeline.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_names</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

        <span class="n">X_scaled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_scaled</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Predict class labels.&quot;&quot;&quot;</span>
        <span class="n">X_scaled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_scaled</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">predict_proba</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Predict class probabilities.&quot;&quot;&quot;</span>
        <span class="n">X_scaled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_scaled</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_signal_strength</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get signal strength from -1 (strong sell) to +1 (strong buy).&quot;&quot;&quot;</span>
        <span class="n">probas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="c1"># Map [0, 1] to [-1, 1]</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">probas</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span>

    <span class="k">def</span> <span class="nf">get_signals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get detailed signal information.&quot;&quot;&quot;</span>
        <span class="n">predictions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="n">probabilities</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="n">strength</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_signal_strength</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
            <span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="n">predictions</span><span class="p">,</span>
            <span class="s1">&#39;signal_name&#39;</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">predictions</span><span class="p">)</span><span class="o">.</span><span class="n">map</span><span class="p">({</span><span class="mi">0</span><span class="p">:</span> <span class="s1">&#39;SELL&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="s1">&#39;BUY&#39;</span><span class="p">}),</span>
            <span class="s1">&#39;prob_down&#39;</span><span class="p">:</span> <span class="n">probabilities</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span>
            <span class="s1">&#39;prob_up&#39;</span><span class="p">:</span> <span class="n">probabilities</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span>
            <span class="s1">&#39;strength&#39;</span><span class="p">:</span> <span class="n">strength</span><span class="p">,</span>
            <span class="s1">&#39;confidence&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">strength</span><span class="p">)</span>
        <span class="p">},</span> <span class="n">index</span><span class="o">=</span><span class="n">X</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_interpretability</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Get model interpretability info.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">classifier_type</span> <span class="o">==</span> <span class="s1">&#39;logreg&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
                <span class="s1">&#39;feature&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_names</span><span class="p">,</span>
                <span class="s1">&#39;coefficient&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">coef_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="p">})</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;coefficient&#39;</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="nb">abs</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">classifier_type</span> <span class="o">==</span> <span class="s1">&#39;mlp&#39;</span><span class="p">:</span>
            <span class="c1"># Approximate importance from first layer weights</span>
            <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">coefs_</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
                <span class="s1">&#39;feature&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_names</span><span class="p">,</span>
                <span class="s1">&#39;importance&#39;</span><span class="p">:</span> <span class="n">weights</span>
            <span class="p">})</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;importance&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">score</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate accuracy.&quot;&quot;&quot;</span>
        <span class="n">X_scaled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_scaled</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell module-project"><hr />
<h2>Module Project: Multi-Model Trading Signal Ensemble</h2>
<p>Build a complete trading system that combines multiple classification models.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">MultiModelTradingSystem</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Trading system combining multiple classification models.</span>
<span class="sd">    </span>
<span class="sd">    Uses logistic regression, SVM, and neural network for robust predictions.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">models</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;logreg&#39;</span><span class="p">:</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">penalty</span><span class="o">=</span><span class="s1">&#39;l2&#39;</span><span class="p">,</span> <span class="n">C</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">),</span>
            <span class="s1">&#39;svm&#39;</span><span class="p">:</span> <span class="n">SVC</span><span class="p">(</span><span class="n">kernel</span><span class="o">=</span><span class="s1">&#39;rbf&#39;</span><span class="p">,</span> <span class="n">C</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">probability</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">),</span>
            <span class="s1">&#39;mlp&#39;</span><span class="p">:</span> <span class="n">MLPClassifier</span><span class="p">(</span><span class="n">hidden_layer_sizes</span><span class="o">=</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">32</span><span class="p">),</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
                                <span class="n">early_stopping</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;logreg&#39;</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">,</span> <span class="s1">&#39;svm&#39;</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">,</span> <span class="s1">&#39;mlp&#39;</span><span class="p">:</span> <span class="mf">0.4</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_names</span> <span class="o">=</span> <span class="kc">None</span>
        
    <span class="k">def</span> <span class="nf">create_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Create features from OHLCV data.&quot;&quot;&quot;</span>
        <span class="n">features</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        
        <span class="c1"># Price features</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;returns&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;volatility&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;returns&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
        
        <span class="c1"># Momentum</span>
        <span class="k">for</span> <span class="n">period</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">]:</span>
            <span class="n">features</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;momentum_</span><span class="si">{</span><span class="n">period</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">(</span><span class="n">period</span><span class="p">)</span>
        
        <span class="c1"># Moving average distances</span>
        <span class="k">for</span> <span class="n">period</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">50</span><span class="p">]:</span>
            <span class="n">ma</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">period</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="n">features</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;dist_ma</span><span class="si">{</span><span class="n">period</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">ma</span><span class="p">)</span> <span class="o">/</span> <span class="n">ma</span>
        
        <span class="c1"># RSI</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span>
        <span class="n">gain</span> <span class="o">=</span> <span class="p">(</span><span class="n">delta</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">delta</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">14</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">delta</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">delta</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">14</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;rsi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">-</span> <span class="p">(</span><span class="mi">100</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">gain</span> <span class="o">/</span> <span class="n">loss</span><span class="p">))</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;rsi_normalized&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">features</span><span class="p">[</span><span class="s1">&#39;rsi&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">50</span><span class="p">)</span> <span class="o">/</span> <span class="mi">50</span>
        
        <span class="c1"># Volume</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;volume_ratio&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Volume&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Volume&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        
        <span class="k">return</span> <span class="n">features</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">test_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Fit all models on the data.&quot;&quot;&quot;</span>
        <span class="c1"># Create features</span>
        <span class="n">features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_features</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_names</span> <span class="o">=</span> <span class="n">features</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        
        <span class="c1"># Create target</span>
        <span class="n">aligned_df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">features</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
        <span class="n">target</span> <span class="o">=</span> <span class="p">(</span><span class="n">aligned_df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        
        <span class="c1"># Remove last row</span>
        <span class="n">features</span> <span class="o">=</span> <span class="n">features</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">target</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        
        <span class="c1"># Split</span>
        <span class="n">split_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">features</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">test_size</span><span class="p">))</span>
        <span class="n">X_train</span> <span class="o">=</span> <span class="n">features</span><span class="p">[:</span><span class="n">split_idx</span><span class="p">]</span>
        <span class="n">X_test</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="n">split_idx</span><span class="p">:]</span>
        <span class="n">y_train</span> <span class="o">=</span> <span class="n">target</span><span class="p">[:</span><span class="n">split_idx</span><span class="p">]</span>
        <span class="n">y_test</span> <span class="o">=</span> <span class="n">target</span><span class="p">[</span><span class="n">split_idx</span><span class="p">:]</span>
        
        <span class="c1"># Scale</span>
        <span class="n">X_train_scaled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
        <span class="n">X_test_scaled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
        
        <span class="c1"># Fit all models</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Training models...</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">model</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_scaled</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
            <span class="n">train_acc</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_train_scaled</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
            <span class="n">test_acc</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_test_scaled</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">:</span><span class="s2">10s</span><span class="si">}</span><span class="s2">: Train </span><span class="si">{</span><span class="n">train_acc</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">, Test </span><span class="si">{</span><span class="n">test_acc</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># Ensemble performance</span>
        <span class="n">ensemble_pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ensemble_predict</span><span class="p">(</span><span class="n">X_test_scaled</span><span class="p">)</span>
        <span class="n">ensemble_acc</span> <span class="o">=</span> <span class="n">accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">ensemble_pred</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;Ensemble&#39;</span><span class="si">:</span><span class="s2">10s</span><span class="si">}</span><span class="s2">: Test </span><span class="si">{</span><span class="n">ensemble_acc</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="bp">self</span>
    
    <span class="k">def</span> <span class="nf">_ensemble_predict_proba</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Weighted average of probabilities.&quot;&quot;&quot;</span>
        <span class="n">weighted_proba</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">),</span> <span class="mi">2</span><span class="p">))</span>
        
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">model</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">weighted_proba</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">weighted_proba</span>
    
    <span class="k">def</span> <span class="nf">_ensemble_predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Ensemble prediction.&quot;&quot;&quot;</span>
        <span class="n">proba</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ensemble_predict_proba</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">proba</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Generate trading signals.&quot;&quot;&quot;</span>
        <span class="n">features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_features</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="n">X_scaled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>
        
        <span class="c1"># Get individual predictions</span>
        <span class="n">signals</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">features</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">model</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">signals</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">_prob&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_scaled</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">signals</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">_signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_scaled</span><span class="p">)</span>
        
        <span class="c1"># Ensemble</span>
        <span class="n">ensemble_proba</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ensemble_predict_proba</span><span class="p">(</span><span class="n">X_scaled</span><span class="p">)</span>
        <span class="n">signals</span><span class="p">[</span><span class="s1">&#39;ensemble_prob&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ensemble_proba</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">signals</span><span class="p">[</span><span class="s1">&#39;ensemble_signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ensemble_predict</span><span class="p">(</span><span class="n">X_scaled</span><span class="p">)</span>
        
        <span class="c1"># Signal strength and agreement</span>
        <span class="n">signals</span><span class="p">[</span><span class="s1">&#39;strength&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">signals</span><span class="p">[</span><span class="s1">&#39;ensemble_prob&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span>
        <span class="n">signals</span><span class="p">[</span><span class="s1">&#39;model_agreement&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">signals</span><span class="p">[</span><span class="s1">&#39;logreg_signal&#39;</span><span class="p">]</span> <span class="o">+</span>
            <span class="n">signals</span><span class="p">[</span><span class="s1">&#39;svm_signal&#39;</span><span class="p">]</span> <span class="o">+</span>
            <span class="n">signals</span><span class="p">[</span><span class="s1">&#39;mlp_signal&#39;</span><span class="p">]</span>
        <span class="p">)</span> <span class="o">/</span> <span class="mi">3</span>
        
        <span class="k">return</span> <span class="n">signals</span>
    
    <span class="k">def</span> <span class="nf">get_feature_importance</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get feature importance from logistic regression.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
            <span class="s1">&#39;feature&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_names</span><span class="p">,</span>
            <span class="s1">&#39;coefficient&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="s1">&#39;logreg&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">coef_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="p">})</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;coefficient&#39;</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="nb">abs</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">backtest</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Simple backtest of the system.&quot;&quot;&quot;</span>
        <span class="n">signals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        
        <span class="c1"># Get returns</span>
        <span class="n">returns</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">aligned_returns</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">signals</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
        
        <span class="c1"># Strategy returns</span>
        <span class="n">signals</span><span class="p">[</span><span class="s1">&#39;next_return&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">aligned_returns</span>
        <span class="n">signals</span><span class="p">[</span><span class="s1">&#39;strategy_return&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">signals</span><span class="p">[</span><span class="s1">&#39;ensemble_signal&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">signals</span><span class="p">[</span><span class="s1">&#39;next_return&#39;</span><span class="p">]</span>
        
        <span class="c1"># Strength-weighted returns</span>
        <span class="n">signals</span><span class="p">[</span><span class="s1">&#39;weighted_return&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">signals</span><span class="p">[</span><span class="s1">&#39;strength&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">signals</span><span class="p">[</span><span class="s1">&#39;next_return&#39;</span><span class="p">]</span>
        
        <span class="c1"># Cumulative</span>
        <span class="n">signals</span><span class="p">[</span><span class="s1">&#39;cum_strategy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">signals</span><span class="p">[</span><span class="s1">&#39;strategy_return&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span>
        <span class="n">signals</span><span class="p">[</span><span class="s1">&#39;cum_weighted&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">signals</span><span class="p">[</span><span class="s1">&#39;weighted_return&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span>
        <span class="n">signals</span><span class="p">[</span><span class="s1">&#39;cum_bh&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">signals</span><span class="p">[</span><span class="s1">&#39;next_return&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span>
        
        <span class="k">return</span> <span class="n">signals</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Test the multi-model system</span>

<span class="c1"># Get data</span>
<span class="n">ticker</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">Ticker</span><span class="p">(</span><span class="s2">&quot;SPY&quot;</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">ticker</span><span class="o">.</span><span class="n">history</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="s2">&quot;2y&quot;</span><span class="p">)</span>

<span class="c1"># Create and train system</span>
<span class="n">system</span> <span class="o">=</span> <span class="n">MultiModelTradingSystem</span><span class="p">()</span>
<span class="n">system</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Backtest and visualize</span>

<span class="n">backtest</span> <span class="o">=</span> <span class="n">system</span><span class="o">.</span><span class="n">backtest</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

<span class="c1"># Plot results</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

<span class="c1"># Cumulative returns</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">backtest</span><span class="p">[</span><span class="s1">&#39;cum_strategy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">(),</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Binary Strategy&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">backtest</span><span class="p">[</span><span class="s1">&#39;cum_weighted&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">(),</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Weighted Strategy&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">backtest</span><span class="p">[</span><span class="s1">&#39;cum_bh&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">(),</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Buy &amp; Hold&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Cumulative Return&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Multi-Model Trading System Performance&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="c1"># Model agreement</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">backtest</span><span class="p">[</span><span class="s1">&#39;model_agreement&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">(),</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">backtest</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="n">backtest</span><span class="p">[</span><span class="s1">&#39;model_agreement&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.66</span><span class="p">,</span>
                     <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Strong Buy&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">backtest</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="n">backtest</span><span class="p">[</span><span class="s1">&#39;model_agreement&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.33</span><span class="p">,</span>
                     <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Strong Sell&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Model Agreement (0-1)&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Model Agreement Over Time&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Performance summary</span>

<span class="n">strategy_return</span> <span class="o">=</span> <span class="n">backtest</span><span class="p">[</span><span class="s1">&#39;cum_strategy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
<span class="n">weighted_return</span> <span class="o">=</span> <span class="n">backtest</span><span class="p">[</span><span class="s1">&#39;cum_weighted&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
<span class="n">bh_return</span> <span class="o">=</span> <span class="n">backtest</span><span class="p">[</span><span class="s1">&#39;cum_bh&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Performance Summary:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Binary Strategy: </span><span class="si">{</span><span class="n">strategy_return</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Weighted Strategy: </span><span class="si">{</span><span class="n">weighted_return</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Buy &amp; Hold: </span><span class="si">{</span><span class="n">bh_return</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">  Outperformance (Binary): </span><span class="si">{</span><span class="n">strategy_return</span> <span class="o">-</span> <span class="n">bh_return</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Outperformance (Weighted): </span><span class="si">{</span><span class="n">weighted_return</span> <span class="o">-</span> <span class="n">bh_return</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Feature importance</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Top Features (from Logistic Regression):&quot;</span><span class="p">)</span>
<span class="n">importance</span> <span class="o">=</span> <span class="n">system</span><span class="o">.</span><span class="n">get_feature_importance</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">importance</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
</code></pre></div>
<div class="md-cell key-takeaways"><hr />
<h2>Key Takeaways</h2>
<ol>
<li>
<p><strong>Logistic Regression</strong> provides interpretable coefficients and probability outputs; regularization (L1/L2) prevents overfitting</p>
</li>
<li>
<p><strong>Support Vector Machines</strong> find maximum-margin boundaries; kernels (RBF, polynomial) capture non-linear patterns</p>
</li>
<li>
<p><strong>Neural Networks (MLP)</strong> learn complex patterns but require careful tuning and more data to avoid overfitting</p>
</li>
<li>
<p><strong>Feature scaling</strong> is crucial for SVM and neural networks; always scale before training</p>
</li>
<li>
<p><strong>Probability calibration</strong> matters for trading; well-calibrated probabilities improve position sizing</p>
</li>
<li>
<p><strong>Model ensembles</strong> often outperform individual models by combining diverse perspectives</p>
</li>
<li>
<p><strong>No single best model</strong> exists; the right choice depends on data characteristics and interpretability needs</p>
</li>
</ol>
<hr />
<p><strong>Next: Module 7 - Model Evaluation</strong> (Classification metrics, financial metrics, ROC curves)</p></div>
        <div class="nav-buttons">
            <button class="nav-btn prev-btn disabled" type="button">
                <span class="nav-btn-label">‚Üê Previous</span>
                <span class="nav-btn-name"></span>
            </button>
            <button class="nav-btn next-btn disabled" type="button">
                <span class="nav-btn-label">Next ‚Üí</span>
                <span class="nav-btn-name"></span>
            </button>
        </div>
        </div>
<div class="module-section" data-idx="7"><div class="md-cell module-header"><h1>Module 7: Model Evaluation</h1>
<h2>Part 2: Classification Models</h2>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Duration</th>
<th>Exercises</th>
<th>Prerequisites</th>
</tr>
</thead>
<tbody>
<tr>
<td>~2.5 hours</td>
<td>6</td>
<td>Modules 1-6</td>
</tr>
</tbody>
</table></div>
<h3>Learning Objectives</h3>
<p>By the end of this module, you will be able to:
- Calculate and interpret classification metrics (accuracy, precision, recall, F1)
- Use confusion matrices for detailed error analysis
- Apply ROC curves and AUC for threshold-independent evaluation
- Evaluate models with financial metrics (returns, Sharpe ratio)
- Implement proper walk-forward validation for realistic assessment</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>

<span class="c1"># Scikit-learn metrics</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">accuracy_score</span><span class="p">,</span> <span class="n">precision_score</span><span class="p">,</span> <span class="n">recall_score</span><span class="p">,</span> <span class="n">f1_score</span><span class="p">,</span>
    <span class="n">confusion_matrix</span><span class="p">,</span> <span class="n">classification_report</span><span class="p">,</span>
    <span class="n">roc_curve</span><span class="p">,</span> <span class="n">auc</span><span class="p">,</span> <span class="n">roc_auc_score</span><span class="p">,</span>
    <span class="n">precision_recall_curve</span><span class="p">,</span> <span class="n">average_precision_score</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">TimeSeriesSplit</span>
<span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">RandomForestClassifier</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">StandardScaler</span>

<span class="kn">import</span> <span class="nn">yfinance</span> <span class="k">as</span> <span class="nn">yf</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Module 7: Model Evaluation&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">40</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Prepare data and train a model for evaluation</span>

<span class="k">def</span> <span class="nf">prepare_data</span><span class="p">(</span><span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;SPY&quot;</span><span class="p">,</span> <span class="n">period</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;2y&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Prepare features, target, and train/test splits.&quot;&quot;&quot;</span>
    <span class="n">ticker</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">Ticker</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">ticker</span><span class="o">.</span><span class="n">history</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="n">period</span><span class="p">)</span>
    
    <span class="c1"># Features</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;returns&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;volatility&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;returns&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;momentum_5&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;momentum_20&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">period_len</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">50</span><span class="p">]:</span>
        <span class="n">ma</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">period_len</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;dist_ma</span><span class="si">{</span><span class="n">period_len</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">ma</span><span class="p">)</span> <span class="o">/</span> <span class="n">ma</span>
    
    <span class="n">delta</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span>
    <span class="n">gain</span> <span class="o">=</span> <span class="p">(</span><span class="n">delta</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">delta</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">14</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">delta</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">delta</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">14</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;rsi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">-</span> <span class="p">(</span><span class="mi">100</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">gain</span> <span class="o">/</span> <span class="n">loss</span><span class="p">))</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;volume_ratio&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Volume&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Volume&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;returns&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
    
    <span class="n">features</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;volatility&#39;</span><span class="p">,</span> <span class="s1">&#39;momentum_5&#39;</span><span class="p">,</span> <span class="s1">&#39;momentum_20&#39;</span><span class="p">,</span> <span class="s1">&#39;dist_ma5&#39;</span><span class="p">,</span>
                <span class="s1">&#39;dist_ma20&#39;</span><span class="p">,</span> <span class="s1">&#39;dist_ma50&#39;</span><span class="p">,</span> <span class="s1">&#39;rsi&#39;</span><span class="p">,</span> <span class="s1">&#39;volume_ratio&#39;</span><span class="p">]</span>
    
    <span class="n">X</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">features</span><span class="p">]</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span>
    
    <span class="n">split_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.8</span><span class="p">)</span>
    <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span> <span class="o">=</span> <span class="n">X</span><span class="p">[:</span><span class="n">split_idx</span><span class="p">],</span> <span class="n">X</span><span class="p">[</span><span class="n">split_idx</span><span class="p">:]</span>
    <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">y</span><span class="p">[:</span><span class="n">split_idx</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">split_idx</span><span class="p">:]</span>
    
    <span class="k">return</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">df</span>

<span class="c1"># Load data</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">df</span> <span class="o">=</span> <span class="n">prepare_data</span><span class="p">()</span>

<span class="c1"># Scale</span>
<span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
<span class="n">X_train_scaled</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
<span class="n">X_test_scaled</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>

<span class="c1"># Train model</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">RandomForestClassifier</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_scaled</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

<span class="c1"># Get predictions</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test_scaled</span><span class="p">)</span>
<span class="n">y_proba</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test_scaled</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Test samples: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">y_test</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Predictions shape: </span><span class="si">{</span><span class="n">y_pred</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><hr />
<h2>Section 1: Classification Metrics</h2>
<p>Understanding the fundamental metrics for evaluating classification models.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Classification Metrics Overview</span>

<span class="n">metrics_overview</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">CLASSIFICATION METRICS</span>
<span class="s2">======================</span>

<span class="s2">Confusion Matrix:</span>
<span class="s2">-----------------</span>
<span class="s2">                    Predicted</span>
<span class="s2">                  Neg     Pos</span>
<span class="s2">           Neg  [ TN  |  FP ]</span>
<span class="s2">  Actual   Pos  [ FN  |  TP ]</span>

<span class="s2">  TN = True Negative:  Correctly predicted DOWN</span>
<span class="s2">  TP = True Positive:  Correctly predicted UP</span>
<span class="s2">  FP = False Positive: Predicted UP, was DOWN (Type I error)</span>
<span class="s2">  FN = False Negative: Predicted DOWN, was UP (Type II error)</span>

<span class="s2">Key Metrics:</span>
<span class="s2">------------</span>
<span class="s2">  Accuracy = (TP + TN) / (TP + TN + FP + FN)</span>
<span class="s2">    ‚Üí Overall correctness</span>
<span class="s2">    ‚Üí Misleading for imbalanced data</span>

<span class="s2">  Precision = TP / (TP + FP)</span>
<span class="s2">    ‚Üí &quot;Of all predicted UP, how many were actually UP?&quot;</span>
<span class="s2">    ‚Üí High precision = few false alarms</span>
<span class="s2">    ‚Üí Important when FP is costly (e.g., buying on wrong signal)</span>

<span class="s2">  Recall = TP / (TP + FN)</span>
<span class="s2">    ‚Üí &quot;Of all actual UP days, how many did we catch?&quot;</span>
<span class="s2">    ‚Üí High recall = don&#39;t miss opportunities</span>
<span class="s2">    ‚Üí Important when FN is costly (e.g., missing big moves)</span>

<span class="s2">  F1 Score = 2 * (Precision * Recall) / (Precision + Recall)</span>
<span class="s2">    ‚Üí Harmonic mean of precision and recall</span>
<span class="s2">    ‚Üí Balanced measure when both matter</span>

<span class="s2">Trading Context:</span>
<span class="s2">----------------</span>
<span class="s2">  High Precision Strategy: &quot;Only trade when very confident&quot;</span>
<span class="s2">  High Recall Strategy: &quot;Never miss a move&quot;</span>
<span class="s2">  Balanced (F1): &quot;Reasonable trade-off&quot;</span>
<span class="s2">&quot;&quot;&quot;</span>
<span class="nb">print</span><span class="p">(</span><span class="n">metrics_overview</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Calculate basic metrics</span>

<span class="n">accuracy</span> <span class="o">=</span> <span class="n">accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="n">precision</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="n">recall</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="n">f1</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Classification Metrics:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Accuracy:  </span><span class="si">{</span><span class="n">accuracy</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">accuracy</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Precision: </span><span class="si">{</span><span class="n">precision</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">precision</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Recall:    </span><span class="si">{</span><span class="n">recall</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">recall</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  F1 Score:  </span><span class="si">{</span><span class="n">f1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">f1</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

<span class="c1"># Random baseline</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">  Random Baseline: 50.00%&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Improvement over random: </span><span class="si">{</span><span class="p">(</span><span class="n">accuracy</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">pp&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Full classification report</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Classification Report:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">classification_report</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">target_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;DOWN&#39;</span><span class="p">,</span> <span class="s1">&#39;UP&#39;</span><span class="p">]))</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Confusion matrix</span>

<span class="n">cm</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">annot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Blues&#39;</span><span class="p">,</span>
            <span class="n">xticklabels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Predicted DOWN&#39;</span><span class="p">,</span> <span class="s1">&#39;Predicted UP&#39;</span><span class="p">],</span>
            <span class="n">yticklabels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Actual DOWN&#39;</span><span class="p">,</span> <span class="s1">&#39;Actual UP&#39;</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Confusion Matrix&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Actual&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Predicted&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Extract values</span>
<span class="n">tn</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">tp</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Confusion Matrix Breakdown:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  True Negatives (DOWN ‚Üí DOWN):  </span><span class="si">{</span><span class="n">tn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  False Positives (DOWN ‚Üí UP):   </span><span class="si">{</span><span class="n">fp</span><span class="si">}</span><span class="s2">  ‚Üê Wrong buy signals&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  False Negatives (UP ‚Üí DOWN):   </span><span class="si">{</span><span class="n">fn</span><span class="si">}</span><span class="s2">  ‚Üê Missed opportunities&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  True Positives (UP ‚Üí UP):      </span><span class="si">{</span><span class="n">tp</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 7.1: Metrics Calculator (Guided)</span>

<span class="k">def</span> <span class="nf">calculate_all_metrics</span><span class="p">(</span><span class="n">y_true</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                          <span class="n">y_proba</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate comprehensive classification metrics.</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        Dictionary with all metrics</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Basic metrics</span>
    <span class="n">metrics</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="c1"># TODO: Calculate accuracy, precision, recall, f1</span>
    <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">______</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
    <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">______</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
    <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;recall&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">______</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
    <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">______</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
    
    <span class="c1"># TODO: Get confusion matrix values</span>
    <span class="n">cm</span> <span class="o">=</span> <span class="n">______</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
    <span class="n">tn</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">tp</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">______</span><span class="p">()</span>
    
    <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;true_negatives&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tn</span>
    <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;false_positives&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fp</span>
    <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;false_negatives&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fn</span>
    <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;true_positives&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tp</span>
    
    <span class="c1"># Specificity (true negative rate)</span>
    <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;specificity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tn</span> <span class="o">/</span> <span class="p">(</span><span class="n">tn</span> <span class="o">+</span> <span class="n">fp</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="n">tn</span> <span class="o">+</span> <span class="n">fp</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
    
    <span class="c1"># ROC AUC if probabilities provided</span>
    <span class="k">if</span> <span class="n">y_proba</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;roc_auc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">roc_auc_score</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_proba</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span>
    
    <span class="k">return</span> <span class="n">metrics</span>

<span class="c1"># Test the function</span>
<span class="c1"># metrics = calculate_all_metrics(y_test, y_pred, y_proba)</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 7.1</summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">calculate_all_metrics</span><span class="p">(</span><span class="n">y_true</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                          <span class="n">y_proba</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate comprehensive classification metrics.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">metrics</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">accuracy_score</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
    <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
    <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;recall&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
    <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>

    <span class="n">cm</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
    <span class="n">tn</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">tp</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

    <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;true_negatives&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tn</span>
    <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;false_positives&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fp</span>
    <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;false_negatives&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fn</span>
    <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;true_positives&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tp</span>

    <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;specificity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tn</span> <span class="o">/</span> <span class="p">(</span><span class="n">tn</span> <span class="o">+</span> <span class="n">fp</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="n">tn</span> <span class="o">+</span> <span class="n">fp</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>

    <span class="k">if</span> <span class="n">y_proba</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;roc_auc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">roc_auc_score</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_proba</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">metrics</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h2>Section 2: ROC Curves and AUC</h2>
<p>ROC curves provide threshold-independent model evaluation.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># ROC Curve Concepts</span>

<span class="n">roc_concepts</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">ROC CURVES AND AUC</span>
<span class="s2">==================</span>

<span class="s2">What is ROC?</span>
<span class="s2">------------</span>
<span class="s2">ROC = Receiver Operating Characteristic</span>
<span class="s2">- Plots True Positive Rate vs False Positive Rate at different thresholds</span>
<span class="s2">- Shows trade-off between catching positives and creating false alarms</span>

<span class="s2">Axes:</span>
<span class="s2">-----</span>
<span class="s2">  Y-axis: True Positive Rate (TPR) = Recall = TP / (TP + FN)</span>
<span class="s2">  X-axis: False Positive Rate (FPR) = FP / (FP + TN)</span>

<span class="s2">Interpretation:</span>
<span class="s2">---------------</span>
<span class="s2">  - Diagonal line = random classifier (AUC = 0.5)</span>
<span class="s2">  - Upper left corner = perfect classifier (AUC = 1.0)</span>
<span class="s2">  - Curve above diagonal = better than random</span>

<span class="s2">AUC (Area Under Curve):</span>
<span class="s2">-----------------------</span>
<span class="s2">  - 1.0: Perfect classifier</span>
<span class="s2">  - 0.9-1.0: Excellent</span>
<span class="s2">  - 0.8-0.9: Good</span>
<span class="s2">  - 0.7-0.8: Fair</span>
<span class="s2">  - 0.5-0.7: Poor</span>
<span class="s2">  - 0.5: Random</span>

<span class="s2">Trading Context:</span>
<span class="s2">----------------</span>
<span class="s2">  AUC 0.5: Model has no predictive power</span>
<span class="s2">  AUC 0.55: Slight edge (may be profitable with good execution)</span>
<span class="s2">  AUC 0.60+: Strong signal (rare in liquid markets)</span>
<span class="s2">&quot;&quot;&quot;</span>
<span class="nb">print</span><span class="p">(</span><span class="n">roc_concepts</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Calculate and plot ROC curve</span>

<span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">thresholds</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_proba</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span>
<span class="n">roc_auc</span> <span class="o">=</span> <span class="n">auc</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

<span class="c1"># ROC curve</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkorange&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
         <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;ROC curve (AUC = </span><span class="si">{</span><span class="n">roc_auc</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>

<span class="c1"># Random baseline</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;navy&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span>
         <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Random (AUC = 0.500)&#39;</span><span class="p">)</span>

<span class="c1"># Formatting</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.05</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;False Positive Rate&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;True Positive Rate&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Receiver Operating Characteristic (ROC) Curve&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;lower right&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AUC: </span><span class="si">{</span><span class="n">roc_auc</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Interpretation: </span><span class="si">{</span><span class="s1">&#39;Better than random&#39;</span> <span class="k">if</span> <span class="n">roc_auc</span> <span class="o">&gt;</span> <span class="mf">0.5</span> <span class="k">else</span> <span class="s1">&#39;No predictive power&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Optimal threshold selection</span>

<span class="c1"># Youden&#39;s J statistic: TPR - FPR</span>
<span class="n">j_scores</span> <span class="o">=</span> <span class="n">tpr</span> <span class="o">-</span> <span class="n">fpr</span>
<span class="n">optimal_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">j_scores</span><span class="p">)</span>
<span class="n">optimal_threshold</span> <span class="o">=</span> <span class="n">thresholds</span><span class="p">[</span><span class="n">optimal_idx</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Optimal Threshold (Youden&#39;s J): </span><span class="si">{</span><span class="n">optimal_threshold</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  At this threshold:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  TPR (Recall): </span><span class="si">{</span><span class="n">tpr</span><span class="p">[</span><span class="n">optimal_idx</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  FPR: </span><span class="si">{</span><span class="n">fpr</span><span class="p">[</span><span class="n">optimal_idx</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Apply optimal threshold</span>
<span class="n">y_pred_optimal</span> <span class="o">=</span> <span class="p">(</span><span class="n">y_proba</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">optimal_threshold</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">With optimal threshold:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Accuracy: </span><span class="si">{</span><span class="n">accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_optimal</span><span class="p">)</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Precision: </span><span class="si">{</span><span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_optimal</span><span class="p">)</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Recall: </span><span class="si">{</span><span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_optimal</span><span class="p">)</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Precision-Recall Curve (better for imbalanced data)</span>

<span class="n">precision_curve</span><span class="p">,</span> <span class="n">recall_curve</span><span class="p">,</span> <span class="n">pr_thresholds</span> <span class="o">=</span> <span class="n">precision_recall_curve</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_proba</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span>
<span class="n">avg_precision</span> <span class="o">=</span> <span class="n">average_precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_proba</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">recall_curve</span><span class="p">,</span> <span class="n">precision_curve</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
         <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;PR curve (AP = </span><span class="si">{</span><span class="n">avg_precision</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>

<span class="c1"># Baseline (proportion of positive class)</span>
<span class="n">baseline</span> <span class="o">=</span> <span class="n">y_test</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">baseline</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Random baseline (</span><span class="si">{</span><span class="n">baseline</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Recall&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Precision&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Precision-Recall Curve&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;lower left&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.05</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 7.2: ROC Analyzer (Guided)</span>

<span class="k">def</span> <span class="nf">analyze_roc</span><span class="p">(</span><span class="n">y_true</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">y_proba</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                <span class="n">target_fpr</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Comprehensive ROC analysis.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        y_true: True labels</span>
<span class="sd">        y_proba: Predicted probabilities (n_samples, 2)</span>
<span class="sd">        target_fpr: Target false positive rate for threshold</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        Dictionary with ROC analysis results</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO: Calculate ROC curve</span>
    <span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">thresholds</span> <span class="o">=</span> <span class="n">______</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_proba</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span>
    
    <span class="c1"># TODO: Calculate AUC</span>
    <span class="n">roc_auc</span> <span class="o">=</span> <span class="n">______</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">)</span>
    
    <span class="c1"># Youden&#39;s optimal threshold</span>
    <span class="n">j_scores</span> <span class="o">=</span> <span class="n">tpr</span> <span class="o">-</span> <span class="n">fpr</span>
    <span class="n">optimal_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">______</span><span class="p">(</span><span class="n">j_scores</span><span class="p">)</span>
    <span class="n">optimal_threshold</span> <span class="o">=</span> <span class="n">thresholds</span><span class="p">[</span><span class="n">optimal_idx</span><span class="p">]</span>
    
    <span class="c1"># Threshold for target FPR</span>
    <span class="n">target_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">fpr</span> <span class="o">-</span> <span class="n">target_fpr</span><span class="p">))</span>
    <span class="n">target_threshold</span> <span class="o">=</span> <span class="n">thresholds</span><span class="p">[</span><span class="n">target_idx</span><span class="p">]</span>
    
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;auc&#39;</span><span class="p">:</span> <span class="n">roc_auc</span><span class="p">,</span>
        <span class="s1">&#39;optimal_threshold&#39;</span><span class="p">:</span> <span class="n">optimal_threshold</span><span class="p">,</span>
        <span class="s1">&#39;optimal_tpr&#39;</span><span class="p">:</span> <span class="n">tpr</span><span class="p">[</span><span class="n">optimal_idx</span><span class="p">],</span>
        <span class="s1">&#39;optimal_fpr&#39;</span><span class="p">:</span> <span class="n">fpr</span><span class="p">[</span><span class="n">optimal_idx</span><span class="p">],</span>
        <span class="s1">&#39;target_threshold&#39;</span><span class="p">:</span> <span class="n">target_threshold</span><span class="p">,</span>
        <span class="s1">&#39;target_tpr&#39;</span><span class="p">:</span> <span class="n">tpr</span><span class="p">[</span><span class="n">target_idx</span><span class="p">],</span>
        <span class="s1">&#39;fpr&#39;</span><span class="p">:</span> <span class="n">fpr</span><span class="p">,</span>
        <span class="s1">&#39;tpr&#39;</span><span class="p">:</span> <span class="n">tpr</span><span class="p">,</span>
        <span class="s1">&#39;thresholds&#39;</span><span class="p">:</span> <span class="n">thresholds</span>
    <span class="p">}</span>

<span class="c1"># Test the function</span>
<span class="c1"># roc_analysis = analyze_roc(y_test, y_proba)</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 7.2</summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">analyze_roc</span><span class="p">(</span><span class="n">y_true</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">y_proba</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                <span class="n">target_fpr</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Comprehensive ROC analysis.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">thresholds</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_proba</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span>

    <span class="n">roc_auc</span> <span class="o">=</span> <span class="n">auc</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">)</span>

    <span class="n">j_scores</span> <span class="o">=</span> <span class="n">tpr</span> <span class="o">-</span> <span class="n">fpr</span>
    <span class="n">optimal_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">j_scores</span><span class="p">)</span>
    <span class="n">optimal_threshold</span> <span class="o">=</span> <span class="n">thresholds</span><span class="p">[</span><span class="n">optimal_idx</span><span class="p">]</span>

    <span class="n">target_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">fpr</span> <span class="o">-</span> <span class="n">target_fpr</span><span class="p">))</span>
    <span class="n">target_threshold</span> <span class="o">=</span> <span class="n">thresholds</span><span class="p">[</span><span class="n">target_idx</span><span class="p">]</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;auc&#39;</span><span class="p">:</span> <span class="n">roc_auc</span><span class="p">,</span>
        <span class="s1">&#39;optimal_threshold&#39;</span><span class="p">:</span> <span class="n">optimal_threshold</span><span class="p">,</span>
        <span class="s1">&#39;optimal_tpr&#39;</span><span class="p">:</span> <span class="n">tpr</span><span class="p">[</span><span class="n">optimal_idx</span><span class="p">],</span>
        <span class="s1">&#39;optimal_fpr&#39;</span><span class="p">:</span> <span class="n">fpr</span><span class="p">[</span><span class="n">optimal_idx</span><span class="p">],</span>
        <span class="s1">&#39;target_threshold&#39;</span><span class="p">:</span> <span class="n">target_threshold</span><span class="p">,</span>
        <span class="s1">&#39;target_tpr&#39;</span><span class="p">:</span> <span class="n">tpr</span><span class="p">[</span><span class="n">target_idx</span><span class="p">],</span>
        <span class="s1">&#39;fpr&#39;</span><span class="p">:</span> <span class="n">fpr</span><span class="p">,</span>
        <span class="s1">&#39;tpr&#39;</span><span class="p">:</span> <span class="n">tpr</span><span class="p">,</span>
        <span class="s1">&#39;thresholds&#39;</span><span class="p">:</span> <span class="n">thresholds</span>
    <span class="p">}</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h2>Section 3: Financial Metrics</h2>
<p>ML metrics don't tell the whole story - we need financial performance metrics.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Financial Metrics Overview</span>

<span class="n">financial_metrics</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">FINANCIAL METRICS FOR ML MODELS</span>
<span class="s2">================================</span>

<span class="s2">Why Financial Metrics Matter:</span>
<span class="s2">-----------------------------</span>
<span class="s2">- High accuracy doesn&#39;t mean profits</span>
<span class="s2">- Correct predictions on small moves vs wrong on big moves</span>
<span class="s2">- Transaction costs and slippage</span>
<span class="s2">- Risk-adjusted returns matter</span>

<span class="s2">Key Financial Metrics:</span>
<span class="s2">----------------------</span>
<span class="s2">1. Total Return</span>
<span class="s2">   Strategy return vs buy-and-hold</span>

<span class="s2">2. Sharpe Ratio</span>
<span class="s2">   (Return - Risk Free) / Volatility</span>
<span class="s2">   &gt; 1.0 is good, &gt; 2.0 is excellent</span>

<span class="s2">3. Maximum Drawdown</span>
<span class="s2">   Largest peak-to-trough decline</span>
<span class="s2">   Lower is better</span>

<span class="s2">4. Win Rate</span>
<span class="s2">   Percentage of profitable trades</span>
<span class="s2">   (Different from ML accuracy!)</span>

<span class="s2">5. Profit Factor</span>
<span class="s2">   Gross Profit / Gross Loss</span>
<span class="s2">   &gt; 1.0 means profitable</span>

<span class="s2">6. Average Win/Loss Ratio</span>
<span class="s2">   Average winning trade / Average losing trade</span>

<span class="s2">7. Calmar Ratio</span>
<span class="s2">   Annual Return / Max Drawdown</span>

<span class="s2">Accuracy vs Profitability:</span>
<span class="s2">--------------------------</span>
<span class="s2">  Model A: 60</span><span class="si">% a</span><span class="s2">ccuracy, predicts small moves correctly</span>
<span class="s2">  Model B: 45</span><span class="si">% a</span><span class="s2">ccuracy, predicts big moves correctly</span>
<span class="s2">  </span>
<span class="s2">  Model B can be MORE profitable!</span>
<span class="s2">&quot;&quot;&quot;</span>
<span class="nb">print</span><span class="p">(</span><span class="n">financial_metrics</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Calculate financial metrics for our model</span>

<span class="k">def</span> <span class="nf">calculate_financial_metrics</span><span class="p">(</span><span class="n">y_true</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                                 <span class="n">returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">risk_free</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.02</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate financial performance metrics.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        y_true: True labels</span>
<span class="sd">        y_pred: Predicted labels</span>
<span class="sd">        returns: Actual returns series (aligned with predictions)</span>
<span class="sd">        risk_free: Annual risk-free rate</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Align data</span>
    <span class="n">pred_series</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">y_pred</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">y_true</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
    <span class="n">aligned_returns</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">y_true</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
    
    <span class="c1"># Strategy returns (long when predicted up, flat when predicted down)</span>
    <span class="n">strategy_returns</span> <span class="o">=</span> <span class="n">pred_series</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">aligned_returns</span>
    <span class="n">strategy_returns</span> <span class="o">=</span> <span class="n">strategy_returns</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
    
    <span class="c1"># Buy and hold returns</span>
    <span class="n">bh_returns</span> <span class="o">=</span> <span class="n">aligned_returns</span>
    
    <span class="c1"># Cumulative returns</span>
    <span class="n">cum_strategy</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">strategy_returns</span><span class="p">)</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">cum_bh</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">bh_returns</span><span class="p">)</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
    
    <span class="c1"># Sharpe Ratio (annualized)</span>
    <span class="n">daily_rf</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">risk_free</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">252</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">excess_returns</span> <span class="o">=</span> <span class="n">strategy_returns</span> <span class="o">-</span> <span class="n">daily_rf</span>
    <span class="n">sharpe</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span> <span class="o">*</span> <span class="n">excess_returns</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">/</span> <span class="n">excess_returns</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
    
    <span class="c1"># Maximum Drawdown</span>
    <span class="n">cum_returns</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">strategy_returns</span><span class="p">)</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span>
    <span class="n">running_max</span> <span class="o">=</span> <span class="n">cum_returns</span><span class="o">.</span><span class="n">expanding</span><span class="p">()</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">drawdown</span> <span class="o">=</span> <span class="p">(</span><span class="n">cum_returns</span> <span class="o">-</span> <span class="n">running_max</span><span class="p">)</span> <span class="o">/</span> <span class="n">running_max</span>
    <span class="n">max_drawdown</span> <span class="o">=</span> <span class="n">drawdown</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    
    <span class="c1"># Win Rate (on actual trades)</span>
    <span class="n">trades</span> <span class="o">=</span> <span class="n">strategy_returns</span><span class="p">[</span><span class="n">pred_series</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">win_rate</span> <span class="o">=</span> <span class="p">(</span><span class="n">trades</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">trades</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
    
    <span class="c1"># Profit Factor</span>
    <span class="n">gains</span> <span class="o">=</span> <span class="n">trades</span><span class="p">[</span><span class="n">trades</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">losses</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">trades</span><span class="p">[</span><span class="n">trades</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
    <span class="n">profit_factor</span> <span class="o">=</span> <span class="n">gains</span> <span class="o">/</span> <span class="n">losses</span> <span class="k">if</span> <span class="n">losses</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
    
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;total_return&#39;</span><span class="p">:</span> <span class="n">cum_strategy</span><span class="p">,</span>
        <span class="s1">&#39;bh_return&#39;</span><span class="p">:</span> <span class="n">cum_bh</span><span class="p">,</span>
        <span class="s1">&#39;outperformance&#39;</span><span class="p">:</span> <span class="n">cum_strategy</span> <span class="o">-</span> <span class="n">cum_bh</span><span class="p">,</span>
        <span class="s1">&#39;sharpe_ratio&#39;</span><span class="p">:</span> <span class="n">sharpe</span><span class="p">,</span>
        <span class="s1">&#39;max_drawdown&#39;</span><span class="p">:</span> <span class="n">max_drawdown</span><span class="p">,</span>
        <span class="s1">&#39;win_rate&#39;</span><span class="p">:</span> <span class="n">win_rate</span><span class="p">,</span>
        <span class="s1">&#39;profit_factor&#39;</span><span class="p">:</span> <span class="n">profit_factor</span><span class="p">,</span>
        <span class="s1">&#39;n_trades&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">trades</span><span class="p">)</span>
    <span class="p">}</span>

<span class="c1"># Calculate</span>
<span class="n">returns</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">test_returns</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">y_test</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>

<span class="n">financial</span> <span class="o">=</span> <span class="n">calculate_financial_metrics</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">test_returns</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Financial Performance Metrics:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Total Return: </span><span class="si">{</span><span class="n">financial</span><span class="p">[</span><span class="s1">&#39;total_return&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Buy &amp; Hold:   </span><span class="si">{</span><span class="n">financial</span><span class="p">[</span><span class="s1">&#39;bh_return&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Outperformance: </span><span class="si">{</span><span class="n">financial</span><span class="p">[</span><span class="s1">&#39;outperformance&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">  Sharpe Ratio: </span><span class="si">{</span><span class="n">financial</span><span class="p">[</span><span class="s1">&#39;sharpe_ratio&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Max Drawdown: </span><span class="si">{</span><span class="n">financial</span><span class="p">[</span><span class="s1">&#39;max_drawdown&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">  Win Rate: </span><span class="si">{</span><span class="n">financial</span><span class="p">[</span><span class="s1">&#39;win_rate&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Profit Factor: </span><span class="si">{</span><span class="n">financial</span><span class="p">[</span><span class="s1">&#39;profit_factor&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Number of Trades: </span><span class="si">{</span><span class="n">financial</span><span class="p">[</span><span class="s1">&#39;n_trades&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Visualize strategy performance</span>

<span class="c1"># Calculate cumulative returns</span>
<span class="n">pred_series</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">y_pred</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">y_test</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
<span class="n">strategy_returns</span> <span class="o">=</span> <span class="n">pred_series</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">test_returns</span>
<span class="n">strategy_returns</span> <span class="o">=</span> <span class="n">strategy_returns</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

<span class="n">cum_strategy</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">strategy_returns</span><span class="p">)</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span>
<span class="n">cum_bh</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">test_returns</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">strategy_returns</span><span class="o">.</span><span class="n">index</span><span class="p">])</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

<span class="c1"># Cumulative returns</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">cum_strategy</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">cum_strategy</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Strategy&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">cum_bh</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">cum_bh</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Buy &amp; Hold&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Cumulative Return&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Strategy vs Buy &amp; Hold Performance&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="c1"># Drawdown</span>
<span class="n">running_max</span> <span class="o">=</span> <span class="n">cum_strategy</span><span class="o">.</span><span class="n">expanding</span><span class="p">()</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
<span class="n">drawdown</span> <span class="o">=</span> <span class="p">(</span><span class="n">cum_strategy</span> <span class="o">-</span> <span class="n">running_max</span><span class="p">)</span> <span class="o">/</span> <span class="n">running_max</span> <span class="o">*</span> <span class="mi">100</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">drawdown</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">drawdown</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">drawdown</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">drawdown</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Drawdown (%)&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Strategy Drawdown&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 7.3: Complete Financial Evaluator (Guided)</span>

<span class="k">def</span> <span class="nf">evaluate_trading_strategy</span><span class="p">(</span><span class="n">predictions</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span>
                               <span class="n">index</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DatetimeIndex</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Evaluate trading strategy with comprehensive metrics.</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        DataFrame with daily performance and summary statistics</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Create aligned series</span>
    <span class="n">pred_series</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">predictions</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">)</span>
    <span class="n">aligned_returns</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
    
    <span class="c1"># TODO: Calculate strategy returns</span>
    <span class="n">strategy_returns</span> <span class="o">=</span> <span class="n">pred_series</span><span class="o">.</span><span class="n">______</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">aligned_returns</span>
    
    <span class="c1"># Build results DataFrame</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">)</span>
    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;prediction&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pred_series</span>
    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;actual_return&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">aligned_returns</span>
    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;strategy_return&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">strategy_returns</span>
    
    <span class="c1"># TODO: Calculate cumulative returns</span>
    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;cum_strategy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;strategy_return&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">______</span><span class="p">()</span>
    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;cum_bh&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;actual_return&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">______</span><span class="p">()</span>
    
    <span class="c1"># Drawdown calculation</span>
    <span class="n">running_max</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;cum_strategy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">expanding</span><span class="p">()</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;drawdown&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;cum_strategy&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">running_max</span><span class="p">)</span> <span class="o">/</span> <span class="n">running_max</span>
    
    <span class="k">return</span> <span class="n">results</span>

<span class="c1"># Test the function</span>
<span class="c1"># eval_results = evaluate_trading_strategy(y_pred, test_returns, y_test.index)</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 7.3</summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">evaluate_trading_strategy</span><span class="p">(</span><span class="n">predictions</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span>
                               <span class="n">index</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DatetimeIndex</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Evaluate trading strategy with comprehensive metrics.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pred_series</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">predictions</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">)</span>
    <span class="n">aligned_returns</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>

    <span class="n">strategy_returns</span> <span class="o">=</span> <span class="n">pred_series</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">aligned_returns</span>

    <span class="n">results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">)</span>
    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;prediction&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pred_series</span>
    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;actual_return&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">aligned_returns</span>
    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;strategy_return&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">strategy_returns</span>

    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;cum_strategy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;strategy_return&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span>
    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;cum_bh&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;actual_return&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span>

    <span class="n">running_max</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;cum_strategy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">expanding</span><span class="p">()</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;drawdown&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;cum_strategy&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">running_max</span><span class="p">)</span> <span class="o">/</span> <span class="n">running_max</span>

    <span class="k">return</span> <span class="n">results</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h2>Section 4: Walk-Forward Validation</h2>
<p>Proper time-series validation for realistic performance assessment.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Walk-Forward Validation Concepts</span>

<span class="n">wf_concepts</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">WALK-FORWARD VALIDATION</span>
<span class="s2">=======================</span>

<span class="s2">Why Walk-Forward?</span>
<span class="s2">-----------------</span>
<span class="s2">- Standard k-fold CV uses future data to predict past (leakage!)</span>
<span class="s2">- Time series requires respecting temporal order</span>
<span class="s2">- Simulates real trading: train on past, predict future</span>

<span class="s2">Types of Time Series CV:</span>
<span class="s2">------------------------</span>

<span class="s2">1. Expanding Window:</span>
<span class="s2">   Train: [====]        ‚Üí Test: [=]</span>
<span class="s2">   Train: [=====]       ‚Üí Test: [=]</span>
<span class="s2">   Train: [======]      ‚Üí Test: [=]</span>

<span class="s2">2. Rolling Window (Fixed):</span>
<span class="s2">   Train: [====]        ‚Üí Test: [=]</span>
<span class="s2">         Train: [====]  ‚Üí Test: [=]</span>
<span class="s2">              Train: [====] ‚Üí Test: [=]</span>

<span class="s2">3. Purging &amp; Embargo:</span>
<span class="s2">   Train: [====]___Gap___Test: [=]</span>
<span class="s2">   - Purge: Remove training data too close to test</span>
<span class="s2">   - Embargo: Gap between train and test</span>
<span class="s2">   - Prevents label leakage in overlapping features</span>

<span class="s2">Walk-Forward Process:</span>
<span class="s2">---------------------</span>
<span class="s2">1. Define initial training window</span>
<span class="s2">2. Train model on training window</span>
<span class="s2">3. Make predictions on test window</span>
<span class="s2">4. Roll forward by step size</span>
<span class="s2">5. Repeat until end of data</span>
<span class="s2">6. Aggregate all out-of-sample predictions</span>
<span class="s2">&quot;&quot;&quot;</span>
<span class="nb">print</span><span class="p">(</span><span class="n">wf_concepts</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Walk-Forward Validation Implementation</span>

<span class="k">class</span> <span class="nc">WalkForwardValidator</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Walk-forward validation for time series ML.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">train_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">252</span><span class="p">,</span> <span class="n">test_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">21</span><span class="p">,</span>
                 <span class="n">step_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">21</span><span class="p">,</span> <span class="n">purge_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            train_size: Number of days in training window</span>
<span class="sd">            test_size: Number of days in test window</span>
<span class="sd">            step_size: Number of days to step forward</span>
<span class="sd">            purge_size: Number of days to purge between train and test</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_size</span> <span class="o">=</span> <span class="n">train_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_size</span> <span class="o">=</span> <span class="n">test_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">step_size</span> <span class="o">=</span> <span class="n">step_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">purge_size</span> <span class="o">=</span> <span class="n">purge_size</span>
        
    <span class="k">def</span> <span class="nf">split</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]:</span>
        <span class="sd">&quot;&quot;&quot;Generate train/test splits.&quot;&quot;&quot;</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="n">splits</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">start</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_size</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">purge_size</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_size</span> <span class="o">&lt;=</span> <span class="n">n</span><span class="p">:</span>
            <span class="n">train_end</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_size</span>
            <span class="n">test_start</span> <span class="o">=</span> <span class="n">train_end</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">purge_size</span>
            <span class="n">test_end</span> <span class="o">=</span> <span class="n">test_start</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_size</span>
            
            <span class="n">train_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">train_end</span><span class="p">)</span>
            <span class="n">test_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">test_start</span><span class="p">,</span> <span class="n">test_end</span><span class="p">)</span>
            
            <span class="n">splits</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">train_idx</span><span class="p">,</span> <span class="n">test_idx</span><span class="p">))</span>
            <span class="n">start</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step_size</span>
            
        <span class="k">return</span> <span class="n">splits</span>
    
    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">X</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span>
                 <span class="n">scaler</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Run walk-forward validation.&quot;&quot;&quot;</span>
        <span class="n">splits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        
        <span class="n">all_predictions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">all_actuals</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">all_probas</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">fold_metrics</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">train_idx</span><span class="p">,</span> <span class="n">test_idx</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">splits</span><span class="p">):</span>
            <span class="n">X_train</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_idx</span><span class="p">]</span>
            <span class="n">X_test</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">test_idx</span><span class="p">]</span>
            <span class="n">y_train</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_idx</span><span class="p">]</span>
            <span class="n">y_test</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">test_idx</span><span class="p">]</span>
            
            <span class="c1"># Scale if scaler provided</span>
            <span class="k">if</span> <span class="n">scaler</span><span class="p">:</span>
                <span class="n">scaler_fold</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="vm">__class__</span><span class="p">()</span>
                <span class="n">X_train</span> <span class="o">=</span> <span class="n">scaler_fold</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
                <span class="n">X_test</span> <span class="o">=</span> <span class="n">scaler_fold</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
            
            <span class="c1"># Train and predict</span>
            <span class="n">model_fold</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="o">**</span><span class="n">model</span><span class="o">.</span><span class="n">get_params</span><span class="p">())</span>
            <span class="n">model_fold</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
            
            <span class="n">pred</span> <span class="o">=</span> <span class="n">model_fold</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
            <span class="n">proba</span> <span class="o">=</span> <span class="n">model_fold</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
            
            <span class="n">all_predictions</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">pred</span><span class="p">)</span>
            <span class="n">all_actuals</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">y_test</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
            <span class="n">all_probas</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">proba</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span>
            
            <span class="n">fold_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;fold&#39;</span><span class="p">:</span> <span class="n">i</span><span class="p">,</span>
                <span class="s1">&#39;train_start&#39;</span><span class="p">:</span> <span class="n">X</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">train_idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
                <span class="s1">&#39;train_end&#39;</span><span class="p">:</span> <span class="n">X</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">train_idx</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span>
                <span class="s1">&#39;test_start&#39;</span><span class="p">:</span> <span class="n">X</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">test_idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
                <span class="s1">&#39;test_end&#39;</span><span class="p">:</span> <span class="n">X</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">test_idx</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span>
                <span class="s1">&#39;accuracy&#39;</span><span class="p">:</span> <span class="n">accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">pred</span><span class="p">),</span>
                <span class="s1">&#39;auc&#39;</span><span class="p">:</span> <span class="n">roc_auc_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">proba</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span>
            <span class="p">})</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;predictions&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">all_predictions</span><span class="p">),</span>
            <span class="s1">&#39;actuals&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">all_actuals</span><span class="p">),</span>
            <span class="s1">&#39;probas&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">all_probas</span><span class="p">),</span>
            <span class="s1">&#39;fold_metrics&#39;</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">fold_metrics</span><span class="p">)</span>
        <span class="p">}</span>

<span class="c1"># Run walk-forward validation</span>
<span class="n">X_full</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">])</span>
<span class="n">y_full</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span><span class="p">])</span>

<span class="n">wf</span> <span class="o">=</span> <span class="n">WalkForwardValidator</span><span class="p">(</span><span class="n">train_size</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">step_size</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">wf_results</span> <span class="o">=</span> <span class="n">wf</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">X_full</span><span class="p">,</span> <span class="n">y_full</span><span class="p">,</span> <span class="n">scaler</span><span class="o">=</span><span class="n">StandardScaler</span><span class="p">())</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Walk-Forward Validation:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Total folds: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">wf_results</span><span class="p">[</span><span class="s1">&#39;fold_metrics&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Total predictions: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">wf_results</span><span class="p">[</span><span class="s1">&#39;predictions&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">  Overall Accuracy: </span><span class="si">{</span><span class="n">accuracy_score</span><span class="p">(</span><span class="n">wf_results</span><span class="p">[</span><span class="s1">&#39;actuals&#39;</span><span class="p">],</span> <span class="n">wf_results</span><span class="p">[</span><span class="s1">&#39;predictions&#39;</span><span class="p">])</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Overall AUC: </span><span class="si">{</span><span class="n">roc_auc_score</span><span class="p">(</span><span class="n">wf_results</span><span class="p">[</span><span class="s1">&#39;actuals&#39;</span><span class="p">],</span> <span class="n">wf_results</span><span class="p">[</span><span class="s1">&#39;probas&#39;</span><span class="p">])</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Visualize walk-forward results</span>

<span class="n">fold_df</span> <span class="o">=</span> <span class="n">wf_results</span><span class="p">[</span><span class="s1">&#39;fold_metrics&#39;</span><span class="p">]</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

<span class="c1"># Accuracy across folds</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">fold_df</span><span class="p">[</span><span class="s1">&#39;fold&#39;</span><span class="p">],</span> <span class="n">fold_df</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;steelblue&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Random&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">fold_df</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Mean: </span><span class="si">{</span><span class="n">fold_df</span><span class="p">[</span><span class="s2">&quot;accuracy&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s1">.2%</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Fold&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Accuracy&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Walk-Forward Accuracy by Fold&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="c1"># AUC across folds</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">fold_df</span><span class="p">[</span><span class="s1">&#39;fold&#39;</span><span class="p">],</span> <span class="n">fold_df</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;forestgreen&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Random&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">fold_df</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Mean: </span><span class="si">{</span><span class="n">fold_df</span><span class="p">[</span><span class="s2">&quot;auc&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Fold&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;AUC&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Walk-Forward AUC by Fold&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Fold-level Metrics Summary:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Accuracy: </span><span class="si">{</span><span class="n">fold_df</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> +/- </span><span class="si">{</span><span class="n">fold_df</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  AUC: </span><span class="si">{</span><span class="n">fold_df</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> +/- </span><span class="si">{</span><span class="n">fold_df</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 7.4: Complete Model Evaluator (Open-ended)</span>
<span class="c1">#</span>
<span class="c1"># Build a ModelEvaluator class that:</span>
<span class="c1"># - Calculates all classification metrics (accuracy, precision, recall, F1, AUC)</span>
<span class="c1"># - Calculates financial metrics (return, Sharpe, drawdown, win rate)</span>
<span class="c1"># - Supports walk-forward validation</span>
<span class="c1"># - Generates a comprehensive report</span>
<span class="c1"># - Creates visualization plots (ROC, confusion matrix, returns)</span>
<span class="c1">#</span>
<span class="c1"># Your implementation:</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 7.4</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">ModelEvaluator</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Comprehensive model evaluation for trading ML.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">returns</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">X_train</span> <span class="o">=</span> <span class="n">X_train</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y_train</span> <span class="o">=</span> <span class="n">y_train</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">X_test</span> <span class="o">=</span> <span class="n">X_test</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y_test</span> <span class="o">=</span> <span class="n">y_test</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">returns</span> <span class="o">=</span> <span class="n">returns</span>

        <span class="c1"># Predictions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y_pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y_proba</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_classification_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate all classification metrics.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;accuracy&#39;</span><span class="p">:</span> <span class="n">accuracy_score</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_test</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_pred</span><span class="p">),</span>
            <span class="s1">&#39;precision&#39;</span><span class="p">:</span> <span class="n">precision_score</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_test</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_pred</span><span class="p">),</span>
            <span class="s1">&#39;recall&#39;</span><span class="p">:</span> <span class="n">recall_score</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_test</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_pred</span><span class="p">),</span>
            <span class="s1">&#39;f1&#39;</span><span class="p">:</span> <span class="n">f1_score</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_test</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_pred</span><span class="p">),</span>
            <span class="s1">&#39;roc_auc&#39;</span><span class="p">:</span> <span class="n">roc_auc_score</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_test</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_proba</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">get_financial_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate financial performance metrics.&quot;&quot;&quot;</span>
        <span class="n">test_returns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">returns</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">y_test</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
        <span class="n">pred_series</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_pred</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">y_test</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

        <span class="n">strategy_returns</span> <span class="o">=</span> <span class="n">pred_series</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">test_returns</span>
        <span class="n">strategy_returns</span> <span class="o">=</span> <span class="n">strategy_returns</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

        <span class="n">cum_return</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">strategy_returns</span><span class="p">)</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">sharpe</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span> <span class="o">*</span> <span class="n">strategy_returns</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">/</span> <span class="n">strategy_returns</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>

        <span class="n">cum_rets</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">strategy_returns</span><span class="p">)</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span>
        <span class="n">running_max</span> <span class="o">=</span> <span class="n">cum_rets</span><span class="o">.</span><span class="n">expanding</span><span class="p">()</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">max_dd</span> <span class="o">=</span> <span class="p">((</span><span class="n">cum_rets</span> <span class="o">-</span> <span class="n">running_max</span><span class="p">)</span> <span class="o">/</span> <span class="n">running_max</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>

        <span class="n">trades</span> <span class="o">=</span> <span class="n">strategy_returns</span><span class="p">[</span><span class="n">pred_series</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">win_rate</span> <span class="o">=</span> <span class="p">(</span><span class="n">trades</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">trades</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;total_return&#39;</span><span class="p">:</span> <span class="n">cum_return</span><span class="p">,</span>
            <span class="s1">&#39;sharpe_ratio&#39;</span><span class="p">:</span> <span class="n">sharpe</span><span class="p">,</span>
            <span class="s1">&#39;max_drawdown&#39;</span><span class="p">:</span> <span class="n">max_dd</span><span class="p">,</span>
            <span class="s1">&#39;win_rate&#39;</span><span class="p">:</span> <span class="n">win_rate</span><span class="p">,</span>
            <span class="s1">&#39;n_trades&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">trades</span><span class="p">)</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">walk_forward_validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">train_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">200</span><span class="p">,</span>
                               <span class="n">test_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Run walk-forward validation.&quot;&quot;&quot;</span>
        <span class="n">X_full</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">X_train</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">X_test</span><span class="p">])</span>
        <span class="n">y_full</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">y_train</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_test</span><span class="p">])</span>

        <span class="n">wf</span> <span class="o">=</span> <span class="n">WalkForwardValidator</span><span class="p">(</span><span class="n">train_size</span><span class="p">,</span> <span class="n">test_size</span><span class="p">,</span> <span class="n">test_size</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">wf</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">X_full</span><span class="p">,</span> <span class="n">y_full</span><span class="p">,</span> <span class="n">StandardScaler</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">generate_report</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Generate comprehensive report.&quot;&quot;&quot;</span>
        <span class="n">clf_metrics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_classification_metrics</span><span class="p">()</span>
        <span class="n">fin_metrics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_financial_metrics</span><span class="p">()</span>

        <span class="n">all_metrics</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">clf_metrics</span><span class="p">,</span> <span class="o">**</span><span class="n">fin_metrics</span><span class="p">}</span>

        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
            <span class="s1">&#39;Metric&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">all_metrics</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
            <span class="s1">&#39;Value&#39;</span><span class="p">:</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">v</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                      <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">all_metrics</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
        <span class="p">})</span>

    <span class="k">def</span> <span class="nf">plot_all</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generate all visualization plots.&quot;&quot;&quot;</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

        <span class="c1"># ROC Curve</span>
        <span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_test</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_proba</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="s1">&#39;b-&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;r--&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;ROC Curve (AUC=</span><span class="si">{</span><span class="n">auc</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">)</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;FPR&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;TPR&#39;</span><span class="p">)</span>

        <span class="c1"># Confusion Matrix</span>
        <span class="n">cm</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_test</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_pred</span><span class="p">)</span>
        <span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">annot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Blues&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Confusion Matrix&#39;</span><span class="p">)</span>

        <span class="c1"># Cumulative Returns</span>
        <span class="n">test_returns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">returns</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">y_test</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
        <span class="n">pred_series</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_pred</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">y_test</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="n">strategy_rets</span> <span class="o">=</span> <span class="p">(</span><span class="n">pred_series</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">test_returns</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">cum_strategy</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">strategy_rets</span><span class="p">)</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span>
        <span class="n">cum_bh</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">test_returns</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span>

        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">cum_strategy</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Strategy&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">cum_bh</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Buy &amp; Hold&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Cumulative Returns&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

        <span class="c1"># Metrics Summary</span>
        <span class="n">report</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_report</span><span class="p">()</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
        <span class="n">table</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">table</span><span class="p">(</span>
            <span class="n">cellText</span><span class="o">=</span><span class="n">report</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
            <span class="n">colLabels</span><span class="o">=</span><span class="n">report</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span>
            <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span>
            <span class="n">cellLoc</span><span class="o">=</span><span class="s1">&#39;left&#39;</span>
        <span class="p">)</span>
        <span class="n">table</span><span class="o">.</span><span class="n">auto_set_font_size</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">table</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Performance Metrics&#39;</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>


</details></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 7.5: Threshold Optimizer (Open-ended)</span>
<span class="c1">#</span>
<span class="c1"># Build a ThresholdOptimizer class that:</span>
<span class="c1"># - Takes predicted probabilities and actual labels</span>
<span class="c1"># - Finds optimal threshold for different objectives:</span>
<span class="c1">#   - Maximize accuracy</span>
<span class="c1">#   - Maximize F1 score</span>
<span class="c1">#   - Maximize financial returns</span>
<span class="c1">#   - Balance precision and recall</span>
<span class="c1"># - Visualizes trade-offs at different thresholds</span>
<span class="c1"># - Returns recommendations with reasoning</span>
<span class="c1">#</span>
<span class="c1"># Your implementation:</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 7.5</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">ThresholdOptimizer</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Optimize classification threshold for different objectives.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y_true</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">y_proba</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y_true</span> <span class="o">=</span> <span class="n">y_true</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y_proba</span> <span class="o">=</span> <span class="n">y_proba</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">y_proba</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">y_proba</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">returns</span> <span class="o">=</span> <span class="n">returns</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thresholds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.99</span><span class="p">,</span> <span class="mi">99</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_evaluate_threshold</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">threshold</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Evaluate metrics at given threshold.&quot;&quot;&quot;</span>
        <span class="n">y_pred</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_proba</span> <span class="o">&gt;=</span> <span class="n">threshold</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

        <span class="n">metrics</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;threshold&#39;</span><span class="p">:</span> <span class="n">threshold</span><span class="p">,</span>
            <span class="s1">&#39;accuracy&#39;</span><span class="p">:</span> <span class="n">accuracy_score</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">),</span>
            <span class="s1">&#39;precision&#39;</span><span class="p">:</span> <span class="n">precision_score</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
            <span class="s1">&#39;recall&#39;</span><span class="p">:</span> <span class="n">recall_score</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
            <span class="s1">&#39;f1&#39;</span><span class="p">:</span> <span class="n">f1_score</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
            <span class="s1">&#39;n_predictions&#39;</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="n">y_pred</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">returns</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pred_series</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">y_pred</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">y_true</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
            <span class="n">strat_rets</span> <span class="o">=</span> <span class="p">(</span><span class="n">pred_series</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">returns</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">y_true</span><span class="o">.</span><span class="n">index</span><span class="p">])</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
            <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;total_return&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">strat_rets</span><span class="p">)</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">strat_rets</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>

        <span class="k">return</span> <span class="n">metrics</span>

    <span class="k">def</span> <span class="nf">optimize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">objective</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;f1&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Find optimal threshold for given objective.&quot;&quot;&quot;</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_evaluate_threshold</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">thresholds</span><span class="p">]</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">objective</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">best_idx</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">objective</span><span class="p">]</span><span class="o">.</span><span class="n">idxmax</span><span class="p">()</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s1">&#39;optimal_threshold&#39;</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">best_idx</span><span class="p">,</span> <span class="s1">&#39;threshold&#39;</span><span class="p">],</span>
                <span class="s1">&#39;optimal_value&#39;</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">best_idx</span><span class="p">,</span> <span class="n">objective</span><span class="p">],</span>
                <span class="s1">&#39;metrics_at_optimal&#39;</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">best_idx</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(),</span>
                <span class="s1">&#39;all_results&#39;</span><span class="p">:</span> <span class="n">df</span>
            <span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown objective: </span><span class="si">{</span><span class="n">objective</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">plot_tradeoffs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Visualize metrics across thresholds.&quot;&quot;&quot;</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_evaluate_threshold</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">thresholds</span><span class="p">]</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>

        <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

        <span class="c1"># Accuracy and F1</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;threshold&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Accuracy&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;threshold&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;F1&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Threshold&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Accuracy and F1 vs Threshold&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

        <span class="c1"># Precision and Recall</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;threshold&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Precision&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;threshold&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;recall&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Recall&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Threshold&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Precision and Recall vs Threshold&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

        <span class="c1"># Number of predictions</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;threshold&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;n_predictions&#39;</span><span class="p">])</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Threshold&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Number of Positive Predictions&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Trade Frequency vs Threshold&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

        <span class="c1"># Returns if available</span>
        <span class="k">if</span> <span class="s1">&#39;total_return&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;threshold&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;total_return&#39;</span><span class="p">])</span>
            <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Threshold&#39;</span><span class="p">)</span>
            <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Total Return&#39;</span><span class="p">)</span>
            <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Returns vs Threshold&#39;</span><span class="p">)</span>
            <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">recommend</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Provide threshold recommendation.&quot;&quot;&quot;</span>
        <span class="n">acc_opt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span><span class="s1">&#39;accuracy&#39;</span><span class="p">)</span>
        <span class="n">f1_opt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span><span class="s1">&#39;f1&#39;</span><span class="p">)</span>

        <span class="n">rec</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;Threshold Recommendations:</span>

<span class="s2">1. For Maximum Accuracy: </span><span class="si">{</span><span class="n">acc_opt</span><span class="p">[</span><span class="s1">&#39;optimal_threshold&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"></span>
<span class="s2">   Accuracy: </span><span class="si">{</span><span class="n">acc_opt</span><span class="p">[</span><span class="s1">&#39;optimal_value&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"></span>

<span class="s2">2. For Maximum F1: </span><span class="si">{</span><span class="n">f1_opt</span><span class="p">[</span><span class="s1">&#39;optimal_threshold&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"></span>
<span class="s2">   F1: </span><span class="si">{</span><span class="n">f1_opt</span><span class="p">[</span><span class="s1">&#39;optimal_value&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">returns</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ret_opt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span><span class="s1">&#39;total_return&#39;</span><span class="p">)</span>
            <span class="n">rec</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>

<span class="s2">3. For Maximum Returns: </span><span class="si">{</span><span class="n">ret_opt</span><span class="p">[</span><span class="s1">&#39;optimal_threshold&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"></span>
<span class="s2">   Return: </span><span class="si">{</span><span class="n">ret_opt</span><span class="p">[</span><span class="s1">&#39;optimal_value&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="n">rec</span>
</code></pre></div>


</details></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 7.6: Model Comparison Dashboard (Open-ended)</span>
<span class="c1">#</span>
<span class="c1"># Build a ModelComparisonDashboard class that:</span>
<span class="c1"># - Takes multiple trained models</span>
<span class="c1"># - Compares them on all metrics (ML and financial)</span>
<span class="c1"># - Generates comparison tables and plots</span>
<span class="c1"># - Ranks models by different criteria</span>
<span class="c1"># - Provides a final recommendation</span>
<span class="c1"># - Exports results to a report</span>
<span class="c1">#</span>
<span class="c1"># Your implementation:</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 7.6</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">ModelComparisonDashboard</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Compare multiple models comprehensively.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">models</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">returns</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">models</span> <span class="o">=</span> <span class="n">models</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">X_train</span> <span class="o">=</span> <span class="n">X_train</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y_train</span> <span class="o">=</span> <span class="n">y_train</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">X_test</span> <span class="o">=</span> <span class="n">X_test</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y_test</span> <span class="o">=</span> <span class="n">y_test</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">returns</span> <span class="o">=</span> <span class="n">returns</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">evaluate_all</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Evaluate all models.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">model</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># Get predictions</span>
            <span class="n">y_pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X_test</span><span class="p">)</span>
            <span class="n">y_proba</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X_test</span><span class="p">)</span>

            <span class="c1"># ML metrics</span>
            <span class="n">ml_metrics</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;accuracy&#39;</span><span class="p">:</span> <span class="n">accuracy_score</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">),</span>
                <span class="s1">&#39;precision&#39;</span><span class="p">:</span> <span class="n">precision_score</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">),</span>
                <span class="s1">&#39;recall&#39;</span><span class="p">:</span> <span class="n">recall_score</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">),</span>
                <span class="s1">&#39;f1&#39;</span><span class="p">:</span> <span class="n">f1_score</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">),</span>
                <span class="s1">&#39;auc&#39;</span><span class="p">:</span> <span class="n">roc_auc_score</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_proba</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span>
            <span class="p">}</span>

            <span class="c1"># Financial metrics</span>
            <span class="n">test_returns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">returns</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">y_test</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
            <span class="n">pred_series</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">y_pred</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">y_test</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
            <span class="n">strat_rets</span> <span class="o">=</span> <span class="p">(</span><span class="n">pred_series</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">test_returns</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

            <span class="n">fin_metrics</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;total_return&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">strat_rets</span><span class="p">)</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
                <span class="s1">&#39;sharpe&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span> <span class="o">*</span> <span class="n">strat_rets</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">/</span> <span class="n">strat_rets</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="k">if</span> <span class="n">strat_rets</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s1">&#39;win_rate&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">strat_rets</span><span class="p">[</span><span class="n">pred_series</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="p">}</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">ml_metrics</span><span class="p">,</span> <span class="o">**</span><span class="n">fin_metrics</span><span class="p">}</span>

        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">get_comparison_table</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get comparison table.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

    <span class="k">def</span> <span class="nf">rank_models</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">by</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;f1&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Rank models by specific metric.&quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_comparison_table</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">plot_comparison</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Plot model comparison.&quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_comparison_table</span><span class="p">()</span>

        <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

        <span class="c1"># Accuracy comparison</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;steelblue&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Accuracy&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>

        <span class="c1"># AUC comparison</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;forestgreen&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;AUC&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>

        <span class="c1"># Returns comparison</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;total_return&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkorange&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Total Return&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>

        <span class="c1"># Sharpe comparison</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;sharpe&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;purple&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Sharpe Ratio&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axes</span><span class="o">.</span><span class="n">flat</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">recommend</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Recommend best model.&quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_comparison_table</span><span class="p">()</span>

        <span class="n">best_ml</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">idxmax</span><span class="p">()</span>
        <span class="n">best_financial</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;total_return&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">idxmax</span><span class="p">()</span>

        <span class="c1"># Score models on normalized metrics</span>
        <span class="n">normalized</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span> <span class="o">-</span> <span class="n">df</span><span class="o">.</span><span class="n">min</span><span class="p">())</span> <span class="o">/</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">df</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
        <span class="n">combined_score</span> <span class="o">=</span> <span class="n">normalized</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">best_overall</span> <span class="o">=</span> <span class="n">combined_score</span><span class="o">.</span><span class="n">idxmax</span><span class="p">()</span>

        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;Model Recommendations:</span>

<span class="s2">Best ML Performance: </span><span class="si">{</span><span class="n">best_ml</span><span class="si">}</span><span class="s2"></span>
<span class="s2">  F1 Score: </span><span class="si">{</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">best_ml</span><span class="p">,</span> <span class="s1">&#39;f1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"></span>
<span class="s2">  AUC: </span><span class="si">{</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">best_ml</span><span class="p">,</span> <span class="s1">&#39;auc&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"></span>

<span class="s2">Best Financial Performance: </span><span class="si">{</span><span class="n">best_financial</span><span class="si">}</span><span class="s2"></span>
<span class="s2">  Total Return: </span><span class="si">{</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">best_financial</span><span class="p">,</span> <span class="s1">&#39;total_return&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"></span>
<span class="s2">  Sharpe Ratio: </span><span class="si">{</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">best_financial</span><span class="p">,</span> <span class="s1">&#39;sharpe&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"></span>

<span class="s2">Best Overall (Balanced): </span><span class="si">{</span><span class="n">best_overall</span><span class="si">}</span><span class="s2"></span>
<span class="s2">  Combined Score: </span><span class="si">{</span><span class="n">combined_score</span><span class="p">[</span><span class="n">best_overall</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">export_report</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;model_comparison.csv&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Export comparison to CSV.&quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_comparison_table</span><span class="p">()</span>
        <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Report exported to </span><span class="si">{</span><span class="n">filepath</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell module-project"><hr />
<h2>Module Project: Complete Model Evaluation Pipeline</h2>
<p>Build a comprehensive evaluation system that combines all concepts.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">MLTradingEvaluator</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Complete evaluation pipeline for ML trading models.</span>
<span class="sd">    </span>
<span class="sd">    Combines classification metrics, financial metrics,</span>
<span class="sd">    walk-forward validation, and threshold optimization.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">evaluation_results</span> <span class="o">=</span> <span class="p">{}</span>
        
    <span class="k">def</span> <span class="nf">prepare_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">test_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Prepare features and split data.&quot;&quot;&quot;</span>
        <span class="c1"># Features</span>
        <span class="n">features</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;returns&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;volatility&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;returns&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
        
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">]:</span>
            <span class="n">features</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;momentum_</span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">50</span><span class="p">]:</span>
            <span class="n">ma</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="n">features</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;dist_ma</span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">ma</span><span class="p">)</span> <span class="o">/</span> <span class="n">ma</span>
        
        <span class="n">delta</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span>
        <span class="n">gain</span> <span class="o">=</span> <span class="p">(</span><span class="n">delta</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">delta</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">14</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">delta</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">delta</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">14</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;rsi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">-</span> <span class="p">(</span><span class="mi">100</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">gain</span> <span class="o">/</span> <span class="n">loss</span><span class="p">))</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;volume_ratio&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Volume&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Volume&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        
        <span class="c1"># Target and returns</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">features</span><span class="p">[</span><span class="s1">&#39;returns&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;next_return&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;returns&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        
        <span class="n">features</span> <span class="o">=</span> <span class="n">features</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
        
        <span class="c1"># Feature columns</span>
        <span class="n">feature_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">features</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">,</span> <span class="s1">&#39;next_return&#39;</span><span class="p">]]</span>
        
        <span class="c1"># Split</span>
        <span class="n">split_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">features</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">test_size</span><span class="p">))</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">X_train</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="n">feature_cols</span><span class="p">][:</span><span class="n">split_idx</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">X_test</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="n">feature_cols</span><span class="p">][</span><span class="n">split_idx</span><span class="p">:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y_train</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">][:</span><span class="n">split_idx</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y_test</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">][</span><span class="n">split_idx</span><span class="p">:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">returns</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;next_return&#39;</span><span class="p">]</span>
        
        <span class="k">return</span> <span class="bp">self</span>
    
    <span class="k">def</span> <span class="nf">train_and_predict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Train model and get predictions.&quot;&quot;&quot;</span>
        <span class="n">X_train_scaled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X_train</span><span class="p">)</span>
        <span class="n">X_test_scaled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X_test</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_scaled</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_train</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">y_pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test_scaled</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y_proba</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test_scaled</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="bp">self</span>
    
    <span class="k">def</span> <span class="nf">evaluate_classification</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate classification metrics.&quot;&quot;&quot;</span>
        <span class="n">metrics</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;accuracy&#39;</span><span class="p">:</span> <span class="n">accuracy_score</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_test</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_pred</span><span class="p">),</span>
            <span class="s1">&#39;precision&#39;</span><span class="p">:</span> <span class="n">precision_score</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_test</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_pred</span><span class="p">),</span>
            <span class="s1">&#39;recall&#39;</span><span class="p">:</span> <span class="n">recall_score</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_test</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_pred</span><span class="p">),</span>
            <span class="s1">&#39;f1&#39;</span><span class="p">:</span> <span class="n">f1_score</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_test</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_pred</span><span class="p">),</span>
            <span class="s1">&#39;roc_auc&#39;</span><span class="p">:</span> <span class="n">roc_auc_score</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_test</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_proba</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">evaluation_results</span><span class="p">[</span><span class="s1">&#39;classification&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">metrics</span>
        <span class="k">return</span> <span class="n">metrics</span>
    
    <span class="k">def</span> <span class="nf">evaluate_financial</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate financial metrics.&quot;&quot;&quot;</span>
        <span class="n">test_returns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">returns</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">y_test</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
        <span class="n">pred_series</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_pred</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">y_test</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        
        <span class="n">strategy_returns</span> <span class="o">=</span> <span class="n">pred_series</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">test_returns</span>
        <span class="n">strategy_returns</span> <span class="o">=</span> <span class="n">strategy_returns</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
        
        <span class="n">cum_return</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">strategy_returns</span><span class="p">)</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">cum_bh</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">test_returns</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">strategy_returns</span><span class="o">.</span><span class="n">index</span><span class="p">])</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
        
        <span class="n">sharpe</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span> <span class="o">*</span> <span class="n">strategy_returns</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">/</span> <span class="n">strategy_returns</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
        
        <span class="n">cum_rets</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">strategy_returns</span><span class="p">)</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span>
        <span class="n">running_max</span> <span class="o">=</span> <span class="n">cum_rets</span><span class="o">.</span><span class="n">expanding</span><span class="p">()</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">max_dd</span> <span class="o">=</span> <span class="p">((</span><span class="n">cum_rets</span> <span class="o">-</span> <span class="n">running_max</span><span class="p">)</span> <span class="o">/</span> <span class="n">running_max</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        
        <span class="n">trades</span> <span class="o">=</span> <span class="n">strategy_returns</span><span class="p">[</span><span class="n">pred_series</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">win_rate</span> <span class="o">=</span> <span class="p">(</span><span class="n">trades</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">trades</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
        
        <span class="n">metrics</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;total_return&#39;</span><span class="p">:</span> <span class="n">cum_return</span><span class="p">,</span>
            <span class="s1">&#39;buy_hold_return&#39;</span><span class="p">:</span> <span class="n">cum_bh</span><span class="p">,</span>
            <span class="s1">&#39;outperformance&#39;</span><span class="p">:</span> <span class="n">cum_return</span> <span class="o">-</span> <span class="n">cum_bh</span><span class="p">,</span>
            <span class="s1">&#39;sharpe_ratio&#39;</span><span class="p">:</span> <span class="n">sharpe</span><span class="p">,</span>
            <span class="s1">&#39;max_drawdown&#39;</span><span class="p">:</span> <span class="n">max_dd</span><span class="p">,</span>
            <span class="s1">&#39;win_rate&#39;</span><span class="p">:</span> <span class="n">win_rate</span><span class="p">,</span>
            <span class="s1">&#39;n_trades&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">trades</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">evaluation_results</span><span class="p">[</span><span class="s1">&#39;financial&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">metrics</span>
        <span class="k">return</span> <span class="n">metrics</span>
    
    <span class="k">def</span> <span class="nf">run_full_evaluation</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Run complete evaluation.&quot;&quot;&quot;</span>
        <span class="n">clf_metrics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluate_classification</span><span class="p">()</span>
        <span class="n">fin_metrics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluate_financial</span><span class="p">()</span>
        
        <span class="n">all_metrics</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">clf_metrics</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">all_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;Category&#39;</span><span class="p">:</span> <span class="s1">&#39;Classification&#39;</span><span class="p">,</span> <span class="s1">&#39;Metric&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="s1">&#39;Value&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">value</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">})</span>
        
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">fin_metrics</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
                <span class="n">all_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;Category&#39;</span><span class="p">:</span> <span class="s1">&#39;Financial&#39;</span><span class="p">,</span> <span class="s1">&#39;Metric&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="s1">&#39;Value&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">value</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">})</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">all_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;Category&#39;</span><span class="p">:</span> <span class="s1">&#39;Financial&#39;</span><span class="p">,</span> <span class="s1">&#39;Metric&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="s1">&#39;Value&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)})</span>
        
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">all_metrics</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">plot_evaluation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create evaluation visualization.&quot;&quot;&quot;</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
        
        <span class="c1"># ROC Curve</span>
        <span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_test</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_proba</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="s1">&#39;b-&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;AUC = </span><span class="si">{</span><span class="n">auc</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">)</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;r--&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;ROC Curve&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;False Positive Rate&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;True Positive Rate&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
        
        <span class="c1"># Confusion Matrix</span>
        <span class="n">cm</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_test</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_pred</span><span class="p">)</span>
        <span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">annot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Blues&#39;</span><span class="p">,</span>
                   <span class="n">xticklabels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;DOWN&#39;</span><span class="p">,</span> <span class="s1">&#39;UP&#39;</span><span class="p">],</span> <span class="n">yticklabels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;DOWN&#39;</span><span class="p">,</span> <span class="s1">&#39;UP&#39;</span><span class="p">])</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Confusion Matrix&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Predicted&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Actual&#39;</span><span class="p">)</span>
        
        <span class="c1"># Cumulative Returns</span>
        <span class="n">test_returns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">returns</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">y_test</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
        <span class="n">pred_series</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_pred</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">y_test</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="n">strategy_rets</span> <span class="o">=</span> <span class="p">(</span><span class="n">pred_series</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">test_returns</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        
        <span class="n">cum_strategy</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">strategy_rets</span><span class="p">)</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span>
        <span class="n">cum_bh</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">test_returns</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span>
        
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">cum_strategy</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">cum_strategy</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Strategy&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">cum_bh</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">cum_bh</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Buy &amp; Hold&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Cumulative Returns&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Cumulative Return&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
        
        <span class="c1"># Metrics Summary</span>
        <span class="n">metrics_text</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">cat</span><span class="p">,</span> <span class="n">mets</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluation_results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">metrics_text</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">cat</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">mets</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
                    <span class="n">metrics_text</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">v</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">metrics_text</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">metrics_text</span><span class="p">),</span> <span class="n">transform</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span>
                       <span class="n">fontsize</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span> <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span> <span class="n">fontfamily</span><span class="o">=</span><span class="s1">&#39;monospace&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Evaluation Summary&#39;</span><span class="p">)</span>
        
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Run the complete evaluation pipeline</span>

<span class="c1"># Get data</span>
<span class="n">ticker</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">Ticker</span><span class="p">(</span><span class="s2">&quot;SPY&quot;</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">ticker</span><span class="o">.</span><span class="n">history</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="s2">&quot;2y&quot;</span><span class="p">)</span>

<span class="c1"># Create evaluator</span>
<span class="n">evaluator</span> <span class="o">=</span> <span class="n">MLTradingEvaluator</span><span class="p">(</span>
    <span class="n">RandomForestClassifier</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
<span class="p">)</span>

<span class="c1"># Run pipeline</span>
<span class="n">evaluator</span><span class="o">.</span><span class="n">prepare_data</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="n">evaluator</span><span class="o">.</span><span class="n">train_and_predict</span><span class="p">()</span>

<span class="c1"># Get full evaluation</span>
<span class="n">report</span> <span class="o">=</span> <span class="n">evaluator</span><span class="o">.</span><span class="n">run_full_evaluation</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Full Evaluation Report:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">report</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Visualize evaluation</span>

<span class="n">evaluator</span><span class="o">.</span><span class="n">plot_evaluation</span><span class="p">()</span>
</code></pre></div>
<div class="md-cell key-takeaways"><hr />
<h2>Key Takeaways</h2>
<ol>
<li>
<p><strong>Accuracy alone is insufficient</strong> for evaluating trading models; always use precision, recall, F1, and AUC</p>
</li>
<li>
<p><strong>Confusion matrices</strong> reveal error patterns that summary metrics hide</p>
</li>
<li>
<p><strong>ROC curves and AUC</strong> provide threshold-independent model comparison</p>
</li>
<li>
<p><strong>Financial metrics</strong> (returns, Sharpe, drawdown) matter more than ML metrics for trading</p>
</li>
<li>
<p><strong>Walk-forward validation</strong> simulates real trading conditions and prevents overfitting</p>
</li>
<li>
<p><strong>Threshold optimization</strong> can significantly impact trading performance</p>
</li>
<li>
<p><strong>Compare multiple metrics</strong> across different objectives (ML vs financial) before selecting a model</p>
</li>
</ol>
<hr />
<p><strong>Next: Module 8 - Regression Models</strong> (Return prediction, volatility forecasting)</p></div>
        <div class="nav-buttons">
            <button class="nav-btn prev-btn disabled" type="button">
                <span class="nav-btn-label">‚Üê Previous</span>
                <span class="nav-btn-name"></span>
            </button>
            <button class="nav-btn next-btn disabled" type="button">
                <span class="nav-btn-label">Next ‚Üí</span>
                <span class="nav-btn-name"></span>
            </button>
        </div>
        </div>
<div class="module-section" data-idx="8"><div class="md-cell module-header"><h1>Module 8: Regression Models</h1>
<h2>Part 3: Advanced Techniques</h2>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Duration</th>
<th>Exercises</th>
<th>Prerequisites</th>
</tr>
</thead>
<tbody>
<tr>
<td>~2.5 hours</td>
<td>6</td>
<td>Modules 1-7</td>
</tr>
</tbody>
</table></div>
<h3>Learning Objectives</h3>
<p>By the end of this module, you will be able to:
- Apply regression models for return prediction
- Forecast volatility using various techniques
- Implement quantile regression for tail risk
- Use ensemble methods for regression
- Evaluate regression models with appropriate metrics</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>

<span class="c1"># Regression models</span>
<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">LinearRegression</span><span class="p">,</span> <span class="n">Ridge</span><span class="p">,</span> <span class="n">Lasso</span><span class="p">,</span> <span class="n">ElasticNet</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">RandomForestRegressor</span><span class="p">,</span> <span class="n">GradientBoostingRegressor</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">sklearn.svm</span> <span class="kn">import</span> <span class="n">SVR</span>
<span class="kn">from</span> <span class="nn">sklearn.neural_network</span> <span class="kn">import</span> <span class="n">MLPRegressor</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">StandardScaler</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">TimeSeriesSplit</span><span class="p">,</span> <span class="n">cross_val_score</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">mean_squared_error</span><span class="p">,</span> <span class="n">mean_absolute_error</span><span class="p">,</span> <span class="n">r2_score</span>
<span class="p">)</span>

<span class="kn">import</span> <span class="nn">yfinance</span> <span class="k">as</span> <span class="nn">yf</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Module 8: Regression Models&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">40</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Prepare regression data</span>

<span class="k">def</span> <span class="nf">prepare_regression_data</span><span class="p">(</span><span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;SPY&quot;</span><span class="p">,</span> <span class="n">period</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;2y&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Prepare features and continuous target for regression.&quot;&quot;&quot;</span>
    
    <span class="n">ticker</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">Ticker</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">ticker</span><span class="o">.</span><span class="n">history</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="n">period</span><span class="p">)</span>
    
    <span class="c1"># Features</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;returns&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;volatility&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;returns&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
    
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">]:</span>
        <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;momentum_</span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">50</span><span class="p">]:</span>
        <span class="n">ma</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;dist_ma</span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">ma</span><span class="p">)</span> <span class="o">/</span> <span class="n">ma</span>
    
    <span class="n">delta</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span>
    <span class="n">gain</span> <span class="o">=</span> <span class="p">(</span><span class="n">delta</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">delta</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">14</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">delta</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">delta</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">14</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;rsi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">-</span> <span class="p">(</span><span class="mi">100</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">gain</span> <span class="o">/</span> <span class="n">loss</span><span class="p">))</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;volume_ratio&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Volume&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Volume&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    
    <span class="c1"># Continuous target: next day return</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;target_return&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;returns&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="c1"># Alternative target: next 5-day return</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;target_5d_return&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">)</span>
    
    <span class="c1"># Volatility target</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;target_volatility&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;volatility&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
    
    <span class="n">features</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;volatility&#39;</span><span class="p">,</span> <span class="s1">&#39;momentum_5&#39;</span><span class="p">,</span> <span class="s1">&#39;momentum_10&#39;</span><span class="p">,</span> <span class="s1">&#39;momentum_20&#39;</span><span class="p">,</span>
                <span class="s1">&#39;dist_ma5&#39;</span><span class="p">,</span> <span class="s1">&#39;dist_ma20&#39;</span><span class="p">,</span> <span class="s1">&#39;dist_ma50&#39;</span><span class="p">,</span> <span class="s1">&#39;rsi&#39;</span><span class="p">,</span> <span class="s1">&#39;volume_ratio&#39;</span><span class="p">]</span>
    
    <span class="k">return</span> <span class="n">df</span><span class="p">,</span> <span class="n">features</span>

<span class="c1"># Load data</span>
<span class="n">df</span><span class="p">,</span> <span class="n">feature_cols</span> <span class="o">=</span> <span class="n">prepare_regression_data</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Data shape: </span><span class="si">{</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Features: </span><span class="si">{</span><span class="n">feature_cols</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><hr />
<h2>Section 1: Linear Regression Models</h2>
<p>Linear models are simple, interpretable, and often surprisingly effective for financial prediction.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Linear Regression Concepts</span>

<span class="n">linear_concepts</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">LINEAR REGRESSION FOR FINANCE</span>
<span class="s2">=============================</span>

<span class="s2">Basic Model:</span>
<span class="s2">------------</span>
<span class="s2">  y = Œ≤‚ÇÄ + Œ≤‚ÇÅx‚ÇÅ + Œ≤‚ÇÇx‚ÇÇ + ... + Œ≤‚Çôx‚Çô + Œµ</span>

<span class="s2">  Where:</span>
<span class="s2">  - y: Target (e.g., next day return)</span>
<span class="s2">  - x·µ¢: Features (momentum, volatility, etc.)</span>
<span class="s2">  - Œ≤·µ¢: Coefficients to learn</span>
<span class="s2">  - Œµ: Error term</span>

<span class="s2">Regularization Types:</span>
<span class="s2">---------------------</span>
<span class="s2">1. Ridge (L2): Shrinks coefficients, handles multicollinearity</span>
<span class="s2">   Loss = MSE + Œ± * Œ£Œ≤·µ¢¬≤</span>

<span class="s2">2. Lasso (L1): Can zero out coefficients (feature selection)</span>
<span class="s2">   Loss = MSE + Œ± * Œ£|Œ≤·µ¢|</span>

<span class="s2">3. ElasticNet: Combination of L1 and L2</span>
<span class="s2">   Loss = MSE + Œ± * (r * Œ£|Œ≤·µ¢| + (1-r) * Œ£Œ≤·µ¢¬≤)</span>

<span class="s2">Advantages:</span>
<span class="s2">-----------</span>
<span class="s2">+ Interpretable coefficients</span>
<span class="s2">+ Fast to train and predict</span>
<span class="s2">+ Regularization prevents overfitting</span>

<span class="s2">Disadvantages:</span>
<span class="s2">--------------</span>
<span class="s2">- Assumes linear relationships</span>
<span class="s2">- May underfit complex patterns</span>
<span class="s2">- Sensitive to outliers</span>

<span class="s2">Financial Considerations:</span>
<span class="s2">-------------------------</span>
<span class="s2">- Returns are often nearly unpredictable (efficient markets)</span>
<span class="s2">- Small R¬≤ is normal (0.01-0.05 can be profitable)</span>
<span class="s2">- Coefficients show factor exposure</span>
<span class="s2">&quot;&quot;&quot;</span>
<span class="nb">print</span><span class="p">(</span><span class="n">linear_concepts</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Prepare data for regression</span>

<span class="n">X</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">feature_cols</span><span class="p">]</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;target_return&#39;</span><span class="p">]</span>

<span class="c1"># Time series split</span>
<span class="n">split_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.8</span><span class="p">)</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span> <span class="o">=</span> <span class="n">X</span><span class="p">[:</span><span class="n">split_idx</span><span class="p">],</span> <span class="n">X</span><span class="p">[</span><span class="n">split_idx</span><span class="p">:]</span>
<span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">y</span><span class="p">[:</span><span class="n">split_idx</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">split_idx</span><span class="p">:]</span>

<span class="c1"># Scale features</span>
<span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
<span class="n">X_train_scaled</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
<span class="n">X_test_scaled</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Training: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span><span class="si">}</span><span class="s2">, Test: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Target Statistics:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Mean: </span><span class="si">{</span><span class="n">y_train</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Std: </span><span class="si">{</span><span class="n">y_train</span><span class="o">.</span><span class="n">std</span><span class="p">()</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Basic Linear Regression</span>

<span class="n">lr</span> <span class="o">=</span> <span class="n">LinearRegression</span><span class="p">()</span>
<span class="n">lr</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_scaled</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

<span class="n">y_pred_lr</span> <span class="o">=</span> <span class="n">lr</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test_scaled</span><span class="p">)</span>

<span class="c1"># Metrics</span>
<span class="n">mse</span> <span class="o">=</span> <span class="n">mean_squared_error</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_lr</span><span class="p">)</span>
<span class="n">rmse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mse</span><span class="p">)</span>
<span class="n">mae</span> <span class="o">=</span> <span class="n">mean_absolute_error</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_lr</span><span class="p">)</span>
<span class="n">r2</span> <span class="o">=</span> <span class="n">r2_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_lr</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Linear Regression Results:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  RMSE: </span><span class="si">{</span><span class="n">rmse</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  MAE:  </span><span class="si">{</span><span class="n">mae</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  R¬≤:   </span><span class="si">{</span><span class="n">r2</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Coefficients</span>
<span class="n">coef_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s1">&#39;feature&#39;</span><span class="p">:</span> <span class="n">feature_cols</span><span class="p">,</span>
    <span class="s1">&#39;coefficient&#39;</span><span class="p">:</span> <span class="n">lr</span><span class="o">.</span><span class="n">coef_</span>
<span class="p">})</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;coefficient&#39;</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="nb">abs</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Feature Coefficients:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">coef_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;feature&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">15s</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;coefficient&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">+.6f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Compare regularization methods</span>

<span class="n">models</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;OLS&#39;</span><span class="p">:</span> <span class="n">LinearRegression</span><span class="p">(),</span>
    <span class="s1">&#39;Ridge&#39;</span><span class="p">:</span> <span class="n">Ridge</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">1.0</span><span class="p">),</span>
    <span class="s1">&#39;Lasso&#39;</span><span class="p">:</span> <span class="n">Lasso</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.001</span><span class="p">),</span>
    <span class="s1">&#39;ElasticNet&#39;</span><span class="p">:</span> <span class="n">ElasticNet</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">l1_ratio</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="p">}</span>

<span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">models</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_scaled</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
    <span class="n">y_pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test_scaled</span><span class="p">)</span>
    
    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
        <span class="s1">&#39;Model&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
        <span class="s1">&#39;RMSE&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mean_squared_error</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)),</span>
        <span class="s1">&#39;MAE&#39;</span><span class="p">:</span> <span class="n">mean_absolute_error</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">),</span>
        <span class="s1">&#39;R2&#39;</span><span class="p">:</span> <span class="n">r2_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
    <span class="p">})</span>

<span class="n">results_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Linear Models Comparison:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results_df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 8.1: Regularization Tuner (Guided)</span>

<span class="k">def</span> <span class="nf">tune_ridge_alpha</span><span class="p">(</span><span class="n">X_train</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">y_train</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span>
                     <span class="n">alphas</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                     <span class="n">cv_folds</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Tune Ridge regression alpha using time series CV.</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        Dictionary with best alpha and cross-validation results</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">alphas</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">alphas</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.001</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">,</span> <span class="mf">100.0</span><span class="p">]</span>
    
    <span class="c1"># TODO: Create time series cross-validator</span>
    <span class="n">tscv</span> <span class="o">=</span> <span class="n">______</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="n">cv_folds</span><span class="p">)</span>
    
    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">best_score</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;-inf&#39;</span><span class="p">)</span>
    <span class="n">best_alpha</span> <span class="o">=</span> <span class="kc">None</span>
    
    <span class="k">for</span> <span class="n">alpha</span> <span class="ow">in</span> <span class="n">alphas</span><span class="p">:</span>
        <span class="c1"># TODO: Create Ridge model with current alpha</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">______</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="n">______</span><span class="p">)</span>
        
        <span class="c1"># TODO: Get cross-validation scores (negative MSE)</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="n">______</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="n">tscv</span><span class="p">,</span> 
                              <span class="n">scoring</span><span class="o">=</span><span class="s1">&#39;neg_mean_squared_error&#39;</span><span class="p">)</span>
        <span class="n">mean_score</span> <span class="o">=</span> <span class="n">scores</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        
        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;alpha&#39;</span><span class="p">:</span> <span class="n">alpha</span><span class="p">,</span>
            <span class="s1">&#39;mean_neg_mse&#39;</span><span class="p">:</span> <span class="n">mean_score</span><span class="p">,</span>
            <span class="s1">&#39;std_neg_mse&#39;</span><span class="p">:</span> <span class="n">scores</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
        <span class="p">})</span>
        
        <span class="k">if</span> <span class="n">mean_score</span> <span class="o">&gt;</span> <span class="n">best_score</span><span class="p">:</span>
            <span class="n">best_score</span> <span class="o">=</span> <span class="n">mean_score</span>
            <span class="n">best_alpha</span> <span class="o">=</span> <span class="n">alpha</span>
    
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;best_alpha&#39;</span><span class="p">:</span> <span class="n">best_alpha</span><span class="p">,</span>
        <span class="s1">&#39;best_score&#39;</span><span class="p">:</span> <span class="n">best_score</span><span class="p">,</span>
        <span class="s1">&#39;all_results&#39;</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
    <span class="p">}</span>

<span class="c1"># Test the function</span>
<span class="c1"># ridge_tuning = tune_ridge_alpha(X_train_scaled, y_train)</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 8.1</summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">tune_ridge_alpha</span><span class="p">(</span><span class="n">X_train</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">y_train</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span>
                     <span class="n">alphas</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                     <span class="n">cv_folds</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Tune Ridge regression alpha using time series CV.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">alphas</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">alphas</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.001</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">,</span> <span class="mf">100.0</span><span class="p">]</span>

    <span class="n">tscv</span> <span class="o">=</span> <span class="n">TimeSeriesSplit</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="n">cv_folds</span><span class="p">)</span>

    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">best_score</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;-inf&#39;</span><span class="p">)</span>
    <span class="n">best_alpha</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">for</span> <span class="n">alpha</span> <span class="ow">in</span> <span class="n">alphas</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Ridge</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">)</span>

        <span class="n">scores</span> <span class="o">=</span> <span class="n">cross_val_score</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="n">tscv</span><span class="p">,</span> 
                              <span class="n">scoring</span><span class="o">=</span><span class="s1">&#39;neg_mean_squared_error&#39;</span><span class="p">)</span>
        <span class="n">mean_score</span> <span class="o">=</span> <span class="n">scores</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;alpha&#39;</span><span class="p">:</span> <span class="n">alpha</span><span class="p">,</span>
            <span class="s1">&#39;mean_neg_mse&#39;</span><span class="p">:</span> <span class="n">mean_score</span><span class="p">,</span>
            <span class="s1">&#39;std_neg_mse&#39;</span><span class="p">:</span> <span class="n">scores</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
        <span class="p">})</span>

        <span class="k">if</span> <span class="n">mean_score</span> <span class="o">&gt;</span> <span class="n">best_score</span><span class="p">:</span>
            <span class="n">best_score</span> <span class="o">=</span> <span class="n">mean_score</span>
            <span class="n">best_alpha</span> <span class="o">=</span> <span class="n">alpha</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;best_alpha&#39;</span><span class="p">:</span> <span class="n">best_alpha</span><span class="p">,</span>
        <span class="s1">&#39;best_score&#39;</span><span class="p">:</span> <span class="n">best_score</span><span class="p">,</span>
        <span class="s1">&#39;all_results&#39;</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
    <span class="p">}</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h2>Section 2: Tree-Based Regression</h2>
<p>Random Forest and Gradient Boosting for non-linear return prediction.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Random Forest Regressor</span>

<span class="n">rf_reg</span> <span class="o">=</span> <span class="n">RandomForestRegressor</span><span class="p">(</span>
    <span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
    <span class="n">max_depth</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
    <span class="n">min_samples_leaf</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
    <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span>
    <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span>
<span class="p">)</span>

<span class="n">rf_reg</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_scaled</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="n">y_pred_rf</span> <span class="o">=</span> <span class="n">rf_reg</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test_scaled</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Random Forest Regressor Results:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  RMSE: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mean_squared_error</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_rf</span><span class="p">))</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  MAE:  </span><span class="si">{</span><span class="n">mean_absolute_error</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_rf</span><span class="p">)</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  R¬≤:   </span><span class="si">{</span><span class="n">r2_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_rf</span><span class="p">)</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Feature importance</span>
<span class="n">importance_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s1">&#39;feature&#39;</span><span class="p">:</span> <span class="n">feature_cols</span><span class="p">,</span>
    <span class="s1">&#39;importance&#39;</span><span class="p">:</span> <span class="n">rf_reg</span><span class="o">.</span><span class="n">feature_importances_</span>
<span class="p">})</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;importance&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Feature Importance:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">importance_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;feature&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">15s</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;importance&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Gradient Boosting Regressor</span>

<span class="n">gb_reg</span> <span class="o">=</span> <span class="n">GradientBoostingRegressor</span><span class="p">(</span>
    <span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
    <span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
    <span class="n">max_depth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
    <span class="n">min_samples_leaf</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
    <span class="n">subsample</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
    <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span>
<span class="p">)</span>

<span class="n">gb_reg</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_scaled</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="n">y_pred_gb</span> <span class="o">=</span> <span class="n">gb_reg</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test_scaled</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Gradient Boosting Regressor Results:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  RMSE: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mean_squared_error</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_gb</span><span class="p">))</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  MAE:  </span><span class="si">{</span><span class="n">mean_absolute_error</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_gb</span><span class="p">)</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  R¬≤:   </span><span class="si">{</span><span class="n">r2_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_gb</span><span class="p">)</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 8.2: Ensemble Regressor (Guided)</span>

<span class="k">def</span> <span class="nf">create_ensemble_regressor</span><span class="p">(</span><span class="n">models</span><span class="p">:</span> <span class="n">List</span><span class="p">,</span> <span class="n">weights</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">object</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a weighted ensemble of regression models.</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        Object with fit, predict methods</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">class</span> <span class="nc">EnsembleRegressor</span><span class="p">:</span>
        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">models</span><span class="p">,</span> <span class="n">weights</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">models</span> <span class="o">=</span> <span class="n">models</span>
            <span class="c1"># TODO: Set weights (equal if not provided)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="n">weights</span> <span class="k">if</span> <span class="n">weights</span> <span class="k">else</span> <span class="p">[</span><span class="mi">1</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">______</span><span class="p">)]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">models</span><span class="p">)</span>
            
        <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
            <span class="c1"># TODO: Fit all models</span>
            <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">______</span><span class="p">:</span>
                <span class="n">model</span><span class="o">.</span><span class="n">______</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span>
        
        <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
            <span class="c1"># TODO: Weighted average of predictions</span>
            <span class="n">predictions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">model</span><span class="p">,</span> <span class="n">weight</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">):</span>
                <span class="n">predictions</span> <span class="o">+=</span> <span class="n">______</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">______</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">predictions</span>
    
    <span class="k">return</span> <span class="n">EnsembleRegressor</span><span class="p">(</span><span class="n">models</span><span class="p">,</span> <span class="n">weights</span><span class="p">)</span>

<span class="c1"># Test the function</span>
<span class="c1"># ensemble = create_ensemble_regressor(</span>
<span class="c1">#     [Ridge(), RandomForestRegressor(n_estimators=50, max_depth=5)],</span>
<span class="c1">#     weights=[0.3, 0.7]</span>
<span class="c1"># )</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 8.2</summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">create_ensemble_regressor</span><span class="p">(</span><span class="n">models</span><span class="p">:</span> <span class="n">List</span><span class="p">,</span> <span class="n">weights</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">object</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a weighted ensemble of regression models.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">class</span> <span class="nc">EnsembleRegressor</span><span class="p">:</span>
        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">models</span><span class="p">,</span> <span class="n">weights</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">models</span> <span class="o">=</span> <span class="n">models</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="n">weights</span> <span class="k">if</span> <span class="n">weights</span> <span class="k">else</span> <span class="p">[</span><span class="mi">1</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">models</span><span class="p">)]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">models</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">:</span>
                <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span>

        <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
            <span class="n">predictions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">model</span><span class="p">,</span> <span class="n">weight</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">):</span>
                <span class="n">predictions</span> <span class="o">+=</span> <span class="n">weight</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">predictions</span>

    <span class="k">return</span> <span class="n">EnsembleRegressor</span><span class="p">(</span><span class="n">models</span><span class="p">,</span> <span class="n">weights</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h2>Section 3: Volatility Forecasting</h2>
<p>Predicting volatility is often easier and more useful than predicting returns.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Volatility Forecasting Concepts</span>

<span class="n">vol_concepts</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">VOLATILITY FORECASTING</span>
<span class="s2">======================</span>

<span class="s2">Why Volatility?</span>
<span class="s2">---------------</span>
<span class="s2">- More predictable than returns</span>
<span class="s2">- Clusters (high vol followed by high vol)</span>
<span class="s2">- Critical for risk management</span>
<span class="s2">- Used in options pricing</span>

<span class="s2">Common Measures:</span>
<span class="s2">----------------</span>
<span class="s2">1. Historical Volatility</span>
<span class="s2">   œÉ = std(returns) * sqrt(252)</span>

<span class="s2">2. Realized Volatility</span>
<span class="s2">   RV = sqrt(Œ£(intraday returns)¬≤)</span>

<span class="s2">3. Range-Based (Parkinson)</span>
<span class="s2">   œÉ = sqrt(ln(High/Low)¬≤ / (4*ln(2)))</span>

<span class="s2">ML Approaches:</span>
<span class="s2">--------------</span>
<span class="s2">- Predict next day/week volatility</span>
<span class="s2">- Use lagged volatility as key feature</span>
<span class="s2">- Often more successful than return prediction</span>

<span class="s2">Applications:</span>
<span class="s2">-------------</span>
<span class="s2">- Position sizing</span>
<span class="s2">- Risk budgeting</span>
<span class="s2">- Options trading</span>
<span class="s2">- VaR calculation</span>
<span class="s2">&quot;&quot;&quot;</span>
<span class="nb">print</span><span class="p">(</span><span class="n">vol_concepts</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Prepare volatility prediction data</span>

<span class="k">def</span> <span class="nf">prepare_volatility_data</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">vol_window</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Prepare features for volatility prediction.&quot;&quot;&quot;</span>
    
    <span class="n">vol_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
    
    <span class="c1"># Current volatility (lagged features)</span>
    <span class="n">returns</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span>
    <span class="n">vol_df</span><span class="p">[</span><span class="s1">&#39;vol_20d&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">vol_window</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
    <span class="n">vol_df</span><span class="p">[</span><span class="s1">&#39;vol_5d&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
    <span class="n">vol_df</span><span class="p">[</span><span class="s1">&#39;vol_10d&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
    
    <span class="c1"># Volatility ratios</span>
    <span class="n">vol_df</span><span class="p">[</span><span class="s1">&#39;vol_ratio_5_20&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">vol_df</span><span class="p">[</span><span class="s1">&#39;vol_5d&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">vol_df</span><span class="p">[</span><span class="s1">&#39;vol_20d&#39;</span><span class="p">]</span>
    
    <span class="c1"># Range-based volatility (Parkinson)</span>
    <span class="n">vol_df</span><span class="p">[</span><span class="s1">&#39;parkinson_vol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
        <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;High&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Low&#39;</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">vol_window</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">/</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
    <span class="p">)</span>
    
    <span class="c1"># Absolute returns</span>
    <span class="n">vol_df</span><span class="p">[</span><span class="s1">&#39;abs_return_1d&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span>
    <span class="n">vol_df</span><span class="p">[</span><span class="s1">&#39;abs_return_5d&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    
    <span class="c1"># Volume features</span>
    <span class="n">vol_df</span><span class="p">[</span><span class="s1">&#39;volume_ratio&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Volume&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Volume&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    
    <span class="c1"># Target: next day&#39;s volatility</span>
    <span class="n">vol_df</span><span class="p">[</span><span class="s1">&#39;target_vol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">vol_df</span><span class="p">[</span><span class="s1">&#39;vol_20d&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="n">vol_df</span> <span class="o">=</span> <span class="n">vol_df</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
    
    <span class="n">features</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;vol_20d&#39;</span><span class="p">,</span> <span class="s1">&#39;vol_5d&#39;</span><span class="p">,</span> <span class="s1">&#39;vol_10d&#39;</span><span class="p">,</span> <span class="s1">&#39;vol_ratio_5_20&#39;</span><span class="p">,</span>
                <span class="s1">&#39;parkinson_vol&#39;</span><span class="p">,</span> <span class="s1">&#39;abs_return_1d&#39;</span><span class="p">,</span> <span class="s1">&#39;abs_return_5d&#39;</span><span class="p">,</span> <span class="s1">&#39;volume_ratio&#39;</span><span class="p">]</span>
    
    <span class="k">return</span> <span class="n">vol_df</span><span class="p">[</span><span class="n">features</span><span class="p">],</span> <span class="n">vol_df</span><span class="p">[</span><span class="s1">&#39;target_vol&#39;</span><span class="p">]</span>

<span class="c1"># Prepare volatility data</span>
<span class="n">X_vol</span><span class="p">,</span> <span class="n">y_vol</span> <span class="o">=</span> <span class="n">prepare_volatility_data</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

<span class="c1"># Split</span>
<span class="n">split_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">X_vol</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.8</span><span class="p">)</span>
<span class="n">X_vol_train</span><span class="p">,</span> <span class="n">X_vol_test</span> <span class="o">=</span> <span class="n">X_vol</span><span class="p">[:</span><span class="n">split_idx</span><span class="p">],</span> <span class="n">X_vol</span><span class="p">[</span><span class="n">split_idx</span><span class="p">:]</span>
<span class="n">y_vol_train</span><span class="p">,</span> <span class="n">y_vol_test</span> <span class="o">=</span> <span class="n">y_vol</span><span class="p">[:</span><span class="n">split_idx</span><span class="p">],</span> <span class="n">y_vol</span><span class="p">[</span><span class="n">split_idx</span><span class="p">:]</span>

<span class="c1"># Scale</span>
<span class="n">vol_scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
<span class="n">X_vol_train_scaled</span> <span class="o">=</span> <span class="n">vol_scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_vol_train</span><span class="p">)</span>
<span class="n">X_vol_test_scaled</span> <span class="o">=</span> <span class="n">vol_scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_vol_test</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Volatility prediction data: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">X_vol</span><span class="p">)</span><span class="si">}</span><span class="s2"> samples&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Train volatility forecasting models</span>

<span class="n">vol_models</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;Ridge&#39;</span><span class="p">:</span> <span class="n">Ridge</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">1.0</span><span class="p">),</span>
    <span class="s1">&#39;RF&#39;</span><span class="p">:</span> <span class="n">RandomForestRegressor</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">),</span>
    <span class="s1">&#39;GB&#39;</span><span class="p">:</span> <span class="n">GradientBoostingRegressor</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
<span class="p">}</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Volatility Forecasting Results:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>

<span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">vol_models</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_vol_train_scaled</span><span class="p">,</span> <span class="n">y_vol_train</span><span class="p">)</span>
    <span class="n">y_pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_vol_test_scaled</span><span class="p">)</span>
    
    <span class="n">rmse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mean_squared_error</span><span class="p">(</span><span class="n">y_vol_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">))</span>
    <span class="n">mae</span> <span class="o">=</span> <span class="n">mean_absolute_error</span><span class="p">(</span><span class="n">y_vol_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
    <span class="n">r2</span> <span class="o">=</span> <span class="n">r2_score</span><span class="p">(</span><span class="n">y_vol_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  RMSE: </span><span class="si">{</span><span class="n">rmse</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  MAE:  </span><span class="si">{</span><span class="n">mae</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  R¬≤:   </span><span class="si">{</span><span class="n">r2</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Visualize volatility predictions</span>

<span class="c1"># Use the best model (GB)</span>
<span class="n">gb_vol</span> <span class="o">=</span> <span class="n">GradientBoostingRegressor</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
<span class="n">gb_vol</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_vol_train_scaled</span><span class="p">,</span> <span class="n">y_vol_train</span><span class="p">)</span>
<span class="n">vol_pred</span> <span class="o">=</span> <span class="n">gb_vol</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_vol_test_scaled</span><span class="p">)</span>

<span class="c1"># Plot</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

<span class="c1"># Actual vs Predicted</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">y_vol_test</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">y_vol_test</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Actual&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">y_vol_test</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">vol_pred</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Predicted&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Volatility&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Volatility Forecast: Actual vs Predicted&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="c1"># Scatter plot</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">y_vol_test</span><span class="p">,</span> <span class="n">vol_pred</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">y_vol_test</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">y_vol_test</span><span class="o">.</span><span class="n">max</span><span class="p">()],</span>
             <span class="p">[</span><span class="n">y_vol_test</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">y_vol_test</span><span class="o">.</span><span class="n">max</span><span class="p">()],</span> <span class="s1">&#39;r--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Perfect&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Actual Volatility&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Predicted Volatility&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Prediction Scatter Plot&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 8.3: Volatility Forecaster (Guided)</span>

<span class="k">class</span> <span class="nc">VolatilityForecaster</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Multi-horizon volatility forecasting system.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">horizons</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">20</span><span class="p">]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">horizons</span> <span class="o">=</span> <span class="n">horizons</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">models</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scalers</span> <span class="o">=</span> <span class="p">{}</span>
        
    <span class="k">def</span> <span class="nf">create_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Create volatility features.&quot;&quot;&quot;</span>
        <span class="n">features</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="n">returns</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span>
        
        <span class="c1"># TODO: Add volatility features for multiple windows</span>
        <span class="k">for</span> <span class="n">window</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">60</span><span class="p">]:</span>
            <span class="n">features</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;vol_</span><span class="si">{</span><span class="n">window</span><span class="si">}</span><span class="s1">d&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">______</span><span class="p">)</span><span class="o">.</span><span class="n">______</span><span class="p">()</span>
        
        <span class="c1"># TODO: Add Parkinson volatility</span>
        <span class="n">log_hl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;High&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;______&#39;</span><span class="p">])</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;parkinson&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">log_hl</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">/</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">)))</span>
        
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;volume_ratio&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Volume&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Volume&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        
        <span class="k">return</span> <span class="n">features</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Fit models for each horizon.&quot;&quot;&quot;</span>
        <span class="n">features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_features</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="n">returns</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span>
        
        <span class="k">for</span> <span class="n">horizon</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">horizons</span><span class="p">:</span>
            <span class="c1"># Create target: forward volatility</span>
            <span class="n">target</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">horizon</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="n">horizon</span><span class="p">)</span>
            
            <span class="c1"># Align and clean</span>
            <span class="n">aligned</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">features</span><span class="p">,</span> <span class="n">target</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;target&#39;</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
            
            <span class="n">X</span> <span class="o">=</span> <span class="n">aligned</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;target&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">aligned</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span>
            
            <span class="c1"># Scale and fit</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scalers</span><span class="p">[</span><span class="n">horizon</span><span class="p">]</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
            <span class="n">X_scaled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scalers</span><span class="p">[</span><span class="n">horizon</span><span class="p">]</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="n">horizon</span><span class="p">]</span> <span class="o">=</span> <span class="n">GradientBoostingRegressor</span><span class="p">(</span>
                <span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="n">horizon</span><span class="p">]</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_scaled</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="bp">self</span>
    
    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Predict volatility for all horizons.&quot;&quot;&quot;</span>
        <span class="n">features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_features</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        
        <span class="n">predictions</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">features</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">horizon</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">horizons</span><span class="p">:</span>
            <span class="n">X_scaled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scalers</span><span class="p">[</span><span class="n">horizon</span><span class="p">]</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>
            <span class="n">predictions</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;vol_</span><span class="si">{</span><span class="n">horizon</span><span class="si">}</span><span class="s1">d&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="n">horizon</span><span class="p">]</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_scaled</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">predictions</span>

<span class="c1"># Test</span>
<span class="c1"># forecaster = VolatilityForecaster([1, 5, 20])</span>
<span class="c1"># forecaster.fit(df)</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 8.3</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">VolatilityForecaster</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">horizons</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">20</span><span class="p">]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">horizons</span> <span class="o">=</span> <span class="n">horizons</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">models</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scalers</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">create_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="n">features</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="n">returns</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">window</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">60</span><span class="p">]:</span>
            <span class="n">features</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;vol_</span><span class="si">{</span><span class="n">window</span><span class="si">}</span><span class="s1">d&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>

        <span class="n">log_hl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;High&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Low&#39;</span><span class="p">])</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;parkinson&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">log_hl</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">/</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">)))</span>

        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;volume_ratio&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Volume&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Volume&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">features</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
        <span class="n">features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_features</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="n">returns</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">horizon</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">horizons</span><span class="p">:</span>
            <span class="n">target</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">horizon</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="n">horizon</span><span class="p">)</span>
            <span class="n">aligned</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">features</span><span class="p">,</span> <span class="n">target</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;target&#39;</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

            <span class="n">X</span> <span class="o">=</span> <span class="n">aligned</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;target&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">aligned</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">scalers</span><span class="p">[</span><span class="n">horizon</span><span class="p">]</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
            <span class="n">X_scaled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scalers</span><span class="p">[</span><span class="n">horizon</span><span class="p">]</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="n">horizon</span><span class="p">]</span> <span class="o">=</span> <span class="n">GradientBoostingRegressor</span><span class="p">(</span>
                <span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="n">horizon</span><span class="p">]</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_scaled</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="n">features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_features</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

        <span class="n">predictions</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">features</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">horizon</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">horizons</span><span class="p">:</span>
            <span class="n">X_scaled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scalers</span><span class="p">[</span><span class="n">horizon</span><span class="p">]</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>
            <span class="n">predictions</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;vol_</span><span class="si">{</span><span class="n">horizon</span><span class="si">}</span><span class="s1">d&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="n">horizon</span><span class="p">]</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_scaled</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">predictions</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h2>Section 4: Quantile Regression</h2>
<p>Predict different percentiles of the return distribution for tail risk analysis.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Quantile Regression Concepts</span>

<span class="n">quantile_concepts</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">QUANTILE REGRESSION</span>
<span class="s2">===================</span>

<span class="s2">What is Quantile Regression?</span>
<span class="s2">----------------------------</span>
<span class="s2">- Predict specific percentiles instead of mean</span>
<span class="s2">- Estimate conditional distribution of returns</span>
<span class="s2">- Essential for tail risk (VaR, CVaR)</span>

<span class="s2">Common Quantiles:</span>
<span class="s2">-----------------</span>
<span class="s2">- q=0.01: 1% worst case (VaR 99%)</span>
<span class="s2">- q=0.05: 5% worst case (VaR 95%)</span>
<span class="s2">- q=0.50: Median (robust to outliers)</span>
<span class="s2">- q=0.95: 5% best case</span>
<span class="s2">- q=0.99: 1% best case</span>

<span class="s2">Loss Function:</span>
<span class="s2">--------------</span>
<span class="s2">L(y, ≈∑, q) = max(q*(y-≈∑), (q-1)*(y-≈∑))</span>

<span class="s2">Pinball loss that asymmetrically penalizes</span>
<span class="s2">under and over predictions.</span>

<span class="s2">Applications:</span>
<span class="s2">-------------</span>
<span class="s2">- Value at Risk (VaR)</span>
<span class="s2">- Conditional VaR (Expected Shortfall)</span>
<span class="s2">- Prediction intervals</span>
<span class="s2">- Tail risk management</span>
<span class="s2">&quot;&quot;&quot;</span>
<span class="nb">print</span><span class="p">(</span><span class="n">quantile_concepts</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Quantile Regression with Gradient Boosting</span>

<span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">GradientBoostingRegressor</span>

<span class="n">quantiles</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.50</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">]</span>
<span class="n">quantile_models</span> <span class="o">=</span> <span class="p">{}</span>

<span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">quantiles</span><span class="p">:</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">GradientBoostingRegressor</span><span class="p">(</span>
        <span class="n">loss</span><span class="o">=</span><span class="s1">&#39;quantile&#39;</span><span class="p">,</span>
        <span class="n">alpha</span><span class="o">=</span><span class="n">q</span><span class="p">,</span>
        <span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
        <span class="n">max_depth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
        <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span>
    <span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_scaled</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
    <span class="n">quantile_models</span><span class="p">[</span><span class="n">q</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span>

<span class="c1"># Predict all quantiles</span>
<span class="n">quantile_preds</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">y_test</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
<span class="k">for</span> <span class="n">q</span><span class="p">,</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">quantile_models</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">quantile_preds</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;q</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">q</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span><span class="si">:</span><span class="s1">02d</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test_scaled</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Quantile Predictions (first 5 rows):&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">quantile_preds</span><span class="o">.</span><span class="n">head</span><span class="p">())</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Visualize quantile predictions</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

<span class="c1"># Time series with prediction intervals</span>
<span class="n">sample_size</span> <span class="o">=</span> <span class="mi">50</span>
<span class="n">sample_idx</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">quantile_preds</span><span class="p">)</span> <span class="o">-</span> <span class="n">sample_size</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">quantile_preds</span><span class="p">))</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">sample_size</span><span class="p">),</span> 
                     <span class="n">quantile_preds</span><span class="p">[</span><span class="s1">&#39;q05&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">sample_idx</span><span class="p">],</span>
                     <span class="n">quantile_preds</span><span class="p">[</span><span class="s1">&#39;q95&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">sample_idx</span><span class="p">],</span>
                     <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;90% CI&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">sample_size</span><span class="p">),</span>
                     <span class="n">quantile_preds</span><span class="p">[</span><span class="s1">&#39;q25&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">sample_idx</span><span class="p">],</span>
                     <span class="n">quantile_preds</span><span class="p">[</span><span class="s1">&#39;q75&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">sample_idx</span><span class="p">],</span>
                     <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;50% CI&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">sample_size</span><span class="p">),</span> <span class="n">quantile_preds</span><span class="p">[</span><span class="s1">&#39;q50&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">sample_idx</span><span class="p">],</span>
            <span class="s1">&#39;b-&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Median&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">sample_size</span><span class="p">),</span> <span class="n">y_test</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">sample_idx</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
            <span class="s1">&#39;ro&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Actual&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Day&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Return&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Quantile Predictions with Confidence Intervals&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="c1"># Distribution of predictions</span>
<span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="p">[</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.50</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">]:</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">quantile_models</span><span class="p">[</span><span class="n">q</span><span class="p">]</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test_scaled</span><span class="p">),</span> 
                <span class="n">bins</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;q</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">q</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Predicted Return&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Frequency&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Distribution of Quantile Predictions&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 8.4: VaR Predictor (Open-ended)</span>
<span class="c1">#</span>
<span class="c1"># Build a VaRPredictor class that:</span>
<span class="c1"># - Uses quantile regression to predict VaR at different confidence levels</span>
<span class="c1"># - Calculates Expected Shortfall (CVaR)</span>
<span class="c1"># - Provides backtesting for VaR violations</span>
<span class="c1"># - Visualizes VaR predictions vs actual returns</span>
<span class="c1"># - Reports coverage statistics</span>
<span class="c1">#</span>
<span class="c1"># Your implementation:</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 8.4</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">VaRPredictor</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Value at Risk prediction using quantile regression.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">confidence_levels</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.95</span><span class="p">,</span> <span class="mf">0.99</span><span class="p">]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">confidence_levels</span> <span class="o">=</span> <span class="n">confidence_levels</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">models</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Fit quantile models for each confidence level.&quot;&quot;&quot;</span>
        <span class="n">X_scaled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">conf</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">confidence_levels</span><span class="p">:</span>
            <span class="n">alpha</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">conf</span>  <span class="c1"># VaR quantile</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="n">conf</span><span class="p">]</span> <span class="o">=</span> <span class="n">GradientBoostingRegressor</span><span class="p">(</span>
                <span class="n">loss</span><span class="o">=</span><span class="s1">&#39;quantile&#39;</span><span class="p">,</span>
                <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span>
                <span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
                <span class="n">max_depth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="n">conf</span><span class="p">]</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_scaled</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">predict_var</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Predict VaR for all confidence levels.&quot;&quot;&quot;</span>
        <span class="n">X_scaled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

        <span class="n">var_preds</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">X</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">conf</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">confidence_levels</span><span class="p">:</span>
            <span class="n">var_preds</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;VaR_</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">conf</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="n">conf</span><span class="p">]</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_scaled</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">var_preds</span>

    <span class="k">def</span> <span class="nf">backtest</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Backtest VaR predictions.&quot;&quot;&quot;</span>
        <span class="n">var_preds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict_var</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">conf</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">confidence_levels</span><span class="p">:</span>
            <span class="n">var_col</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;VaR_</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">conf</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="n">violations</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">y</span><span class="o">.</span><span class="n">values</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">var_preds</span><span class="p">[</span><span class="n">var_col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="n">expected</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">conf</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>

            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;confidence&#39;</span><span class="p">:</span> <span class="n">conf</span><span class="p">,</span>
                <span class="s1">&#39;violations&#39;</span><span class="p">:</span> <span class="n">violations</span><span class="p">,</span>
                <span class="s1">&#39;expected&#39;</span><span class="p">:</span> <span class="n">expected</span><span class="p">,</span>
                <span class="s1">&#39;violation_rate&#39;</span><span class="p">:</span> <span class="n">violations</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">),</span>
                <span class="s1">&#39;expected_rate&#39;</span><span class="p">:</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">conf</span>
            <span class="p">})</span>

        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">calculate_cvar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> 
                       <span class="n">confidence</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.95</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate Conditional VaR (Expected Shortfall).&quot;&quot;&quot;</span>
        <span class="n">var_preds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict_var</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="n">var_col</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;VaR_</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">confidence</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span>

        <span class="c1"># CVaR = average of returns below VaR</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="o">-</span><span class="n">y</span><span class="o">.</span><span class="n">values</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">var_preds</span><span class="p">[</span><span class="n">var_col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="k">if</span> <span class="n">mask</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">cvar</span> <span class="o">=</span> <span class="o">-</span><span class="n">y</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cvar</span> <span class="o">=</span> <span class="n">var_preds</span><span class="p">[</span><span class="n">var_col</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">cvar</span>

    <span class="k">def</span> <span class="nf">plot_backtest</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Visualize VaR backtest.&quot;&quot;&quot;</span>
        <span class="n">var_preds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict_var</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

        <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">confidence_levels</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> 
                                 <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">4</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">confidence_levels</span><span class="p">)))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">confidence_levels</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">axes</span> <span class="o">=</span> <span class="p">[</span><span class="n">axes</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">ax</span><span class="p">,</span> <span class="n">conf</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">confidence_levels</span><span class="p">):</span>
            <span class="n">var_col</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;VaR_</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">conf</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">y</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="s1">&#39;b-&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Returns&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="o">-</span><span class="n">var_preds</span><span class="p">[</span><span class="n">var_col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="s1">&#39;r-&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">var_col</span><span class="p">)</span>

            <span class="c1"># Mark violations</span>
            <span class="n">violations</span> <span class="o">=</span> <span class="o">-</span><span class="n">y</span><span class="o">.</span><span class="n">values</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">var_preds</span><span class="p">[</span><span class="n">var_col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">violations</span><span class="p">],</span> <span class="n">y</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">violations</span><span class="p">],</span> 
                      <span class="n">c</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Violations&#39;</span><span class="p">)</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;VaR </span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">conf</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span><span class="si">}</span><span class="s1">% Backtest&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>


</details></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 8.5: Multi-Horizon Return Predictor (Open-ended)</span>
<span class="c1">#</span>
<span class="c1"># Build a MultiHorizonPredictor class that:</span>
<span class="c1"># - Predicts returns at multiple horizons (1, 5, 10, 20 days)</span>
<span class="c1"># - Uses different models for each horizon</span>
<span class="c1"># - Provides uncertainty estimates</span>
<span class="c1"># - Evaluates prediction accuracy at each horizon</span>
<span class="c1"># - Generates a comprehensive prediction report</span>
<span class="c1">#</span>
<span class="c1"># Your implementation:</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 8.5</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">MultiHorizonPredictor</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Predict returns at multiple horizons.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">horizons</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">horizons</span> <span class="o">=</span> <span class="n">horizons</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">models</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scalers</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_names</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">create_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Create features from price data.&quot;&quot;&quot;</span>
        <span class="n">features</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="n">returns</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span>

        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;volatility&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">]:</span>
            <span class="n">features</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;momentum_</span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">50</span><span class="p">]:</span>
            <span class="n">ma</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="n">features</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;dist_ma</span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">ma</span><span class="p">)</span> <span class="o">/</span> <span class="n">ma</span>

        <span class="n">delta</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span>
        <span class="n">gain</span> <span class="o">=</span> <span class="p">(</span><span class="n">delta</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">delta</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">14</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">delta</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">delta</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">14</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;rsi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">-</span> <span class="p">(</span><span class="mi">100</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">gain</span> <span class="o">/</span> <span class="n">loss</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">features</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Fit models for each horizon.&quot;&quot;&quot;</span>
        <span class="n">features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_features</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_names</span> <span class="o">=</span> <span class="n">features</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">horizon</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">horizons</span><span class="p">:</span>
            <span class="c1"># Create target</span>
            <span class="n">target</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">(</span><span class="n">horizon</span><span class="p">)</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="n">horizon</span><span class="p">)</span>
            <span class="n">aligned</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">features</span><span class="p">,</span> <span class="n">target</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;target&#39;</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

            <span class="n">X</span> <span class="o">=</span> <span class="n">aligned</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;target&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">aligned</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">scalers</span><span class="p">[</span><span class="n">horizon</span><span class="p">]</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
            <span class="n">X_scaled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scalers</span><span class="p">[</span><span class="n">horizon</span><span class="p">]</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

            <span class="c1"># Use ensemble</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="n">horizon</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;point&#39;</span><span class="p">:</span> <span class="n">GradientBoostingRegressor</span><span class="p">(</span>
                    <span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span>
                <span class="p">),</span>
                <span class="s1">&#39;lower&#39;</span><span class="p">:</span> <span class="n">GradientBoostingRegressor</span><span class="p">(</span>
                    <span class="n">loss</span><span class="o">=</span><span class="s1">&#39;quantile&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> 
                    <span class="n">max_depth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span>
                <span class="p">),</span>
                <span class="s1">&#39;upper&#39;</span><span class="p">:</span> <span class="n">GradientBoostingRegressor</span><span class="p">(</span>
                    <span class="n">loss</span><span class="o">=</span><span class="s1">&#39;quantile&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
                    <span class="n">max_depth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span>
                <span class="p">)</span>
            <span class="p">}</span>

            <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="n">horizon</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_scaled</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Predict returns with uncertainty.&quot;&quot;&quot;</span>
        <span class="n">features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_features</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

        <span class="n">predictions</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">features</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">horizon</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">horizons</span><span class="p">:</span>
            <span class="n">X_scaled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scalers</span><span class="p">[</span><span class="n">horizon</span><span class="p">]</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>

            <span class="n">predictions</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;h</span><span class="si">{</span><span class="n">horizon</span><span class="si">}</span><span class="s1">_point&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="n">horizon</span><span class="p">][</span><span class="s1">&#39;point&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_scaled</span><span class="p">)</span>
            <span class="n">predictions</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;h</span><span class="si">{</span><span class="n">horizon</span><span class="si">}</span><span class="s1">_lower&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="n">horizon</span><span class="p">][</span><span class="s1">&#39;lower&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_scaled</span><span class="p">)</span>
            <span class="n">predictions</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;h</span><span class="si">{</span><span class="n">horizon</span><span class="si">}</span><span class="s1">_upper&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="n">horizon</span><span class="p">][</span><span class="s1">&#39;upper&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_scaled</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">predictions</span>

    <span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">test_frac</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Evaluate predictions at each horizon.&quot;&quot;&quot;</span>
        <span class="n">features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_features</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="n">split_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">features</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">test_frac</span><span class="p">))</span>

        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">horizon</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">horizons</span><span class="p">:</span>
            <span class="n">target</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">(</span><span class="n">horizon</span><span class="p">)</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="n">horizon</span><span class="p">)</span>
            <span class="n">aligned</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">features</span><span class="p">,</span> <span class="n">target</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;target&#39;</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

            <span class="n">test_features</span> <span class="o">=</span> <span class="n">aligned</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;target&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="n">split_idx</span><span class="p">:]</span>
            <span class="n">test_target</span> <span class="o">=</span> <span class="n">aligned</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">][</span><span class="n">split_idx</span><span class="p">:]</span>

            <span class="n">X_scaled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scalers</span><span class="p">[</span><span class="n">horizon</span><span class="p">]</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">test_features</span><span class="p">)</span>
            <span class="n">y_pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="n">horizon</span><span class="p">][</span><span class="s1">&#39;point&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_scaled</span><span class="p">)</span>

            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;horizon&#39;</span><span class="p">:</span> <span class="n">horizon</span><span class="p">,</span>
                <span class="s1">&#39;rmse&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mean_squared_error</span><span class="p">(</span><span class="n">test_target</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)),</span>
                <span class="s1">&#39;mae&#39;</span><span class="p">:</span> <span class="n">mean_absolute_error</span><span class="p">(</span><span class="n">test_target</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">),</span>
                <span class="s1">&#39;r2&#39;</span><span class="p">:</span> <span class="n">r2_score</span><span class="p">(</span><span class="n">test_target</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
            <span class="p">})</span>

        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 8.6: Complete Regression Evaluator (Open-ended)</span>
<span class="c1">#</span>
<span class="c1"># Build a RegressionEvaluator class that:</span>
<span class="c1"># - Compares multiple regression models</span>
<span class="c1"># - Uses walk-forward validation</span>
<span class="c1"># - Calculates regression metrics (MSE, MAE, R2)</span>
<span class="c1"># - Calculates direction accuracy (sign of prediction)</span>
<span class="c1"># - Computes information coefficient (IC)</span>
<span class="c1"># - Generates visualization of residuals and predictions</span>
<span class="c1">#</span>
<span class="c1"># Your implementation:</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 8.6</summary>


<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">spearmanr</span>

<span class="k">class</span> <span class="nc">RegressionEvaluator</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Comprehensive regression model evaluation.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">models</span><span class="p">:</span> <span class="n">Dict</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">models</span> <span class="o">=</span> <span class="n">models</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">predictions</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Evaluate all models.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">model</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
            <span class="n">y_pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">predictions</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_pred</span>

            <span class="c1"># Regression metrics</span>
            <span class="n">mse</span> <span class="o">=</span> <span class="n">mean_squared_error</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
            <span class="n">mae</span> <span class="o">=</span> <span class="n">mean_absolute_error</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
            <span class="n">r2</span> <span class="o">=</span> <span class="n">r2_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>

            <span class="c1"># Direction accuracy</span>
            <span class="n">dir_acc</span> <span class="o">=</span> <span class="p">((</span><span class="n">y_test</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">y_pred</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

            <span class="c1"># Information coefficient (rank correlation)</span>
            <span class="n">ic</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">spearmanr</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;mse&#39;</span><span class="p">:</span> <span class="n">mse</span><span class="p">,</span>
                <span class="s1">&#39;rmse&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mse</span><span class="p">),</span>
                <span class="s1">&#39;mae&#39;</span><span class="p">:</span> <span class="n">mae</span><span class="p">,</span>
                <span class="s1">&#39;r2&#39;</span><span class="p">:</span> <span class="n">r2</span><span class="p">,</span>
                <span class="s1">&#39;direction_accuracy&#39;</span><span class="p">:</span> <span class="n">dir_acc</span><span class="p">,</span>
                <span class="s1">&#39;information_coefficient&#39;</span><span class="p">:</span> <span class="n">ic</span>
            <span class="p">}</span>

        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">walk_forward_evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">train_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">200</span><span class="p">,</span>
                               <span class="n">step_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Walk-forward evaluation.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">model</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">all_preds</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">all_actuals</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="n">start</span> <span class="o">+</span> <span class="n">train_size</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>
                <span class="n">train_end</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">train_size</span>
                <span class="n">test_end</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">train_end</span> <span class="o">+</span> <span class="n">step_size</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">))</span>

                <span class="n">X_train</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">train_end</span><span class="p">]</span>
                <span class="n">y_train_fold</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">train_end</span><span class="p">]</span>
                <span class="n">X_test</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_end</span><span class="p">:</span><span class="n">test_end</span><span class="p">]</span>
                <span class="n">y_test_fold</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_end</span><span class="p">:</span><span class="n">test_end</span><span class="p">]</span>

                <span class="n">model_clone</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="o">**</span><span class="n">model</span><span class="o">.</span><span class="n">get_params</span><span class="p">())</span>
                <span class="n">model_clone</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train_fold</span><span class="p">)</span>

                <span class="n">all_preds</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">model_clone</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">))</span>
                <span class="n">all_actuals</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">y_test_fold</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

                <span class="n">start</span> <span class="o">+=</span> <span class="n">step_size</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">predictions</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">all_preds</span><span class="p">)</span>
            <span class="n">y_test_wf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">all_actuals</span><span class="p">)</span>

            <span class="n">mse</span> <span class="o">=</span> <span class="n">mean_squared_error</span><span class="p">(</span><span class="n">y_test_wf</span><span class="p">,</span> <span class="n">all_preds</span><span class="p">)</span>
            <span class="n">ic</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">spearmanr</span><span class="p">(</span><span class="n">y_test_wf</span><span class="p">,</span> <span class="n">all_preds</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;rmse&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mse</span><span class="p">),</span>
                <span class="s1">&#39;mae&#39;</span><span class="p">:</span> <span class="n">mean_absolute_error</span><span class="p">(</span><span class="n">y_test_wf</span><span class="p">,</span> <span class="n">all_preds</span><span class="p">),</span>
                <span class="s1">&#39;r2&#39;</span><span class="p">:</span> <span class="n">r2_score</span><span class="p">(</span><span class="n">y_test_wf</span><span class="p">,</span> <span class="n">all_preds</span><span class="p">),</span>
                <span class="s1">&#39;direction_accuracy&#39;</span><span class="p">:</span> <span class="p">((</span><span class="n">y_test_wf</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">all_preds</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
                <span class="s1">&#39;ic&#39;</span><span class="p">:</span> <span class="n">ic</span>
            <span class="p">}</span>

        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">get_comparison_table</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get comparison DataFrame.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

    <span class="k">def</span> <span class="nf">plot_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y_test</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Plot predictions and residuals.&quot;&quot;&quot;</span>
        <span class="n">n_models</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">)</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">n_models</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">4</span><span class="o">*</span><span class="n">n_models</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">n_models</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">axes</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">preds</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">predictions</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="c1"># Scatter plot</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">y_test</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">preds</span><span class="p">)],</span> <span class="n">preds</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">y_test</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">y_test</span><span class="o">.</span><span class="n">max</span><span class="p">()],</span>
                           <span class="p">[</span><span class="n">y_test</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">y_test</span><span class="o">.</span><span class="n">max</span><span class="p">()],</span> <span class="s1">&#39;r--&#39;</span><span class="p">)</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Actual&#39;</span><span class="p">)</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Predicted&#39;</span><span class="p">)</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">: Actual vs Predicted&#39;</span><span class="p">)</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

            <span class="c1"># Residuals</span>
            <span class="n">residuals</span> <span class="o">=</span> <span class="n">y_test</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">preds</span><span class="p">)]</span><span class="o">.</span><span class="n">values</span> <span class="o">-</span> <span class="n">preds</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">residuals</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Residual&#39;</span><span class="p">)</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Frequency&#39;</span><span class="p">)</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">: Residual Distribution&#39;</span><span class="p">)</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>


</details></div>
<div class="md-cell module-project"><hr />
<h2>Module Project: Complete Return Prediction System</h2>
<p>Build a comprehensive system for return and volatility prediction.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">ReturnPredictionSystem</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Complete system for return and volatility prediction.</span>
<span class="sd">    </span>
<span class="sd">    Features:</span>
<span class="sd">    - Multiple model types (linear, tree, ensemble)</span>
<span class="sd">    - Return and volatility forecasting</span>
<span class="sd">    - Quantile predictions for risk management</span>
<span class="sd">    - Walk-forward validation</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">return_models</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vol_models</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">quantile_models</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_names</span> <span class="o">=</span> <span class="kc">None</span>
        
    <span class="k">def</span> <span class="nf">create_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Create comprehensive feature set.&quot;&quot;&quot;</span>
        <span class="n">features</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        
        <span class="n">returns</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span>
        
        <span class="c1"># Volatility features</span>
        <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">]:</span>
            <span class="n">features</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;vol_</span><span class="si">{</span><span class="n">w</span><span class="si">}</span><span class="s1">d&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">w</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
        
        <span class="c1"># Momentum features</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">]:</span>
            <span class="n">features</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;mom_</span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s1">d&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        
        <span class="c1"># MA distances</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">50</span><span class="p">]:</span>
            <span class="n">ma</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="n">features</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;dist_ma</span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">ma</span><span class="p">)</span> <span class="o">/</span> <span class="n">ma</span>
        
        <span class="c1"># RSI</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span>
        <span class="n">gain</span> <span class="o">=</span> <span class="p">(</span><span class="n">delta</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">delta</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">14</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">delta</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">delta</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">14</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;rsi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">-</span> <span class="p">(</span><span class="mi">100</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">gain</span> <span class="o">/</span> <span class="n">loss</span><span class="p">))</span>
        
        <span class="c1"># Volume</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;vol_ratio&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Volume&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Volume&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        
        <span class="k">return</span> <span class="n">features</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">test_frac</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Fit all prediction models.&quot;&quot;&quot;</span>
        <span class="n">features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_features</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_names</span> <span class="o">=</span> <span class="n">features</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        
        <span class="n">returns</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span>
        <span class="n">volatility</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
        
        <span class="c1"># Align targets</span>
        <span class="n">target_return</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">target_vol</span> <span class="o">=</span> <span class="n">volatility</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        
        <span class="n">combined</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span>
            <span class="n">features</span><span class="p">,</span> 
            <span class="n">target_return</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;target_return&#39;</span><span class="p">),</span>
            <span class="n">target_vol</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;target_vol&#39;</span><span class="p">)</span>
        <span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
        
        <span class="n">X</span> <span class="o">=</span> <span class="n">combined</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">feature_names</span><span class="p">]</span>
        <span class="n">y_return</span> <span class="o">=</span> <span class="n">combined</span><span class="p">[</span><span class="s1">&#39;target_return&#39;</span><span class="p">]</span>
        <span class="n">y_vol</span> <span class="o">=</span> <span class="n">combined</span><span class="p">[</span><span class="s1">&#39;target_vol&#39;</span><span class="p">]</span>
        
        <span class="c1"># Split</span>
        <span class="n">split_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">test_frac</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">X_train</span> <span class="o">=</span> <span class="n">X</span><span class="p">[:</span><span class="n">split_idx</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">X_test</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">split_idx</span><span class="p">:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y_return_train</span> <span class="o">=</span> <span class="n">y_return</span><span class="p">[:</span><span class="n">split_idx</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y_return_test</span> <span class="o">=</span> <span class="n">y_return</span><span class="p">[</span><span class="n">split_idx</span><span class="p">:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y_vol_train</span> <span class="o">=</span> <span class="n">y_vol</span><span class="p">[:</span><span class="n">split_idx</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y_vol_test</span> <span class="o">=</span> <span class="n">y_vol</span><span class="p">[</span><span class="n">split_idx</span><span class="p">:]</span>
        
        <span class="c1"># Scale</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">X_train_scaled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X_train</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">X_test_scaled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X_test</span><span class="p">)</span>
        
        <span class="c1"># Train return models</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">return_models</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;Ridge&#39;</span><span class="p">:</span> <span class="n">Ridge</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">1.0</span><span class="p">),</span>
            <span class="s1">&#39;RF&#39;</span><span class="p">:</span> <span class="n">RandomForestRegressor</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">),</span>
            <span class="s1">&#39;GB&#39;</span><span class="p">:</span> <span class="n">GradientBoostingRegressor</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
        <span class="p">}</span>
        
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">model</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">return_models</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X_train_scaled</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_return_train</span><span class="p">)</span>
        
        <span class="c1"># Train volatility models</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vol_models</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;Ridge&#39;</span><span class="p">:</span> <span class="n">Ridge</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">1.0</span><span class="p">),</span>
            <span class="s1">&#39;GB&#39;</span><span class="p">:</span> <span class="n">GradientBoostingRegressor</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
        <span class="p">}</span>
        
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">model</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vol_models</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X_train_scaled</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_vol_train</span><span class="p">)</span>
        
        <span class="c1"># Train quantile models</span>
        <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="p">[</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.50</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">quantile_models</span><span class="p">[</span><span class="n">q</span><span class="p">]</span> <span class="o">=</span> <span class="n">GradientBoostingRegressor</span><span class="p">(</span>
                <span class="n">loss</span><span class="o">=</span><span class="s1">&#39;quantile&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">q</span><span class="p">,</span> <span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> 
                <span class="n">max_depth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">quantile_models</span><span class="p">[</span><span class="n">q</span><span class="p">]</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X_train_scaled</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_return_train</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="bp">self</span>
    
    <span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Evaluate all models.&quot;&quot;&quot;</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;return_models&#39;</span><span class="p">:</span> <span class="p">{},</span> <span class="s1">&#39;vol_models&#39;</span><span class="p">:</span> <span class="p">{}}</span>
        
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">model</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">return_models</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">y_pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X_test_scaled</span><span class="p">)</span>
            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;return_models&#39;</span><span class="p">][</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;rmse&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mean_squared_error</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_return_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)),</span>
                <span class="s1">&#39;r2&#39;</span><span class="p">:</span> <span class="n">r2_score</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_return_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">),</span>
                <span class="s1">&#39;dir_acc&#39;</span><span class="p">:</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">y_return_test</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">y_pred</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="p">}</span>
        
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">model</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vol_models</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">y_pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X_test_scaled</span><span class="p">)</span>
            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;vol_models&#39;</span><span class="p">][</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;rmse&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mean_squared_error</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_vol_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)),</span>
                <span class="s1">&#39;r2&#39;</span><span class="p">:</span> <span class="n">r2_score</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_vol_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
            <span class="p">}</span>
        
        <span class="k">return</span> <span class="n">results</span>
    
    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Generate all predictions.&quot;&quot;&quot;</span>
        <span class="n">features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_features</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="n">X_scaled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>
        
        <span class="n">predictions</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">features</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        
        <span class="c1"># Ensemble return prediction</span>
        <span class="n">return_preds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">features</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">return_models</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">return_preds</span> <span class="o">+=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_scaled</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">return_models</span><span class="p">)</span>
        <span class="n">predictions</span><span class="p">[</span><span class="s1">&#39;return_pred&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">return_preds</span>
        
        <span class="c1"># Volatility prediction</span>
        <span class="n">predictions</span><span class="p">[</span><span class="s1">&#39;vol_pred&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vol_models</span><span class="p">[</span><span class="s1">&#39;GB&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_scaled</span><span class="p">)</span>
        
        <span class="c1"># Quantile predictions</span>
        <span class="k">for</span> <span class="n">q</span><span class="p">,</span> <span class="n">model</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">quantile_models</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">predictions</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;q</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">q</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span><span class="si">:</span><span class="s1">02d</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_scaled</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">predictions</span>
    
    <span class="k">def</span> <span class="nf">plot_results</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Visualize results.&quot;&quot;&quot;</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
        
        <span class="c1"># Return predictions</span>
        <span class="n">best_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">return_models</span><span class="p">[</span><span class="s1">&#39;GB&#39;</span><span class="p">]</span>
        <span class="n">y_pred</span> <span class="o">=</span> <span class="n">best_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X_test_scaled</span><span class="p">)</span>
        
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_return_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">y_return_test</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_return_test</span><span class="o">.</span><span class="n">max</span><span class="p">()],</span>
                       <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">y_return_test</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_return_test</span><span class="o">.</span><span class="n">max</span><span class="p">()],</span> <span class="s1">&#39;r--&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Actual Return&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Predicted Return&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Return Prediction&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
        
        <span class="c1"># Volatility predictions</span>
        <span class="n">vol_pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vol_models</span><span class="p">[</span><span class="s1">&#39;GB&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X_test_scaled</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_vol_test</span><span class="p">,</span> <span class="n">vol_pred</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">y_vol_test</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_vol_test</span><span class="o">.</span><span class="n">max</span><span class="p">()],</span>
                       <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">y_vol_test</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_vol_test</span><span class="o">.</span><span class="n">max</span><span class="p">()],</span> <span class="s1">&#39;r--&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Actual Volatility&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Predicted Volatility&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Volatility Prediction&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
        
        <span class="c1"># Quantile predictions</span>
        <span class="n">q05</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">quantile_models</span><span class="p">[</span><span class="mf">0.05</span><span class="p">]</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X_test_scaled</span><span class="p">)</span>
        <span class="n">q95</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">quantile_models</span><span class="p">[</span><span class="mf">0.95</span><span class="p">]</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X_test_scaled</span><span class="p">)</span>
        
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">q05</span><span class="p">)),</span> <span class="n">q05</span><span class="p">,</span> <span class="n">q95</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;90% CI&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_return_test</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="s1">&#39;b-&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Actual&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Day&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Return&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Quantile Predictions&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
        
        <span class="c1"># Model comparison</span>
        <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluate</span><span class="p">()</span>
        <span class="n">models</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;return_models&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">r2_scores</span> <span class="o">=</span> <span class="p">[</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;return_models&#39;</span><span class="p">][</span><span class="n">m</span><span class="p">][</span><span class="s1">&#39;r2&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">models</span><span class="p">]</span>
        <span class="n">dir_accs</span> <span class="o">=</span> <span class="p">[</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;return_models&#39;</span><span class="p">][</span><span class="n">m</span><span class="p">][</span><span class="s1">&#39;dir_acc&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">models</span><span class="p">]</span>
        
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">models</span><span class="p">))</span>
        <span class="n">width</span> <span class="o">=</span> <span class="mf">0.35</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">r2_scores</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;R¬≤&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">dir_accs</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Dir Acc&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">models</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Model Comparison&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
        
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Test the complete system</span>

<span class="c1"># Get data</span>
<span class="n">ticker</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">Ticker</span><span class="p">(</span><span class="s2">&quot;SPY&quot;</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">ticker</span><span class="o">.</span><span class="n">history</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="s2">&quot;2y&quot;</span><span class="p">)</span>

<span class="c1"># Create and fit system</span>
<span class="n">system</span> <span class="o">=</span> <span class="n">ReturnPredictionSystem</span><span class="p">()</span>
<span class="n">system</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

<span class="c1"># Evaluate</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">system</span><span class="o">.</span><span class="n">evaluate</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Return Prediction Results:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;return_models&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Volatility Prediction Results:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;vol_models&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Visualize results</span>

<span class="n">system</span><span class="o">.</span><span class="n">plot_results</span><span class="p">()</span>
</code></pre></div>
<div class="md-cell key-takeaways"><hr />
<h2>Key Takeaways</h2>
<ol>
<li>
<p><strong>Regularized linear models</strong> (Ridge, Lasso, ElasticNet) are simple baselines that often perform well</p>
</li>
<li>
<p><strong>Tree-based regressors</strong> (Random Forest, Gradient Boosting) capture non-linear patterns</p>
</li>
<li>
<p><strong>Volatility is more predictable</strong> than returns due to clustering effects</p>
</li>
<li>
<p><strong>Quantile regression</strong> provides uncertainty estimates and is essential for risk management</p>
</li>
<li>
<p><strong>Low R¬≤ is normal</strong> for return prediction; even 1-5% can be profitable</p>
</li>
<li>
<p><strong>Direction accuracy</strong> often matters more than exact return prediction for trading</p>
</li>
<li>
<p><strong>Walk-forward validation</strong> prevents overfitting and simulates real trading conditions</p>
</li>
</ol>
<hr />
<p><strong>Next: Module 9 - Sentiment Analysis</strong> (Text processing, sentiment scoring, news signals)</p></div>
        <div class="nav-buttons">
            <button class="nav-btn prev-btn disabled" type="button">
                <span class="nav-btn-label">‚Üê Previous</span>
                <span class="nav-btn-name"></span>
            </button>
            <button class="nav-btn next-btn disabled" type="button">
                <span class="nav-btn-label">Next ‚Üí</span>
                <span class="nav-btn-name"></span>
            </button>
        </div>
        </div>
<div class="module-section" data-idx="9"><div class="md-cell module-header"><h1>Module 9: Sentiment Analysis</h1>
<h2>Part 3: Advanced Techniques</h2>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Duration</th>
<th>Exercises</th>
<th>Prerequisites</th>
</tr>
</thead>
<tbody>
<tr>
<td>~2.5 hours</td>
<td>6</td>
<td>Modules 1-8</td>
</tr>
</tbody>
</table></div>
<h3>Learning Objectives</h3>
<p>By the end of this module, you will be able to:
- Process and clean financial text data
- Apply sentiment scoring techniques to news and social media
- Use pre-trained models for financial sentiment
- Combine sentiment signals with price data
- Evaluate sentiment-based trading strategies</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">Counter</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>

<span class="c1"># NLP libraries</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">textblob</span> <span class="kn">import</span> <span class="n">TextBlob</span>
    <span class="n">HAS_TEXTBLOB</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">HAS_TEXTBLOB</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;TextBlob not installed. Install with: pip install textblob&quot;</span><span class="p">)</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">nltk</span>
    <span class="kn">from</span> <span class="nn">nltk.sentiment.vader</span> <span class="kn">import</span> <span class="n">SentimentIntensityAnalyzer</span>
    <span class="n">nltk</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="s1">&#39;vader_lexicon&#39;</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">nltk</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="s1">&#39;punkt&#39;</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">nltk</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="s1">&#39;stopwords&#39;</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">HAS_NLTK</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">HAS_NLTK</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;NLTK not installed. Install with: pip install nltk&quot;</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">sklearn.feature_extraction.text</span> <span class="kn">import</span> <span class="n">TfidfVectorizer</span><span class="p">,</span> <span class="n">CountVectorizer</span>
<span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">RandomForestClassifier</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">StandardScaler</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">TimeSeriesSplit</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">accuracy_score</span><span class="p">,</span> <span class="n">classification_report</span>

<span class="kn">import</span> <span class="nn">yfinance</span> <span class="k">as</span> <span class="nn">yf</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Module 9: Sentiment Analysis&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">40</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><hr />
<h2>Section 1: Text Processing Fundamentals</h2>
<p>Before analyzing sentiment, we need to clean and preprocess text data.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Sentiment Analysis Concepts</span>

<span class="n">sentiment_concepts</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">SENTIMENT ANALYSIS FOR FINANCE</span>
<span class="s2">==============================</span>

<span class="s2">Why Sentiment Matters:</span>
<span class="s2">----------------------</span>
<span class="s2">- Market moves on news and perception</span>
<span class="s2">- Sentiment can lead price movements</span>
<span class="s2">- Social media provides real-time signals</span>
<span class="s2">- News impacts trading volumes</span>

<span class="s2">Data Sources:</span>
<span class="s2">-------------</span>
<span class="s2">1. News Articles</span>
<span class="s2">   - Financial news (Bloomberg, Reuters)</span>
<span class="s2">   - Press releases</span>
<span class="s2">   - Analyst reports</span>

<span class="s2">2. Social Media</span>
<span class="s2">   - Twitter/X (high frequency)</span>
<span class="s2">   - Reddit (r/wallstreetbets)</span>
<span class="s2">   - StockTwits</span>

<span class="s2">3. Company Filings</span>
<span class="s2">   - 10-K, 10-Q reports</span>
<span class="s2">   - Earnings call transcripts</span>
<span class="s2">   - Conference calls</span>

<span class="s2">Sentiment Scoring Methods:</span>
<span class="s2">--------------------------</span>
<span class="s2">1. Lexicon-Based</span>
<span class="s2">   - Dictionary of positive/negative words</span>
<span class="s2">   - VADER, Loughran-McDonald</span>
<span class="s2">   - Fast but may miss context</span>

<span class="s2">2. Machine Learning</span>
<span class="s2">   - Train classifier on labeled data</span>
<span class="s2">   - Can capture nuance</span>
<span class="s2">   - Needs training data</span>

<span class="s2">3. Deep Learning</span>
<span class="s2">   - Transformers (BERT, FinBERT)</span>
<span class="s2">   - State-of-the-art accuracy</span>
<span class="s2">   - Computationally expensive</span>
<span class="s2">&quot;&quot;&quot;</span>
<span class="nb">print</span><span class="p">(</span><span class="n">sentiment_concepts</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Sample financial news headlines</span>

<span class="n">sample_headlines</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;Apple reports record quarterly earnings, beats analyst expectations&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Tech stocks tumble amid interest rate concerns&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Federal Reserve signals potential rate cuts in 2024&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Tesla faces production challenges, stock drops 5%&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Microsoft&#39;s AI investments show strong returns&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Oil prices surge on Middle East tensions&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Retail sales disappoint, raising recession fears&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Goldman Sachs upgrades Amazon to buy rating&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Cryptocurrency market sees massive selloff&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Strong jobs report eases inflation concerns&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Boeing faces new safety investigation&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Nvidia stock hits all-time high on AI demand&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Bank earnings mixed amid economic uncertainty&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Housing market shows signs of cooling&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Disney streaming losses narrow, shares rally&quot;</span>
<span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sample Headlines (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">sample_headlines</span><span class="p">)</span><span class="si">}</span><span class="s2">):&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">headline</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sample_headlines</span><span class="p">[:</span><span class="mi">5</span><span class="p">],</span> <span class="mi">1</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">. </span><span class="si">{</span><span class="n">headline</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Text preprocessing functions</span>

<span class="k">class</span> <span class="nc">TextPreprocessor</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Clean and preprocess financial text.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Common financial abbreviations to expand</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">abbreviations</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;Q1&#39;</span><span class="p">:</span> <span class="s1">&#39;first quarter&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Q2&#39;</span><span class="p">:</span> <span class="s1">&#39;second quarter&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Q3&#39;</span><span class="p">:</span> <span class="s1">&#39;third quarter&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Q4&#39;</span><span class="p">:</span> <span class="s1">&#39;fourth quarter&#39;</span><span class="p">,</span>
            <span class="s1">&#39;CEO&#39;</span><span class="p">:</span> <span class="s1">&#39;chief executive officer&#39;</span><span class="p">,</span>
            <span class="s1">&#39;CFO&#39;</span><span class="p">:</span> <span class="s1">&#39;chief financial officer&#39;</span><span class="p">,</span>
            <span class="s1">&#39;IPO&#39;</span><span class="p">:</span> <span class="s1">&#39;initial public offering&#39;</span><span class="p">,</span>
            <span class="s1">&#39;EPS&#39;</span><span class="p">:</span> <span class="s1">&#39;earnings per share&#39;</span><span class="p">,</span>
            <span class="s1">&#39;M&amp;A&#39;</span><span class="p">:</span> <span class="s1">&#39;mergers and acquisitions&#39;</span><span class="p">,</span>
            <span class="s1">&#39;YoY&#39;</span><span class="p">:</span> <span class="s1">&#39;year over year&#39;</span><span class="p">,</span>
            <span class="s1">&#39;QoQ&#39;</span><span class="p">:</span> <span class="s1">&#39;quarter over quarter&#39;</span>
        <span class="p">}</span>
        
        <span class="c1"># Stopwords (common words to remove)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stopwords</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="s1">&#39;the&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;an&#39;</span><span class="p">,</span> <span class="s1">&#39;is&#39;</span><span class="p">,</span> <span class="s1">&#39;are&#39;</span><span class="p">,</span> <span class="s1">&#39;was&#39;</span><span class="p">,</span> <span class="s1">&#39;were&#39;</span><span class="p">,</span> 
                             <span class="s1">&#39;be&#39;</span><span class="p">,</span> <span class="s1">&#39;been&#39;</span><span class="p">,</span> <span class="s1">&#39;being&#39;</span><span class="p">,</span> <span class="s1">&#39;have&#39;</span><span class="p">,</span> <span class="s1">&#39;has&#39;</span><span class="p">,</span> <span class="s1">&#39;had&#39;</span><span class="p">,</span>
                             <span class="s1">&#39;do&#39;</span><span class="p">,</span> <span class="s1">&#39;does&#39;</span><span class="p">,</span> <span class="s1">&#39;did&#39;</span><span class="p">,</span> <span class="s1">&#39;will&#39;</span><span class="p">,</span> <span class="s1">&#39;would&#39;</span><span class="p">,</span> <span class="s1">&#39;could&#39;</span><span class="p">,</span>
                             <span class="s1">&#39;should&#39;</span><span class="p">,</span> <span class="s1">&#39;may&#39;</span><span class="p">,</span> <span class="s1">&#39;might&#39;</span><span class="p">,</span> <span class="s1">&#39;must&#39;</span><span class="p">,</span> <span class="s1">&#39;shall&#39;</span><span class="p">,</span>
                             <span class="s1">&#39;and&#39;</span><span class="p">,</span> <span class="s1">&#39;or&#39;</span><span class="p">,</span> <span class="s1">&#39;but&#39;</span><span class="p">,</span> <span class="s1">&#39;if&#39;</span><span class="p">,</span> <span class="s1">&#39;then&#39;</span><span class="p">,</span> <span class="s1">&#39;else&#39;</span><span class="p">,</span>
                             <span class="s1">&#39;when&#39;</span><span class="p">,</span> <span class="s1">&#39;where&#39;</span><span class="p">,</span> <span class="s1">&#39;why&#39;</span><span class="p">,</span> <span class="s1">&#39;how&#39;</span><span class="p">,</span> <span class="s1">&#39;what&#39;</span><span class="p">,</span> <span class="s1">&#39;which&#39;</span><span class="p">,</span>
                             <span class="s1">&#39;who&#39;</span><span class="p">,</span> <span class="s1">&#39;whom&#39;</span><span class="p">,</span> <span class="s1">&#39;this&#39;</span><span class="p">,</span> <span class="s1">&#39;that&#39;</span><span class="p">,</span> <span class="s1">&#39;these&#39;</span><span class="p">,</span> <span class="s1">&#39;those&#39;</span><span class="p">,</span>
                             <span class="s1">&#39;to&#39;</span><span class="p">,</span> <span class="s1">&#39;of&#39;</span><span class="p">,</span> <span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="s1">&#39;for&#39;</span><span class="p">,</span> <span class="s1">&#39;on&#39;</span><span class="p">,</span> <span class="s1">&#39;with&#39;</span><span class="p">,</span> <span class="s1">&#39;at&#39;</span><span class="p">,</span>
                             <span class="s1">&#39;by&#39;</span><span class="p">,</span> <span class="s1">&#39;from&#39;</span><span class="p">,</span> <span class="s1">&#39;as&#39;</span><span class="p">,</span> <span class="s1">&#39;into&#39;</span><span class="p">,</span> <span class="s1">&#39;through&#39;</span><span class="p">,</span> <span class="s1">&#39;during&#39;</span><span class="p">])</span>
    
    <span class="k">def</span> <span class="nf">clean</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Basic text cleaning.&quot;&quot;&quot;</span>
        <span class="c1"># Lowercase</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        
        <span class="c1"># Remove URLs</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;http\S+|www\S+|https\S+&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
        
        <span class="c1"># Remove mentions and hashtags (for social media)</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;@\w+|#\w+&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
        
        <span class="c1"># Remove special characters but keep important punctuation</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[^a-zA-Z0-9\s\.\!\?\%\$]&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
        
        <span class="c1"># Remove extra whitespace</span>
        <span class="n">text</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
        
        <span class="k">return</span> <span class="n">text</span>
    
    <span class="k">def</span> <span class="nf">expand_abbreviations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Expand financial abbreviations.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">abbr</span><span class="p">,</span> <span class="n">expansion</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">abbreviations</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\b&#39;</span> <span class="o">+</span> <span class="n">abbr</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;\b&#39;</span><span class="p">,</span> <span class="n">expansion</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">text</span>
    
    <span class="k">def</span> <span class="nf">remove_stopwords</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Remove common stopwords.&quot;&quot;&quot;</span>
        <span class="n">words</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="n">words</span> <span class="o">=</span> <span class="p">[</span><span class="n">w</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">words</span> <span class="k">if</span> <span class="n">w</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stopwords</span><span class="p">]</span>
        <span class="k">return</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">words</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">remove_stops</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Full preprocessing pipeline.&quot;&quot;&quot;</span>
        <span class="n">text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clean</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="n">text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expand_abbreviations</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">remove_stops</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">remove_stopwords</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">text</span>

<span class="c1"># Test preprocessing</span>
<span class="n">preprocessor</span> <span class="o">=</span> <span class="n">TextPreprocessor</span><span class="p">()</span>

<span class="n">test_text</span> <span class="o">=</span> <span class="s2">&quot;Apple&#39;s Q4 EPS beats estimates! $AAPL @Bloomberg #stocks&quot;</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Original: </span><span class="si">{</span><span class="n">test_text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cleaned:  </span><span class="si">{</span><span class="n">preprocessor</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">test_text</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 9.1: Financial Text Cleaner (Guided)</span>

<span class="k">def</span> <span class="nf">clean_financial_text</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">extract_tickers</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Clean financial text and optionally extract stock tickers.</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        Dictionary with cleaned text and extracted information</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;original&#39;</span><span class="p">:</span> <span class="n">text</span><span class="p">,</span>
        <span class="s1">&#39;cleaned&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="s1">&#39;tickers&#39;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s1">&#39;numbers&#39;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s1">&#39;percentages&#39;</span><span class="p">:</span> <span class="p">[]</span>
    <span class="p">}</span>
    
    <span class="c1"># TODO: Extract stock tickers (pattern: $AAPL or just uppercase 2-5 letters)</span>
    <span class="k">if</span> <span class="n">extract_tickers</span><span class="p">:</span>
        <span class="n">ticker_pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;\$([A-Z]{1,5})|\b([A-Z]{2,5})\b&#39;</span>
        <span class="n">matches</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">______</span><span class="p">(</span><span class="n">ticker_pattern</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
        <span class="n">result</span><span class="p">[</span><span class="s1">&#39;tickers&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="n">m</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">matches</span> <span class="k">if</span> <span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="n">m</span><span class="p">[</span><span class="mi">1</span><span class="p">]]))</span>
    
    <span class="c1"># TODO: Extract percentages</span>
    <span class="n">pct_pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;([-+]?\d+\.?\d*)\s*%&#39;</span>
    <span class="n">result</span><span class="p">[</span><span class="s1">&#39;percentages&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">______</span><span class="p">(</span><span class="n">pct_pattern</span><span class="p">,</span> <span class="n">text</span><span class="p">)]</span>
    
    <span class="c1"># TODO: Extract numbers with $ sign</span>
    <span class="n">money_pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;\$([\d,]+\.?\d*)&#39;</span>
    <span class="n">result</span><span class="p">[</span><span class="s1">&#39;numbers&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">______</span><span class="p">(</span><span class="n">money_pattern</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
    
    <span class="c1"># Clean text</span>
    <span class="n">cleaned</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="n">cleaned</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[^a-zA-Z\s]&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">cleaned</span><span class="p">)</span>
    <span class="n">cleaned</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cleaned</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
    <span class="n">result</span><span class="p">[</span><span class="s1">&#39;cleaned&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cleaned</span>
    
    <span class="k">return</span> <span class="n">result</span>

<span class="c1"># Test</span>
<span class="c1"># result = clean_financial_text(&quot;$AAPL jumps 5.2% after beating Q4 estimates by $0.15&quot;)</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 9.1</summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">clean_financial_text</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">extract_tickers</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Clean financial text and optionally extract stock tickers.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;original&#39;</span><span class="p">:</span> <span class="n">text</span><span class="p">,</span>
        <span class="s1">&#39;cleaned&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="s1">&#39;tickers&#39;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s1">&#39;numbers&#39;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s1">&#39;percentages&#39;</span><span class="p">:</span> <span class="p">[]</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="n">extract_tickers</span><span class="p">:</span>
        <span class="n">ticker_pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;\$([A-Z]{1,5})|\b([A-Z]{2,5})\b&#39;</span>
        <span class="n">matches</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">ticker_pattern</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
        <span class="n">result</span><span class="p">[</span><span class="s1">&#39;tickers&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="n">m</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">matches</span> <span class="k">if</span> <span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="n">m</span><span class="p">[</span><span class="mi">1</span><span class="p">]]))</span>

    <span class="n">pct_pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;([-+]?\d+\.?\d*)\s*%&#39;</span>
    <span class="n">result</span><span class="p">[</span><span class="s1">&#39;percentages&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">pct_pattern</span><span class="p">,</span> <span class="n">text</span><span class="p">)]</span>

    <span class="n">money_pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;\$([\d,]+\.?\d*)&#39;</span>
    <span class="n">result</span><span class="p">[</span><span class="s1">&#39;numbers&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">money_pattern</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>

    <span class="n">cleaned</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="n">cleaned</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[^a-zA-Z\s]&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">cleaned</span><span class="p">)</span>
    <span class="n">cleaned</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cleaned</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
    <span class="n">result</span><span class="p">[</span><span class="s1">&#39;cleaned&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cleaned</span>

    <span class="k">return</span> <span class="n">result</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h2>Section 2: Lexicon-Based Sentiment</h2>
<p>Using predefined sentiment dictionaries to score text.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># VADER Sentiment Analysis</span>

<span class="k">if</span> <span class="n">HAS_NLTK</span><span class="p">:</span>
    <span class="n">sia</span> <span class="o">=</span> <span class="n">SentimentIntensityAnalyzer</span><span class="p">()</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;VADER Sentiment Analysis:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">headline</span> <span class="ow">in</span> <span class="n">sample_headlines</span><span class="p">[:</span><span class="mi">5</span><span class="p">]:</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="n">sia</span><span class="o">.</span><span class="n">polarity_scores</span><span class="p">(</span><span class="n">headline</span><span class="p">)</span>
        <span class="n">sentiment</span> <span class="o">=</span> <span class="s1">&#39;Positive&#39;</span> <span class="k">if</span> <span class="n">scores</span><span class="p">[</span><span class="s1">&#39;compound&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.05</span> <span class="k">else</span> \
                   <span class="s1">&#39;Negative&#39;</span> <span class="k">if</span> <span class="n">scores</span><span class="p">[</span><span class="s1">&#39;compound&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">0.05</span> <span class="k">else</span> <span class="s1">&#39;Neutral&#39;</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&#39;</span><span class="si">{</span><span class="n">headline</span><span class="p">[:</span><span class="mi">50</span><span class="p">]</span><span class="si">}</span><span class="s2">...&#39;&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Compound: </span><span class="si">{</span><span class="n">scores</span><span class="p">[</span><span class="s1">&#39;compound&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">sentiment</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Pos: </span><span class="si">{</span><span class="n">scores</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, Neg: </span><span class="si">{</span><span class="n">scores</span><span class="p">[</span><span class="s1">&#39;neg&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, Neu: </span><span class="si">{</span><span class="n">scores</span><span class="p">[</span><span class="s1">&#39;neu&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;NLTK not available&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Custom Financial Sentiment Lexicon</span>

<span class="k">class</span> <span class="nc">FinancialSentimentLexicon</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Custom sentiment scoring for financial text.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Financial-specific sentiment words</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">positive_words</span> <span class="o">=</span> <span class="p">{</span>
            <span class="c1"># Strong positive</span>
            <span class="s1">&#39;surge&#39;</span><span class="p">,</span> <span class="s1">&#39;soar&#39;</span><span class="p">,</span> <span class="s1">&#39;rally&#39;</span><span class="p">,</span> <span class="s1">&#39;boom&#39;</span><span class="p">,</span> <span class="s1">&#39;breakthrough&#39;</span><span class="p">,</span> <span class="s1">&#39;record&#39;</span><span class="p">,</span>
            <span class="s1">&#39;beat&#39;</span><span class="p">,</span> <span class="s1">&#39;exceed&#39;</span><span class="p">,</span> <span class="s1">&#39;outperform&#39;</span><span class="p">,</span> <span class="s1">&#39;upgrade&#39;</span><span class="p">,</span> <span class="s1">&#39;bullish&#39;</span><span class="p">,</span>
            <span class="c1"># Moderate positive</span>
            <span class="s1">&#39;gain&#39;</span><span class="p">,</span> <span class="s1">&#39;rise&#39;</span><span class="p">,</span> <span class="s1">&#39;grow&#39;</span><span class="p">,</span> <span class="s1">&#39;improve&#39;</span><span class="p">,</span> <span class="s1">&#39;strong&#39;</span><span class="p">,</span> <span class="s1">&#39;robust&#39;</span><span class="p">,</span>
            <span class="s1">&#39;optimistic&#39;</span><span class="p">,</span> <span class="s1">&#39;profitable&#39;</span><span class="p">,</span> <span class="s1">&#39;positive&#39;</span><span class="p">,</span> <span class="s1">&#39;success&#39;</span><span class="p">,</span>
            <span class="c1"># Mild positive</span>
            <span class="s1">&#39;stable&#39;</span><span class="p">,</span> <span class="s1">&#39;steady&#39;</span><span class="p">,</span> <span class="s1">&#39;maintain&#39;</span><span class="p">,</span> <span class="s1">&#39;recovery&#39;</span><span class="p">,</span> <span class="s1">&#39;rebound&#39;</span>
        <span class="p">}</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">negative_words</span> <span class="o">=</span> <span class="p">{</span>
            <span class="c1"># Strong negative</span>
            <span class="s1">&#39;crash&#39;</span><span class="p">,</span> <span class="s1">&#39;plunge&#39;</span><span class="p">,</span> <span class="s1">&#39;collapse&#39;</span><span class="p">,</span> <span class="s1">&#39;crisis&#39;</span><span class="p">,</span> <span class="s1">&#39;disaster&#39;</span><span class="p">,</span>
            <span class="s1">&#39;bankrupt&#39;</span><span class="p">,</span> <span class="s1">&#39;default&#39;</span><span class="p">,</span> <span class="s1">&#39;miss&#39;</span><span class="p">,</span> <span class="s1">&#39;downgrade&#39;</span><span class="p">,</span> <span class="s1">&#39;bearish&#39;</span><span class="p">,</span>
            <span class="c1"># Moderate negative</span>
            <span class="s1">&#39;fall&#39;</span><span class="p">,</span> <span class="s1">&#39;drop&#39;</span><span class="p">,</span> <span class="s1">&#39;decline&#39;</span><span class="p">,</span> <span class="s1">&#39;loss&#39;</span><span class="p">,</span> <span class="s1">&#39;weak&#39;</span><span class="p">,</span> <span class="s1">&#39;concern&#39;</span><span class="p">,</span>
            <span class="s1">&#39;fear&#39;</span><span class="p">,</span> <span class="s1">&#39;risk&#39;</span><span class="p">,</span> <span class="s1">&#39;warning&#39;</span><span class="p">,</span> <span class="s1">&#39;struggle&#39;</span><span class="p">,</span>
            <span class="c1"># Mild negative</span>
            <span class="s1">&#39;uncertainty&#39;</span><span class="p">,</span> <span class="s1">&#39;volatility&#39;</span><span class="p">,</span> <span class="s1">&#39;challenge&#39;</span><span class="p">,</span> <span class="s1">&#39;pressure&#39;</span><span class="p">,</span> <span class="s1">&#39;disappoint&#39;</span>
        <span class="p">}</span>
        
        <span class="c1"># Intensifiers and negations</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">intensifiers</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;very&#39;</span><span class="p">,</span> <span class="s1">&#39;extremely&#39;</span><span class="p">,</span> <span class="s1">&#39;significantly&#39;</span><span class="p">,</span> <span class="s1">&#39;sharply&#39;</span><span class="p">,</span> <span class="s1">&#39;dramatically&#39;</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">negations</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;not&#39;</span><span class="p">,</span> <span class="s1">&#39;no&#39;</span><span class="p">,</span> <span class="s1">&#39;never&#39;</span><span class="p">,</span> <span class="s1">&#39;neither&#39;</span><span class="p">,</span> <span class="s2">&quot;n&#39;t&quot;</span><span class="p">,</span> <span class="s1">&#39;without&#39;</span><span class="p">,</span> <span class="s1">&#39;lack&#39;</span><span class="p">}</span>
        
        <span class="c1"># Word weights</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">word_weights</span> <span class="o">=</span> <span class="p">{</span>
            <span class="c1"># Strong words get higher weights</span>
            <span class="s1">&#39;surge&#39;</span><span class="p">:</span> <span class="mf">2.0</span><span class="p">,</span> <span class="s1">&#39;crash&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">2.0</span><span class="p">,</span> <span class="s1">&#39;record&#39;</span><span class="p">:</span> <span class="mf">1.5</span><span class="p">,</span> <span class="s1">&#39;crisis&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">1.5</span><span class="p">,</span>
            <span class="s1">&#39;beat&#39;</span><span class="p">:</span> <span class="mf">1.2</span><span class="p">,</span> <span class="s1">&#39;miss&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">1.2</span><span class="p">,</span> <span class="s1">&#39;upgrade&#39;</span><span class="p">:</span> <span class="mf">1.5</span><span class="p">,</span> <span class="s1">&#39;downgrade&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">1.5</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">score</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Score sentiment of text.&quot;&quot;&quot;</span>
        <span class="n">text_lower</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">words</span> <span class="o">=</span> <span class="n">text_lower</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        
        <span class="n">positive_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">negative_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">weighted_score</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="n">prev_word</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">words</span><span class="p">:</span>
            <span class="c1"># Check for negation</span>
            <span class="n">negated</span> <span class="o">=</span> <span class="n">prev_word</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">negations</span>
            <span class="n">intensified</span> <span class="o">=</span> <span class="n">prev_word</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">intensifiers</span>
            
            <span class="n">multiplier</span> <span class="o">=</span> <span class="mf">1.5</span> <span class="k">if</span> <span class="n">intensified</span> <span class="k">else</span> <span class="mf">1.0</span>
            <span class="k">if</span> <span class="n">negated</span><span class="p">:</span>
                <span class="n">multiplier</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>
            
            <span class="k">if</span> <span class="n">word</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">positive_words</span><span class="p">:</span>
                <span class="n">weight</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">word_weights</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
                <span class="n">positive_count</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">weighted_score</span> <span class="o">+=</span> <span class="n">weight</span> <span class="o">*</span> <span class="n">multiplier</span>
            <span class="k">elif</span> <span class="n">word</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">negative_words</span><span class="p">:</span>
                <span class="n">weight</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">word_weights</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">)</span>
                <span class="n">negative_count</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">weighted_score</span> <span class="o">+=</span> <span class="n">weight</span> <span class="o">*</span> <span class="n">multiplier</span>
            
            <span class="n">prev_word</span> <span class="o">=</span> <span class="n">word</span>
        
        <span class="n">total_words</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">words</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;positive_count&#39;</span><span class="p">:</span> <span class="n">positive_count</span><span class="p">,</span>
            <span class="s1">&#39;negative_count&#39;</span><span class="p">:</span> <span class="n">negative_count</span><span class="p">,</span>
            <span class="s1">&#39;weighted_score&#39;</span><span class="p">:</span> <span class="n">weighted_score</span><span class="p">,</span>
            <span class="s1">&#39;normalized_score&#39;</span><span class="p">:</span> <span class="n">weighted_score</span> <span class="o">/</span> <span class="n">total_words</span> <span class="k">if</span> <span class="n">total_words</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;sentiment&#39;</span><span class="p">:</span> <span class="s1">&#39;positive&#39;</span> <span class="k">if</span> <span class="n">weighted_score</span> <span class="o">&gt;</span> <span class="mf">0.5</span> <span class="k">else</span> 
                        <span class="s1">&#39;negative&#39;</span> <span class="k">if</span> <span class="n">weighted_score</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">0.5</span> <span class="k">else</span> <span class="s1">&#39;neutral&#39;</span>
        <span class="p">}</span>

<span class="c1"># Test</span>
<span class="n">fin_lexicon</span> <span class="o">=</span> <span class="n">FinancialSentimentLexicon</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Financial Sentiment Lexicon:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>

<span class="k">for</span> <span class="n">headline</span> <span class="ow">in</span> <span class="n">sample_headlines</span><span class="p">[:</span><span class="mi">5</span><span class="p">]:</span>
    <span class="n">scores</span> <span class="o">=</span> <span class="n">fin_lexicon</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">headline</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&#39;</span><span class="si">{</span><span class="n">headline</span><span class="p">[:</span><span class="mi">50</span><span class="p">]</span><span class="si">}</span><span class="s2">...&#39;&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Score: </span><span class="si">{</span><span class="n">scores</span><span class="p">[</span><span class="s1">&#39;weighted_score&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">scores</span><span class="p">[</span><span class="s1">&#39;sentiment&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Pos words: </span><span class="si">{</span><span class="n">scores</span><span class="p">[</span><span class="s1">&#39;positive_count&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, Neg words: </span><span class="si">{</span><span class="n">scores</span><span class="p">[</span><span class="s1">&#39;negative_count&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 9.2: Sentiment Scorer (Guided)</span>

<span class="k">class</span> <span class="nc">SentimentScorer</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Combined sentiment scoring using multiple methods.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vader</span> <span class="o">=</span> <span class="n">SentimentIntensityAnalyzer</span><span class="p">()</span> <span class="k">if</span> <span class="n">HAS_NLTK</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fin_lexicon</span> <span class="o">=</span> <span class="n">FinancialSentimentLexicon</span><span class="p">()</span>
        
    <span class="k">def</span> <span class="nf">score_vader</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get VADER compound score.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">vader</span><span class="p">:</span>
            <span class="c1"># TODO: Get VADER polarity scores and return compound</span>
            <span class="n">scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vader</span><span class="o">.</span><span class="n">______</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">scores</span><span class="p">[</span><span class="s1">&#39;______&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="mf">0.0</span>
    
    <span class="k">def</span> <span class="nf">score_financial</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get financial lexicon score.&quot;&quot;&quot;</span>
        <span class="c1"># TODO: Get financial lexicon scores and return normalized score</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fin_lexicon</span><span class="o">.</span><span class="n">______</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">scores</span><span class="p">[</span><span class="s1">&#39;______&#39;</span><span class="p">]</span>
    
    <span class="k">def</span> <span class="nf">score_combined</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">vader_weight</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Combine VADER and financial lexicon scores.&quot;&quot;&quot;</span>
        <span class="n">vader_score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">score_vader</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="n">fin_score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">score_financial</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        
        <span class="c1"># Normalize financial score to [-1, 1] range</span>
        <span class="n">fin_normalized</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">fin_score</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        
        <span class="c1"># Combined score</span>
        <span class="n">combined</span> <span class="o">=</span> <span class="n">vader_weight</span> <span class="o">*</span> <span class="n">vader_score</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">vader_weight</span><span class="p">)</span> <span class="o">*</span> <span class="n">fin_normalized</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;vader&#39;</span><span class="p">:</span> <span class="n">vader_score</span><span class="p">,</span>
            <span class="s1">&#39;financial&#39;</span><span class="p">:</span> <span class="n">fin_score</span><span class="p">,</span>
            <span class="s1">&#39;combined&#39;</span><span class="p">:</span> <span class="n">combined</span><span class="p">,</span>
            <span class="s1">&#39;sentiment&#39;</span><span class="p">:</span> <span class="s1">&#39;positive&#39;</span> <span class="k">if</span> <span class="n">combined</span> <span class="o">&gt;</span> <span class="mf">0.1</span> <span class="k">else</span> <span class="s1">&#39;negative&#39;</span> <span class="k">if</span> <span class="n">combined</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">0.1</span> <span class="k">else</span> <span class="s1">&#39;neutral&#39;</span>
        <span class="p">}</span>

<span class="c1"># Test</span>
<span class="c1"># scorer = SentimentScorer()</span>
<span class="c1"># result = scorer.score_combined(&quot;Apple reports record earnings&quot;)</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 9.2</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">SentimentScorer</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vader</span> <span class="o">=</span> <span class="n">SentimentIntensityAnalyzer</span><span class="p">()</span> <span class="k">if</span> <span class="n">HAS_NLTK</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fin_lexicon</span> <span class="o">=</span> <span class="n">FinancialSentimentLexicon</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">score_vader</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">vader</span><span class="p">:</span>
            <span class="n">scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vader</span><span class="o">.</span><span class="n">polarity_scores</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">scores</span><span class="p">[</span><span class="s1">&#39;compound&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="mf">0.0</span>

    <span class="k">def</span> <span class="nf">score_financial</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fin_lexicon</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">scores</span><span class="p">[</span><span class="s1">&#39;normalized_score&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">score_combined</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">vader_weight</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="n">vader_score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">score_vader</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="n">fin_score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">score_financial</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

        <span class="n">fin_normalized</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">fin_score</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">combined</span> <span class="o">=</span> <span class="n">vader_weight</span> <span class="o">*</span> <span class="n">vader_score</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">vader_weight</span><span class="p">)</span> <span class="o">*</span> <span class="n">fin_normalized</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;vader&#39;</span><span class="p">:</span> <span class="n">vader_score</span><span class="p">,</span>
            <span class="s1">&#39;financial&#39;</span><span class="p">:</span> <span class="n">fin_score</span><span class="p">,</span>
            <span class="s1">&#39;combined&#39;</span><span class="p">:</span> <span class="n">combined</span><span class="p">,</span>
            <span class="s1">&#39;sentiment&#39;</span><span class="p">:</span> <span class="s1">&#39;positive&#39;</span> <span class="k">if</span> <span class="n">combined</span> <span class="o">&gt;</span> <span class="mf">0.1</span> <span class="k">else</span> <span class="s1">&#39;negative&#39;</span> <span class="k">if</span> <span class="n">combined</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">0.1</span> <span class="k">else</span> <span class="s1">&#39;neutral&#39;</span>
        <span class="p">}</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h2>Section 3: News Sentiment Features</h2>
<p>Creating tradeable features from news sentiment.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Simulate news data with timestamps</span>

<span class="k">def</span> <span class="nf">generate_simulated_news</span><span class="p">(</span><span class="n">n_days</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">252</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Generate simulated news data for demonstration.&quot;&quot;&quot;</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
    
    <span class="n">dates</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">end</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="o">.</span><span class="n">today</span><span class="p">(),</span> <span class="n">periods</span><span class="o">=</span><span class="n">n_days</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;B&#39;</span><span class="p">)</span>
    
    <span class="c1"># Templates</span>
    <span class="n">positive_templates</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;Stock surges on strong earnings report&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Analysts upgrade rating to buy&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Company announces record quarterly revenue&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Shares rally after positive guidance&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Investor optimism grows on deal news&quot;</span>
    <span class="p">]</span>
    
    <span class="n">negative_templates</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;Stock drops on disappointing results&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Analysts downgrade amid concerns&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Shares tumble on weak guidance&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Company faces regulatory challenges&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Investors worry about debt levels&quot;</span>
    <span class="p">]</span>
    
    <span class="n">neutral_templates</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;Company reports inline with expectations&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Stock trades sideways on mixed signals&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Analysts maintain hold rating&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Market awaits upcoming earnings release&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Trading volume remains steady&quot;</span>
    <span class="p">]</span>
    
    <span class="n">news_data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">date</span> <span class="ow">in</span> <span class="n">dates</span><span class="p">:</span>
        <span class="c1"># Generate 1-5 news items per day</span>
        <span class="n">n_news</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_news</span><span class="p">):</span>
            <span class="c1"># Randomly select sentiment</span>
            <span class="n">sentiment_type</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">([</span><span class="s1">&#39;positive&#39;</span><span class="p">,</span> <span class="s1">&#39;negative&#39;</span><span class="p">,</span> <span class="s1">&#39;neutral&#39;</span><span class="p">],</span> <span class="n">p</span><span class="o">=</span><span class="p">[</span><span class="mf">0.35</span><span class="p">,</span> <span class="mf">0.35</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">])</span>
            
            <span class="k">if</span> <span class="n">sentiment_type</span> <span class="o">==</span> <span class="s1">&#39;positive&#39;</span><span class="p">:</span>
                <span class="n">headline</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">positive_templates</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">sentiment_type</span> <span class="o">==</span> <span class="s1">&#39;negative&#39;</span><span class="p">:</span>
                <span class="n">headline</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">negative_templates</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">headline</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">neutral_templates</span><span class="p">)</span>
            
            <span class="n">news_data</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;date&#39;</span><span class="p">:</span> <span class="n">date</span><span class="p">,</span>
                <span class="s1">&#39;headline&#39;</span><span class="p">:</span> <span class="n">headline</span><span class="p">,</span>
                <span class="s1">&#39;true_sentiment&#39;</span><span class="p">:</span> <span class="n">sentiment_type</span>
            <span class="p">})</span>
    
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">news_data</span><span class="p">)</span>

<span class="c1"># Generate news</span>
<span class="n">news_df</span> <span class="o">=</span> <span class="n">generate_simulated_news</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generated </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">news_df</span><span class="p">)</span><span class="si">}</span><span class="s2"> news items over </span><span class="si">{</span><span class="n">news_df</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span><span class="si">}</span><span class="s2"> days&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Sample:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">news_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Create sentiment features from news</span>

<span class="k">def</span> <span class="nf">create_sentiment_features</span><span class="p">(</span><span class="n">news_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Aggregate news sentiment into daily features.&quot;&quot;&quot;</span>
    <span class="n">scorer</span> <span class="o">=</span> <span class="n">SentimentScorer</span><span class="p">()</span>
    
    <span class="c1"># Score each headline</span>
    <span class="n">news_df</span><span class="p">[</span><span class="s1">&#39;sentiment_score&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">news_df</span><span class="p">[</span><span class="s1">&#39;headline&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">scorer</span><span class="o">.</span><span class="n">score_combined</span><span class="p">(</span><span class="n">x</span><span class="p">)[</span><span class="s1">&#39;combined&#39;</span><span class="p">]</span>
    <span class="p">)</span>
    
    <span class="c1"># Aggregate by date</span>
    <span class="n">daily_features</span> <span class="o">=</span> <span class="n">news_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;date&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">({</span>
        <span class="s1">&#39;sentiment_score&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="s1">&#39;std&#39;</span><span class="p">,</span> <span class="s1">&#39;min&#39;</span><span class="p">,</span> <span class="s1">&#39;max&#39;</span><span class="p">,</span> <span class="s1">&#39;count&#39;</span><span class="p">],</span>
        <span class="s1">&#39;headline&#39;</span><span class="p">:</span> <span class="s1">&#39;count&#39;</span>
    <span class="p">})</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    
    <span class="c1"># Flatten column names</span>
    <span class="n">daily_features</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;sentiment_mean&#39;</span><span class="p">,</span> <span class="s1">&#39;sentiment_std&#39;</span><span class="p">,</span> <span class="s1">&#39;sentiment_min&#39;</span><span class="p">,</span>
        <span class="s1">&#39;sentiment_max&#39;</span><span class="p">,</span> <span class="s1">&#39;sentiment_count&#39;</span><span class="p">,</span> <span class="s1">&#39;news_count&#39;</span>
    <span class="p">]</span>
    
    <span class="c1"># Calculate additional features</span>
    <span class="n">daily_features</span><span class="p">[</span><span class="s1">&#39;sentiment_range&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">daily_features</span><span class="p">[</span><span class="s1">&#39;sentiment_max&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">daily_features</span><span class="p">[</span><span class="s1">&#39;sentiment_min&#39;</span><span class="p">]</span>
    <span class="n">daily_features</span><span class="p">[</span><span class="s1">&#39;sentiment_skew&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">daily_features</span><span class="p">[</span><span class="s1">&#39;sentiment_mean&#39;</span><span class="p">]</span> <span class="o">-</span> \
                                        <span class="p">(</span><span class="n">daily_features</span><span class="p">[</span><span class="s1">&#39;sentiment_max&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">daily_features</span><span class="p">[</span><span class="s1">&#39;sentiment_min&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span>
    
    <span class="c1"># Rolling features</span>
    <span class="n">daily_features</span> <span class="o">=</span> <span class="n">daily_features</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;date&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
    <span class="n">daily_features</span><span class="p">[</span><span class="s1">&#39;sentiment_ma3&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">daily_features</span><span class="p">[</span><span class="s1">&#39;sentiment_mean&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">daily_features</span><span class="p">[</span><span class="s1">&#39;sentiment_ma7&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">daily_features</span><span class="p">[</span><span class="s1">&#39;sentiment_mean&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">daily_features</span><span class="p">[</span><span class="s1">&#39;sentiment_momentum&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">daily_features</span><span class="p">[</span><span class="s1">&#39;sentiment_mean&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">daily_features</span><span class="p">[</span><span class="s1">&#39;sentiment_ma7&#39;</span><span class="p">]</span>
    
    <span class="k">return</span> <span class="n">daily_features</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

<span class="c1"># Create features</span>
<span class="n">sentiment_features</span> <span class="o">=</span> <span class="n">create_sentiment_features</span><span class="p">(</span><span class="n">news_df</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Daily sentiment features: </span><span class="si">{</span><span class="n">sentiment_features</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Features:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">sentiment_features</span><span class="o">.</span><span class="n">head</span><span class="p">())</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Visualize sentiment over time</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

<span class="c1"># Sentiment mean</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">sentiment_features</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">sentiment_features</span><span class="p">[</span><span class="s1">&#39;sentiment_mean&#39;</span><span class="p">],</span> 
             <span class="s1">&#39;b-&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Daily Mean&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">sentiment_features</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">sentiment_features</span><span class="p">[</span><span class="s1">&#39;sentiment_ma7&#39;</span><span class="p">],</span> 
             <span class="s1">&#39;r-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;7-Day MA&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">sentiment_features</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> 
                     <span class="n">sentiment_features</span><span class="p">[</span><span class="s1">&#39;sentiment_min&#39;</span><span class="p">],</span>
                     <span class="n">sentiment_features</span><span class="p">[</span><span class="s1">&#39;sentiment_max&#39;</span><span class="p">],</span>
                     <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Min-Max Range&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Sentiment Score&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Daily News Sentiment&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="c1"># News volume</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">sentiment_features</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">sentiment_features</span><span class="p">[</span><span class="s1">&#39;news_count&#39;</span><span class="p">],</span> 
           <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;steelblue&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;News Count&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Daily News Volume&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 9.3: Sentiment Feature Engineer (Guided)</span>

<span class="k">def</span> <span class="nf">create_advanced_sentiment_features</span><span class="p">(</span><span class="n">news_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> 
                                        <span class="n">lookback_days</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">14</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create advanced sentiment features with multiple lookback periods.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">scorer</span> <span class="o">=</span> <span class="n">SentimentScorer</span><span class="p">()</span>
    
    <span class="c1"># Score headlines</span>
    <span class="n">news_df</span> <span class="o">=</span> <span class="n">news_df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">news_df</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">news_df</span><span class="p">[</span><span class="s1">&#39;headline&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">scorer</span><span class="o">.</span><span class="n">score_combined</span><span class="p">(</span><span class="n">x</span><span class="p">)[</span><span class="s1">&#39;combined&#39;</span><span class="p">]</span>
    <span class="p">)</span>
    
    <span class="c1"># TODO: Aggregate by date</span>
    <span class="n">daily</span> <span class="o">=</span> <span class="n">news_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;date&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">({</span>
        <span class="s1">&#39;score&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="s1">&#39;std&#39;</span><span class="p">,</span> <span class="s1">&#39;count&#39;</span><span class="p">]</span>
    <span class="p">})</span>
    <span class="n">daily</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;sentiment&#39;</span><span class="p">,</span> <span class="s1">&#39;sentiment_std&#39;</span><span class="p">,</span> <span class="s1">&#39;news_count&#39;</span><span class="p">]</span>
    <span class="n">daily</span> <span class="o">=</span> <span class="n">daily</span><span class="o">.</span><span class="n">______</span><span class="p">()</span>
    
    <span class="c1"># Fill missing dates</span>
    <span class="n">full_dates</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">daily</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">daily</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;B&#39;</span><span class="p">)</span>
    <span class="n">daily</span> <span class="o">=</span> <span class="n">daily</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">full_dates</span><span class="p">)</span>
    <span class="n">daily</span><span class="p">[</span><span class="s1">&#39;sentiment&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">daily</span><span class="p">[</span><span class="s1">&#39;sentiment&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">daily</span><span class="p">[</span><span class="s1">&#39;news_count&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">daily</span><span class="p">[</span><span class="s1">&#39;news_count&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    
    <span class="c1"># TODO: Create rolling features for each lookback period</span>
    <span class="k">for</span> <span class="n">days</span> <span class="ow">in</span> <span class="n">lookback_days</span><span class="p">:</span>
        <span class="n">daily</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;sentiment_ma</span><span class="si">{</span><span class="n">days</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">daily</span><span class="p">[</span><span class="s1">&#39;sentiment&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">______</span><span class="p">(</span><span class="n">days</span><span class="p">)</span><span class="o">.</span><span class="n">______</span><span class="p">()</span>
        <span class="n">daily</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;sentiment_vol</span><span class="si">{</span><span class="n">days</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">daily</span><span class="p">[</span><span class="s1">&#39;sentiment&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">______</span><span class="p">(</span><span class="n">days</span><span class="p">)</span><span class="o">.</span><span class="n">______</span><span class="p">()</span>
    
    <span class="c1"># Sentiment momentum</span>
    <span class="n">daily</span><span class="p">[</span><span class="s1">&#39;sentiment_momentum&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">daily</span><span class="p">[</span><span class="s1">&#39;sentiment&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">daily</span><span class="p">[</span><span class="s1">&#39;sentiment_ma7&#39;</span><span class="p">]</span>
    
    <span class="c1"># Sentiment acceleration</span>
    <span class="n">daily</span><span class="p">[</span><span class="s1">&#39;sentiment_accel&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">daily</span><span class="p">[</span><span class="s1">&#39;sentiment_momentum&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span>
    
    <span class="k">return</span> <span class="n">daily</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

<span class="c1"># Test</span>
<span class="c1"># advanced_features = create_advanced_sentiment_features(news_df)</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 9.3</summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">create_advanced_sentiment_features</span><span class="p">(</span><span class="n">news_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> 
                                        <span class="n">lookback_days</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">14</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="n">scorer</span> <span class="o">=</span> <span class="n">SentimentScorer</span><span class="p">()</span>

    <span class="n">news_df</span> <span class="o">=</span> <span class="n">news_df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">news_df</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">news_df</span><span class="p">[</span><span class="s1">&#39;headline&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">scorer</span><span class="o">.</span><span class="n">score_combined</span><span class="p">(</span><span class="n">x</span><span class="p">)[</span><span class="s1">&#39;combined&#39;</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="n">daily</span> <span class="o">=</span> <span class="n">news_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;date&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">({</span>
        <span class="s1">&#39;score&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="s1">&#39;std&#39;</span><span class="p">,</span> <span class="s1">&#39;count&#39;</span><span class="p">]</span>
    <span class="p">})</span>
    <span class="n">daily</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;sentiment&#39;</span><span class="p">,</span> <span class="s1">&#39;sentiment_std&#39;</span><span class="p">,</span> <span class="s1">&#39;news_count&#39;</span><span class="p">]</span>
    <span class="n">daily</span> <span class="o">=</span> <span class="n">daily</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>

    <span class="n">full_dates</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">daily</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">daily</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;B&#39;</span><span class="p">)</span>
    <span class="n">daily</span> <span class="o">=</span> <span class="n">daily</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">full_dates</span><span class="p">)</span>
    <span class="n">daily</span><span class="p">[</span><span class="s1">&#39;sentiment&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">daily</span><span class="p">[</span><span class="s1">&#39;sentiment&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">daily</span><span class="p">[</span><span class="s1">&#39;news_count&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">daily</span><span class="p">[</span><span class="s1">&#39;news_count&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">days</span> <span class="ow">in</span> <span class="n">lookback_days</span><span class="p">:</span>
        <span class="n">daily</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;sentiment_ma</span><span class="si">{</span><span class="n">days</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">daily</span><span class="p">[</span><span class="s1">&#39;sentiment&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">days</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">daily</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;sentiment_vol</span><span class="si">{</span><span class="n">days</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">daily</span><span class="p">[</span><span class="s1">&#39;sentiment&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">days</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>

    <span class="n">daily</span><span class="p">[</span><span class="s1">&#39;sentiment_momentum&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">daily</span><span class="p">[</span><span class="s1">&#39;sentiment&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">daily</span><span class="p">[</span><span class="s1">&#39;sentiment_ma7&#39;</span><span class="p">]</span>
    <span class="n">daily</span><span class="p">[</span><span class="s1">&#39;sentiment_accel&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">daily</span><span class="p">[</span><span class="s1">&#39;sentiment_momentum&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">daily</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h2>Section 4: Sentiment Trading Signals</h2>
<p>Combining sentiment with price data for trading signals.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Combine sentiment with price data</span>

<span class="k">def</span> <span class="nf">combine_sentiment_with_price</span><span class="p">(</span><span class="n">sentiment_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> 
                                  <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;SPY&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Combine sentiment features with price data.&quot;&quot;&quot;</span>
    <span class="c1"># Get price data</span>
    <span class="n">ticker</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">Ticker</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
    <span class="n">price_df</span> <span class="o">=</span> <span class="n">ticker</span><span class="o">.</span><span class="n">history</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="s2">&quot;1y&quot;</span><span class="p">)</span>
    
    <span class="c1"># Calculate price features</span>
    <span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;returns&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span>
    <span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;volatility&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;returns&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
    
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">]:</span>
        <span class="n">price_df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;momentum_</span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
    
    <span class="c1"># Target: next day direction</span>
    <span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;returns&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    
    <span class="c1"># Merge with sentiment</span>
    <span class="n">price_df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">price_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tz_localize</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">sentiment_df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">sentiment_df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">tz_localize</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
    
    <span class="n">combined</span> <span class="o">=</span> <span class="n">price_df</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sentiment_df</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
    
    <span class="c1"># Fill missing sentiment with 0</span>
    <span class="n">sentiment_cols</span> <span class="o">=</span> <span class="n">sentiment_df</span><span class="o">.</span><span class="n">columns</span>
    <span class="n">combined</span><span class="p">[</span><span class="n">sentiment_cols</span><span class="p">]</span> <span class="o">=</span> <span class="n">combined</span><span class="p">[</span><span class="n">sentiment_cols</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">combined</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

<span class="c1"># Combine data</span>
<span class="n">combined_df</span> <span class="o">=</span> <span class="n">combine_sentiment_with_price</span><span class="p">(</span><span class="n">sentiment_features</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Combined data: </span><span class="si">{</span><span class="n">combined_df</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Columns: </span><span class="si">{</span><span class="n">combined_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Build sentiment-enhanced prediction model</span>

<span class="k">def</span> <span class="nf">build_sentiment_model</span><span class="p">(</span><span class="n">combined_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Build and evaluate sentiment-enhanced model.&quot;&quot;&quot;</span>
    <span class="c1"># Define features</span>
    <span class="n">price_features</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;volatility&#39;</span><span class="p">,</span> <span class="s1">&#39;momentum_5&#39;</span><span class="p">,</span> <span class="s1">&#39;momentum_10&#39;</span><span class="p">,</span> <span class="s1">&#39;momentum_20&#39;</span><span class="p">]</span>
    <span class="n">sentiment_features_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;sentiment_mean&#39;</span><span class="p">,</span> <span class="s1">&#39;sentiment_ma7&#39;</span><span class="p">,</span> <span class="s1">&#39;sentiment_momentum&#39;</span><span class="p">]</span>
    
    <span class="c1"># Available columns</span>
    <span class="n">price_available</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">price_features</span> <span class="k">if</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">combined_df</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
    <span class="n">sentiment_available</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">sentiment_features_cols</span> <span class="k">if</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">combined_df</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
    
    <span class="c1"># Models</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="c1"># Split</span>
    <span class="n">split_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">combined_df</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.8</span><span class="p">)</span>
    
    <span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
    
    <span class="c1"># Model 1: Price only</span>
    <span class="k">if</span> <span class="n">price_available</span><span class="p">:</span>
        <span class="n">X_price</span> <span class="o">=</span> <span class="n">combined_df</span><span class="p">[</span><span class="n">price_available</span><span class="p">]</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">combined_df</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span>
        
        <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span> <span class="o">=</span> <span class="n">X_price</span><span class="p">[:</span><span class="n">split_idx</span><span class="p">],</span> <span class="n">X_price</span><span class="p">[</span><span class="n">split_idx</span><span class="p">:]</span>
        <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">y</span><span class="p">[:</span><span class="n">split_idx</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">split_idx</span><span class="p">:]</span>
        
        <span class="n">X_train_scaled</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
        <span class="n">X_test_scaled</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
        
        <span class="n">model</span> <span class="o">=</span> <span class="n">RandomForestClassifier</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_scaled</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
        
        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;price_only&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;accuracy&#39;</span><span class="p">:</span> <span class="n">accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test_scaled</span><span class="p">)),</span>
            <span class="s1">&#39;features&#39;</span><span class="p">:</span> <span class="n">price_available</span>
        <span class="p">}</span>
    
    <span class="c1"># Model 2: Price + Sentiment</span>
    <span class="n">all_features</span> <span class="o">=</span> <span class="n">price_available</span> <span class="o">+</span> <span class="n">sentiment_available</span>
    <span class="k">if</span> <span class="n">all_features</span><span class="p">:</span>
        <span class="n">X_all</span> <span class="o">=</span> <span class="n">combined_df</span><span class="p">[</span><span class="n">all_features</span><span class="p">]</span>
        
        <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span> <span class="o">=</span> <span class="n">X_all</span><span class="p">[:</span><span class="n">split_idx</span><span class="p">],</span> <span class="n">X_all</span><span class="p">[</span><span class="n">split_idx</span><span class="p">:]</span>
        <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">y</span><span class="p">[:</span><span class="n">split_idx</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">split_idx</span><span class="p">:]</span>
        
        <span class="n">scaler_all</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
        <span class="n">X_train_scaled</span> <span class="o">=</span> <span class="n">scaler_all</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
        <span class="n">X_test_scaled</span> <span class="o">=</span> <span class="n">scaler_all</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
        
        <span class="n">model_all</span> <span class="o">=</span> <span class="n">RandomForestClassifier</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
        <span class="n">model_all</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_scaled</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
        
        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;price_sentiment&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;accuracy&#39;</span><span class="p">:</span> <span class="n">accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">model_all</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test_scaled</span><span class="p">)),</span>
            <span class="s1">&#39;features&#39;</span><span class="p">:</span> <span class="n">all_features</span><span class="p">,</span>
            <span class="s1">&#39;feature_importance&#39;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">all_features</span><span class="p">,</span> <span class="n">model_all</span><span class="o">.</span><span class="n">feature_importances_</span><span class="p">))</span>
        <span class="p">}</span>
    
    <span class="k">return</span> <span class="n">results</span>

<span class="c1"># Build models</span>
<span class="n">model_results</span> <span class="o">=</span> <span class="n">build_sentiment_model</span><span class="p">(</span><span class="n">combined_df</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Model Comparison:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">40</span><span class="p">)</span>
<span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">model_results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Accuracy: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Features: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;features&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;feature_importance&#39;</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Top Features:&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">feat</span><span class="p">,</span> <span class="n">imp</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;feature_importance&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="o">-</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])[:</span><span class="mi">3</span><span class="p">]:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    </span><span class="si">{</span><span class="n">feat</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">imp</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 9.4: Sentiment Trading System (Open-ended)</span>
<span class="c1">#</span>
<span class="c1"># Build a SentimentTradingSystem class that:</span>
<span class="c1"># - Processes news headlines to extract sentiment</span>
<span class="c1"># - Creates daily sentiment features</span>
<span class="c1"># - Combines with price data for signals</span>
<span class="c1"># - Generates buy/sell signals based on sentiment thresholds</span>
<span class="c1"># - Backtests the strategy and reports performance</span>
<span class="c1">#</span>
<span class="c1"># Your implementation:</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 9.4</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">SentimentTradingSystem</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Trading system based on news sentiment.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">buy_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">,</span> <span class="n">sell_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.2</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buy_threshold</span> <span class="o">=</span> <span class="n">buy_threshold</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sell_threshold</span> <span class="o">=</span> <span class="n">sell_threshold</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scorer</span> <span class="o">=</span> <span class="n">SentimentScorer</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">score_news</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">news_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Score all news headlines.&quot;&quot;&quot;</span>
        <span class="n">news_df</span> <span class="o">=</span> <span class="n">news_df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">news_df</span><span class="p">[</span><span class="s1">&#39;sentiment&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">news_df</span><span class="p">[</span><span class="s1">&#39;headline&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">scorer</span><span class="o">.</span><span class="n">score_combined</span><span class="p">(</span><span class="n">x</span><span class="p">)[</span><span class="s1">&#39;combined&#39;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">news_df</span>

    <span class="k">def</span> <span class="nf">aggregate_daily</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">news_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Aggregate to daily sentiment.&quot;&quot;&quot;</span>
        <span class="n">daily</span> <span class="o">=</span> <span class="n">news_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;date&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">({</span>
            <span class="s1">&#39;sentiment&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="s1">&#39;std&#39;</span><span class="p">,</span> <span class="s1">&#39;count&#39;</span><span class="p">]</span>
        <span class="p">})</span>
        <span class="n">daily</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;sentiment&#39;</span><span class="p">,</span> <span class="s1">&#39;sentiment_std&#39;</span><span class="p">,</span> <span class="s1">&#39;news_count&#39;</span><span class="p">]</span>
        <span class="n">daily</span><span class="p">[</span><span class="s1">&#39;sentiment_ma5&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">daily</span><span class="p">[</span><span class="s1">&#39;sentiment&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">daily</span><span class="p">[</span><span class="s1">&#39;sentiment_momentum&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">daily</span><span class="p">[</span><span class="s1">&#39;sentiment&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">daily</span><span class="p">[</span><span class="s1">&#39;sentiment_ma5&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">daily</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">generate_signals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sentiment_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Generate trading signals.&quot;&quot;&quot;</span>
        <span class="n">signals</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">sentiment_df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="n">signals</span><span class="p">[</span><span class="s1">&#39;sentiment&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sentiment_df</span><span class="p">[</span><span class="s1">&#39;sentiment&#39;</span><span class="p">]</span>
        <span class="n">signals</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># Buy signal</span>
        <span class="n">signals</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">sentiment_df</span><span class="p">[</span><span class="s1">&#39;sentiment&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">buy_threshold</span><span class="p">,</span> <span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="c1"># Sell signal</span>
        <span class="n">signals</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">sentiment_df</span><span class="p">[</span><span class="s1">&#39;sentiment&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">sell_threshold</span><span class="p">,</span> <span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

        <span class="n">signals</span><span class="p">[</span><span class="s1">&#39;position&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">signals</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span><span class="o">.</span><span class="n">ffill</span><span class="p">()</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">signals</span>

    <span class="k">def</span> <span class="nf">backtest</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">signals</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">prices</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Backtest the sentiment strategy.&quot;&quot;&quot;</span>
        <span class="n">prices</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">prices</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tz_localize</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>

        <span class="n">aligned</span> <span class="o">=</span> <span class="n">signals</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">prices</span><span class="p">[[</span><span class="s1">&#39;Close&#39;</span><span class="p">]],</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">)</span>
        <span class="n">aligned</span><span class="p">[</span><span class="s1">&#39;returns&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">aligned</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span>
        <span class="n">aligned</span><span class="p">[</span><span class="s1">&#39;strategy_returns&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">aligned</span><span class="p">[</span><span class="s1">&#39;position&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">aligned</span><span class="p">[</span><span class="s1">&#39;returns&#39;</span><span class="p">]</span>

        <span class="n">aligned</span><span class="p">[</span><span class="s1">&#39;cum_returns&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">aligned</span><span class="p">[</span><span class="s1">&#39;returns&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span>
        <span class="n">aligned</span><span class="p">[</span><span class="s1">&#39;cum_strategy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">aligned</span><span class="p">[</span><span class="s1">&#39;strategy_returns&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">aligned</span>

    <span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">backtest_results</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Evaluate strategy performance.&quot;&quot;&quot;</span>
        <span class="n">strat_rets</span> <span class="o">=</span> <span class="n">backtest_results</span><span class="p">[</span><span class="s1">&#39;strategy_returns&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;total_return&#39;</span><span class="p">:</span> <span class="n">backtest_results</span><span class="p">[</span><span class="s1">&#39;cum_strategy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s1">&#39;buy_hold_return&#39;</span><span class="p">:</span> <span class="n">backtest_results</span><span class="p">[</span><span class="s1">&#39;cum_returns&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s1">&#39;sharpe&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span> <span class="o">*</span> <span class="n">strat_rets</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">/</span> <span class="n">strat_rets</span><span class="o">.</span><span class="n">std</span><span class="p">(),</span>
            <span class="s1">&#39;win_rate&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">strat_rets</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
            <span class="s1">&#39;n_trades&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">backtest_results</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">plot_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">backtest_results</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Visualize results.&quot;&quot;&quot;</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">backtest_results</span><span class="p">[</span><span class="s1">&#39;cum_strategy&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Strategy&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">backtest_results</span><span class="p">[</span><span class="s1">&#39;cum_returns&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Buy &amp; Hold&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Sentiment Strategy Performance&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">backtest_results</span><span class="p">[</span><span class="s1">&#39;sentiment&#39;</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">buy_threshold</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sell_threshold</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Sentiment with Thresholds&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>


</details></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 9.5: News Impact Analyzer (Open-ended)</span>
<span class="c1">#</span>
<span class="c1"># Build a NewsImpactAnalyzer class that:</span>
<span class="c1"># - Measures price impact after news events</span>
<span class="c1"># - Categorizes news by sentiment intensity</span>
<span class="c1"># - Calculates average returns for each sentiment category</span>
<span class="c1"># - Identifies which types of news have the most impact</span>
<span class="c1"># - Provides statistical significance tests</span>
<span class="c1">#</span>
<span class="c1"># Your implementation:</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 9.5</summary>


<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span>

<span class="k">class</span> <span class="nc">NewsImpactAnalyzer</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Analyze impact of news on prices.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">impact_windows</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">impact_windows</span> <span class="o">=</span> <span class="n">impact_windows</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scorer</span> <span class="o">=</span> <span class="n">SentimentScorer</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">score_and_categorize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">news_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Score news and categorize by intensity.&quot;&quot;&quot;</span>
        <span class="n">news_df</span> <span class="o">=</span> <span class="n">news_df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">news_df</span><span class="p">[</span><span class="s1">&#39;sentiment&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">news_df</span><span class="p">[</span><span class="s1">&#39;headline&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">scorer</span><span class="o">.</span><span class="n">score_combined</span><span class="p">(</span><span class="n">x</span><span class="p">)[</span><span class="s1">&#39;combined&#39;</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="c1"># Categorize</span>
        <span class="n">news_df</span><span class="p">[</span><span class="s1">&#39;category&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">cut</span><span class="p">(</span>
            <span class="n">news_df</span><span class="p">[</span><span class="s1">&#39;sentiment&#39;</span><span class="p">],</span>
            <span class="n">bins</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.3</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">],</span>
            <span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Very Negative&#39;</span><span class="p">,</span> <span class="s1">&#39;Negative&#39;</span><span class="p">,</span> <span class="s1">&#39;Neutral&#39;</span><span class="p">,</span> <span class="s1">&#39;Positive&#39;</span><span class="p">,</span> <span class="s1">&#39;Very Positive&#39;</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">news_df</span>

    <span class="k">def</span> <span class="nf">calculate_impact</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">news_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> 
                         <span class="n">price_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate price impact for each news item.&quot;&quot;&quot;</span>
        <span class="n">news_df</span> <span class="o">=</span> <span class="n">news_df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">price_df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">price_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tz_localize</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">window</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">impact_windows</span><span class="p">:</span>
            <span class="n">impacts</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">news_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                <span class="n">date</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">date</span> <span class="ow">in</span> <span class="n">price_df</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">idx</span> <span class="o">=</span> <span class="n">price_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="n">date</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">idx</span> <span class="o">+</span> <span class="n">window</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">price_df</span><span class="p">):</span>
                            <span class="n">impact</span> <span class="o">=</span> <span class="p">(</span>
                                <span class="n">price_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">idx</span> <span class="o">+</span> <span class="n">window</span><span class="p">][</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span> <span class="o">/</span> 
                                <span class="n">price_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
                            <span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">impact</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">impact</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">impact</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="n">impacts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">impact</span><span class="p">)</span>

            <span class="n">news_df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;impact_</span><span class="si">{</span><span class="n">window</span><span class="si">}</span><span class="s1">d&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">impacts</span>

        <span class="k">return</span> <span class="n">news_df</span>

    <span class="k">def</span> <span class="nf">analyze_by_category</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">news_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Analyze impact by sentiment category.&quot;&quot;&quot;</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">category</span> <span class="ow">in</span> <span class="n">news_df</span><span class="p">[</span><span class="s1">&#39;category&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
            <span class="n">cat_df</span> <span class="o">=</span> <span class="n">news_df</span><span class="p">[</span><span class="n">news_df</span><span class="p">[</span><span class="s1">&#39;category&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">category</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">window</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">impact_windows</span><span class="p">:</span>
                <span class="n">impact_col</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;impact_</span><span class="si">{</span><span class="n">window</span><span class="si">}</span><span class="s1">d&#39;</span>
                <span class="n">impacts</span> <span class="o">=</span> <span class="n">cat_df</span><span class="p">[</span><span class="n">impact_col</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">impacts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># T-test against zero</span>
                    <span class="n">t_stat</span><span class="p">,</span> <span class="n">p_value</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">ttest_1samp</span><span class="p">(</span><span class="n">impacts</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

                    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                        <span class="s1">&#39;category&#39;</span><span class="p">:</span> <span class="n">category</span><span class="p">,</span>
                        <span class="s1">&#39;window&#39;</span><span class="p">:</span> <span class="n">window</span><span class="p">,</span>
                        <span class="s1">&#39;mean_impact&#39;</span><span class="p">:</span> <span class="n">impacts</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
                        <span class="s1">&#39;std_impact&#39;</span><span class="p">:</span> <span class="n">impacts</span><span class="o">.</span><span class="n">std</span><span class="p">(),</span>
                        <span class="s1">&#39;n_samples&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">impacts</span><span class="p">),</span>
                        <span class="s1">&#39;t_stat&#39;</span><span class="p">:</span> <span class="n">t_stat</span><span class="p">,</span>
                        <span class="s1">&#39;p_value&#39;</span><span class="p">:</span> <span class="n">p_value</span><span class="p">,</span>
                        <span class="s1">&#39;significant&#39;</span><span class="p">:</span> <span class="n">p_value</span> <span class="o">&lt;</span> <span class="mf">0.05</span>
                    <span class="p">})</span>

        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">plot_impact</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">analysis_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Visualize impact by category.&quot;&quot;&quot;</span>
        <span class="n">pivot</span> <span class="o">=</span> <span class="n">analysis_df</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span>
            <span class="n">index</span><span class="o">=</span><span class="s1">&#39;category&#39;</span><span class="p">,</span> 
            <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;window&#39;</span><span class="p">,</span> 
            <span class="n">values</span><span class="o">=</span><span class="s1">&#39;mean_impact&#39;</span>
        <span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
        <span class="n">pivot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">())</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Average Price Impact by Sentiment Category&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Sentiment Category&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Mean Return&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;Days After&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>


</details></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 9.6: Complete Sentiment Pipeline (Open-ended)</span>
<span class="c1">#</span>
<span class="c1"># Build a SentimentPipeline class that:</span>
<span class="c1"># - Ingests raw news data</span>
<span class="c1"># - Cleans and preprocesses text</span>
<span class="c1"># - Scores sentiment using multiple methods</span>
<span class="c1"># - Creates tradeable features</span>
<span class="c1"># - Builds and evaluates ML models</span>
<span class="c1"># - Generates signals and backtests</span>
<span class="c1"># - Produces a comprehensive report</span>
<span class="c1">#</span>
<span class="c1"># Your implementation:</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 9.6</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">SentimentPipeline</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;End-to-end sentiment analysis pipeline.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">preprocessor</span> <span class="o">=</span> <span class="n">TextPreprocessor</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scorer</span> <span class="o">=</span> <span class="n">SentimentScorer</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">RandomForestClassifier</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">preprocess</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">news_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Clean and preprocess news.&quot;&quot;&quot;</span>
        <span class="n">news_df</span> <span class="o">=</span> <span class="n">news_df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">news_df</span><span class="p">[</span><span class="s1">&#39;cleaned&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">news_df</span><span class="p">[</span><span class="s1">&#39;headline&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">preprocessor</span><span class="o">.</span><span class="n">process</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">news_df</span>

    <span class="k">def</span> <span class="nf">score</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">news_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Score sentiment.&quot;&quot;&quot;</span>
        <span class="n">news_df</span><span class="p">[</span><span class="s1">&#39;sentiment&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">news_df</span><span class="p">[</span><span class="s1">&#39;headline&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">scorer</span><span class="o">.</span><span class="n">score_combined</span><span class="p">(</span><span class="n">x</span><span class="p">)[</span><span class="s1">&#39;combined&#39;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">news_df</span>

    <span class="k">def</span> <span class="nf">create_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">news_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Create daily features.&quot;&quot;&quot;</span>
        <span class="n">daily</span> <span class="o">=</span> <span class="n">news_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;date&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">({</span>
            <span class="s1">&#39;sentiment&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="s1">&#39;std&#39;</span><span class="p">,</span> <span class="s1">&#39;min&#39;</span><span class="p">,</span> <span class="s1">&#39;max&#39;</span><span class="p">,</span> <span class="s1">&#39;count&#39;</span><span class="p">]</span>
        <span class="p">})</span>
        <span class="n">daily</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;sent_mean&#39;</span><span class="p">,</span> <span class="s1">&#39;sent_std&#39;</span><span class="p">,</span> <span class="s1">&#39;sent_min&#39;</span><span class="p">,</span> <span class="s1">&#39;sent_max&#39;</span><span class="p">,</span> <span class="s1">&#39;news_count&#39;</span><span class="p">]</span>

        <span class="c1"># Rolling features</span>
        <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">14</span><span class="p">]:</span>
            <span class="n">daily</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;sent_ma</span><span class="si">{</span><span class="n">w</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">daily</span><span class="p">[</span><span class="s1">&#39;sent_mean&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">w</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="n">daily</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;sent_vol</span><span class="si">{</span><span class="n">w</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">daily</span><span class="p">[</span><span class="s1">&#39;sent_mean&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">w</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>

        <span class="n">daily</span><span class="p">[</span><span class="s1">&#39;sent_momentum&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">daily</span><span class="p">[</span><span class="s1">&#39;sent_mean&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">daily</span><span class="p">[</span><span class="s1">&#39;sent_ma7&#39;</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">daily</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">combine_with_price</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> 
                           <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;SPY&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Combine with price data.&quot;&quot;&quot;</span>
        <span class="n">ticker</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">Ticker</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
        <span class="n">prices</span> <span class="o">=</span> <span class="n">ticker</span><span class="o">.</span><span class="n">history</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="s1">&#39;1y&#39;</span><span class="p">)</span>

        <span class="n">prices</span><span class="p">[</span><span class="s1">&#39;returns&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prices</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span>
        <span class="n">prices</span><span class="p">[</span><span class="s1">&#39;volatility&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prices</span><span class="p">[</span><span class="s1">&#39;returns&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
        <span class="n">prices</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">prices</span><span class="p">[</span><span class="s1">&#39;returns&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

        <span class="n">prices</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">prices</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tz_localize</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">combined</span> <span class="o">=</span> <span class="n">prices</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">combined</span>

    <span class="k">def</span> <span class="nf">train_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">combined</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">test_frac</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Train prediction model.&quot;&quot;&quot;</span>
        <span class="n">feature_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;volatility&#39;</span><span class="p">,</span> <span class="s1">&#39;sent_mean&#39;</span><span class="p">,</span> <span class="s1">&#39;sent_ma7&#39;</span><span class="p">,</span> <span class="s1">&#39;sent_momentum&#39;</span><span class="p">]</span>
        <span class="n">available</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">feature_cols</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">combined</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>

        <span class="n">X</span> <span class="o">=</span> <span class="n">combined</span><span class="p">[</span><span class="n">available</span><span class="p">]</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">combined</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span>

        <span class="n">split_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">test_frac</span><span class="p">))</span>
        <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span> <span class="o">=</span> <span class="n">X</span><span class="p">[:</span><span class="n">split_idx</span><span class="p">],</span> <span class="n">X</span><span class="p">[</span><span class="n">split_idx</span><span class="p">:]</span>
        <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">y</span><span class="p">[:</span><span class="n">split_idx</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">split_idx</span><span class="p">:]</span>

        <span class="n">X_train_scaled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
        <span class="n">X_test_scaled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_scaled</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;train_accuracy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_train_scaled</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;test_accuracy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_test_scaled</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;feature_importance&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">available</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">feature_importances_</span><span class="p">))</span>

        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">run_pipeline</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">news_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;SPY&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Run full pipeline.&quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Preprocessing...&quot;</span><span class="p">)</span>
        <span class="n">news_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">preprocess</span><span class="p">(</span><span class="n">news_df</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Scoring sentiment...&quot;</span><span class="p">)</span>
        <span class="n">news_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">news_df</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Creating features...&quot;</span><span class="p">)</span>
        <span class="n">features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_features</span><span class="p">(</span><span class="n">news_df</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Combining with prices...&quot;</span><span class="p">)</span>
        <span class="n">combined</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">combine_with_price</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="n">symbol</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Training model...&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_model</span><span class="p">(</span><span class="n">combined</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Pipeline Complete!&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span>

    <span class="k">def</span> <span class="nf">generate_report</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Generate text report.&quot;&quot;&quot;</span>
        <span class="n">report</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;Sentiment Pipeline Report</span>
<span class="s2">========================</span>

<span class="s2">Model Performance:</span>
<span class="s2">  Train Accuracy: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;train_accuracy&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2"></span>
<span class="s2">  Test Accuracy: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;test_accuracy&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2"></span>

<span class="s2">Feature Importance:</span>
<span class="s2">&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">feat</span><span class="p">,</span> <span class="n">imp</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;feature_importance&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span>
            <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="o">-</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="p">):</span>
            <span class="n">report</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">feat</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">imp</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="k">return</span> <span class="n">report</span>
</code></pre></div>


</details></div>
<div class="md-cell module-project"><hr />
<h2>Module Project: News Sentiment Trading System</h2>
<p>Build a complete system that combines news sentiment analysis with trading signals.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">NewsSentimentTradingSystem</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Complete news sentiment trading system.</span>
<span class="sd">    </span>
<span class="sd">    Features:</span>
<span class="sd">    - Multi-method sentiment scoring</span>
<span class="sd">    - Feature engineering for sentiment</span>
<span class="sd">    - ML model for signal generation</span>
<span class="sd">    - Backtesting and performance analysis</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">preprocessor</span> <span class="o">=</span> <span class="n">TextPreprocessor</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scorer</span> <span class="o">=</span> <span class="n">SentimentScorer</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">RandomForestClassifier</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
        
    <span class="k">def</span> <span class="nf">process_news</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">news_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Process raw news data.&quot;&quot;&quot;</span>
        <span class="n">news_df</span> <span class="o">=</span> <span class="n">news_df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        
        <span class="c1"># Clean text</span>
        <span class="n">news_df</span><span class="p">[</span><span class="s1">&#39;cleaned&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">news_df</span><span class="p">[</span><span class="s1">&#39;headline&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">preprocessor</span><span class="o">.</span><span class="n">process</span><span class="p">)</span>
        
        <span class="c1"># Score sentiment</span>
        <span class="n">news_df</span><span class="p">[</span><span class="s1">&#39;sentiment&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">news_df</span><span class="p">[</span><span class="s1">&#39;headline&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">scorer</span><span class="o">.</span><span class="n">score_combined</span><span class="p">(</span><span class="n">x</span><span class="p">)[</span><span class="s1">&#39;combined&#39;</span><span class="p">]</span>
        <span class="p">)</span>
        
        <span class="k">return</span> <span class="n">news_df</span>
    
    <span class="k">def</span> <span class="nf">create_daily_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">news_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Aggregate news to daily features.&quot;&quot;&quot;</span>
        <span class="n">daily</span> <span class="o">=</span> <span class="n">news_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;date&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">({</span>
            <span class="s1">&#39;sentiment&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="s1">&#39;std&#39;</span><span class="p">,</span> <span class="s1">&#39;min&#39;</span><span class="p">,</span> <span class="s1">&#39;max&#39;</span><span class="p">,</span> <span class="s1">&#39;count&#39;</span><span class="p">]</span>
        <span class="p">})</span>
        <span class="n">daily</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;sent_mean&#39;</span><span class="p">,</span> <span class="s1">&#39;sent_std&#39;</span><span class="p">,</span> <span class="s1">&#39;sent_min&#39;</span><span class="p">,</span> <span class="s1">&#39;sent_max&#39;</span><span class="p">,</span> <span class="s1">&#39;news_count&#39;</span><span class="p">]</span>
        <span class="n">daily</span> <span class="o">=</span> <span class="n">daily</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
        
        <span class="c1"># Rolling features</span>
        <span class="k">for</span> <span class="n">window</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">14</span><span class="p">]:</span>
            <span class="n">daily</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;sent_ma</span><span class="si">{</span><span class="n">window</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">daily</span><span class="p">[</span><span class="s1">&#39;sent_mean&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        
        <span class="c1"># Momentum and volatility</span>
        <span class="n">daily</span><span class="p">[</span><span class="s1">&#39;sent_momentum&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">daily</span><span class="p">[</span><span class="s1">&#39;sent_mean&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">daily</span><span class="p">[</span><span class="s1">&#39;sent_ma7&#39;</span><span class="p">]</span>
        <span class="n">daily</span><span class="p">[</span><span class="s1">&#39;sent_vol7&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">daily</span><span class="p">[</span><span class="s1">&#39;sent_mean&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
        
        <span class="k">return</span> <span class="n">daily</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">prepare_training_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sentiment_features</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> 
                              <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;SPY&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Prepare training data with price and sentiment.&quot;&quot;&quot;</span>
        <span class="c1"># Get price data</span>
        <span class="n">ticker</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">Ticker</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
        <span class="n">prices</span> <span class="o">=</span> <span class="n">ticker</span><span class="o">.</span><span class="n">history</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="s2">&quot;1y&quot;</span><span class="p">)</span>
        
        <span class="c1"># Price features</span>
        <span class="n">prices</span><span class="p">[</span><span class="s1">&#39;returns&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prices</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span>
        <span class="n">prices</span><span class="p">[</span><span class="s1">&#39;volatility&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prices</span><span class="p">[</span><span class="s1">&#39;returns&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
        <span class="n">prices</span><span class="p">[</span><span class="s1">&#39;momentum_5&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prices</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">prices</span><span class="p">[</span><span class="s1">&#39;momentum_20&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prices</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
        
        <span class="c1"># Target</span>
        <span class="n">prices</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">prices</span><span class="p">[</span><span class="s1">&#39;returns&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        
        <span class="c1"># Merge</span>
        <span class="n">prices</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">prices</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tz_localize</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">combined</span> <span class="o">=</span> <span class="n">prices</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sentiment_features</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
        
        <span class="c1"># Fill missing sentiment</span>
        <span class="n">sent_cols</span> <span class="o">=</span> <span class="n">sentiment_features</span><span class="o">.</span><span class="n">columns</span>
        <span class="n">combined</span><span class="p">[</span><span class="n">sent_cols</span><span class="p">]</span> <span class="o">=</span> <span class="n">combined</span><span class="p">[</span><span class="n">sent_cols</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">combined</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">combined_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">test_frac</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Train the trading model.&quot;&quot;&quot;</span>
        <span class="c1"># Features</span>
        <span class="n">feature_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;volatility&#39;</span><span class="p">,</span> <span class="s1">&#39;momentum_5&#39;</span><span class="p">,</span> <span class="s1">&#39;momentum_20&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;sent_mean&#39;</span><span class="p">,</span> <span class="s1">&#39;sent_ma7&#39;</span><span class="p">,</span> <span class="s1">&#39;sent_momentum&#39;</span><span class="p">,</span> <span class="s1">&#39;sent_vol7&#39;</span><span class="p">]</span>
        <span class="n">available</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">feature_cols</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">combined_df</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
        
        <span class="n">X</span> <span class="o">=</span> <span class="n">combined_df</span><span class="p">[</span><span class="n">available</span><span class="p">]</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">combined_df</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span>
        
        <span class="c1"># Split</span>
        <span class="n">split_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">test_frac</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">X_train</span> <span class="o">=</span> <span class="n">X</span><span class="p">[:</span><span class="n">split_idx</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">X_test</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">split_idx</span><span class="p">:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y_train</span> <span class="o">=</span> <span class="n">y</span><span class="p">[:</span><span class="n">split_idx</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y_test</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">split_idx</span><span class="p">:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_returns</span> <span class="o">=</span> <span class="n">combined_df</span><span class="p">[</span><span class="s1">&#39;returns&#39;</span><span class="p">][</span><span class="n">split_idx</span><span class="p">:]</span>
        
        <span class="c1"># Scale and train</span>
        <span class="n">X_train_scaled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X_train</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_scaled</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_train</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_names</span> <span class="o">=</span> <span class="n">available</span>
        
        <span class="k">return</span> <span class="bp">self</span>
    
    <span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Evaluate model performance.&quot;&quot;&quot;</span>
        <span class="n">X_train_scaled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X_train</span><span class="p">)</span>
        <span class="n">X_test_scaled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X_test</span><span class="p">)</span>
        
        <span class="n">y_pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test_scaled</span><span class="p">)</span>
        
        <span class="c1"># Classification metrics</span>
        <span class="n">train_acc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_train_scaled</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_train</span><span class="p">)</span>
        <span class="n">test_acc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_test_scaled</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_test</span><span class="p">)</span>
        
        <span class="c1"># Financial metrics</span>
        <span class="n">pred_series</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">y_pred</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">y_test</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="n">strategy_returns</span> <span class="o">=</span> <span class="n">pred_series</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_returns</span>
        <span class="n">strategy_returns</span> <span class="o">=</span> <span class="n">strategy_returns</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
        
        <span class="n">total_return</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">strategy_returns</span><span class="p">)</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">bh_return</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_returns</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">strategy_returns</span><span class="o">.</span><span class="n">index</span><span class="p">])</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">sharpe</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span> <span class="o">*</span> <span class="n">strategy_returns</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">/</span> <span class="n">strategy_returns</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;train_accuracy&#39;</span><span class="p">:</span> <span class="n">train_acc</span><span class="p">,</span>
            <span class="s1">&#39;test_accuracy&#39;</span><span class="p">:</span> <span class="n">test_acc</span><span class="p">,</span>
            <span class="s1">&#39;total_return&#39;</span><span class="p">:</span> <span class="n">total_return</span><span class="p">,</span>
            <span class="s1">&#39;buy_hold_return&#39;</span><span class="p">:</span> <span class="n">bh_return</span><span class="p">,</span>
            <span class="s1">&#39;outperformance&#39;</span><span class="p">:</span> <span class="n">total_return</span> <span class="o">-</span> <span class="n">bh_return</span><span class="p">,</span>
            <span class="s1">&#39;sharpe_ratio&#39;</span><span class="p">:</span> <span class="n">sharpe</span><span class="p">,</span>
            <span class="s1">&#39;feature_importance&#39;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">feature_names</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">feature_importances_</span><span class="p">))</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">plot_results</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Visualize results.&quot;&quot;&quot;</span>
        <span class="n">X_test_scaled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X_test</span><span class="p">)</span>
        <span class="n">y_pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test_scaled</span><span class="p">)</span>
        
        <span class="n">pred_series</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">y_pred</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">y_test</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="n">strategy_returns</span> <span class="o">=</span> <span class="n">pred_series</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_returns</span>
        
        <span class="n">cum_strategy</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">strategy_returns</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span>
        <span class="n">cum_bh</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_returns</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span>
        
        <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
        
        <span class="c1"># Cumulative returns</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">cum_strategy</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">cum_strategy</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Strategy&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">cum_bh</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">cum_bh</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Buy &amp; Hold&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Cumulative Return&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Sentiment Trading Strategy Performance&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
        
        <span class="c1"># Feature importance</span>
        <span class="n">importance</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">feature_importances_</span><span class="p">,</span>
            <span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">feature_names</span>
        <span class="p">)</span><span class="o">.</span><span class="n">sort_values</span><span class="p">()</span>
        
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="n">importance</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">importance</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;steelblue&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Feature Importance&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Model Feature Importance&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
        
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Run the complete system</span>

<span class="c1"># Generate simulated news</span>
<span class="n">news_data</span> <span class="o">=</span> <span class="n">generate_simulated_news</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span>

<span class="c1"># Create system</span>
<span class="n">system</span> <span class="o">=</span> <span class="n">NewsSentimentTradingSystem</span><span class="p">()</span>

<span class="c1"># Process news</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Processing news...&quot;</span><span class="p">)</span>
<span class="n">processed_news</span> <span class="o">=</span> <span class="n">system</span><span class="o">.</span><span class="n">process_news</span><span class="p">(</span><span class="n">news_data</span><span class="p">)</span>

<span class="c1"># Create features</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Creating features...&quot;</span><span class="p">)</span>
<span class="n">sentiment_features</span> <span class="o">=</span> <span class="n">system</span><span class="o">.</span><span class="n">create_daily_features</span><span class="p">(</span><span class="n">processed_news</span><span class="p">)</span>

<span class="c1"># Prepare training data</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Preparing training data...&quot;</span><span class="p">)</span>
<span class="n">combined</span> <span class="o">=</span> <span class="n">system</span><span class="o">.</span><span class="n">prepare_training_data</span><span class="p">(</span><span class="n">sentiment_features</span><span class="p">)</span>

<span class="c1"># Train</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Training model...&quot;</span><span class="p">)</span>
<span class="n">system</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">combined</span><span class="p">)</span>

<span class="c1"># Evaluate</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">system</span><span class="o">.</span><span class="n">evaluate</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;SENTIMENT TRADING SYSTEM RESULTS&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Classification Metrics:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Train Accuracy: </span><span class="si">{</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;train_accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Test Accuracy:  </span><span class="si">{</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;test_accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Financial Metrics:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Strategy Return: </span><span class="si">{</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;total_return&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Buy &amp; Hold:      </span><span class="si">{</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;buy_hold_return&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Outperformance:  </span><span class="si">{</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;outperformance&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Sharpe Ratio:    </span><span class="si">{</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;sharpe_ratio&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Top Features:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">feat</span><span class="p">,</span> <span class="n">imp</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;feature_importance&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="o">-</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])[:</span><span class="mi">5</span><span class="p">]:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">feat</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">imp</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Visualize</span>

<span class="n">system</span><span class="o">.</span><span class="n">plot_results</span><span class="p">()</span>
</code></pre></div>
<div class="md-cell key-takeaways"><hr />
<h2>Key Takeaways</h2>
<ol>
<li>
<p><strong>Text preprocessing</strong> is critical: clean, normalize, and extract relevant entities from financial text</p>
</li>
<li>
<p><strong>Lexicon-based methods</strong> (VADER, custom dictionaries) are fast but may miss context</p>
</li>
<li>
<p><strong>Financial-specific lexicons</strong> outperform general sentiment tools for market data</p>
</li>
<li>
<p><strong>Sentiment features</strong> should include means, volatility, momentum, and rolling statistics</p>
</li>
<li>
<p><strong>Combining sentiment with price features</strong> often improves prediction accuracy</p>
</li>
<li>
<p><strong>News impact analysis</strong> helps identify which sentiment signals are most predictive</p>
</li>
<li>
<p><strong>Real-time news</strong> sources (Twitter, news APIs) provide actionable signals but require careful latency management</p>
</li>
</ol>
<hr />
<p><strong>Next: Module 10 - Alternative Data</strong> (Web scraping, social media, multi-source features)</p></div>
        <div class="nav-buttons">
            <button class="nav-btn prev-btn disabled" type="button">
                <span class="nav-btn-label">‚Üê Previous</span>
                <span class="nav-btn-name"></span>
            </button>
            <button class="nav-btn next-btn disabled" type="button">
                <span class="nav-btn-label">Next ‚Üí</span>
                <span class="nav-btn-name"></span>
            </button>
        </div>
        </div>
<div class="module-section" data-idx="10"><div class="md-cell module-header"><h1>Module 10: Alternative Data</h1>
<h2>Part 3: Advanced Techniques</h2>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Duration</th>
<th>Exercises</th>
<th>Prerequisites</th>
</tr>
</thead>
<tbody>
<tr>
<td>~2.5 hours</td>
<td>6</td>
<td>Modules 1-9</td>
</tr>
</tbody>
</table></div>
<h3>Learning Objectives</h3>
<p>By the end of this module, you will be able to:
- Understand alternative data sources for trading
- Collect data from web and API sources
- Process and clean social media data
- Combine multiple data sources into features
- Build multi-source prediction models</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>

<span class="c1"># Data collection</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">requests</span>
    <span class="n">HAS_REQUESTS</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">HAS_REQUESTS</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;requests not installed. Install with: pip install requests&quot;</span><span class="p">)</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">bs4</span> <span class="kn">import</span> <span class="n">BeautifulSoup</span>
    <span class="n">HAS_BS4</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">HAS_BS4</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;BeautifulSoup not installed. Install with: pip install beautifulsoup4&quot;</span><span class="p">)</span>

<span class="c1"># ML</span>
<span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">RandomForestClassifier</span><span class="p">,</span> <span class="n">GradientBoostingClassifier</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">StandardScaler</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">TimeSeriesSplit</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">accuracy_score</span><span class="p">,</span> <span class="n">classification_report</span>

<span class="kn">import</span> <span class="nn">yfinance</span> <span class="k">as</span> <span class="nn">yf</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Module 10: Alternative Data&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">40</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><hr />
<h2>Section 1: Alternative Data Sources</h2>
<p>Understanding the landscape of non-traditional data for trading.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Alternative Data Overview</span>

<span class="n">alt_data_overview</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">ALTERNATIVE DATA FOR TRADING</span>
<span class="s2">============================</span>

<span class="s2">What is Alternative Data?</span>
<span class="s2">-------------------------</span>
<span class="s2">Non-traditional data sources beyond price/volume that provide</span>
<span class="s2">insights into economic activity, company performance, or sentiment.</span>

<span class="s2">Categories:</span>
<span class="s2">-----------</span>

<span class="s2">1. SOCIAL &amp; SENTIMENT</span>
<span class="s2">   - Twitter/X posts and trends</span>
<span class="s2">   - Reddit (r/wallstreetbets, r/investing)</span>
<span class="s2">   - StockTwits messages</span>
<span class="s2">   - News headlines and articles</span>
<span class="s2">   - Analyst reports</span>

<span class="s2">2. WEB DATA</span>
<span class="s2">   - Google Trends search volume</span>
<span class="s2">   - Website traffic (SimilarWeb)</span>
<span class="s2">   - Job postings (LinkedIn, Indeed)</span>
<span class="s2">   - Product reviews and ratings</span>
<span class="s2">   - Price comparison sites</span>

<span class="s2">3. TRANSACTION DATA</span>
<span class="s2">   - Credit card transactions</span>
<span class="s2">   - Point of sale data</span>
<span class="s2">   - App usage metrics</span>
<span class="s2">   - Email receipts</span>

<span class="s2">4. GEOSPATIAL DATA</span>
<span class="s2">   - Satellite imagery</span>
<span class="s2">   - GPS/location data</span>
<span class="s2">   - Foot traffic counts</span>
<span class="s2">   - Shipping/logistics tracking</span>

<span class="s2">5. GOVERNMENT &amp; ECONOMIC</span>
<span class="s2">   - SEC filings</span>
<span class="s2">   - Patent applications</span>
<span class="s2">   - Building permits</span>
<span class="s2">   - Import/export data</span>

<span class="s2">Considerations:</span>
<span class="s2">---------------</span>
<span class="s2">- Data quality and consistency</span>
<span class="s2">- Latency and timeliness</span>
<span class="s2">- Cost of acquisition</span>
<span class="s2">- Legal/compliance issues</span>
<span class="s2">- Alpha decay (as data becomes common)</span>
<span class="s2">&quot;&quot;&quot;</span>
<span class="nb">print</span><span class="p">(</span><span class="n">alt_data_overview</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Simulate alternative data sources</span>

<span class="k">def</span> <span class="nf">generate_simulated_alt_data</span><span class="p">(</span><span class="n">n_days</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">252</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;AAPL&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;Generate simulated alternative data for demonstration.&quot;&quot;&quot;</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
    
    <span class="n">dates</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">end</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="o">.</span><span class="n">today</span><span class="p">(),</span> <span class="n">periods</span><span class="o">=</span><span class="n">n_days</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;B&#39;</span><span class="p">)</span>
    
    <span class="c1"># 1. Social Media Metrics</span>
    <span class="n">social_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
        <span class="s1">&#39;date&#39;</span><span class="p">:</span> <span class="n">dates</span><span class="p">,</span>
        <span class="s1">&#39;twitter_mentions&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">poisson</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="n">n_days</span><span class="p">),</span>
        <span class="s1">&#39;twitter_sentiment&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="n">n_days</span><span class="p">),</span>
        <span class="s1">&#39;reddit_posts&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">poisson</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="n">n_days</span><span class="p">),</span>
        <span class="s1">&#39;reddit_comments&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">poisson</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="n">n_days</span><span class="p">),</span>
        <span class="s1">&#39;stocktwits_messages&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">poisson</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="n">n_days</span><span class="p">),</span>
        <span class="s1">&#39;stocktwits_bullish_pct&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">beta</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">n_days</span><span class="p">)</span>  <span class="c1"># Slightly bullish bias</span>
    <span class="p">})</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;date&#39;</span><span class="p">)</span>
    
    <span class="c1"># 2. Web Traffic Data</span>
    <span class="n">base_traffic</span> <span class="o">=</span> <span class="mi">1000000</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">50000</span><span class="p">,</span> <span class="n">n_days</span><span class="p">))</span>
    <span class="n">web_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
        <span class="s1">&#39;date&#39;</span><span class="p">:</span> <span class="n">dates</span><span class="p">,</span>
        <span class="s1">&#39;website_visits&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">base_traffic</span><span class="p">,</span> <span class="mi">500000</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span>
        <span class="s1">&#39;app_downloads&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">poisson</span><span class="p">(</span><span class="mi">10000</span><span class="p">,</span> <span class="n">n_days</span><span class="p">),</span>
        <span class="s1">&#39;google_trend_score&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="n">n_days</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span>
        <span class="s1">&#39;product_reviews&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">poisson</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="n">n_days</span><span class="p">),</span>
        <span class="s1">&#39;avg_review_score&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mf">4.2</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="n">n_days</span><span class="p">)</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
    <span class="p">})</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;date&#39;</span><span class="p">)</span>
    
    <span class="c1"># 3. Job Posting Data</span>
    <span class="n">base_jobs</span> <span class="o">=</span> <span class="mi">200</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">n_days</span><span class="p">))</span>
    <span class="n">job_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
        <span class="s1">&#39;date&#39;</span><span class="p">:</span> <span class="n">dates</span><span class="p">,</span>
        <span class="s1">&#39;job_postings&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">base_jobs</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span>
        <span class="s1">&#39;engineering_jobs&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">poisson</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="n">n_days</span><span class="p">),</span>
        <span class="s1">&#39;sales_jobs&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">poisson</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="n">n_days</span><span class="p">),</span>
        <span class="s1">&#39;avg_salary_listed&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">120000</span><span class="p">,</span> <span class="mi">20000</span><span class="p">,</span> <span class="n">n_days</span><span class="p">)</span>
    <span class="p">})</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;date&#39;</span><span class="p">)</span>
    
    <span class="c1"># 4. Satellite/Foot Traffic Data</span>
    <span class="n">geo_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
        <span class="s1">&#39;date&#39;</span><span class="p">:</span> <span class="n">dates</span><span class="p">,</span>
        <span class="s1">&#39;store_foot_traffic&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">poisson</span><span class="p">(</span><span class="mi">5000</span><span class="p">,</span> <span class="n">n_days</span><span class="p">),</span>
        <span class="s1">&#39;parking_lot_fill&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">beta</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">n_days</span><span class="p">),</span>
        <span class="s1">&#39;shipping_containers&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">poisson</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="n">n_days</span><span class="p">)</span>
    <span class="p">})</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;date&#39;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;social&#39;</span><span class="p">:</span> <span class="n">social_data</span><span class="p">,</span>
        <span class="s1">&#39;web&#39;</span><span class="p">:</span> <span class="n">web_data</span><span class="p">,</span>
        <span class="s1">&#39;jobs&#39;</span><span class="p">:</span> <span class="n">job_data</span><span class="p">,</span>
        <span class="s1">&#39;geo&#39;</span><span class="p">:</span> <span class="n">geo_data</span>
    <span class="p">}</span>

<span class="c1"># Generate data</span>
<span class="n">alt_data</span> <span class="o">=</span> <span class="n">generate_simulated_alt_data</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Generated Alternative Data:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">source</span><span class="p">,</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">alt_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">source</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Columns: </span><span class="si">{</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Shape: </span><span class="si">{</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Visualize alternative data</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

<span class="c1"># Social media</span>
<span class="n">ax1</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">alt_data</span><span class="p">[</span><span class="s1">&#39;social&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">alt_data</span><span class="p">[</span><span class="s1">&#39;social&#39;</span><span class="p">][</span><span class="s1">&#39;twitter_mentions&#39;</span><span class="p">],</span> 
         <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Twitter Mentions&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Mentions&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Social Media Activity&#39;</span><span class="p">)</span>
<span class="n">ax1_twin</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>
<span class="n">ax1_twin</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">alt_data</span><span class="p">[</span><span class="s1">&#39;social&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">alt_data</span><span class="p">[</span><span class="s1">&#39;social&#39;</span><span class="p">][</span><span class="s1">&#39;twitter_sentiment&#39;</span><span class="p">],</span> 
              <span class="s1">&#39;r-&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Sentiment&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
<span class="n">ax1_twin</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Sentiment&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="c1"># Web traffic</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">alt_data</span><span class="p">[</span><span class="s1">&#39;web&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">alt_data</span><span class="p">[</span><span class="s1">&#39;web&#39;</span><span class="p">][</span><span class="s1">&#39;website_visits&#39;</span><span class="p">],</span> 
                <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Website Visits&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">alt_data</span><span class="p">[</span><span class="s1">&#39;web&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">alt_data</span><span class="p">[</span><span class="s1">&#39;web&#39;</span><span class="p">][</span><span class="s1">&#39;google_trend_score&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">20000</span><span class="p">,</span> 
                <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Google Trends (scaled)&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Visits&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Web Traffic Metrics&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="c1"># Job postings</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">alt_data</span><span class="p">[</span><span class="s1">&#39;jobs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">alt_data</span><span class="p">[</span><span class="s1">&#39;jobs&#39;</span><span class="p">][</span><span class="s1">&#39;job_postings&#39;</span><span class="p">],</span> 
                        <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Total Jobs&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">alt_data</span><span class="p">[</span><span class="s1">&#39;jobs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">alt_data</span><span class="p">[</span><span class="s1">&#39;jobs&#39;</span><span class="p">][</span><span class="s1">&#39;engineering_jobs&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> 
                <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Engineering (x4)&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Job Postings&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Job Market Indicators&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="c1"># Geospatial</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">alt_data</span><span class="p">[</span><span class="s1">&#39;geo&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">alt_data</span><span class="p">[</span><span class="s1">&#39;geo&#39;</span><span class="p">][</span><span class="s1">&#39;store_foot_traffic&#39;</span><span class="p">],</span> 
                <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Foot Traffic&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Daily Visitors&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Physical Activity Indicators&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 10.1: Alt Data Feature Calculator (Guided)</span>

<span class="k">def</span> <span class="nf">calculate_alt_data_features</span><span class="p">(</span><span class="n">alt_data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">],</span> 
                                 <span class="n">lookback_days</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">20</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate features from alternative data sources.</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        DataFrame with all calculated features</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">features</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    
    <span class="c1"># Social features</span>
    <span class="n">social</span> <span class="o">=</span> <span class="n">alt_data</span><span class="p">[</span><span class="s1">&#39;social&#39;</span><span class="p">]</span>
    <span class="n">features</span><span class="p">[</span><span class="s1">&#39;social_sentiment&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">social</span><span class="p">[</span><span class="s1">&#39;twitter_sentiment&#39;</span><span class="p">]</span>
    <span class="n">features</span><span class="p">[</span><span class="s1">&#39;social_volume&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">social</span><span class="p">[</span><span class="s1">&#39;twitter_mentions&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">social</span><span class="p">[</span><span class="s1">&#39;reddit_posts&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">10</span>
    <span class="n">features</span><span class="p">[</span><span class="s1">&#39;bullish_ratio&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">social</span><span class="p">[</span><span class="s1">&#39;stocktwits_bullish_pct&#39;</span><span class="p">]</span>
    
    <span class="c1"># TODO: Calculate rolling features for social</span>
    <span class="k">for</span> <span class="n">days</span> <span class="ow">in</span> <span class="n">lookback_days</span><span class="p">:</span>
        <span class="n">features</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;sentiment_ma</span><span class="si">{</span><span class="n">days</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">social</span><span class="p">[</span><span class="s1">&#39;twitter_sentiment&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">______</span><span class="p">(</span><span class="n">days</span><span class="p">)</span><span class="o">.</span><span class="n">______</span><span class="p">()</span>
        <span class="n">features</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;volume_ma</span><span class="si">{</span><span class="n">days</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;social_volume&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">______</span><span class="p">(</span><span class="n">days</span><span class="p">)</span><span class="o">.</span><span class="n">______</span><span class="p">()</span>
    
    <span class="c1"># Web features</span>
    <span class="n">web</span> <span class="o">=</span> <span class="n">alt_data</span><span class="p">[</span><span class="s1">&#39;web&#39;</span><span class="p">]</span>
    <span class="n">features</span><span class="p">[</span><span class="s1">&#39;web_traffic&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">web</span><span class="p">[</span><span class="s1">&#39;website_visits&#39;</span><span class="p">]</span>
    <span class="n">features</span><span class="p">[</span><span class="s1">&#39;google_trends&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">web</span><span class="p">[</span><span class="s1">&#39;google_trend_score&#39;</span><span class="p">]</span>
    <span class="n">features</span><span class="p">[</span><span class="s1">&#39;review_score&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">web</span><span class="p">[</span><span class="s1">&#39;avg_review_score&#39;</span><span class="p">]</span>
    
    <span class="c1"># TODO: Calculate traffic changes</span>
    <span class="n">features</span><span class="p">[</span><span class="s1">&#39;traffic_change_5d&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">web</span><span class="p">[</span><span class="s1">&#39;website_visits&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">______</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">features</span><span class="p">[</span><span class="s1">&#39;traffic_change_20d&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">web</span><span class="p">[</span><span class="s1">&#39;website_visits&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">______</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
    
    <span class="c1"># Job features</span>
    <span class="n">jobs</span> <span class="o">=</span> <span class="n">alt_data</span><span class="p">[</span><span class="s1">&#39;jobs&#39;</span><span class="p">]</span>
    <span class="n">features</span><span class="p">[</span><span class="s1">&#39;job_postings&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">jobs</span><span class="p">[</span><span class="s1">&#39;job_postings&#39;</span><span class="p">]</span>
    <span class="n">features</span><span class="p">[</span><span class="s1">&#39;job_growth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">jobs</span><span class="p">[</span><span class="s1">&#39;job_postings&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
    <span class="n">features</span><span class="p">[</span><span class="s1">&#39;eng_to_sales&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">jobs</span><span class="p">[</span><span class="s1">&#39;engineering_jobs&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="n">jobs</span><span class="p">[</span><span class="s1">&#39;sales_jobs&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    
    <span class="c1"># Geo features</span>
    <span class="n">geo</span> <span class="o">=</span> <span class="n">alt_data</span><span class="p">[</span><span class="s1">&#39;geo&#39;</span><span class="p">]</span>
    <span class="n">features</span><span class="p">[</span><span class="s1">&#39;foot_traffic&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">geo</span><span class="p">[</span><span class="s1">&#39;store_foot_traffic&#39;</span><span class="p">]</span>
    <span class="n">features</span><span class="p">[</span><span class="s1">&#39;parking_fill&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">geo</span><span class="p">[</span><span class="s1">&#39;parking_lot_fill&#39;</span><span class="p">]</span>
    
    <span class="k">return</span> <span class="n">features</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

<span class="c1"># Test</span>
<span class="c1"># alt_features = calculate_alt_data_features(alt_data)</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 10.1</summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">calculate_alt_data_features</span><span class="p">(</span><span class="n">alt_data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">],</span> 
                                 <span class="n">lookback_days</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">20</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="n">features</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

    <span class="n">social</span> <span class="o">=</span> <span class="n">alt_data</span><span class="p">[</span><span class="s1">&#39;social&#39;</span><span class="p">]</span>
    <span class="n">features</span><span class="p">[</span><span class="s1">&#39;social_sentiment&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">social</span><span class="p">[</span><span class="s1">&#39;twitter_sentiment&#39;</span><span class="p">]</span>
    <span class="n">features</span><span class="p">[</span><span class="s1">&#39;social_volume&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">social</span><span class="p">[</span><span class="s1">&#39;twitter_mentions&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">social</span><span class="p">[</span><span class="s1">&#39;reddit_posts&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">10</span>
    <span class="n">features</span><span class="p">[</span><span class="s1">&#39;bullish_ratio&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">social</span><span class="p">[</span><span class="s1">&#39;stocktwits_bullish_pct&#39;</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">days</span> <span class="ow">in</span> <span class="n">lookback_days</span><span class="p">:</span>
        <span class="n">features</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;sentiment_ma</span><span class="si">{</span><span class="n">days</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">social</span><span class="p">[</span><span class="s1">&#39;twitter_sentiment&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">days</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">features</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;volume_ma</span><span class="si">{</span><span class="n">days</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;social_volume&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">days</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

    <span class="n">web</span> <span class="o">=</span> <span class="n">alt_data</span><span class="p">[</span><span class="s1">&#39;web&#39;</span><span class="p">]</span>
    <span class="n">features</span><span class="p">[</span><span class="s1">&#39;web_traffic&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">web</span><span class="p">[</span><span class="s1">&#39;website_visits&#39;</span><span class="p">]</span>
    <span class="n">features</span><span class="p">[</span><span class="s1">&#39;google_trends&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">web</span><span class="p">[</span><span class="s1">&#39;google_trend_score&#39;</span><span class="p">]</span>
    <span class="n">features</span><span class="p">[</span><span class="s1">&#39;review_score&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">web</span><span class="p">[</span><span class="s1">&#39;avg_review_score&#39;</span><span class="p">]</span>

    <span class="n">features</span><span class="p">[</span><span class="s1">&#39;traffic_change_5d&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">web</span><span class="p">[</span><span class="s1">&#39;website_visits&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">features</span><span class="p">[</span><span class="s1">&#39;traffic_change_20d&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">web</span><span class="p">[</span><span class="s1">&#39;website_visits&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>

    <span class="n">jobs</span> <span class="o">=</span> <span class="n">alt_data</span><span class="p">[</span><span class="s1">&#39;jobs&#39;</span><span class="p">]</span>
    <span class="n">features</span><span class="p">[</span><span class="s1">&#39;job_postings&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">jobs</span><span class="p">[</span><span class="s1">&#39;job_postings&#39;</span><span class="p">]</span>
    <span class="n">features</span><span class="p">[</span><span class="s1">&#39;job_growth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">jobs</span><span class="p">[</span><span class="s1">&#39;job_postings&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
    <span class="n">features</span><span class="p">[</span><span class="s1">&#39;eng_to_sales&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">jobs</span><span class="p">[</span><span class="s1">&#39;engineering_jobs&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="n">jobs</span><span class="p">[</span><span class="s1">&#39;sales_jobs&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">geo</span> <span class="o">=</span> <span class="n">alt_data</span><span class="p">[</span><span class="s1">&#39;geo&#39;</span><span class="p">]</span>
    <span class="n">features</span><span class="p">[</span><span class="s1">&#39;foot_traffic&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">geo</span><span class="p">[</span><span class="s1">&#39;store_foot_traffic&#39;</span><span class="p">]</span>
    <span class="n">features</span><span class="p">[</span><span class="s1">&#39;parking_fill&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">geo</span><span class="p">[</span><span class="s1">&#39;parking_lot_fill&#39;</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">features</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h2>Section 2: Web Data Collection</h2>
<p>Techniques for collecting data from web sources.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Web Scraping Best Practices</span>

<span class="n">web_scraping_guide</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">WEB DATA COLLECTION</span>
<span class="s2">===================</span>

<span class="s2">Data Collection Methods:</span>
<span class="s2">------------------------</span>
<span class="s2">1. APIs (Preferred)</span>
<span class="s2">   - Official, structured access</span>
<span class="s2">   - Rate limits and authentication</span>
<span class="s2">   - Examples: Twitter API, Reddit API, Alpha Vantage</span>

<span class="s2">2. Web Scraping</span>
<span class="s2">   - Parse HTML content</span>
<span class="s2">   - Tools: BeautifulSoup, Scrapy, Selenium</span>
<span class="s2">   - Requires understanding of HTML structure</span>

<span class="s2">3. Data Vendors</span>
<span class="s2">   - Pre-processed alternative data</span>
<span class="s2">   - Examples: Quandl, Bloomberg, Refinitiv</span>
<span class="s2">   - Higher cost, higher quality</span>

<span class="s2">Ethical Considerations:</span>
<span class="s2">-----------------------</span>
<span class="s2">- Respect robots.txt</span>
<span class="s2">- Rate limit your requests</span>
<span class="s2">- Don&#39;t overload servers</span>
<span class="s2">- Respect terms of service</span>
<span class="s2">- Handle personal data carefully</span>

<span class="s2">Technical Best Practices:</span>
<span class="s2">-------------------------</span>
<span class="s2">- Use user-agent headers</span>
<span class="s2">- Implement exponential backoff</span>
<span class="s2">- Cache responses</span>
<span class="s2">- Handle errors gracefully</span>
<span class="s2">- Log all requests</span>

<span class="s2">Common Data Sources:</span>
<span class="s2">--------------------</span>
<span class="s2">- SEC EDGAR (company filings)</span>
<span class="s2">- Google Trends</span>
<span class="s2">- GitHub activity</span>
<span class="s2">- Wikipedia pageviews</span>
<span class="s2">- Job boards (Indeed, LinkedIn)</span>
<span class="s2">&quot;&quot;&quot;</span>
<span class="nb">print</span><span class="p">(</span><span class="n">web_scraping_guide</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Web Data Collector Class</span>

<span class="k">class</span> <span class="nc">WebDataCollector</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Collect data from web sources with rate limiting and caching.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rate_limit</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            rate_limit: Minimum seconds between requests</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rate_limit</span> <span class="o">=</span> <span class="n">rate_limit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_request</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">min</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;User-Agent&#39;</span><span class="p">:</span> <span class="s1">&#39;Mozilla/5.0 (Educational/Research Purpose)&#39;</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">_wait_for_rate_limit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Ensure we don&#39;t exceed rate limit.&quot;&quot;&quot;</span>
        <span class="n">elapsed</span> <span class="o">=</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_request</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">elapsed</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">rate_limit</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">time</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rate_limit</span> <span class="o">-</span> <span class="n">elapsed</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_request</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">fetch_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">use_cache</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Fetch content from URL.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">HAS_REQUESTS</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;requests library not available&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        
        <span class="c1"># Check cache</span>
        <span class="k">if</span> <span class="n">use_cache</span> <span class="ow">and</span> <span class="n">url</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">url</span><span class="p">]</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_wait_for_rate_limit</span><span class="p">()</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
            <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
            <span class="n">content</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span>
            
            <span class="c1"># Cache result</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">url</span><span class="p">]</span> <span class="o">=</span> <span class="n">content</span>
            <span class="k">return</span> <span class="n">content</span>
            
        <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">RequestException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error fetching </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
    
    <span class="k">def</span> <span class="nf">parse_html</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">html</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">selector</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Parse HTML and extract text from elements.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">HAS_BS4</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">html</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>
        
        <span class="n">soup</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">html</span><span class="p">,</span> <span class="s1">&#39;html.parser&#39;</span><span class="p">)</span>
        <span class="n">elements</span> <span class="o">=</span> <span class="n">soup</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">selector</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">elem</span><span class="o">.</span><span class="n">get_text</span><span class="p">(</span><span class="n">strip</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">elements</span><span class="p">]</span>
    
    <span class="k">def</span> <span class="nf">fetch_json</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Fetch and parse JSON from URL.&quot;&quot;&quot;</span>
        <span class="n">content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fetch_url</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">content</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid JSON from </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

<span class="c1"># Example usage</span>
<span class="n">collector</span> <span class="o">=</span> <span class="n">WebDataCollector</span><span class="p">(</span><span class="n">rate_limit</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;WebDataCollector initialized&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Rate limit: </span><span class="si">{</span><span class="n">collector</span><span class="o">.</span><span class="n">rate_limit</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  User-Agent: </span><span class="si">{</span><span class="n">collector</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;User-Agent&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Simulated API data (for demonstration without actual API calls)</span>

<span class="k">def</span> <span class="nf">simulate_google_trends_data</span><span class="p">(</span><span class="n">keyword</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">n_days</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">90</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Simulate Google Trends data.&quot;&quot;&quot;</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="nb">hash</span><span class="p">(</span><span class="n">keyword</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span><span class="o">**</span><span class="mi">32</span><span class="p">)</span>
    
    <span class="n">dates</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">end</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="o">.</span><span class="n">today</span><span class="p">(),</span> <span class="n">periods</span><span class="o">=</span><span class="n">n_days</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;D&#39;</span><span class="p">)</span>
    
    <span class="c1"># Generate trend with weekly seasonality and random noise</span>
    <span class="n">trend</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">n_days</span><span class="p">)</span>
    <span class="n">seasonality</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_days</span><span class="p">)</span> <span class="o">/</span> <span class="mi">7</span><span class="p">)</span>
    <span class="n">values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">trend</span> <span class="o">+</span> <span class="n">seasonality</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
        <span class="s1">&#39;date&#39;</span><span class="p">:</span> <span class="n">dates</span><span class="p">,</span>
        <span class="s1">&#39;keyword&#39;</span><span class="p">:</span> <span class="n">keyword</span><span class="p">,</span>
        <span class="s1">&#39;interest&#39;</span><span class="p">:</span> <span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="p">})</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;date&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">simulate_reddit_data</span><span class="p">(</span><span class="n">subreddit</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">n_days</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">90</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Simulate Reddit activity data.&quot;&quot;&quot;</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="nb">hash</span><span class="p">(</span><span class="n">subreddit</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span><span class="o">**</span><span class="mi">32</span><span class="p">)</span>
    
    <span class="n">dates</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">end</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="o">.</span><span class="n">today</span><span class="p">(),</span> <span class="n">periods</span><span class="o">=</span><span class="n">n_days</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;D&#39;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
        <span class="s1">&#39;date&#39;</span><span class="p">:</span> <span class="n">dates</span><span class="p">,</span>
        <span class="s1">&#39;subreddit&#39;</span><span class="p">:</span> <span class="n">subreddit</span><span class="p">,</span>
        <span class="s1">&#39;posts&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">poisson</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="n">n_days</span><span class="p">),</span>
        <span class="s1">&#39;comments&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">poisson</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="n">n_days</span><span class="p">),</span>
        <span class="s1">&#39;avg_score&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">exponential</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="n">n_days</span><span class="p">),</span>
        <span class="s1">&#39;sentiment&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="n">n_days</span><span class="p">)</span>
    <span class="p">})</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;date&#39;</span><span class="p">)</span>

<span class="c1"># Get simulated data</span>
<span class="n">google_data</span> <span class="o">=</span> <span class="n">simulate_google_trends_data</span><span class="p">(</span><span class="s2">&quot;Tesla stock&quot;</span><span class="p">)</span>
<span class="n">reddit_data</span> <span class="o">=</span> <span class="n">simulate_reddit_data</span><span class="p">(</span><span class="s2">&quot;wallstreetbets&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Simulated Google Trends:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">google_data</span><span class="o">.</span><span class="n">head</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Simulated Reddit Data:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">reddit_data</span><span class="o">.</span><span class="n">head</span><span class="p">())</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 10.2: Multi-Source Data Aggregator (Guided)</span>

<span class="k">class</span> <span class="nc">MultiSourceAggregator</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Aggregate data from multiple alternative sources.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sources</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">combined_data</span> <span class="o">=</span> <span class="kc">None</span>
        
    <span class="k">def</span> <span class="nf">add_source</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> 
                   <span class="n">date_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add a data source.&quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        
        <span class="c1"># Ensure date index</span>
        <span class="k">if</span> <span class="n">date_col</span> <span class="ow">and</span> <span class="n">date_col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">date_col</span><span class="p">)</span>
        
        <span class="c1"># Prefix columns with source name</span>
        <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span>
        <span class="k">return</span> <span class="bp">self</span>
    
    <span class="k">def</span> <span class="nf">combine</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fill_method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;ffill&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Combine all sources into single DataFrame.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        
        <span class="c1"># TODO: Start with first source</span>
        <span class="n">combined</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="o">.</span><span class="n">______</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        
        <span class="c1"># TODO: Join remaining sources</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">df</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="o">.</span><span class="n">items</span><span class="p">())[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="n">combined</span> <span class="o">=</span> <span class="n">combined</span><span class="o">.</span><span class="n">______</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;outer&#39;</span><span class="p">)</span>
        
        <span class="c1"># Fill missing values</span>
        <span class="k">if</span> <span class="n">fill_method</span> <span class="o">==</span> <span class="s1">&#39;ffill&#39;</span><span class="p">:</span>
            <span class="n">combined</span> <span class="o">=</span> <span class="n">combined</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;ffill&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">fill_method</span> <span class="o">==</span> <span class="s1">&#39;zero&#39;</span><span class="p">:</span>
            <span class="n">combined</span> <span class="o">=</span> <span class="n">combined</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">combined_data</span> <span class="o">=</span> <span class="n">combined</span>
        <span class="k">return</span> <span class="n">combined</span>
    
    <span class="k">def</span> <span class="nf">get_correlation_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate correlation between all features.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">combined_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">combine</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">combined_data</span><span class="o">.</span><span class="n">corr</span><span class="p">()</span>

<span class="c1"># Test</span>
<span class="c1"># aggregator = MultiSourceAggregator()</span>
<span class="c1"># aggregator.add_source(&#39;google&#39;, google_data)</span>
<span class="c1"># aggregator.add_source(&#39;reddit&#39;, reddit_data)</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 10.2</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">MultiSourceAggregator</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sources</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">combined_data</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">add_source</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> 
                   <span class="n">date_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">date_col</span> <span class="ow">and</span> <span class="n">date_col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">date_col</span><span class="p">)</span>

        <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">combine</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fill_method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;ffill&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

        <span class="n">combined</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">df</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="o">.</span><span class="n">items</span><span class="p">())[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="n">combined</span> <span class="o">=</span> <span class="n">combined</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;outer&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">fill_method</span> <span class="o">==</span> <span class="s1">&#39;ffill&#39;</span><span class="p">:</span>
            <span class="n">combined</span> <span class="o">=</span> <span class="n">combined</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;ffill&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">fill_method</span> <span class="o">==</span> <span class="s1">&#39;zero&#39;</span><span class="p">:</span>
            <span class="n">combined</span> <span class="o">=</span> <span class="n">combined</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">combined_data</span> <span class="o">=</span> <span class="n">combined</span>
        <span class="k">return</span> <span class="n">combined</span>

    <span class="k">def</span> <span class="nf">get_correlation_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">combined_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">combine</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">combined_data</span><span class="o">.</span><span class="n">corr</span><span class="p">()</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h2>Section 3: Social Media Data</h2>
<p>Processing and analyzing social media data for trading signals.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Social Media Data Processing</span>

<span class="k">class</span> <span class="nc">SocialMediaProcessor</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Process social media data for trading signals.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ticker_patterns</span> <span class="o">=</span> <span class="p">{}</span>
        
    <span class="k">def</span> <span class="nf">extract_tickers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Extract stock tickers from text.&quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">re</span>
        
        <span class="c1"># Pattern: $AAPL or $aapl</span>
        <span class="n">cashtag_pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;\$([A-Za-z]{1,5})&#39;</span>
        <span class="n">tickers</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">cashtag_pattern</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tickers</span><span class="p">]</span>
    
    <span class="k">def</span> <span class="nf">calculate_engagement_score</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">likes</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">comments</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> 
                                    <span class="n">shares</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">followers</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate normalized engagement score.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">followers</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
        
        <span class="n">engagement</span> <span class="o">=</span> <span class="p">(</span><span class="n">likes</span> <span class="o">+</span> <span class="n">comments</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">shares</span> <span class="o">*</span> <span class="mi">3</span><span class="p">)</span> <span class="o">/</span> <span class="n">followers</span>
        <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">engagement</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>  <span class="c1"># Cap at 100</span>
    
    <span class="k">def</span> <span class="nf">analyze_post_timing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timestamps</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Analyze timing patterns in posts.&quot;&quot;&quot;</span>
        <span class="n">timestamps</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">timestamps</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;posts_by_hour&#39;</span><span class="p">:</span> <span class="n">timestamps</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">hour</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(),</span>
            <span class="s1">&#39;posts_by_day&#39;</span><span class="p">:</span> <span class="n">timestamps</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">dayofweek</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(),</span>
            <span class="s1">&#39;peak_hour&#39;</span><span class="p">:</span> <span class="n">timestamps</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">hour</span><span class="o">.</span><span class="n">mode</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">timestamps</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;weekend_ratio&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">timestamps</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">dayofweek</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">calculate_velocity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">counts</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">window</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">24</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate rate of change in social activity.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">counts</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">window</span><span class="p">)</span> <span class="o">/</span> <span class="n">window</span>
    
    <span class="k">def</span> <span class="nf">detect_anomalies</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Detect unusual spikes in activity.&quot;&quot;&quot;</span>
        <span class="n">mean</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">std</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
        <span class="n">z_score</span> <span class="o">=</span> <span class="p">(</span><span class="n">values</span> <span class="o">-</span> <span class="n">mean</span><span class="p">)</span> <span class="o">/</span> <span class="n">std</span>
        <span class="k">return</span> <span class="n">z_score</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">threshold</span>

<span class="c1"># Test</span>
<span class="n">processor</span> <span class="o">=</span> <span class="n">SocialMediaProcessor</span><span class="p">()</span>

<span class="n">sample_text</span> <span class="o">=</span> <span class="s2">&quot;$AAPL is looking bullish! Also watching $TSLA and $MSFT for breakouts.&quot;</span>
<span class="n">tickers</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">extract_tickers</span><span class="p">(</span><span class="n">sample_text</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Extracted tickers: </span><span class="si">{</span><span class="n">tickers</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">engagement</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">calculate_engagement_score</span><span class="p">(</span><span class="n">likes</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">comments</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">shares</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">followers</span><span class="o">=</span><span class="mi">10000</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Engagement score: </span><span class="si">{</span><span class="n">engagement</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Simulate social media posts</span>

<span class="k">def</span> <span class="nf">simulate_social_posts</span><span class="p">(</span><span class="n">ticker</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">n_posts</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Simulate social media posts about a ticker.&quot;&quot;&quot;</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="nb">hash</span><span class="p">(</span><span class="n">ticker</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span><span class="o">**</span><span class="mi">32</span><span class="p">)</span>
    
    <span class="c1"># Generate timestamps over 30 days</span>
    <span class="n">base_date</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="o">.</span><span class="n">today</span><span class="p">()</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
    <span class="n">timestamps</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span>
        <span class="n">base_date</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_timedelta</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">30</span><span class="o">*</span><span class="mi">24</span><span class="o">*</span><span class="mi">60</span><span class="p">,</span> <span class="n">n_posts</span><span class="p">),</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;m&#39;</span><span class="p">)</span>
    <span class="p">)</span>
    
    <span class="c1"># Simulate post metrics</span>
    <span class="n">posts</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
        <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">timestamps</span><span class="p">,</span>
        <span class="s1">&#39;ticker&#39;</span><span class="p">:</span> <span class="n">ticker</span><span class="p">,</span>
        <span class="s1">&#39;likes&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">exponential</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="n">n_posts</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span>
        <span class="s1">&#39;comments&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">exponential</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">n_posts</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span>
        <span class="s1">&#39;shares&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">exponential</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">n_posts</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span>
        <span class="s1">&#39;followers&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">exponential</span><span class="p">(</span><span class="mi">5000</span><span class="p">,</span> <span class="n">n_posts</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span>
        <span class="s1">&#39;sentiment&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">n_posts</span><span class="p">)</span>
    <span class="p">})</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;timestamp&#39;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">posts</span>

<span class="c1"># Generate simulated posts</span>
<span class="n">social_posts</span> <span class="o">=</span> <span class="n">simulate_social_posts</span><span class="p">(</span><span class="s2">&quot;AAPL&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Simulated </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">social_posts</span><span class="p">)</span><span class="si">}</span><span class="s2"> social media posts&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">social_posts</span><span class="o">.</span><span class="n">head</span><span class="p">())</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Aggregate social posts to daily features</span>

<span class="k">def</span> <span class="nf">aggregate_social_to_daily</span><span class="p">(</span><span class="n">posts</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Aggregate social media posts to daily features.&quot;&quot;&quot;</span>
    <span class="n">posts</span> <span class="o">=</span> <span class="n">posts</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">posts</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">posts</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span>
    
    <span class="c1"># Aggregate</span>
    <span class="n">daily</span> <span class="o">=</span> <span class="n">posts</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;date&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">({</span>
        <span class="s1">&#39;likes&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;sum&#39;</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">],</span>
        <span class="s1">&#39;comments&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;sum&#39;</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">],</span>
        <span class="s1">&#39;shares&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;sum&#39;</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">],</span>
        <span class="s1">&#39;sentiment&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="s1">&#39;std&#39;</span><span class="p">],</span>
        <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="s1">&#39;count&#39;</span>
    <span class="p">})</span>
    
    <span class="c1"># Flatten column names</span>
    <span class="n">daily</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">col</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">daily</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span><span class="p">]</span>
    <span class="n">daily</span> <span class="o">=</span> <span class="n">daily</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;timestamp_count&#39;</span><span class="p">:</span> <span class="s1">&#39;post_count&#39;</span><span class="p">})</span>
    
    <span class="c1"># Calculate engagement</span>
    <span class="n">daily</span><span class="p">[</span><span class="s1">&#39;total_engagement&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">daily</span><span class="p">[</span><span class="s1">&#39;likes_sum&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">daily</span><span class="p">[</span><span class="s1">&#39;comments_sum&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">daily</span><span class="p">[</span><span class="s1">&#39;shares_sum&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span>
    
    <span class="c1"># Rolling features</span>
    <span class="n">daily</span><span class="p">[</span><span class="s1">&#39;engagement_ma5&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">daily</span><span class="p">[</span><span class="s1">&#39;total_engagement&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">daily</span><span class="p">[</span><span class="s1">&#39;sentiment_ma5&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">daily</span><span class="p">[</span><span class="s1">&#39;sentiment_mean&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">daily</span><span class="p">[</span><span class="s1">&#39;post_velocity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">daily</span><span class="p">[</span><span class="s1">&#39;post_count&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="n">daily</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">daily</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">daily</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

<span class="c1"># Aggregate</span>
<span class="n">daily_social</span> <span class="o">=</span> <span class="n">aggregate_social_to_daily</span><span class="p">(</span><span class="n">social_posts</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Daily Social Features:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">daily_social</span><span class="o">.</span><span class="n">head</span><span class="p">())</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 10.3: Social Momentum Detector (Guided)</span>

<span class="k">class</span> <span class="nc">SocialMomentumDetector</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Detect momentum in social media activity.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">short_window</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="n">long_window</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">short_window</span> <span class="o">=</span> <span class="n">short_window</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">long_window</span> <span class="o">=</span> <span class="n">long_window</span>
        
    <span class="k">def</span> <span class="nf">calculate_momentum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">daily_data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate social momentum indicators.&quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">daily_data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        
        <span class="c1"># Volume momentum (post count)</span>
        <span class="c1"># TODO: Calculate short and long moving averages</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;volume_ma_short&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;post_count&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">______</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">short_window</span><span class="p">)</span><span class="o">.</span><span class="n">______</span><span class="p">()</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;volume_ma_long&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;post_count&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">______</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">long_window</span><span class="p">)</span><span class="o">.</span><span class="n">______</span><span class="p">()</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;volume_momentum&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;volume_ma_short&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;volume_ma_long&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
        
        <span class="c1"># Engagement momentum</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;eng_ma_short&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;total_engagement&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">short_window</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;eng_ma_long&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;total_engagement&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">long_window</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;engagement_momentum&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;eng_ma_short&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;eng_ma_long&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
        
        <span class="c1"># Sentiment momentum</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;sent_ma_short&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;sentiment_mean&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">short_window</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;sent_ma_long&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;sentiment_mean&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">long_window</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;sentiment_momentum&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;sent_ma_short&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;sent_ma_long&#39;</span><span class="p">]</span>
        
        <span class="k">return</span> <span class="n">df</span>
    
    <span class="k">def</span> <span class="nf">generate_signals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">momentum_data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
                         <span class="n">volume_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">,</span>
                         <span class="n">sentiment_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Generate trading signals from momentum.&quot;&quot;&quot;</span>
        <span class="n">signals</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">momentum_data</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        
        <span class="c1"># Bullish: high volume momentum + positive sentiment momentum</span>
        <span class="n">bullish</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="n">momentum_data</span><span class="p">[</span><span class="s1">&#39;volume_momentum&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">volume_threshold</span><span class="p">)</span> <span class="o">&amp;</span>
            <span class="p">(</span><span class="n">momentum_data</span><span class="p">[</span><span class="s1">&#39;sentiment_momentum&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">sentiment_threshold</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">signals</span><span class="p">[</span><span class="n">bullish</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        
        <span class="c1"># Bearish: high volume momentum + negative sentiment momentum</span>
        <span class="n">bearish</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="n">momentum_data</span><span class="p">[</span><span class="s1">&#39;volume_momentum&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">volume_threshold</span><span class="p">)</span> <span class="o">&amp;</span>
            <span class="p">(</span><span class="n">momentum_data</span><span class="p">[</span><span class="s1">&#39;sentiment_momentum&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">sentiment_threshold</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">signals</span><span class="p">[</span><span class="n">bearish</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        
        <span class="k">return</span> <span class="n">signals</span>

<span class="c1"># Test</span>
<span class="c1"># detector = SocialMomentumDetector()</span>
<span class="c1"># momentum_data = detector.calculate_momentum(daily_social)</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 10.3</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">SocialMomentumDetector</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">short_window</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="n">long_window</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">short_window</span> <span class="o">=</span> <span class="n">short_window</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">long_window</span> <span class="o">=</span> <span class="n">long_window</span>

    <span class="k">def</span> <span class="nf">calculate_momentum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">daily_data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">daily_data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;volume_ma_short&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;post_count&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">short_window</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;volume_ma_long&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;post_count&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">long_window</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;volume_momentum&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;volume_ma_short&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;volume_ma_long&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>

        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;eng_ma_short&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;total_engagement&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">short_window</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;eng_ma_long&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;total_engagement&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">long_window</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;engagement_momentum&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;eng_ma_short&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;eng_ma_long&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>

        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;sent_ma_short&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;sentiment_mean&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">short_window</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;sent_ma_long&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;sentiment_mean&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">long_window</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;sentiment_momentum&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;sent_ma_short&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;sent_ma_long&#39;</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">df</span>

    <span class="k">def</span> <span class="nf">generate_signals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">momentum_data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
                         <span class="n">volume_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">,</span>
                         <span class="n">sentiment_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
        <span class="n">signals</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">momentum_data</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

        <span class="n">bullish</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="n">momentum_data</span><span class="p">[</span><span class="s1">&#39;volume_momentum&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">volume_threshold</span><span class="p">)</span> <span class="o">&amp;</span>
            <span class="p">(</span><span class="n">momentum_data</span><span class="p">[</span><span class="s1">&#39;sentiment_momentum&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">sentiment_threshold</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">signals</span><span class="p">[</span><span class="n">bullish</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="n">bearish</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="n">momentum_data</span><span class="p">[</span><span class="s1">&#39;volume_momentum&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">volume_threshold</span><span class="p">)</span> <span class="o">&amp;</span>
            <span class="p">(</span><span class="n">momentum_data</span><span class="p">[</span><span class="s1">&#39;sentiment_momentum&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">sentiment_threshold</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">signals</span><span class="p">[</span><span class="n">bearish</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

        <span class="k">return</span> <span class="n">signals</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h2>Section 4: Multi-Source Prediction Model</h2>
<p>Building prediction models that combine multiple data sources.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Multi-Source Feature Engineering</span>

<span class="k">class</span> <span class="nc">MultiSourceFeatureEngine</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Create features from multiple alternative data sources.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_names</span> <span class="o">=</span> <span class="p">[]</span>
        
    <span class="k">def</span> <span class="nf">create_price_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">price_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Create features from price data.&quot;&quot;&quot;</span>
        <span class="n">features</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">price_df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;returns&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;volatility&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;returns&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
        
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">]:</span>
            <span class="n">features</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;momentum_</span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;volume_ratio&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;Volume&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;Volume&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        
        <span class="k">return</span> <span class="n">features</span>
    
    <span class="k">def</span> <span class="nf">create_social_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">social_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Create features from social media data.&quot;&quot;&quot;</span>
        <span class="n">features</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">social_df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;social_volume&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">social_df</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;post_count&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;social_sentiment&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">social_df</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sentiment_mean&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;social_engagement&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">social_df</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;total_engagement&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        
        <span class="c1"># Normalize</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">features</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">mean</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="n">std</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
            <span class="n">features</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s1">_zscore&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">features</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">-</span> <span class="n">mean</span><span class="p">)</span> <span class="o">/</span> <span class="n">std</span>
        
        <span class="k">return</span> <span class="n">features</span>
    
    <span class="k">def</span> <span class="nf">create_web_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">web_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Create features from web traffic data.&quot;&quot;&quot;</span>
        <span class="n">features</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">web_df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;website_visits&#39;</span><span class="p">,</span> <span class="s1">&#39;google_trend_score&#39;</span><span class="p">,</span> <span class="s1">&#39;app_downloads&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">web_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">features</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">web_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span>
                <span class="n">features</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s1">_change&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">web_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">features</span>
    
    <span class="k">def</span> <span class="nf">combine_all</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">price_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> 
                    <span class="n">social_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="n">web_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="n">alt_data</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Combine all feature sources.&quot;&quot;&quot;</span>
        <span class="c1"># Start with price features</span>
        <span class="n">combined</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_price_features</span><span class="p">(</span><span class="n">price_df</span><span class="p">)</span>
        
        <span class="c1"># Add social features</span>
        <span class="k">if</span> <span class="n">social_df</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">social_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_social_features</span><span class="p">(</span><span class="n">social_df</span><span class="p">)</span>
            <span class="n">combined</span> <span class="o">=</span> <span class="n">combined</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">social_features</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
        
        <span class="c1"># Add web features</span>
        <span class="k">if</span> <span class="n">web_df</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">web_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_web_features</span><span class="p">(</span><span class="n">web_df</span><span class="p">)</span>
            <span class="n">combined</span> <span class="o">=</span> <span class="n">combined</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">web_features</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
        
        <span class="c1"># Add other alt data</span>
        <span class="k">if</span> <span class="n">alt_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">source_name</span><span class="p">,</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">alt_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">source_name</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
                <span class="n">combined</span> <span class="o">=</span> <span class="n">combined</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
        
        <span class="c1"># Fill missing</span>
        <span class="n">combined</span> <span class="o">=</span> <span class="n">combined</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;ffill&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_names</span> <span class="o">=</span> <span class="n">combined</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        
        <span class="k">return</span> <span class="n">combined</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

<span class="c1"># Test</span>
<span class="n">feature_engine</span> <span class="o">=</span> <span class="n">MultiSourceFeatureEngine</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;MultiSourceFeatureEngine initialized&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Build multi-source model</span>

<span class="k">def</span> <span class="nf">build_multi_source_model</span><span class="p">(</span><span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;AAPL&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Build and evaluate model with multiple data sources.&quot;&quot;&quot;</span>
    
    <span class="c1"># Get price data</span>
    <span class="n">ticker</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">Ticker</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
    <span class="n">price_df</span> <span class="o">=</span> <span class="n">ticker</span><span class="o">.</span><span class="n">history</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="s2">&quot;1y&quot;</span><span class="p">)</span>
    <span class="n">price_df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">price_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tz_localize</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
    
    <span class="c1"># Create target</span>
    <span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    
    <span class="c1"># Generate simulated alt data</span>
    <span class="n">alt_data</span> <span class="o">=</span> <span class="n">generate_simulated_alt_data</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">price_df</span><span class="p">),</span> <span class="n">symbol</span><span class="p">)</span>
    
    <span class="c1"># Align alt data with price data</span>
    <span class="k">for</span> <span class="n">source</span> <span class="ow">in</span> <span class="n">alt_data</span><span class="p">:</span>
        <span class="n">alt_data</span><span class="p">[</span><span class="n">source</span><span class="p">]</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">price_df</span><span class="o">.</span><span class="n">index</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">alt_data</span><span class="p">[</span><span class="n">source</span><span class="p">])]</span>
    
    <span class="c1"># Create features</span>
    <span class="n">feature_engine</span> <span class="o">=</span> <span class="n">MultiSourceFeatureEngine</span><span class="p">()</span>
    
    <span class="c1"># Model 1: Price only</span>
    <span class="n">price_features</span> <span class="o">=</span> <span class="n">feature_engine</span><span class="o">.</span><span class="n">create_price_features</span><span class="p">(</span><span class="n">price_df</span><span class="p">)</span>
    
    <span class="c1"># Model 2: Price + Social</span>
    <span class="n">combined_social</span> <span class="o">=</span> <span class="n">feature_engine</span><span class="o">.</span><span class="n">combine_all</span><span class="p">(</span><span class="n">price_df</span><span class="p">,</span> <span class="n">social_df</span><span class="o">=</span><span class="n">alt_data</span><span class="p">[</span><span class="s1">&#39;social&#39;</span><span class="p">])</span>
    
    <span class="c1"># Model 3: All sources</span>
    <span class="n">combined_all</span> <span class="o">=</span> <span class="n">feature_engine</span><span class="o">.</span><span class="n">combine_all</span><span class="p">(</span>
        <span class="n">price_df</span><span class="p">,</span>
        <span class="n">social_df</span><span class="o">=</span><span class="n">alt_data</span><span class="p">[</span><span class="s1">&#39;social&#39;</span><span class="p">],</span>
        <span class="n">web_df</span><span class="o">=</span><span class="n">alt_data</span><span class="p">[</span><span class="s1">&#39;web&#39;</span><span class="p">],</span>
        <span class="n">alt_data</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;jobs&#39;</span><span class="p">:</span> <span class="n">alt_data</span><span class="p">[</span><span class="s1">&#39;jobs&#39;</span><span class="p">],</span> <span class="s1">&#39;geo&#39;</span><span class="p">:</span> <span class="n">alt_data</span><span class="p">[</span><span class="s1">&#39;geo&#39;</span><span class="p">]}</span>
    <span class="p">)</span>
    
    <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
    
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">features</span> <span class="ow">in</span> <span class="p">[(</span><span class="s1">&#39;price_only&#39;</span><span class="p">,</span> <span class="n">price_features</span><span class="p">),</span> 
                           <span class="p">(</span><span class="s1">&#39;price_social&#39;</span><span class="p">,</span> <span class="n">combined_social</span><span class="p">),</span>
                           <span class="p">(</span><span class="s1">&#39;all_sources&#39;</span><span class="p">,</span> <span class="n">combined_all</span><span class="p">)]:</span>
        <span class="c1"># Align with target</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">features</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
        <span class="n">features</span> <span class="o">=</span> <span class="n">features</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">target</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
        
        <span class="n">features</span> <span class="o">=</span> <span class="n">features</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">features</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
        
        <span class="c1"># Split</span>
        <span class="n">split_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">features</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.8</span><span class="p">)</span>
        <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span> <span class="o">=</span> <span class="n">features</span><span class="p">[:</span><span class="n">split_idx</span><span class="p">],</span> <span class="n">features</span><span class="p">[</span><span class="n">split_idx</span><span class="p">:]</span>
        <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">target</span><span class="p">[:</span><span class="n">split_idx</span><span class="p">],</span> <span class="n">target</span><span class="p">[</span><span class="n">split_idx</span><span class="p">:]</span>
        
        <span class="c1"># Scale and train</span>
        <span class="n">X_train_scaled</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
        <span class="n">X_test_scaled</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
        
        <span class="n">model</span> <span class="o">=</span> <span class="n">RandomForestClassifier</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_scaled</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
        
        <span class="n">results</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;accuracy&#39;</span><span class="p">:</span> <span class="n">accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test_scaled</span><span class="p">)),</span>
            <span class="s1">&#39;n_features&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">features</span><span class="o">.</span><span class="n">columns</span><span class="p">),</span>
            <span class="s1">&#39;feature_importance&#39;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">features</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">feature_importances_</span><span class="p">))</span>
        <span class="p">}</span>
    
    <span class="k">return</span> <span class="n">results</span>

<span class="c1"># Build models</span>
<span class="n">model_results</span> <span class="o">=</span> <span class="n">build_multi_source_model</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Multi-Source Model Results:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
<span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">model_results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Accuracy: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Features: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;n_features&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Top 3 Features:&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">feat</span><span class="p">,</span> <span class="n">imp</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;feature_importance&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="o">-</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])[:</span><span class="mi">3</span><span class="p">]:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    </span><span class="si">{</span><span class="n">feat</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">imp</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 10.4: Complete Alt Data System (Open-ended)</span>
<span class="c1">#</span>
<span class="c1"># Build an AlternativeDataSystem class that:</span>
<span class="c1"># - Collects data from multiple simulated sources</span>
<span class="c1"># - Creates features from each source</span>
<span class="c1"># - Combines all sources with price data</span>
<span class="c1"># - Trains and evaluates prediction models</span>
<span class="c1"># - Compares value-add of each data source</span>
<span class="c1"># - Generates a report on feature importance</span>
<span class="c1">#</span>
<span class="c1"># Your implementation:</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 10.4</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">AlternativeDataSystem</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Complete alternative data trading system.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;AAPL&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span> <span class="o">=</span> <span class="n">symbol</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">price_data</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alt_data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">features</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">models</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">collect_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">period</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;1y&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Collect price and alternative data.&quot;&quot;&quot;</span>
        <span class="c1"># Price data</span>
        <span class="n">ticker</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">Ticker</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">price_data</span> <span class="o">=</span> <span class="n">ticker</span><span class="o">.</span><span class="n">history</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="n">period</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">price_data</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">price_data</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tz_localize</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>

        <span class="c1"># Simulated alt data</span>
        <span class="n">n_days</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">price_data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alt_data</span> <span class="o">=</span> <span class="n">generate_simulated_alt_data</span><span class="p">(</span><span class="n">n_days</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">)</span>

        <span class="c1"># Align indices</span>
        <span class="k">for</span> <span class="n">source</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">alt_data</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">alt_data</span><span class="p">[</span><span class="n">source</span><span class="p">]</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">price_data</span><span class="o">.</span><span class="n">index</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alt_data</span><span class="p">[</span><span class="n">source</span><span class="p">])]</span>

        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">create_features</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create features from all sources.&quot;&quot;&quot;</span>
        <span class="n">engine</span> <span class="o">=</span> <span class="n">MultiSourceFeatureEngine</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">features</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">combine_all</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">price_data</span><span class="p">,</span>
            <span class="n">social_df</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">alt_data</span><span class="p">[</span><span class="s1">&#39;social&#39;</span><span class="p">],</span>
            <span class="n">web_df</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">alt_data</span><span class="p">[</span><span class="s1">&#39;web&#39;</span><span class="p">],</span>
            <span class="n">alt_data</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;jobs&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">alt_data</span><span class="p">[</span><span class="s1">&#39;jobs&#39;</span><span class="p">],</span> <span class="s1">&#39;geo&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">alt_data</span><span class="p">[</span><span class="s1">&#39;geo&#39;</span><span class="p">]}</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">train_models</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test_frac</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Train models with different feature sets.&quot;&quot;&quot;</span>
        <span class="n">target</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">price_data</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>

        <span class="c1"># Define feature sets</span>
        <span class="n">price_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span>
            <span class="n">s</span> <span class="ow">in</span> <span class="n">c</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;social&#39;</span><span class="p">,</span> <span class="s1">&#39;web&#39;</span><span class="p">,</span> <span class="s1">&#39;jobs&#39;</span><span class="p">,</span> <span class="s1">&#39;geo&#39;</span><span class="p">])]</span>
        <span class="n">social_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="s1">&#39;social&#39;</span> <span class="ow">in</span> <span class="n">c</span><span class="p">]</span>
        <span class="n">all_cols</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

        <span class="n">feature_sets</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;price_only&#39;</span><span class="p">:</span> <span class="n">price_cols</span><span class="p">,</span>
            <span class="s1">&#39;price_social&#39;</span><span class="p">:</span> <span class="n">price_cols</span> <span class="o">+</span> <span class="n">social_cols</span><span class="p">,</span>
            <span class="s1">&#39;all_sources&#39;</span><span class="p">:</span> <span class="n">all_cols</span>
        <span class="p">}</span>

        <span class="n">split_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">test_frac</span><span class="p">))</span>
        <span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">cols</span> <span class="ow">in</span> <span class="n">feature_sets</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">X</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">target</span>

            <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span> <span class="o">=</span> <span class="n">X</span><span class="p">[:</span><span class="n">split_idx</span><span class="p">],</span> <span class="n">X</span><span class="p">[</span><span class="n">split_idx</span><span class="p">:]</span>
            <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">y</span><span class="p">[:</span><span class="n">split_idx</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">split_idx</span><span class="p">:]</span>

            <span class="n">X_train_scaled</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
            <span class="n">X_test_scaled</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>

            <span class="n">model</span> <span class="o">=</span> <span class="n">RandomForestClassifier</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
            <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_scaled</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;accuracy&#39;</span><span class="p">:</span> <span class="n">accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test_scaled</span><span class="p">)),</span>
                <span class="s1">&#39;features&#39;</span><span class="p">:</span> <span class="n">cols</span><span class="p">,</span>
                <span class="s1">&#39;importance&#39;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">cols</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">feature_importances_</span><span class="p">))</span>
            <span class="p">}</span>

        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">compare_sources</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Compare value of each data source.&quot;&quot;&quot;</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">base_acc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;price_only&#39;</span><span class="p">][</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;Model&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                <span class="s1">&#39;Accuracy&#39;</span><span class="p">:</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">],</span>
                <span class="s1">&#39;Improvement&#39;</span><span class="p">:</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">base_acc</span><span class="p">,</span>
                <span class="s1">&#39;N_Features&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;features&#39;</span><span class="p">])</span>
            <span class="p">})</span>

        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_top_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get top features across all models.&quot;&quot;&quot;</span>
        <span class="n">all_importance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;all_sources&#39;</span><span class="p">][</span><span class="s1">&#39;importance&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span>
            <span class="p">{</span><span class="s1">&#39;feature&#39;</span><span class="p">:</span> <span class="n">k</span><span class="p">,</span> <span class="s1">&#39;importance&#39;</span><span class="p">:</span> <span class="n">v</span><span class="p">}</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">all_importance</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="o">-</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])[:</span><span class="n">n</span><span class="p">]</span>
        <span class="p">])</span>

    <span class="k">def</span> <span class="nf">generate_report</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Generate text report.&quot;&quot;&quot;</span>
        <span class="n">report</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;Alternative Data System Report</span>
<span class="s2">================================</span>
<span class="s2">Symbol: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="si">}</span><span class="s2"></span>
<span class="s2">Data Points: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">)</span><span class="si">}</span><span class="s2"></span>
<span class="s2">Total Features: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="si">}</span><span class="s2"></span>

<span class="s2">Model Comparison:</span>
<span class="s2">&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">report</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;features&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2"> features)</span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="n">report</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Top Features:</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_top_features</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="n">report</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;feature&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;importance&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="k">return</span> <span class="n">report</span>
</code></pre></div>


</details></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 10.5: Data Source Evaluator (Open-ended)</span>
<span class="c1">#</span>
<span class="c1"># Build a DataSourceEvaluator class that:</span>
<span class="c1"># - Tests predictive value of individual data sources</span>
<span class="c1"># - Uses ablation studies (removing one source at a time)</span>
<span class="c1"># - Calculates information ratio for each source</span>
<span class="c1"># - Ranks sources by value-add</span>
<span class="c1"># - Visualizes source contributions</span>
<span class="c1">#</span>
<span class="c1"># Your implementation:</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 10.5</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">DataSourceEvaluator</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Evaluate predictive value of individual data sources.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">target</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">features</span> <span class="o">=</span> <span class="n">features</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target</span> <span class="o">=</span> <span class="n">target</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source_results</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">identify_sources</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
        <span class="sd">&quot;&quot;&quot;Identify which features belong to which source.&quot;&quot;&quot;</span>
        <span class="n">sources</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;social&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;web&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;jobs&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;geo&#39;</span><span class="p">:</span> <span class="p">[]}</span>

        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">assigned</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">source</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;social&#39;</span><span class="p">,</span> <span class="s1">&#39;web&#39;</span><span class="p">,</span> <span class="s1">&#39;jobs&#39;</span><span class="p">,</span> <span class="s1">&#39;geo&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">source</span> <span class="ow">in</span> <span class="n">col</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                    <span class="n">sources</span><span class="p">[</span><span class="n">source</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
                    <span class="n">assigned</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">assigned</span><span class="p">:</span>
                <span class="n">sources</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">sources</span>

    <span class="k">def</span> <span class="nf">evaluate_single_source</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
                                <span class="n">source_cols</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Evaluate a single data source.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">source_cols</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;accuracy&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;features&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>

        <span class="n">X</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="n">source_cols</span><span class="p">]</span>
        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span>

        <span class="n">split_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.8</span><span class="p">)</span>
        <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span> <span class="o">=</span> <span class="n">X</span><span class="p">[:</span><span class="n">split_idx</span><span class="p">],</span> <span class="n">X</span><span class="p">[</span><span class="n">split_idx</span><span class="p">:]</span>
        <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">y</span><span class="p">[:</span><span class="n">split_idx</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">split_idx</span><span class="p">:]</span>

        <span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
        <span class="n">X_train_scaled</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
        <span class="n">X_test_scaled</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>

        <span class="n">model</span> <span class="o">=</span> <span class="n">RandomForestClassifier</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_scaled</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;accuracy&#39;</span><span class="p">:</span> <span class="n">accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test_scaled</span><span class="p">)),</span>
            <span class="s1">&#39;features&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">source_cols</span><span class="p">)</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">ablation_study</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Remove each source and measure impact.&quot;&quot;&quot;</span>
        <span class="n">sources</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">identify_sources</span><span class="p">()</span>
        <span class="n">all_cols</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

        <span class="c1"># Full model baseline</span>
        <span class="n">full_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluate_single_source</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">all_cols</span><span class="p">)</span>

        <span class="n">results</span> <span class="o">=</span> <span class="p">[{</span><span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="s1">&#39;accuracy&#39;</span><span class="p">:</span> <span class="n">full_result</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">],</span> 
                   <span class="s1">&#39;drop&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;features&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_cols</span><span class="p">)}]</span>

        <span class="k">for</span> <span class="n">source</span><span class="p">,</span> <span class="n">cols</span> <span class="ow">in</span> <span class="n">sources</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">cols</span><span class="p">:</span>
                <span class="n">remaining_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">all_cols</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">remaining_cols</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluate_single_source</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;without_</span><span class="si">{</span><span class="n">source</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">remaining_cols</span><span class="p">)</span>
                    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                        <span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;without_</span><span class="si">{</span><span class="n">source</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;accuracy&#39;</span><span class="p">:</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">],</span>
                        <span class="s1">&#39;drop&#39;</span><span class="p">:</span> <span class="n">full_result</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">],</span>
                        <span class="s1">&#39;features&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">remaining_cols</span><span class="p">)</span>
                    <span class="p">})</span>

        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;drop&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">rank_sources</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Rank data sources by value.&quot;&quot;&quot;</span>
        <span class="n">sources</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">identify_sources</span><span class="p">()</span>

        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">source</span><span class="p">,</span> <span class="n">cols</span> <span class="ow">in</span> <span class="n">sources</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluate_single_source</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">cols</span><span class="p">)</span>
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="n">source</span><span class="p">,</span>
                <span class="s1">&#39;accuracy&#39;</span><span class="p">:</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">],</span>
                <span class="s1">&#39;features&#39;</span><span class="p">:</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;features&#39;</span><span class="p">],</span>
                <span class="s1">&#39;acc_per_feature&#39;</span><span class="p">:</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;features&#39;</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>
            <span class="p">})</span>

        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;accuracy&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">plot_contributions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Visualize source contributions.&quot;&quot;&quot;</span>
        <span class="n">ranking</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rank_sources</span><span class="p">()</span>
        <span class="n">ablation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ablation_study</span><span class="p">()</span>

        <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">ranking</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">],</span> <span class="n">ranking</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">])</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Accuracy by Single Source&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Accuracy&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>

        <span class="n">ablation_plot</span> <span class="o">=</span> <span class="n">ablation</span><span class="p">[</span><span class="n">ablation</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;all&#39;</span><span class="p">]</span>
        <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;red&#39;</span> <span class="k">if</span> <span class="n">d</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;green&#39;</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">ablation_plot</span><span class="p">[</span><span class="s1">&#39;drop&#39;</span><span class="p">]]</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">ablation_plot</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">],</span> <span class="n">ablation_plot</span><span class="p">[</span><span class="s1">&#39;drop&#39;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Accuracy Drop When Removing Source&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Accuracy Drop&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>


</details></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 10.6: Production Alt Data Pipeline (Open-ended)</span>
<span class="c1">#</span>
<span class="c1"># Build a ProductionAltDataPipeline class that:</span>
<span class="c1"># - Simulates real-time data collection</span>
<span class="c1"># - Handles missing data and outliers</span>
<span class="c1"># - Updates features incrementally</span>
<span class="c1"># - Generates trading signals with confidence</span>
<span class="c1"># - Tracks data quality metrics</span>
<span class="c1"># - Provides alerting for data anomalies</span>
<span class="c1">#</span>
<span class="c1"># Your implementation:</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 10.6</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">ProductionAltDataPipeline</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Production-ready alternative data pipeline.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_buffer</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">features</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">quality_metrics</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alerts</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">ingest_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">:</span> <span class="n">datetime</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Ingest new data point.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">source</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_buffer</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data_buffer</span><span class="p">[</span><span class="n">source</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">timestamp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_buffer</span><span class="p">[</span><span class="n">source</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Check for anomalies</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_anomalies</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_check_anomalies</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check for data anomalies.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_buffer</span><span class="p">[</span><span class="n">source</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># Get recent values</span>
        <span class="n">recent</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_buffer</span><span class="p">[</span><span class="n">source</span><span class="p">][</span><span class="o">-</span><span class="mi">20</span><span class="p">:])</span>

        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">recent</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">number</span><span class="p">])</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">mean</span> <span class="o">=</span> <span class="n">recent</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="n">std</span> <span class="o">=</span> <span class="n">recent</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">std</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">z_score</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">mean</span><span class="p">)</span> <span class="o">-</span> <span class="n">mean</span><span class="p">)</span> <span class="o">/</span> <span class="n">std</span>
                <span class="k">if</span> <span class="n">z_score</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">alerts</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                        <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">],</span>
                        <span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="n">source</span><span class="p">,</span>
                        <span class="s1">&#39;field&#39;</span><span class="p">:</span> <span class="n">col</span><span class="p">,</span>
                        <span class="s1">&#39;z_score&#39;</span><span class="p">:</span> <span class="n">z_score</span><span class="p">,</span>
                        <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Anomaly detected in </span><span class="si">{</span><span class="n">source</span><span class="si">}</span><span class="s1">.</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s1">&#39;</span>
                    <span class="p">})</span>

    <span class="k">def</span> <span class="nf">update_features</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update features from buffer.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_buffer</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># Convert buffers to DataFrames</span>
        <span class="n">dfs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">source</span><span class="p">,</span> <span class="n">buffer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_buffer</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;timestamp&#39;</span><span class="p">)</span>
            <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">source</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
            <span class="n">dfs</span><span class="p">[</span><span class="n">source</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span>

        <span class="c1"># Combine</span>
        <span class="k">if</span> <span class="n">dfs</span><span class="p">:</span>
            <span class="n">combined</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">dfs</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">df</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">dfs</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">1</span><span class="p">:]:</span>
                <span class="n">combined</span> <span class="o">=</span> <span class="n">combined</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;outer&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">features</span> <span class="o">=</span> <span class="n">combined</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;ffill&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">handle_missing_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;ffill&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Handle missing data.&quot;&quot;&quot;</span>
        <span class="n">before</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;ffill&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;ffill&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;interpolate&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">interpolate</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;zero&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">after</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">quality_metrics</span><span class="p">[</span><span class="s1">&#39;missing_filled&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">before</span> <span class="o">-</span> <span class="n">after</span>

    <span class="k">def</span> <span class="nf">generate_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Generate trading signal from latest features.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;confidence&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>

        <span class="n">latest</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">latest_scaled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">latest</span><span class="p">)</span>

        <span class="n">prediction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">latest_scaled</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">proba</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">latest_scaled</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">confidence</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">proba</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="n">prediction</span><span class="p">,</span>
            <span class="s1">&#39;signal_name&#39;</span><span class="p">:</span> <span class="s1">&#39;BUY&#39;</span> <span class="k">if</span> <span class="n">prediction</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="s1">&#39;SELL&#39;</span><span class="p">,</span>
            <span class="s1">&#39;confidence&#39;</span><span class="p">:</span> <span class="n">confidence</span><span class="p">,</span>
            <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">get_quality_report</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Generate data quality report.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;sources&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_buffer</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
            <span class="s1">&#39;total_records&#39;</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_buffer</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span>
            <span class="s1">&#39;feature_count&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">columns</span><span class="p">),</span>
            <span class="s1">&#39;missing_values&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(),</span>
            <span class="s1">&#39;alerts&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alerts</span><span class="p">),</span>
            <span class="s1">&#39;recent_alerts&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">alerts</span><span class="p">[</span><span class="o">-</span><span class="mi">5</span><span class="p">:]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">alerts</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">train_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Train prediction model.&quot;&quot;&quot;</span>
        <span class="n">aligned</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">target</span><span class="o">.</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">aligned</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>

        <span class="n">X_scaled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">aligned</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">RandomForestClassifier</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_scaled</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span>
</code></pre></div>


</details></div>
<div class="md-cell module-project"><hr />
<h2>Module Project: Complete Alternative Data Trading System</h2>
<p>Build a comprehensive system combining multiple alternative data sources.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">AltDataTradingSystem</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Complete alternative data trading system.</span>
<span class="sd">    </span>
<span class="sd">    Combines social, web, job, and geospatial data</span>
<span class="sd">    with price data for trading signals.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;AAPL&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span> <span class="o">=</span> <span class="n">symbol</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">price_data</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alt_data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">features</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">RandomForestClassifier</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
        
    <span class="k">def</span> <span class="nf">load_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">period</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;1y&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Load price and alternative data.&quot;&quot;&quot;</span>
        <span class="c1"># Price data</span>
        <span class="n">ticker</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">Ticker</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">price_data</span> <span class="o">=</span> <span class="n">ticker</span><span class="o">.</span><span class="n">history</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="n">period</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">price_data</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">price_data</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tz_localize</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        
        <span class="c1"># Target</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">price_data</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">price_data</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        
        <span class="c1"># Simulated alt data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alt_data</span> <span class="o">=</span> <span class="n">generate_simulated_alt_data</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">price_data</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">)</span>
        
        <span class="c1"># Align indices</span>
        <span class="k">for</span> <span class="n">source</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">alt_data</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">alt_data</span><span class="p">[</span><span class="n">source</span><span class="p">]</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">price_data</span><span class="o">.</span><span class="n">index</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alt_data</span><span class="p">[</span><span class="n">source</span><span class="p">])]</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loaded </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">price_data</span><span class="p">)</span><span class="si">}</span><span class="s2"> days of price data&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Alt data sources: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alt_data</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="bp">self</span>
    
    <span class="k">def</span> <span class="nf">create_features</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create comprehensive feature set.&quot;&quot;&quot;</span>
        <span class="n">features</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">price_data</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        
        <span class="c1"># Price features</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;returns&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">price_data</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;volatility&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;returns&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">]:</span>
            <span class="n">features</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;momentum_</span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">price_data</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;volume_ratio&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">price_data</span><span class="p">[</span><span class="s1">&#39;Volume&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">price_data</span><span class="p">[</span><span class="s1">&#39;Volume&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        
        <span class="c1"># Social features</span>
        <span class="n">social</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alt_data</span><span class="p">[</span><span class="s1">&#39;social&#39;</span><span class="p">]</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;social_sentiment&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">social</span><span class="p">[</span><span class="s1">&#39;twitter_sentiment&#39;</span><span class="p">]</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;social_volume&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">social</span><span class="p">[</span><span class="s1">&#39;twitter_mentions&#39;</span><span class="p">]</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;bullish_ratio&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">social</span><span class="p">[</span><span class="s1">&#39;stocktwits_bullish_pct&#39;</span><span class="p">]</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;social_sentiment_ma5&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;social_sentiment&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;social_momentum&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;social_sentiment&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;social_sentiment_ma5&#39;</span><span class="p">]</span>
        
        <span class="c1"># Web features</span>
        <span class="n">web</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alt_data</span><span class="p">[</span><span class="s1">&#39;web&#39;</span><span class="p">]</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;web_traffic&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">web</span><span class="p">[</span><span class="s1">&#39;website_visits&#39;</span><span class="p">]</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;traffic_change&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">web</span><span class="p">[</span><span class="s1">&#39;website_visits&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;google_trends&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">web</span><span class="p">[</span><span class="s1">&#39;google_trend_score&#39;</span><span class="p">]</span>
        
        <span class="c1"># Job features</span>
        <span class="n">jobs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alt_data</span><span class="p">[</span><span class="s1">&#39;jobs&#39;</span><span class="p">]</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;job_growth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">jobs</span><span class="p">[</span><span class="s1">&#39;job_postings&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;eng_ratio&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">jobs</span><span class="p">[</span><span class="s1">&#39;engineering_jobs&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="n">jobs</span><span class="p">[</span><span class="s1">&#39;sales_jobs&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        
        <span class="c1"># Geo features</span>
        <span class="n">geo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alt_data</span><span class="p">[</span><span class="s1">&#39;geo&#39;</span><span class="p">]</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;foot_traffic&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">geo</span><span class="p">[</span><span class="s1">&#39;store_foot_traffic&#39;</span><span class="p">]</span>
        <span class="n">features</span><span class="p">[</span><span class="s1">&#39;parking_fill&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">geo</span><span class="p">[</span><span class="s1">&#39;parking_lot_fill&#39;</span><span class="p">]</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">features</span> <span class="o">=</span> <span class="n">features</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Created </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">feature_names</span><span class="p">)</span><span class="si">}</span><span class="s2"> features&quot;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="bp">self</span>
    
    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test_frac</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Train the model.&quot;&quot;&quot;</span>
        <span class="n">target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">price_data</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
        
        <span class="n">split_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">test_frac</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">X_train</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[:</span><span class="n">split_idx</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">X_test</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="n">split_idx</span><span class="p">:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y_train</span> <span class="o">=</span> <span class="n">target</span><span class="p">[:</span><span class="n">split_idx</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y_test</span> <span class="o">=</span> <span class="n">target</span><span class="p">[</span><span class="n">split_idx</span><span class="p">:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_returns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">price_data</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()[</span><span class="n">split_idx</span><span class="p">:]</span>
        
        <span class="n">X_train_scaled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X_train</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_scaled</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_train</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="bp">self</span>
    
    <span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Evaluate model performance.&quot;&quot;&quot;</span>
        <span class="n">X_test_scaled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X_test</span><span class="p">)</span>
        <span class="n">y_pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test_scaled</span><span class="p">)</span>
        
        <span class="c1"># Classification metrics</span>
        <span class="n">accuracy</span> <span class="o">=</span> <span class="n">accuracy_score</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
        
        <span class="c1"># Financial metrics</span>
        <span class="n">pred_series</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">y_pred</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">y_test</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="n">test_returns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_returns</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pred_series</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
        <span class="n">strategy_returns</span> <span class="o">=</span> <span class="n">pred_series</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">test_returns</span>
        <span class="n">strategy_returns</span> <span class="o">=</span> <span class="n">strategy_returns</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
        
        <span class="n">total_return</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">strategy_returns</span><span class="p">)</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">bh_return</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">test_returns</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">strategy_returns</span><span class="o">.</span><span class="n">index</span><span class="p">])</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">sharpe</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span> <span class="o">*</span> <span class="n">strategy_returns</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">/</span> <span class="n">strategy_returns</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;accuracy&#39;</span><span class="p">:</span> <span class="n">accuracy</span><span class="p">,</span>
            <span class="s1">&#39;total_return&#39;</span><span class="p">:</span> <span class="n">total_return</span><span class="p">,</span>
            <span class="s1">&#39;buy_hold_return&#39;</span><span class="p">:</span> <span class="n">bh_return</span><span class="p">,</span>
            <span class="s1">&#39;outperformance&#39;</span><span class="p">:</span> <span class="n">total_return</span> <span class="o">-</span> <span class="n">bh_return</span><span class="p">,</span>
            <span class="s1">&#39;sharpe_ratio&#39;</span><span class="p">:</span> <span class="n">sharpe</span><span class="p">,</span>
            <span class="s1">&#39;feature_importance&#39;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">feature_names</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">feature_importances_</span><span class="p">))</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">plot_results</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Visualize results.&quot;&quot;&quot;</span>
        <span class="n">X_test_scaled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X_test</span><span class="p">)</span>
        <span class="n">y_pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test_scaled</span><span class="p">)</span>
        
        <span class="n">pred_series</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">y_pred</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">y_test</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="n">test_returns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_returns</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pred_series</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
        <span class="n">strategy_returns</span> <span class="o">=</span> <span class="n">pred_series</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">test_returns</span>
        
        <span class="n">cum_strategy</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">strategy_returns</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span>
        <span class="n">cum_bh</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">test_returns</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span>
        
        <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
        
        <span class="c1"># Cumulative returns</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">cum_strategy</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">cum_strategy</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Strategy&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">cum_bh</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">cum_bh</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Buy &amp; Hold&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Cumulative Return&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Alt Data Strategy Performance&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
        
        <span class="c1"># Feature importance</span>
        <span class="n">importance</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">feature_importances_</span><span class="p">,</span>
            <span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">feature_names</span>
        <span class="p">)</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
        
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="n">importance</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">importance</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;steelblue&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Importance&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Top 10 Feature Importance&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
        
        <span class="c1"># Social sentiment vs returns</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="s1">&#39;social_sentiment&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">test_returns</span><span class="o">.</span><span class="n">index</span><span class="p">],</span>
                          <span class="n">test_returns</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Social Sentiment&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Next Day Return&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Sentiment vs Returns&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
        
        <span class="c1"># Data source contribution</span>
        <span class="n">sources</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;social&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;web&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;job&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;geo&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">feat</span><span class="p">,</span> <span class="n">imp</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">feature_names</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">feature_importances_</span><span class="p">):</span>
            <span class="k">if</span> <span class="s1">&#39;social&#39;</span> <span class="ow">in</span> <span class="n">feat</span> <span class="ow">or</span> <span class="s1">&#39;bullish&#39;</span> <span class="ow">in</span> <span class="n">feat</span><span class="p">:</span>
                <span class="n">sources</span><span class="p">[</span><span class="s1">&#39;social&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">imp</span>
            <span class="k">elif</span> <span class="s1">&#39;web&#39;</span> <span class="ow">in</span> <span class="n">feat</span> <span class="ow">or</span> <span class="s1">&#39;traffic&#39;</span> <span class="ow">in</span> <span class="n">feat</span> <span class="ow">or</span> <span class="s1">&#39;google&#39;</span> <span class="ow">in</span> <span class="n">feat</span><span class="p">:</span>
                <span class="n">sources</span><span class="p">[</span><span class="s1">&#39;web&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">imp</span>
            <span class="k">elif</span> <span class="s1">&#39;job&#39;</span> <span class="ow">in</span> <span class="n">feat</span> <span class="ow">or</span> <span class="s1">&#39;eng&#39;</span> <span class="ow">in</span> <span class="n">feat</span><span class="p">:</span>
                <span class="n">sources</span><span class="p">[</span><span class="s1">&#39;job&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">imp</span>
            <span class="k">elif</span> <span class="s1">&#39;foot&#39;</span> <span class="ow">in</span> <span class="n">feat</span> <span class="ow">or</span> <span class="s1">&#39;parking&#39;</span> <span class="ow">in</span> <span class="n">feat</span><span class="p">:</span>
                <span class="n">sources</span><span class="p">[</span><span class="s1">&#39;geo&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">imp</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sources</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">imp</span>
        
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">pie</span><span class="p">(</span><span class="n">sources</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="n">labels</span><span class="o">=</span><span class="n">sources</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">autopct</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%1.1f%%</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Feature Importance by Source&#39;</span><span class="p">)</span>
        
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Run the complete system</span>

<span class="n">system</span> <span class="o">=</span> <span class="n">AltDataTradingSystem</span><span class="p">(</span><span class="s2">&quot;AAPL&quot;</span><span class="p">)</span>
<span class="n">system</span><span class="o">.</span><span class="n">load_data</span><span class="p">()</span>
<span class="n">system</span><span class="o">.</span><span class="n">create_features</span><span class="p">()</span>
<span class="n">system</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>

<span class="c1"># Evaluate</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">system</span><span class="o">.</span><span class="n">evaluate</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ALT DATA TRADING SYSTEM RESULTS&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Accuracy: </span><span class="si">{</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Strategy Return: </span><span class="si">{</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;total_return&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Buy &amp; Hold Return: </span><span class="si">{</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;buy_hold_return&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Outperformance: </span><span class="si">{</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;outperformance&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sharpe Ratio: </span><span class="si">{</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;sharpe_ratio&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Top 5 Features:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">feat</span><span class="p">,</span> <span class="n">imp</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;feature_importance&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="o">-</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])[:</span><span class="mi">5</span><span class="p">]:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">feat</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">imp</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Visualize</span>

<span class="n">system</span><span class="o">.</span><span class="n">plot_results</span><span class="p">()</span>
</code></pre></div>
<div class="md-cell key-takeaways"><hr />
<h2>Key Takeaways</h2>
<ol>
<li>
<p><strong>Alternative data</strong> provides unique signals beyond price and volume</p>
</li>
<li>
<p><strong>Data collection</strong> requires attention to rate limits, caching, and error handling</p>
</li>
<li>
<p><strong>Social media</strong> data can capture market sentiment in real-time</p>
</li>
<li>
<p><strong>Multi-source models</strong> often outperform single-source models</p>
</li>
<li>
<p><strong>Data quality</strong> monitoring is essential for production systems</p>
</li>
<li>
<p><strong>Ablation studies</strong> help identify which sources provide the most value</p>
</li>
<li>
<p><strong>Alpha decay</strong> means alternative data edges diminish as more traders use them</p>
</li>
</ol>
<hr />
<p><strong>Next: Module 11 - Deep Learning for Finance</strong> (Neural networks, LSTM, transformers)</p></div>
        <div class="nav-buttons">
            <button class="nav-btn prev-btn disabled" type="button">
                <span class="nav-btn-label">‚Üê Previous</span>
                <span class="nav-btn-name"></span>
            </button>
            <button class="nav-btn next-btn disabled" type="button">
                <span class="nav-btn-label">Next ‚Üí</span>
                <span class="nav-btn-name"></span>
            </button>
        </div>
        </div>
<div class="module-section" data-idx="11"><div class="md-cell module-header"><h1>Module 11: Deep Learning for Finance</h1>
<h2>Overview</h2>
<p>Deep learning has revolutionized many fields, and finance is no exception. This module covers neural network architectures particularly suited for financial applications, from basic feedforward networks to advanced sequence models like LSTMs and Transformers.</p>
<h2>Learning Objectives</h2>
<p>By the end of this module, you will be able to:
- Build and train neural networks for financial prediction
- Implement LSTM networks for time series forecasting
- Apply attention mechanisms and Transformers to market data
- Design appropriate architectures for different financial tasks</p>
<h2>Prerequisites</h2>
<ul>
<li>Module 6: Other Classification Models (Neural Network basics)</li>
<li>Module 8: Regression Models</li>
<li>Understanding of backpropagation and gradient descent</li>
</ul>
<h2>Estimated Time: 4 hours</h2></div>
<div class="md-cell"><hr />
<h2>Section 1: Neural Network Fundamentals for Finance</h2>
<p>Neural networks can capture complex non-linear relationships in financial data that traditional models miss.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>

<span class="c1"># Deep learning imports</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">from</span> <span class="nn">tensorflow</span> <span class="kn">import</span> <span class="n">keras</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras</span> <span class="kn">import</span> <span class="n">layers</span><span class="p">,</span> <span class="n">Model</span><span class="p">,</span> <span class="n">Sequential</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.callbacks</span> <span class="kn">import</span> <span class="n">EarlyStopping</span><span class="p">,</span> <span class="n">ReduceLROnPlateau</span><span class="p">,</span> <span class="n">ModelCheckpoint</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.optimizers</span> <span class="kn">import</span> <span class="n">Adam</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">StandardScaler</span><span class="p">,</span> <span class="n">MinMaxScaler</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">accuracy_score</span><span class="p">,</span> <span class="n">mean_squared_error</span><span class="p">,</span> <span class="n">mean_absolute_error</span>

<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">set_seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;TensorFlow version: </span><span class="si">{</span><span class="n">tf</span><span class="o">.</span><span class="n">__version__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Deep learning libraries loaded successfully&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Generate synthetic financial data</span>
<span class="k">def</span> <span class="nf">generate_financial_data</span><span class="p">(</span><span class="n">n_samples</span><span class="o">=</span><span class="mi">2000</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Generate synthetic stock data with realistic patterns.&quot;&quot;&quot;</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
    
    <span class="n">dates</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="s1">&#39;2018-01-01&#39;</span><span class="p">,</span> <span class="n">periods</span><span class="o">=</span><span class="n">n_samples</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;D&#39;</span><span class="p">)</span>
    
    <span class="c1"># Generate price series with trend and volatility clustering</span>
    <span class="n">returns</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mf">0.0003</span><span class="p">,</span> <span class="mf">0.015</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">)</span>
    
    <span class="c1"># Add volatility clustering (GARCH-like effect)</span>
    <span class="n">volatility</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n_samples</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.015</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">):</span>
        <span class="n">volatility</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.9</span> <span class="o">*</span> <span class="n">volatility</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="nb">abs</span><span class="p">(</span><span class="n">returns</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="mi">2</span>
        <span class="n">returns</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mf">0.0003</span><span class="p">,</span> <span class="n">volatility</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    
    <span class="c1"># Generate prices</span>
    <span class="n">prices</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">returns</span><span class="p">))</span>
    
    <span class="c1"># Create OHLCV data</span>
    <span class="n">high</span> <span class="o">=</span> <span class="n">prices</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">)))</span>
    <span class="n">low</span> <span class="o">=</span> <span class="n">prices</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">)))</span>
    <span class="n">volume</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">lognormal</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">)</span>
    
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
        <span class="s1">&#39;date&#39;</span><span class="p">:</span> <span class="n">dates</span><span class="p">,</span>
        <span class="s1">&#39;open&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">prices</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="s1">&#39;high&#39;</span><span class="p">:</span> <span class="n">high</span><span class="p">,</span>
        <span class="s1">&#39;low&#39;</span><span class="p">:</span> <span class="n">low</span><span class="p">,</span>
        <span class="s1">&#39;close&#39;</span><span class="p">:</span> <span class="n">prices</span><span class="p">,</span>
        <span class="s1">&#39;volume&#39;</span><span class="p">:</span> <span class="n">volume</span>
    <span class="p">})</span>
    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;open&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;close&#39;</span><span class="p">]</span>
    <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">df</span>

<span class="c1"># Generate data</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">generate_financial_data</span><span class="p">(</span><span class="mi">2000</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dataset shape: </span><span class="si">{</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">tail</span><span class="p">()</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Feature engineering for neural networks</span>
<span class="k">def</span> <span class="nf">create_nn_features</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">lookback_periods</span><span class="o">=</span><span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">50</span><span class="p">]):</span>
    <span class="sd">&quot;&quot;&quot;Create features suitable for neural network input.&quot;&quot;&quot;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    
    <span class="c1"># Returns at different horizons</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;return_1d&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;return_5d&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;return_20d&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
    
    <span class="c1"># Volatility features</span>
    <span class="k">for</span> <span class="n">period</span> <span class="ow">in</span> <span class="n">lookback_periods</span><span class="p">:</span>
        <span class="n">data</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;volatility_</span><span class="si">{</span><span class="n">period</span><span class="si">}</span><span class="s1">d&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;return_1d&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">period</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
        <span class="n">data</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;sma_</span><span class="si">{</span><span class="n">period</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">period</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">data</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;price_to_sma_</span><span class="si">{</span><span class="n">period</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">data</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;sma_</span><span class="si">{</span><span class="n">period</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span>
    
    <span class="c1"># RSI</span>
    <span class="n">delta</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span>
    <span class="n">gain</span> <span class="o">=</span> <span class="p">(</span><span class="n">delta</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">delta</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">14</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">delta</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">delta</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">14</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">rs</span> <span class="o">=</span> <span class="n">gain</span> <span class="o">/</span> <span class="n">loss</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;rsi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">-</span> <span class="p">(</span><span class="mi">100</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">rs</span><span class="p">))</span>
    
    <span class="c1"># MACD</span>
    <span class="n">exp12</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">ewm</span><span class="p">(</span><span class="n">span</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">exp26</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">ewm</span><span class="p">(</span><span class="n">span</span><span class="o">=</span><span class="mi">26</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;macd&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">exp12</span> <span class="o">-</span> <span class="n">exp26</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;macd_signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;macd&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">ewm</span><span class="p">(</span><span class="n">span</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;macd_hist&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;macd&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;macd_signal&#39;</span><span class="p">]</span>
    
    <span class="c1"># Volume features</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;volume_sma_20&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;volume&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;volume_ratio&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;volume&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;volume_sma_20&#39;</span><span class="p">]</span>
    
    <span class="c1"># Price range</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;daily_range&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;high&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;low&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;avg_range_20&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;daily_range&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    
    <span class="c1"># Target: Next day return direction</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;target_return&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">data</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

<span class="c1"># Create features</span>
<span class="n">df_features</span> <span class="o">=</span> <span class="n">create_nn_features</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Features created: </span><span class="si">{</span><span class="n">df_features</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"> columns&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Samples after processing: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df_features</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Building a Feedforward Neural Network for classification</span>
<span class="k">class</span> <span class="nc">FinancialNeuralNetwork</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Neural network for financial prediction tasks.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_dim</span><span class="p">,</span> <span class="n">hidden_layers</span><span class="o">=</span><span class="p">[</span><span class="mi">64</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">16</span><span class="p">],</span> 
                 <span class="n">dropout_rate</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.001</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_dim</span> <span class="o">=</span> <span class="n">input_dim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hidden_layers</span> <span class="o">=</span> <span class="n">hidden_layers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dropout_rate</span> <span class="o">=</span> <span class="n">dropout_rate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">learning_rate</span> <span class="o">=</span> <span class="n">learning_rate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">history</span> <span class="o">=</span> <span class="kc">None</span>
        
    <span class="k">def</span> <span class="nf">build_classifier</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Build classification neural network.&quot;&quot;&quot;</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Sequential</span><span class="p">()</span>
        
        <span class="c1"># Input layer</span>
        <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hidden_layers</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> 
                               <span class="n">input_dim</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">input_dim</span><span class="p">,</span>
                               <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">,</span>
                               <span class="n">kernel_regularizer</span><span class="o">=</span><span class="n">keras</span><span class="o">.</span><span class="n">regularizers</span><span class="o">.</span><span class="n">l2</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)))</span>
        <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">BatchNormalization</span><span class="p">())</span>
        <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dropout_rate</span><span class="p">))</span>
        
        <span class="c1"># Hidden layers</span>
        <span class="k">for</span> <span class="n">units</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">hidden_layers</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">units</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">,</span>
                                   <span class="n">kernel_regularizer</span><span class="o">=</span><span class="n">keras</span><span class="o">.</span><span class="n">regularizers</span><span class="o">.</span><span class="n">l2</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)))</span>
            <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">BatchNormalization</span><span class="p">())</span>
            <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dropout_rate</span><span class="p">))</span>
        
        <span class="c1"># Output layer</span>
        <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;sigmoid&#39;</span><span class="p">))</span>
        
        <span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
            <span class="n">optimizer</span><span class="o">=</span><span class="n">Adam</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">learning_rate</span><span class="p">),</span>
            <span class="n">loss</span><span class="o">=</span><span class="s1">&#39;binary_crossentropy&#39;</span><span class="p">,</span>
            <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span>
        <span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="k">return</span> <span class="n">model</span>
    
    <span class="k">def</span> <span class="nf">build_regressor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Build regression neural network.&quot;&quot;&quot;</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Sequential</span><span class="p">()</span>
        
        <span class="c1"># Input layer</span>
        <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hidden_layers</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> 
                               <span class="n">input_dim</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">input_dim</span><span class="p">,</span>
                               <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">,</span>
                               <span class="n">kernel_regularizer</span><span class="o">=</span><span class="n">keras</span><span class="o">.</span><span class="n">regularizers</span><span class="o">.</span><span class="n">l2</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)))</span>
        <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">BatchNormalization</span><span class="p">())</span>
        <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dropout_rate</span><span class="p">))</span>
        
        <span class="c1"># Hidden layers</span>
        <span class="k">for</span> <span class="n">units</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">hidden_layers</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">units</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">,</span>
                                   <span class="n">kernel_regularizer</span><span class="o">=</span><span class="n">keras</span><span class="o">.</span><span class="n">regularizers</span><span class="o">.</span><span class="n">l2</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)))</span>
            <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">BatchNormalization</span><span class="p">())</span>
            <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dropout_rate</span><span class="p">))</span>
        
        <span class="c1"># Output layer (linear for regression)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">))</span>
        
        <span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
            <span class="n">optimizer</span><span class="o">=</span><span class="n">Adam</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">learning_rate</span><span class="p">),</span>
            <span class="n">loss</span><span class="o">=</span><span class="s1">&#39;mse&#39;</span><span class="p">,</span>
            <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;mae&#39;</span><span class="p">]</span>
        <span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="k">return</span> <span class="n">model</span>
    
    <span class="k">def</span> <span class="nf">prepare_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">fit_scaler</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Scale features for neural network.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">fit_scaler</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">X_val</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">y_val</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
              <span class="n">epochs</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Train the neural network with early stopping.&quot;&quot;&quot;</span>
        <span class="n">callbacks</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">EarlyStopping</span><span class="p">(</span><span class="n">monitor</span><span class="o">=</span><span class="s1">&#39;val_loss&#39;</span><span class="p">,</span> <span class="n">patience</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> 
                          <span class="n">restore_best_weights</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
            <span class="n">ReduceLROnPlateau</span><span class="p">(</span><span class="n">monitor</span><span class="o">=</span><span class="s1">&#39;val_loss&#39;</span><span class="p">,</span> <span class="n">factor</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> 
                              <span class="n">patience</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">min_lr</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">)</span>
        <span class="p">]</span>
        
        <span class="n">validation_data</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">X_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">y_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">validation_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">X_val</span><span class="p">,</span> <span class="n">y_val</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">history</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
            <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span>
            <span class="n">validation_data</span><span class="o">=</span><span class="n">validation_data</span><span class="p">,</span>
            <span class="n">epochs</span><span class="o">=</span><span class="n">epochs</span><span class="p">,</span>
            <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
            <span class="n">callbacks</span><span class="o">=</span><span class="n">callbacks</span><span class="p">,</span>
            <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span>
        <span class="p">)</span>
        
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span>
    
    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Make predictions.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">predict_classes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Predict class labels.&quot;&quot;&quot;</span>
        <span class="n">probs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">probs</span> <span class="o">&gt;=</span> <span class="n">threshold</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;FinancialNeuralNetwork class defined&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Prepare data for classification</span>
<span class="n">feature_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;return_1d&#39;</span><span class="p">,</span> <span class="s1">&#39;return_5d&#39;</span><span class="p">,</span> <span class="s1">&#39;return_20d&#39;</span><span class="p">,</span>
                <span class="s1">&#39;volatility_5d&#39;</span><span class="p">,</span> <span class="s1">&#39;volatility_10d&#39;</span><span class="p">,</span> <span class="s1">&#39;volatility_20d&#39;</span><span class="p">,</span>
                <span class="s1">&#39;price_to_sma_5&#39;</span><span class="p">,</span> <span class="s1">&#39;price_to_sma_10&#39;</span><span class="p">,</span> <span class="s1">&#39;price_to_sma_20&#39;</span><span class="p">,</span> <span class="s1">&#39;price_to_sma_50&#39;</span><span class="p">,</span>
                <span class="s1">&#39;rsi&#39;</span><span class="p">,</span> <span class="s1">&#39;macd_hist&#39;</span><span class="p">,</span> <span class="s1">&#39;volume_ratio&#39;</span><span class="p">,</span> <span class="s1">&#39;daily_range&#39;</span><span class="p">]</span>

<span class="n">X</span> <span class="o">=</span> <span class="n">df_features</span><span class="p">[</span><span class="n">feature_cols</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">df_features</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

<span class="c1"># Time-based split (no shuffling for time series)</span>
<span class="n">split_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.8</span><span class="p">)</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span> <span class="o">=</span> <span class="n">X</span><span class="p">[:</span><span class="n">split_idx</span><span class="p">],</span> <span class="n">X</span><span class="p">[</span><span class="n">split_idx</span><span class="p">:]</span>
<span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">y</span><span class="p">[:</span><span class="n">split_idx</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">split_idx</span><span class="p">:]</span>

<span class="c1"># Further split training for validation</span>
<span class="n">val_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.8</span><span class="p">)</span>
<span class="n">X_train_nn</span><span class="p">,</span> <span class="n">X_val</span> <span class="o">=</span> <span class="n">X_train</span><span class="p">[:</span><span class="n">val_idx</span><span class="p">],</span> <span class="n">X_train</span><span class="p">[</span><span class="n">val_idx</span><span class="p">:]</span>
<span class="n">y_train_nn</span><span class="p">,</span> <span class="n">y_val</span> <span class="o">=</span> <span class="n">y_train</span><span class="p">[:</span><span class="n">val_idx</span><span class="p">],</span> <span class="n">y_train</span><span class="p">[</span><span class="n">val_idx</span><span class="p">:]</span>

<span class="c1"># Build and train classifier</span>
<span class="n">nn_classifier</span> <span class="o">=</span> <span class="n">FinancialNeuralNetwork</span><span class="p">(</span>
    <span class="n">input_dim</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">feature_cols</span><span class="p">),</span>
    <span class="n">hidden_layers</span><span class="o">=</span><span class="p">[</span><span class="mi">64</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">16</span><span class="p">],</span>
    <span class="n">dropout_rate</span><span class="o">=</span><span class="mf">0.3</span>
<span class="p">)</span>
<span class="n">nn_classifier</span><span class="o">.</span><span class="n">build_classifier</span><span class="p">()</span>

<span class="c1"># Scale data</span>
<span class="n">X_train_scaled</span> <span class="o">=</span> <span class="n">nn_classifier</span><span class="o">.</span><span class="n">prepare_data</span><span class="p">(</span><span class="n">X_train_nn</span><span class="p">,</span> <span class="n">fit_scaler</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">X_val_scaled</span> <span class="o">=</span> <span class="n">nn_classifier</span><span class="o">.</span><span class="n">prepare_data</span><span class="p">(</span><span class="n">X_val</span><span class="p">,</span> <span class="n">fit_scaler</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">X_test_scaled</span> <span class="o">=</span> <span class="n">nn_classifier</span><span class="o">.</span><span class="n">prepare_data</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">fit_scaler</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># Train model</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Training neural network classifier...&quot;</span><span class="p">)</span>
<span class="n">history</span> <span class="o">=</span> <span class="n">nn_classifier</span><span class="o">.</span><span class="n">train</span><span class="p">(</span>
    <span class="n">X_train_scaled</span><span class="p">,</span> <span class="n">y_train_nn</span><span class="p">,</span>
    <span class="n">X_val_scaled</span><span class="p">,</span> <span class="n">y_val</span><span class="p">,</span>
    <span class="n">epochs</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
    <span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span>
<span class="p">)</span>

<span class="c1"># Evaluate</span>
<span class="n">train_pred</span> <span class="o">=</span> <span class="n">nn_classifier</span><span class="o">.</span><span class="n">predict_classes</span><span class="p">(</span><span class="n">X_train_scaled</span><span class="p">)</span>
<span class="n">test_pred</span> <span class="o">=</span> <span class="n">nn_classifier</span><span class="o">.</span><span class="n">predict_classes</span><span class="p">(</span><span class="n">X_test_scaled</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Training accuracy: </span><span class="si">{</span><span class="n">accuracy_score</span><span class="p">(</span><span class="n">y_train_nn</span><span class="p">,</span> <span class="n">train_pred</span><span class="p">)</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Test accuracy: </span><span class="si">{</span><span class="n">accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">test_pred</span><span class="p">)</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Visualize training history</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>

<span class="c1"># Loss</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">history</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Training&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">history</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;val_loss&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Validation&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Epoch&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Loss&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Model Loss&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="c1"># Accuracy</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">history</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Training&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">history</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;val_accuracy&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Validation&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Epoch&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Accuracy&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Model Accuracy&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
<div class="md-cell"><hr />
<h2>Section 2: LSTM Networks for Time Series</h2>
<p>Long Short-Term Memory (LSTM) networks are designed to capture long-term dependencies in sequential data, making them ideal for financial time series.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># LSTM for Financial Time Series</span>
<span class="k">class</span> <span class="nc">FinancialLSTM</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;LSTM network for financial time series prediction.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sequence_length</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">n_features</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                 <span class="n">lstm_units</span><span class="o">=</span><span class="p">[</span><span class="mi">64</span><span class="p">,</span> <span class="mi">32</span><span class="p">],</span> <span class="n">dropout_rate</span><span class="o">=</span><span class="mf">0.2</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sequence_length</span> <span class="o">=</span> <span class="n">sequence_length</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_features</span> <span class="o">=</span> <span class="n">n_features</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lstm_units</span> <span class="o">=</span> <span class="n">lstm_units</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dropout_rate</span> <span class="o">=</span> <span class="n">dropout_rate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scaler</span> <span class="o">=</span> <span class="n">MinMaxScaler</span><span class="p">()</span>
        
    <span class="k">def</span> <span class="nf">create_sequences</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">target_col_idx</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create sequences for LSTM input.&quot;&quot;&quot;</span>
        <span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sequence_length</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)):</span>
            <span class="n">X</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">sequence_length</span><span class="p">:</span><span class="n">i</span><span class="p">])</span>
            <span class="n">y</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">target_col_idx</span><span class="p">])</span>
        
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">X</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">build_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_type</span><span class="o">=</span><span class="s1">&#39;regression&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Build LSTM model.&quot;&quot;&quot;</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Sequential</span><span class="p">()</span>
        
        <span class="c1"># First LSTM layer</span>
        <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">LSTM</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lstm_units</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">return_sequences</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lstm_units</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">,</span>
            <span class="n">input_shape</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sequence_length</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_features</span><span class="p">)</span>
        <span class="p">))</span>
        <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dropout_rate</span><span class="p">))</span>
        
        <span class="c1"># Additional LSTM layers</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">units</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lstm_units</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
            <span class="n">return_seq</span> <span class="o">=</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lstm_units</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span>
            <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">LSTM</span><span class="p">(</span><span class="n">units</span><span class="p">,</span> <span class="n">return_sequences</span><span class="o">=</span><span class="n">return_seq</span><span class="p">))</span>
            <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dropout_rate</span><span class="p">))</span>
        
        <span class="c1"># Dense layers</span>
        <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">))</span>
        
        <span class="c1"># Output layer</span>
        <span class="k">if</span> <span class="n">output_type</span> <span class="o">==</span> <span class="s1">&#39;regression&#39;</span><span class="p">:</span>
            <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">))</span>
            <span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="n">Adam</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.001</span><span class="p">),</span>
                          <span class="n">loss</span><span class="o">=</span><span class="s1">&#39;mse&#39;</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;mae&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;sigmoid&#39;</span><span class="p">))</span>
            <span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="n">Adam</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.001</span><span class="p">),</span>
                          <span class="n">loss</span><span class="o">=</span><span class="s1">&#39;binary_crossentropy&#39;</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">])</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="k">return</span> <span class="n">model</span>
    
    <span class="k">def</span> <span class="nf">prepare_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">feature_cols</span><span class="p">,</span> <span class="n">target_col</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Prepare data for LSTM training.&quot;&quot;&quot;</span>
        <span class="c1"># Get features and target</span>
        <span class="n">features</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">feature_cols</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        
        <span class="c1"># Scale features</span>
        <span class="n">scaled_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>
        
        <span class="c1"># Create sequences</span>
        <span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_sequences</span><span class="p">(</span><span class="n">scaled_features</span><span class="p">,</span> 
                                      <span class="n">target_col_idx</span><span class="o">=</span><span class="n">feature_cols</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">target_col</span><span class="p">))</span>
        
        <span class="k">return</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span>
    
    <span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">X_val</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">y_val</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
              <span class="n">epochs</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Train LSTM model.&quot;&quot;&quot;</span>
        <span class="n">callbacks</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">EarlyStopping</span><span class="p">(</span><span class="n">monitor</span><span class="o">=</span><span class="s1">&#39;val_loss&#39;</span><span class="p">,</span> <span class="n">patience</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                          <span class="n">restore_best_weights</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
            <span class="n">ReduceLROnPlateau</span><span class="p">(</span><span class="n">monitor</span><span class="o">=</span><span class="s1">&#39;val_loss&#39;</span><span class="p">,</span> <span class="n">factor</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                              <span class="n">patience</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">min_lr</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">)</span>
        <span class="p">]</span>
        
        <span class="n">validation_data</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">X_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">validation_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">X_val</span><span class="p">,</span> <span class="n">y_val</span><span class="p">)</span>
        
        <span class="n">history</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
            <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span>
            <span class="n">validation_data</span><span class="o">=</span><span class="n">validation_data</span><span class="p">,</span>
            <span class="n">epochs</span><span class="o">=</span><span class="n">epochs</span><span class="p">,</span>
            <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
            <span class="n">callbacks</span><span class="o">=</span><span class="n">callbacks</span><span class="p">,</span>
            <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span>
        <span class="p">)</span>
        
        <span class="k">return</span> <span class="n">history</span>
    
    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Make predictions.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;FinancialLSTM class defined&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Prepare data for LSTM</span>
<span class="n">lstm_features</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;return_1d&#39;</span><span class="p">,</span> <span class="s1">&#39;volatility_10d&#39;</span><span class="p">,</span> <span class="s1">&#39;rsi&#39;</span><span class="p">,</span> <span class="s1">&#39;macd_hist&#39;</span><span class="p">,</span> <span class="s1">&#39;volume_ratio&#39;</span><span class="p">]</span>

<span class="c1"># Add return as target (shifted for prediction)</span>
<span class="n">df_lstm</span> <span class="o">=</span> <span class="n">df_features</span><span class="p">[</span><span class="n">lstm_features</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">df_lstm</span><span class="p">[</span><span class="s1">&#39;target_return&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_features</span><span class="p">[</span><span class="s1">&#39;return_1d&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">df_lstm</span> <span class="o">=</span> <span class="n">df_lstm</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

<span class="c1"># Scale all features</span>
<span class="n">scaler</span> <span class="o">=</span> <span class="n">MinMaxScaler</span><span class="p">()</span>
<span class="n">scaled_data</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">df_lstm</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

<span class="c1"># Create sequences</span>
<span class="n">sequence_length</span> <span class="o">=</span> <span class="mi">20</span>
<span class="n">X_seq</span><span class="p">,</span> <span class="n">y_seq</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">sequence_length</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">scaled_data</span><span class="p">)):</span>
    <span class="n">X_seq</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scaled_data</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="n">sequence_length</span><span class="p">:</span><span class="n">i</span><span class="p">,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># All features except target</span>
    <span class="n">y_seq</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scaled_data</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># Target return</span>

<span class="n">X_seq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">X_seq</span><span class="p">)</span>
<span class="n">y_seq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y_seq</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sequence shape: </span><span class="si">{</span><span class="n">X_seq</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Target shape: </span><span class="si">{</span><span class="n">y_seq</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Train LSTM model</span>
<span class="c1"># Time-based split</span>
<span class="n">split_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">X_seq</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.8</span><span class="p">)</span>
<span class="n">X_train_lstm</span> <span class="o">=</span> <span class="n">X_seq</span><span class="p">[:</span><span class="n">split_idx</span><span class="p">]</span>
<span class="n">X_test_lstm</span> <span class="o">=</span> <span class="n">X_seq</span><span class="p">[</span><span class="n">split_idx</span><span class="p">:]</span>
<span class="n">y_train_lstm</span> <span class="o">=</span> <span class="n">y_seq</span><span class="p">[:</span><span class="n">split_idx</span><span class="p">]</span>
<span class="n">y_test_lstm</span> <span class="o">=</span> <span class="n">y_seq</span><span class="p">[</span><span class="n">split_idx</span><span class="p">:]</span>

<span class="c1"># Validation split</span>
<span class="n">val_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">X_train_lstm</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.8</span><span class="p">)</span>
<span class="n">X_train_l</span><span class="p">,</span> <span class="n">X_val_l</span> <span class="o">=</span> <span class="n">X_train_lstm</span><span class="p">[:</span><span class="n">val_idx</span><span class="p">],</span> <span class="n">X_train_lstm</span><span class="p">[</span><span class="n">val_idx</span><span class="p">:]</span>
<span class="n">y_train_l</span><span class="p">,</span> <span class="n">y_val_l</span> <span class="o">=</span> <span class="n">y_train_lstm</span><span class="p">[:</span><span class="n">val_idx</span><span class="p">],</span> <span class="n">y_train_lstm</span><span class="p">[</span><span class="n">val_idx</span><span class="p">:]</span>

<span class="c1"># Build LSTM</span>
<span class="n">lstm_model</span> <span class="o">=</span> <span class="n">Sequential</span><span class="p">([</span>
    <span class="n">layers</span><span class="o">.</span><span class="n">LSTM</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="n">return_sequences</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
                <span class="n">input_shape</span><span class="o">=</span><span class="p">(</span><span class="n">sequence_length</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">lstm_features</span><span class="p">))),</span>
    <span class="n">layers</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.2</span><span class="p">),</span>
    <span class="n">layers</span><span class="o">.</span><span class="n">LSTM</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="n">return_sequences</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
    <span class="n">layers</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.2</span><span class="p">),</span>
    <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">),</span>
    <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">)</span>
<span class="p">])</span>

<span class="n">lstm_model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="n">Adam</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.001</span><span class="p">),</span>
                   <span class="n">loss</span><span class="o">=</span><span class="s1">&#39;mse&#39;</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;mae&#39;</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Training LSTM model...&quot;</span><span class="p">)</span>
<span class="n">lstm_history</span> <span class="o">=</span> <span class="n">lstm_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
    <span class="n">X_train_l</span><span class="p">,</span> <span class="n">y_train_l</span><span class="p">,</span>
    <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">X_val_l</span><span class="p">,</span> <span class="n">y_val_l</span><span class="p">),</span>
    <span class="n">epochs</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
    <span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span>
    <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">EarlyStopping</span><span class="p">(</span><span class="n">monitor</span><span class="o">=</span><span class="s1">&#39;val_loss&#39;</span><span class="p">,</span> <span class="n">patience</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">restore_best_weights</span><span class="o">=</span><span class="kc">True</span><span class="p">)],</span>
    <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span>
<span class="p">)</span>

<span class="c1"># Evaluate</span>
<span class="n">train_pred_lstm</span> <span class="o">=</span> <span class="n">lstm_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_train_l</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">test_pred_lstm</span> <span class="o">=</span> <span class="n">lstm_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test_lstm</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Training MSE: </span><span class="si">{</span><span class="n">mean_squared_error</span><span class="p">(</span><span class="n">y_train_l</span><span class="p">,</span> <span class="n">train_pred_lstm</span><span class="p">)</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Test MSE: </span><span class="si">{</span><span class="n">mean_squared_error</span><span class="p">(</span><span class="n">y_test_lstm</span><span class="p">,</span> <span class="n">test_pred_lstm</span><span class="p">)</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Test MAE: </span><span class="si">{</span><span class="n">mean_absolute_error</span><span class="p">(</span><span class="n">y_test_lstm</span><span class="p">,</span> <span class="n">test_pred_lstm</span><span class="p">)</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Visualize LSTM predictions</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

<span class="c1"># Training history</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lstm_history</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Training Loss&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lstm_history</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;val_loss&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Validation Loss&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Epoch&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Loss (MSE)&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;LSTM Training History&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="c1"># Predictions vs Actual</span>
<span class="n">test_range</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">test_pred_lstm</span><span class="p">))</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">test_range</span><span class="p">,</span> <span class="n">y_test_lstm</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Actual&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">test_range</span><span class="p">,</span> <span class="n">test_pred_lstm</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Predicted&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time Step&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Scaled Return&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;LSTM Predictions vs Actual (Test Set)&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
<div class="md-cell"><hr />
<h2>Section 3: Attention Mechanisms and Transformers</h2>
<p>Transformers use attention mechanisms to capture relationships across all time steps simultaneously, often outperforming LSTMs on financial data.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Custom Attention Layer</span>
<span class="k">class</span> <span class="nc">AttentionLayer</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">Layer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Simple attention mechanism for time series.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">AttentionLayer</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_shape</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">W</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_weight</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;attention_weight&#39;</span><span class="p">,</span>
            <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">input_shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">),</span>
            <span class="n">initializer</span><span class="o">=</span><span class="s1">&#39;glorot_uniform&#39;</span><span class="p">,</span>
            <span class="n">trainable</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_weight</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;attention_bias&#39;</span><span class="p">,</span>
            <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">input_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">),</span>
            <span class="n">initializer</span><span class="o">=</span><span class="s1">&#39;zeros&#39;</span><span class="p">,</span>
            <span class="n">trainable</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">AttentionLayer</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">input_shape</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="c1"># Compute attention scores</span>
        <span class="n">e</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">W</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="p">)</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        
        <span class="c1"># Apply attention weights</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">a</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">output</span>
    
    <span class="k">def</span> <span class="nf">compute_output_shape</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_shape</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">input_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">input_shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;AttentionLayer defined&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Transformer Block for Financial Data</span>
<span class="k">class</span> <span class="nc">TransformerBlock</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">Layer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Transformer block with multi-head attention.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">embed_dim</span><span class="p">,</span> <span class="n">num_heads</span><span class="p">,</span> <span class="n">ff_dim</span><span class="p">,</span> <span class="n">dropout_rate</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TransformerBlock</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">embed_dim</span> <span class="o">=</span> <span class="n">embed_dim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_heads</span> <span class="o">=</span> <span class="n">num_heads</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ff_dim</span> <span class="o">=</span> <span class="n">ff_dim</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">att</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">MultiHeadAttention</span><span class="p">(</span>
            <span class="n">num_heads</span><span class="o">=</span><span class="n">num_heads</span><span class="p">,</span> 
            <span class="n">key_dim</span><span class="o">=</span><span class="n">embed_dim</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ffn</span> <span class="o">=</span> <span class="n">Sequential</span><span class="p">([</span>
            <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">ff_dim</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">),</span>
            <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">embed_dim</span><span class="p">)</span>
        <span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layernorm1</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">LayerNormalization</span><span class="p">(</span><span class="n">epsilon</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layernorm2</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">LayerNormalization</span><span class="p">(</span><span class="n">epsilon</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dropout1</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">dropout_rate</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dropout2</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">dropout_rate</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">training</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="c1"># Multi-head self-attention</span>
        <span class="n">attn_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">att</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">inputs</span><span class="p">)</span>
        <span class="n">attn_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout1</span><span class="p">(</span><span class="n">attn_output</span><span class="p">,</span> <span class="n">training</span><span class="o">=</span><span class="n">training</span><span class="p">)</span>
        <span class="n">out1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">layernorm1</span><span class="p">(</span><span class="n">inputs</span> <span class="o">+</span> <span class="n">attn_output</span><span class="p">)</span>
        
        <span class="c1"># Feed-forward network</span>
        <span class="n">ffn_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ffn</span><span class="p">(</span><span class="n">out1</span><span class="p">)</span>
        <span class="n">ffn_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout2</span><span class="p">(</span><span class="n">ffn_output</span><span class="p">,</span> <span class="n">training</span><span class="o">=</span><span class="n">training</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">layernorm2</span><span class="p">(</span><span class="n">out1</span> <span class="o">+</span> <span class="n">ffn_output</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;TransformerBlock defined&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Positional Encoding for Transformers</span>
<span class="k">class</span> <span class="nc">PositionalEncoding</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">Layer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Add positional information to embeddings.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sequence_length</span><span class="p">,</span> <span class="n">embed_dim</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">PositionalEncoding</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sequence_length</span> <span class="o">=</span> <span class="n">sequence_length</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">embed_dim</span> <span class="o">=</span> <span class="n">embed_dim</span>
        
    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_shape</span><span class="p">):</span>
        <span class="c1"># Create positional encoding matrix</span>
        <span class="n">position</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sequence_length</span><span class="p">)[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
        <span class="n">div_term</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">embed_dim</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> 
                          <span class="o">-</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">10000.0</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">embed_dim</span><span class="p">))</span>
        
        <span class="n">pe</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">sequence_length</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">embed_dim</span><span class="p">))</span>
        <span class="n">pe</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">position</span> <span class="o">*</span> <span class="n">div_term</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">embed_dim</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">pe</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">position</span> <span class="o">*</span> <span class="n">div_term</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">embed_dim</span><span class="o">//</span><span class="mi">2</span><span class="p">])</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">pe</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">pe</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">PositionalEncoding</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">input_shape</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">pe</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;PositionalEncoding defined&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Build Financial Transformer Model</span>
<span class="k">def</span> <span class="nf">build_financial_transformer</span><span class="p">(</span><span class="n">sequence_length</span><span class="p">,</span> <span class="n">n_features</span><span class="p">,</span> 
                                 <span class="n">embed_dim</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">num_heads</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> 
                                 <span class="n">ff_dim</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">num_blocks</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                                 <span class="n">output_type</span><span class="o">=</span><span class="s1">&#39;regression&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Build a Transformer model for financial prediction.&quot;&quot;&quot;</span>
    
    <span class="n">inputs</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">sequence_length</span><span class="p">,</span> <span class="n">n_features</span><span class="p">))</span>
    
    <span class="c1"># Project input to embedding dimension</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">embed_dim</span><span class="p">)(</span><span class="n">inputs</span><span class="p">)</span>
    
    <span class="c1"># Add positional encoding</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">PositionalEncoding</span><span class="p">(</span><span class="n">sequence_length</span><span class="p">,</span> <span class="n">embed_dim</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
    
    <span class="c1"># Transformer blocks</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_blocks</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">TransformerBlock</span><span class="p">(</span><span class="n">embed_dim</span><span class="p">,</span> <span class="n">num_heads</span><span class="p">,</span> <span class="n">ff_dim</span><span class="p">,</span> <span class="n">dropout_rate</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
    
    <span class="c1"># Global average pooling</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">GlobalAveragePooling1D</span><span class="p">()(</span><span class="n">x</span><span class="p">)</span>
    
    <span class="c1"># Dense layers</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.2</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
    
    <span class="c1"># Output layer</span>
    <span class="k">if</span> <span class="n">output_type</span> <span class="o">==</span> <span class="s1">&#39;regression&#39;</span><span class="p">:</span>
        <span class="n">outputs</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Model</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="n">Adam</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.001</span><span class="p">),</span>
                      <span class="n">loss</span><span class="o">=</span><span class="s1">&#39;mse&#39;</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;mae&#39;</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">outputs</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;sigmoid&#39;</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Model</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="n">Adam</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.001</span><span class="p">),</span>
                      <span class="n">loss</span><span class="o">=</span><span class="s1">&#39;binary_crossentropy&#39;</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">])</span>
    
    <span class="k">return</span> <span class="n">model</span>

<span class="c1"># Build and train transformer</span>
<span class="n">transformer_model</span> <span class="o">=</span> <span class="n">build_financial_transformer</span><span class="p">(</span>
    <span class="n">sequence_length</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
    <span class="n">n_features</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">lstm_features</span><span class="p">),</span>
    <span class="n">embed_dim</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span>
    <span class="n">num_heads</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
    <span class="n">ff_dim</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span>
    <span class="n">num_blocks</span><span class="o">=</span><span class="mi">2</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Financial Transformer built&quot;</span><span class="p">)</span>
<span class="n">transformer_model</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Train transformer model</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Training Transformer model...&quot;</span><span class="p">)</span>
<span class="n">transformer_history</span> <span class="o">=</span> <span class="n">transformer_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
    <span class="n">X_train_l</span><span class="p">,</span> <span class="n">y_train_l</span><span class="p">,</span>
    <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">X_val_l</span><span class="p">,</span> <span class="n">y_val_l</span><span class="p">),</span>
    <span class="n">epochs</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
    <span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span>
    <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">EarlyStopping</span><span class="p">(</span><span class="n">monitor</span><span class="o">=</span><span class="s1">&#39;val_loss&#39;</span><span class="p">,</span> <span class="n">patience</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">restore_best_weights</span><span class="o">=</span><span class="kc">True</span><span class="p">)],</span>
    <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span>
<span class="p">)</span>

<span class="c1"># Evaluate</span>
<span class="n">transformer_pred</span> <span class="o">=</span> <span class="n">transformer_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test_lstm</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Transformer Test MSE: </span><span class="si">{</span><span class="n">mean_squared_error</span><span class="p">(</span><span class="n">y_test_lstm</span><span class="p">,</span> <span class="n">transformer_pred</span><span class="p">)</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Transformer Test MAE: </span><span class="si">{</span><span class="n">mean_absolute_error</span><span class="p">(</span><span class="n">y_test_lstm</span><span class="p">,</span> <span class="n">transformer_pred</span><span class="p">)</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">LSTM Test MSE: </span><span class="si">{</span><span class="n">mean_squared_error</span><span class="p">(</span><span class="n">y_test_lstm</span><span class="p">,</span> <span class="n">test_pred_lstm</span><span class="p">)</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;LSTM Test MAE: </span><span class="si">{</span><span class="n">mean_absolute_error</span><span class="p">(</span><span class="n">y_test_lstm</span><span class="p">,</span> <span class="n">test_pred_lstm</span><span class="p">)</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><hr />
<h2>Section 4: Deep Learning Architecture Design</h2>
<p>Designing the right architecture is crucial for financial applications. This section covers best practices and common patterns.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Multi-Input Deep Learning Model</span>
<span class="k">class</span> <span class="nc">MultiInputFinanceModel</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Deep learning model with multiple input branches.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sequence_length</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">n_price_features</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                 <span class="n">n_fundamental_features</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sequence_length</span> <span class="o">=</span> <span class="n">sequence_length</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_price_features</span> <span class="o">=</span> <span class="n">n_price_features</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_fundamental_features</span> <span class="o">=</span> <span class="n">n_fundamental_features</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="kc">None</span>
        
    <span class="k">def</span> <span class="nf">build_model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Build multi-input model with LSTM and dense branches.&quot;&quot;&quot;</span>
        
        <span class="c1"># Price time series input (LSTM branch)</span>
        <span class="n">price_input</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Input</span><span class="p">(</span>
            <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sequence_length</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_price_features</span><span class="p">),</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;price_input&#39;</span>
        <span class="p">)</span>
        
        <span class="n">lstm_out</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">LSTM</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="n">return_sequences</span><span class="o">=</span><span class="kc">True</span><span class="p">)(</span><span class="n">price_input</span><span class="p">)</span>
        <span class="n">lstm_out</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.2</span><span class="p">)(</span><span class="n">lstm_out</span><span class="p">)</span>
        <span class="n">lstm_out</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">LSTM</span><span class="p">(</span><span class="mi">32</span><span class="p">)(</span><span class="n">lstm_out</span><span class="p">)</span>
        <span class="n">lstm_out</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.2</span><span class="p">)(</span><span class="n">lstm_out</span><span class="p">)</span>
        <span class="n">lstm_out</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">)(</span><span class="n">lstm_out</span><span class="p">)</span>
        
        <span class="c1"># Fundamental features input (Dense branch)</span>
        <span class="n">fundamental_input</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Input</span><span class="p">(</span>
            <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_fundamental_features</span><span class="p">,),</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;fundamental_input&#39;</span>
        <span class="p">)</span>
        
        <span class="n">dense_out</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">)(</span><span class="n">fundamental_input</span><span class="p">)</span>
        <span class="n">dense_out</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">BatchNormalization</span><span class="p">()(</span><span class="n">dense_out</span><span class="p">)</span>
        <span class="n">dense_out</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.3</span><span class="p">)(</span><span class="n">dense_out</span><span class="p">)</span>
        <span class="n">dense_out</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">)(</span><span class="n">dense_out</span><span class="p">)</span>
        
        <span class="c1"># Merge branches</span>
        <span class="n">merged</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Concatenate</span><span class="p">()([</span><span class="n">lstm_out</span><span class="p">,</span> <span class="n">dense_out</span><span class="p">])</span>
        
        <span class="c1"># Final layers</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">)(</span><span class="n">merged</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.2</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
        
        <span class="c1"># Output</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;sigmoid&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;output&#39;</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">Model</span><span class="p">(</span>
            <span class="n">inputs</span><span class="o">=</span><span class="p">[</span><span class="n">price_input</span><span class="p">,</span> <span class="n">fundamental_input</span><span class="p">],</span>
            <span class="n">outputs</span><span class="o">=</span><span class="n">output</span>
        <span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
            <span class="n">optimizer</span><span class="o">=</span><span class="n">Adam</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.001</span><span class="p">),</span>
            <span class="n">loss</span><span class="o">=</span><span class="s1">&#39;binary_crossentropy&#39;</span><span class="p">,</span>
            <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span>
        <span class="p">)</span>
        
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span>

<span class="c1"># Create multi-input model</span>
<span class="n">multi_model</span> <span class="o">=</span> <span class="n">MultiInputFinanceModel</span><span class="p">(</span>
    <span class="n">sequence_length</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
    <span class="n">n_price_features</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
    <span class="n">n_fundamental_features</span><span class="o">=</span><span class="mi">10</span>
<span class="p">)</span>
<span class="n">multi_model</span><span class="o">.</span><span class="n">build_model</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Multi-Input Model Architecture:&quot;</span><span class="p">)</span>
<span class="n">multi_model</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Residual Network for Finance</span>
<span class="k">def</span> <span class="nf">residual_block</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">units</span><span class="p">,</span> <span class="n">dropout_rate</span><span class="o">=</span><span class="mf">0.2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create a residual block with skip connection.&quot;&quot;&quot;</span>
    <span class="c1"># Main path</span>
    <span class="n">shortcut</span> <span class="o">=</span> <span class="n">x</span>
    
    <span class="n">x</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">units</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">BatchNormalization</span><span class="p">()(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">dropout_rate</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">units</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">BatchNormalization</span><span class="p">()(</span><span class="n">x</span><span class="p">)</span>
    
    <span class="c1"># Skip connection</span>
    <span class="k">if</span> <span class="n">shortcut</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">units</span><span class="p">:</span>
        <span class="n">shortcut</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">units</span><span class="p">)(</span><span class="n">shortcut</span><span class="p">)</span>
    
    <span class="n">x</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Add</span><span class="p">()([</span><span class="n">x</span><span class="p">,</span> <span class="n">shortcut</span><span class="p">])</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Activation</span><span class="p">(</span><span class="s1">&#39;relu&#39;</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">dropout_rate</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">x</span>

<span class="k">def</span> <span class="nf">build_resnet_finance</span><span class="p">(</span><span class="n">input_dim</span><span class="p">,</span> <span class="n">hidden_units</span><span class="o">=</span><span class="p">[</span><span class="mi">64</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">16</span><span class="p">]):</span>
    <span class="sd">&quot;&quot;&quot;Build a ResNet-style model for financial data.&quot;&quot;&quot;</span>
    <span class="n">inputs</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">input_dim</span><span class="p">,))</span>
    
    <span class="n">x</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">hidden_units</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">)(</span><span class="n">inputs</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">BatchNormalization</span><span class="p">()(</span><span class="n">x</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">units</span> <span class="ow">in</span> <span class="n">hidden_units</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">residual_block</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">units</span><span class="p">)</span>
    
    <span class="n">x</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">outputs</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;sigmoid&#39;</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
    
    <span class="n">model</span> <span class="o">=</span> <span class="n">Model</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
        <span class="n">optimizer</span><span class="o">=</span><span class="n">Adam</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.001</span><span class="p">),</span>
        <span class="n">loss</span><span class="o">=</span><span class="s1">&#39;binary_crossentropy&#39;</span><span class="p">,</span>
        <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span>
    <span class="p">)</span>
    
    <span class="k">return</span> <span class="n">model</span>

<span class="c1"># Build ResNet model</span>
<span class="n">resnet_model</span> <span class="o">=</span> <span class="n">build_resnet_finance</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">feature_cols</span><span class="p">),</span> <span class="n">hidden_units</span><span class="o">=</span><span class="p">[</span><span class="mi">64</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">16</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ResNet-style Financial Model:&quot;</span><span class="p">)</span>
<span class="n">resnet_model</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Compare architectures</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Training ResNet model for comparison...&quot;</span><span class="p">)</span>
<span class="n">resnet_history</span> <span class="o">=</span> <span class="n">resnet_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
    <span class="n">X_train_scaled</span><span class="p">,</span> <span class="n">y_train_nn</span><span class="p">,</span>
    <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">X_val_scaled</span><span class="p">,</span> <span class="n">y_val</span><span class="p">),</span>
    <span class="n">epochs</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
    <span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span>
    <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">EarlyStopping</span><span class="p">(</span><span class="n">monitor</span><span class="o">=</span><span class="s1">&#39;val_loss&#39;</span><span class="p">,</span> <span class="n">patience</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">restore_best_weights</span><span class="o">=</span><span class="kc">True</span><span class="p">)],</span>
    <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span>
<span class="p">)</span>

<span class="c1"># Evaluate</span>
<span class="n">resnet_pred</span> <span class="o">=</span> <span class="p">(</span><span class="n">resnet_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test_scaled</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Architecture Comparison (Test Set):&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Simple NN Accuracy: </span><span class="si">{</span><span class="n">accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">test_pred</span><span class="p">)</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ResNet Accuracy: </span><span class="si">{</span><span class="n">accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">resnet_pred</span><span class="p">)</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><hr />
<h2>Section 5: Regularization and Optimization Techniques</h2>
<p>Financial data is noisy and prone to overfitting. Proper regularization is essential.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Custom Financial Loss Functions</span>
<span class="k">def</span> <span class="nf">directional_loss</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Loss that penalizes wrong direction more than magnitude.&quot;&quot;&quot;</span>
    <span class="n">direction_true</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">y_true</span><span class="p">)</span>
    <span class="n">direction_pred</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">y_pred</span><span class="p">)</span>
    
    <span class="c1"># MSE component</span>
    <span class="n">mse_loss</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">y_true</span> <span class="o">-</span> <span class="n">y_pred</span><span class="p">))</span>
    
    <span class="c1"># Direction penalty</span>
    <span class="n">direction_penalty</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">direction_true</span> <span class="o">!=</span> <span class="n">direction_pred</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="p">)</span>
    
    <span class="k">return</span> <span class="n">mse_loss</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">direction_penalty</span>


<span class="k">def</span> <span class="nf">sharpe_loss</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Loss based on Sharpe ratio approximation.&quot;&quot;&quot;</span>
    <span class="c1"># Predicted returns (position * actual return)</span>
    <span class="n">pred_returns</span> <span class="o">=</span> <span class="n">y_pred</span> <span class="o">*</span> <span class="n">y_true</span>
    
    <span class="n">mean_return</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span><span class="n">pred_returns</span><span class="p">)</span>
    <span class="n">std_return</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">reduce_std</span><span class="p">(</span><span class="n">pred_returns</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1e-8</span>
    
    <span class="c1"># Negative Sharpe (to minimize)</span>
    <span class="n">sharpe</span> <span class="o">=</span> <span class="n">mean_return</span> <span class="o">/</span> <span class="n">std_return</span>
    
    <span class="k">return</span> <span class="o">-</span><span class="n">sharpe</span>


<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Custom loss functions defined&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Advanced Regularization Techniques</span>
<span class="k">def</span> <span class="nf">build_regularized_model</span><span class="p">(</span><span class="n">input_dim</span><span class="p">,</span> <span class="n">l1_reg</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">l2_reg</span><span class="o">=</span><span class="mf">0.01</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Build a heavily regularized model for noisy financial data.&quot;&quot;&quot;</span>
    
    <span class="n">model</span> <span class="o">=</span> <span class="n">Sequential</span><span class="p">([</span>
        <span class="c1"># Input layer with L1/L2 regularization</span>
        <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span>
            <span class="mi">64</span><span class="p">,</span> 
            <span class="n">input_dim</span><span class="o">=</span><span class="n">input_dim</span><span class="p">,</span>
            <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">,</span>
            <span class="n">kernel_regularizer</span><span class="o">=</span><span class="n">keras</span><span class="o">.</span><span class="n">regularizers</span><span class="o">.</span><span class="n">l1_l2</span><span class="p">(</span><span class="n">l1</span><span class="o">=</span><span class="n">l1_reg</span><span class="p">,</span> <span class="n">l2</span><span class="o">=</span><span class="n">l2_reg</span><span class="p">),</span>
            <span class="n">activity_regularizer</span><span class="o">=</span><span class="n">keras</span><span class="o">.</span><span class="n">regularizers</span><span class="o">.</span><span class="n">l2</span><span class="p">(</span><span class="n">l2_reg</span><span class="p">)</span>
        <span class="p">),</span>
        <span class="n">layers</span><span class="o">.</span><span class="n">BatchNormalization</span><span class="p">(),</span>
        <span class="n">layers</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.4</span><span class="p">),</span>
        
        <span class="c1"># Hidden layers</span>
        <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span>
            <span class="mi">32</span><span class="p">,</span> 
            <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">,</span>
            <span class="n">kernel_regularizer</span><span class="o">=</span><span class="n">keras</span><span class="o">.</span><span class="n">regularizers</span><span class="o">.</span><span class="n">l2</span><span class="p">(</span><span class="n">l2_reg</span><span class="p">)</span>
        <span class="p">),</span>
        <span class="n">layers</span><span class="o">.</span><span class="n">BatchNormalization</span><span class="p">(),</span>
        <span class="n">layers</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.3</span><span class="p">),</span>
        
        <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span>
            <span class="mi">16</span><span class="p">,</span> 
            <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">,</span>
            <span class="n">kernel_regularizer</span><span class="o">=</span><span class="n">keras</span><span class="o">.</span><span class="n">regularizers</span><span class="o">.</span><span class="n">l2</span><span class="p">(</span><span class="n">l2_reg</span><span class="p">)</span>
        <span class="p">),</span>
        <span class="n">layers</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.2</span><span class="p">),</span>
        
        <span class="c1"># Output</span>
        <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;sigmoid&#39;</span><span class="p">)</span>
    <span class="p">])</span>
    
    <span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
        <span class="n">optimizer</span><span class="o">=</span><span class="n">Adam</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.001</span><span class="p">),</span>
        <span class="n">loss</span><span class="o">=</span><span class="s1">&#39;binary_crossentropy&#39;</span><span class="p">,</span>
        <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span>
    <span class="p">)</span>
    
    <span class="k">return</span> <span class="n">model</span>

<span class="c1"># Build and train regularized model</span>
<span class="n">reg_model</span> <span class="o">=</span> <span class="n">build_regularized_model</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">feature_cols</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Training regularized model...&quot;</span><span class="p">)</span>
<span class="n">reg_history</span> <span class="o">=</span> <span class="n">reg_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
    <span class="n">X_train_scaled</span><span class="p">,</span> <span class="n">y_train_nn</span><span class="p">,</span>
    <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">X_val_scaled</span><span class="p">,</span> <span class="n">y_val</span><span class="p">),</span>
    <span class="n">epochs</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
    <span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span>
    <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">EarlyStopping</span><span class="p">(</span><span class="n">monitor</span><span class="o">=</span><span class="s1">&#39;val_loss&#39;</span><span class="p">,</span> <span class="n">patience</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">restore_best_weights</span><span class="o">=</span><span class="kc">True</span><span class="p">)],</span>
    <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span>
<span class="p">)</span>

<span class="c1"># Compare overfitting</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Regularization Effect:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Train-Val accuracy gap (Original): </span><span class="si">{</span><span class="n">history</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">history</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;val_accuracy&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Train-Val accuracy gap (Regularized): </span><span class="si">{</span><span class="n">reg_history</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">reg_history</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;val_accuracy&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Learning Rate Scheduling</span>
<span class="k">def</span> <span class="nf">get_lr_schedule</span><span class="p">(</span><span class="n">initial_lr</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">decay_steps</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">decay_rate</span><span class="o">=</span><span class="mf">0.9</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create exponential decay learning rate schedule.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">schedules</span><span class="o">.</span><span class="n">ExponentialDecay</span><span class="p">(</span>
        <span class="n">initial_learning_rate</span><span class="o">=</span><span class="n">initial_lr</span><span class="p">,</span>
        <span class="n">decay_steps</span><span class="o">=</span><span class="n">decay_steps</span><span class="p">,</span>
        <span class="n">decay_rate</span><span class="o">=</span><span class="n">decay_rate</span><span class="p">,</span>
        <span class="n">staircase</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>

<span class="k">def</span> <span class="nf">get_warmup_schedule</span><span class="p">(</span><span class="n">initial_lr</span><span class="o">=</span><span class="mf">0.0001</span><span class="p">,</span> <span class="n">target_lr</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">warmup_steps</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create learning rate schedule with warmup.&quot;&quot;&quot;</span>
    <span class="k">class</span> <span class="nc">WarmupSchedule</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">schedules</span><span class="o">.</span><span class="n">LearningRateSchedule</span><span class="p">):</span>
        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">initial_lr</span><span class="p">,</span> <span class="n">target_lr</span><span class="p">,</span> <span class="n">warmup_steps</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">initial_lr</span> <span class="o">=</span> <span class="n">initial_lr</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">target_lr</span> <span class="o">=</span> <span class="n">target_lr</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">warmup_steps</span> <span class="o">=</span> <span class="n">warmup_steps</span>
            
        <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">step</span><span class="p">):</span>
            <span class="n">step</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
            <span class="n">warmup_factor</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">step</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">warmup_steps</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_lr</span> <span class="o">+</span> <span class="n">warmup_factor</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target_lr</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_lr</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">WarmupSchedule</span><span class="p">(</span><span class="n">initial_lr</span><span class="p">,</span> <span class="n">target_lr</span><span class="p">,</span> <span class="n">warmup_steps</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Learning rate schedules defined&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><hr />
<h2>Section 6: Module Project - Deep Learning Trading System</h2>
<p>Build a complete deep learning trading system that combines multiple architectures.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Complete Deep Learning Trading System</span>
<span class="k">class</span> <span class="nc">DeepLearningTradingSystem</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Production-ready deep learning trading system.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sequence_length</span><span class="o">=</span><span class="mi">20</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sequence_length</span> <span class="o">=</span> <span class="n">sequence_length</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">models</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">histories</span> <span class="o">=</span> <span class="p">{}</span>
        
    <span class="k">def</span> <span class="nf">create_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create comprehensive feature set.&quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        
        <span class="c1"># Returns</span>
        <span class="k">for</span> <span class="n">period</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">]:</span>
            <span class="n">data</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;return_</span><span class="si">{</span><span class="n">period</span><span class="si">}</span><span class="s1">d&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">(</span><span class="n">period</span><span class="p">)</span>
        
        <span class="c1"># Volatility</span>
        <span class="k">for</span> <span class="n">period</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">]:</span>
            <span class="n">data</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;volatility_</span><span class="si">{</span><span class="n">period</span><span class="si">}</span><span class="s1">d&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;return_1d&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">period</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
        
        <span class="c1"># Technical indicators</span>
        <span class="k">for</span> <span class="n">period</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">50</span><span class="p">]:</span>
            <span class="n">sma</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">period</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="n">data</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;price_to_sma_</span><span class="si">{</span><span class="n">period</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">sma</span>
        
        <span class="c1"># RSI</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span>
        <span class="n">gain</span> <span class="o">=</span> <span class="p">(</span><span class="n">delta</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">delta</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">14</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">delta</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">delta</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">14</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;rsi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">-</span> <span class="p">(</span><span class="mi">100</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">gain</span> <span class="o">/</span> <span class="p">(</span><span class="n">loss</span> <span class="o">+</span> <span class="mf">1e-10</span><span class="p">)))</span>
        
        <span class="c1"># MACD</span>
        <span class="n">exp12</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">ewm</span><span class="p">(</span><span class="n">span</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">exp26</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">ewm</span><span class="p">(</span><span class="n">span</span><span class="o">=</span><span class="mi">26</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;macd&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">exp12</span> <span class="o">-</span> <span class="n">exp26</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;macd_signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;macd&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">ewm</span><span class="p">(</span><span class="n">span</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        
        <span class="c1"># Volume</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;volume_ratio&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;volume&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;volume&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        
        <span class="c1"># Target</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">data</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">build_ensemble</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_features</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Build ensemble of different architectures.&quot;&quot;&quot;</span>
        
        <span class="c1"># 1. Feedforward Network</span>
        <span class="n">ff_model</span> <span class="o">=</span> <span class="n">Sequential</span><span class="p">([</span>
            <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="n">input_dim</span><span class="o">=</span><span class="n">n_features</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">,</span>
                         <span class="n">kernel_regularizer</span><span class="o">=</span><span class="n">keras</span><span class="o">.</span><span class="n">regularizers</span><span class="o">.</span><span class="n">l2</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)),</span>
            <span class="n">layers</span><span class="o">.</span><span class="n">BatchNormalization</span><span class="p">(),</span>
            <span class="n">layers</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.3</span><span class="p">),</span>
            <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">),</span>
            <span class="n">layers</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.2</span><span class="p">),</span>
            <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">),</span>
            <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;sigmoid&#39;</span><span class="p">)</span>
        <span class="p">])</span>
        <span class="n">ff_model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="n">Adam</span><span class="p">(</span><span class="mf">0.001</span><span class="p">),</span> 
                         <span class="n">loss</span><span class="o">=</span><span class="s1">&#39;binary_crossentropy&#39;</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="s1">&#39;feedforward&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ff_model</span>
        
        <span class="c1"># 2. ResNet-style</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="s1">&#39;resnet&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">build_resnet_finance</span><span class="p">(</span><span class="n">n_features</span><span class="p">)</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Built ensemble with </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">)</span><span class="si">}</span><span class="s2"> models&quot;</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">build_lstm_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_features</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Build LSTM model for sequence data.&quot;&quot;&quot;</span>
        <span class="n">lstm_model</span> <span class="o">=</span> <span class="n">Sequential</span><span class="p">([</span>
            <span class="n">layers</span><span class="o">.</span><span class="n">LSTM</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="n">return_sequences</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="n">input_shape</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sequence_length</span><span class="p">,</span> <span class="n">n_features</span><span class="p">)),</span>
            <span class="n">layers</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.2</span><span class="p">),</span>
            <span class="n">layers</span><span class="o">.</span><span class="n">LSTM</span><span class="p">(</span><span class="mi">32</span><span class="p">),</span>
            <span class="n">layers</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.2</span><span class="p">),</span>
            <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">),</span>
            <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;sigmoid&#39;</span><span class="p">)</span>
        <span class="p">])</span>
        <span class="n">lstm_model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="n">Adam</span><span class="p">(</span><span class="mf">0.001</span><span class="p">),</span>
                           <span class="n">loss</span><span class="o">=</span><span class="s1">&#39;binary_crossentropy&#39;</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="s1">&#39;lstm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lstm_model</span>
        
    <span class="k">def</span> <span class="nf">train_models</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">X_val</span><span class="p">,</span> <span class="n">y_val</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">50</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Train all models in the ensemble.&quot;&quot;&quot;</span>
        <span class="n">callbacks</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">EarlyStopping</span><span class="p">(</span><span class="n">monitor</span><span class="o">=</span><span class="s1">&#39;val_loss&#39;</span><span class="p">,</span> <span class="n">patience</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">restore_best_weights</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="p">]</span>
        
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">model</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Training </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
            <span class="n">history</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
                <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span>
                <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">X_val</span><span class="p">,</span> <span class="n">y_val</span><span class="p">),</span>
                <span class="n">epochs</span><span class="o">=</span><span class="n">epochs</span><span class="p">,</span>
                <span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span>
                <span class="n">callbacks</span><span class="o">=</span><span class="n">callbacks</span><span class="p">,</span>
                <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">histories</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">history</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Val accuracy: </span><span class="si">{</span><span class="n">history</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;val_accuracy&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">predict_ensemble</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Make ensemble predictions.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">weights</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">weights</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="mi">1</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">}</span>
        
        <span class="n">predictions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">),</span> <span class="mi">1</span><span class="p">))</span>
        
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">model</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">predictions</span> <span class="o">+=</span> <span class="n">weights</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">*</span> <span class="n">pred</span>
        
        <span class="k">return</span> <span class="n">predictions</span>
    
    <span class="k">def</span> <span class="nf">generate_signals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generate trading signals from ensemble.&quot;&quot;&quot;</span>
        <span class="n">probs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict_ensemble</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="n">signals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">probs</span> <span class="o">&gt;=</span> <span class="n">threshold</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">signals</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">probs</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">backtest</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">signals</span><span class="p">,</span> <span class="n">returns</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Simple backtest of signals.&quot;&quot;&quot;</span>
        <span class="n">strategy_returns</span> <span class="o">=</span> <span class="n">signals</span> <span class="o">*</span> <span class="n">returns</span>
        
        <span class="n">cumulative</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">strategy_returns</span><span class="p">)</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span>
        
        <span class="c1"># Metrics</span>
        <span class="n">total_return</span> <span class="o">=</span> <span class="n">cumulative</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">sharpe</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span> <span class="o">*</span> <span class="n">strategy_returns</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">/</span> <span class="p">(</span><span class="n">strategy_returns</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">+</span> <span class="mf">1e-8</span><span class="p">)</span>
        <span class="n">max_dd</span> <span class="o">=</span> <span class="p">(</span><span class="n">cumulative</span> <span class="o">/</span> <span class="n">cumulative</span><span class="o">.</span><span class="n">cummax</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="n">win_rate</span> <span class="o">=</span> <span class="p">(</span><span class="n">strategy_returns</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;total_return&#39;</span><span class="p">:</span> <span class="n">total_return</span><span class="p">,</span>
            <span class="s1">&#39;sharpe_ratio&#39;</span><span class="p">:</span> <span class="n">sharpe</span><span class="p">,</span>
            <span class="s1">&#39;max_drawdown&#39;</span><span class="p">:</span> <span class="n">max_dd</span><span class="p">,</span>
            <span class="s1">&#39;win_rate&#39;</span><span class="p">:</span> <span class="n">win_rate</span><span class="p">,</span>
            <span class="s1">&#39;cumulative&#39;</span><span class="p">:</span> <span class="n">cumulative</span>
        <span class="p">}</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;DeepLearningTradingSystem class defined&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Run the complete system</span>
<span class="n">system</span> <span class="o">=</span> <span class="n">DeepLearningTradingSystem</span><span class="p">(</span><span class="n">sequence_length</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>

<span class="c1"># Create features</span>
<span class="n">df_system</span> <span class="o">=</span> <span class="n">system</span><span class="o">.</span><span class="n">create_features</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

<span class="c1"># Select features</span>
<span class="n">system_features</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;return_1d&#39;</span><span class="p">,</span> <span class="s1">&#39;return_5d&#39;</span><span class="p">,</span> <span class="s1">&#39;return_10d&#39;</span><span class="p">,</span> <span class="s1">&#39;return_20d&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;volatility_5d&#39;</span><span class="p">,</span> <span class="s1">&#39;volatility_10d&#39;</span><span class="p">,</span> <span class="s1">&#39;volatility_20d&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;price_to_sma_5&#39;</span><span class="p">,</span> <span class="s1">&#39;price_to_sma_10&#39;</span><span class="p">,</span> <span class="s1">&#39;price_to_sma_20&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;rsi&#39;</span><span class="p">,</span> <span class="s1">&#39;macd&#39;</span><span class="p">,</span> <span class="s1">&#39;volume_ratio&#39;</span><span class="p">]</span>

<span class="n">X_sys</span> <span class="o">=</span> <span class="n">df_system</span><span class="p">[</span><span class="n">system_features</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
<span class="n">y_sys</span> <span class="o">=</span> <span class="n">df_system</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
<span class="n">returns</span> <span class="o">=</span> <span class="n">df_system</span><span class="p">[</span><span class="s1">&#39;return_1d&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

<span class="c1"># Time-based splits</span>
<span class="n">split_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">X_sys</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.8</span><span class="p">)</span>
<span class="n">X_train_sys</span><span class="p">,</span> <span class="n">X_test_sys</span> <span class="o">=</span> <span class="n">X_sys</span><span class="p">[:</span><span class="n">split_idx</span><span class="p">],</span> <span class="n">X_sys</span><span class="p">[</span><span class="n">split_idx</span><span class="p">:]</span>
<span class="n">y_train_sys</span><span class="p">,</span> <span class="n">y_test_sys</span> <span class="o">=</span> <span class="n">y_sys</span><span class="p">[:</span><span class="n">split_idx</span><span class="p">],</span> <span class="n">y_sys</span><span class="p">[</span><span class="n">split_idx</span><span class="p">:]</span>
<span class="n">returns_test</span> <span class="o">=</span> <span class="n">returns</span><span class="p">[</span><span class="n">split_idx</span><span class="p">:]</span>

<span class="n">val_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">X_train_sys</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.8</span><span class="p">)</span>
<span class="n">X_train_s</span><span class="p">,</span> <span class="n">X_val_s</span> <span class="o">=</span> <span class="n">X_train_sys</span><span class="p">[:</span><span class="n">val_idx</span><span class="p">],</span> <span class="n">X_train_sys</span><span class="p">[</span><span class="n">val_idx</span><span class="p">:]</span>
<span class="n">y_train_s</span><span class="p">,</span> <span class="n">y_val_s</span> <span class="o">=</span> <span class="n">y_train_sys</span><span class="p">[:</span><span class="n">val_idx</span><span class="p">],</span> <span class="n">y_train_sys</span><span class="p">[</span><span class="n">val_idx</span><span class="p">:]</span>

<span class="c1"># Scale features</span>
<span class="n">X_train_scaled_s</span> <span class="o">=</span> <span class="n">system</span><span class="o">.</span><span class="n">feature_scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_train_s</span><span class="p">)</span>
<span class="n">X_val_scaled_s</span> <span class="o">=</span> <span class="n">system</span><span class="o">.</span><span class="n">feature_scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_val_s</span><span class="p">)</span>
<span class="n">X_test_scaled_s</span> <span class="o">=</span> <span class="n">system</span><span class="o">.</span><span class="n">feature_scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_test_sys</span><span class="p">)</span>

<span class="c1"># Build and train ensemble</span>
<span class="n">system</span><span class="o">.</span><span class="n">build_ensemble</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">system_features</span><span class="p">))</span>
<span class="n">system</span><span class="o">.</span><span class="n">train_models</span><span class="p">(</span><span class="n">X_train_scaled_s</span><span class="p">,</span> <span class="n">y_train_s</span><span class="p">,</span> <span class="n">X_val_scaled_s</span><span class="p">,</span> <span class="n">y_val_s</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Generate signals and backtest</span>
<span class="n">signals</span><span class="p">,</span> <span class="n">probs</span> <span class="o">=</span> <span class="n">system</span><span class="o">.</span><span class="n">generate_signals</span><span class="p">(</span><span class="n">X_test_scaled_s</span><span class="p">)</span>

<span class="c1"># Convert to pandas for backtest</span>
<span class="n">returns_series</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">returns_test</span><span class="p">,</span> 
                           <span class="n">index</span><span class="o">=</span><span class="n">df_system</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">split_idx</span><span class="p">:])</span>
<span class="n">signals_series</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">signals</span><span class="p">,</span> 
                           <span class="n">index</span><span class="o">=</span><span class="n">df_system</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">split_idx</span><span class="p">:])</span>

<span class="c1"># Run backtest</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">system</span><span class="o">.</span><span class="n">backtest</span><span class="p">(</span><span class="n">signals_series</span><span class="p">,</span> <span class="n">returns_series</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Deep Learning Trading System Results&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total Return: </span><span class="si">{</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;total_return&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sharpe Ratio: </span><span class="si">{</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;sharpe_ratio&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Max Drawdown: </span><span class="si">{</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;max_drawdown&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Win Rate: </span><span class="si">{</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;win_rate&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Visualize results</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

<span class="c1"># Cumulative returns</span>
<span class="n">buy_hold</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">returns_series</span><span class="p">)</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;cumulative&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;cumulative&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> 
                <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Strategy&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">buy_hold</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">buy_hold</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> 
                <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Buy &amp; Hold&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Cumulative Return&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Strategy vs Buy &amp; Hold&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="c1"># Prediction probabilities distribution</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">probs</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Threshold&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Prediction Probability&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Frequency&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Ensemble Prediction Distribution&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="c1"># Training history comparison</span>
<span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">history</span> <span class="ow">in</span> <span class="n">system</span><span class="o">.</span><span class="n">histories</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">history</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;val_accuracy&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Epoch&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Validation Accuracy&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Model Training Comparison&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="c1"># Signal distribution over time</span>
<span class="n">signal_ma</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">signals</span><span class="p">)</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">signal_ma</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Signal (20-day MA)&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Trading Signal Trend&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
<div class="md-cell"><hr />
<h2>Exercises</h2>
<p>Complete the following exercises to practice deep learning for finance.</p></div>
<div class="md-cell exercise-header"><h3>Exercise 11.1: Build Custom Neural Network (Guided)</h3>
<p>Complete the neural network architecture with proper layers.</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 11.1: Build Custom Neural Network</span>
<span class="k">def</span> <span class="nf">build_custom_classifier</span><span class="p">(</span><span class="n">input_dim</span><span class="p">,</span> <span class="n">hidden_units</span><span class="o">=</span><span class="p">[</span><span class="mi">128</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">32</span><span class="p">]):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Build a custom neural network classifier.</span>
<span class="sd">    </span>
<span class="sd">    Requirements:</span>
<span class="sd">    - Add Dense layers with ReLU activation</span>
<span class="sd">    - Add BatchNormalization after each Dense layer</span>
<span class="sd">    - Add Dropout(0.3) for regularization</span>
<span class="sd">    - Output layer with sigmoid activation</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">Sequential</span><span class="p">()</span>
    
    <span class="c1"># TODO: Add first Dense layer with input_dim</span>
    <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">______</span><span class="p">(</span><span class="n">hidden_units</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">input_dim</span><span class="o">=</span><span class="n">______</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;______&#39;</span><span class="p">))</span>
    <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">______</span><span class="p">())</span>
    <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">______</span><span class="p">(</span><span class="mf">0.3</span><span class="p">))</span>
    
    <span class="c1"># TODO: Add remaining hidden layers</span>
    <span class="k">for</span> <span class="n">units</span> <span class="ow">in</span> <span class="n">hidden_units</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
        <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">______</span><span class="p">(</span><span class="n">______</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;______&#39;</span><span class="p">))</span>
        <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">______</span><span class="p">())</span>
        <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">______</span><span class="p">(</span><span class="mf">0.3</span><span class="p">))</span>
    
    <span class="c1"># TODO: Add output layer</span>
    <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">______</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;______&#39;</span><span class="p">))</span>
    
    <span class="c1"># Compile model</span>
    <span class="n">model</span><span class="o">.</span><span class="n">______</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="n">Adam</span><span class="p">(</span><span class="mf">0.001</span><span class="p">),</span> <span class="n">loss</span><span class="o">=</span><span class="s1">&#39;______&#39;</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">])</span>
    
    <span class="k">return</span> <span class="n">model</span>

<span class="c1"># Test</span>
<span class="c1"># custom_model = build_custom_classifier(input_dim=14)</span>
<span class="c1"># custom_model.summary()</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 11.1</summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">build_custom_classifier</span><span class="p">(</span><span class="n">input_dim</span><span class="p">,</span> <span class="n">hidden_units</span><span class="o">=</span><span class="p">[</span><span class="mi">128</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">32</span><span class="p">]):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">Sequential</span><span class="p">()</span>

    <span class="c1"># Add first Dense layer with input_dim</span>
    <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">hidden_units</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">input_dim</span><span class="o">=</span><span class="n">input_dim</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">))</span>
    <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">BatchNormalization</span><span class="p">())</span>
    <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.3</span><span class="p">))</span>

    <span class="c1"># Add remaining hidden layers</span>
    <span class="k">for</span> <span class="n">units</span> <span class="ow">in</span> <span class="n">hidden_units</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
        <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">units</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">))</span>
        <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">BatchNormalization</span><span class="p">())</span>
        <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.3</span><span class="p">))</span>

    <span class="c1"># Add output layer</span>
    <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;sigmoid&#39;</span><span class="p">))</span>

    <span class="c1"># Compile model</span>
    <span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="n">Adam</span><span class="p">(</span><span class="mf">0.001</span><span class="p">),</span> <span class="n">loss</span><span class="o">=</span><span class="s1">&#39;binary_crossentropy&#39;</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">model</span>
</code></pre></div>


</details></div>
<div class="md-cell exercise-header"><h3>Exercise 11.2: Implement LSTM Sequence Model (Guided)</h3>
<p>Build an LSTM model for sequence prediction.</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 11.2: Implement LSTM Sequence Model</span>
<span class="k">def</span> <span class="nf">build_lstm_classifier</span><span class="p">(</span><span class="n">sequence_length</span><span class="p">,</span> <span class="n">n_features</span><span class="p">,</span> <span class="n">lstm_units</span><span class="o">=</span><span class="p">[</span><span class="mi">64</span><span class="p">,</span> <span class="mi">32</span><span class="p">]):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Build an LSTM model for sequence classification.</span>
<span class="sd">    </span>
<span class="sd">    Requirements:</span>
<span class="sd">    - First LSTM layer should return sequences</span>
<span class="sd">    - Add Dropout after each LSTM layer</span>
<span class="sd">    - Final Dense layer with sigmoid</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">Sequential</span><span class="p">()</span>
    
    <span class="c1"># TODO: Add first LSTM layer (return sequences for stacking)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">______</span><span class="p">(</span>
        <span class="n">lstm_units</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="n">return_sequences</span><span class="o">=</span><span class="n">______</span><span class="p">,</span>
        <span class="n">input_shape</span><span class="o">=</span><span class="p">(</span><span class="n">______</span><span class="p">,</span> <span class="n">______</span><span class="p">)</span>
    <span class="p">))</span>
    <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.2</span><span class="p">))</span>
    
    <span class="c1"># TODO: Add second LSTM layer (no return sequences)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">______</span><span class="p">(</span><span class="n">lstm_units</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">return_sequences</span><span class="o">=</span><span class="n">______</span><span class="p">))</span>
    <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.2</span><span class="p">))</span>
    
    <span class="c1"># TODO: Add Dense layers and output</span>
    <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">______</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;______&#39;</span><span class="p">))</span>
    <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">______</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;______&#39;</span><span class="p">))</span>
    
    <span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="n">Adam</span><span class="p">(</span><span class="mf">0.001</span><span class="p">),</span> <span class="n">loss</span><span class="o">=</span><span class="s1">&#39;______&#39;</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">])</span>
    
    <span class="k">return</span> <span class="n">model</span>

<span class="c1"># Test</span>
<span class="c1"># lstm_classifier = build_lstm_classifier(20, 5)</span>
<span class="c1"># lstm_classifier.summary()</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 11.2</summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">build_lstm_classifier</span><span class="p">(</span><span class="n">sequence_length</span><span class="p">,</span> <span class="n">n_features</span><span class="p">,</span> <span class="n">lstm_units</span><span class="o">=</span><span class="p">[</span><span class="mi">64</span><span class="p">,</span> <span class="mi">32</span><span class="p">]):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">Sequential</span><span class="p">()</span>

    <span class="c1"># Add first LSTM layer (return sequences for stacking)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">LSTM</span><span class="p">(</span>
        <span class="n">lstm_units</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="n">return_sequences</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">input_shape</span><span class="o">=</span><span class="p">(</span><span class="n">sequence_length</span><span class="p">,</span> <span class="n">n_features</span><span class="p">)</span>
    <span class="p">))</span>
    <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.2</span><span class="p">))</span>

    <span class="c1"># Add second LSTM layer (no return sequences)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">LSTM</span><span class="p">(</span><span class="n">lstm_units</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">return_sequences</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
    <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.2</span><span class="p">))</span>

    <span class="c1"># Add Dense layers and output</span>
    <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">))</span>
    <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;sigmoid&#39;</span><span class="p">))</span>

    <span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="n">Adam</span><span class="p">(</span><span class="mf">0.001</span><span class="p">),</span> <span class="n">loss</span><span class="o">=</span><span class="s1">&#39;binary_crossentropy&#39;</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">model</span>
</code></pre></div>


</details></div>
<div class="md-cell exercise-header"><h3>Exercise 11.3: Create Training Pipeline (Guided)</h3>
<p>Implement a training pipeline with proper callbacks.</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 11.3: Create Training Pipeline</span>
<span class="k">def</span> <span class="nf">train_with_callbacks</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">X_val</span><span class="p">,</span> <span class="n">y_val</span><span class="p">,</span>
                         <span class="n">epochs</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Train model with proper callbacks.</span>
<span class="sd">    </span>
<span class="sd">    Requirements:</span>
<span class="sd">    - EarlyStopping with patience=10</span>
<span class="sd">    - ReduceLROnPlateau with factor=0.5</span>
<span class="sd">    - Return training history</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO: Create callbacks list</span>
    <span class="n">callbacks</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">______</span><span class="p">(</span>
            <span class="n">monitor</span><span class="o">=</span><span class="s1">&#39;______&#39;</span><span class="p">,</span>
            <span class="n">patience</span><span class="o">=</span><span class="n">______</span><span class="p">,</span>
            <span class="n">restore_best_weights</span><span class="o">=</span><span class="n">______</span>
        <span class="p">),</span>
        <span class="n">______</span><span class="p">(</span>
            <span class="n">monitor</span><span class="o">=</span><span class="s1">&#39;______&#39;</span><span class="p">,</span>
            <span class="n">factor</span><span class="o">=</span><span class="n">______</span><span class="p">,</span>
            <span class="n">patience</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
            <span class="n">min_lr</span><span class="o">=</span><span class="mf">1e-6</span>
        <span class="p">)</span>
    <span class="p">]</span>
    
    <span class="c1"># TODO: Train model</span>
    <span class="n">history</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">______</span><span class="p">(</span>
        <span class="n">______</span><span class="p">,</span> <span class="n">______</span><span class="p">,</span>
        <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">______</span><span class="p">,</span> <span class="n">______</span><span class="p">),</span>
        <span class="n">epochs</span><span class="o">=</span><span class="n">______</span><span class="p">,</span>
        <span class="n">batch_size</span><span class="o">=</span><span class="n">______</span><span class="p">,</span>
        <span class="n">callbacks</span><span class="o">=</span><span class="n">______</span><span class="p">,</span>
        <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span>
    <span class="p">)</span>
    
    <span class="k">return</span> <span class="n">history</span>

<span class="c1"># Test</span>
<span class="c1"># history = train_with_callbacks(custom_model, X_train_scaled, y_train_nn,</span>
<span class="c1">#                                X_val_scaled, y_val, epochs=30)</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 11.3</summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">train_with_callbacks</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">X_val</span><span class="p">,</span> <span class="n">y_val</span><span class="p">,</span>
                         <span class="n">epochs</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span><span class="p">):</span>
    <span class="c1"># Create callbacks list</span>
    <span class="n">callbacks</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">EarlyStopping</span><span class="p">(</span>
            <span class="n">monitor</span><span class="o">=</span><span class="s1">&#39;val_loss&#39;</span><span class="p">,</span>
            <span class="n">patience</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
            <span class="n">restore_best_weights</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">),</span>
        <span class="n">ReduceLROnPlateau</span><span class="p">(</span>
            <span class="n">monitor</span><span class="o">=</span><span class="s1">&#39;val_loss&#39;</span><span class="p">,</span>
            <span class="n">factor</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
            <span class="n">patience</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
            <span class="n">min_lr</span><span class="o">=</span><span class="mf">1e-6</span>
        <span class="p">)</span>
    <span class="p">]</span>

    <span class="c1"># Train model</span>
    <span class="n">history</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
        <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span>
        <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">X_val</span><span class="p">,</span> <span class="n">y_val</span><span class="p">),</span>
        <span class="n">epochs</span><span class="o">=</span><span class="n">epochs</span><span class="p">,</span>
        <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
        <span class="n">callbacks</span><span class="o">=</span><span class="n">callbacks</span><span class="p">,</span>
        <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">history</span>
</code></pre></div>


</details></div>
<div class="md-cell exercise-header"><h3>Exercise 11.4: Build a Bidirectional LSTM (Open-ended)</h3>
<p>Create a Bidirectional LSTM model that can learn patterns from both past and future context in the sequence.</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 11.4: Build a Bidirectional LSTM</span>
<span class="c1"># TODO: Create a function that builds a Bidirectional LSTM model</span>
<span class="c1"># The model should:</span>
<span class="c1"># - Use layers.Bidirectional wrapper around LSTM</span>
<span class="c1"># - Include multiple Bidirectional LSTM layers</span>
<span class="c1"># - Have appropriate dropout and dense layers</span>
<span class="c1"># - Output binary classification prediction</span>

<span class="c1"># Your code here</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 11.4</summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">build_bidirectional_lstm</span><span class="p">(</span><span class="n">sequence_length</span><span class="p">,</span> <span class="n">n_features</span><span class="p">,</span> <span class="n">lstm_units</span><span class="o">=</span><span class="p">[</span><span class="mi">64</span><span class="p">,</span> <span class="mi">32</span><span class="p">]):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">Sequential</span><span class="p">([</span>
        <span class="n">layers</span><span class="o">.</span><span class="n">Bidirectional</span><span class="p">(</span>
            <span class="n">layers</span><span class="o">.</span><span class="n">LSTM</span><span class="p">(</span><span class="n">lstm_units</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">return_sequences</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
            <span class="n">input_shape</span><span class="o">=</span><span class="p">(</span><span class="n">sequence_length</span><span class="p">,</span> <span class="n">n_features</span><span class="p">)</span>
        <span class="p">),</span>
        <span class="n">layers</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.2</span><span class="p">),</span>
        <span class="n">layers</span><span class="o">.</span><span class="n">Bidirectional</span><span class="p">(</span>
            <span class="n">layers</span><span class="o">.</span><span class="n">LSTM</span><span class="p">(</span><span class="n">lstm_units</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">return_sequences</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="p">),</span>
        <span class="n">layers</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.2</span><span class="p">),</span>
        <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">),</span>
        <span class="n">layers</span><span class="o">.</span><span class="n">BatchNormalization</span><span class="p">(),</span>
        <span class="n">layers</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.2</span><span class="p">),</span>
        <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">),</span>
        <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;sigmoid&#39;</span><span class="p">)</span>
    <span class="p">])</span>

    <span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
        <span class="n">optimizer</span><span class="o">=</span><span class="n">Adam</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.001</span><span class="p">),</span>
        <span class="n">loss</span><span class="o">=</span><span class="s1">&#39;binary_crossentropy&#39;</span><span class="p">,</span>
        <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">model</span>

<span class="c1"># Build and test</span>
<span class="n">bilstm</span> <span class="o">=</span> <span class="n">build_bidirectional_lstm</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<span class="n">bilstm</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</code></pre></div>


</details></div>
<div class="md-cell exercise-header"><h3>Exercise 11.5: Implement Attention Mechanism (Open-ended)</h3>
<p>Add a custom attention layer to an LSTM model to focus on important time steps.</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 11.5: Implement Attention Mechanism</span>
<span class="c1"># TODO: Create an LSTM model with attention mechanism</span>
<span class="c1"># The model should:</span>
<span class="c1"># - Use LSTM with return_sequences=True</span>
<span class="c1"># - Apply attention to weight different time steps</span>
<span class="c1"># - Combine attended output for final prediction</span>
<span class="c1"># - Can use the AttentionLayer class defined earlier</span>

<span class="c1"># Your code here</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 11.5</summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">build_lstm_attention</span><span class="p">(</span><span class="n">sequence_length</span><span class="p">,</span> <span class="n">n_features</span><span class="p">,</span> <span class="n">lstm_units</span><span class="o">=</span><span class="mi">64</span><span class="p">):</span>
    <span class="n">inputs</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">sequence_length</span><span class="p">,</span> <span class="n">n_features</span><span class="p">))</span>

    <span class="c1"># LSTM layer with sequence output</span>
    <span class="n">lstm_out</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">LSTM</span><span class="p">(</span><span class="n">lstm_units</span><span class="p">,</span> <span class="n">return_sequences</span><span class="o">=</span><span class="kc">True</span><span class="p">)(</span><span class="n">inputs</span><span class="p">)</span>
    <span class="n">lstm_out</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.2</span><span class="p">)(</span><span class="n">lstm_out</span><span class="p">)</span>

    <span class="c1"># Apply attention</span>
    <span class="n">attention_out</span> <span class="o">=</span> <span class="n">AttentionLayer</span><span class="p">()(</span><span class="n">lstm_out</span><span class="p">)</span>

    <span class="c1"># Dense layers</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">)(</span><span class="n">attention_out</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">BatchNormalization</span><span class="p">()(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.2</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>

    <span class="c1"># Output</span>
    <span class="n">outputs</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;sigmoid&#39;</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>

    <span class="n">model</span> <span class="o">=</span> <span class="n">Model</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
        <span class="n">optimizer</span><span class="o">=</span><span class="n">Adam</span><span class="p">(</span><span class="mf">0.001</span><span class="p">),</span>
        <span class="n">loss</span><span class="o">=</span><span class="s1">&#39;binary_crossentropy&#39;</span><span class="p">,</span>
        <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">model</span>

<span class="c1"># Build and test</span>
<span class="n">attention_model</span> <span class="o">=</span> <span class="n">build_lstm_attention</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<span class="n">attention_model</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</code></pre></div>


</details></div>
<div class="md-cell exercise-header"><h3>Exercise 11.6: Create Model Ensemble with Weighted Voting (Open-ended)</h3>
<p>Build an ensemble of different deep learning architectures with learned weights.</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 11.6: Create Model Ensemble with Weighted Voting</span>
<span class="c1"># TODO: Create an ensemble system that:</span>
<span class="c1"># - Trains multiple different architectures (FF, LSTM, CNN-1D)</span>
<span class="c1"># - Learns optimal weights for each model based on validation performance</span>
<span class="c1"># - Combines predictions using weighted average</span>
<span class="c1"># - Includes method to evaluate ensemble performance</span>

<span class="c1"># Your code here</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 11.6</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">WeightedDeepEnsemble</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">models</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">build_models</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_dim</span><span class="p">,</span> <span class="n">sequence_length</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">n_features</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># Feedforward</span>
        <span class="n">ff</span> <span class="o">=</span> <span class="n">Sequential</span><span class="p">([</span>
            <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="n">input_dim</span><span class="o">=</span><span class="n">input_dim</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">),</span>
            <span class="n">layers</span><span class="o">.</span><span class="n">BatchNormalization</span><span class="p">(),</span>
            <span class="n">layers</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.3</span><span class="p">),</span>
            <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">),</span>
            <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;sigmoid&#39;</span><span class="p">)</span>
        <span class="p">])</span>
        <span class="n">ff</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="n">Adam</span><span class="p">(</span><span class="mf">0.001</span><span class="p">),</span> <span class="n">loss</span><span class="o">=</span><span class="s1">&#39;binary_crossentropy&#39;</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="s1">&#39;feedforward&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ff</span>

        <span class="c1"># CNN-1D (if sequence data)</span>
        <span class="k">if</span> <span class="n">sequence_length</span> <span class="ow">and</span> <span class="n">n_features</span><span class="p">:</span>
            <span class="n">cnn</span> <span class="o">=</span> <span class="n">Sequential</span><span class="p">([</span>
                <span class="n">layers</span><span class="o">.</span><span class="n">Conv1D</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">,</span> 
                              <span class="n">input_shape</span><span class="o">=</span><span class="p">(</span><span class="n">sequence_length</span><span class="p">,</span> <span class="n">n_features</span><span class="p">)),</span>
                <span class="n">layers</span><span class="o">.</span><span class="n">MaxPooling1D</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>
                <span class="n">layers</span><span class="o">.</span><span class="n">Conv1D</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">),</span>
                <span class="n">layers</span><span class="o">.</span><span class="n">GlobalMaxPooling1D</span><span class="p">(),</span>
                <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">),</span>
                <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;sigmoid&#39;</span><span class="p">)</span>
            <span class="p">])</span>
            <span class="n">cnn</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="n">Adam</span><span class="p">(</span><span class="mf">0.001</span><span class="p">),</span> <span class="n">loss</span><span class="o">=</span><span class="s1">&#39;binary_crossentropy&#39;</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="s1">&#39;cnn&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cnn</span>

    <span class="k">def</span> <span class="nf">train_and_weight</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">X_val</span><span class="p">,</span> <span class="n">y_val</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">30</span><span class="p">):</span>
        <span class="n">val_accuracies</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">model</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">history</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
                <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span>
                <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">X_val</span><span class="p">,</span> <span class="n">y_val</span><span class="p">),</span>
                <span class="n">epochs</span><span class="o">=</span><span class="n">epochs</span><span class="p">,</span>
                <span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span>
                <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">EarlyStopping</span><span class="p">(</span><span class="n">patience</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">restore_best_weights</span><span class="o">=</span><span class="kc">True</span><span class="p">)],</span>
                <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span>
            <span class="p">)</span>
            <span class="n">val_accuracies</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">history</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;val_accuracy&#39;</span><span class="p">])</span>

        <span class="c1"># Calculate weights based on validation accuracy</span>
        <span class="n">total</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">val_accuracies</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">acc</span><span class="o">/</span><span class="n">total</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">acc</span> <span class="ow">in</span> <span class="n">val_accuracies</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Learned weights: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="n">predictions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">),</span> <span class="mi">1</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">model</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">predictions</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">predictions</span>

<span class="c1"># Usage</span>
<span class="n">ensemble</span> <span class="o">=</span> <span class="n">WeightedDeepEnsemble</span><span class="p">()</span>
<span class="n">ensemble</span><span class="o">.</span><span class="n">build_models</span><span class="p">(</span><span class="n">input_dim</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell key-takeaways"><hr />
<h2>Summary</h2>
<p>In this module, you learned:</p>
<ol>
<li>
<p><strong>Neural Network Fundamentals</strong>: Building feedforward networks with proper regularization for financial data</p>
</li>
<li>
<p><strong>LSTM Networks</strong>: Implementing sequence models that capture temporal dependencies in price data</p>
</li>
<li>
<p><strong>Transformers and Attention</strong>: Using attention mechanisms to identify important time steps</p>
</li>
<li>
<p><strong>Architecture Design</strong>: Creating multi-input models and residual connections</p>
</li>
<li>
<p><strong>Regularization Techniques</strong>: Preventing overfitting with dropout, batch normalization, and L1/L2 regularization</p>
</li>
<li>
<p><strong>Production Systems</strong>: Building complete trading systems with deep learning ensembles</p>
</li>
</ol>
<h2>Key Takeaways</h2>
<ul>
<li>Financial data requires heavy regularization due to low signal-to-noise ratio</li>
<li>LSTM and Transformers capture different types of temporal patterns</li>
<li>Ensemble methods combine strengths of multiple architectures</li>
<li>Proper data preprocessing (scaling, sequencing) is critical for deep learning</li>
<li>Always use validation sets and early stopping to prevent overfitting</li>
</ul>
<h2>Next Steps</h2>
<p>In Module 12, you'll learn about backtesting ML strategies properly, including walk-forward optimization and avoiding common pitfalls like look-ahead bias.</p></div>
        <div class="nav-buttons">
            <button class="nav-btn prev-btn disabled" type="button">
                <span class="nav-btn-label">‚Üê Previous</span>
                <span class="nav-btn-name"></span>
            </button>
            <button class="nav-btn next-btn disabled" type="button">
                <span class="nav-btn-label">Next ‚Üí</span>
                <span class="nav-btn-name"></span>
            </button>
        </div>
        </div>
<div class="module-section" data-idx="12"><div class="md-cell module-header"><h1>Module 12: Backtesting ML Strategies</h1>
<h2>Overview</h2>
<p>Backtesting ML trading strategies requires special care to avoid common pitfalls like look-ahead bias and overfitting. This module covers proper backtesting methodology, walk-forward optimization, and realistic performance evaluation.</p>
<h2>Learning Objectives</h2>
<p>By the end of this module, you will be able to:
- Implement proper walk-forward validation for ML strategies
- Identify and avoid common backtesting pitfalls
- Build realistic backtesting frameworks with transaction costs
- Apply robust performance evaluation techniques</p>
<h2>Prerequisites</h2>
<ul>
<li>Module 7: Model Evaluation</li>
<li>Module 11: Deep Learning for Finance</li>
<li>Understanding of time series cross-validation</li>
</ul>
<h2>Estimated Time: 3 hours</h2></div>
<div class="md-cell"><hr />
<h2>Section 1: Walk-Forward Optimization</h2>
<p>Walk-forward optimization is the gold standard for backtesting ML strategies, simulating real-world conditions where models are periodically retrained.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">RandomForestClassifier</span><span class="p">,</span> <span class="n">GradientBoostingClassifier</span>
<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LogisticRegression</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">StandardScaler</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">accuracy_score</span><span class="p">,</span> <span class="n">precision_score</span><span class="p">,</span> <span class="n">recall_score</span><span class="p">,</span> <span class="n">f1_score</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>

<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Libraries loaded for backtesting&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Generate realistic financial data</span>
<span class="k">def</span> <span class="nf">generate_backtest_data</span><span class="p">(</span><span class="n">n_samples</span><span class="o">=</span><span class="mi">3000</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Generate synthetic data with regime changes.&quot;&quot;&quot;</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
    
    <span class="n">dates</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="s1">&#39;2015-01-01&#39;</span><span class="p">,</span> <span class="n">periods</span><span class="o">=</span><span class="n">n_samples</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;D&#39;</span><span class="p">)</span>
    
    <span class="c1"># Create regime-switching returns</span>
    <span class="n">regime</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_samples</span><span class="p">)</span>
    <span class="n">current_regime</span> <span class="o">=</span> <span class="mi">0</span>
    
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_samples</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mf">0.01</span><span class="p">:</span>  <span class="c1"># 1% chance to switch regime</span>
            <span class="n">current_regime</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">current_regime</span>
        <span class="n">regime</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_regime</span>
    
    <span class="c1"># Generate returns based on regime</span>
    <span class="n">returns</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
        <span class="n">regime</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mf">0.0005</span><span class="p">,</span> <span class="mf">0.012</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">),</span>  <span class="c1"># Bull regime</span>
        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="o">-</span><span class="mf">0.0002</span><span class="p">,</span> <span class="mf">0.018</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">)</span>  <span class="c1"># Bear regime</span>
    <span class="p">)</span>
    
    <span class="c1"># Generate prices</span>
    <span class="n">prices</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">returns</span><span class="p">))</span>
    
    <span class="c1"># Create OHLCV</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
        <span class="s1">&#39;date&#39;</span><span class="p">:</span> <span class="n">dates</span><span class="p">,</span>
        <span class="s1">&#39;open&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">prices</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="s1">&#39;high&#39;</span><span class="p">:</span> <span class="n">prices</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.008</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">))),</span>
        <span class="s1">&#39;low&#39;</span><span class="p">:</span> <span class="n">prices</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.008</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">))),</span>
        <span class="s1">&#39;close&#39;</span><span class="p">:</span> <span class="n">prices</span><span class="p">,</span>
        <span class="s1">&#39;volume&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">lognormal</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">),</span>
        <span class="s1">&#39;regime&#39;</span><span class="p">:</span> <span class="n">regime</span>
    <span class="p">})</span>
    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;open&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;close&#39;</span><span class="p">]</span>
    <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">df</span>

<span class="c1"># Generate data</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">generate_backtest_data</span><span class="p">(</span><span class="mi">3000</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dataset: </span><span class="si">{</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">date</span><span class="p">()</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">date</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Samples: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">tail</span><span class="p">()</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Feature engineering</span>
<span class="k">def</span> <span class="nf">create_features</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create features for ML model.&quot;&quot;&quot;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    
    <span class="c1"># Returns</span>
    <span class="k">for</span> <span class="n">period</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">]:</span>
        <span class="n">data</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;return_</span><span class="si">{</span><span class="n">period</span><span class="si">}</span><span class="s1">d&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">(</span><span class="n">period</span><span class="p">)</span>
    
    <span class="c1"># Volatility</span>
    <span class="k">for</span> <span class="n">period</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">]:</span>
        <span class="n">data</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;volatility_</span><span class="si">{</span><span class="n">period</span><span class="si">}</span><span class="s1">d&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;return_1d&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">period</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
    
    <span class="c1"># Moving averages</span>
    <span class="k">for</span> <span class="n">period</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">50</span><span class="p">]:</span>
        <span class="n">data</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;sma_</span><span class="si">{</span><span class="n">period</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">period</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">data</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;price_to_sma_</span><span class="si">{</span><span class="n">period</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">data</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;sma_</span><span class="si">{</span><span class="n">period</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span>
    
    <span class="c1"># RSI</span>
    <span class="n">delta</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span>
    <span class="n">gain</span> <span class="o">=</span> <span class="p">(</span><span class="n">delta</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">delta</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">14</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">delta</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">delta</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">14</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;rsi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">-</span> <span class="p">(</span><span class="mi">100</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">gain</span> <span class="o">/</span> <span class="p">(</span><span class="n">loss</span> <span class="o">+</span> <span class="mf">1e-10</span><span class="p">)))</span>
    
    <span class="c1"># MACD</span>
    <span class="n">exp12</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">ewm</span><span class="p">(</span><span class="n">span</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">exp26</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">ewm</span><span class="p">(</span><span class="n">span</span><span class="o">=</span><span class="mi">26</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;macd&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">exp12</span> <span class="o">-</span> <span class="n">exp26</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;macd_signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;macd&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">ewm</span><span class="p">(</span><span class="n">span</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    
    <span class="c1"># Volume</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;volume_sma&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;volume&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;volume_ratio&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;volume&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;volume_sma&#39;</span><span class="p">]</span>
    
    <span class="c1"># Target: next day direction</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;future_return&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">data</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

<span class="c1"># Create features</span>
<span class="n">df_features</span> <span class="o">=</span> <span class="n">create_features</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Features created: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df_features</span><span class="p">)</span><span class="si">}</span><span class="s2"> samples&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Walk-Forward Optimizer</span>
<span class="k">class</span> <span class="nc">WalkForwardOptimizer</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Walk-forward optimization framework for ML strategies.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">train_window</span><span class="o">=</span><span class="mi">252</span><span class="p">,</span> <span class="n">test_window</span><span class="o">=</span><span class="mi">21</span><span class="p">,</span> 
                 <span class="n">step_size</span><span class="o">=</span><span class="mi">21</span><span class="p">,</span> <span class="n">min_train_samples</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            model: sklearn-compatible model</span>
<span class="sd">            train_window: Number of days for training (1 year = 252)</span>
<span class="sd">            test_window: Number of days for testing (1 month = 21)</span>
<span class="sd">            step_size: How often to retrain (monthly = 21)</span>
<span class="sd">            min_train_samples: Minimum samples needed for training</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_window</span> <span class="o">=</span> <span class="n">train_window</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_window</span> <span class="o">=</span> <span class="n">test_window</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">step_size</span> <span class="o">=</span> <span class="n">step_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_train_samples</span> <span class="o">=</span> <span class="n">min_train_samples</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">feature_cols</span><span class="p">,</span> <span class="n">target_col</span><span class="o">=</span><span class="s1">&#39;target&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Run walk-forward optimization.&quot;&quot;&quot;</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">feature_cols</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">target_col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">dates</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span>
        
        <span class="n">n_samples</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="n">predictions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">n_samples</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="n">probabilities</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">n_samples</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        
        <span class="c1"># Walk-forward loop</span>
        <span class="n">start_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_window</span>
        
        <span class="n">fold</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">start_idx</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_window</span> <span class="o">&lt;=</span> <span class="n">n_samples</span><span class="p">:</span>
            <span class="c1"># Define train and test indices</span>
            <span class="n">train_start</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">start_idx</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_window</span><span class="p">)</span>
            <span class="n">train_end</span> <span class="o">=</span> <span class="n">start_idx</span>
            <span class="n">test_start</span> <span class="o">=</span> <span class="n">start_idx</span>
            <span class="n">test_end</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">start_idx</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_window</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">)</span>
            
            <span class="c1"># Get train and test data</span>
            <span class="n">X_train</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">train_start</span><span class="p">:</span><span class="n">train_end</span><span class="p">]</span>
            <span class="n">y_train</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">train_start</span><span class="p">:</span><span class="n">train_end</span><span class="p">]</span>
            <span class="n">X_test</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">test_start</span><span class="p">:</span><span class="n">test_end</span><span class="p">]</span>
            <span class="n">y_test</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">test_start</span><span class="p">:</span><span class="n">test_end</span><span class="p">]</span>
            
            <span class="c1"># Skip if insufficient training data</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_train_samples</span><span class="p">:</span>
                <span class="n">start_idx</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step_size</span>
                <span class="k">continue</span>
            
            <span class="c1"># Scale features</span>
            <span class="n">X_train_scaled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
            <span class="n">X_test_scaled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
            
            <span class="c1"># Train model</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_scaled</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
            
            <span class="c1"># Predict</span>
            <span class="n">pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test_scaled</span><span class="p">)</span>
            <span class="n">prob</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test_scaled</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">]</span>
            
            <span class="c1"># Store predictions</span>
            <span class="n">predictions</span><span class="p">[</span><span class="n">test_start</span><span class="p">:</span><span class="n">test_end</span><span class="p">]</span> <span class="o">=</span> <span class="n">pred</span>
            <span class="n">probabilities</span><span class="p">[</span><span class="n">test_start</span><span class="p">:</span><span class="n">test_end</span><span class="p">]</span> <span class="o">=</span> <span class="n">prob</span>
            
            <span class="c1"># Record fold results</span>
            <span class="n">fold_accuracy</span> <span class="o">=</span> <span class="n">accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">pred</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;fold&#39;</span><span class="p">:</span> <span class="n">fold</span><span class="p">,</span>
                <span class="s1">&#39;train_start&#39;</span><span class="p">:</span> <span class="n">dates</span><span class="p">[</span><span class="n">train_start</span><span class="p">],</span>
                <span class="s1">&#39;train_end&#39;</span><span class="p">:</span> <span class="n">dates</span><span class="p">[</span><span class="n">train_end</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                <span class="s1">&#39;test_start&#39;</span><span class="p">:</span> <span class="n">dates</span><span class="p">[</span><span class="n">test_start</span><span class="p">],</span>
                <span class="s1">&#39;test_end&#39;</span><span class="p">:</span> <span class="n">dates</span><span class="p">[</span><span class="n">test_end</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                <span class="s1">&#39;accuracy&#39;</span><span class="p">:</span> <span class="n">fold_accuracy</span><span class="p">,</span>
                <span class="s1">&#39;n_train&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">X_train</span><span class="p">),</span>
                <span class="s1">&#39;n_test&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
            <span class="p">})</span>
            
            <span class="n">fold</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">start_idx</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step_size</span>
        
        <span class="c1"># Create results dataframe</span>
        <span class="n">df_results</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">df_results</span><span class="p">[</span><span class="s1">&#39;prediction&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">predictions</span>
        <span class="n">df_results</span><span class="p">[</span><span class="s1">&#39;probability&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">probabilities</span>
        <span class="n">df_results</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">predictions</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">df_results</span>
    
    <span class="k">def</span> <span class="nf">get_fold_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get summary of all folds.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;WalkForwardOptimizer class defined&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Run walk-forward optimization</span>
<span class="n">feature_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;return_1d&#39;</span><span class="p">,</span> <span class="s1">&#39;return_5d&#39;</span><span class="p">,</span> <span class="s1">&#39;return_10d&#39;</span><span class="p">,</span> <span class="s1">&#39;return_20d&#39;</span><span class="p">,</span>
                <span class="s1">&#39;volatility_5d&#39;</span><span class="p">,</span> <span class="s1">&#39;volatility_10d&#39;</span><span class="p">,</span> <span class="s1">&#39;volatility_20d&#39;</span><span class="p">,</span>
                <span class="s1">&#39;price_to_sma_5&#39;</span><span class="p">,</span> <span class="s1">&#39;price_to_sma_10&#39;</span><span class="p">,</span> <span class="s1">&#39;price_to_sma_20&#39;</span><span class="p">,</span>
                <span class="s1">&#39;rsi&#39;</span><span class="p">,</span> <span class="s1">&#39;macd&#39;</span><span class="p">,</span> <span class="s1">&#39;volume_ratio&#39;</span><span class="p">]</span>

<span class="c1"># Initialize optimizer with Random Forest</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">RandomForestClassifier</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
<span class="n">wfo</span> <span class="o">=</span> <span class="n">WalkForwardOptimizer</span><span class="p">(</span>
    <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
    <span class="n">train_window</span><span class="o">=</span><span class="mi">252</span><span class="p">,</span>  <span class="c1"># 1 year training</span>
    <span class="n">test_window</span><span class="o">=</span><span class="mi">21</span><span class="p">,</span>    <span class="c1"># 1 month testing</span>
    <span class="n">step_size</span><span class="o">=</span><span class="mi">21</span>       <span class="c1"># Retrain monthly</span>
<span class="p">)</span>

<span class="c1"># Run walk-forward</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">wfo</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">df_features</span><span class="p">,</span> <span class="n">feature_cols</span><span class="p">)</span>

<span class="c1"># Get fold summary</span>
<span class="n">fold_summary</span> <span class="o">=</span> <span class="n">wfo</span><span class="o">.</span><span class="n">get_fold_summary</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Walk-forward completed: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">fold_summary</span><span class="p">)</span><span class="si">}</span><span class="s2"> folds&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Average accuracy: </span><span class="si">{</span><span class="n">fold_summary</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Accuracy std: </span><span class="si">{</span><span class="n">fold_summary</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Visualize walk-forward results</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

<span class="c1"># Accuracy by fold</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">fold_summary</span><span class="p">[</span><span class="s1">&#39;fold&#39;</span><span class="p">],</span> <span class="n">fold_summary</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">])</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Random&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">fold_summary</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span> 
                   <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Average&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Fold&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Accuracy&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Accuracy by Fold&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="c1"># Rolling accuracy over time</span>
<span class="n">test_mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;prediction&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span>
<span class="n">rolling_acc</span> <span class="o">=</span> <span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">test_mask</span><span class="p">,</span> <span class="s1">&#39;prediction&#39;</span><span class="p">]</span> <span class="o">==</span> 
               <span class="n">results</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">test_mask</span><span class="p">,</span> <span class="s1">&#39;target&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">63</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">rolling_acc</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">rolling_acc</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Rolling Accuracy (63-day)&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Accuracy Over Time&#39;</span><span class="p">)</span>

<span class="c1"># Prediction probability distribution</span>
<span class="n">valid_probs</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;probability&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">valid_probs</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Prediction Probability&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Frequency&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Prediction Distribution&#39;</span><span class="p">)</span>

<span class="c1"># Training window visualization</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">fold_summary</span><span class="p">[</span><span class="s1">&#39;fold&#39;</span><span class="p">],</span> <span class="n">fold_summary</span><span class="p">[</span><span class="s1">&#39;n_train&#39;</span><span class="p">],</span> 
                   <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Train samples&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">fold_summary</span><span class="p">[</span><span class="s1">&#39;fold&#39;</span><span class="p">],</span> <span class="n">fold_summary</span><span class="p">[</span><span class="s1">&#39;n_test&#39;</span><span class="p">],</span> 
                   <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Test samples&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Fold&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Number of Samples&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Sample Sizes by Fold&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
<div class="md-cell"><hr />
<h2>Section 2: Avoiding Backtesting Pitfalls</h2>
<p>Common backtesting mistakes can make a losing strategy appear profitable.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Demonstrating Look-Ahead Bias</span>
<span class="k">def</span> <span class="nf">demonstrate_lookahead_bias</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">feature_cols</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Show the impact of look-ahead bias.&quot;&quot;&quot;</span>
    
    <span class="c1"># WRONG: Using future information in features</span>
    <span class="n">df_wrong</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="c1"># This uses the next day&#39;s close to create today&#39;s feature!</span>
    <span class="n">df_wrong</span><span class="p">[</span><span class="s1">&#39;future_leak&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_wrong</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">df_wrong</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
    
    <span class="c1"># Split data</span>
    <span class="n">split_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df_wrong</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.7</span><span class="p">)</span>
    
    <span class="c1"># Train with leaked feature</span>
    <span class="n">X_train</span> <span class="o">=</span> <span class="n">df_wrong</span><span class="p">[</span><span class="n">feature_cols</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;future_leak&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="n">split_idx</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">X_test</span> <span class="o">=</span> <span class="n">df_wrong</span><span class="p">[</span><span class="n">feature_cols</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;future_leak&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">split_idx</span><span class="p">:]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">y_train</span> <span class="o">=</span> <span class="n">df_wrong</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="n">split_idx</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">y_test</span> <span class="o">=</span> <span class="n">df_wrong</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">split_idx</span><span class="p">:]</span><span class="o">.</span><span class="n">values</span>
    
    <span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
    <span class="n">X_train_scaled</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_train</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># Remove last row (NaN)</span>
    <span class="n">X_test_scaled</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_test</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">y_train</span> <span class="o">=</span> <span class="n">y_train</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">y_test</span> <span class="o">=</span> <span class="n">y_test</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    
    <span class="n">model_biased</span> <span class="o">=</span> <span class="n">RandomForestClassifier</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
    <span class="n">model_biased</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_scaled</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
    
    <span class="n">biased_accuracy</span> <span class="o">=</span> <span class="n">accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">model_biased</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test_scaled</span><span class="p">))</span>
    
    <span class="c1"># Train without leaked feature (correct approach)</span>
    <span class="n">X_train_correct</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">feature_cols</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="n">split_idx</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">X_test_correct</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">feature_cols</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">split_idx</span><span class="p">:]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">y_train_correct</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="n">split_idx</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">y_test_correct</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">split_idx</span><span class="p">:]</span><span class="o">.</span><span class="n">values</span>
    
    <span class="n">scaler2</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
    <span class="n">X_train_scaled2</span> <span class="o">=</span> <span class="n">scaler2</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_train_correct</span><span class="p">)</span>
    <span class="n">X_test_scaled2</span> <span class="o">=</span> <span class="n">scaler2</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_test_correct</span><span class="p">)</span>
    
    <span class="n">model_correct</span> <span class="o">=</span> <span class="n">RandomForestClassifier</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
    <span class="n">model_correct</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_scaled2</span><span class="p">,</span> <span class="n">y_train_correct</span><span class="p">)</span>
    
    <span class="n">correct_accuracy</span> <span class="o">=</span> <span class="n">accuracy_score</span><span class="p">(</span><span class="n">y_test_correct</span><span class="p">,</span> <span class="n">model_correct</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test_scaled2</span><span class="p">))</span>
    
    <span class="k">return</span> <span class="n">biased_accuracy</span><span class="p">,</span> <span class="n">correct_accuracy</span>

<span class="n">biased_acc</span><span class="p">,</span> <span class="n">correct_acc</span> <span class="o">=</span> <span class="n">demonstrate_lookahead_bias</span><span class="p">(</span><span class="n">df_features</span><span class="p">,</span> <span class="n">feature_cols</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Look-Ahead Bias Demonstration:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Accuracy WITH look-ahead bias: </span><span class="si">{</span><span class="n">biased_acc</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> (unrealistically high!)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Accuracy WITHOUT look-ahead bias: </span><span class="si">{</span><span class="n">correct_acc</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> (realistic)&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Survivorship Bias Simulator</span>
<span class="k">def</span> <span class="nf">simulate_survivorship_bias</span><span class="p">(</span><span class="n">n_stocks</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">n_periods</span><span class="o">=</span><span class="mi">252</span><span class="p">,</span> <span class="n">survival_rate</span><span class="o">=</span><span class="mf">0.8</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Simulate the impact of survivorship bias.&quot;&quot;&quot;</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
    
    <span class="c1"># Generate returns for all stocks</span>
    <span class="n">all_returns</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mf">0.0003</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">,</span> <span class="p">(</span><span class="n">n_stocks</span><span class="p">,</span> <span class="n">n_periods</span><span class="p">))</span>
    
    <span class="c1"># Some stocks will &quot;die&quot; (go bankrupt)</span>
    <span class="c1"># Dying stocks tend to have worse returns before death</span>
    <span class="n">n_deaths</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n_stocks</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">survival_rate</span><span class="p">))</span>
    <span class="n">death_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">n_stocks</span><span class="p">,</span> <span class="n">n_deaths</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    
    <span class="c1"># Make dying stocks have negative returns</span>
    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">death_indices</span><span class="p">:</span>
        <span class="n">death_period</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="n">n_periods</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="n">n_periods</span><span class="p">)</span>
        <span class="n">all_returns</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:</span><span class="n">death_period</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="o">-</span><span class="mf">0.002</span><span class="p">,</span> <span class="mf">0.03</span><span class="p">,</span> <span class="n">death_period</span><span class="p">)</span>
        <span class="n">all_returns</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="n">death_period</span><span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>  <span class="c1"># Dead after this</span>
    
    <span class="c1"># Calculate true average (including dead stocks)</span>
    <span class="n">true_avg_return</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">all_returns</span><span class="p">)</span>
    
    <span class="c1"># Calculate survivorship-biased average (only surviving stocks)</span>
    <span class="n">survivor_mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">all_returns</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># Stocks that survived to end</span>
    <span class="n">biased_avg_return</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">all_returns</span><span class="p">[</span><span class="n">survivor_mask</span><span class="p">])</span>
    
    <span class="k">return</span> <span class="n">true_avg_return</span><span class="p">,</span> <span class="n">biased_avg_return</span><span class="p">,</span> <span class="n">death_indices</span>

<span class="n">true_ret</span><span class="p">,</span> <span class="n">biased_ret</span><span class="p">,</span> <span class="n">deaths</span> <span class="o">=</span> <span class="n">simulate_survivorship_bias</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Survivorship Bias Simulation:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;True average daily return: </span><span class="si">{</span><span class="n">true_ret</span><span class="si">:</span><span class="s2">.4%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Biased average daily return: </span><span class="si">{</span><span class="n">biased_ret</span><span class="si">:</span><span class="s2">.4%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Annualized difference: </span><span class="si">{</span><span class="p">(</span><span class="n">biased_ret</span> <span class="o">-</span> <span class="n">true_ret</span><span class="p">)</span> <span class="o">*</span> <span class="mi">252</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Overfitting Detection</span>
<span class="k">def</span> <span class="nf">detect_overfitting</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">feature_cols</span><span class="p">,</span> <span class="n">max_depth_range</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">20</span><span class="p">)):</span>
    <span class="sd">&quot;&quot;&quot;Detect overfitting by comparing train/test performance.&quot;&quot;&quot;</span>
    
    <span class="n">X</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">feature_cols</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    
    <span class="c1"># Time-based split</span>
    <span class="n">split_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.7</span><span class="p">)</span>
    <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span> <span class="o">=</span> <span class="n">X</span><span class="p">[:</span><span class="n">split_idx</span><span class="p">],</span> <span class="n">X</span><span class="p">[</span><span class="n">split_idx</span><span class="p">:]</span>
    <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">y</span><span class="p">[:</span><span class="n">split_idx</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">split_idx</span><span class="p">:]</span>
    
    <span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
    <span class="n">X_train_scaled</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
    <span class="n">X_test_scaled</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
    
    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">for</span> <span class="n">depth</span> <span class="ow">in</span> <span class="n">max_depth_range</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">RandomForestClassifier</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="n">depth</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_scaled</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
        
        <span class="n">train_acc</span> <span class="o">=</span> <span class="n">accuracy_score</span><span class="p">(</span><span class="n">y_train</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_train_scaled</span><span class="p">))</span>
        <span class="n">test_acc</span> <span class="o">=</span> <span class="n">accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test_scaled</span><span class="p">))</span>
        
        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;max_depth&#39;</span><span class="p">:</span> <span class="n">depth</span><span class="p">,</span>
            <span class="s1">&#39;train_accuracy&#39;</span><span class="p">:</span> <span class="n">train_acc</span><span class="p">,</span>
            <span class="s1">&#39;test_accuracy&#39;</span><span class="p">:</span> <span class="n">test_acc</span><span class="p">,</span>
            <span class="s1">&#39;overfit_gap&#39;</span><span class="p">:</span> <span class="n">train_acc</span> <span class="o">-</span> <span class="n">test_acc</span>
        <span class="p">})</span>
    
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>

<span class="n">overfit_results</span> <span class="o">=</span> <span class="n">detect_overfitting</span><span class="p">(</span><span class="n">df_features</span><span class="p">,</span> <span class="n">feature_cols</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Overfitting Analysis:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">overfit_results</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Visualize overfitting</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

<span class="c1"># Train vs Test accuracy</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">overfit_results</span><span class="p">[</span><span class="s1">&#39;max_depth&#39;</span><span class="p">],</span> <span class="n">overfit_results</span><span class="p">[</span><span class="s1">&#39;train_accuracy&#39;</span><span class="p">],</span> 
             <span class="s1">&#39;b-&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Training&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">overfit_results</span><span class="p">[</span><span class="s1">&#39;max_depth&#39;</span><span class="p">],</span> <span class="n">overfit_results</span><span class="p">[</span><span class="s1">&#39;test_accuracy&#39;</span><span class="p">],</span> 
             <span class="s1">&#39;r-&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Test&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Max Depth&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Accuracy&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Model Complexity vs Performance&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="c1"># Overfit gap</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">overfit_results</span><span class="p">[</span><span class="s1">&#39;max_depth&#39;</span><span class="p">],</span> <span class="n">overfit_results</span><span class="p">[</span><span class="s1">&#39;overfit_gap&#39;</span><span class="p">])</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Warning threshold&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Max Depth&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Train - Test Gap&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Overfitting Gap&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Recommend optimal depth</span>
<span class="n">best_depth</span> <span class="o">=</span> <span class="n">overfit_results</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">overfit_results</span><span class="p">[</span><span class="s1">&#39;test_accuracy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">idxmax</span><span class="p">(),</span> <span class="s1">&#39;max_depth&#39;</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Recommended max_depth: </span><span class="si">{</span><span class="n">best_depth</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><hr />
<h2>Section 3: Realistic Backtesting Framework</h2>
<p>A proper backtest must account for transaction costs, slippage, and realistic execution.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Realistic Backtester</span>
<span class="k">class</span> <span class="nc">RealisticBacktester</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Backtesting framework with realistic assumptions.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">initial_capital</span><span class="o">=</span><span class="mi">100000</span><span class="p">,</span> <span class="n">commission</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span> 
                 <span class="n">slippage</span><span class="o">=</span><span class="mf">0.0005</span><span class="p">,</span> <span class="n">max_position_size</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            initial_capital: Starting capital</span>
<span class="sd">            commission: Commission per trade (0.1% = 0.001)</span>
<span class="sd">            slippage: Expected slippage (0.05% = 0.0005)</span>
<span class="sd">            max_position_size: Maximum position as fraction of portfolio</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initial_capital</span> <span class="o">=</span> <span class="n">initial_capital</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">commission</span> <span class="o">=</span> <span class="n">commission</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slippage</span> <span class="o">=</span> <span class="n">slippage</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_position_size</span> <span class="o">=</span> <span class="n">max_position_size</span>
        
    <span class="k">def</span> <span class="nf">run_backtest</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">signal_col</span><span class="o">=</span><span class="s1">&#39;signal&#39;</span><span class="p">,</span> <span class="n">return_col</span><span class="o">=</span><span class="s1">&#39;future_return&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Run backtest with realistic assumptions.&quot;&quot;&quot;</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        
        <span class="c1"># Remove NaN signals</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">results</span><span class="p">[</span><span class="n">signal_col</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">results</span><span class="p">[</span><span class="n">return_col</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        
        <span class="c1"># Initialize tracking</span>
        <span class="n">capital</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_capital</span>
        <span class="n">position</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># 1 = long, -1 = short, 0 = flat</span>
        
        <span class="n">capitals</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">positions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">trades</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">costs</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">results</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="n">signal</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">signal_col</span><span class="p">]</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">return_col</span><span class="p">]</span>
            
            <span class="c1"># Calculate position change</span>
            <span class="k">if</span> <span class="n">signal</span> <span class="o">!=</span> <span class="n">position</span><span class="p">:</span>
                <span class="c1"># Trade occurred</span>
                <span class="n">trade_cost</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">signal</span> <span class="o">-</span> <span class="n">position</span><span class="p">)</span> <span class="o">*</span> <span class="n">capital</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">commission</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">slippage</span><span class="p">)</span>
                <span class="n">capital</span> <span class="o">-=</span> <span class="n">trade_cost</span>
                <span class="n">trades</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">costs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">trade_cost</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">trades</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">costs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            
            <span class="c1"># Update position</span>
            <span class="n">position</span> <span class="o">=</span> <span class="n">signal</span>
            
            <span class="c1"># Apply position sizing</span>
            <span class="n">effective_position</span> <span class="o">=</span> <span class="n">position</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_position_size</span>
            
            <span class="c1"># Calculate return</span>
            <span class="n">capital</span> <span class="o">=</span> <span class="n">capital</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">effective_position</span> <span class="o">*</span> <span class="n">ret</span><span class="p">)</span>
            
            <span class="n">capitals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">capital</span><span class="p">)</span>
            <span class="n">positions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">position</span><span class="p">)</span>
        
        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;capital&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">capitals</span>
        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;position&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">positions</span>
        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;trade&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">trades</span>
        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;cost&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">costs</span>
        
        <span class="k">return</span> <span class="n">results</span>
    
    <span class="k">def</span> <span class="nf">calculate_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">results</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculate performance metrics.&quot;&quot;&quot;</span>
        <span class="n">capitals</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;capital&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        
        <span class="c1"># Returns</span>
        <span class="n">returns</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">capitals</span><span class="p">)</span> <span class="o">/</span> <span class="n">capitals</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        
        <span class="c1"># Total return</span>
        <span class="n">total_return</span> <span class="o">=</span> <span class="p">(</span><span class="n">capitals</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">capitals</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span>
        
        <span class="c1"># Annualized return</span>
        <span class="n">n_years</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">capitals</span><span class="p">)</span> <span class="o">/</span> <span class="mi">252</span>
        <span class="n">annual_return</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">total_return</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">n_years</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        
        <span class="c1"># Sharpe ratio</span>
        <span class="n">sharpe</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">returns</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">returns</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1e-8</span><span class="p">)</span>
        
        <span class="c1"># Max drawdown</span>
        <span class="n">peak</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="o">.</span><span class="n">accumulate</span><span class="p">(</span><span class="n">capitals</span><span class="p">)</span>
        <span class="n">drawdown</span> <span class="o">=</span> <span class="p">(</span><span class="n">capitals</span> <span class="o">-</span> <span class="n">peak</span><span class="p">)</span> <span class="o">/</span> <span class="n">peak</span>
        <span class="n">max_drawdown</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">drawdown</span><span class="p">)</span>
        
        <span class="c1"># Win rate</span>
        <span class="n">win_rate</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">returns</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
        
        <span class="c1"># Trade statistics</span>
        <span class="n">n_trades</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;trade&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">total_costs</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;cost&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;total_return&#39;</span><span class="p">:</span> <span class="n">total_return</span><span class="p">,</span>
            <span class="s1">&#39;annual_return&#39;</span><span class="p">:</span> <span class="n">annual_return</span><span class="p">,</span>
            <span class="s1">&#39;sharpe_ratio&#39;</span><span class="p">:</span> <span class="n">sharpe</span><span class="p">,</span>
            <span class="s1">&#39;max_drawdown&#39;</span><span class="p">:</span> <span class="n">max_drawdown</span><span class="p">,</span>
            <span class="s1">&#39;win_rate&#39;</span><span class="p">:</span> <span class="n">win_rate</span><span class="p">,</span>
            <span class="s1">&#39;n_trades&#39;</span><span class="p">:</span> <span class="n">n_trades</span><span class="p">,</span>
            <span class="s1">&#39;total_costs&#39;</span><span class="p">:</span> <span class="n">total_costs</span><span class="p">,</span>
            <span class="s1">&#39;cost_drag&#39;</span><span class="p">:</span> <span class="n">total_costs</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_capital</span>
        <span class="p">}</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;RealisticBacktester class defined&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Run realistic backtest</span>
<span class="n">backtester</span> <span class="o">=</span> <span class="n">RealisticBacktester</span><span class="p">(</span>
    <span class="n">initial_capital</span><span class="o">=</span><span class="mi">100000</span><span class="p">,</span>
    <span class="n">commission</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span>  <span class="c1"># 0.1%</span>
    <span class="n">slippage</span><span class="o">=</span><span class="mf">0.0005</span><span class="p">,</span>   <span class="c1"># 0.05%</span>
    <span class="n">max_position_size</span><span class="o">=</span><span class="mf">1.0</span>  <span class="c1"># Full position</span>
<span class="p">)</span>

<span class="c1"># Use walk-forward results</span>
<span class="n">backtest_results</span> <span class="o">=</span> <span class="n">backtester</span><span class="o">.</span><span class="n">run_backtest</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">signal_col</span><span class="o">=</span><span class="s1">&#39;signal&#39;</span><span class="p">,</span> <span class="n">return_col</span><span class="o">=</span><span class="s1">&#39;future_return&#39;</span><span class="p">)</span>

<span class="c1"># Calculate metrics</span>
<span class="n">metrics</span> <span class="o">=</span> <span class="n">backtester</span><span class="o">.</span><span class="n">calculate_metrics</span><span class="p">(</span><span class="n">backtest_results</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Realistic Backtest Results&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>
<span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">metrics</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="k">if</span> <span class="s1">&#39;return&#39;</span> <span class="ow">in</span> <span class="n">key</span> <span class="ow">or</span> <span class="s1">&#39;drawdown&#39;</span> <span class="ow">in</span> <span class="n">key</span> <span class="ow">or</span> <span class="s1">&#39;rate&#39;</span> <span class="ow">in</span> <span class="n">key</span> <span class="ow">or</span> <span class="s1">&#39;drag&#39;</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">value</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="s1">&#39;ratio&#39;</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">value</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">value</span><span class="si">:</span><span class="s2">,.0f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Compare with and without costs</span>
<span class="n">backtester_no_costs</span> <span class="o">=</span> <span class="n">RealisticBacktester</span><span class="p">(</span>
    <span class="n">initial_capital</span><span class="o">=</span><span class="mi">100000</span><span class="p">,</span>
    <span class="n">commission</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">slippage</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">max_position_size</span><span class="o">=</span><span class="mf">1.0</span>
<span class="p">)</span>

<span class="n">results_no_costs</span> <span class="o">=</span> <span class="n">backtester_no_costs</span><span class="o">.</span><span class="n">run_backtest</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
<span class="n">metrics_no_costs</span> <span class="o">=</span> <span class="n">backtester_no_costs</span><span class="o">.</span><span class="n">calculate_metrics</span><span class="p">(</span><span class="n">results_no_costs</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Impact of Transaction Costs:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Return without costs: </span><span class="si">{</span><span class="n">metrics_no_costs</span><span class="p">[</span><span class="s1">&#39;total_return&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Return with costs: </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;total_return&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cost impact: </span><span class="si">{</span><span class="n">metrics_no_costs</span><span class="p">[</span><span class="s1">&#39;total_return&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;total_return&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Visualize backtest</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

<span class="c1"># Equity curve</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">backtest_results</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">backtest_results</span><span class="p">[</span><span class="s1">&#39;capital&#39;</span><span class="p">],</span> 
                <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Strategy&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

<span class="c1"># Buy and hold comparison</span>
<span class="n">bh_capital</span> <span class="o">=</span> <span class="mi">100000</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">backtest_results</span><span class="p">[</span><span class="s1">&#39;future_return&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">backtest_results</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">bh_capital</span><span class="p">,</span> 
                <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Buy &amp; Hold&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Portfolio Value ($)&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Equity Curve&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="c1"># Drawdown</span>
<span class="n">peak</span> <span class="o">=</span> <span class="n">backtest_results</span><span class="p">[</span><span class="s1">&#39;capital&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">cummax</span><span class="p">()</span>
<span class="n">drawdown</span> <span class="o">=</span> <span class="p">(</span><span class="n">backtest_results</span><span class="p">[</span><span class="s1">&#39;capital&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">peak</span><span class="p">)</span> <span class="o">/</span> <span class="n">peak</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">drawdown</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">drawdown</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Drawdown&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Drawdown Over Time&#39;</span><span class="p">)</span>

<span class="c1"># Position over time</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">backtest_results</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">backtest_results</span><span class="p">[</span><span class="s1">&#39;position&#39;</span><span class="p">],</span> 
                <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Position&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Position Over Time&#39;</span><span class="p">)</span>

<span class="c1"># Cumulative costs</span>
<span class="n">cum_costs</span> <span class="o">=</span> <span class="n">backtest_results</span><span class="p">[</span><span class="s1">&#39;cost&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">backtest_results</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">cum_costs</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Cumulative Costs ($)&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Transaction Costs&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
<div class="md-cell"><hr />
<h2>Section 4: Robustness Testing</h2>
<p>Testing strategy robustness helps ensure performance isn't due to luck or overfitting.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Monte Carlo Simulation for Strategy Robustness</span>
<span class="k">def</span> <span class="nf">monte_carlo_robustness</span><span class="p">(</span><span class="n">returns</span><span class="p">,</span> <span class="n">n_simulations</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Test strategy robustness using Monte Carlo.&quot;&quot;&quot;</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
    
    <span class="n">original_sharpe</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span> <span class="o">*</span> <span class="n">returns</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">/</span> <span class="p">(</span><span class="n">returns</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">+</span> <span class="mf">1e-8</span><span class="p">)</span>
    <span class="n">original_total</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">returns</span><span class="p">)</span><span class="o">.</span><span class="n">prod</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span>
    
    <span class="n">simulated_sharpes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">simulated_returns</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_simulations</span><span class="p">):</span>
        <span class="c1"># Randomly shuffle returns</span>
        <span class="n">shuffled</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">permutation</span><span class="p">(</span><span class="n">returns</span><span class="p">)</span>
        
        <span class="n">sim_sharpe</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span> <span class="o">*</span> <span class="n">shuffled</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">/</span> <span class="p">(</span><span class="n">shuffled</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">+</span> <span class="mf">1e-8</span><span class="p">)</span>
        <span class="n">sim_total</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">shuffled</span><span class="p">)</span><span class="o">.</span><span class="n">prod</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span>
        
        <span class="n">simulated_sharpes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sim_sharpe</span><span class="p">)</span>
        <span class="n">simulated_returns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sim_total</span><span class="p">)</span>
    
    <span class="c1"># Calculate percentiles</span>
    <span class="n">sharpe_percentile</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">simulated_sharpes</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">original_sharpe</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">*</span> <span class="mi">100</span>
    <span class="n">return_percentile</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">simulated_returns</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">original_total</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">*</span> <span class="mi">100</span>
    
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;original_sharpe&#39;</span><span class="p">:</span> <span class="n">original_sharpe</span><span class="p">,</span>
        <span class="s1">&#39;simulated_sharpes&#39;</span><span class="p">:</span> <span class="n">simulated_sharpes</span><span class="p">,</span>
        <span class="s1">&#39;sharpe_percentile&#39;</span><span class="p">:</span> <span class="n">sharpe_percentile</span><span class="p">,</span>
        <span class="s1">&#39;original_return&#39;</span><span class="p">:</span> <span class="n">original_total</span><span class="p">,</span>
        <span class="s1">&#39;simulated_returns&#39;</span><span class="p">:</span> <span class="n">simulated_returns</span><span class="p">,</span>
        <span class="s1">&#39;return_percentile&#39;</span><span class="p">:</span> <span class="n">return_percentile</span>
    <span class="p">}</span>

<span class="c1"># Run Monte Carlo</span>
<span class="n">strategy_returns</span> <span class="o">=</span> <span class="n">backtest_results</span><span class="p">[</span><span class="s1">&#39;capital&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
<span class="n">mc_results</span> <span class="o">=</span> <span class="n">monte_carlo_robustness</span><span class="p">(</span><span class="n">strategy_returns</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Monte Carlo Robustness Test:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Strategy Sharpe: </span><span class="si">{</span><span class="n">mc_results</span><span class="p">[</span><span class="s1">&#39;original_sharpe&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sharpe percentile: </span><span class="si">{</span><span class="n">mc_results</span><span class="p">[</span><span class="s1">&#39;sharpe_percentile&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Strategy Return: </span><span class="si">{</span><span class="n">mc_results</span><span class="p">[</span><span class="s1">&#39;original_return&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Return percentile: </span><span class="si">{</span><span class="n">mc_results</span><span class="p">[</span><span class="s1">&#39;return_percentile&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Visualize Monte Carlo results</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

<span class="c1"># Sharpe distribution</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">mc_results</span><span class="p">[</span><span class="s1">&#39;simulated_sharpes&#39;</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">mc_results</span><span class="p">[</span><span class="s1">&#39;original_sharpe&#39;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Strategy: </span><span class="si">{</span><span class="n">mc_results</span><span class="p">[</span><span class="s2">&quot;original_sharpe&quot;</span><span class="p">]</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Sharpe Ratio&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Frequency&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Monte Carlo Sharpe Distribution</span><span class="se">\n</span><span class="s1">(Percentile: </span><span class="si">{</span><span class="n">mc_results</span><span class="p">[</span><span class="s2">&quot;sharpe_percentile&quot;</span><span class="p">]</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">%)&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="c1"># Return distribution</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">mc_results</span><span class="p">[</span><span class="s1">&#39;simulated_returns&#39;</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">mc_results</span><span class="p">[</span><span class="s1">&#39;original_return&#39;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Strategy: </span><span class="si">{</span><span class="n">mc_results</span><span class="p">[</span><span class="s2">&quot;original_return&quot;</span><span class="p">]</span><span class="si">:</span><span class="s1">.2%</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Total Return&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Frequency&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Monte Carlo Return Distribution</span><span class="se">\n</span><span class="s1">(Percentile: </span><span class="si">{</span><span class="n">mc_results</span><span class="p">[</span><span class="s2">&quot;return_percentile&quot;</span><span class="p">]</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">%)&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Parameter Sensitivity Analysis</span>
<span class="k">def</span> <span class="nf">sensitivity_analysis</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">feature_cols</span><span class="p">,</span> <span class="n">param_name</span><span class="p">,</span> <span class="n">param_values</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Analyze sensitivity to a parameter.&quot;&quot;&quot;</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="n">X</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">feature_cols</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    
    <span class="n">split_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.7</span><span class="p">)</span>
    <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span> <span class="o">=</span> <span class="n">X</span><span class="p">[:</span><span class="n">split_idx</span><span class="p">],</span> <span class="n">X</span><span class="p">[</span><span class="n">split_idx</span><span class="p">:]</span>
    <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">y</span><span class="p">[:</span><span class="n">split_idx</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">split_idx</span><span class="p">:]</span>
    
    <span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
    <span class="n">X_train_scaled</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
    <span class="n">X_test_scaled</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">param_values</span><span class="p">:</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="n">param_name</span><span class="p">:</span> <span class="n">value</span><span class="p">}</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">RandomForestClassifier</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="o">**</span><span class="n">params</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_scaled</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
        
        <span class="n">test_acc</span> <span class="o">=</span> <span class="n">accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test_scaled</span><span class="p">))</span>
        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;param_value&#39;</span><span class="p">:</span> <span class="n">value</span><span class="p">,</span> <span class="s1">&#39;test_accuracy&#39;</span><span class="p">:</span> <span class="n">test_acc</span><span class="p">})</span>
    
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>

<span class="c1"># Test sensitivity to max_depth</span>
<span class="n">depth_sensitivity</span> <span class="o">=</span> <span class="n">sensitivity_analysis</span><span class="p">(</span>
    <span class="n">df_features</span><span class="p">,</span> <span class="n">feature_cols</span><span class="p">,</span> 
    <span class="s1">&#39;max_depth&#39;</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">15</span><span class="p">)</span>
<span class="p">)</span>

<span class="c1"># Test sensitivity to n_estimators</span>
<span class="n">n_est_sensitivity</span> <span class="o">=</span> <span class="n">sensitivity_analysis</span><span class="p">(</span>
    <span class="n">df_features</span><span class="p">,</span> <span class="n">feature_cols</span><span class="p">,</span>
    <span class="s1">&#39;n_estimators&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">300</span><span class="p">]</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Parameter Sensitivity:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Max Depth:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">depth_sensitivity</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Visualize sensitivity</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">depth_sensitivity</span><span class="p">[</span><span class="s1">&#39;param_value&#39;</span><span class="p">],</span> <span class="n">depth_sensitivity</span><span class="p">[</span><span class="s1">&#39;test_accuracy&#39;</span><span class="p">],</span> 
             <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Max Depth&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Test Accuracy&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Sensitivity to Max Depth&#39;</span><span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">n_est_sensitivity</span><span class="p">[</span><span class="s1">&#39;param_value&#39;</span><span class="p">],</span> <span class="n">n_est_sensitivity</span><span class="p">[</span><span class="s1">&#39;test_accuracy&#39;</span><span class="p">],</span>
             <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Number of Estimators&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Test Accuracy&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Sensitivity to N Estimators&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
<div class="md-cell"><hr />
<h2>Section 5: Module Project - Complete Backtesting System</h2>
<p>Build a complete backtesting system with all proper safeguards.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Complete ML Backtesting System</span>
<span class="k">class</span> <span class="nc">MLBacktestingSystem</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Complete ML strategy backtesting system.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">initial_capital</span><span class="o">=</span><span class="mi">100000</span><span class="p">,</span>
                 <span class="n">commission</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">slippage</span><span class="o">=</span><span class="mf">0.0005</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initial_capital</span> <span class="o">=</span> <span class="n">initial_capital</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">commission</span> <span class="o">=</span> <span class="n">commission</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slippage</span> <span class="o">=</span> <span class="n">slippage</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">walk_forward_results</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">backtest_results</span> <span class="o">=</span> <span class="kc">None</span>
        
    <span class="k">def</span> <span class="nf">run_walk_forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">feature_cols</span><span class="p">,</span> <span class="n">target_col</span><span class="o">=</span><span class="s1">&#39;target&#39;</span><span class="p">,</span>
                          <span class="n">train_window</span><span class="o">=</span><span class="mi">252</span><span class="p">,</span> <span class="n">test_window</span><span class="o">=</span><span class="mi">21</span><span class="p">,</span> <span class="n">step_size</span><span class="o">=</span><span class="mi">21</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Run walk-forward optimization.&quot;&quot;&quot;</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">feature_cols</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">target_col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">dates</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span>
        
        <span class="n">n_samples</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="n">predictions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">n_samples</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="n">probabilities</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">n_samples</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        
        <span class="n">start_idx</span> <span class="o">=</span> <span class="n">train_window</span>
        <span class="n">fold_results</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">while</span> <span class="n">start_idx</span> <span class="o">+</span> <span class="n">test_window</span> <span class="o">&lt;=</span> <span class="n">n_samples</span><span class="p">:</span>
            <span class="n">train_start</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">start_idx</span> <span class="o">-</span> <span class="n">train_window</span><span class="p">)</span>
            <span class="n">train_end</span> <span class="o">=</span> <span class="n">start_idx</span>
            <span class="n">test_start</span> <span class="o">=</span> <span class="n">start_idx</span>
            <span class="n">test_end</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">start_idx</span> <span class="o">+</span> <span class="n">test_window</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">)</span>
            
            <span class="n">X_train</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">train_start</span><span class="p">:</span><span class="n">train_end</span><span class="p">]</span>
            <span class="n">y_train</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">train_start</span><span class="p">:</span><span class="n">train_end</span><span class="p">]</span>
            <span class="n">X_test</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">test_start</span><span class="p">:</span><span class="n">test_end</span><span class="p">]</span>
            <span class="n">y_test</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">test_start</span><span class="p">:</span><span class="n">test_end</span><span class="p">]</span>
            
            <span class="n">X_train_scaled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
            <span class="n">X_test_scaled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_scaled</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
            
            <span class="n">pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test_scaled</span><span class="p">)</span>
            <span class="n">prob</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test_scaled</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">]</span>
            
            <span class="n">predictions</span><span class="p">[</span><span class="n">test_start</span><span class="p">:</span><span class="n">test_end</span><span class="p">]</span> <span class="o">=</span> <span class="n">pred</span>
            <span class="n">probabilities</span><span class="p">[</span><span class="n">test_start</span><span class="p">:</span><span class="n">test_end</span><span class="p">]</span> <span class="o">=</span> <span class="n">prob</span>
            
            <span class="n">fold_results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;test_start&#39;</span><span class="p">:</span> <span class="n">dates</span><span class="p">[</span><span class="n">test_start</span><span class="p">],</span>
                <span class="s1">&#39;test_end&#39;</span><span class="p">:</span> <span class="n">dates</span><span class="p">[</span><span class="n">test_end</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                <span class="s1">&#39;accuracy&#39;</span><span class="p">:</span> <span class="n">accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">pred</span><span class="p">)</span>
            <span class="p">})</span>
            
            <span class="n">start_idx</span> <span class="o">+=</span> <span class="n">step_size</span>
        
        <span class="n">results</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;prediction&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">predictions</span>
        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;probability&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">probabilities</span>
        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">predictions</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">walk_forward_results</span> <span class="o">=</span> <span class="n">results</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fold_summary</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">fold_results</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">results</span>
    
    <span class="k">def</span> <span class="nf">run_backtest</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">signal_col</span><span class="o">=</span><span class="s1">&#39;signal&#39;</span><span class="p">,</span> <span class="n">return_col</span><span class="o">=</span><span class="s1">&#39;future_return&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Run realistic backtest.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">walk_forward_results</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Run walk_forward first&quot;</span><span class="p">)</span>
        
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">walk_forward_results</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">df</span><span class="p">[</span><span class="n">signal_col</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">df</span><span class="p">[</span><span class="n">return_col</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        
        <span class="n">capital</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_capital</span>
        <span class="n">position</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="n">capitals</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">trades</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="n">signal</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">signal_col</span><span class="p">]</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">return_col</span><span class="p">]</span>
            
            <span class="k">if</span> <span class="n">signal</span> <span class="o">!=</span> <span class="n">position</span><span class="p">:</span>
                <span class="n">cost</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">signal</span> <span class="o">-</span> <span class="n">position</span><span class="p">)</span> <span class="o">*</span> <span class="n">capital</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">commission</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">slippage</span><span class="p">)</span>
                <span class="n">capital</span> <span class="o">-=</span> <span class="n">cost</span>
                <span class="n">trades</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">trades</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            
            <span class="n">position</span> <span class="o">=</span> <span class="n">signal</span>
            <span class="n">capital</span> <span class="o">=</span> <span class="n">capital</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">position</span> <span class="o">*</span> <span class="n">ret</span><span class="p">)</span>
            <span class="n">capitals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">capital</span><span class="p">)</span>
        
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;capital&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">capitals</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;trade&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">trades</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">backtest_results</span> <span class="o">=</span> <span class="n">df</span>
        <span class="k">return</span> <span class="n">df</span>
    
    <span class="k">def</span> <span class="nf">calculate_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculate all performance metrics.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">backtest_results</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Run backtest first&quot;</span><span class="p">)</span>
        
        <span class="n">capitals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">backtest_results</span><span class="p">[</span><span class="s1">&#39;capital&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">returns</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">capitals</span><span class="p">)</span> <span class="o">/</span> <span class="n">capitals</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        
        <span class="n">total_return</span> <span class="o">=</span> <span class="p">(</span><span class="n">capitals</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">capitals</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">n_years</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">capitals</span><span class="p">)</span> <span class="o">/</span> <span class="mi">252</span>
        <span class="n">annual_return</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">total_return</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">n_years</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">sharpe</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">returns</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">returns</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1e-8</span><span class="p">)</span>
        
        <span class="n">peak</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="o">.</span><span class="n">accumulate</span><span class="p">(</span><span class="n">capitals</span><span class="p">)</span>
        <span class="n">drawdown</span> <span class="o">=</span> <span class="p">(</span><span class="n">capitals</span> <span class="o">-</span> <span class="n">peak</span><span class="p">)</span> <span class="o">/</span> <span class="n">peak</span>
        <span class="n">max_drawdown</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">drawdown</span><span class="p">)</span>
        
        <span class="c1"># Walk-forward metrics</span>
        <span class="n">avg_fold_accuracy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fold_summary</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">accuracy_std</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fold_summary</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;total_return&#39;</span><span class="p">:</span> <span class="n">total_return</span><span class="p">,</span>
            <span class="s1">&#39;annual_return&#39;</span><span class="p">:</span> <span class="n">annual_return</span><span class="p">,</span>
            <span class="s1">&#39;sharpe_ratio&#39;</span><span class="p">:</span> <span class="n">sharpe</span><span class="p">,</span>
            <span class="s1">&#39;max_drawdown&#39;</span><span class="p">:</span> <span class="n">max_drawdown</span><span class="p">,</span>
            <span class="s1">&#39;avg_fold_accuracy&#39;</span><span class="p">:</span> <span class="n">avg_fold_accuracy</span><span class="p">,</span>
            <span class="s1">&#39;accuracy_std&#39;</span><span class="p">:</span> <span class="n">accuracy_std</span><span class="p">,</span>
            <span class="s1">&#39;n_trades&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">backtest_results</span><span class="p">[</span><span class="s1">&#39;trade&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span>
            <span class="s1">&#39;n_folds&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fold_summary</span><span class="p">)</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">run_robustness_tests</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_simulations</span><span class="o">=</span><span class="mi">500</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Run Monte Carlo robustness tests.&quot;&quot;&quot;</span>
        <span class="n">returns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">backtest_results</span><span class="p">[</span><span class="s1">&#39;capital&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>
        
        <span class="n">original_sharpe</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span> <span class="o">*</span> <span class="n">returns</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">/</span> <span class="p">(</span><span class="n">returns</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">+</span> <span class="mf">1e-8</span><span class="p">)</span>
        
        <span class="n">simulated_sharpes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_simulations</span><span class="p">):</span>
            <span class="n">shuffled</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">permutation</span><span class="p">(</span><span class="n">returns</span><span class="p">)</span>
            <span class="n">sim_sharpe</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span> <span class="o">*</span> <span class="n">shuffled</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">/</span> <span class="p">(</span><span class="n">shuffled</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">+</span> <span class="mf">1e-8</span><span class="p">)</span>
            <span class="n">simulated_sharpes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sim_sharpe</span><span class="p">)</span>
        
        <span class="n">percentile</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">simulated_sharpes</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">original_sharpe</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">*</span> <span class="mi">100</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;original_sharpe&#39;</span><span class="p">:</span> <span class="n">original_sharpe</span><span class="p">,</span>
            <span class="s1">&#39;sharpe_percentile&#39;</span><span class="p">:</span> <span class="n">percentile</span><span class="p">,</span>
            <span class="s1">&#39;is_significant&#39;</span><span class="p">:</span> <span class="n">percentile</span> <span class="o">&gt;</span> <span class="mi">95</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">generate_report</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generate complete backtest report.&quot;&quot;&quot;</span>
        <span class="n">metrics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_metrics</span><span class="p">()</span>
        <span class="n">robustness</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_robustness_tests</span><span class="p">()</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ML STRATEGY BACKTEST REPORT&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- Performance Metrics ---&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total Return: </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;total_return&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Annual Return: </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;annual_return&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sharpe Ratio: </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;sharpe_ratio&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Max Drawdown: </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;max_drawdown&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- Walk-Forward Results ---&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of Folds: </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;n_folds&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Average Fold Accuracy: </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;avg_fold_accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Accuracy Std Dev: </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;accuracy_std&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- Trading Statistics ---&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of Trades: </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;n_trades&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- Robustness Tests ---&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Strategy Sharpe: </span><span class="si">{</span><span class="n">robustness</span><span class="p">[</span><span class="s1">&#39;original_sharpe&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sharpe Percentile: </span><span class="si">{</span><span class="n">robustness</span><span class="p">[</span><span class="s1">&#39;sharpe_percentile&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Statistically Significant: </span><span class="si">{</span><span class="n">robustness</span><span class="p">[</span><span class="s1">&#39;is_significant&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">metrics</span><span class="p">,</span> <span class="n">robustness</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;MLBacktestingSystem class defined&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Run complete backtesting system</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">RandomForestClassifier</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>

<span class="n">system</span> <span class="o">=</span> <span class="n">MLBacktestingSystem</span><span class="p">(</span>
    <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
    <span class="n">initial_capital</span><span class="o">=</span><span class="mi">100000</span><span class="p">,</span>
    <span class="n">commission</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span>
    <span class="n">slippage</span><span class="o">=</span><span class="mf">0.0005</span>
<span class="p">)</span>

<span class="c1"># Run walk-forward</span>
<span class="n">wf_results</span> <span class="o">=</span> <span class="n">system</span><span class="o">.</span><span class="n">run_walk_forward</span><span class="p">(</span>
    <span class="n">df_features</span><span class="p">,</span> <span class="n">feature_cols</span><span class="p">,</span>
    <span class="n">train_window</span><span class="o">=</span><span class="mi">252</span><span class="p">,</span>
    <span class="n">test_window</span><span class="o">=</span><span class="mi">21</span><span class="p">,</span>
    <span class="n">step_size</span><span class="o">=</span><span class="mi">21</span>
<span class="p">)</span>

<span class="c1"># Run backtest</span>
<span class="n">bt_results</span> <span class="o">=</span> <span class="n">system</span><span class="o">.</span><span class="n">run_backtest</span><span class="p">()</span>

<span class="c1"># Generate report</span>
<span class="n">metrics</span><span class="p">,</span> <span class="n">robustness</span> <span class="o">=</span> <span class="n">system</span><span class="o">.</span><span class="n">generate_report</span><span class="p">()</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Comprehensive visualization</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

<span class="c1"># Equity curve</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">bt_results</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">bt_results</span><span class="p">[</span><span class="s1">&#39;capital&#39;</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Portfolio Value ($)&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Equity Curve&#39;</span><span class="p">)</span>

<span class="c1"># Drawdown</span>
<span class="n">peak</span> <span class="o">=</span> <span class="n">bt_results</span><span class="p">[</span><span class="s1">&#39;capital&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">cummax</span><span class="p">()</span>
<span class="n">dd</span> <span class="o">=</span> <span class="p">(</span><span class="n">bt_results</span><span class="p">[</span><span class="s1">&#39;capital&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">peak</span><span class="p">)</span> <span class="o">/</span> <span class="n">peak</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">dd</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">dd</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Drawdown&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Drawdown&#39;</span><span class="p">)</span>

<span class="c1"># Walk-forward accuracy</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">system</span><span class="o">.</span><span class="n">fold_summary</span><span class="p">)),</span> <span class="n">system</span><span class="o">.</span><span class="n">fold_summary</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">])</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">system</span><span class="o">.</span><span class="n">fold_summary</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Fold&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Accuracy&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Walk-Forward Accuracy&#39;</span><span class="p">)</span>

<span class="c1"># Monthly returns</span>
<span class="n">monthly_returns</span> <span class="o">=</span> <span class="n">bt_results</span><span class="p">[</span><span class="s1">&#39;capital&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">&#39;M&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">last</span><span class="p">()</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
<span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;green&#39;</span> <span class="k">if</span> <span class="n">r</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;red&#39;</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">monthly_returns</span><span class="p">]</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">monthly_returns</span><span class="p">)),</span> <span class="n">monthly_returns</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Month&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Return&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Monthly Returns&#39;</span><span class="p">)</span>

<span class="c1"># Return distribution</span>
<span class="n">daily_returns</span> <span class="o">=</span> <span class="n">bt_results</span><span class="p">[</span><span class="s1">&#39;capital&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">daily_returns</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Daily Return&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Frequency&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Return Distribution&#39;</span><span class="p">)</span>

<span class="c1"># Rolling Sharpe</span>
<span class="n">rolling_sharpe</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span> <span class="o">*</span> <span class="n">daily_returns</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">63</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">/</span> <span class="n">daily_returns</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">63</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">rolling_sharpe</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">rolling_sharpe</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Rolling Sharpe (63-day)&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Rolling Sharpe Ratio&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
<div class="md-cell"><hr />
<h2>Exercises</h2>
<p>Complete the following exercises to practice ML backtesting.</p></div>
<div class="md-cell exercise-header"><h3>Exercise 12.1: Implement Walk-Forward Split (Guided)</h3>
<p>Create a function that generates walk-forward train/test indices.</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 12.1: Implement Walk-Forward Split</span>
<span class="k">def</span> <span class="nf">walk_forward_split</span><span class="p">(</span><span class="n">n_samples</span><span class="p">,</span> <span class="n">train_size</span><span class="p">,</span> <span class="n">test_size</span><span class="p">,</span> <span class="n">step_size</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate walk-forward train/test indices.</span>
<span class="sd">    </span>
<span class="sd">    Returns list of (train_indices, test_indices) tuples.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">splits</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="c1"># TODO: Start from end of first training window</span>
    <span class="n">start_idx</span> <span class="o">=</span> <span class="n">______</span>
    
    <span class="k">while</span> <span class="n">start_idx</span> <span class="o">+</span> <span class="n">______</span> <span class="o">&lt;=</span> <span class="n">n_samples</span><span class="p">:</span>
        <span class="c1"># TODO: Calculate train indices</span>
        <span class="n">train_start</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">start_idx</span> <span class="o">-</span> <span class="n">______</span><span class="p">)</span>
        <span class="n">train_end</span> <span class="o">=</span> <span class="n">______</span>
        <span class="n">train_indices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">______</span><span class="p">,</span> <span class="n">______</span><span class="p">))</span>
        
        <span class="c1"># TODO: Calculate test indices</span>
        <span class="n">test_start</span> <span class="o">=</span> <span class="n">______</span>
        <span class="n">test_end</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">start_idx</span> <span class="o">+</span> <span class="n">______</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">)</span>
        <span class="n">test_indices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">______</span><span class="p">,</span> <span class="n">______</span><span class="p">))</span>
        
        <span class="n">splits</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">train_indices</span><span class="p">,</span> <span class="n">test_indices</span><span class="p">))</span>
        
        <span class="c1"># TODO: Move to next fold</span>
        <span class="n">start_idx</span> <span class="o">+=</span> <span class="n">______</span>
    
    <span class="k">return</span> <span class="n">splits</span>

<span class="c1"># Test</span>
<span class="c1"># splits = walk_forward_split(1000, train_size=200, test_size=50, step_size=50)</span>
<span class="c1"># print(f&quot;Number of splits: {len(splits)}&quot;)</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 12.1</summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">walk_forward_split</span><span class="p">(</span><span class="n">n_samples</span><span class="p">,</span> <span class="n">train_size</span><span class="p">,</span> <span class="n">test_size</span><span class="p">,</span> <span class="n">step_size</span><span class="p">):</span>
    <span class="n">splits</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Start from end of first training window</span>
    <span class="n">start_idx</span> <span class="o">=</span> <span class="n">train_size</span>

    <span class="k">while</span> <span class="n">start_idx</span> <span class="o">+</span> <span class="n">test_size</span> <span class="o">&lt;=</span> <span class="n">n_samples</span><span class="p">:</span>
        <span class="c1"># Calculate train indices</span>
        <span class="n">train_start</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">start_idx</span> <span class="o">-</span> <span class="n">train_size</span><span class="p">)</span>
        <span class="n">train_end</span> <span class="o">=</span> <span class="n">start_idx</span>
        <span class="n">train_indices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">train_start</span><span class="p">,</span> <span class="n">train_end</span><span class="p">))</span>

        <span class="c1"># Calculate test indices</span>
        <span class="n">test_start</span> <span class="o">=</span> <span class="n">start_idx</span>
        <span class="n">test_end</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">start_idx</span> <span class="o">+</span> <span class="n">test_size</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">)</span>
        <span class="n">test_indices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">test_start</span><span class="p">,</span> <span class="n">test_end</span><span class="p">))</span>

        <span class="n">splits</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">train_indices</span><span class="p">,</span> <span class="n">test_indices</span><span class="p">))</span>

        <span class="c1"># Move to next fold</span>
        <span class="n">start_idx</span> <span class="o">+=</span> <span class="n">step_size</span>

    <span class="k">return</span> <span class="n">splits</span>
</code></pre></div>


</details></div>
<div class="md-cell exercise-header"><h3>Exercise 12.2: Calculate Strategy Metrics (Guided)</h3>
<p>Implement a function to calculate key performance metrics.</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 12.2: Calculate Strategy Metrics</span>
<span class="k">def</span> <span class="nf">calculate_strategy_metrics</span><span class="p">(</span><span class="n">returns</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate performance metrics from returns series.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        returns: numpy array or pandas Series of daily returns</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">returns</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">returns</span><span class="p">)</span>
    
    <span class="c1"># TODO: Calculate total return</span>
    <span class="n">total_return</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">returns</span><span class="p">)</span><span class="o">.</span><span class="n">______</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span>
    
    <span class="c1"># TODO: Calculate Sharpe ratio (annualized)</span>
    <span class="n">sharpe</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">______</span><span class="p">)</span> <span class="o">*</span> <span class="n">returns</span><span class="o">.</span><span class="n">______</span><span class="p">()</span> <span class="o">/</span> <span class="p">(</span><span class="n">returns</span><span class="o">.</span><span class="n">______</span><span class="p">()</span> <span class="o">+</span> <span class="mf">1e-8</span><span class="p">)</span>
    
    <span class="c1"># TODO: Calculate max drawdown</span>
    <span class="n">cumulative</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">returns</span><span class="p">)</span><span class="o">.</span><span class="n">______</span><span class="p">()</span>
    <span class="n">peak</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="o">.</span><span class="n">______</span><span class="p">(</span><span class="n">cumulative</span><span class="p">)</span>
    <span class="n">drawdown</span> <span class="o">=</span> <span class="p">(</span><span class="n">cumulative</span> <span class="o">-</span> <span class="n">peak</span><span class="p">)</span> <span class="o">/</span> <span class="n">______</span>
    <span class="n">max_dd</span> <span class="o">=</span> <span class="n">drawdown</span><span class="o">.</span><span class="n">______</span><span class="p">()</span>
    
    <span class="c1"># TODO: Calculate win rate</span>
    <span class="n">win_rate</span> <span class="o">=</span> <span class="p">(</span><span class="n">returns</span> <span class="n">______</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">______</span><span class="p">()</span>
    
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;total_return&#39;</span><span class="p">:</span> <span class="n">total_return</span><span class="p">,</span>
        <span class="s1">&#39;sharpe_ratio&#39;</span><span class="p">:</span> <span class="n">sharpe</span><span class="p">,</span>
        <span class="s1">&#39;max_drawdown&#39;</span><span class="p">:</span> <span class="n">max_dd</span><span class="p">,</span>
        <span class="s1">&#39;win_rate&#39;</span><span class="p">:</span> <span class="n">win_rate</span>
    <span class="p">}</span>

<span class="c1"># Test</span>
<span class="c1"># test_returns = np.random.normal(0.001, 0.02, 252)</span>
<span class="c1"># metrics = calculate_strategy_metrics(test_returns)</span>
<span class="c1"># print(metrics)</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 12.2</summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">calculate_strategy_metrics</span><span class="p">(</span><span class="n">returns</span><span class="p">):</span>
    <span class="n">returns</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">returns</span><span class="p">)</span>

    <span class="c1"># Calculate total return</span>
    <span class="n">total_return</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">returns</span><span class="p">)</span><span class="o">.</span><span class="n">prod</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span>

    <span class="c1"># Calculate Sharpe ratio (annualized)</span>
    <span class="n">sharpe</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span> <span class="o">*</span> <span class="n">returns</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">/</span> <span class="p">(</span><span class="n">returns</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">+</span> <span class="mf">1e-8</span><span class="p">)</span>

    <span class="c1"># Calculate max drawdown</span>
    <span class="n">cumulative</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">returns</span><span class="p">)</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span>
    <span class="n">peak</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="o">.</span><span class="n">accumulate</span><span class="p">(</span><span class="n">cumulative</span><span class="p">)</span>
    <span class="n">drawdown</span> <span class="o">=</span> <span class="p">(</span><span class="n">cumulative</span> <span class="o">-</span> <span class="n">peak</span><span class="p">)</span> <span class="o">/</span> <span class="n">peak</span>
    <span class="n">max_dd</span> <span class="o">=</span> <span class="n">drawdown</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>

    <span class="c1"># Calculate win rate</span>
    <span class="n">win_rate</span> <span class="o">=</span> <span class="p">(</span><span class="n">returns</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;total_return&#39;</span><span class="p">:</span> <span class="n">total_return</span><span class="p">,</span>
        <span class="s1">&#39;sharpe_ratio&#39;</span><span class="p">:</span> <span class="n">sharpe</span><span class="p">,</span>
        <span class="s1">&#39;max_drawdown&#39;</span><span class="p">:</span> <span class="n">max_dd</span><span class="p">,</span>
        <span class="s1">&#39;win_rate&#39;</span><span class="p">:</span> <span class="n">win_rate</span>
    <span class="p">}</span>
</code></pre></div>


</details></div>
<div class="md-cell exercise-header"><h3>Exercise 12.3: Implement Transaction Cost Calculator (Guided)</h3>
<p>Create a function that calculates transaction costs for a signal series.</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 12.3: Implement Transaction Cost Calculator</span>
<span class="k">def</span> <span class="nf">calculate_transaction_costs</span><span class="p">(</span><span class="n">signals</span><span class="p">,</span> <span class="n">prices</span><span class="p">,</span> <span class="n">commission</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">slippage</span><span class="o">=</span><span class="mf">0.0005</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate transaction costs from signals.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        signals: array of trading signals (1, -1, 0)</span>
<span class="sd">        prices: array of prices</span>
<span class="sd">        commission: commission rate per trade</span>
<span class="sd">        slippage: expected slippage per trade</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">signals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">signals</span><span class="p">)</span>
    <span class="n">prices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span>
    
    <span class="c1"># TODO: Calculate position changes</span>
    <span class="n">position_changes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">______</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">______</span><span class="p">(</span><span class="n">signals</span><span class="p">))</span>
    <span class="n">position_changes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">position_changes</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">abs</span><span class="p">(</span><span class="n">signals</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>  <span class="c1"># Initial position</span>
    
    <span class="c1"># TODO: Calculate trade values</span>
    <span class="n">trade_values</span> <span class="o">=</span> <span class="n">position_changes</span> <span class="o">*</span> <span class="n">______</span>
    
    <span class="c1"># TODO: Calculate costs</span>
    <span class="n">costs</span> <span class="o">=</span> <span class="n">trade_values</span> <span class="o">*</span> <span class="p">(</span><span class="n">______</span> <span class="o">+</span> <span class="n">______</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;total_cost&#39;</span><span class="p">:</span> <span class="n">costs</span><span class="o">.</span><span class="n">______</span><span class="p">(),</span>
        <span class="s1">&#39;n_trades&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">position_changes</span> <span class="n">______</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">______</span><span class="p">(),</span>
        <span class="s1">&#39;costs_per_trade&#39;</span><span class="p">:</span> <span class="n">costs</span>
    <span class="p">}</span>

<span class="c1"># Test</span>
<span class="c1"># test_signals = np.array([1, 1, -1, -1, 1, 0, 1])</span>
<span class="c1"># test_prices = np.array([100, 101, 102, 101, 100, 99, 100])</span>
<span class="c1"># costs = calculate_transaction_costs(test_signals, test_prices)</span>
<span class="c1"># print(costs)</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 12.3</summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">calculate_transaction_costs</span><span class="p">(</span><span class="n">signals</span><span class="p">,</span> <span class="n">prices</span><span class="p">,</span> <span class="n">commission</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">slippage</span><span class="o">=</span><span class="mf">0.0005</span><span class="p">):</span>
    <span class="n">signals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">signals</span><span class="p">)</span>
    <span class="n">prices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span>

    <span class="c1"># Calculate position changes</span>
    <span class="n">position_changes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">signals</span><span class="p">))</span>
    <span class="n">position_changes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">position_changes</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">abs</span><span class="p">(</span><span class="n">signals</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

    <span class="c1"># Calculate trade values</span>
    <span class="n">trade_values</span> <span class="o">=</span> <span class="n">position_changes</span> <span class="o">*</span> <span class="n">prices</span>

    <span class="c1"># Calculate costs</span>
    <span class="n">costs</span> <span class="o">=</span> <span class="n">trade_values</span> <span class="o">*</span> <span class="p">(</span><span class="n">commission</span> <span class="o">+</span> <span class="n">slippage</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;total_cost&#39;</span><span class="p">:</span> <span class="n">costs</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span>
        <span class="s1">&#39;n_trades&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">position_changes</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span>
        <span class="s1">&#39;costs_per_trade&#39;</span><span class="p">:</span> <span class="n">costs</span>
    <span class="p">}</span>
</code></pre></div>


</details></div>
<div class="md-cell exercise-header"><h3>Exercise 12.4: Build Expanding Window Backtester (Open-ended)</h3>
<p>Create a backtester that uses expanding training windows instead of fixed rolling windows.</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 12.4: Build Expanding Window Backtester</span>
<span class="c1"># TODO: Create an expanding window backtester that:</span>
<span class="c1"># - Starts with minimum training samples</span>
<span class="c1"># - Adds all historical data to training as time progresses</span>
<span class="c1"># - Tests on fixed-size test windows</span>
<span class="c1"># - Compares results with rolling window approach</span>

<span class="c1"># Your code here</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 12.4</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">ExpandingWindowBacktester</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">min_train_samples</span><span class="o">=</span><span class="mi">252</span><span class="p">,</span> <span class="n">test_window</span><span class="o">=</span><span class="mi">21</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_train_samples</span> <span class="o">=</span> <span class="n">min_train_samples</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_window</span> <span class="o">=</span> <span class="n">test_window</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="n">n_samples</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="n">predictions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">n_samples</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>

        <span class="n">start_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_train_samples</span>

        <span class="k">while</span> <span class="n">start_idx</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_window</span> <span class="o">&lt;=</span> <span class="n">n_samples</span><span class="p">:</span>
            <span class="c1"># Expanding window: use ALL data from beginning</span>
            <span class="n">train_start</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Always start from beginning</span>
            <span class="n">train_end</span> <span class="o">=</span> <span class="n">start_idx</span>
            <span class="n">test_start</span> <span class="o">=</span> <span class="n">start_idx</span>
            <span class="n">test_end</span> <span class="o">=</span> <span class="n">start_idx</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_window</span>

            <span class="n">X_train</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">train_start</span><span class="p">:</span><span class="n">train_end</span><span class="p">]</span>
            <span class="n">y_train</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">train_start</span><span class="p">:</span><span class="n">train_end</span><span class="p">]</span>
            <span class="n">X_test</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">test_start</span><span class="p">:</span><span class="n">test_end</span><span class="p">]</span>
            <span class="n">y_test</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">test_start</span><span class="p">:</span><span class="n">test_end</span><span class="p">]</span>

            <span class="n">X_train_scaled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
            <span class="n">X_test_scaled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_scaled</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
            <span class="n">pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test_scaled</span><span class="p">)</span>

            <span class="n">predictions</span><span class="p">[</span><span class="n">test_start</span><span class="p">:</span><span class="n">test_end</span><span class="p">]</span> <span class="o">=</span> <span class="n">pred</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;train_size&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">X_train</span><span class="p">),</span>
                <span class="s1">&#39;accuracy&#39;</span><span class="p">:</span> <span class="n">accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">pred</span><span class="p">)</span>
            <span class="p">})</span>

            <span class="n">start_idx</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_window</span>

        <span class="k">return</span> <span class="n">predictions</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">)</span>

<span class="c1"># Compare with rolling</span>
<span class="n">expanding</span> <span class="o">=</span> <span class="n">ExpandingWindowBacktester</span><span class="p">(</span>
    <span class="n">RandomForestClassifier</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">),</span>
    <span class="n">min_train_samples</span><span class="o">=</span><span class="mi">252</span>
<span class="p">)</span>
<span class="n">exp_pred</span><span class="p">,</span> <span class="n">exp_results</span> <span class="o">=</span> <span class="n">expanding</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Expanding window avg accuracy: </span><span class="si">{</span><span class="n">exp_results</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell exercise-header"><h3>Exercise 12.5: Implement Bootstrap Confidence Intervals (Open-ended)</h3>
<p>Create a function that calculates bootstrap confidence intervals for strategy metrics.</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 12.5: Implement Bootstrap Confidence Intervals</span>
<span class="c1"># TODO: Create a function that:</span>
<span class="c1"># - Resamples returns with replacement</span>
<span class="c1"># - Calculates Sharpe ratio for each bootstrap sample</span>
<span class="c1"># - Returns confidence intervals (e.g., 5th and 95th percentile)</span>
<span class="c1"># - Determines if strategy is significantly better than zero</span>

<span class="c1"># Your code here</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 12.5</summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">bootstrap_confidence_intervals</span><span class="p">(</span><span class="n">returns</span><span class="p">,</span> <span class="n">n_bootstrap</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">confidence_level</span><span class="o">=</span><span class="mf">0.95</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Calculate bootstrap confidence intervals for strategy metrics.&quot;&quot;&quot;</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
    <span class="n">returns</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">returns</span><span class="p">)</span>
    <span class="n">n_samples</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">returns</span><span class="p">)</span>

    <span class="n">bootstrap_sharpes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">bootstrap_returns</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_bootstrap</span><span class="p">):</span>
        <span class="c1"># Resample with replacement</span>
        <span class="n">sample_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">n_samples</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">n_samples</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">sample_returns</span> <span class="o">=</span> <span class="n">returns</span><span class="p">[</span><span class="n">sample_indices</span><span class="p">]</span>

        <span class="c1"># Calculate metrics</span>
        <span class="n">sharpe</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span> <span class="o">*</span> <span class="n">sample_returns</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">/</span> <span class="p">(</span><span class="n">sample_returns</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">+</span> <span class="mf">1e-8</span><span class="p">)</span>
        <span class="n">total_ret</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">sample_returns</span><span class="p">)</span><span class="o">.</span><span class="n">prod</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span>

        <span class="n">bootstrap_sharpes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sharpe</span><span class="p">)</span>
        <span class="n">bootstrap_returns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">total_ret</span><span class="p">)</span>

    <span class="c1"># Calculate confidence intervals</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">confidence_level</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>

    <span class="n">sharpe_ci</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">bootstrap_sharpes</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">*</span> <span class="mi">100</span><span class="p">),</span>
        <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">bootstrap_sharpes</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">alpha</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="n">return_ci</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">bootstrap_returns</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">*</span> <span class="mi">100</span><span class="p">),</span>
        <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">bootstrap_returns</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">alpha</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># Is significantly positive?</span>
    <span class="n">sharpe_significant</span> <span class="o">=</span> <span class="n">sharpe_ci</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;sharpe_ci&#39;</span><span class="p">:</span> <span class="n">sharpe_ci</span><span class="p">,</span>
        <span class="s1">&#39;return_ci&#39;</span><span class="p">:</span> <span class="n">return_ci</span><span class="p">,</span>
        <span class="s1">&#39;sharpe_significant&#39;</span><span class="p">:</span> <span class="n">sharpe_significant</span><span class="p">,</span>
        <span class="s1">&#39;original_sharpe&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span> <span class="o">*</span> <span class="n">returns</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">/</span> <span class="n">returns</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
    <span class="p">}</span>

<span class="c1"># Test</span>
<span class="n">strategy_returns</span> <span class="o">=</span> <span class="n">backtest_results</span><span class="p">[</span><span class="s1">&#39;capital&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>
<span class="n">ci_results</span> <span class="o">=</span> <span class="n">bootstrap_confidence_intervals</span><span class="p">(</span><span class="n">strategy_returns</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sharpe 95% CI: (</span><span class="si">{</span><span class="n">ci_results</span><span class="p">[</span><span class="s1">&#39;sharpe_ci&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">ci_results</span><span class="p">[</span><span class="s1">&#39;sharpe_ci&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Statistically significant: </span><span class="si">{</span><span class="n">ci_results</span><span class="p">[</span><span class="s1">&#39;sharpe_significant&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell exercise-header"><h3>Exercise 12.6: Build Regime-Aware Backtester (Open-ended)</h3>
<p>Create a backtester that tracks performance across different market regimes.</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 12.6: Build Regime-Aware Backtester</span>
<span class="c1"># TODO: Create a backtester that:</span>
<span class="c1"># - Identifies market regimes (bull/bear/sideways)</span>
<span class="c1"># - Tracks strategy performance in each regime</span>
<span class="c1"># - Reports regime-specific metrics</span>
<span class="c1"># - Helps identify if strategy works in all conditions</span>

<span class="c1"># Your code here</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 12.6</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">RegimeAwareBacktester</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lookback</span><span class="o">=</span><span class="mi">63</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lookback</span> <span class="o">=</span> <span class="n">lookback</span>

    <span class="k">def</span> <span class="nf">identify_regimes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prices</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Identify market regimes based on price trend.&quot;&quot;&quot;</span>
        <span class="n">returns</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span>
        <span class="n">rolling_return</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lookback</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">*</span> <span class="mi">252</span>
        <span class="n">rolling_vol</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lookback</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span>

        <span class="n">regimes</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">prices</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">prices</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">rolling_return</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
                <span class="n">regimes</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;unknown&#39;</span>
            <span class="k">elif</span> <span class="n">rolling_return</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.1</span><span class="p">:</span>  <span class="c1"># &gt;10% annualized</span>
                <span class="n">regimes</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;bull&#39;</span>
            <span class="k">elif</span> <span class="n">rolling_return</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">0.1</span><span class="p">:</span>  <span class="c1"># &lt;-10% annualized</span>
                <span class="n">regimes</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;bear&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">regimes</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;sideways&#39;</span>

        <span class="k">return</span> <span class="n">regimes</span>

    <span class="k">def</span> <span class="nf">analyze_by_regime</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">strategy_returns</span><span class="p">,</span> <span class="n">prices</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Analyze strategy performance by regime.&quot;&quot;&quot;</span>
        <span class="n">regimes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">identify_regimes</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span>

        <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">regime</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;bull&#39;</span><span class="p">,</span> <span class="s1">&#39;bear&#39;</span><span class="p">,</span> <span class="s1">&#39;sideways&#39;</span><span class="p">]:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">regimes</span> <span class="o">==</span> <span class="n">regime</span>
            <span class="n">regime_returns</span> <span class="o">=</span> <span class="n">strategy_returns</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">regime_returns</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">results</span><span class="p">[</span><span class="n">regime</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;n_days&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">regime_returns</span><span class="p">),</span>
                    <span class="s1">&#39;total_return&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">regime_returns</span><span class="p">)</span><span class="o">.</span><span class="n">prod</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
                    <span class="s1">&#39;sharpe&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span> <span class="o">*</span> <span class="n">regime_returns</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">/</span> <span class="p">(</span><span class="n">regime_returns</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">+</span> <span class="mf">1e-8</span><span class="p">),</span>
                    <span class="s1">&#39;win_rate&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">regime_returns</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
                <span class="p">}</span>

        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

<span class="c1"># Usage</span>
<span class="n">regime_analyzer</span> <span class="o">=</span> <span class="n">RegimeAwareBacktester</span><span class="p">(</span><span class="n">lookback</span><span class="o">=</span><span class="mi">63</span><span class="p">)</span>
<span class="n">strategy_rets</span> <span class="o">=</span> <span class="n">backtest_results</span><span class="p">[</span><span class="s1">&#39;capital&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>
<span class="n">prices</span> <span class="o">=</span> <span class="n">backtest_results</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
<span class="n">regime_results</span> <span class="o">=</span> <span class="n">regime_analyzer</span><span class="o">.</span><span class="n">analyze_by_regime</span><span class="p">(</span><span class="n">strategy_rets</span><span class="p">,</span> <span class="n">prices</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Performance by Regime:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">regime_results</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell key-takeaways"><hr />
<h2>Summary</h2>
<p>In this module, you learned:</p>
<ol>
<li>
<p><strong>Walk-Forward Optimization</strong>: Proper methodology for testing ML strategies on unseen data</p>
</li>
<li>
<p><strong>Avoiding Pitfalls</strong>: Look-ahead bias, survivorship bias, and overfitting detection</p>
</li>
<li>
<p><strong>Realistic Backtesting</strong>: Accounting for transaction costs, slippage, and execution</p>
</li>
<li>
<p><strong>Robustness Testing</strong>: Monte Carlo simulations and parameter sensitivity analysis</p>
</li>
<li>
<p><strong>Complete Systems</strong>: Building production-ready backtesting frameworks</p>
</li>
</ol>
<h2>Key Takeaways</h2>
<ul>
<li>Walk-forward validation is essential for ML strategies to avoid look-ahead bias</li>
<li>Transaction costs can significantly impact strategy performance</li>
<li>Monte Carlo tests help distinguish skill from luck</li>
<li>Overfitting is the #1 enemy of ML trading strategies</li>
<li>Always test robustness before deploying any strategy</li>
</ul>
<h2>Next Steps</h2>
<p>In Module 13, you'll learn about deploying ML models to production, including feature pipelines, model monitoring, and system architecture.</p></div>
        <div class="nav-buttons">
            <button class="nav-btn prev-btn disabled" type="button">
                <span class="nav-btn-label">‚Üê Previous</span>
                <span class="nav-btn-name"></span>
            </button>
            <button class="nav-btn next-btn disabled" type="button">
                <span class="nav-btn-label">Next ‚Üí</span>
                <span class="nav-btn-name"></span>
            </button>
        </div>
        </div>
<div class="module-section" data-idx="13"><div class="md-cell module-header"><h1>Module 13: Production ML Systems</h1>
<h2>Overview</h2>
<p>Moving ML models from research to production requires careful engineering. This module covers the infrastructure, pipelines, and monitoring needed to deploy ML trading systems reliably.</p>
<h2>Learning Objectives</h2>
<p>By the end of this module, you will be able to:
- Design feature pipelines for real-time prediction
- Implement model versioning and deployment strategies
- Build monitoring systems to detect model degradation
- Create robust error handling and fallback mechanisms</p>
<h2>Prerequisites</h2>
<ul>
<li>Module 11: Deep Learning for Finance</li>
<li>Module 12: Backtesting ML Strategies</li>
<li>Basic understanding of software engineering principles</li>
</ul>
<h2>Estimated Time: 3.5 hours</h2></div>
<div class="md-cell"><hr />
<h2>Section 1: Feature Pipeline Architecture</h2>
<p>A robust feature pipeline ensures consistent feature computation between training and inference.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span>
<span class="kn">from</span> <span class="nn">abc</span> <span class="kn">import</span> <span class="n">ABC</span><span class="p">,</span> <span class="n">abstractmethod</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">RandomForestClassifier</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">StandardScaler</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>

<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Production ML libraries loaded&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Feature Definition Framework</span>
<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">FeatureDefinition</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Defines a single feature for the pipeline.&quot;&quot;&quot;</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">feature_type</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1"># &#39;price&#39;, &#39;volume&#39;, &#39;technical&#39;, &#39;derived&#39;</span>
    <span class="n">lookback_periods</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">dependencies</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
    <span class="n">params</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="s1">&#39;feature_type&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_type</span><span class="p">,</span>
            <span class="s1">&#39;lookback_periods&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookback_periods</span><span class="p">,</span>
            <span class="s1">&#39;dependencies&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="p">,</span>
            <span class="s1">&#39;params&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
        <span class="p">}</span>


<span class="k">class</span> <span class="nc">FeatureRegistry</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Central registry for all feature definitions.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">FeatureDefinition</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">computation_order</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        
    <span class="k">def</span> <span class="nf">register</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feature</span><span class="p">:</span> <span class="n">FeatureDefinition</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Register a feature definition.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="n">feature</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">feature</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_computation_order</span><span class="p">()</span>
        
    <span class="k">def</span> <span class="nf">_update_computation_order</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Topologically sort features based on dependencies.&quot;&quot;&quot;</span>
        <span class="n">visited</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">order</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">def</span> <span class="nf">visit</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">visited</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="n">visited</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">dep</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">dependencies</span><span class="p">:</span>
                    <span class="n">visit</span><span class="p">(</span><span class="n">dep</span><span class="p">)</span>
                <span class="n">order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">:</span>
            <span class="n">visit</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">computation_order</span> <span class="o">=</span> <span class="n">order</span>
    
    <span class="k">def</span> <span class="nf">get_max_lookback</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get maximum lookback period needed.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">lookback_periods</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
    
    <span class="k">def</span> <span class="nf">get_feature_hash</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Generate hash of feature definitions for versioning.&quot;&quot;&quot;</span>
        <span class="n">feature_str</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
            <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">f</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">items</span><span class="p">())},</span>
            <span class="n">sort_keys</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="n">feature_str</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()[:</span><span class="mi">8</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Feature definition framework created&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Feature Computation Engine</span>
<span class="k">class</span> <span class="nc">FeatureComputer</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Abstract base class for feature computation.&quot;&quot;&quot;</span>
    
    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">compute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
        <span class="k">pass</span>


<span class="k">class</span> <span class="nc">ReturnFeature</span><span class="p">(</span><span class="n">FeatureComputer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Compute return features.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="nf">compute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
        <span class="n">period</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;period&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">(</span><span class="n">period</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">VolatilityFeature</span><span class="p">(</span><span class="n">FeatureComputer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Compute volatility features.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="nf">compute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
        <span class="n">period</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;period&#39;</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
        <span class="n">returns</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">returns</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">period</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">SMAFeature</span><span class="p">(</span><span class="n">FeatureComputer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Compute simple moving average features.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="nf">compute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
        <span class="n">period</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;period&#39;</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">period</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">RSIFeature</span><span class="p">(</span><span class="n">FeatureComputer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Compute RSI feature.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="nf">compute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
        <span class="n">period</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;period&#39;</span><span class="p">,</span> <span class="mi">14</span><span class="p">)</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span>
        <span class="n">gain</span> <span class="o">=</span> <span class="p">(</span><span class="n">delta</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">delta</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">period</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">delta</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">delta</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">period</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">rs</span> <span class="o">=</span> <span class="n">gain</span> <span class="o">/</span> <span class="p">(</span><span class="n">loss</span> <span class="o">+</span> <span class="mf">1e-10</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">100</span> <span class="o">-</span> <span class="p">(</span><span class="mi">100</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">rs</span><span class="p">))</span>


<span class="k">class</span> <span class="nc">MACDFeature</span><span class="p">(</span><span class="n">FeatureComputer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Compute MACD feature.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="nf">compute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
        <span class="n">fast</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fast&#39;</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span>
        <span class="n">slow</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;slow&#39;</span><span class="p">,</span> <span class="mi">26</span><span class="p">)</span>
        <span class="n">exp_fast</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">ewm</span><span class="p">(</span><span class="n">span</span><span class="o">=</span><span class="n">fast</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">exp_slow</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">ewm</span><span class="p">(</span><span class="n">span</span><span class="o">=</span><span class="n">slow</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">exp_fast</span> <span class="o">-</span> <span class="n">exp_slow</span>


<span class="k">class</span> <span class="nc">PriceToSMAFeature</span><span class="p">(</span><span class="n">FeatureComputer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Compute price relative to SMA.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="nf">compute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
        <span class="n">period</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;period&#39;</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
        <span class="n">sma</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">period</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">sma</span>


<span class="c1"># Feature Computer Registry</span>
<span class="n">FEATURE_COMPUTERS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;return&#39;</span><span class="p">:</span> <span class="n">ReturnFeature</span><span class="p">(),</span>
    <span class="s1">&#39;volatility&#39;</span><span class="p">:</span> <span class="n">VolatilityFeature</span><span class="p">(),</span>
    <span class="s1">&#39;sma&#39;</span><span class="p">:</span> <span class="n">SMAFeature</span><span class="p">(),</span>
    <span class="s1">&#39;rsi&#39;</span><span class="p">:</span> <span class="n">RSIFeature</span><span class="p">(),</span>
    <span class="s1">&#39;macd&#39;</span><span class="p">:</span> <span class="n">MACDFeature</span><span class="p">(),</span>
    <span class="s1">&#39;price_to_sma&#39;</span><span class="p">:</span> <span class="n">PriceToSMAFeature</span><span class="p">()</span>
<span class="p">}</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Feature computers registered&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Production Feature Pipeline</span>
<span class="k">class</span> <span class="nc">FeaturePipeline</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Production-ready feature pipeline.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">registry</span><span class="p">:</span> <span class="n">FeatureRegistry</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registry</span> <span class="o">=</span> <span class="n">registry</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_fitted</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_stats</span> <span class="o">=</span> <span class="p">{}</span>
        
    <span class="k">def</span> <span class="nf">compute_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Compute all registered features.&quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        
        <span class="k">for</span> <span class="n">feature_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">computation_order</span><span class="p">:</span>
            <span class="n">feature_def</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="n">feature_name</span><span class="p">]</span>
            <span class="n">computer</span> <span class="o">=</span> <span class="n">FEATURE_COMPUTERS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">feature_def</span><span class="o">.</span><span class="n">feature_type</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">computer</span><span class="p">:</span>
                <span class="n">result</span><span class="p">[</span><span class="n">feature_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">computer</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">feature_def</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">result</span>
    
    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Fit the pipeline on training data.&quot;&quot;&quot;</span>
        <span class="n">features_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_features</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="n">feature_cols</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        
        <span class="c1"># Store feature statistics</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">feature_cols</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">feature_stats</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;mean&#39;</span><span class="p">:</span> <span class="n">features_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
                <span class="s1">&#39;std&#39;</span><span class="p">:</span> <span class="n">features_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">(),</span>
                <span class="s1">&#39;min&#39;</span><span class="p">:</span> <span class="n">features_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span>
                <span class="s1">&#39;max&#39;</span><span class="p">:</span> <span class="n">features_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="p">}</span>
        
        <span class="c1"># Fit scaler</span>
        <span class="n">valid_data</span> <span class="o">=</span> <span class="n">features_df</span><span class="p">[</span><span class="n">feature_cols</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scaler</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">valid_data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_fitted</span> <span class="o">=</span> <span class="kc">True</span>
        
    <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Transform data using fitted pipeline.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_fitted</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Pipeline not fitted. Call fit() first.&quot;</span><span class="p">)</span>
        
        <span class="n">features_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_features</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="n">feature_cols</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        
        <span class="c1"># Scale features</span>
        <span class="n">valid_mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">features_df</span><span class="p">[</span><span class="n">feature_cols</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">features_df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">result</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">,</span> <span class="n">feature_cols</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span>
            <span class="n">features_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">,</span> <span class="n">feature_cols</span><span class="p">]</span>
        <span class="p">)</span>
        
        <span class="k">return</span> <span class="n">result</span>
    
    <span class="k">def</span> <span class="nf">fit_transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Fit and transform in one step.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">get_feature_vector</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get feature vector for prediction.&quot;&quot;&quot;</span>
        <span class="n">transformed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="n">feature_cols</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">transformed</span><span class="p">[</span><span class="n">feature_cols</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    
    <span class="k">def</span> <span class="nf">validate_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Validate features against training statistics.&quot;&quot;&quot;</span>
        <span class="n">features_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_features</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="n">validation_results</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="k">for</span> <span class="n">col</span><span class="p">,</span> <span class="n">stats</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_stats</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">current_value</span> <span class="o">=</span> <span class="n">features_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            
            <span class="c1"># Check for outliers</span>
            <span class="n">z_score</span> <span class="o">=</span> <span class="p">(</span><span class="n">current_value</span> <span class="o">-</span> <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;std&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mf">1e-10</span><span class="p">)</span>
            <span class="n">is_outlier</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">z_score</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span>
            
            <span class="n">validation_results</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">current_value</span><span class="p">,</span>
                <span class="s1">&#39;z_score&#39;</span><span class="p">:</span> <span class="n">z_score</span><span class="p">,</span>
                <span class="s1">&#39;is_outlier&#39;</span><span class="p">:</span> <span class="n">is_outlier</span>
            <span class="p">}</span>
        
        <span class="k">return</span> <span class="n">validation_results</span>
    
    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Save pipeline to file.&quot;&quot;&quot;</span>
        <span class="n">state</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;registry&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="p">,</span>
            <span class="s1">&#39;scaler&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaler</span><span class="p">,</span>
            <span class="s1">&#39;feature_stats&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_stats</span><span class="p">,</span>
            <span class="s1">&#39;is_fitted&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_fitted</span><span class="p">,</span>
            <span class="s1">&#39;feature_hash&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">get_feature_hash</span><span class="p">()</span>
        <span class="p">}</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
    
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">filepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;FeaturePipeline&#39;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Load pipeline from file.&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">state</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        
        <span class="n">pipeline</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;registry&#39;</span><span class="p">])</span>
        <span class="n">pipeline</span><span class="o">.</span><span class="n">scaler</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s1">&#39;scaler&#39;</span><span class="p">]</span>
        <span class="n">pipeline</span><span class="o">.</span><span class="n">feature_stats</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s1">&#39;feature_stats&#39;</span><span class="p">]</span>
        <span class="n">pipeline</span><span class="o">.</span><span class="n">is_fitted</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s1">&#39;is_fitted&#39;</span><span class="p">]</span>
        
        <span class="k">return</span> <span class="n">pipeline</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;FeaturePipeline class defined&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Create and test feature pipeline</span>
<span class="c1"># Generate sample data</span>
<span class="k">def</span> <span class="nf">generate_sample_data</span><span class="p">(</span><span class="n">n_samples</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
    <span class="n">dates</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="s1">&#39;2020-01-01&#39;</span><span class="p">,</span> <span class="n">periods</span><span class="o">=</span><span class="n">n_samples</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;D&#39;</span><span class="p">)</span>
    <span class="n">returns</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mf">0.0003</span><span class="p">,</span> <span class="mf">0.015</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">)</span>
    <span class="n">prices</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">returns</span><span class="p">))</span>
    
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
        <span class="s1">&#39;date&#39;</span><span class="p">:</span> <span class="n">dates</span><span class="p">,</span>
        <span class="s1">&#39;open&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">prices</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="s1">&#39;high&#39;</span><span class="p">:</span> <span class="n">prices</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">))),</span>
        <span class="s1">&#39;low&#39;</span><span class="p">:</span> <span class="n">prices</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">))),</span>
        <span class="s1">&#39;close&#39;</span><span class="p">:</span> <span class="n">prices</span><span class="p">,</span>
        <span class="s1">&#39;volume&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">lognormal</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">)</span>
    <span class="p">})</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;date&#39;</span><span class="p">)</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">generate_sample_data</span><span class="p">()</span>

<span class="c1"># Create feature registry</span>
<span class="n">registry</span> <span class="o">=</span> <span class="n">FeatureRegistry</span><span class="p">()</span>

<span class="c1"># Register features</span>
<span class="n">registry</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">FeatureDefinition</span><span class="p">(</span><span class="s1">&#39;return_1d&#39;</span><span class="p">,</span> <span class="s1">&#39;return&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;period&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}))</span>
<span class="n">registry</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">FeatureDefinition</span><span class="p">(</span><span class="s1">&#39;return_5d&#39;</span><span class="p">,</span> <span class="s1">&#39;return&#39;</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;period&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">}))</span>
<span class="n">registry</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">FeatureDefinition</span><span class="p">(</span><span class="s1">&#39;volatility_20d&#39;</span><span class="p">,</span> <span class="s1">&#39;volatility&#39;</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;period&#39;</span><span class="p">:</span> <span class="mi">20</span><span class="p">}))</span>
<span class="n">registry</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">FeatureDefinition</span><span class="p">(</span><span class="s1">&#39;rsi&#39;</span><span class="p">,</span> <span class="s1">&#39;rsi&#39;</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;period&#39;</span><span class="p">:</span> <span class="mi">14</span><span class="p">}))</span>
<span class="n">registry</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">FeatureDefinition</span><span class="p">(</span><span class="s1">&#39;macd&#39;</span><span class="p">,</span> <span class="s1">&#39;macd&#39;</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;fast&#39;</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span> <span class="s1">&#39;slow&#39;</span><span class="p">:</span> <span class="mi">26</span><span class="p">}))</span>
<span class="n">registry</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">FeatureDefinition</span><span class="p">(</span><span class="s1">&#39;price_to_sma_20&#39;</span><span class="p">,</span> <span class="s1">&#39;price_to_sma&#39;</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;period&#39;</span><span class="p">:</span> <span class="mi">20</span><span class="p">}))</span>

<span class="c1"># Create pipeline</span>
<span class="n">pipeline</span> <span class="o">=</span> <span class="n">FeaturePipeline</span><span class="p">(</span><span class="n">registry</span><span class="p">)</span>

<span class="c1"># Fit on training data</span>
<span class="n">train_df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="mi">800</span><span class="p">]</span>
<span class="n">test_df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">800</span><span class="p">:]</span>

<span class="n">pipeline</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_df</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Feature hash: </span><span class="si">{</span><span class="n">registry</span><span class="o">.</span><span class="n">get_feature_hash</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Max lookback: </span><span class="si">{</span><span class="n">registry</span><span class="o">.</span><span class="n">get_max_lookback</span><span class="p">()</span><span class="si">}</span><span class="s2"> days&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Computation order: </span><span class="si">{</span><span class="n">registry</span><span class="o">.</span><span class="n">computation_order</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><hr />
<h2>Section 2: Model Versioning and Deployment</h2>
<p>Proper model versioning ensures reproducibility and enables rollback if needed.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Model Versioning System</span>
<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">ModelVersion</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Represents a versioned model.&quot;&quot;&quot;</span>
    <span class="n">version_id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">model_type</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">feature_hash</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">created_at</span><span class="p">:</span> <span class="n">datetime</span>
    <span class="n">metrics</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span>
    <span class="n">hyperparameters</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
    <span class="n">is_active</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    
    <span class="k">def</span> <span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;version_id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">version_id</span><span class="p">,</span>
            <span class="s1">&#39;model_type&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_type</span><span class="p">,</span>
            <span class="s1">&#39;feature_hash&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_hash</span><span class="p">,</span>
            <span class="s1">&#39;created_at&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">created_at</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
            <span class="s1">&#39;metrics&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">,</span>
            <span class="s1">&#39;hyperparameters&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">hyperparameters</span><span class="p">,</span>
            <span class="s1">&#39;is_active&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_active</span>
        <span class="p">}</span>


<span class="k">class</span> <span class="nc">ModelRegistry</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Registry for model versions.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">versions</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ModelVersion</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">active_version</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        
    <span class="k">def</span> <span class="nf">register_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">version</span><span class="p">:</span> <span class="n">ModelVersion</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Register a new model version.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">versions</span><span class="p">[</span><span class="n">version</span><span class="o">.</span><span class="n">version_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">version</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="n">version</span><span class="o">.</span><span class="n">version_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Registered model version: </span><span class="si">{</span><span class="n">version</span><span class="o">.</span><span class="n">version_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">activate_version</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">version_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Activate a specific model version.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">version_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">versions</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Version </span><span class="si">{</span><span class="n">version_id</span><span class="si">}</span><span class="s2"> not found&quot;</span><span class="p">)</span>
        
        <span class="c1"># Deactivate current</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_version</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">versions</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">active_version</span><span class="p">]</span><span class="o">.</span><span class="n">is_active</span> <span class="o">=</span> <span class="kc">False</span>
        
        <span class="c1"># Activate new</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">versions</span><span class="p">[</span><span class="n">version_id</span><span class="p">]</span><span class="o">.</span><span class="n">is_active</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">active_version</span> <span class="o">=</span> <span class="n">version_id</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Activated version: </span><span class="si">{</span><span class="n">version_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">get_active_model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the currently active model.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_version</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No active model version&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">active_version</span><span class="p">]</span>
    
    <span class="k">def</span> <span class="nf">get_version_history</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get version history as dataframe.&quot;&quot;&quot;</span>
        <span class="n">records</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">versions</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">records</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">rollback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">version_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Rollback to a previous version.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">version_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">versions</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Version </span><span class="si">{</span><span class="n">version_id</span><span class="si">}</span><span class="s2"> not found&quot;</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">activate_version</span><span class="p">(</span><span class="n">version_id</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Rolled back to version: </span><span class="si">{</span><span class="n">version_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">compare_versions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">version_ids</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Compare metrics across versions.&quot;&quot;&quot;</span>
        <span class="n">comparisons</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">vid</span> <span class="ow">in</span> <span class="n">version_ids</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">vid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">versions</span><span class="p">:</span>
                <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">versions</span><span class="p">[</span><span class="n">vid</span><span class="p">]</span>
                <span class="n">record</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;version_id&#39;</span><span class="p">:</span> <span class="n">vid</span><span class="p">,</span> <span class="o">**</span><span class="n">v</span><span class="o">.</span><span class="n">metrics</span><span class="p">}</span>
                <span class="n">comparisons</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">comparisons</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Model versioning system defined&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Model Deployment Manager</span>
<span class="k">class</span> <span class="nc">ModelDeploymentManager</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Manages model deployment lifecycle.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_registry</span><span class="p">:</span> <span class="n">ModelRegistry</span><span class="p">,</span> 
                 <span class="n">feature_pipeline</span><span class="p">:</span> <span class="n">FeaturePipeline</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_registry</span> <span class="o">=</span> <span class="n">model_registry</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_pipeline</span> <span class="o">=</span> <span class="n">feature_pipeline</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deployment_history</span> <span class="o">=</span> <span class="p">[]</span>
        
    <span class="k">def</span> <span class="nf">train_new_version</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">train_data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> 
                          <span class="n">model_class</span><span class="p">,</span> <span class="n">hyperparameters</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span>
                          <span class="n">target_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;target&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Train and register a new model version.&quot;&quot;&quot;</span>
        <span class="c1"># Prepare features</span>
        <span class="n">features_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_pipeline</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">train_data</span><span class="p">)</span>
        <span class="n">feature_cols</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">feature_pipeline</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        
        <span class="c1"># Prepare target</span>
        <span class="n">features_df</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">features_df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> 
                                  <span class="n">features_df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        
        <span class="c1"># Remove NaN</span>
        <span class="n">valid_data</span> <span class="o">=</span> <span class="n">features_df</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">valid_data</span><span class="p">[</span><span class="n">feature_cols</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">valid_data</span><span class="p">[</span><span class="n">target_col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        
        <span class="c1"># Train model</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">model_class</span><span class="p">(</span><span class="o">**</span><span class="n">hyperparameters</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        
        <span class="c1"># Calculate metrics</span>
        <span class="n">train_pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="n">accuracy</span> <span class="o">=</span> <span class="p">(</span><span class="n">train_pred</span> <span class="o">==</span> <span class="n">y</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        
        <span class="c1"># Create version</span>
        <span class="n">version_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;v_</span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">_%H%M%S&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">version</span> <span class="o">=</span> <span class="n">ModelVersion</span><span class="p">(</span>
            <span class="n">version_id</span><span class="o">=</span><span class="n">version_id</span><span class="p">,</span>
            <span class="n">model_type</span><span class="o">=</span><span class="n">model_class</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
            <span class="n">feature_hash</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">feature_pipeline</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">get_feature_hash</span><span class="p">(),</span>
            <span class="n">created_at</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
            <span class="n">metrics</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;train_accuracy&#39;</span><span class="p">:</span> <span class="n">accuracy</span><span class="p">},</span>
            <span class="n">hyperparameters</span><span class="o">=</span><span class="n">hyperparameters</span>
        <span class="p">)</span>
        
        <span class="c1"># Register</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_registry</span><span class="o">.</span><span class="n">register_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">version</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">version_id</span>
    
    <span class="k">def</span> <span class="nf">validate_before_deploy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">version_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
                                <span class="n">validation_data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
                                <span class="n">min_accuracy</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Validate model before deployment.&quot;&quot;&quot;</span>
        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_registry</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="n">version_id</span><span class="p">]</span>
        
        <span class="c1"># Prepare validation data</span>
        <span class="n">features_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_pipeline</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">validation_data</span><span class="p">)</span>
        <span class="n">feature_cols</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">feature_pipeline</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        
        <span class="n">features_df</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">features_df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> 
                                  <span class="n">features_df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        
        <span class="n">valid_data</span> <span class="o">=</span> <span class="n">features_df</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">valid_data</span><span class="p">[</span><span class="n">feature_cols</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">valid_data</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        
        <span class="c1"># Validate</span>
        <span class="n">predictions</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="n">accuracy</span> <span class="o">=</span> <span class="p">(</span><span class="n">predictions</span> <span class="o">==</span> <span class="n">y</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        
        <span class="c1"># Update version metrics</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_registry</span><span class="o">.</span><span class="n">versions</span><span class="p">[</span><span class="n">version_id</span><span class="p">]</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;val_accuracy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">accuracy</span>
        
        <span class="n">is_valid</span> <span class="o">=</span> <span class="n">accuracy</span> <span class="o">&gt;=</span> <span class="n">min_accuracy</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Validation accuracy: </span><span class="si">{</span><span class="n">accuracy</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="s1">&#39;PASSED&#39;</span> <span class="k">if</span> <span class="n">is_valid</span> <span class="k">else</span> <span class="s1">&#39;FAILED&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">is_valid</span>
    
    <span class="k">def</span> <span class="nf">deploy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">version_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">force</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Deploy a model version.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">force</span><span class="p">:</span>
            <span class="n">val_acc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_registry</span><span class="o">.</span><span class="n">versions</span><span class="p">[</span><span class="n">version_id</span><span class="p">]</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;val_accuracy&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">val_acc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Model not validated. Run validate_before_deploy() first.&quot;</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">model_registry</span><span class="o">.</span><span class="n">activate_version</span><span class="p">(</span><span class="n">version_id</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">deployment_history</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;version_id&#39;</span><span class="p">:</span> <span class="n">version_id</span><span class="p">,</span>
            <span class="s1">&#39;deployed_at&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
            <span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="s1">&#39;deploy&#39;</span>
        <span class="p">})</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Deployed version: </span><span class="si">{</span><span class="n">version_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Make predictions using active model.&quot;&quot;&quot;</span>
        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_registry</span><span class="o">.</span><span class="n">get_active_model</span><span class="p">()</span>
        <span class="n">features_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_pipeline</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">feature_cols</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">feature_pipeline</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        
        <span class="n">X</span> <span class="o">=</span> <span class="n">features_df</span><span class="p">[</span><span class="n">feature_cols</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>
        <span class="k">return</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ModelDeploymentManager defined&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Test deployment workflow</span>
<span class="n">model_registry</span> <span class="o">=</span> <span class="n">ModelRegistry</span><span class="p">()</span>
<span class="n">deployment_manager</span> <span class="o">=</span> <span class="n">ModelDeploymentManager</span><span class="p">(</span><span class="n">model_registry</span><span class="p">,</span> <span class="n">pipeline</span><span class="p">)</span>

<span class="c1"># Train first version</span>
<span class="n">v1_id</span> <span class="o">=</span> <span class="n">deployment_manager</span><span class="o">.</span><span class="n">train_new_version</span><span class="p">(</span>
    <span class="n">train_data</span><span class="o">=</span><span class="n">train_df</span><span class="p">,</span>
    <span class="n">model_class</span><span class="o">=</span><span class="n">RandomForestClassifier</span><span class="p">,</span>
    <span class="n">hyperparameters</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;n_estimators&#39;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span> <span class="s1">&#39;max_depth&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;random_state&#39;</span><span class="p">:</span> <span class="mi">42</span><span class="p">}</span>
<span class="p">)</span>

<span class="c1"># Validate</span>
<span class="n">is_valid</span> <span class="o">=</span> <span class="n">deployment_manager</span><span class="o">.</span><span class="n">validate_before_deploy</span><span class="p">(</span><span class="n">v1_id</span><span class="p">,</span> <span class="n">test_df</span><span class="p">)</span>

<span class="c1"># Deploy if valid</span>
<span class="k">if</span> <span class="n">is_valid</span><span class="p">:</span>
    <span class="n">deployment_manager</span><span class="o">.</span><span class="n">deploy</span><span class="p">(</span><span class="n">v1_id</span><span class="p">)</span>

<span class="c1"># Show version history</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Version History:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">model_registry</span><span class="o">.</span><span class="n">get_version_history</span><span class="p">())</span>
</code></pre></div>
<div class="md-cell"><hr />
<h2>Section 3: Model Monitoring</h2>
<p>Continuous monitoring detects model degradation and data drift.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Model Monitoring System</span>
<span class="k">class</span> <span class="nc">ModelMonitor</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Monitor model performance and data drift.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feature_pipeline</span><span class="p">:</span> <span class="n">FeaturePipeline</span><span class="p">,</span>
                 <span class="n">alert_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_pipeline</span> <span class="o">=</span> <span class="n">feature_pipeline</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alert_threshold</span> <span class="o">=</span> <span class="n">alert_threshold</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prediction_log</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">performance_history</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">drift_alerts</span> <span class="o">=</span> <span class="p">[]</span>
        
    <span class="k">def</span> <span class="nf">log_prediction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">:</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">features</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span>
                       <span class="n">prediction</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">probability</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                       <span class="n">actual</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Log a prediction for monitoring.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prediction_log</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">timestamp</span><span class="p">,</span>
            <span class="s1">&#39;features&#39;</span><span class="p">:</span> <span class="n">features</span><span class="p">,</span>
            <span class="s1">&#39;prediction&#39;</span><span class="p">:</span> <span class="n">prediction</span><span class="p">,</span>
            <span class="s1">&#39;probability&#39;</span><span class="p">:</span> <span class="n">probability</span><span class="p">,</span>
            <span class="s1">&#39;actual&#39;</span><span class="p">:</span> <span class="n">actual</span>
        <span class="p">})</span>
        
    <span class="k">def</span> <span class="nf">update_actual</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">:</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">actual</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update actual outcome for a prediction.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">log</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">prediction_log</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">log</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">timestamp</span><span class="p">:</span>
                <span class="n">log</span><span class="p">[</span><span class="s1">&#39;actual&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">actual</span>
                <span class="k">break</span>
                
    <span class="k">def</span> <span class="nf">calculate_rolling_accuracy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">window</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate rolling accuracy.&quot;&quot;&quot;</span>
        <span class="n">recent_logs</span> <span class="o">=</span> <span class="p">[</span><span class="n">l</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">prediction_log</span><span class="p">[</span><span class="o">-</span><span class="n">window</span><span class="p">:]</span> 
                       <span class="k">if</span> <span class="n">l</span><span class="p">[</span><span class="s1">&#39;actual&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">recent_logs</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        
        <span class="n">correct</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">recent_logs</span> <span class="k">if</span> <span class="n">l</span><span class="p">[</span><span class="s1">&#39;prediction&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">l</span><span class="p">[</span><span class="s1">&#39;actual&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">correct</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">recent_logs</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">detect_feature_drift</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current_data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Detect drift in feature distributions.&quot;&quot;&quot;</span>
        <span class="n">drift_results</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="n">validation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_pipeline</span><span class="o">.</span><span class="n">validate_features</span><span class="p">(</span><span class="n">current_data</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">feature_name</span><span class="p">,</span> <span class="n">stats</span> <span class="ow">in</span> <span class="n">validation</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">drift_results</span><span class="p">[</span><span class="n">feature_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;z_score&#39;</span><span class="p">:</span> <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;z_score&#39;</span><span class="p">],</span>
                <span class="s1">&#39;is_drifted&#39;</span><span class="p">:</span> <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;is_outlier&#39;</span><span class="p">]</span>
            <span class="p">}</span>
            
            <span class="k">if</span> <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;is_outlier&#39;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">drift_alerts</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
                    <span class="s1">&#39;feature&#39;</span><span class="p">:</span> <span class="n">feature_name</span><span class="p">,</span>
                    <span class="s1">&#39;z_score&#39;</span><span class="p">:</span> <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;z_score&#39;</span><span class="p">]</span>
                <span class="p">})</span>
        
        <span class="k">return</span> <span class="n">drift_results</span>
    
    <span class="k">def</span> <span class="nf">detect_prediction_drift</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">window</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Detect drift in prediction distribution.&quot;&quot;&quot;</span>
        <span class="n">recent_logs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prediction_log</span><span class="p">[</span><span class="o">-</span><span class="n">window</span><span class="p">:]</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">recent_logs</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">window</span> <span class="o">//</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;insufficient_data&#39;</span><span class="p">}</span>
        
        <span class="c1"># Calculate prediction distribution</span>
        <span class="n">predictions</span> <span class="o">=</span> <span class="p">[</span><span class="n">l</span><span class="p">[</span><span class="s1">&#39;prediction&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">recent_logs</span><span class="p">]</span>
        <span class="n">probabilities</span> <span class="o">=</span> <span class="p">[</span><span class="n">l</span><span class="p">[</span><span class="s1">&#39;probability&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">recent_logs</span><span class="p">]</span>
        
        <span class="c1"># Split into first and second half</span>
        <span class="n">mid</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">predictions</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="n">first_half_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">predictions</span><span class="p">[:</span><span class="n">mid</span><span class="p">])</span>
        <span class="n">second_half_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">predictions</span><span class="p">[</span><span class="n">mid</span><span class="p">:])</span>
        
        <span class="n">drift_score</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">second_half_mean</span> <span class="o">-</span> <span class="n">first_half_mean</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;ok&#39;</span> <span class="k">if</span> <span class="n">drift_score</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">alert_threshold</span> <span class="k">else</span> <span class="s1">&#39;drift_detected&#39;</span><span class="p">,</span>
            <span class="s1">&#39;drift_score&#39;</span><span class="p">:</span> <span class="n">drift_score</span><span class="p">,</span>
            <span class="s1">&#39;first_half_mean&#39;</span><span class="p">:</span> <span class="n">first_half_mean</span><span class="p">,</span>
            <span class="s1">&#39;second_half_mean&#39;</span><span class="p">:</span> <span class="n">second_half_mean</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">check_performance_degradation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">baseline_accuracy</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                                       <span class="n">window</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Check for performance degradation.&quot;&quot;&quot;</span>
        <span class="n">current_accuracy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_rolling_accuracy</span><span class="p">(</span><span class="n">window</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">current_accuracy</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;insufficient_data&#39;</span><span class="p">}</span>
        
        <span class="n">degradation</span> <span class="o">=</span> <span class="n">baseline_accuracy</span> <span class="o">-</span> <span class="n">current_accuracy</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;ok&#39;</span> <span class="k">if</span> <span class="n">degradation</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">alert_threshold</span> <span class="k">else</span> <span class="s1">&#39;degraded&#39;</span><span class="p">,</span>
            <span class="s1">&#39;baseline_accuracy&#39;</span><span class="p">:</span> <span class="n">baseline_accuracy</span><span class="p">,</span>
            <span class="s1">&#39;current_accuracy&#39;</span><span class="p">:</span> <span class="n">current_accuracy</span><span class="p">,</span>
            <span class="s1">&#39;degradation&#39;</span><span class="p">:</span> <span class="n">degradation</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">generate_monitoring_report</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Generate comprehensive monitoring report.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
            <span class="s1">&#39;total_predictions&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prediction_log</span><span class="p">),</span>
            <span class="s1">&#39;predictions_with_actual&#39;</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">prediction_log</span> 
                                           <span class="k">if</span> <span class="n">l</span><span class="p">[</span><span class="s1">&#39;actual&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">),</span>
            <span class="s1">&#39;rolling_accuracy_20&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_rolling_accuracy</span><span class="p">(</span><span class="mi">20</span><span class="p">),</span>
            <span class="s1">&#39;rolling_accuracy_50&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_rolling_accuracy</span><span class="p">(</span><span class="mi">50</span><span class="p">),</span>
            <span class="s1">&#39;drift_alerts_count&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">drift_alerts</span><span class="p">),</span>
            <span class="s1">&#39;recent_drift_alerts&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">drift_alerts</span><span class="p">[</span><span class="o">-</span><span class="mi">5</span><span class="p">:]</span>
        <span class="p">}</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ModelMonitor class defined&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Alert System</span>
<span class="k">class</span> <span class="nc">AlertManager</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Manage alerts for model monitoring.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alerts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alert_handlers</span> <span class="o">=</span> <span class="p">[]</span>
        
    <span class="k">def</span> <span class="nf">register_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">handler_func</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Register an alert handler function.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alert_handlers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">handler_func</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">raise_alert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alert_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">severity</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                    <span class="n">message</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">details</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Raise an alert.&quot;&quot;&quot;</span>
        <span class="n">alert</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="n">alert_type</span><span class="p">,</span>
            <span class="s1">&#39;severity&#39;</span><span class="p">:</span> <span class="n">severity</span><span class="p">,</span>
            <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="n">message</span><span class="p">,</span>
            <span class="s1">&#39;details&#39;</span><span class="p">:</span> <span class="n">details</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="p">}</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">alerts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">alert</span><span class="p">)</span>
        
        <span class="c1"># Trigger handlers</span>
        <span class="k">for</span> <span class="n">handler</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">alert_handlers</span><span class="p">:</span>
            <span class="n">handler</span><span class="p">(</span><span class="n">alert</span><span class="p">)</span>
            
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">severity</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2">] </span><span class="si">{</span><span class="n">alert_type</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">get_alerts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">severity</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                   <span class="n">since</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">datetime</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Get alerts with optional filtering.&quot;&quot;&quot;</span>
        <span class="n">filtered</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alerts</span>
        
        <span class="k">if</span> <span class="n">severity</span><span class="p">:</span>
            <span class="n">filtered</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">filtered</span> <span class="k">if</span> <span class="n">a</span><span class="p">[</span><span class="s1">&#39;severity&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">severity</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="n">since</span><span class="p">:</span>
            <span class="n">filtered</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">filtered</span> <span class="k">if</span> <span class="n">a</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">since</span><span class="p">]</span>
        
        <span class="k">return</span> <span class="n">filtered</span>

<span class="c1"># Example handler</span>
<span class="k">def</span> <span class="nf">print_handler</span><span class="p">(</span><span class="n">alert</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">alert</span><span class="p">[</span><span class="s1">&#39;severity&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;critical&#39;</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;!!! CRITICAL ALERT: </span><span class="si">{</span><span class="n">alert</span><span class="p">[</span><span class="s1">&#39;message&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> !!!&quot;</span><span class="p">)</span>

<span class="n">alert_manager</span> <span class="o">=</span> <span class="n">AlertManager</span><span class="p">()</span>
<span class="n">alert_manager</span><span class="o">.</span><span class="n">register_handler</span><span class="p">(</span><span class="n">print_handler</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;AlertManager configured&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Simulate monitoring</span>
<span class="n">monitor</span> <span class="o">=</span> <span class="n">ModelMonitor</span><span class="p">(</span><span class="n">pipeline</span><span class="p">)</span>

<span class="c1"># Simulate predictions</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">):</span>
    <span class="c1"># Simulate prediction</span>
    <span class="n">prediction</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="n">probability</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">-</span><span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">)</span>
    <span class="n">actual</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
    
    <span class="n">monitor</span><span class="o">.</span><span class="n">log_prediction</span><span class="p">(</span>
        <span class="n">timestamp</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">i</span><span class="p">),</span>
        <span class="n">features</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;return_1d&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">)},</span>
        <span class="n">prediction</span><span class="o">=</span><span class="n">prediction</span><span class="p">,</span>
        <span class="n">probability</span><span class="o">=</span><span class="n">probability</span><span class="p">,</span>
        <span class="n">actual</span><span class="o">=</span><span class="n">actual</span>
    <span class="p">)</span>

<span class="c1"># Generate report</span>
<span class="n">report</span> <span class="o">=</span> <span class="n">monitor</span><span class="o">.</span><span class="n">generate_monitoring_report</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Monitoring Report:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">report</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">key</span> <span class="o">!=</span> <span class="s1">&#39;recent_drift_alerts&#39;</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><hr />
<h2>Section 4: Error Handling and Fallbacks</h2>
<p>Production systems need robust error handling and graceful degradation.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Production Prediction Service</span>
<span class="k">class</span> <span class="nc">PredictionService</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Production-ready prediction service with fallbacks.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">deployment_manager</span><span class="p">:</span> <span class="n">ModelDeploymentManager</span><span class="p">,</span>
                 <span class="n">monitor</span><span class="p">:</span> <span class="n">ModelMonitor</span><span class="p">,</span>
                 <span class="n">alert_manager</span><span class="p">:</span> <span class="n">AlertManager</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deployment_manager</span> <span class="o">=</span> <span class="n">deployment_manager</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">monitor</span> <span class="o">=</span> <span class="n">monitor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alert_manager</span> <span class="o">=</span> <span class="n">alert_manager</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fallback_prediction</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Conservative: no position</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">error_count</span> <span class="o">=</span> <span class="mi">0</span>
        
    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Make prediction with error handling.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request_count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
            <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;success&#39;</span><span class="p">,</span>
            <span class="s1">&#39;prediction&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;probability&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;is_fallback&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s1">&#39;warnings&#39;</span><span class="p">:</span> <span class="p">[]</span>
        <span class="p">}</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Validate input data</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">deployment_manager</span><span class="o">.</span><span class="n">feature_pipeline</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">get_max_lookback</span><span class="p">():</span>
                <span class="n">result</span><span class="p">[</span><span class="s1">&#39;warnings&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Insufficient data for full lookback&#39;</span><span class="p">)</span>
            
            <span class="c1"># Check for data quality</span>
            <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Missing price data&quot;</span><span class="p">)</span>
            
            <span class="c1"># Detect feature drift</span>
            <span class="n">drift_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">monitor</span><span class="o">.</span><span class="n">detect_feature_drift</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="n">drifted_features</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">drift_results</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;is_drifted&#39;</span><span class="p">]]</span>
            
            <span class="k">if</span> <span class="n">drifted_features</span><span class="p">:</span>
                <span class="n">result</span><span class="p">[</span><span class="s1">&#39;warnings&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Feature drift detected: </span><span class="si">{</span><span class="n">drifted_features</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">alert_manager</span><span class="o">.</span><span class="n">raise_alert</span><span class="p">(</span>
                    <span class="s1">&#39;feature_drift&#39;</span><span class="p">,</span> <span class="s1">&#39;warning&#39;</span><span class="p">,</span>
                    <span class="sa">f</span><span class="s2">&quot;Drift detected in features: </span><span class="si">{</span><span class="n">drifted_features</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
            
            <span class="c1"># Make prediction</span>
            <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">deployment_manager</span><span class="o">.</span><span class="n">model_registry</span><span class="o">.</span><span class="n">get_active_model</span><span class="p">()</span>
            <span class="n">features_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">deployment_manager</span><span class="o">.</span><span class="n">feature_pipeline</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="n">feature_cols</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">deployment_manager</span><span class="o">.</span><span class="n">feature_pipeline</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            
            <span class="n">X</span> <span class="o">=</span> <span class="n">features_df</span><span class="p">[</span><span class="n">feature_cols</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">values</span>
            
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;NaN values in features&quot;</span><span class="p">)</span>
            
            <span class="n">prediction</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">probability</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X</span><span class="p">)[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
            
            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;prediction&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">prediction</span><span class="p">)</span>
            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;probability&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">probability</span><span class="p">)</span>
            
            <span class="c1"># Log prediction</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">monitor</span><span class="o">.</span><span class="n">log_prediction</span><span class="p">(</span>
                <span class="n">timestamp</span><span class="o">=</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">],</span>
                <span class="n">features</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">feature_cols</span><span class="p">,</span> <span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">])),</span>
                <span class="n">prediction</span><span class="o">=</span><span class="n">prediction</span><span class="p">,</span>
                <span class="n">probability</span><span class="o">=</span><span class="n">probability</span>
            <span class="p">)</span>
            
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">error_count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;fallback&#39;</span>
            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;prediction&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fallback_prediction</span>
            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;probability&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span>
            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;is_fallback&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            
            <span class="c1"># Alert on errors</span>
            <span class="n">error_rate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_count</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">request_count</span>
            <span class="k">if</span> <span class="n">error_rate</span> <span class="o">&gt;</span> <span class="mf">0.1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">alert_manager</span><span class="o">.</span><span class="n">raise_alert</span><span class="p">(</span>
                    <span class="s1">&#39;high_error_rate&#39;</span><span class="p">,</span> <span class="s1">&#39;critical&#39;</span><span class="p">,</span>
                    <span class="sa">f</span><span class="s2">&quot;Error rate: </span><span class="si">{</span><span class="n">error_rate</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="p">{</span><span class="s1">&#39;error_count&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_count</span><span class="p">,</span> <span class="s1">&#39;request_count&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">request_count</span><span class="p">}</span>
                <span class="p">)</span>
        
        <span class="k">return</span> <span class="n">result</span>
    
    <span class="k">def</span> <span class="nf">health_check</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Check service health.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;healthy&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_count</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">request_count</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.1</span> <span class="k">else</span> <span class="s1">&#39;degraded&#39;</span><span class="p">,</span>
            <span class="s1">&#39;request_count&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">request_count</span><span class="p">,</span>
            <span class="s1">&#39;error_count&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_count</span><span class="p">,</span>
            <span class="s1">&#39;error_rate&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_count</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">request_count</span><span class="p">),</span>
            <span class="s1">&#39;active_model&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">deployment_manager</span><span class="o">.</span><span class="n">model_registry</span><span class="o">.</span><span class="n">active_version</span>
        <span class="p">}</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;PredictionService class defined&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Test prediction service</span>
<span class="n">service</span> <span class="o">=</span> <span class="n">PredictionService</span><span class="p">(</span><span class="n">deployment_manager</span><span class="p">,</span> <span class="n">monitor</span><span class="p">,</span> <span class="n">alert_manager</span><span class="p">)</span>

<span class="c1"># Normal prediction</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_df</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Prediction Result:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Health check</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Health Check:&quot;</span><span class="p">)</span>
<span class="n">health</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="n">health_check</span><span class="p">()</span>
<span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">health</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><hr />
<h2>Section 5: Module Project - Complete Production System</h2>
<p>Build a complete production ML trading system.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Complete Production ML Trading System</span>
<span class="k">class</span> <span class="nc">ProductionTradingSystem</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Complete production ML trading system.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">initial_capital</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">100000</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initial_capital</span> <span class="o">=</span> <span class="n">initial_capital</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">capital</span> <span class="o">=</span> <span class="n">initial_capital</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="c1"># Initialize components</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_registry</span> <span class="o">=</span> <span class="n">FeatureRegistry</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setup_features</span><span class="p">()</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_pipeline</span> <span class="o">=</span> <span class="n">FeaturePipeline</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">feature_registry</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_registry</span> <span class="o">=</span> <span class="n">ModelRegistry</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deployment_manager</span> <span class="o">=</span> <span class="n">ModelDeploymentManager</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model_registry</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_pipeline</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">monitor</span> <span class="o">=</span> <span class="n">ModelMonitor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">feature_pipeline</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alert_manager</span> <span class="o">=</span> <span class="n">AlertManager</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prediction_service</span> <span class="o">=</span> <span class="n">PredictionService</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">deployment_manager</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">monitor</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">alert_manager</span>
        <span class="p">)</span>
        
        <span class="c1"># Trading state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trade_history</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">equity_curve</span> <span class="o">=</span> <span class="p">[]</span>
        
    <span class="k">def</span> <span class="nf">_setup_features</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Setup standard feature set.&quot;&quot;&quot;</span>
        <span class="n">features</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">FeatureDefinition</span><span class="p">(</span><span class="s1">&#39;return_1d&#39;</span><span class="p">,</span> <span class="s1">&#39;return&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;period&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}),</span>
            <span class="n">FeatureDefinition</span><span class="p">(</span><span class="s1">&#39;return_5d&#39;</span><span class="p">,</span> <span class="s1">&#39;return&#39;</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;period&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">}),</span>
            <span class="n">FeatureDefinition</span><span class="p">(</span><span class="s1">&#39;return_20d&#39;</span><span class="p">,</span> <span class="s1">&#39;return&#39;</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;period&#39;</span><span class="p">:</span> <span class="mi">20</span><span class="p">}),</span>
            <span class="n">FeatureDefinition</span><span class="p">(</span><span class="s1">&#39;volatility_20d&#39;</span><span class="p">,</span> <span class="s1">&#39;volatility&#39;</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;period&#39;</span><span class="p">:</span> <span class="mi">20</span><span class="p">}),</span>
            <span class="n">FeatureDefinition</span><span class="p">(</span><span class="s1">&#39;rsi&#39;</span><span class="p">,</span> <span class="s1">&#39;rsi&#39;</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;period&#39;</span><span class="p">:</span> <span class="mi">14</span><span class="p">}),</span>
            <span class="n">FeatureDefinition</span><span class="p">(</span><span class="s1">&#39;macd&#39;</span><span class="p">,</span> <span class="s1">&#39;macd&#39;</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;fast&#39;</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span> <span class="s1">&#39;slow&#39;</span><span class="p">:</span> <span class="mi">26</span><span class="p">}),</span>
            <span class="n">FeatureDefinition</span><span class="p">(</span><span class="s1">&#39;price_to_sma_20&#39;</span><span class="p">,</span> <span class="s1">&#39;price_to_sma&#39;</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;period&#39;</span><span class="p">:</span> <span class="mi">20</span><span class="p">}),</span>
            <span class="n">FeatureDefinition</span><span class="p">(</span><span class="s1">&#39;price_to_sma_50&#39;</span><span class="p">,</span> <span class="s1">&#39;price_to_sma&#39;</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;period&#39;</span><span class="p">:</span> <span class="mi">50</span><span class="p">}),</span>
        <span class="p">]</span>
        
        <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">features</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">feature_registry</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">feature</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">train_data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> 
              <span class="n">model_class</span><span class="o">=</span><span class="n">RandomForestClassifier</span><span class="p">,</span>
              <span class="n">hyperparameters</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Train and deploy a model.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">hyperparameters</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">hyperparameters</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;n_estimators&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
                <span class="s1">&#39;max_depth&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
                <span class="s1">&#39;random_state&#39;</span><span class="p">:</span> <span class="mi">42</span>
            <span class="p">}</span>
        
        <span class="c1"># Train new version</span>
        <span class="n">version_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">deployment_manager</span><span class="o">.</span><span class="n">train_new_version</span><span class="p">(</span>
            <span class="n">train_data</span><span class="p">,</span> <span class="n">model_class</span><span class="p">,</span> <span class="n">hyperparameters</span>
        <span class="p">)</span>
        
        <span class="k">return</span> <span class="n">version_id</span>
    
    <span class="k">def</span> <span class="nf">validate_and_deploy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">version_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
                            <span class="n">validation_data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
                            <span class="n">min_accuracy</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Validate and deploy a model version.&quot;&quot;&quot;</span>
        <span class="n">is_valid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">deployment_manager</span><span class="o">.</span><span class="n">validate_before_deploy</span><span class="p">(</span>
            <span class="n">version_id</span><span class="p">,</span> <span class="n">validation_data</span><span class="p">,</span> <span class="n">min_accuracy</span>
        <span class="p">)</span>
        
        <span class="k">if</span> <span class="n">is_valid</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">deployment_manager</span><span class="o">.</span><span class="n">deploy</span><span class="p">(</span><span class="n">version_id</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">alert_manager</span><span class="o">.</span><span class="n">raise_alert</span><span class="p">(</span>
                <span class="s1">&#39;validation_failed&#39;</span><span class="p">,</span> <span class="s1">&#39;warning&#39;</span><span class="p">,</span>
                <span class="sa">f</span><span class="s2">&quot;Model </span><span class="si">{</span><span class="n">version_id</span><span class="si">}</span><span class="s2"> failed validation&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
    
    <span class="k">def</span> <span class="nf">process_bar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current_data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> 
                    <span class="n">current_price</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Process a new bar and potentially trade.&quot;&quot;&quot;</span>
        <span class="c1"># Get prediction</span>
        <span class="n">prediction_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prediction_service</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">current_data</span><span class="p">)</span>
        
        <span class="c1"># Determine position</span>
        <span class="n">signal</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">prediction_result</span><span class="p">[</span><span class="s1">&#39;prediction&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span>
        
        <span class="n">trade_result</span> <span class="o">=</span> <span class="kc">None</span>
        
        <span class="c1"># Check for position change</span>
        <span class="k">if</span> <span class="n">signal</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">position</span><span class="p">:</span>
            <span class="n">trade_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execute_trade</span><span class="p">(</span><span class="n">signal</span><span class="p">,</span> <span class="n">current_price</span><span class="p">)</span>
        
        <span class="c1"># Update equity</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">equity_curve</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
            <span class="s1">&#39;capital&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">capital</span><span class="p">,</span>
            <span class="s1">&#39;position&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">position</span>
        <span class="p">})</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;prediction&#39;</span><span class="p">:</span> <span class="n">prediction_result</span><span class="p">,</span>
            <span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="n">signal</span><span class="p">,</span>
            <span class="s1">&#39;trade&#39;</span><span class="p">:</span> <span class="n">trade_result</span><span class="p">,</span>
            <span class="s1">&#39;capital&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">capital</span><span class="p">,</span>
            <span class="s1">&#39;position&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">position</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">_execute_trade</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_position</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">price</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Execute a trade.&quot;&quot;&quot;</span>
        <span class="c1"># Calculate trade cost (0.1% commission + 0.05% slippage)</span>
        <span class="n">cost_rate</span> <span class="o">=</span> <span class="mf">0.0015</span>
        <span class="n">position_change</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">new_position</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">position</span><span class="p">)</span>
        <span class="n">trade_cost</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">capital</span> <span class="o">*</span> <span class="n">position_change</span> <span class="o">*</span> <span class="n">cost_rate</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">capital</span> <span class="o">-=</span> <span class="n">trade_cost</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="n">new_position</span>
        
        <span class="n">trade</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
            <span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="n">price</span><span class="p">,</span>
            <span class="s1">&#39;new_position&#39;</span><span class="p">:</span> <span class="n">new_position</span><span class="p">,</span>
            <span class="s1">&#39;cost&#39;</span><span class="p">:</span> <span class="n">trade_cost</span>
        <span class="p">}</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">trade_history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">trade</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">trade</span>
    
    <span class="k">def</span> <span class="nf">update_pnl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">price_return</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update P&amp;L based on position and return.&quot;&quot;&quot;</span>
        <span class="n">pnl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">capital</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">*</span> <span class="n">price_return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">capital</span> <span class="o">+=</span> <span class="n">pnl</span>
        <span class="k">return</span> <span class="n">pnl</span>
    
    <span class="k">def</span> <span class="nf">get_performance_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get performance summary.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">equity_curve</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;no_data&#39;</span><span class="p">}</span>
        
        <span class="n">equity_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">equity_curve</span><span class="p">)</span>
        <span class="n">capitals</span> <span class="o">=</span> <span class="n">equity_df</span><span class="p">[</span><span class="s1">&#39;capital&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        
        <span class="n">returns</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">capitals</span><span class="p">)</span> <span class="o">/</span> <span class="n">capitals</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;total_return&#39;</span><span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">capital</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_capital</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s1">&#39;sharpe_ratio&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">returns</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">returns</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1e-8</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">returns</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;max_drawdown&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">capitals</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="o">.</span><span class="n">accumulate</span><span class="p">(</span><span class="n">capitals</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">capitals</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;n_trades&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trade_history</span><span class="p">),</span>
            <span class="s1">&#39;total_costs&#39;</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="s1">&#39;cost&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trade_history</span><span class="p">),</span>
            <span class="s1">&#39;active_model&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_registry</span><span class="o">.</span><span class="n">active_version</span><span class="p">,</span>
            <span class="s1">&#39;health&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">prediction_service</span><span class="o">.</span><span class="n">health_check</span><span class="p">()</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">generate_system_report</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Generate comprehensive system report.&quot;&quot;&quot;</span>
        <span class="n">perf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_performance_summary</span><span class="p">()</span>
        <span class="n">monitoring</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">monitor</span><span class="o">.</span><span class="n">generate_monitoring_report</span><span class="p">()</span>
        
        <span class="n">report</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">========================================</span>
<span class="s2">PRODUCTION TRADING SYSTEM REPORT</span>
<span class="s2">========================================</span>
<span class="s2">Generated: </span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="si">}</span><span class="s2"></span>

<span class="s2">--- Performance ---</span>
<span class="s2">Total Return: </span><span class="si">{</span><span class="n">perf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;total_return&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2"></span>
<span class="s2">Sharpe Ratio: </span><span class="si">{</span><span class="n">perf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sharpe_ratio&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"></span>
<span class="s2">Max Drawdown: </span><span class="si">{</span><span class="n">perf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;max_drawdown&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2"></span>
<span class="s2">Number of Trades: </span><span class="si">{</span><span class="n">perf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;n_trades&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2"></span>
<span class="s2">Total Costs: $</span><span class="si">{</span><span class="n">perf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;total_costs&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="si">:</span><span class="s2">,.2f</span><span class="si">}</span><span class="s2"></span>

<span class="s2">--- Model ---</span>
<span class="s2">Active Model: </span><span class="si">{</span><span class="n">perf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;active_model&#39;</span><span class="p">,</span> <span class="s1">&#39;None&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2"></span>
<span class="s2">Feature Hash: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">feature_registry</span><span class="o">.</span><span class="n">get_feature_hash</span><span class="p">()</span><span class="si">}</span><span class="s2"></span>

<span class="s2">--- Monitoring ---</span>
<span class="s2">Total Predictions: </span><span class="si">{</span><span class="n">monitoring</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;total_predictions&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2"></span>
<span class="s2">Rolling Accuracy (20): </span><span class="si">{</span><span class="n">monitoring</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;rolling_accuracy_20&#39;</span><span class="p">,</span> <span class="s1">&#39;N/A&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2"></span>
<span class="s2">Drift Alerts: </span><span class="si">{</span><span class="n">monitoring</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;drift_alerts_count&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2"></span>

<span class="s2">--- Health ---</span>
<span class="s2">Status: </span><span class="si">{</span><span class="n">perf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;health&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;status&#39;</span><span class="p">,</span> <span class="s1">&#39;Unknown&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2"></span>
<span class="s2">Error Rate: </span><span class="si">{</span><span class="n">perf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;health&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;error_rate&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2"></span>
<span class="s2">========================================</span>
<span class="s2">&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">report</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ProductionTradingSystem class defined&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Run complete production system</span>
<span class="c1"># Generate more data</span>
<span class="n">full_data</span> <span class="o">=</span> <span class="n">generate_sample_data</span><span class="p">(</span><span class="mi">1500</span><span class="p">)</span>

<span class="c1"># Split data</span>
<span class="n">train_data</span> <span class="o">=</span> <span class="n">full_data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="mi">1000</span><span class="p">]</span>
<span class="n">val_data</span> <span class="o">=</span> <span class="n">full_data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">1000</span><span class="p">:</span><span class="mi">1200</span><span class="p">]</span>
<span class="n">test_data</span> <span class="o">=</span> <span class="n">full_data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">1200</span><span class="p">:]</span>

<span class="c1"># Initialize system</span>
<span class="n">system</span> <span class="o">=</span> <span class="n">ProductionTradingSystem</span><span class="p">(</span><span class="n">initial_capital</span><span class="o">=</span><span class="mi">100000</span><span class="p">)</span>

<span class="c1"># Train model</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Training model...&quot;</span><span class="p">)</span>
<span class="n">version_id</span> <span class="o">=</span> <span class="n">system</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">train_data</span><span class="p">)</span>

<span class="c1"># Validate and deploy</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Validating and deploying...&quot;</span><span class="p">)</span>
<span class="n">deployed</span> <span class="o">=</span> <span class="n">system</span><span class="o">.</span><span class="n">validate_and_deploy</span><span class="p">(</span><span class="n">version_id</span><span class="p">,</span> <span class="n">val_data</span><span class="p">,</span> <span class="n">min_accuracy</span><span class="o">=</span><span class="mf">0.45</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Simulate live trading</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Simulating live trading...&quot;</span><span class="p">)</span>

<span class="n">lookback</span> <span class="o">=</span> <span class="mi">100</span>  <span class="c1"># Days of history needed</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">lookback</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_data</span><span class="p">)):</span>
    <span class="c1"># Get current data window</span>
    <span class="n">current_data</span> <span class="o">=</span> <span class="n">test_data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="n">lookback</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">current_price</span> <span class="o">=</span> <span class="n">test_data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;close&#39;</span><span class="p">]</span>
    
    <span class="c1"># Process bar</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">system</span><span class="o">.</span><span class="n">process_bar</span><span class="p">(</span><span class="n">current_data</span><span class="p">,</span> <span class="n">current_price</span><span class="p">)</span>
    
    <span class="c1"># Update P&amp;L if we have previous price</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="n">lookback</span><span class="p">:</span>
        <span class="n">prev_price</span> <span class="o">=</span> <span class="n">test_data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;close&#39;</span><span class="p">]</span>
        <span class="n">price_return</span> <span class="o">=</span> <span class="p">(</span><span class="n">current_price</span> <span class="o">-</span> <span class="n">prev_price</span><span class="p">)</span> <span class="o">/</span> <span class="n">prev_price</span>
        <span class="n">system</span><span class="o">.</span><span class="n">update_pnl</span><span class="p">(</span><span class="n">price_return</span><span class="p">)</span>

<span class="c1"># Generate final report</span>
<span class="nb">print</span><span class="p">(</span><span class="n">system</span><span class="o">.</span><span class="n">generate_system_report</span><span class="p">())</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Visualize system performance</span>
<span class="k">if</span> <span class="n">system</span><span class="o">.</span><span class="n">equity_curve</span><span class="p">:</span>
    <span class="n">equity_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">system</span><span class="o">.</span><span class="n">equity_curve</span><span class="p">)</span>
    
    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
    
    <span class="c1"># Equity curve</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">equity_df</span><span class="p">)),</span> <span class="n">equity_df</span><span class="p">[</span><span class="s1">&#39;capital&#39;</span><span class="p">])</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time Step&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Capital ($)&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Equity Curve&#39;</span><span class="p">)</span>
    
    <span class="c1"># Position over time</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">equity_df</span><span class="p">)),</span> <span class="n">equity_df</span><span class="p">[</span><span class="s1">&#39;position&#39;</span><span class="p">],</span> <span class="n">where</span><span class="o">=</span><span class="s1">&#39;post&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time Step&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Position&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Position Over Time&#39;</span><span class="p">)</span>
    
    <span class="c1"># Trade costs</span>
    <span class="k">if</span> <span class="n">system</span><span class="o">.</span><span class="n">trade_history</span><span class="p">:</span>
        <span class="n">costs</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="p">[</span><span class="s1">&#39;cost&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">system</span><span class="o">.</span><span class="n">trade_history</span><span class="p">]</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">costs</span><span class="p">)),</span> <span class="n">costs</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Trade Number&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Cost ($)&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Trade Costs&#39;</span><span class="p">)</span>
    
    <span class="c1"># Drawdown</span>
    <span class="n">capitals</span> <span class="o">=</span> <span class="n">equity_df</span><span class="p">[</span><span class="s1">&#39;capital&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">peak</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="o">.</span><span class="n">accumulate</span><span class="p">(</span><span class="n">capitals</span><span class="p">)</span>
    <span class="n">drawdown</span> <span class="o">=</span> <span class="p">(</span><span class="n">capitals</span> <span class="o">-</span> <span class="n">peak</span><span class="p">)</span> <span class="o">/</span> <span class="n">peak</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">drawdown</span><span class="p">)),</span> <span class="n">drawdown</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time Step&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Drawdown&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Drawdown&#39;</span><span class="p">)</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
<div class="md-cell"><hr />
<h2>Exercises</h2>
<p>Complete the following exercises to practice production ML systems.</p></div>
<div class="md-cell exercise-header"><h3>Exercise 13.1: Create Feature Definition (Guided)</h3>
<p>Define a new feature for the pipeline.</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 13.1: Create Feature Definition</span>
<span class="k">def</span> <span class="nf">create_bollinger_band_feature</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a Bollinger Band width feature definition.</span>
<span class="sd">    </span>
<span class="sd">    The feature should:</span>
<span class="sd">    - Have name &#39;bb_width&#39;</span>
<span class="sd">    - Use &#39;volatility&#39; type (we&#39;ll add the computer)</span>
<span class="sd">    - Have lookback of 20 periods</span>
<span class="sd">    - Include &#39;period&#39; and &#39;std_dev&#39; params</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO: Create FeatureDefinition</span>
    <span class="n">feature</span> <span class="o">=</span> <span class="n">______</span><span class="p">(</span>  
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;______&#39;</span><span class="p">,</span>
        <span class="n">feature_type</span><span class="o">=</span><span class="s1">&#39;______&#39;</span><span class="p">,</span>
        <span class="n">lookback_periods</span><span class="o">=</span><span class="n">______</span><span class="p">,</span>
        <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;period&#39;</span><span class="p">:</span> <span class="n">______</span><span class="p">,</span> <span class="s1">&#39;std_dev&#39;</span><span class="p">:</span> <span class="n">______</span><span class="p">}</span>
    <span class="p">)</span>
    
    <span class="k">return</span> <span class="n">feature</span>

<span class="c1"># Test</span>
<span class="c1"># bb_feature = create_bollinger_band_feature()</span>
<span class="c1"># print(bb_feature.to_dict())</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 13.1</summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">create_bollinger_band_feature</span><span class="p">():</span>
    <span class="n">feature</span> <span class="o">=</span> <span class="n">FeatureDefinition</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;bb_width&#39;</span><span class="p">,</span>
        <span class="n">feature_type</span><span class="o">=</span><span class="s1">&#39;volatility&#39;</span><span class="p">,</span>
        <span class="n">lookback_periods</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
        <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;period&#39;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span> <span class="s1">&#39;std_dev&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">}</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">feature</span>
</code></pre></div>


</details></div>
<div class="md-cell exercise-header"><h3>Exercise 13.2: Implement Model Version Comparison (Guided)</h3>
<p>Create a function to compare model versions.</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 13.2: Implement Model Version Comparison</span>
<span class="k">def</span> <span class="nf">compare_model_versions</span><span class="p">(</span><span class="n">registry</span><span class="p">:</span> <span class="n">ModelRegistry</span><span class="p">,</span> 
                           <span class="n">version_ids</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compare multiple model versions.</span>
<span class="sd">    </span>
<span class="sd">    Returns DataFrame with:</span>
<span class="sd">    - version_id</span>
<span class="sd">    - model_type</span>
<span class="sd">    - created_at</span>
<span class="sd">    - All metrics</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">records</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">for</span> <span class="n">version_id</span> <span class="ow">in</span> <span class="n">version_ids</span><span class="p">:</span>
        <span class="c1"># TODO: Get version from registry</span>
        <span class="k">if</span> <span class="n">version_id</span> <span class="ow">in</span> <span class="n">registry</span><span class="o">.</span><span class="n">______</span><span class="p">:</span>
            <span class="n">version</span> <span class="o">=</span> <span class="n">registry</span><span class="o">.</span><span class="n">______</span><span class="p">[</span><span class="n">______</span><span class="p">]</span>
            
            <span class="c1"># TODO: Create record dict</span>
            <span class="n">record</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;version_id&#39;</span><span class="p">:</span> <span class="n">version</span><span class="o">.</span><span class="n">______</span><span class="p">,</span>
                <span class="s1">&#39;model_type&#39;</span><span class="p">:</span> <span class="n">version</span><span class="o">.</span><span class="n">______</span><span class="p">,</span>
                <span class="s1">&#39;created_at&#39;</span><span class="p">:</span> <span class="n">version</span><span class="o">.</span><span class="n">______</span><span class="p">,</span>
                <span class="s1">&#39;is_active&#39;</span><span class="p">:</span> <span class="n">version</span><span class="o">.</span><span class="n">______</span>
            <span class="p">}</span>
            
            <span class="c1"># TODO: Add all metrics</span>
            <span class="k">for</span> <span class="n">metric_name</span><span class="p">,</span> <span class="n">metric_value</span> <span class="ow">in</span> <span class="n">version</span><span class="o">.</span><span class="n">______</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">record</span><span class="p">[</span><span class="n">metric_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">metric_value</span>
            
            <span class="n">records</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">______</span><span class="p">(</span><span class="n">records</span><span class="p">)</span>

<span class="c1"># Test</span>
<span class="c1"># comparison = compare_model_versions(model_registry, [v1_id])</span>
<span class="c1"># print(comparison)</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 13.2</summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">compare_model_versions</span><span class="p">(</span><span class="n">registry</span><span class="p">:</span> <span class="n">ModelRegistry</span><span class="p">,</span>
                           <span class="n">version_ids</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="n">records</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">version_id</span> <span class="ow">in</span> <span class="n">version_ids</span><span class="p">:</span>
        <span class="c1"># Get version from registry</span>
        <span class="k">if</span> <span class="n">version_id</span> <span class="ow">in</span> <span class="n">registry</span><span class="o">.</span><span class="n">versions</span><span class="p">:</span>
            <span class="n">version</span> <span class="o">=</span> <span class="n">registry</span><span class="o">.</span><span class="n">versions</span><span class="p">[</span><span class="n">version_id</span><span class="p">]</span>

            <span class="c1"># Create record dict</span>
            <span class="n">record</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;version_id&#39;</span><span class="p">:</span> <span class="n">version</span><span class="o">.</span><span class="n">version_id</span><span class="p">,</span>
                <span class="s1">&#39;model_type&#39;</span><span class="p">:</span> <span class="n">version</span><span class="o">.</span><span class="n">model_type</span><span class="p">,</span>
                <span class="s1">&#39;created_at&#39;</span><span class="p">:</span> <span class="n">version</span><span class="o">.</span><span class="n">created_at</span><span class="p">,</span>
                <span class="s1">&#39;is_active&#39;</span><span class="p">:</span> <span class="n">version</span><span class="o">.</span><span class="n">is_active</span>
            <span class="p">}</span>

            <span class="c1"># Add all metrics</span>
            <span class="k">for</span> <span class="n">metric_name</span><span class="p">,</span> <span class="n">metric_value</span> <span class="ow">in</span> <span class="n">version</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">record</span><span class="p">[</span><span class="n">metric_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">metric_value</span>

            <span class="n">records</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">records</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell exercise-header"><h3>Exercise 13.3: Implement Drift Detection (Guided)</h3>
<p>Create a simple drift detection function.</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 13.3: Implement Drift Detection</span>
<span class="k">def</span> <span class="nf">detect_distribution_drift</span><span class="p">(</span><span class="n">reference_data</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                               <span class="n">current_data</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                               <span class="n">threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Detect drift between reference and current distributions.</span>
<span class="sd">    </span>
<span class="sd">    Uses simple mean/std comparison.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO: Calculate reference statistics</span>
    <span class="n">ref_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">______</span><span class="p">(</span><span class="n">reference_data</span><span class="p">)</span>
    <span class="n">ref_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">______</span><span class="p">(</span><span class="n">reference_data</span><span class="p">)</span>
    
    <span class="c1"># TODO: Calculate current statistics</span>
    <span class="n">curr_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">______</span><span class="p">(</span><span class="n">current_data</span><span class="p">)</span>
    <span class="n">curr_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">______</span><span class="p">(</span><span class="n">current_data</span><span class="p">)</span>
    
    <span class="c1"># TODO: Calculate drift metrics</span>
    <span class="n">mean_drift</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">curr_mean</span> <span class="o">-</span> <span class="n">______</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">______</span> <span class="o">+</span> <span class="mf">1e-10</span><span class="p">)</span>
    <span class="n">std_drift</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">curr_std</span> <span class="o">-</span> <span class="n">______</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">______</span> <span class="o">+</span> <span class="mf">1e-10</span><span class="p">)</span>
    
    <span class="c1"># TODO: Determine if drifted</span>
    <span class="n">is_drifted</span> <span class="o">=</span> <span class="n">mean_drift</span> <span class="o">&gt;</span> <span class="n">______</span> <span class="ow">or</span> <span class="n">std_drift</span> <span class="o">&gt;</span> <span class="n">______</span>
    
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;mean_drift&#39;</span><span class="p">:</span> <span class="n">mean_drift</span><span class="p">,</span>
        <span class="s1">&#39;std_drift&#39;</span><span class="p">:</span> <span class="n">std_drift</span><span class="p">,</span>
        <span class="s1">&#39;is_drifted&#39;</span><span class="p">:</span> <span class="n">is_drifted</span><span class="p">,</span>
        <span class="s1">&#39;ref_mean&#39;</span><span class="p">:</span> <span class="n">ref_mean</span><span class="p">,</span>
        <span class="s1">&#39;curr_mean&#39;</span><span class="p">:</span> <span class="n">curr_mean</span>
    <span class="p">}</span>

<span class="c1"># Test</span>
<span class="c1"># ref = np.random.normal(0, 1, 1000)</span>
<span class="c1"># curr = np.random.normal(0.5, 1, 100)  # Shifted mean</span>
<span class="c1"># drift_result = detect_distribution_drift(ref, curr)</span>
<span class="c1"># print(drift_result)</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 13.3</summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">detect_distribution_drift</span><span class="p">(</span><span class="n">reference_data</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                               <span class="n">current_data</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                               <span class="n">threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
    <span class="c1"># Calculate reference statistics</span>
    <span class="n">ref_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">reference_data</span><span class="p">)</span>
    <span class="n">ref_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">reference_data</span><span class="p">)</span>

    <span class="c1"># Calculate current statistics</span>
    <span class="n">curr_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">current_data</span><span class="p">)</span>
    <span class="n">curr_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">current_data</span><span class="p">)</span>

    <span class="c1"># Calculate drift metrics</span>
    <span class="n">mean_drift</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">curr_mean</span> <span class="o">-</span> <span class="n">ref_mean</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">ref_std</span> <span class="o">+</span> <span class="mf">1e-10</span><span class="p">)</span>
    <span class="n">std_drift</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">curr_std</span> <span class="o">-</span> <span class="n">ref_std</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">ref_std</span> <span class="o">+</span> <span class="mf">1e-10</span><span class="p">)</span>

    <span class="c1"># Determine if drifted</span>
    <span class="n">is_drifted</span> <span class="o">=</span> <span class="n">mean_drift</span> <span class="o">&gt;</span> <span class="n">threshold</span> <span class="ow">or</span> <span class="n">std_drift</span> <span class="o">&gt;</span> <span class="n">threshold</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;mean_drift&#39;</span><span class="p">:</span> <span class="n">mean_drift</span><span class="p">,</span>
        <span class="s1">&#39;std_drift&#39;</span><span class="p">:</span> <span class="n">std_drift</span><span class="p">,</span>
        <span class="s1">&#39;is_drifted&#39;</span><span class="p">:</span> <span class="n">is_drifted</span><span class="p">,</span>
        <span class="s1">&#39;ref_mean&#39;</span><span class="p">:</span> <span class="n">ref_mean</span><span class="p">,</span>
        <span class="s1">&#39;curr_mean&#39;</span><span class="p">:</span> <span class="n">curr_mean</span>
    <span class="p">}</span>
</code></pre></div>


</details></div>
<div class="md-cell exercise-header"><h3>Exercise 13.4: Build Feature Store (Open-ended)</h3>
<p>Create a simple feature store for caching computed features.</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 13.4: Build Feature Store</span>
<span class="c1"># TODO: Create a FeatureStore class that:</span>
<span class="c1"># - Caches computed features by date</span>
<span class="c1"># - Supports point-in-time lookups</span>
<span class="c1"># - Has TTL (time-to-live) for cache entries</span>
<span class="c1"># - Can save/load from disk</span>

<span class="c1"># Your code here</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 13.4</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">FeatureStore</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ttl_hours</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">24</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># {date: {feature_name: value}}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timestamps</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># {date: cache_time}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ttl</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="n">ttl_hours</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">put</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">date</span><span class="p">:</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">features</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]):</span>
        <span class="sd">&quot;&quot;&quot;Store features for a date.&quot;&quot;&quot;</span>
        <span class="n">date_key</span> <span class="o">=</span> <span class="n">date</span><span class="o">.</span><span class="n">date</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">date</span><span class="p">,</span> <span class="n">datetime</span><span class="p">)</span> <span class="k">else</span> <span class="n">date</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">date_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">features</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timestamps</span><span class="p">[</span><span class="n">date_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">date</span><span class="p">:</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">feature_names</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Get features for a date (point-in-time lookup).&quot;&quot;&quot;</span>
        <span class="n">date_key</span> <span class="o">=</span> <span class="n">date</span><span class="o">.</span><span class="n">date</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">date</span><span class="p">,</span> <span class="n">datetime</span><span class="p">)</span> <span class="k">else</span> <span class="n">date</span>

        <span class="k">if</span> <span class="n">date_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># Check TTL</span>
        <span class="k">if</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">timestamps</span><span class="p">[</span><span class="n">date_key</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">ttl</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">date_key</span><span class="p">]</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">timestamps</span><span class="p">[</span><span class="n">date_key</span><span class="p">]</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">date_key</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">feature_names</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">features</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">feature_names</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">features</span>

    <span class="k">def</span> <span class="nf">get_range</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_date</span><span class="p">:</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">end_date</span><span class="p">:</span> <span class="n">datetime</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get features for a date range.&quot;&quot;&quot;</span>
        <span class="n">records</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">current</span> <span class="o">=</span> <span class="n">start_date</span>

        <span class="k">while</span> <span class="n">current</span> <span class="o">&lt;=</span> <span class="n">end_date</span><span class="p">:</span>
            <span class="n">features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">current</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">features</span><span class="p">:</span>
                <span class="n">records</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;date&#39;</span><span class="p">:</span> <span class="n">current</span><span class="p">,</span> <span class="o">**</span><span class="n">features</span><span class="p">})</span>
            <span class="n">current</span> <span class="o">+=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">records</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Save feature store to disk.&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">({</span><span class="s1">&#39;cache&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">,</span> <span class="s1">&#39;timestamps&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">timestamps</span><span class="p">},</span> <span class="n">f</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">filepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;FeatureStore&#39;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Load feature store from disk.&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

        <span class="n">store</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">()</span>
        <span class="n">store</span><span class="o">.</span><span class="n">cache</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;cache&#39;</span><span class="p">]</span>
        <span class="n">store</span><span class="o">.</span><span class="n">timestamps</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;timestamps&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">store</span>

    <span class="k">def</span> <span class="nf">cleanup_expired</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove expired entries.&quot;&quot;&quot;</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">expired</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">timestamps</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">now</span> <span class="o">-</span> <span class="n">v</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">ttl</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">expired</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">timestamps</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">expired</span><span class="p">)</span>

<span class="c1"># Usage</span>
<span class="n">store</span> <span class="o">=</span> <span class="n">FeatureStore</span><span class="p">(</span><span class="n">ttl_hours</span><span class="o">=</span><span class="mi">24</span><span class="p">)</span>
<span class="n">store</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span> <span class="p">{</span><span class="s1">&#39;return_1d&#39;</span><span class="p">:</span> <span class="mf">0.01</span><span class="p">,</span> <span class="s1">&#39;rsi&#39;</span><span class="p">:</span> <span class="mi">55</span><span class="p">})</span>
<span class="nb">print</span><span class="p">(</span><span class="n">store</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()))</span>
</code></pre></div>


</details></div>
<div class="md-cell exercise-header"><h3>Exercise 13.5: Implement A/B Testing Framework (Open-ended)</h3>
<p>Create a framework for A/B testing model versions.</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 13.5: Implement A/B Testing Framework</span>
<span class="c1"># TODO: Create an ABTestManager class that:</span>
<span class="c1"># - Runs two model versions simultaneously</span>
<span class="c1"># - Tracks performance for each</span>
<span class="c1"># - Determines statistical significance</span>
<span class="c1"># - Provides recommendation on which to deploy</span>

<span class="c1"># Your code here</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 13.5</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">ABTestManager</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_a</span><span class="p">,</span> <span class="n">model_b</span><span class="p">,</span> <span class="n">split_ratio</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_a</span> <span class="o">=</span> <span class="n">model_a</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_b</span> <span class="o">=</span> <span class="n">model_b</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">split_ratio</span> <span class="o">=</span> <span class="n">split_ratio</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results_a</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results_b</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Route prediction to A or B based on split.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_ratio</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_a</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_b</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">record_outcome</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">prediction</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">actual</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Record prediction outcome.&quot;&quot;&quot;</span>
        <span class="n">is_correct</span> <span class="o">=</span> <span class="n">prediction</span> <span class="o">==</span> <span class="n">actual</span>
        <span class="k">if</span> <span class="n">model_id</span> <span class="o">==</span> <span class="s1">&#39;A&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">results_a</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">is_correct</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">results_b</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">is_correct</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_performance</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get performance comparison.&quot;&quot;&quot;</span>
        <span class="n">acc_a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">results_a</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">results_a</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="n">acc_b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">results_b</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">results_b</span> <span class="k">else</span> <span class="mi">0</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;model_a&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;accuracy&#39;</span><span class="p">:</span> <span class="n">acc_a</span><span class="p">,</span> <span class="s1">&#39;n_samples&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">results_a</span><span class="p">)},</span>
            <span class="s1">&#39;model_b&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;accuracy&#39;</span><span class="p">:</span> <span class="n">acc_b</span><span class="p">,</span> <span class="s1">&#39;n_samples&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">results_b</span><span class="p">)}</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">is_significant</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">confidence</span><span class="o">=</span><span class="mf">0.95</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Check if difference is statistically significant.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">results_a</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">30</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">results_b</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">30</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;significant&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="s1">&#39;insufficient_samples&#39;</span><span class="p">}</span>

        <span class="c1"># Two-proportion z-test</span>
        <span class="n">p_a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">results_a</span><span class="p">)</span>
        <span class="n">p_b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">results_b</span><span class="p">)</span>
        <span class="n">n_a</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">results_a</span><span class="p">)</span>
        <span class="n">n_b</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">results_b</span><span class="p">)</span>

        <span class="n">p_pooled</span> <span class="o">=</span> <span class="p">(</span><span class="n">p_a</span> <span class="o">*</span> <span class="n">n_a</span> <span class="o">+</span> <span class="n">p_b</span> <span class="o">*</span> <span class="n">n_b</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">n_a</span> <span class="o">+</span> <span class="n">n_b</span><span class="p">)</span>
        <span class="n">se</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">p_pooled</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">p_pooled</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">n_a</span> <span class="o">+</span> <span class="mi">1</span><span class="o">/</span><span class="n">n_b</span><span class="p">))</span>

        <span class="n">z</span> <span class="o">=</span> <span class="p">(</span><span class="n">p_a</span> <span class="o">-</span> <span class="n">p_b</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">se</span> <span class="o">+</span> <span class="mf">1e-10</span><span class="p">)</span>

        <span class="c1"># Critical value for 95% confidence</span>
        <span class="n">z_critical</span> <span class="o">=</span> <span class="mf">1.96</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;significant&#39;</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">z_critical</span><span class="p">,</span>
            <span class="s1">&#39;z_score&#39;</span><span class="p">:</span> <span class="n">z</span><span class="p">,</span>
            <span class="s1">&#39;winner&#39;</span><span class="p">:</span> <span class="s1">&#39;A&#39;</span> <span class="k">if</span> <span class="n">z</span> <span class="o">&gt;</span> <span class="n">z_critical</span> <span class="k">else</span> <span class="p">(</span><span class="s1">&#39;B&#39;</span> <span class="k">if</span> <span class="n">z</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">z_critical</span> <span class="k">else</span> <span class="s1">&#39;tie&#39;</span><span class="p">)</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">get_recommendation</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get deployment recommendation.&quot;&quot;&quot;</span>
        <span class="n">perf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_performance</span><span class="p">()</span>
        <span class="n">sig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_significant</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">sig</span><span class="p">[</span><span class="s1">&#39;significant&#39;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="s2">&quot;Continue testing - no significant difference yet&quot;</span>

        <span class="n">winner</span> <span class="o">=</span> <span class="n">sig</span><span class="p">[</span><span class="s1">&#39;winner&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Deploy Model </span><span class="si">{</span><span class="n">winner</span><span class="si">}</span><span class="s2"> - statistically significant improvement&quot;</span>

<span class="c1"># Usage</span>
<span class="c1"># ab_test = ABTestManager(model_v1, model_v2)</span>
</code></pre></div>


</details></div>
<div class="md-cell exercise-header"><h3>Exercise 13.6: Create Automated Retraining Pipeline (Open-ended)</h3>
<p>Build an automated pipeline that retrains models when performance degrades.</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 13.6: Create Automated Retraining Pipeline</span>
<span class="c1"># TODO: Create an AutoRetrainer class that:</span>
<span class="c1"># - Monitors model performance continuously</span>
<span class="c1"># - Triggers retraining when accuracy drops below threshold</span>
<span class="c1"># - Trains new model on recent data</span>
<span class="c1"># - Validates before auto-deploying</span>
<span class="c1"># - Logs all retraining events</span>

<span class="c1"># Your code here</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 13.6</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">AutoRetrainer</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">deployment_manager</span><span class="p">:</span> <span class="n">ModelDeploymentManager</span><span class="p">,</span>
                 <span class="n">monitor</span><span class="p">:</span> <span class="n">ModelMonitor</span><span class="p">,</span>
                 <span class="n">accuracy_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.48</span><span class="p">,</span>
                 <span class="n">retrain_window</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">252</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deployment_manager</span> <span class="o">=</span> <span class="n">deployment_manager</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">monitor</span> <span class="o">=</span> <span class="n">monitor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">accuracy_threshold</span> <span class="o">=</span> <span class="n">accuracy_threshold</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">retrain_window</span> <span class="o">=</span> <span class="n">retrain_window</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">retrain_history</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_retrain</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_retrain_interval</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">check_retrain_needed</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Check if retraining is needed.&quot;&quot;&quot;</span>
        <span class="n">current_accuracy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">monitor</span><span class="o">.</span><span class="n">calculate_rolling_accuracy</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">current_accuracy</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Check if enough time since last retrain</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_retrain</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_retrain</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_retrain_interval</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="n">current_accuracy</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">accuracy_threshold</span>

    <span class="k">def</span> <span class="nf">retrain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recent_data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
                <span class="n">model_class</span><span class="o">=</span><span class="n">RandomForestClassifier</span><span class="p">,</span>
                <span class="n">hyperparameters</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Retrain model on recent data.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_retrain_needed</span><span class="p">():</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">hyperparameters</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">hyperparameters</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;n_estimators&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span> <span class="s1">&#39;max_depth&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;random_state&#39;</span><span class="p">:</span> <span class="mi">42</span><span class="p">}</span>

        <span class="c1"># Use recent data for training</span>
        <span class="n">train_data</span> <span class="o">=</span> <span class="n">recent_data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">retrain_window</span><span class="p">:]</span>

        <span class="c1"># Train new version</span>
        <span class="n">version_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">deployment_manager</span><span class="o">.</span><span class="n">train_new_version</span><span class="p">(</span>
            <span class="n">train_data</span><span class="p">,</span> <span class="n">model_class</span><span class="p">,</span> <span class="n">hyperparameters</span>
        <span class="p">)</span>

        <span class="c1"># Log retraining</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">retrain_history</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
            <span class="s1">&#39;version_id&#39;</span><span class="p">:</span> <span class="n">version_id</span><span class="p">,</span>
            <span class="s1">&#39;trigger_accuracy&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">monitor</span><span class="o">.</span><span class="n">calculate_rolling_accuracy</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span>
        <span class="p">})</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">last_retrain</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">version_id</span>

    <span class="k">def</span> <span class="nf">auto_deploy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">version_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                    <span class="n">validation_data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
                    <span class="n">min_improvement</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.02</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Automatically deploy if new model is better.&quot;&quot;&quot;</span>
        <span class="c1"># Validate new model</span>
        <span class="n">is_valid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">deployment_manager</span><span class="o">.</span><span class="n">validate_before_deploy</span><span class="p">(</span>
            <span class="n">version_id</span><span class="p">,</span> <span class="n">validation_data</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_valid</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Check if improvement is significant</span>
        <span class="n">current_accuracy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">monitor</span><span class="o">.</span><span class="n">calculate_rolling_accuracy</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">0</span>
        <span class="n">new_accuracy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">deployment_manager</span><span class="o">.</span><span class="n">model_registry</span><span class="o">.</span><span class="n">versions</span><span class="p">[</span><span class="n">version_id</span><span class="p">]</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;val_accuracy&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">new_accuracy</span> <span class="o">-</span> <span class="n">current_accuracy</span> <span class="o">&gt;=</span> <span class="n">min_improvement</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">deployment_manager</span><span class="o">.</span><span class="n">deploy</span><span class="p">(</span><span class="n">version_id</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">run_auto_retrain_cycle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recent_data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
                                <span class="n">validation_data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Run complete auto-retrain cycle.&quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;retrain_needed&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_retrain_needed</span><span class="p">(),</span>
            <span class="s1">&#39;retrained&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s1">&#39;deployed&#39;</span><span class="p">:</span> <span class="kc">False</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;retrain_needed&#39;</span><span class="p">]:</span>
            <span class="n">version_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">retrain</span><span class="p">(</span><span class="n">recent_data</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">version_id</span><span class="p">:</span>
                <span class="n">result</span><span class="p">[</span><span class="s1">&#39;retrained&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">result</span><span class="p">[</span><span class="s1">&#39;version_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">version_id</span>
                <span class="n">result</span><span class="p">[</span><span class="s1">&#39;deployed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_deploy</span><span class="p">(</span><span class="n">version_id</span><span class="p">,</span> <span class="n">validation_data</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span>

<span class="c1"># Usage</span>
<span class="c1"># auto_retrainer = AutoRetrainer(deployment_manager, monitor)</span>
<span class="c1"># result = auto_retrainer.run_auto_retrain_cycle(recent_data, val_data)</span>
</code></pre></div>


</details></div>
<div class="md-cell key-takeaways"><hr />
<h2>Summary</h2>
<p>In this module, you learned:</p>
<ol>
<li>
<p><strong>Feature Pipelines</strong>: Building robust, versioned feature computation systems</p>
</li>
<li>
<p><strong>Model Versioning</strong>: Managing model versions with proper metadata and rollback capability</p>
</li>
<li>
<p><strong>Model Monitoring</strong>: Detecting drift, degradation, and anomalies in production</p>
</li>
<li>
<p><strong>Error Handling</strong>: Building resilient systems with fallbacks and alerts</p>
</li>
<li>
<p><strong>Production Systems</strong>: Integrating all components into a complete trading system</p>
</li>
</ol>
<h2>Key Takeaways</h2>
<ul>
<li>Feature pipelines must be consistent between training and inference</li>
<li>Model versioning enables reproducibility and safe rollbacks</li>
<li>Continuous monitoring catches problems before they cause losses</li>
<li>Fallback mechanisms ensure the system degrades gracefully</li>
<li>Production systems require more engineering than research systems</li>
</ul>
<h2>Next Steps</h2>
<p>In Module 14, you'll explore advanced ML topics including reinforcement learning, online learning, and ensemble methods for finance.</p></div>
        <div class="nav-buttons">
            <button class="nav-btn prev-btn disabled" type="button">
                <span class="nav-btn-label">‚Üê Previous</span>
                <span class="nav-btn-name"></span>
            </button>
            <button class="nav-btn next-btn disabled" type="button">
                <span class="nav-btn-label">Next ‚Üí</span>
                <span class="nav-btn-name"></span>
            </button>
        </div>
        </div>
<div class="module-section" data-idx="14"><div class="md-cell module-header"><h1>Module 14: Advanced ML Topics</h1>
<h2>Overview</h2>
<p>This module explores cutting-edge ML techniques for finance including reinforcement learning, online learning, and advanced ensemble methods. These techniques address unique challenges in financial markets.</p>
<h2>Learning Objectives</h2>
<p>By the end of this module, you will be able to:
- Apply reinforcement learning to portfolio optimization
- Implement online learning for adapting to market changes
- Build advanced ensemble methods for improved predictions
- Understand meta-learning approaches for finance</p>
<h2>Prerequisites</h2>
<ul>
<li>Module 11: Deep Learning for Finance</li>
<li>Module 12: Backtesting ML Strategies</li>
<li>Module 13: Production ML Systems</li>
</ul>
<h2>Estimated Time: 4 hours</h2></div>
<div class="md-cell"><hr />
<h2>Section 1: Reinforcement Learning for Trading</h2>
<p>Reinforcement learning (RL) frames trading as a sequential decision problem where an agent learns to maximize cumulative rewards.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">deque</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">from</span> <span class="nn">abc</span> <span class="kn">import</span> <span class="n">ABC</span><span class="p">,</span> <span class="n">abstractmethod</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>

<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Advanced ML libraries loaded&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Trading Environment for RL</span>
<span class="k">class</span> <span class="nc">TradingEnvironment</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;RL environment for trading.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">initial_capital</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">100000</span><span class="p">,</span>
                 <span class="n">commission</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.001</span><span class="p">,</span> <span class="n">window_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initial_capital</span> <span class="o">=</span> <span class="n">initial_capital</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">commission</span> <span class="o">=</span> <span class="n">commission</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">window_size</span> <span class="o">=</span> <span class="n">window_size</span>
        
        <span class="c1"># State variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_step</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">capital</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># -1, 0, 1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">entry_price</span> <span class="o">=</span> <span class="kc">None</span>
        
        <span class="c1"># Actions: 0=hold, 1=buy, 2=sell</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">action_space</span> <span class="o">=</span> <span class="mi">3</span>
        
    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Reset environment to initial state.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_step</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">window_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">capital</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_capital</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">entry_price</span> <span class="o">=</span> <span class="kc">None</span>
        
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_state</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">_get_state</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get current state observation.&quot;&quot;&quot;</span>
        <span class="c1"># Price-based features</span>
        <span class="n">window</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">current_step</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">window_size</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">current_step</span><span class="p">]</span>
        
        <span class="c1"># Normalized returns</span>
        <span class="n">returns</span> <span class="o">=</span> <span class="n">window</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
        
        <span class="c1"># Position encoding</span>
        <span class="n">position_encoding</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">position</span><span class="p">])</span>
        
        <span class="c1"># PnL if in position</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">entry_price</span><span class="p">:</span>
            <span class="n">unrealized_pnl</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">current_step</span><span class="p">][</span><span class="s1">&#39;close&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">entry_price</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">entry_price</span>
            <span class="n">unrealized_pnl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">unrealized_pnl</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">position</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">unrealized_pnl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">])</span>
        
        <span class="n">state</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">returns</span><span class="p">,</span> <span class="n">position_encoding</span><span class="p">,</span> <span class="n">unrealized_pnl</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">state</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">Dict</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Take action and return next state, reward, done, info.&quot;&quot;&quot;</span>
        <span class="n">current_price</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">current_step</span><span class="p">][</span><span class="s1">&#39;close&#39;</span><span class="p">]</span>
        <span class="n">reward</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="c1"># Execute action</span>
        <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># Buy</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># Close short if any</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">pnl</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">entry_price</span> <span class="o">-</span> <span class="n">current_price</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">entry_price</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">capital</span> <span class="o">*=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">pnl</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">commission</span><span class="p">)</span>
                
                <span class="c1"># Open long</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">entry_price</span> <span class="o">=</span> <span class="n">current_price</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">capital</span> <span class="o">*=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">commission</span><span class="p">)</span>
                
        <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># Sell</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># Close long if any</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">pnl</span> <span class="o">=</span> <span class="p">(</span><span class="n">current_price</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">entry_price</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">entry_price</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">capital</span> <span class="o">*=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">pnl</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">commission</span><span class="p">)</span>
                
                <span class="c1"># Open short</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">entry_price</span> <span class="o">=</span> <span class="n">current_price</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">capital</span> <span class="o">*=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">commission</span><span class="p">)</span>
        
        <span class="c1"># Move to next step</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_step</span> <span class="o">+=</span> <span class="mi">1</span>
        
        <span class="c1"># Calculate reward (daily return of position)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_step</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">):</span>
            <span class="n">next_price</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">current_step</span><span class="p">][</span><span class="s1">&#39;close&#39;</span><span class="p">]</span>
            <span class="n">price_return</span> <span class="o">=</span> <span class="p">(</span><span class="n">next_price</span> <span class="o">-</span> <span class="n">current_price</span><span class="p">)</span> <span class="o">/</span> <span class="n">current_price</span>
            <span class="n">reward</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">*</span> <span class="n">price_return</span>
        
        <span class="c1"># Check if done</span>
        <span class="n">done</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_step</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        
        <span class="c1"># Get next state</span>
        <span class="n">next_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_state</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">done</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">window_size</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>
        
        <span class="n">info</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;capital&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">capital</span><span class="p">,</span>
            <span class="s1">&#39;position&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">position</span><span class="p">,</span>
            <span class="s1">&#39;step&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_step</span>
        <span class="p">}</span>
        
        <span class="k">return</span> <span class="n">next_state</span><span class="p">,</span> <span class="n">reward</span><span class="p">,</span> <span class="n">done</span><span class="p">,</span> <span class="n">info</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">state_size</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get state dimension.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">window_size</span> <span class="o">+</span> <span class="mi">2</span>  <span class="c1"># returns + position + unrealized pnl</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;TradingEnvironment class defined&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Q-Learning Agent</span>
<span class="k">class</span> <span class="nc">QLearningAgent</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Simple Q-learning agent for trading.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">action_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                 <span class="n">learning_rate</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">,</span>
                 <span class="n">gamma</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.95</span><span class="p">,</span>
                 <span class="n">epsilon</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
                 <span class="n">epsilon_decay</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.995</span><span class="p">,</span>
                 <span class="n">epsilon_min</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state_size</span> <span class="o">=</span> <span class="n">state_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">action_size</span> <span class="o">=</span> <span class="n">action_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">learning_rate</span> <span class="o">=</span> <span class="n">learning_rate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gamma</span> <span class="o">=</span> <span class="n">gamma</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epsilon</span> <span class="o">=</span> <span class="n">epsilon</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epsilon_decay</span> <span class="o">=</span> <span class="n">epsilon_decay</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epsilon_min</span> <span class="o">=</span> <span class="n">epsilon_min</span>
        
        <span class="c1"># Q-table (discretized)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_bins</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">q_table</span> <span class="o">=</span> <span class="p">{}</span>
        
    <span class="k">def</span> <span class="nf">_discretize_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Discretize continuous state.&quot;&quot;&quot;</span>
        <span class="c1"># Clip and bin the state</span>
        <span class="n">clipped</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">binned</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">digitize</span><span class="p">(</span><span class="n">clipped</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_bins</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">binned</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">get_q_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get Q-values for a state.&quot;&quot;&quot;</span>
        <span class="n">discrete_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_discretize_state</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">discrete_state</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">q_table</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">q_table</span><span class="p">[</span><span class="n">discrete_state</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">action_size</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">q_table</span><span class="p">[</span><span class="n">discrete_state</span><span class="p">]</span>
    
    <span class="k">def</span> <span class="nf">choose_action</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">training</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Choose action using epsilon-greedy policy.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">training</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">epsilon</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">action_size</span><span class="p">)</span>
        
        <span class="n">q_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_q_values</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">q_values</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">learn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">action</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> 
              <span class="n">reward</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">next_state</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">done</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update Q-values.&quot;&quot;&quot;</span>
        <span class="n">discrete_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_discretize_state</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
        <span class="n">discrete_next_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_discretize_state</span><span class="p">(</span><span class="n">next_state</span><span class="p">)</span>
        
        <span class="c1"># Initialize if needed</span>
        <span class="k">if</span> <span class="n">discrete_state</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">q_table</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">q_table</span><span class="p">[</span><span class="n">discrete_state</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">action_size</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">discrete_next_state</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">q_table</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">q_table</span><span class="p">[</span><span class="n">discrete_next_state</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">action_size</span><span class="p">)</span>
        
        <span class="c1"># Q-learning update</span>
        <span class="n">current_q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">q_table</span><span class="p">[</span><span class="n">discrete_state</span><span class="p">][</span><span class="n">action</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="n">done</span><span class="p">:</span>
            <span class="n">target_q</span> <span class="o">=</span> <span class="n">reward</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">target_q</span> <span class="o">=</span> <span class="n">reward</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">gamma</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">q_table</span><span class="p">[</span><span class="n">discrete_next_state</span><span class="p">])</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">q_table</span><span class="p">[</span><span class="n">discrete_state</span><span class="p">][</span><span class="n">action</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">learning_rate</span> <span class="o">*</span> <span class="p">(</span><span class="n">target_q</span> <span class="o">-</span> <span class="n">current_q</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">decay_epsilon</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Decay exploration rate.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epsilon</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">epsilon_min</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">epsilon</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">epsilon_decay</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;QLearningAgent class defined&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Generate data and train RL agent</span>
<span class="k">def</span> <span class="nf">generate_trading_data</span><span class="p">(</span><span class="n">n_samples</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
    <span class="n">returns</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mf">0.0003</span><span class="p">,</span> <span class="mf">0.015</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">)</span>
    <span class="n">prices</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">returns</span><span class="p">))</span>
    
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
        <span class="s1">&#39;close&#39;</span><span class="p">:</span> <span class="n">prices</span><span class="p">,</span>
        <span class="s1">&#39;volume&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">lognormal</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">)</span>
    <span class="p">})</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">generate_trading_data</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>

<span class="c1"># Create environment and agent</span>
<span class="n">env</span> <span class="o">=</span> <span class="n">TradingEnvironment</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">window_size</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">agent</span> <span class="o">=</span> <span class="n">QLearningAgent</span><span class="p">(</span>
    <span class="n">state_size</span><span class="o">=</span><span class="n">env</span><span class="o">.</span><span class="n">state_size</span><span class="p">,</span>
    <span class="n">action_size</span><span class="o">=</span><span class="n">env</span><span class="o">.</span><span class="n">action_space</span>
<span class="p">)</span>

<span class="c1"># Training loop</span>
<span class="n">n_episodes</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">episode_rewards</span> <span class="o">=</span> <span class="p">[]</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Training RL agent...&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">episode</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_episodes</span><span class="p">):</span>
    <span class="n">state</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
    <span class="n">total_reward</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">done</span> <span class="o">=</span> <span class="kc">False</span>
    
    <span class="k">while</span> <span class="ow">not</span> <span class="n">done</span><span class="p">:</span>
        <span class="n">action</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">choose_action</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">training</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">next_state</span><span class="p">,</span> <span class="n">reward</span><span class="p">,</span> <span class="n">done</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>
        
        <span class="n">agent</span><span class="o">.</span><span class="n">learn</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="n">reward</span><span class="p">,</span> <span class="n">next_state</span><span class="p">,</span> <span class="n">done</span><span class="p">)</span>
        
        <span class="n">state</span> <span class="o">=</span> <span class="n">next_state</span>
        <span class="n">total_reward</span> <span class="o">+=</span> <span class="n">reward</span>
    
    <span class="n">agent</span><span class="o">.</span><span class="n">decay_epsilon</span><span class="p">()</span>
    <span class="n">episode_rewards</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">total_reward</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="n">episode</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">20</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">avg_reward</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">episode_rewards</span><span class="p">[</span><span class="o">-</span><span class="mi">20</span><span class="p">:])</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Episode </span><span class="si">{</span><span class="n">episode</span> <span class="o">+</span> <span class="mi">1</span><span class="si">}</span><span class="s2">: Avg Reward = </span><span class="si">{</span><span class="n">avg_reward</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, Epsilon = </span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">epsilon</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Evaluate trained agent</span>
<span class="n">state</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
<span class="n">done</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">capitals</span> <span class="o">=</span> <span class="p">[</span><span class="n">env</span><span class="o">.</span><span class="n">initial_capital</span><span class="p">]</span>
<span class="n">positions</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="k">while</span> <span class="ow">not</span> <span class="n">done</span><span class="p">:</span>
    <span class="n">action</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">choose_action</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">training</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">next_state</span><span class="p">,</span> <span class="n">reward</span><span class="p">,</span> <span class="n">done</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>
    
    <span class="n">capitals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;capital&#39;</span><span class="p">])</span>
    <span class="n">positions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;position&#39;</span><span class="p">])</span>
    <span class="n">state</span> <span class="o">=</span> <span class="n">next_state</span>

<span class="c1"># Visualize results</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

<span class="c1"># Training rewards</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">episode_rewards</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Episode&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Total Reward&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Training Progress&#39;</span><span class="p">)</span>

<span class="c1"># Equity curve</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">capitals</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Step&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Capital ($)&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;RL Agent Equity Curve&#39;</span><span class="p">)</span>

<span class="c1"># Position over time</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">positions</span><span class="p">)),</span> <span class="n">positions</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="s1">&#39;post&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Step&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Position&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Positions Over Time&#39;</span><span class="p">)</span>

<span class="c1"># Compare with buy and hold</span>
<span class="n">buy_hold</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">initial_capital</span> <span class="o">*</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">capitals</span><span class="p">)),</span> <span class="n">capitals</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;RL Agent&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">buy_hold</span><span class="p">)),</span> <span class="n">buy_hold</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Buy &amp; Hold&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Step&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Capital ($)&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;RL vs Buy &amp; Hold&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Final Capital: $</span><span class="si">{</span><span class="n">capitals</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">,.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total Return: </span><span class="si">{</span><span class="p">(</span><span class="n">capitals</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">capitals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><hr />
<h2>Section 2: Online Learning</h2>
<p>Online learning allows models to adapt continuously to new data without full retraining.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Online Learning Framework</span>
<span class="k">class</span> <span class="nc">OnlineLearner</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Abstract base class for online learning.&quot;&quot;&quot;</span>
    
    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">partial_fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="k">pass</span>
    
    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="k">pass</span>


<span class="k">class</span> <span class="nc">OnlineSGDClassifier</span><span class="p">(</span><span class="n">OnlineLearner</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Online SGD classifier with adaptive learning.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_features</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">learning_rate</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">,</span>
                 <span class="n">l2_reg</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.001</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_features</span> <span class="o">=</span> <span class="n">n_features</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">learning_rate</span> <span class="o">=</span> <span class="n">learning_rate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">l2_reg</span> <span class="o">=</span> <span class="n">l2_reg</span>
        
        <span class="c1"># Initialize weights</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_features</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bias</span> <span class="o">=</span> <span class="mf">0.0</span>
        
        <span class="c1"># Adaptive learning rate (AdaGrad)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grad_squared</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_features</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bias_grad_squared</span> <span class="o">=</span> <span class="mf">0.0</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">n_samples_seen</span> <span class="o">=</span> <span class="mi">0</span>
        
    <span class="k">def</span> <span class="nf">_sigmoid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">z</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Sigmoid activation.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="o">-</span><span class="mi">500</span><span class="p">,</span> <span class="mi">500</span><span class="p">)))</span>
    
    <span class="k">def</span> <span class="nf">partial_fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update model with new samples.&quot;&quot;&quot;</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">xi</span><span class="p">,</span> <span class="n">yi</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
            <span class="c1"># Forward pass</span>
            <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">xi</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">bias</span>
            <span class="n">pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sigmoid</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
            
            <span class="c1"># Gradient</span>
            <span class="n">error</span> <span class="o">=</span> <span class="n">pred</span> <span class="o">-</span> <span class="n">yi</span>
            <span class="n">grad_w</span> <span class="o">=</span> <span class="n">error</span> <span class="o">*</span> <span class="n">xi</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">l2_reg</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span>
            <span class="n">grad_b</span> <span class="o">=</span> <span class="n">error</span>
            
            <span class="c1"># AdaGrad update</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">grad_squared</span> <span class="o">+=</span> <span class="n">grad_w</span> <span class="o">**</span> <span class="mi">2</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bias_grad_squared</span> <span class="o">+=</span> <span class="n">grad_b</span> <span class="o">**</span> <span class="mi">2</span>
            
            <span class="n">adj_lr_w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">learning_rate</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grad_squared</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1e-8</span><span class="p">)</span>
            <span class="n">adj_lr_b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">learning_rate</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bias_grad_squared</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1e-8</span><span class="p">)</span>
            
            <span class="c1"># Update weights</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">weights</span> <span class="o">-=</span> <span class="n">adj_lr_w</span> <span class="o">*</span> <span class="n">grad_w</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bias</span> <span class="o">-=</span> <span class="n">adj_lr_b</span> <span class="o">*</span> <span class="n">grad_b</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">n_samples_seen</span> <span class="o">+=</span> <span class="mi">1</span>
    
    <span class="k">def</span> <span class="nf">predict_proba</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Predict probabilities.&quot;&quot;&quot;</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">bias</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sigmoid</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Predict class labels.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;OnlineSGDClassifier defined&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Online Learning with Concept Drift Detection</span>
<span class="k">class</span> <span class="nc">DriftDetector</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Detect concept drift in streaming data.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">window_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span> <span class="n">threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">window_size</span> <span class="o">=</span> <span class="n">window_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="o">=</span> <span class="n">threshold</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">error_window</span> <span class="o">=</span> <span class="n">deque</span><span class="p">(</span><span class="n">maxlen</span><span class="o">=</span><span class="n">window_size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">baseline_error</span> <span class="o">=</span> <span class="kc">None</span>
        
    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_error</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update with new prediction result.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">error_window</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span> <span class="k">if</span> <span class="n">is_error</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">error_window</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">window_size</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">baseline_error</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">baseline_error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">error_window</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">is_drift</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Check if drift has occurred.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">baseline_error</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">error_window</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">window_size</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        
        <span class="n">current_error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">error_window</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">current_error</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">baseline_error</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span>
    
    <span class="k">def</span> <span class="nf">reset_baseline</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Reset baseline after handling drift.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">error_window</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">window_size</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">baseline_error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">error_window</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">AdaptiveOnlineLearner</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Online learner with drift detection and adaptation.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_features</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">learning_rate</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">OnlineSGDClassifier</span><span class="p">(</span><span class="n">n_features</span><span class="p">,</span> <span class="n">learning_rate</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">drift_detector</span> <span class="o">=</span> <span class="n">DriftDetector</span><span class="p">(</span><span class="n">window_size</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.15</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">predictions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">actuals</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">drift_points</span> <span class="o">=</span> <span class="p">[]</span>
        
    <span class="k">def</span> <span class="nf">predict_and_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Make prediction and update model.&quot;&quot;&quot;</span>
        <span class="c1"># Predict</span>
        <span class="n">pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        
        <span class="c1"># Record</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">predictions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pred</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">actuals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        
        <span class="c1"># Check for drift</span>
        <span class="n">is_error</span> <span class="o">=</span> <span class="n">pred</span> <span class="o">!=</span> <span class="n">y</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">drift_detector</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">is_error</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">drift_detector</span><span class="o">.</span><span class="n">is_drift</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">drift_points</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">predictions</span><span class="p">))</span>
            <span class="c1"># Increase learning rate temporarily</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">learning_rate</span> <span class="o">*=</span> <span class="mi">2</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">drift_detector</span><span class="o">.</span><span class="n">reset_baseline</span><span class="p">()</span>
        
        <span class="c1"># Update model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">partial_fit</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">y</span><span class="p">]))</span>
        
        <span class="c1"># Decay learning rate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">learning_rate</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.001</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">learning_rate</span> <span class="o">*</span> <span class="mf">0.999</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">pred</span>
    
    <span class="k">def</span> <span class="nf">get_rolling_accuracy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">window</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get rolling accuracy.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">predictions</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">window</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        
        <span class="n">recent_pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predictions</span><span class="p">[</span><span class="o">-</span><span class="n">window</span><span class="p">:]</span>
        <span class="n">recent_actual</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">actuals</span><span class="p">[</span><span class="o">-</span><span class="n">window</span><span class="p">:]</span>
        
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">recent_pred</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">recent_actual</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;AdaptiveOnlineLearner defined&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Test online learning with simulated concept drift</span>
<span class="k">def</span> <span class="nf">generate_drift_data</span><span class="p">(</span><span class="n">n_samples</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">drift_point</span><span class="o">=</span><span class="mi">500</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Generate data with concept drift.&quot;&quot;&quot;</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
    
    <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">n_samples</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
    
    <span class="c1"># Before drift: y depends on X[:, 0] + X[:, 1]</span>
    <span class="n">y_before</span> <span class="o">=</span> <span class="p">((</span><span class="n">X</span><span class="p">[:</span><span class="n">drift_point</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">X</span><span class="p">[:</span><span class="n">drift_point</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    
    <span class="c1"># After drift: y depends on X[:, 2] - X[:, 3]</span>
    <span class="n">y_after</span> <span class="o">=</span> <span class="p">((</span><span class="n">X</span><span class="p">[</span><span class="n">drift_point</span><span class="p">:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">X</span><span class="p">[</span><span class="n">drift_point</span><span class="p">:,</span> <span class="mi">3</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">y_before</span><span class="p">,</span> <span class="n">y_after</span><span class="p">])</span>
    
    <span class="k">return</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span>

<span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">generate_drift_data</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="n">drift_point</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>

<span class="c1"># Train adaptive online learner</span>
<span class="n">online_learner</span> <span class="o">=</span> <span class="n">AdaptiveOnlineLearner</span><span class="p">(</span><span class="n">n_features</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>

<span class="n">rolling_accuracies</span> <span class="o">=</span> <span class="p">[]</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Training adaptive online learner...&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)):</span>
    <span class="n">online_learner</span><span class="o">.</span><span class="n">predict_and_update</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    
    <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">50</span><span class="p">:</span>
        <span class="n">acc</span> <span class="o">=</span> <span class="n">online_learner</span><span class="o">.</span><span class="n">get_rolling_accuracy</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span>
        <span class="n">rolling_accuracies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">acc</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Drift detected at points: </span><span class="si">{</span><span class="n">online_learner</span><span class="o">.</span><span class="n">drift_points</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Final rolling accuracy: </span><span class="si">{</span><span class="n">rolling_accuracies</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Visualize online learning</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

<span class="c1"># Rolling accuracy</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)),</span> <span class="n">rolling_accuracies</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;True Drift Point&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">dp</span> <span class="ow">in</span> <span class="n">online_learner</span><span class="o">.</span><span class="n">drift_points</span><span class="p">:</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">dp</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Sample&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Rolling Accuracy (50)&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Online Learning Accuracy with Concept Drift&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="c1"># Cumulative accuracy</span>
<span class="n">cumulative_correct</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">online_learner</span><span class="o">.</span><span class="n">predictions</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">online_learner</span><span class="o">.</span><span class="n">actuals</span><span class="p">))</span>
<span class="n">cumulative_accuracy</span> <span class="o">=</span> <span class="n">cumulative_correct</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">cumulative_correct</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">cumulative_accuracy</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Drift Point&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Sample&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Cumulative Accuracy&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Cumulative Accuracy Over Time&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
<div class="md-cell"><hr />
<h2>Section 3: Advanced Ensemble Methods</h2>
<p>Advanced ensembles go beyond simple averaging to dynamically weight models based on recent performance.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Dynamic Weighted Ensemble</span>
<span class="k">class</span> <span class="nc">DynamicEnsemble</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Ensemble that dynamically adjusts weights based on performance.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">models</span><span class="p">:</span> <span class="n">List</span><span class="p">,</span> <span class="n">weight_decay</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.95</span><span class="p">,</span>
                 <span class="n">min_weight</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">models</span> <span class="o">=</span> <span class="n">models</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_models</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">models</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weight_decay</span> <span class="o">=</span> <span class="n">weight_decay</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_weight</span> <span class="o">=</span> <span class="n">min_weight</span>
        
        <span class="c1"># Initialize equal weights</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_models</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_models</span>
        
        <span class="c1"># Track performance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_correct</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_models</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_total</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_models</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Make weighted ensemble prediction.&quot;&quot;&quot;</span>
        <span class="n">predictions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">m</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">])</span>
        
        <span class="c1"># Weighted voting</span>
        <span class="n">weighted_sum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">,</span> <span class="n">predictions</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">weighted_sum</span> <span class="o">&gt;=</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">predict_proba</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get weighted probability.&quot;&quot;&quot;</span>
        <span class="n">probas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">m</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s1">&#39;predict_proba&#39;</span><span class="p">)</span> 
                          <span class="k">else</span> <span class="n">m</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">,</span> <span class="n">probas</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">update_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">y_true</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update weights based on individual model performance.&quot;&quot;&quot;</span>
        <span class="c1"># Get individual predictions</span>
        <span class="n">predictions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">m</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">])</span>
        
        <span class="c1"># Update performance tracking</span>
        <span class="n">correct</span> <span class="o">=</span> <span class="n">predictions</span> <span class="o">==</span> <span class="n">y_true</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_correct</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight_decay</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_correct</span> <span class="o">+</span> <span class="n">correct</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_total</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight_decay</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_total</span> <span class="o">+</span> <span class="mi">1</span>
        
        <span class="c1"># Calculate new weights based on accuracy</span>
        <span class="n">accuracies</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_correct</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_total</span> <span class="o">+</span> <span class="mf">1e-8</span><span class="p">)</span>
        
        <span class="c1"># Ensure minimum weight</span>
        <span class="n">accuracies</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">accuracies</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_weight</span><span class="p">)</span>
        
        <span class="c1"># Normalize weights</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="n">accuracies</span> <span class="o">/</span> <span class="n">accuracies</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">get_model_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Get current model weights.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="n">w</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">w</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">)}</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;DynamicEnsemble defined&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Stacking Ensemble with Meta-Learner</span>
<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LogisticRegression</span>
<span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">RandomForestClassifier</span><span class="p">,</span> <span class="n">GradientBoostingClassifier</span>
<span class="kn">from</span> <span class="nn">sklearn.svm</span> <span class="kn">import</span> <span class="n">SVC</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">cross_val_predict</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">StandardScaler</span>

<span class="k">class</span> <span class="nc">StackingEnsemble</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Stacking ensemble with meta-learner.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base_models</span><span class="p">:</span> <span class="n">List</span><span class="p">,</span> <span class="n">meta_model</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_models</span> <span class="o">=</span> <span class="n">base_models</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meta_model</span> <span class="o">=</span> <span class="n">meta_model</span> <span class="ow">or</span> <span class="n">LogisticRegression</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fitted</span> <span class="o">=</span> <span class="kc">False</span>
        
    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Fit stacking ensemble.&quot;&quot;&quot;</span>
        <span class="c1"># Scale features</span>
        <span class="n">X_scaled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        
        <span class="c1"># Generate base model predictions using cross-validation</span>
        <span class="n">meta_features</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_models</span><span class="p">)))</span>
        
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">model</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_models</span><span class="p">):</span>
            <span class="c1"># Get out-of-fold predictions</span>
            <span class="n">meta_features</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">cross_val_predict</span><span class="p">(</span>
                <span class="n">model</span><span class="p">,</span> <span class="n">X_scaled</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;predict&#39;</span>
            <span class="p">)</span>
            <span class="c1"># Fit on full data</span>
            <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_scaled</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        
        <span class="c1"># Fit meta-learner</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meta_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">meta_features</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fitted</span> <span class="o">=</span> <span class="kc">True</span>
        
    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Make stacked prediction.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitted</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Model not fitted&quot;</span><span class="p">)</span>
        
        <span class="n">X_scaled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        
        <span class="c1"># Get base model predictions</span>
        <span class="n">meta_features</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">([</span>
            <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_scaled</span><span class="p">)</span> <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_models</span>
        <span class="p">])</span>
        
        <span class="c1"># Meta-learner prediction</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">meta_features</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">predict_proba</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get probability predictions.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitted</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Model not fitted&quot;</span><span class="p">)</span>
        
        <span class="n">X_scaled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        
        <span class="n">meta_features</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">([</span>
            <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_scaled</span><span class="p">)</span> <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_models</span>
        <span class="p">])</span>
        
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta_model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">meta_features</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;StackingEnsemble defined&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Test stacking ensemble</span>
<span class="kn">from</span> <span class="nn">sklearn.datasets</span> <span class="kn">import</span> <span class="n">make_classification</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">accuracy_score</span>

<span class="c1"># Generate data</span>
<span class="n">X_class</span><span class="p">,</span> <span class="n">y_class</span> <span class="o">=</span> <span class="n">make_classification</span><span class="p">(</span><span class="n">n_samples</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">n_features</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
                                        <span class="n">n_informative</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>

<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
    <span class="n">X_class</span><span class="p">,</span> <span class="n">y_class</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span>
<span class="p">)</span>

<span class="c1"># Create base models</span>
<span class="n">base_models</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">RandomForestClassifier</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">),</span>
    <span class="n">GradientBoostingClassifier</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">),</span>
    <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
<span class="p">]</span>

<span class="c1"># Train stacking ensemble</span>
<span class="n">stacking</span> <span class="o">=</span> <span class="n">StackingEnsemble</span><span class="p">(</span><span class="n">base_models</span><span class="p">)</span>
<span class="n">stacking</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

<span class="c1"># Evaluate</span>
<span class="n">stacking_pred</span> <span class="o">=</span> <span class="n">stacking</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
<span class="n">stacking_acc</span> <span class="o">=</span> <span class="n">accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">stacking_pred</span><span class="p">)</span>

<span class="c1"># Compare with individual models</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Model Comparison:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Stacking Ensemble: </span><span class="si">{</span><span class="n">stacking_acc</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">model</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">base_models</span><span class="p">):</span>
    <span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
    <span class="n">X_train_scaled</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
    <span class="n">X_test_scaled</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_scaled</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
    <span class="n">pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test_scaled</span><span class="p">)</span>
    <span class="n">acc</span> <span class="o">=</span> <span class="n">accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">pred</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Model </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">model</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="n">acc</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><hr />
<h2>Section 4: Meta-Learning for Finance</h2>
<p>Meta-learning aims to learn how to learn, enabling quick adaptation to new market regimes.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Model Selection Meta-Learner</span>
<span class="k">class</span> <span class="nc">ModelSelector</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Meta-learner that selects best model based on market conditions.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">models</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">models</span> <span class="o">=</span> <span class="n">models</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_performance</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">deque</span><span class="p">(</span><span class="n">maxlen</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">models</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">regime_detector</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">regime_model_map</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Maps regime to best model</span>
        
    <span class="k">def</span> <span class="nf">detect_regime</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Detect current market regime.&quot;&quot;&quot;</span>
        <span class="c1"># Simple regime detection based on volatility and trend</span>
        <span class="n">volatility</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">features</span><span class="p">[</span><span class="o">-</span><span class="mi">20</span><span class="p">:,</span> <span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">features</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">20</span> <span class="k">else</span> <span class="mf">0.01</span>
        <span class="n">trend</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">features</span><span class="p">[</span><span class="o">-</span><span class="mi">10</span><span class="p">:,</span> <span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">features</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">10</span> <span class="k">else</span> <span class="mi">0</span>
        
        <span class="k">if</span> <span class="n">volatility</span> <span class="o">&gt;</span> <span class="mf">0.02</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;high_volatility&#39;</span>
        <span class="k">elif</span> <span class="n">trend</span> <span class="o">&gt;</span> <span class="mf">0.001</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;bullish&#39;</span>
        <span class="k">elif</span> <span class="n">trend</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">0.001</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;bearish&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;sideways&#39;</span>
    
    <span class="k">def</span> <span class="nf">select_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Select best model for current conditions.&quot;&quot;&quot;</span>
        <span class="n">regime</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detect_regime</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>
        
        <span class="c1"># Check if we have learned which model works best for this regime</span>
        <span class="k">if</span> <span class="n">regime</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">regime_model_map</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">regime_model_map</span><span class="p">[</span><span class="n">regime</span><span class="p">]</span>
        
        <span class="c1"># Otherwise, select model with best recent performance</span>
        <span class="n">best_model</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">best_accuracy</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">perf</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_performance</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">perf</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">acc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">perf</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">acc</span> <span class="o">&gt;</span> <span class="n">best_accuracy</span><span class="p">:</span>
                    <span class="n">best_accuracy</span> <span class="o">=</span> <span class="n">acc</span>
                    <span class="n">best_model</span> <span class="o">=</span> <span class="n">name</span>
        
        <span class="k">return</span> <span class="n">best_model</span> <span class="ow">or</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
    
    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">features_history</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Make prediction using selected model.&quot;&quot;&quot;</span>
        <span class="n">model_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">select_model</span><span class="p">(</span><span class="n">features_history</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="n">model_name</span><span class="p">]</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">update_performance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">is_correct</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
                            <span class="n">features</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update model performance tracking.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_performance</span><span class="p">[</span><span class="n">model_name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span> <span class="k">if</span> <span class="n">is_correct</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
        
        <span class="c1"># Update regime-model mapping</span>
        <span class="n">regime</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detect_regime</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>
        
        <span class="c1"># Find best model for this regime</span>
        <span class="n">best_acc</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">best_model</span> <span class="o">=</span> <span class="kc">None</span>
        
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">perf</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_performance</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">perf</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">10</span><span class="p">:</span>
                <span class="n">acc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">perf</span><span class="p">)[</span><span class="o">-</span><span class="mi">10</span><span class="p">:])</span>
                <span class="k">if</span> <span class="n">acc</span> <span class="o">&gt;</span> <span class="n">best_acc</span><span class="p">:</span>
                    <span class="n">best_acc</span> <span class="o">=</span> <span class="n">acc</span>
                    <span class="n">best_model</span> <span class="o">=</span> <span class="n">name</span>
        
        <span class="k">if</span> <span class="n">best_model</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">regime_model_map</span><span class="p">[</span><span class="n">regime</span><span class="p">]</span> <span class="o">=</span> <span class="n">best_model</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ModelSelector defined&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Regime-Specific Model Training</span>
<span class="k">class</span> <span class="nc">RegimeAdaptiveSystem</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;System that adapts model based on detected regime.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">regime_models</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;high_volatility&#39;</span><span class="p">:</span> <span class="n">RandomForestClassifier</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">),</span>
            <span class="s1">&#39;bullish&#39;</span><span class="p">:</span> <span class="n">GradientBoostingClassifier</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">),</span>
            <span class="s1">&#39;bearish&#39;</span><span class="p">:</span> <span class="n">GradientBoostingClassifier</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">),</span>
            <span class="s1">&#39;sideways&#39;</span><span class="p">:</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">regime_data</span> <span class="o">=</span> <span class="p">{</span><span class="n">regime</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="p">[]}</span> <span class="k">for</span> <span class="n">regime</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">regime_models</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_samples</span> <span class="o">=</span> <span class="mi">50</span>
        
    <span class="k">def</span> <span class="nf">detect_regime</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Detect market regime from price data.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;sideways&#39;</span>
        
        <span class="n">returns</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
        <span class="n">volatility</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
        <span class="n">trend</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="n">volatility</span> <span class="o">&gt;</span> <span class="mf">0.02</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;high_volatility&#39;</span>
        <span class="k">elif</span> <span class="n">trend</span> <span class="o">&gt;</span> <span class="mf">0.001</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;bullish&#39;</span>
        <span class="k">elif</span> <span class="n">trend</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">0.001</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;bearish&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;sideways&#39;</span>
    
    <span class="k">def</span> <span class="nf">add_sample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">regime</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add training sample to regime-specific data.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">regime_data</span><span class="p">[</span><span class="n">regime</span><span class="p">][</span><span class="s1">&#39;X&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">regime_data</span><span class="p">[</span><span class="n">regime</span><span class="p">][</span><span class="s1">&#39;y&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        
        <span class="c1"># Retrain if enough samples</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">regime_data</span><span class="p">[</span><span class="n">regime</span><span class="p">][</span><span class="s1">&#39;X&#39;</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_samples</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_retrain_regime</span><span class="p">(</span><span class="n">regime</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">_retrain_regime</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">regime</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Retrain model for specific regime.&quot;&quot;&quot;</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">regime_data</span><span class="p">[</span><span class="n">regime</span><span class="p">][</span><span class="s1">&#39;X&#39;</span><span class="p">])</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">regime_data</span><span class="p">[</span><span class="n">regime</span><span class="p">][</span><span class="s1">&#39;y&#39;</span><span class="p">])</span>
        
        <span class="n">X_scaled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">regime_models</span><span class="p">[</span><span class="n">regime</span><span class="p">]</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_scaled</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Predict using regime-appropriate model.&quot;&quot;&quot;</span>
        <span class="n">regime</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detect_regime</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        
        <span class="c1"># Check if model is trained</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">regime_data</span><span class="p">[</span><span class="n">regime</span><span class="p">][</span><span class="s1">&#39;X&#39;</span><span class="p">])</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_samples</span><span class="p">:</span>
            <span class="c1"># Use default model</span>
            <span class="n">regime</span> <span class="o">=</span> <span class="s1">&#39;sideways&#39;</span>
        
        <span class="n">X_scaled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">regime_models</span><span class="p">[</span><span class="n">regime</span><span class="p">]</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_scaled</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;RegimeAdaptiveSystem defined&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><hr />
<h2>Section 5: Module Project - Advanced Trading System</h2>
<p>Build an advanced trading system combining RL, online learning, and ensemble methods.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Advanced ML Trading System</span>
<span class="k">class</span> <span class="nc">AdvancedMLTradingSystem</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Trading system combining multiple advanced ML techniques.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">initial_capital</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">100000</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initial_capital</span> <span class="o">=</span> <span class="n">initial_capital</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">capital</span> <span class="o">=</span> <span class="n">initial_capital</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="c1"># Components</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">online_learner</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ensemble</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">regime_system</span> <span class="o">=</span> <span class="n">RegimeAdaptiveSystem</span><span class="p">()</span>
        
        <span class="c1"># Tracking</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">equity_curve</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">signals</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">regime_history</span> <span class="o">=</span> <span class="p">[]</span>
        
    <span class="k">def</span> <span class="nf">create_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Create features from price data.&quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        
        <span class="c1"># Returns</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;return_1d&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;return_5d&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
        
        <span class="c1"># Volatility</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;volatility&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;return_1d&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
        
        <span class="c1"># RSI</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span>
        <span class="n">gain</span> <span class="o">=</span> <span class="p">(</span><span class="n">delta</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">delta</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">14</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">delta</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">delta</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">14</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;rsi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">-</span> <span class="p">(</span><span class="mi">100</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">gain</span> <span class="o">/</span> <span class="p">(</span><span class="n">loss</span> <span class="o">+</span> <span class="mf">1e-10</span><span class="p">)))</span>
        
        <span class="c1"># Price to SMA</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;price_to_sma&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        
        <span class="n">feature_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;return_1d&#39;</span><span class="p">,</span> <span class="s1">&#39;return_5d&#39;</span><span class="p">,</span> <span class="s1">&#39;volatility&#39;</span><span class="p">,</span> <span class="s1">&#39;rsi&#39;</span><span class="p">,</span> <span class="s1">&#39;price_to_sma&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">data</span><span class="p">[</span><span class="n">feature_cols</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
    
    <span class="k">def</span> <span class="nf">initialize_models</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">train_data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize all models with training data.&quot;&quot;&quot;</span>
        <span class="n">features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_features</span><span class="p">(</span><span class="n">train_data</span><span class="p">)</span>
        
        <span class="c1"># Create target</span>
        <span class="n">target</span> <span class="o">=</span> <span class="p">(</span><span class="n">train_data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">train_data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
        
        <span class="c1"># Remove NaN</span>
        <span class="n">valid_idx</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">features</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">features</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="n">valid_idx</span><span class="p">]</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">target</span><span class="p">[</span><span class="n">valid_idx</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># Remove last (no target)</span>
        <span class="n">features</span> <span class="o">=</span> <span class="n">features</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        
        <span class="c1"># Scale features</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scaler</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>
        <span class="n">features_scaled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>
        
        <span class="c1"># Initialize online learner</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">online_learner</span> <span class="o">=</span> <span class="n">OnlineSGDClassifier</span><span class="p">(</span><span class="n">n_features</span><span class="o">=</span><span class="n">features</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">features</span><span class="p">))):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">online_learner</span><span class="o">.</span><span class="n">partial_fit</span><span class="p">(</span>
                <span class="n">features_scaled</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">target</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
            <span class="p">)</span>
        
        <span class="c1"># Initialize ensemble</span>
        <span class="n">base_models</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">RandomForestClassifier</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">),</span>
            <span class="n">GradientBoostingClassifier</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">),</span>
            <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
        <span class="p">]</span>
        
        <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">base_models</span><span class="p">:</span>
            <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">features_scaled</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">ensemble</span> <span class="o">=</span> <span class="n">DynamicEnsemble</span><span class="p">(</span><span class="n">base_models</span><span class="p">)</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Models initialized&quot;</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">generate_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current_data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Generate trading signal using ensemble of methods.&quot;&quot;&quot;</span>
        <span class="n">features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_features</span><span class="p">(</span><span class="n">current_data</span><span class="p">)</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span>
        
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="k">return</span> <span class="mi">0</span>
        
        <span class="n">X_scaled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        
        <span class="c1"># Get predictions from different methods</span>
        <span class="n">online_pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">online_learner</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_scaled</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">ensemble_pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensemble</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_scaled</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">regime_pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">regime_system</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_scaled</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">current_data</span><span class="p">)</span>
        
        <span class="c1"># Combine predictions (majority voting)</span>
        <span class="n">votes</span> <span class="o">=</span> <span class="p">[</span><span class="n">online_pred</span><span class="p">,</span> <span class="n">ensemble_pred</span><span class="p">,</span> <span class="n">regime_pred</span><span class="p">]</span>
        <span class="n">final_pred</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="n">votes</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="k">else</span> <span class="mi">0</span>
        
        <span class="k">return</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">final_pred</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span>
    
    <span class="k">def</span> <span class="nf">update_models</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update models with new observation.&quot;&quot;&quot;</span>
        <span class="n">X_scaled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        
        <span class="c1"># Update online learner</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">online_learner</span><span class="o">.</span><span class="n">partial_fit</span><span class="p">(</span><span class="n">X_scaled</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">y</span><span class="p">]))</span>
        
        <span class="c1"># Update ensemble weights</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ensemble</span><span class="o">.</span><span class="n">update_weights</span><span class="p">(</span><span class="n">X_scaled</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">y</span><span class="p">)</span>
        
        <span class="c1"># Update regime system</span>
        <span class="n">regime</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">regime_system</span><span class="o">.</span><span class="n">detect_regime</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">regime_system</span><span class="o">.</span><span class="n">add_sample</span><span class="p">(</span><span class="n">X_scaled</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">y</span><span class="p">,</span> <span class="n">regime</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">trade</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">signal</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">price</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Execute trade based on signal.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">signal</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">position</span><span class="p">:</span>
            <span class="c1"># Close existing position</span>
            <span class="c1"># Open new position</span>
            <span class="n">cost</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">signal</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">position</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">capital</span> <span class="o">*</span> <span class="mf">0.001</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">capital</span> <span class="o">-=</span> <span class="n">cost</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="n">signal</span>
    
    <span class="k">def</span> <span class="nf">update_pnl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">price_return</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update P&amp;L based on position.&quot;&quot;&quot;</span>
        <span class="n">pnl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">capital</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">*</span> <span class="n">price_return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">capital</span> <span class="o">+=</span> <span class="n">pnl</span>
    
    <span class="k">def</span> <span class="nf">run_backtest</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">lookback</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Run backtest on historical data.&quot;&quot;&quot;</span>
        <span class="c1"># Initialize with first portion</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initialize_models</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="n">lookback</span><span class="p">])</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">equity_curve</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">initial_capital</span><span class="p">]</span>
        
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">lookback</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">current_data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="n">lookback</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
            
            <span class="c1"># Generate signal</span>
            <span class="n">signal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_signal</span><span class="p">(</span><span class="n">current_data</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">signals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">signal</span><span class="p">)</span>
            
            <span class="c1"># Record regime</span>
            <span class="n">regime</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">regime_system</span><span class="o">.</span><span class="n">detect_regime</span><span class="p">(</span><span class="n">current_data</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">regime_history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">regime</span><span class="p">)</span>
            
            <span class="c1"># Trade</span>
            <span class="n">current_price</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;close&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trade</span><span class="p">(</span><span class="n">signal</span><span class="p">,</span> <span class="n">current_price</span><span class="p">)</span>
            
            <span class="c1"># Update P&amp;L</span>
            <span class="n">next_price</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;close&#39;</span><span class="p">]</span>
            <span class="n">price_return</span> <span class="o">=</span> <span class="p">(</span><span class="n">next_price</span> <span class="o">-</span> <span class="n">current_price</span><span class="p">)</span> <span class="o">/</span> <span class="n">current_price</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_pnl</span><span class="p">(</span><span class="n">price_return</span><span class="p">)</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">equity_curve</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">capital</span><span class="p">)</span>
            
            <span class="c1"># Update models with actual outcome</span>
            <span class="n">actual</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">next_price</span> <span class="o">&gt;</span> <span class="n">current_price</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="n">features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_features</span><span class="p">(</span><span class="n">current_data</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">features</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">update_models</span><span class="p">(</span><span class="n">features</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">actual</span><span class="p">,</span> <span class="n">current_data</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_results</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">get_results</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get backtest results.&quot;&quot;&quot;</span>
        <span class="n">capitals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">equity_curve</span><span class="p">)</span>
        <span class="n">returns</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">capitals</span><span class="p">)</span> <span class="o">/</span> <span class="n">capitals</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;total_return&#39;</span><span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">capital</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_capital</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s1">&#39;sharpe_ratio&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">returns</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">returns</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1e-8</span><span class="p">),</span>
            <span class="s1">&#39;max_drawdown&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">capitals</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="o">.</span><span class="n">accumulate</span><span class="p">(</span><span class="n">capitals</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span>
            <span class="s1">&#39;equity_curve&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">equity_curve</span><span class="p">,</span>
            <span class="s1">&#39;signals&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">signals</span><span class="p">,</span>
            <span class="s1">&#39;regime_history&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">regime_history</span>
        <span class="p">}</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;AdvancedMLTradingSystem defined&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Run advanced system backtest</span>
<span class="c1"># Generate longer dataset</span>
<span class="n">full_data</span> <span class="o">=</span> <span class="n">generate_trading_data</span><span class="p">(</span><span class="mi">2000</span><span class="p">)</span>

<span class="c1"># Initialize and run system</span>
<span class="n">advanced_system</span> <span class="o">=</span> <span class="n">AdvancedMLTradingSystem</span><span class="p">(</span><span class="n">initial_capital</span><span class="o">=</span><span class="mi">100000</span><span class="p">)</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">advanced_system</span><span class="o">.</span><span class="n">run_backtest</span><span class="p">(</span><span class="n">full_data</span><span class="p">,</span> <span class="n">lookback</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Advanced ML Trading System Results&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total Return: </span><span class="si">{</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;total_return&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sharpe Ratio: </span><span class="si">{</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;sharpe_ratio&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Max Drawdown: </span><span class="si">{</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;max_drawdown&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Visualize advanced system results</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

<span class="c1"># Equity curve</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;equity_curve&#39;</span><span class="p">])</span>
<span class="n">buy_hold</span> <span class="o">=</span> <span class="mi">100000</span> <span class="o">*</span> <span class="p">(</span><span class="n">full_data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">full_data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">buy_hold</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">100</span><span class="p">:]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Buy &amp; Hold&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Step&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Capital ($)&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Advanced System vs Buy &amp; Hold&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s1">&#39;Strategy&#39;</span><span class="p">,</span> <span class="s1">&#39;Buy &amp; Hold&#39;</span><span class="p">])</span>

<span class="c1"># Drawdown</span>
<span class="n">capitals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;equity_curve&#39;</span><span class="p">])</span>
<span class="n">peak</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="o">.</span><span class="n">accumulate</span><span class="p">(</span><span class="n">capitals</span><span class="p">)</span>
<span class="n">drawdown</span> <span class="o">=</span> <span class="p">(</span><span class="n">capitals</span> <span class="o">-</span> <span class="n">peak</span><span class="p">)</span> <span class="o">/</span> <span class="n">peak</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">drawdown</span><span class="p">)),</span> <span class="n">drawdown</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Step&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Drawdown&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Drawdown&#39;</span><span class="p">)</span>

<span class="c1"># Regime distribution</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">Counter</span>
<span class="n">regime_counts</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;regime_history&#39;</span><span class="p">])</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">regime_counts</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">regime_counts</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Regime&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Count&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Regime Distribution&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>

<span class="c1"># Signal distribution</span>
<span class="n">signal_counts</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;signals&#39;</span><span class="p">])</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">bar</span><span class="p">([</span><span class="s1">&#39;Short (-1)&#39;</span><span class="p">,</span> <span class="s1">&#39;Long (1)&#39;</span><span class="p">],</span> 
               <span class="p">[</span><span class="n">signal_counts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">signal_counts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)])</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Signal&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Count&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Signal Distribution&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
<div class="md-cell"><hr />
<h2>Exercises</h2>
<p>Complete the following exercises to practice advanced ML techniques.</p></div>
<div class="md-cell exercise-header"><h3>Exercise 14.1: Implement Reward Shaping (Guided)</h3>
<p>Create a custom reward function for RL trading.</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 14.1: Implement Reward Shaping</span>
<span class="k">def</span> <span class="nf">calculate_shaped_reward</span><span class="p">(</span><span class="n">position</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">price_return</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                            <span class="n">volatility</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">drawdown</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate shaped reward for RL trading.</span>
<span class="sd">    </span>
<span class="sd">    The reward should:</span>
<span class="sd">    - Reward profitable positions</span>
<span class="sd">    - Penalize high drawdowns</span>
<span class="sd">    - Adjust for volatility (risk-adjusted)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO: Calculate base return reward</span>
    <span class="n">return_reward</span> <span class="o">=</span> <span class="n">______</span> <span class="o">*</span> <span class="n">______</span>
    
    <span class="c1"># TODO: Calculate risk-adjusted reward</span>
    <span class="n">risk_adjusted</span> <span class="o">=</span> <span class="n">return_reward</span> <span class="o">/</span> <span class="p">(</span><span class="n">______</span> <span class="o">+</span> <span class="mf">1e-8</span><span class="p">)</span>
    
    <span class="c1"># TODO: Calculate drawdown penalty</span>
    <span class="n">drawdown_penalty</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="nb">abs</span><span class="p">(</span><span class="n">______</span><span class="p">)</span> <span class="k">if</span> <span class="n">______</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">0.05</span> <span class="k">else</span> <span class="mi">0</span>
    
    <span class="c1"># TODO: Combine rewards</span>
    <span class="n">total_reward</span> <span class="o">=</span> <span class="n">______</span> <span class="o">+</span> <span class="n">______</span>
    
    <span class="k">return</span> <span class="n">total_reward</span>

<span class="c1"># Test</span>
<span class="c1"># reward = calculate_shaped_reward(1, 0.02, 0.015, -0.03)</span>
<span class="c1"># print(f&quot;Shaped reward: {reward:.4f}&quot;)</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 14.1</summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">calculate_shaped_reward</span><span class="p">(</span><span class="n">position</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">price_return</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                            <span class="n">volatility</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">drawdown</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="c1"># Calculate base return reward</span>
    <span class="n">return_reward</span> <span class="o">=</span> <span class="n">position</span> <span class="o">*</span> <span class="n">price_return</span>

    <span class="c1"># Calculate risk-adjusted reward</span>
    <span class="n">risk_adjusted</span> <span class="o">=</span> <span class="n">return_reward</span> <span class="o">/</span> <span class="p">(</span><span class="n">volatility</span> <span class="o">+</span> <span class="mf">1e-8</span><span class="p">)</span>

    <span class="c1"># Calculate drawdown penalty</span>
    <span class="n">drawdown_penalty</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="nb">abs</span><span class="p">(</span><span class="n">drawdown</span><span class="p">)</span> <span class="k">if</span> <span class="n">drawdown</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">0.05</span> <span class="k">else</span> <span class="mi">0</span>

    <span class="c1"># Combine rewards</span>
    <span class="n">total_reward</span> <span class="o">=</span> <span class="n">risk_adjusted</span> <span class="o">+</span> <span class="n">drawdown_penalty</span>

    <span class="k">return</span> <span class="n">total_reward</span>
</code></pre></div>


</details></div>
<div class="md-cell exercise-header"><h3>Exercise 14.2: Implement Online Weight Update (Guided)</h3>
<p>Create a function to update ensemble weights online.</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 14.2: Implement Online Weight Update</span>
<span class="k">def</span> <span class="nf">update_ensemble_weights</span><span class="p">(</span><span class="n">weights</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">predictions</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                             <span class="n">actual</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">learning_rate</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Update ensemble weights based on prediction accuracy.</span>
<span class="sd">    </span>
<span class="sd">    Uses exponential weighting based on accuracy.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO: Calculate which models were correct</span>
    <span class="n">correct</span> <span class="o">=</span> <span class="p">(</span><span class="n">predictions</span> <span class="o">==</span> <span class="n">______</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    
    <span class="c1"># TODO: Calculate reward/penalty for each model</span>
    <span class="n">rewards</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">correct</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">______</span><span class="p">,</span> <span class="o">-</span><span class="n">learning_rate</span><span class="p">)</span>
    
    <span class="c1"># TODO: Update weights using exponential update</span>
    <span class="n">new_weights</span> <span class="o">=</span> <span class="n">weights</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">______</span><span class="p">)</span>
    
    <span class="c1"># TODO: Normalize weights to sum to 1</span>
    <span class="n">new_weights</span> <span class="o">=</span> <span class="n">new_weights</span> <span class="o">/</span> <span class="n">new_weights</span><span class="o">.</span><span class="n">______</span><span class="p">()</span>
    
    <span class="k">return</span> <span class="n">new_weights</span>

<span class="c1"># Test</span>
<span class="c1"># weights = np.array([0.33, 0.33, 0.34])</span>
<span class="c1"># preds = np.array([1, 0, 1])</span>
<span class="c1"># new_weights = update_ensemble_weights(weights, preds, actual=1)</span>
<span class="c1"># print(f&quot;Updated weights: {new_weights}&quot;)</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 14.2</summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">update_ensemble_weights</span><span class="p">(</span><span class="n">weights</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">predictions</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                             <span class="n">actual</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">learning_rate</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="c1"># Calculate which models were correct</span>
    <span class="n">correct</span> <span class="o">=</span> <span class="p">(</span><span class="n">predictions</span> <span class="o">==</span> <span class="n">actual</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>

    <span class="c1"># Calculate reward/penalty for each model</span>
    <span class="n">rewards</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">correct</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">learning_rate</span><span class="p">,</span> <span class="o">-</span><span class="n">learning_rate</span><span class="p">)</span>

    <span class="c1"># Update weights using exponential update</span>
    <span class="n">new_weights</span> <span class="o">=</span> <span class="n">weights</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">rewards</span><span class="p">)</span>

    <span class="c1"># Normalize weights to sum to 1</span>
    <span class="n">new_weights</span> <span class="o">=</span> <span class="n">new_weights</span> <span class="o">/</span> <span class="n">new_weights</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">new_weights</span>
</code></pre></div>


</details></div>
<div class="md-cell exercise-header"><h3>Exercise 14.3: Implement Regime Detection (Guided)</h3>
<p>Create a market regime detector.</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 14.3: Implement Regime Detection</span>
<span class="k">def</span> <span class="nf">detect_market_regime</span><span class="p">(</span><span class="n">prices</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">window</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Detect current market regime.</span>
<span class="sd">    </span>
<span class="sd">    Returns: &#39;trending_up&#39;, &#39;trending_down&#39;, &#39;high_volatility&#39;, &#39;low_volatility&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">window</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;unknown&#39;</span>
    
    <span class="c1"># TODO: Calculate returns</span>
    <span class="n">returns</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">______</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span> <span class="o">/</span> <span class="n">prices</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">recent_returns</span> <span class="o">=</span> <span class="n">returns</span><span class="p">[</span><span class="o">-</span><span class="n">______</span><span class="p">:]</span>
    
    <span class="c1"># TODO: Calculate trend (average return)</span>
    <span class="n">trend</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">______</span><span class="p">(</span><span class="n">recent_returns</span><span class="p">)</span>
    
    <span class="c1"># TODO: Calculate volatility</span>
    <span class="n">volatility</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">______</span><span class="p">(</span><span class="n">recent_returns</span><span class="p">)</span>
    
    <span class="c1"># TODO: Classify regime</span>
    <span class="k">if</span> <span class="n">volatility</span> <span class="o">&gt;</span> <span class="n">______</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;high_volatility&#39;</span>
    <span class="k">elif</span> <span class="n">trend</span> <span class="o">&gt;</span> <span class="n">______</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;trending_up&#39;</span>
    <span class="k">elif</span> <span class="n">trend</span> <span class="o">&lt;</span> <span class="n">______</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;trending_down&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;low_volatility&#39;</span>

<span class="c1"># Test</span>
<span class="c1"># prices = np.array([100, 101, 102, 103, 104, 105, 106, 107, 108, 109] * 3)</span>
<span class="c1"># regime = detect_market_regime(prices)</span>
<span class="c1"># print(f&quot;Detected regime: {regime}&quot;)</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 14.3</summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">detect_market_regime</span><span class="p">(</span><span class="n">prices</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">window</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">window</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;unknown&#39;</span>

    <span class="c1"># Calculate returns</span>
    <span class="n">returns</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span> <span class="o">/</span> <span class="n">prices</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">recent_returns</span> <span class="o">=</span> <span class="n">returns</span><span class="p">[</span><span class="o">-</span><span class="n">window</span><span class="p">:]</span>

    <span class="c1"># Calculate trend (average return)</span>
    <span class="n">trend</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">recent_returns</span><span class="p">)</span>

    <span class="c1"># Calculate volatility</span>
    <span class="n">volatility</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">recent_returns</span><span class="p">)</span>

    <span class="c1"># Classify regime</span>
    <span class="k">if</span> <span class="n">volatility</span> <span class="o">&gt;</span> <span class="mf">0.02</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;high_volatility&#39;</span>
    <span class="k">elif</span> <span class="n">trend</span> <span class="o">&gt;</span> <span class="mf">0.001</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;trending_up&#39;</span>
    <span class="k">elif</span> <span class="n">trend</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">0.001</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;trending_down&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;low_volatility&#39;</span>
</code></pre></div>


</details></div>
<div class="md-cell exercise-header"><h3>Exercise 14.4: Build Experience Replay Buffer (Open-ended)</h3>
<p>Create an experience replay buffer for deep RL.</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 14.4: Build Experience Replay Buffer</span>
<span class="c1"># TODO: Create a ReplayBuffer class that:</span>
<span class="c1"># - Stores (state, action, reward, next_state, done) tuples</span>
<span class="c1"># - Has a maximum capacity</span>
<span class="c1"># - Supports random sampling for training</span>
<span class="c1"># - Implements prioritized experience replay (bonus)</span>

<span class="c1"># Your code here</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 14.4</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">ReplayBuffer</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">capacity</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">capacity</span> <span class="o">=</span> <span class="n">capacity</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">deque</span><span class="p">(</span><span class="n">maxlen</span><span class="o">=</span><span class="n">capacity</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">priorities</span> <span class="o">=</span> <span class="n">deque</span><span class="p">(</span><span class="n">maxlen</span><span class="o">=</span><span class="n">capacity</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">push</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="n">reward</span><span class="p">,</span> <span class="n">next_state</span><span class="p">,</span> <span class="n">done</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add experience to buffer.&quot;&quot;&quot;</span>
        <span class="n">experience</span> <span class="o">=</span> <span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="n">reward</span><span class="p">,</span> <span class="n">next_state</span><span class="p">,</span> <span class="n">done</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">experience</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">priorities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">priority</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">sample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Sample random batch.&quot;&quot;&quot;</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="p">),</span> 
                                   <span class="n">size</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="p">)),</span>
                                   <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">sample_prioritized</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">alpha</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.6</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Sample with priority weighting.&quot;&quot;&quot;</span>
        <span class="n">priorities</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">priorities</span><span class="p">)</span> <span class="o">**</span> <span class="n">alpha</span>
        <span class="n">probs</span> <span class="o">=</span> <span class="n">priorities</span> <span class="o">/</span> <span class="n">priorities</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

        <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="p">),</span>
                                   <span class="n">size</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="p">)),</span>
                                   <span class="n">p</span><span class="o">=</span><span class="n">probs</span><span class="p">,</span>
                                   <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">update_priority</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">priority</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update priority for an experience.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">priorities</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">priorities</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">priority</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="p">)</span>

<span class="c1"># Usage</span>
<span class="n">buffer</span> <span class="o">=</span> <span class="n">ReplayBuffer</span><span class="p">(</span><span class="n">capacity</span><span class="o">=</span><span class="mi">10000</span><span class="p">)</span>
<span class="n">buffer</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span> <span class="kc">False</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Buffer size: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell exercise-header"><h3>Exercise 14.5: Implement Bandit-Based Model Selection (Open-ended)</h3>
<p>Create a multi-armed bandit for dynamic model selection.</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 14.5: Implement Bandit-Based Model Selection</span>
<span class="c1"># TODO: Create a ModelBandit class that:</span>
<span class="c1"># - Uses UCB (Upper Confidence Bound) for model selection</span>
<span class="c1"># - Balances exploration and exploitation</span>
<span class="c1"># - Tracks performance of each model</span>
<span class="c1"># - Adapts selection based on recent performance</span>

<span class="c1"># Your code here</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 14.5</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">ModelBandit</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_models</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">exploration_param</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_models</span> <span class="o">=</span> <span class="n">n_models</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exploration_param</span> <span class="o">=</span> <span class="n">exploration_param</span>

        <span class="c1"># Track performance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_selections</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_models</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">total_rewards</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_models</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">total_rounds</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">select_model</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Select model using UCB algorithm.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">total_rounds</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># Ensure each model is tried at least once</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_models</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_selections</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">i</span>

        <span class="c1"># Calculate UCB scores</span>
        <span class="n">avg_rewards</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_rewards</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_selections</span>
        <span class="n">exploration_bonus</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exploration_param</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">total_rounds</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_selections</span>
        <span class="p">)</span>
        <span class="n">ucb_scores</span> <span class="o">=</span> <span class="n">avg_rewards</span> <span class="o">+</span> <span class="n">exploration_bonus</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">ucb_scores</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">reward</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update model statistics.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_selections</span><span class="p">[</span><span class="n">model_idx</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">total_rewards</span><span class="p">[</span><span class="n">model_idx</span><span class="p">]</span> <span class="o">+=</span> <span class="n">reward</span>

    <span class="k">def</span> <span class="nf">get_best_model</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get best performing model.&quot;&quot;&quot;</span>
        <span class="n">avg_rewards</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_rewards</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_selections</span> <span class="o">+</span> <span class="mf">1e-8</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">avg_rewards</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_model_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get statistics for all models.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
            <span class="s1">&#39;model&#39;</span><span class="p">:</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_models</span><span class="p">),</span>
            <span class="s1">&#39;n_selections&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_selections</span><span class="p">,</span>
            <span class="s1">&#39;total_rewards&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_rewards</span><span class="p">,</span>
            <span class="s1">&#39;avg_reward&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_rewards</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_selections</span> <span class="o">+</span> <span class="mf">1e-8</span><span class="p">)</span>
        <span class="p">})</span>

<span class="c1"># Usage</span>
<span class="n">bandit</span> <span class="o">=</span> <span class="n">ModelBandit</span><span class="p">(</span><span class="n">n_models</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">):</span>
    <span class="n">model_idx</span> <span class="o">=</span> <span class="n">bandit</span><span class="o">.</span><span class="n">select_model</span><span class="p">()</span>
    <span class="n">reward</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span>  <span class="c1"># Simulated reward</span>
    <span class="n">bandit</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">model_idx</span><span class="p">,</span> <span class="n">reward</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">bandit</span><span class="o">.</span><span class="n">get_model_stats</span><span class="p">())</span>
</code></pre></div>


</details></div>
<div class="md-cell exercise-header"><h3>Exercise 14.6: Create Adaptive Learning Rate Scheduler (Open-ended)</h3>
<p>Build a learning rate scheduler that adapts to market conditions.</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 14.6: Create Adaptive Learning Rate Scheduler</span>
<span class="c1"># TODO: Create a MarketAdaptiveLRScheduler class that:</span>
<span class="c1"># - Increases learning rate during high volatility</span>
<span class="c1"># - Decreases learning rate during stable periods</span>
<span class="c1"># - Has warmup period at the start</span>
<span class="c1"># - Implements learning rate bounds</span>

<span class="c1"># Your code here</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 14.6</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">MarketAdaptiveLRScheduler</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">initial_lr</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">,</span>
                 <span class="n">min_lr</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0001</span><span class="p">,</span>
                 <span class="n">max_lr</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
                 <span class="n">warmup_steps</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initial_lr</span> <span class="o">=</span> <span class="n">initial_lr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_lr</span> <span class="o">=</span> <span class="n">min_lr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_lr</span> <span class="o">=</span> <span class="n">max_lr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">warmup_steps</span> <span class="o">=</span> <span class="n">warmup_steps</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">current_lr</span> <span class="o">=</span> <span class="n">initial_lr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">step_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">volatility_history</span> <span class="o">=</span> <span class="n">deque</span><span class="p">(</span><span class="n">maxlen</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">baseline_volatility</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">volatility</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Update and return learning rate.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">step_count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">volatility_history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">volatility</span><span class="p">)</span>

        <span class="c1"># Warmup phase</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">step_count</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">warmup_steps</span><span class="p">:</span>
            <span class="n">warmup_factor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step_count</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">warmup_steps</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_lr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_lr</span> <span class="o">*</span> <span class="n">warmup_factor</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_lr</span>

        <span class="c1"># Set baseline after warmup</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">baseline_volatility</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">baseline_volatility</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">volatility_history</span><span class="p">)</span>

        <span class="c1"># Adapt based on volatility</span>
        <span class="n">current_vol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">volatility_history</span><span class="p">)[</span><span class="o">-</span><span class="mi">10</span><span class="p">:])</span>
        <span class="n">vol_ratio</span> <span class="o">=</span> <span class="n">current_vol</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">baseline_volatility</span> <span class="o">+</span> <span class="mf">1e-8</span><span class="p">)</span>

        <span class="c1"># Higher volatility -&gt; higher learning rate (faster adaptation)</span>
        <span class="k">if</span> <span class="n">vol_ratio</span> <span class="o">&gt;</span> <span class="mf">1.5</span><span class="p">:</span>  <span class="c1"># High volatility</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_lr</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_lr</span> <span class="o">*</span> <span class="mf">1.1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_lr</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">vol_ratio</span> <span class="o">&lt;</span> <span class="mf">0.7</span><span class="p">:</span>  <span class="c1"># Low volatility</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_lr</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_lr</span> <span class="o">*</span> <span class="mf">0.95</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_lr</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_lr</span>

    <span class="k">def</span> <span class="nf">get_lr</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_lr</span>

    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_lr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_lr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">step_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">volatility_history</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">baseline_volatility</span> <span class="o">=</span> <span class="kc">None</span>

<span class="c1"># Usage</span>
<span class="n">scheduler</span> <span class="o">=</span> <span class="n">MarketAdaptiveLRScheduler</span><span class="p">()</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">200</span><span class="p">):</span>
    <span class="n">vol</span> <span class="o">=</span> <span class="mf">0.01</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">100</span> <span class="k">else</span> <span class="mf">0.03</span>  <span class="c1"># Volatility spike at step 100</span>
    <span class="n">lr</span> <span class="o">=</span> <span class="n">scheduler</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">vol</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">50</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Step </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">: LR = </span><span class="si">{</span><span class="n">lr</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell key-takeaways"><hr />
<h2>Summary</h2>
<p>In this module, you learned:</p>
<ol>
<li>
<p><strong>Reinforcement Learning</strong>: Using RL to learn trading policies through interaction with market environments</p>
</li>
<li>
<p><strong>Online Learning</strong>: Continuously adapting models to new data with drift detection</p>
</li>
<li>
<p><strong>Advanced Ensembles</strong>: Dynamic weighting and stacking for improved predictions</p>
</li>
<li>
<p><strong>Meta-Learning</strong>: Learning which models work best in different market conditions</p>
</li>
<li>
<p><strong>Production Systems</strong>: Combining multiple techniques into robust trading systems</p>
</li>
</ol>
<h2>Key Takeaways</h2>
<ul>
<li>RL can discover trading strategies that supervised learning might miss</li>
<li>Online learning enables continuous adaptation without full retraining</li>
<li>Dynamic ensembles outperform static ensembles in changing markets</li>
<li>Meta-learning helps select the right model for current conditions</li>
<li>Combining multiple techniques provides the most robust results</li>
</ul>
<h2>Course Completion</h2>
<p>Congratulations! You have completed the Machine Learning for Financial Markets course. You now have a comprehensive understanding of applying ML techniques to trading and investment problems.</p></div>
        <div class="nav-buttons">
            <button class="nav-btn prev-btn disabled" type="button">
                <span class="nav-btn-label">‚Üê Previous</span>
                <span class="nav-btn-name"></span>
            </button>
            <button class="nav-btn next-btn disabled" type="button">
                <span class="nav-btn-label">Next ‚Üí</span>
                <span class="nav-btn-name"></span>
            </button>
        </div>
        </div>
<div class="module-section" data-idx="15"><div class="md-cell module-header"><h1>Capstone Project: End-to-End ML Trading System</h1>
<h2>Project Overview</h2>
<p>In this capstone project, you will build a complete machine learning trading system from scratch. This project integrates all concepts from the course including data preprocessing, feature engineering, model selection, backtesting, and production deployment.</p>
<h2>Learning Objectives</h2>
<p>By completing this project, you will demonstrate:
- Comprehensive feature engineering for financial data
- Multiple ML model implementation and comparison
- Proper walk-forward backtesting methodology
- Production-ready system architecture
- Performance analysis and risk management</p>
<h2>Project Requirements</h2>
<p>Build a trading system that:
1. Processes raw market data into ML-ready features
2. Trains and evaluates multiple model types
3. Implements proper walk-forward validation
4. Includes realistic transaction costs
5. Provides comprehensive performance analysis
6. Is designed for production deployment</p>
<h2>Estimated Time: 6-8 hours</h2></div>
<div class="md-cell"><hr />
<h2>Part 1: Setup and Data Generation</h2>
<p>Set up the project environment and generate realistic market data.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Import all required libraries</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">deque</span>
<span class="kn">from</span> <span class="nn">abc</span> <span class="kn">import</span> <span class="n">ABC</span><span class="p">,</span> <span class="n">abstractmethod</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>

<span class="c1"># ML libraries</span>
<span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">RandomForestClassifier</span><span class="p">,</span> <span class="n">GradientBoostingClassifier</span>
<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LogisticRegression</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">StandardScaler</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">accuracy_score</span><span class="p">,</span> <span class="n">precision_score</span><span class="p">,</span> <span class="n">recall_score</span><span class="p">,</span> <span class="n">f1_score</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">confusion_matrix</span><span class="p">,</span> <span class="n">classification_report</span>

<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;All libraries loaded successfully&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Project started: </span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Generate comprehensive market data</span>
<span class="k">def</span> <span class="nf">generate_market_data</span><span class="p">(</span><span class="n">n_days</span><span class="o">=</span><span class="mi">2500</span><span class="p">,</span> <span class="n">n_assets</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate realistic multi-asset market data with:</span>
<span class="sd">    - Regime switching</span>
<span class="sd">    - Volatility clustering</span>
<span class="sd">    - Cross-asset correlations</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
    
    <span class="n">dates</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="s1">&#39;2015-01-01&#39;</span><span class="p">,</span> <span class="n">periods</span><span class="o">=</span><span class="n">n_days</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;D&#39;</span><span class="p">)</span>
    
    <span class="c1"># Create regime series</span>
    <span class="n">regime</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_days</span><span class="p">)</span>
    <span class="n">current_regime</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_days</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mf">0.005</span><span class="p">:</span>  <span class="c1"># 0.5% chance to switch</span>
            <span class="n">current_regime</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">current_regime</span>
        <span class="n">regime</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_regime</span>
    
    <span class="n">assets</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">asset_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;STOCK_A&#39;</span><span class="p">,</span> <span class="s1">&#39;STOCK_B&#39;</span><span class="p">,</span> <span class="s1">&#39;STOCK_C&#39;</span><span class="p">][:</span><span class="n">n_assets</span><span class="p">]</span>
    
    <span class="c1"># Correlation matrix</span>
    <span class="n">correlation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
        <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">],</span>
        <span class="p">[</span><span class="mf">0.6</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">],</span>
        <span class="p">[</span><span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]</span>
    <span class="p">])[:</span><span class="n">n_assets</span><span class="p">,</span> <span class="p">:</span><span class="n">n_assets</span><span class="p">]</span>
    
    <span class="c1"># Generate correlated returns</span>
    <span class="n">L</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">cholesky</span><span class="p">(</span><span class="n">correlation</span><span class="p">)</span>
    <span class="n">uncorr_returns</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">n_days</span><span class="p">,</span> <span class="n">n_assets</span><span class="p">))</span>
    <span class="n">corr_returns</span> <span class="o">=</span> <span class="n">uncorr_returns</span> <span class="o">@</span> <span class="n">L</span><span class="o">.</span><span class="n">T</span>
    
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">asset</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">asset_names</span><span class="p">):</span>
        <span class="c1"># Base parameters vary by regime</span>
        <span class="n">base_return</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">regime</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.0004</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0001</span><span class="p">)</span>
        <span class="n">base_vol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">regime</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.012</span><span class="p">,</span> <span class="mf">0.020</span><span class="p">)</span>
        
        <span class="c1"># Apply volatility clustering</span>
        <span class="n">volatility</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_days</span><span class="p">)</span>
        <span class="n">volatility</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">base_vol</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_days</span><span class="p">):</span>
            <span class="n">volatility</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.9</span> <span class="o">*</span> <span class="n">volatility</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">base_vol</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        
        <span class="c1"># Generate returns</span>
        <span class="n">returns</span> <span class="o">=</span> <span class="n">base_return</span> <span class="o">+</span> <span class="n">volatility</span> <span class="o">*</span> <span class="n">corr_returns</span><span class="p">[:,</span> <span class="n">idx</span><span class="p">]</span>
        
        <span class="c1"># Generate prices</span>
        <span class="n">prices</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">returns</span><span class="p">))</span>
        
        <span class="c1"># Create OHLCV</span>
        <span class="n">daily_range</span> <span class="o">=</span> <span class="n">volatility</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">,</span> <span class="n">n_days</span><span class="p">)</span>
        
        <span class="n">assets</span><span class="p">[</span><span class="n">asset</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
            <span class="s1">&#39;date&#39;</span><span class="p">:</span> <span class="n">dates</span><span class="p">,</span>
            <span class="s1">&#39;open&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">prices</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="s1">&#39;high&#39;</span><span class="p">:</span> <span class="n">prices</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">daily_range</span><span class="p">),</span>
            <span class="s1">&#39;low&#39;</span><span class="p">:</span> <span class="n">prices</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">daily_range</span><span class="p">),</span>
            <span class="s1">&#39;close&#39;</span><span class="p">:</span> <span class="n">prices</span><span class="p">,</span>
            <span class="s1">&#39;volume&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">lognormal</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">n_days</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">regime</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">),</span>
            <span class="s1">&#39;regime&#39;</span><span class="p">:</span> <span class="n">regime</span>
        <span class="p">})</span>
        <span class="n">assets</span><span class="p">[</span><span class="n">asset</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;open&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">assets</span><span class="p">[</span><span class="n">asset</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;close&#39;</span><span class="p">]</span>
        <span class="n">assets</span><span class="p">[</span><span class="n">asset</span><span class="p">]</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">assets</span>

<span class="c1"># Generate data</span>
<span class="n">market_data</span> <span class="o">=</span> <span class="n">generate_market_data</span><span class="p">(</span><span class="n">n_days</span><span class="o">=</span><span class="mi">2500</span><span class="p">,</span> <span class="n">n_assets</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generated data for </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">market_data</span><span class="p">)</span><span class="si">}</span><span class="s2"> assets&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">asset</span><span class="p">,</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">market_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">asset</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="si">}</span><span class="s2"> days from </span><span class="si">{</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">date</span><span class="p">()</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">date</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Visualize market data</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

<span class="c1"># Price series</span>
<span class="k">for</span> <span class="n">asset</span><span class="p">,</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">market_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="n">asset</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Price&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Asset Prices&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="c1"># Returns distribution</span>
<span class="k">for</span> <span class="n">asset</span><span class="p">,</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">market_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">returns</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">returns</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">asset</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Daily Return&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Frequency&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Return Distributions&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="c1"># Regime over time (first asset)</span>
<span class="n">first_asset</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">market_data</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">market_data</span><span class="p">[</span><span class="n">first_asset</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> 
                        <span class="n">market_data</span><span class="p">[</span><span class="n">first_asset</span><span class="p">][</span><span class="s1">&#39;regime&#39;</span><span class="p">],</span> 
                        <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Regime&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Market Regime (0=Bull, 1=Bear)&#39;</span><span class="p">)</span>

<span class="c1"># Rolling volatility</span>
<span class="k">for</span> <span class="n">asset</span><span class="p">,</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">market_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">returns</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span>
    <span class="n">rolling_vol</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">rolling_vol</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">asset</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Annualized Volatility&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Rolling 20-Day Volatility&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
<div class="md-cell"><hr />
<h2>Part 2: Feature Engineering Pipeline</h2>
<p>Build a comprehensive feature engineering pipeline.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Feature Engineering Class</span>
<span class="k">class</span> <span class="nc">FeatureEngineer</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Comprehensive feature engineering for trading.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_names</span> <span class="o">=</span> <span class="p">[]</span>
        
    <span class="k">def</span> <span class="nf">create_price_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Create price-based features.&quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        
        <span class="c1"># Returns at multiple horizons</span>
        <span class="k">for</span> <span class="n">period</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">]:</span>
            <span class="n">data</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;return_</span><span class="si">{</span><span class="n">period</span><span class="si">}</span><span class="s1">d&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">(</span><span class="n">period</span><span class="p">)</span>
        
        <span class="c1"># Log returns</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;log_return_1d&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
        
        <span class="c1"># Price momentum</span>
        <span class="k">for</span> <span class="n">period</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">50</span><span class="p">]:</span>
            <span class="n">data</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;momentum_</span><span class="si">{</span><span class="n">period</span><span class="si">}</span><span class="s1">d&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="n">period</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        
        <span class="k">return</span> <span class="n">data</span>
    
    <span class="k">def</span> <span class="nf">create_volatility_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Create volatility-based features.&quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">returns</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span>
        
        <span class="c1"># Rolling volatility</span>
        <span class="k">for</span> <span class="n">period</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">50</span><span class="p">]:</span>
            <span class="n">data</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;volatility_</span><span class="si">{</span><span class="n">period</span><span class="si">}</span><span class="s1">d&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">period</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
        
        <span class="c1"># Volatility ratio</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;volatility_ratio&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;volatility_5d&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;volatility_20d&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mf">1e-10</span><span class="p">)</span>
        
        <span class="c1"># Parkinson volatility (using high/low)</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;parkinson_vol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
            <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">)))</span> <span class="o">*</span> 
            <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;high&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;low&#39;</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="p">)</span>
        
        <span class="c1"># Average True Range</span>
        <span class="n">high_low</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;high&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;low&#39;</span><span class="p">]</span>
        <span class="n">high_close</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;high&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">low_close</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;low&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">tr</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">high_low</span><span class="p">,</span> <span class="n">high_close</span><span class="p">,</span> <span class="n">low_close</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;atr_14&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tr</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">14</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;atr_normalized&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;atr_14&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span>
        
        <span class="k">return</span> <span class="n">data</span>
    
    <span class="k">def</span> <span class="nf">create_technical_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Create technical indicator features.&quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        
        <span class="c1"># Moving averages</span>
        <span class="k">for</span> <span class="n">period</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">200</span><span class="p">]:</span>
            <span class="n">data</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;sma_</span><span class="si">{</span><span class="n">period</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">period</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="n">data</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;ema_</span><span class="si">{</span><span class="n">period</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">ewm</span><span class="p">(</span><span class="n">span</span><span class="o">=</span><span class="n">period</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="n">data</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;price_to_sma_</span><span class="si">{</span><span class="n">period</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">data</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;sma_</span><span class="si">{</span><span class="n">period</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span>
        
        <span class="c1"># MACD</span>
        <span class="n">exp12</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">ewm</span><span class="p">(</span><span class="n">span</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">exp26</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">ewm</span><span class="p">(</span><span class="n">span</span><span class="o">=</span><span class="mi">26</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;macd&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">exp12</span> <span class="o">-</span> <span class="n">exp26</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;macd_signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;macd&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">ewm</span><span class="p">(</span><span class="n">span</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;macd_hist&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;macd&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;macd_signal&#39;</span><span class="p">]</span>
        
        <span class="c1"># RSI</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span>
        <span class="n">gain</span> <span class="o">=</span> <span class="p">(</span><span class="n">delta</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">delta</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">14</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">delta</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">delta</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">14</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">rs</span> <span class="o">=</span> <span class="n">gain</span> <span class="o">/</span> <span class="p">(</span><span class="n">loss</span> <span class="o">+</span> <span class="mf">1e-10</span><span class="p">)</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;rsi_14&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">-</span> <span class="p">(</span><span class="mi">100</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">rs</span><span class="p">))</span>
        
        <span class="c1"># Stochastic Oscillator</span>
        <span class="n">low_14</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;low&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">14</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="n">high_14</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;high&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">14</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;stoch_k&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">low_14</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">high_14</span> <span class="o">-</span> <span class="n">low_14</span> <span class="o">+</span> <span class="mf">1e-10</span><span class="p">)</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;stoch_d&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;stoch_k&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        
        <span class="c1"># Bollinger Bands</span>
        <span class="n">bb_sma</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">bb_std</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;bb_upper&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bb_sma</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">bb_std</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;bb_lower&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bb_sma</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">bb_std</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;bb_width&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;bb_upper&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;bb_lower&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="n">bb_sma</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;bb_position&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;bb_lower&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;bb_upper&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;bb_lower&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mf">1e-10</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">data</span>
    
    <span class="k">def</span> <span class="nf">create_volume_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Create volume-based features.&quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        
        <span class="c1"># Volume moving averages</span>
        <span class="k">for</span> <span class="n">period</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">]:</span>
            <span class="n">data</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;volume_sma_</span><span class="si">{</span><span class="n">period</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;volume&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">period</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        
        <span class="c1"># Volume ratio</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;volume_ratio&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;volume&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;volume_sma_20&#39;</span><span class="p">]</span>
        
        <span class="c1"># On-Balance Volume (OBV)</span>
        <span class="n">obv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;volume&#39;</span><span class="p">],</span>
                       <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="o">-</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;volume&#39;</span><span class="p">],</span> <span class="mi">0</span><span class="p">))</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;obv&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">obv</span><span class="p">)</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;obv_sma&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;obv&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>
        
        <span class="c1"># Volume-Price Trend</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;vpt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;volume&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">())</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>
        
        <span class="k">return</span> <span class="n">data</span>
    
    <span class="k">def</span> <span class="nf">create_all_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Create all features.&quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_price_features</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_volatility_features</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_technical_features</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_volume_features</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        
        <span class="c1"># Create target (next day direction)</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;target_return&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        
        <span class="c1"># Store feature names</span>
        <span class="n">exclude_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;open&#39;</span><span class="p">,</span> <span class="s1">&#39;high&#39;</span><span class="p">,</span> <span class="s1">&#39;low&#39;</span><span class="p">,</span> <span class="s1">&#39;close&#39;</span><span class="p">,</span> <span class="s1">&#39;volume&#39;</span><span class="p">,</span> <span class="s1">&#39;regime&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;target&#39;</span><span class="p">,</span> <span class="s1">&#39;target_return&#39;</span><span class="p">]</span> <span class="o">+</span> \
                       <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="s1">&#39;sma_&#39;</span> <span class="ow">in</span> <span class="n">c</span> <span class="ow">and</span> <span class="s1">&#39;price_to&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">c</span><span class="p">]</span> <span class="o">+</span> \
                       <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="s1">&#39;ema_&#39;</span> <span class="ow">in</span> <span class="n">c</span><span class="p">]</span> <span class="o">+</span> \
                       <span class="p">[</span><span class="s1">&#39;bb_upper&#39;</span><span class="p">,</span> <span class="s1">&#39;bb_lower&#39;</span><span class="p">,</span> <span class="s1">&#39;volume_sma_5&#39;</span><span class="p">,</span> <span class="s1">&#39;volume_sma_10&#39;</span><span class="p">,</span> 
                        <span class="s1">&#39;volume_sma_20&#39;</span><span class="p">,</span> <span class="s1">&#39;obv&#39;</span><span class="p">,</span> <span class="s1">&#39;obv_sma&#39;</span><span class="p">,</span> <span class="s1">&#39;vpt&#39;</span><span class="p">]</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">exclude_cols</span><span class="p">]</span>
        
        <span class="k">return</span> <span class="n">data</span>
    
    <span class="k">def</span> <span class="nf">get_feature_names</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Get list of feature names.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_names</span>

<span class="c1"># Create features for primary asset</span>
<span class="n">feature_engineer</span> <span class="o">=</span> <span class="n">FeatureEngineer</span><span class="p">()</span>
<span class="n">primary_asset</span> <span class="o">=</span> <span class="s1">&#39;STOCK_A&#39;</span>
<span class="n">df_features</span> <span class="o">=</span> <span class="n">feature_engineer</span><span class="o">.</span><span class="n">create_all_features</span><span class="p">(</span><span class="n">market_data</span><span class="p">[</span><span class="n">primary_asset</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Created </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">feature_engineer</span><span class="o">.</span><span class="n">get_feature_names</span><span class="p">())</span><span class="si">}</span><span class="s2"> features:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">feature_engineer</span><span class="o">.</span><span class="n">get_feature_names</span><span class="p">()):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">. </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># TODO: Complete the feature correlation analysis</span>
<span class="c1"># Analyze feature correlations and select the most important features</span>

<span class="k">def</span> <span class="nf">analyze_feature_importance</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">feature_names</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> 
                                <span class="n">target_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;target&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Analyze feature importance and correlation with target.</span>
<span class="sd">    </span>
<span class="sd">    Returns DataFrame with:</span>
<span class="sd">    - Feature correlations with target</span>
<span class="sd">    - Feature correlations with each other (to detect multicollinearity)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># YOUR CODE HERE</span>
    <span class="c1"># 1. Calculate correlation of each feature with target</span>
    <span class="c1"># 2. Identify highly correlated feature pairs</span>
    <span class="c1"># 3. Return sorted importance scores</span>
    
    <span class="n">valid_data</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">feature_names</span> <span class="o">+</span> <span class="p">[</span><span class="n">target_col</span><span class="p">]]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
    
    <span class="c1"># Calculate correlations with target</span>
    <span class="n">target_corr</span> <span class="o">=</span> <span class="n">valid_data</span><span class="p">[</span><span class="n">feature_names</span><span class="p">]</span><span class="o">.</span><span class="n">corrwith</span><span class="p">(</span><span class="n">valid_data</span><span class="p">[</span><span class="n">target_col</span><span class="p">])</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span>
    
    <span class="c1"># Create importance DataFrame</span>
    <span class="n">importance</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
        <span class="s1">&#39;feature&#39;</span><span class="p">:</span> <span class="n">feature_names</span><span class="p">,</span>
        <span class="s1">&#39;target_correlation&#39;</span><span class="p">:</span> <span class="n">target_corr</span><span class="o">.</span><span class="n">values</span>
    <span class="p">})</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;target_correlation&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">importance</span>

<span class="c1"># Analyze features</span>
<span class="n">feature_importance</span> <span class="o">=</span> <span class="n">analyze_feature_importance</span><span class="p">(</span>
    <span class="n">df_features</span><span class="p">,</span> <span class="n">feature_engineer</span><span class="o">.</span><span class="n">get_feature_names</span><span class="p">()</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Top 15 Features by Target Correlation:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">feature_importance</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
</code></pre></div>
<div class="md-cell"><hr />
<h2>Part 3: Model Training and Selection</h2>
<p>Train multiple models and select the best one.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Model Training Framework</span>
<span class="k">class</span> <span class="nc">ModelTrainer</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Framework for training and comparing models.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feature_names</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_names</span> <span class="o">=</span> <span class="n">feature_names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">models</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
        
    <span class="k">def</span> <span class="nf">prepare_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">target_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;target&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Prepare data for training.&quot;&quot;&quot;</span>
        <span class="c1"># Get features and target</span>
        <span class="n">valid_mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">feature_names</span> <span class="o">+</span> <span class="p">[</span><span class="n">target_col</span><span class="p">]]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">valid_data</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        
        <span class="n">X</span> <span class="o">=</span> <span class="n">valid_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">feature_names</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">valid_data</span><span class="p">[</span><span class="n">target_col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">dates</span> <span class="o">=</span> <span class="n">valid_data</span><span class="o">.</span><span class="n">index</span>
        
        <span class="k">return</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">dates</span>
    
    <span class="k">def</span> <span class="nf">train_test_split</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> 
                          <span class="n">dates</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DatetimeIndex</span><span class="p">,</span> <span class="n">train_ratio</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.7</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Time-based train/test split.&quot;&quot;&quot;</span>
        <span class="n">split_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span> <span class="o">*</span> <span class="n">train_ratio</span><span class="p">)</span>
        
        <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span> <span class="o">=</span> <span class="n">X</span><span class="p">[:</span><span class="n">split_idx</span><span class="p">],</span> <span class="n">X</span><span class="p">[</span><span class="n">split_idx</span><span class="p">:]</span>
        <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">y</span><span class="p">[:</span><span class="n">split_idx</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">split_idx</span><span class="p">:]</span>
        <span class="n">dates_train</span><span class="p">,</span> <span class="n">dates_test</span> <span class="o">=</span> <span class="n">dates</span><span class="p">[:</span><span class="n">split_idx</span><span class="p">],</span> <span class="n">dates</span><span class="p">[</span><span class="n">split_idx</span><span class="p">:]</span>
        
        <span class="c1"># Scale features</span>
        <span class="n">X_train_scaled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
        <span class="n">X_test_scaled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="p">(</span><span class="n">X_train_scaled</span><span class="p">,</span> <span class="n">X_test_scaled</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> 
                <span class="n">dates_train</span><span class="p">,</span> <span class="n">dates_test</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">train_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">X_train</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> 
                    <span class="n">y_train</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Train a model.&quot;&quot;&quot;</span>
        <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span>
        <span class="k">return</span> <span class="n">model</span>
    
    <span class="k">def</span> <span class="nf">evaluate_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">X_test</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> 
                       <span class="n">y_test</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Evaluate a trained model.&quot;&quot;&quot;</span>
        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="n">predictions</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
        
        <span class="n">results</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;accuracy&#39;</span><span class="p">:</span> <span class="n">accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">predictions</span><span class="p">),</span>
            <span class="s1">&#39;precision&#39;</span><span class="p">:</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">predictions</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
            <span class="s1">&#39;recall&#39;</span><span class="p">:</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">predictions</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
            <span class="s1">&#39;f1&#39;</span><span class="p">:</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">predictions</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
            <span class="s1">&#39;predictions&#39;</span><span class="p">:</span> <span class="n">predictions</span>
        <span class="p">}</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">results</span>
        <span class="k">return</span> <span class="n">results</span>
    
    <span class="k">def</span> <span class="nf">compare_models</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Compare all trained models.&quot;&quot;&quot;</span>
        <span class="n">comparison</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">results</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">comparison</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;model&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                <span class="s1">&#39;accuracy&#39;</span><span class="p">:</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">],</span>
                <span class="s1">&#39;precision&#39;</span><span class="p">:</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span><span class="p">],</span>
                <span class="s1">&#39;recall&#39;</span><span class="p">:</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;recall&#39;</span><span class="p">],</span>
                <span class="s1">&#39;f1&#39;</span><span class="p">:</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span>
            <span class="p">})</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">comparison</span><span class="p">)</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;f1&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ModelTrainer class defined&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># TODO: Train and compare multiple models</span>

<span class="c1"># Select top features</span>
<span class="n">top_features</span> <span class="o">=</span> <span class="n">feature_importance</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">20</span><span class="p">)[</span><span class="s1">&#39;feature&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

<span class="c1"># Initialize trainer</span>
<span class="n">trainer</span> <span class="o">=</span> <span class="n">ModelTrainer</span><span class="p">(</span><span class="n">top_features</span><span class="p">)</span>

<span class="c1"># Prepare data</span>
<span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">dates</span> <span class="o">=</span> <span class="n">trainer</span><span class="o">.</span><span class="n">prepare_data</span><span class="p">(</span><span class="n">df_features</span><span class="p">)</span>

<span class="c1"># Split data</span>
<span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> 
 <span class="n">dates_train</span><span class="p">,</span> <span class="n">dates_test</span><span class="p">)</span> <span class="o">=</span> <span class="n">trainer</span><span class="o">.</span><span class="n">train_test_split</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">dates</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Training set: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span><span class="si">}</span><span class="s2"> samples&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Test set: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span><span class="si">}</span><span class="s2"> samples&quot;</span><span class="p">)</span>

<span class="c1"># Define models to train</span>
<span class="n">models_to_train</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;Logistic Regression&#39;</span><span class="p">:</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">),</span>
    <span class="s1">&#39;Random Forest&#39;</span><span class="p">:</span> <span class="n">RandomForestClassifier</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">),</span>
    <span class="s1">&#39;Gradient Boosting&#39;</span><span class="p">:</span> <span class="n">GradientBoostingClassifier</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1"># Train and evaluate models</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Training models...&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">models_to_train</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Training </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
    <span class="n">trainer</span><span class="o">.</span><span class="n">train_model</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">trainer</span><span class="o">.</span><span class="n">evaluate_model</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Accuracy: </span><span class="si">{</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, F1: </span><span class="si">{</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Compare models</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Model Comparison:&quot;</span><span class="p">)</span>
<span class="n">comparison</span> <span class="o">=</span> <span class="n">trainer</span><span class="o">.</span><span class="n">compare_models</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">comparison</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
</code></pre></div>
<div class="md-cell"><hr />
<h2>Part 4: Walk-Forward Backtesting</h2>
<p>Implement proper walk-forward validation.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Walk-Forward Backtester</span>
<span class="k">class</span> <span class="nc">WalkForwardBacktester</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Walk-forward backtesting with realistic assumptions.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">feature_names</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                 <span class="n">train_window</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">252</span><span class="p">,</span> <span class="n">test_window</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">21</span><span class="p">,</span>
                 <span class="n">step_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">21</span><span class="p">,</span> <span class="n">commission</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.001</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_names</span> <span class="o">=</span> <span class="n">feature_names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_window</span> <span class="o">=</span> <span class="n">train_window</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_window</span> <span class="o">=</span> <span class="n">test_window</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">step_size</span> <span class="o">=</span> <span class="n">step_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">commission</span> <span class="o">=</span> <span class="n">commission</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">fold_results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">all_predictions</span> <span class="o">=</span> <span class="kc">None</span>
        
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Run walk-forward backtest.&quot;&quot;&quot;</span>
        <span class="c1"># Prepare data</span>
        <span class="n">valid_mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">feature_names</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        
        <span class="n">X</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">feature_names</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        
        <span class="n">n_samples</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="n">predictions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">n_samples</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="n">probabilities</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">n_samples</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        
        <span class="n">start_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_window</span>
        <span class="n">fold</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="k">while</span> <span class="n">start_idx</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_window</span> <span class="o">&lt;=</span> <span class="n">n_samples</span><span class="p">:</span>
            <span class="c1"># Define windows</span>
            <span class="n">train_start</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">start_idx</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_window</span><span class="p">)</span>
            <span class="n">train_end</span> <span class="o">=</span> <span class="n">start_idx</span>
            <span class="n">test_start</span> <span class="o">=</span> <span class="n">start_idx</span>
            <span class="n">test_end</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">start_idx</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_window</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">)</span>
            
            <span class="c1"># Get data</span>
            <span class="n">X_train</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">train_start</span><span class="p">:</span><span class="n">train_end</span><span class="p">]</span>
            <span class="n">y_train</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">train_start</span><span class="p">:</span><span class="n">train_end</span><span class="p">]</span>
            <span class="n">X_test</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">test_start</span><span class="p">:</span><span class="n">test_end</span><span class="p">]</span>
            <span class="n">y_test</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">test_start</span><span class="p">:</span><span class="n">test_end</span><span class="p">]</span>
            
            <span class="c1"># Scale</span>
            <span class="n">X_train_scaled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
            <span class="n">X_test_scaled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
            
            <span class="c1"># Train</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_scaled</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
            
            <span class="c1"># Predict</span>
            <span class="n">pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test_scaled</span><span class="p">)</span>
            <span class="n">prob</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test_scaled</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">]</span>
            
            <span class="n">predictions</span><span class="p">[</span><span class="n">test_start</span><span class="p">:</span><span class="n">test_end</span><span class="p">]</span> <span class="o">=</span> <span class="n">pred</span>
            <span class="n">probabilities</span><span class="p">[</span><span class="n">test_start</span><span class="p">:</span><span class="n">test_end</span><span class="p">]</span> <span class="o">=</span> <span class="n">prob</span>
            
            <span class="c1"># Record fold results</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fold_results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;fold&#39;</span><span class="p">:</span> <span class="n">fold</span><span class="p">,</span>
                <span class="s1">&#39;train_start&#39;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">train_start</span><span class="p">],</span>
                <span class="s1">&#39;test_start&#39;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">test_start</span><span class="p">],</span>
                <span class="s1">&#39;test_end&#39;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">test_end</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                <span class="s1">&#39;accuracy&#39;</span><span class="p">:</span> <span class="n">accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">pred</span><span class="p">)</span>
            <span class="p">})</span>
            
            <span class="n">fold</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">start_idx</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step_size</span>
        
        <span class="c1"># Store results</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;prediction&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">predictions</span>
        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;probability&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">probabilities</span>
        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">predictions</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">all_predictions</span> <span class="o">=</span> <span class="n">results</span>
        <span class="k">return</span> <span class="n">results</span>
    
    <span class="k">def</span> <span class="nf">calculate_backtest_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">initial_capital</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">100000</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate backtest performance metrics.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_predictions</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Run backtest first&quot;</span><span class="p">)</span>
        
        <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_predictions</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        
        <span class="c1"># Calculate strategy returns</span>
        <span class="n">position</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">returns</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;target_return&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        
        <span class="c1"># Account for position changes (transaction costs)</span>
        <span class="n">position_changes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([[</span><span class="mi">0</span><span class="p">],</span> <span class="n">position</span><span class="p">])))</span>
        <span class="n">costs</span> <span class="o">=</span> <span class="n">position_changes</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">commission</span>
        
        <span class="c1"># Strategy returns</span>
        <span class="n">strategy_returns</span> <span class="o">=</span> <span class="n">position</span> <span class="o">*</span> <span class="n">returns</span> <span class="o">-</span> <span class="n">costs</span>
        
        <span class="c1"># Calculate metrics</span>
        <span class="n">cumulative_returns</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">strategy_returns</span><span class="p">)</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span>
        
        <span class="n">total_return</span> <span class="o">=</span> <span class="n">cumulative_returns</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cumulative_returns</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="n">sharpe</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">strategy_returns</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">strategy_returns</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1e-8</span><span class="p">)</span>
        
        <span class="c1"># Max drawdown</span>
        <span class="n">peak</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="o">.</span><span class="n">accumulate</span><span class="p">(</span><span class="n">cumulative_returns</span><span class="p">)</span>
        <span class="n">drawdown</span> <span class="o">=</span> <span class="p">(</span><span class="n">cumulative_returns</span> <span class="o">-</span> <span class="n">peak</span><span class="p">)</span> <span class="o">/</span> <span class="n">peak</span>
        <span class="n">max_drawdown</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">drawdown</span><span class="p">)</span>
        
        <span class="c1"># Win rate</span>
        <span class="n">win_rate</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">strategy_returns</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
        
        <span class="c1"># Trade statistics</span>
        <span class="n">n_trades</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">position_changes</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">total_costs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">costs</span><span class="p">)</span> <span class="o">*</span> <span class="n">initial_capital</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;total_return&#39;</span><span class="p">:</span> <span class="n">total_return</span><span class="p">,</span>
            <span class="s1">&#39;sharpe_ratio&#39;</span><span class="p">:</span> <span class="n">sharpe</span><span class="p">,</span>
            <span class="s1">&#39;max_drawdown&#39;</span><span class="p">:</span> <span class="n">max_drawdown</span><span class="p">,</span>
            <span class="s1">&#39;win_rate&#39;</span><span class="p">:</span> <span class="n">win_rate</span><span class="p">,</span>
            <span class="s1">&#39;n_trades&#39;</span><span class="p">:</span> <span class="n">n_trades</span><span class="p">,</span>
            <span class="s1">&#39;total_costs&#39;</span><span class="p">:</span> <span class="n">total_costs</span><span class="p">,</span>
            <span class="s1">&#39;avg_fold_accuracy&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fold_results</span><span class="p">]),</span>
            <span class="s1">&#39;cumulative_returns&#39;</span><span class="p">:</span> <span class="n">cumulative_returns</span><span class="p">,</span>
            <span class="s1">&#39;strategy_returns&#39;</span><span class="p">:</span> <span class="n">strategy_returns</span>
        <span class="p">}</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;WalkForwardBacktester class defined&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># TODO: Run walk-forward backtest</span>

<span class="c1"># Select best model from comparison</span>
<span class="n">best_model_name</span> <span class="o">=</span> <span class="n">comparison</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;model&#39;</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using best model: </span><span class="si">{</span><span class="n">best_model_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Create fresh model instance</span>
<span class="k">if</span> <span class="s1">&#39;Random Forest&#39;</span> <span class="ow">in</span> <span class="n">best_model_name</span><span class="p">:</span>
    <span class="n">backtest_model</span> <span class="o">=</span> <span class="n">RandomForestClassifier</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
<span class="k">elif</span> <span class="s1">&#39;Gradient Boosting&#39;</span> <span class="ow">in</span> <span class="n">best_model_name</span><span class="p">:</span>
    <span class="n">backtest_model</span> <span class="o">=</span> <span class="n">GradientBoostingClassifier</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">backtest_model</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>

<span class="c1"># Initialize backtester</span>
<span class="n">backtester</span> <span class="o">=</span> <span class="n">WalkForwardBacktester</span><span class="p">(</span>
    <span class="n">model</span><span class="o">=</span><span class="n">backtest_model</span><span class="p">,</span>
    <span class="n">feature_names</span><span class="o">=</span><span class="n">top_features</span><span class="p">,</span>
    <span class="n">train_window</span><span class="o">=</span><span class="mi">252</span><span class="p">,</span>
    <span class="n">test_window</span><span class="o">=</span><span class="mi">21</span><span class="p">,</span>
    <span class="n">step_size</span><span class="o">=</span><span class="mi">21</span><span class="p">,</span>
    <span class="n">commission</span><span class="o">=</span><span class="mf">0.001</span>
<span class="p">)</span>

<span class="c1"># Run backtest</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Running walk-forward backtest...&quot;</span><span class="p">)</span>
<span class="n">backtest_results</span> <span class="o">=</span> <span class="n">backtester</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">df_features</span><span class="p">)</span>

<span class="c1"># Calculate metrics</span>
<span class="n">metrics</span> <span class="o">=</span> <span class="n">backtester</span><span class="o">.</span><span class="n">calculate_backtest_metrics</span><span class="p">(</span><span class="n">initial_capital</span><span class="o">=</span><span class="mi">100000</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;WALK-FORWARD BACKTEST RESULTS&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total Return: </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;total_return&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sharpe Ratio: </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;sharpe_ratio&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Max Drawdown: </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;max_drawdown&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Win Rate: </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;win_rate&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of Trades: </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;n_trades&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total Costs: $</span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;total_costs&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">,.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Average Fold Accuracy: </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;avg_fold_accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Visualize backtest results</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

<span class="c1"># Cumulative returns</span>
<span class="n">valid_results</span> <span class="o">=</span> <span class="n">backtest_results</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">])</span>
<span class="n">strategy_cum</span> <span class="o">=</span> <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;cumulative_returns&#39;</span><span class="p">]</span>
<span class="n">buy_hold_cum</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">valid_results</span><span class="p">[</span><span class="s1">&#39;target_return&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">strategy_cum</span><span class="p">)),</span> <span class="n">strategy_cum</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Strategy&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">buy_hold_cum</span><span class="p">)),</span> <span class="n">buy_hold_cum</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Buy &amp; Hold&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Trading Days&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Cumulative Return&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Strategy vs Buy &amp; Hold&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="c1"># Drawdown</span>
<span class="n">peak</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="o">.</span><span class="n">accumulate</span><span class="p">(</span><span class="n">strategy_cum</span><span class="p">)</span>
<span class="n">drawdown</span> <span class="o">=</span> <span class="p">(</span><span class="n">strategy_cum</span> <span class="o">-</span> <span class="n">peak</span><span class="p">)</span> <span class="o">/</span> <span class="n">peak</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">drawdown</span><span class="p">)),</span> <span class="n">drawdown</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Trading Days&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Drawdown&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Strategy Drawdown&#39;</span><span class="p">)</span>

<span class="c1"># Fold accuracy over time</span>
<span class="n">fold_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">backtester</span><span class="o">.</span><span class="n">fold_results</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fold_df</span><span class="p">)),</span> <span class="n">fold_df</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">])</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Random&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">fold_df</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Average&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Fold&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Accuracy&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Walk-Forward Accuracy by Fold&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="c1"># Monthly returns heatmap</span>
<span class="n">strategy_returns</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;strategy_returns&#39;</span><span class="p">],</span> <span class="n">index</span><span class="o">=</span><span class="n">valid_results</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
<span class="n">monthly</span> <span class="o">=</span> <span class="n">strategy_returns</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">&#39;M&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;green&#39;</span> <span class="k">if</span> <span class="n">r</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;red&#39;</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">monthly</span><span class="o">.</span><span class="n">values</span><span class="p">]</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">monthly</span><span class="p">)),</span> <span class="n">monthly</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Month&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Monthly Return&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Monthly Returns&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
<div class="md-cell"><hr />
<h2>Part 5: Production System Design</h2>
<p>Design a production-ready system architecture.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># TODO: Build a complete production trading system</span>

<span class="k">class</span> <span class="nc">ProductionTradingSystem</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Complete production ML trading system.</span>
<span class="sd">    </span>
<span class="sd">    This system should include:</span>
<span class="sd">    - Feature pipeline with versioning</span>
<span class="sd">    - Model registry with version control</span>
<span class="sd">    - Real-time prediction service</span>
<span class="sd">    - Performance monitoring</span>
<span class="sd">    - Alert system</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">feature_names</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                 <span class="n">initial_capital</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">100000</span><span class="p">):</span>
        <span class="c1"># Your implementation here</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_names</span> <span class="o">=</span> <span class="n">feature_names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initial_capital</span> <span class="o">=</span> <span class="n">initial_capital</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">capital</span> <span class="o">=</span> <span class="n">initial_capital</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_engineer</span> <span class="o">=</span> <span class="n">FeatureEngineer</span><span class="p">()</span>
        
        <span class="c1"># Tracking</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">predictions_log</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trades_log</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">equity_curve</span> <span class="o">=</span> <span class="p">[</span><span class="n">initial_capital</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alerts</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="c1"># Performance monitoring</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rolling_accuracy</span> <span class="o">=</span> <span class="n">deque</span><span class="p">(</span><span class="n">maxlen</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">train_data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Fit the system on training data.&quot;&quot;&quot;</span>
        <span class="c1"># Create features</span>
        <span class="n">df_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_engineer</span><span class="o">.</span><span class="n">create_all_features</span><span class="p">(</span><span class="n">train_data</span><span class="p">)</span>
        
        <span class="c1"># Prepare data</span>
        <span class="n">valid_mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">df_features</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">feature_names</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">valid_data</span> <span class="o">=</span> <span class="n">df_features</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">]</span>
        
        <span class="n">X</span> <span class="o">=</span> <span class="n">valid_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">feature_names</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">valid_data</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        
        <span class="c1"># Fit scaler and model</span>
        <span class="n">X_scaled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_scaled</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;System fitted on </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="si">}</span><span class="s2"> samples&quot;</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current_data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Generate prediction for current data.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Create features</span>
            <span class="n">df_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_engineer</span><span class="o">.</span><span class="n">create_all_features</span><span class="p">(</span><span class="n">current_data</span><span class="p">)</span>
            
            <span class="c1"># Get latest features</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">df_features</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">feature_names</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">values</span>
            
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;NaN in features&#39;</span><span class="p">}</span>
            
            <span class="c1"># Scale and predict</span>
            <span class="n">X_scaled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
            <span class="n">prediction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_scaled</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">probability</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_scaled</span><span class="p">)[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
            
            <span class="n">signal</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">prediction</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span>
            
            <span class="n">result</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;success&#39;</span><span class="p">,</span>
                <span class="s1">&#39;prediction&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">prediction</span><span class="p">),</span>
                <span class="s1">&#39;probability&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">probability</span><span class="p">),</span>
                <span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="n">signal</span><span class="p">,</span>
                <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
            <span class="p">}</span>
            
            <span class="c1"># Log prediction</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">predictions_log</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
            
            <span class="k">return</span> <span class="n">result</span>
            
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>
    
    <span class="k">def</span> <span class="nf">update_with_actual</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">actual</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update system with actual outcome.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">predictions_log</span><span class="p">:</span>
            <span class="n">last_pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predictions_log</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;prediction&#39;</span><span class="p">]</span>
            <span class="n">is_correct</span> <span class="o">=</span> <span class="n">last_pred</span> <span class="o">==</span> <span class="n">actual</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rolling_accuracy</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span> <span class="k">if</span> <span class="n">is_correct</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
            
            <span class="c1"># Check for performance degradation</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rolling_accuracy</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">20</span><span class="p">:</span>
                <span class="n">acc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rolling_accuracy</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">acc</span> <span class="o">&lt;</span> <span class="mf">0.45</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">alerts</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                        <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
                        <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;performance_degradation&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Rolling accuracy dropped to </span><span class="si">{</span><span class="n">acc</span><span class="si">:</span><span class="s1">.2%</span><span class="si">}</span><span class="s1">&#39;</span>
                    <span class="p">})</span>
    
    <span class="k">def</span> <span class="nf">trade</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">signal</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">price</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Execute trade based on signal.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">signal</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">position</span><span class="p">:</span>
            <span class="c1"># Calculate cost</span>
            <span class="n">cost</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">signal</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">position</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">capital</span> <span class="o">*</span> <span class="mf">0.001</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">capital</span> <span class="o">-=</span> <span class="n">cost</span>
            
            <span class="n">trade</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
                <span class="s1">&#39;old_position&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">position</span><span class="p">,</span>
                <span class="s1">&#39;new_position&#39;</span><span class="p">:</span> <span class="n">signal</span><span class="p">,</span>
                <span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="n">price</span><span class="p">,</span>
                <span class="s1">&#39;cost&#39;</span><span class="p">:</span> <span class="n">cost</span>
            <span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trades_log</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">trade</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="n">signal</span>
    
    <span class="k">def</span> <span class="nf">update_pnl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">price_return</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update P&amp;L based on position.&quot;&quot;&quot;</span>
        <span class="n">pnl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">capital</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">*</span> <span class="n">price_return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">capital</span> <span class="o">+=</span> <span class="n">pnl</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">equity_curve</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">capital</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">get_status</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get system status.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;capital&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">capital</span><span class="p">,</span>
            <span class="s1">&#39;position&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">position</span><span class="p">,</span>
            <span class="s1">&#39;total_return&#39;</span><span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">capital</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_capital</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s1">&#39;n_predictions&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">predictions_log</span><span class="p">),</span>
            <span class="s1">&#39;n_trades&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trades_log</span><span class="p">),</span>
            <span class="s1">&#39;rolling_accuracy&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rolling_accuracy</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rolling_accuracy</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;n_alerts&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alerts</span><span class="p">)</span>
        <span class="p">}</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ProductionTradingSystem class defined&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Test production system</span>
<span class="c1"># Split data for production simulation</span>
<span class="n">train_data</span> <span class="o">=</span> <span class="n">market_data</span><span class="p">[</span><span class="n">primary_asset</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="mi">1500</span><span class="p">]</span>
<span class="n">test_data</span> <span class="o">=</span> <span class="n">market_data</span><span class="p">[</span><span class="n">primary_asset</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">1500</span><span class="p">:]</span>

<span class="c1"># Initialize production system</span>
<span class="n">prod_system</span> <span class="o">=</span> <span class="n">ProductionTradingSystem</span><span class="p">(</span>
    <span class="n">model</span><span class="o">=</span><span class="n">RandomForestClassifier</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">),</span>
    <span class="n">feature_names</span><span class="o">=</span><span class="n">top_features</span><span class="p">,</span>
    <span class="n">initial_capital</span><span class="o">=</span><span class="mi">100000</span>
<span class="p">)</span>

<span class="c1"># Fit on training data</span>
<span class="n">prod_system</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_data</span><span class="p">)</span>

<span class="c1"># Simulate live trading</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Simulating live trading...&quot;</span><span class="p">)</span>
<span class="n">lookback</span> <span class="o">=</span> <span class="mi">100</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">lookback</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
    <span class="c1"># Get current data window</span>
    <span class="n">current_data</span> <span class="o">=</span> <span class="n">test_data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="n">lookback</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">current_price</span> <span class="o">=</span> <span class="n">test_data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;close&#39;</span><span class="p">]</span>
    
    <span class="c1"># Generate prediction</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">prod_system</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">current_data</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;success&#39;</span><span class="p">:</span>
        <span class="c1"># Trade</span>
        <span class="n">prod_system</span><span class="o">.</span><span class="n">trade</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">],</span> <span class="n">current_price</span><span class="p">)</span>
        
        <span class="c1"># Update P&amp;L</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="n">lookback</span><span class="p">:</span>
            <span class="n">prev_price</span> <span class="o">=</span> <span class="n">test_data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;close&#39;</span><span class="p">]</span>
            <span class="n">price_return</span> <span class="o">=</span> <span class="p">(</span><span class="n">current_price</span> <span class="o">-</span> <span class="n">prev_price</span><span class="p">)</span> <span class="o">/</span> <span class="n">prev_price</span>
            <span class="n">prod_system</span><span class="o">.</span><span class="n">update_pnl</span><span class="p">(</span><span class="n">price_return</span><span class="p">)</span>
        
        <span class="c1"># Update with actual</span>
        <span class="n">next_price</span> <span class="o">=</span> <span class="n">test_data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;close&#39;</span><span class="p">]</span>
        <span class="n">actual</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">next_price</span> <span class="o">&gt;</span> <span class="n">current_price</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="n">prod_system</span><span class="o">.</span><span class="n">update_with_actual</span><span class="p">(</span><span class="n">actual</span><span class="p">)</span>

<span class="c1"># Get final status</span>
<span class="n">status</span> <span class="o">=</span> <span class="n">prod_system</span><span class="o">.</span><span class="n">get_status</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;PRODUCTION SYSTEM STATUS&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>
<span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">status</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="k">if</span> <span class="s1">&#39;return&#39;</span> <span class="ow">in</span> <span class="n">key</span> <span class="ow">or</span> <span class="s1">&#39;accuracy&#39;</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">value</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">value</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">: N/A&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="s1">&#39;capital&#39;</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">: $</span><span class="si">{</span><span class="n">value</span><span class="si">:</span><span class="s2">,.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><hr />
<h2>Part 6: Final Analysis and Report</h2>
<p>Generate comprehensive analysis and final report.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Generate final comprehensive report</span>

<span class="k">def</span> <span class="nf">generate_final_report</span><span class="p">(</span><span class="n">backtester</span><span class="p">:</span> <span class="n">WalkForwardBacktester</span><span class="p">,</span>
                          <span class="n">prod_system</span><span class="p">:</span> <span class="n">ProductionTradingSystem</span><span class="p">,</span>
                          <span class="n">model_comparison</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Generate comprehensive project report.&quot;&quot;&quot;</span>
    
    <span class="n">bt_metrics</span> <span class="o">=</span> <span class="n">backtester</span><span class="o">.</span><span class="n">calculate_backtest_metrics</span><span class="p">()</span>
    <span class="n">prod_status</span> <span class="o">=</span> <span class="n">prod_system</span><span class="o">.</span><span class="n">get_status</span><span class="p">()</span>
    
    <span class="n">report</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="si">{</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">60</span><span class="si">}</span><span class="s2"></span>
<span class="s2">CAPSTONE PROJECT: END-TO-END ML TRADING SYSTEM</span>
<span class="s2">Final Report</span>
<span class="si">{</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">60</span><span class="si">}</span><span class="s2"></span>
<span class="s2">Generated: </span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="si">}</span><span class="s2"></span>

<span class="si">{</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">60</span><span class="si">}</span><span class="s2"></span>
<span class="s2">1. MODEL SELECTION</span>
<span class="si">{</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">60</span><span class="si">}</span><span class="s2"></span>
<span class="si">{</span><span class="n">model_comparison</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="si">}</span><span class="s2"></span>

<span class="s2">Best Model: </span><span class="si">{</span><span class="n">model_comparison</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;model&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"></span>

<span class="si">{</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">60</span><span class="si">}</span><span class="s2"></span>
<span class="s2">2. WALK-FORWARD BACKTEST RESULTS</span>
<span class="si">{</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">60</span><span class="si">}</span><span class="s2"></span>
<span class="s2">Total Return: </span><span class="si">{</span><span class="n">bt_metrics</span><span class="p">[</span><span class="s1">&#39;total_return&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2"></span>
<span class="s2">Sharpe Ratio: </span><span class="si">{</span><span class="n">bt_metrics</span><span class="p">[</span><span class="s1">&#39;sharpe_ratio&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"></span>
<span class="s2">Max Drawdown: </span><span class="si">{</span><span class="n">bt_metrics</span><span class="p">[</span><span class="s1">&#39;max_drawdown&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2"></span>
<span class="s2">Win Rate: </span><span class="si">{</span><span class="n">bt_metrics</span><span class="p">[</span><span class="s1">&#39;win_rate&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2"></span>
<span class="s2">Number of Trades: </span><span class="si">{</span><span class="n">bt_metrics</span><span class="p">[</span><span class="s1">&#39;n_trades&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2"></span>
<span class="s2">Total Transaction Costs: $</span><span class="si">{</span><span class="n">bt_metrics</span><span class="p">[</span><span class="s1">&#39;total_costs&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">,.2f</span><span class="si">}</span><span class="s2"></span>
<span class="s2">Average Fold Accuracy: </span><span class="si">{</span><span class="n">bt_metrics</span><span class="p">[</span><span class="s1">&#39;avg_fold_accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"></span>

<span class="si">{</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">60</span><span class="si">}</span><span class="s2"></span>
<span class="s2">3. PRODUCTION SIMULATION RESULTS</span>
<span class="si">{</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">60</span><span class="si">}</span><span class="s2"></span>
<span class="s2">Final Capital: $</span><span class="si">{</span><span class="n">prod_status</span><span class="p">[</span><span class="s1">&#39;capital&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">,.2f</span><span class="si">}</span><span class="s2"></span>
<span class="s2">Total Return: </span><span class="si">{</span><span class="n">prod_status</span><span class="p">[</span><span class="s1">&#39;total_return&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2"></span>
<span class="s2">Total Predictions: </span><span class="si">{</span><span class="n">prod_status</span><span class="p">[</span><span class="s1">&#39;n_predictions&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"></span>
<span class="s2">Total Trades: </span><span class="si">{</span><span class="n">prod_status</span><span class="p">[</span><span class="s1">&#39;n_trades&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"></span>
<span class="s2">Rolling Accuracy: </span><span class="si">{</span><span class="n">prod_status</span><span class="p">[</span><span class="s1">&#39;rolling_accuracy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot; if prod_status[&#39;rolling_accuracy&#39;] else &quot;N/A&quot;</span>
<span class="s2">Alerts Generated: </span><span class="si">{</span><span class="n">prod_status</span><span class="p">[</span><span class="s1">&#39;n_alerts&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"></span>

<span class="si">{</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">60</span><span class="si">}</span><span class="s2"></span>
<span class="s2">4. KEY FINDINGS</span>
<span class="si">{</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">60</span><span class="si">}</span><span class="s2"></span>
<span class="s2">- The </span><span class="si">{</span><span class="n">model_comparison</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;model&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> model achieved the best F1 score</span>
<span class="s2">- Walk-forward validation shows realistic out-of-sample performance</span>
<span class="s2">- Transaction costs significantly impact overall returns</span>
<span class="s2">- System includes monitoring for performance degradation</span>

<span class="si">{</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">60</span><span class="si">}</span><span class="s2"></span>
<span class="s2">5. RECOMMENDATIONS</span>
<span class="si">{</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">60</span><span class="si">}</span><span class="s2"></span>
<span class="s2">- Consider additional features (sentiment, alternative data)</span>
<span class="s2">- Implement ensemble methods for more robust predictions</span>
<span class="s2">- Add regime detection for adaptive model selection</span>
<span class="s2">- Monitor for concept drift and retrain periodically</span>

<span class="si">{</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">60</span><span class="si">}</span><span class="s2"></span>
<span class="s2">END OF REPORT</span>
<span class="si">{</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">60</span><span class="si">}</span><span class="s2"></span>
<span class="s2">&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">report</span>

<span class="c1"># Generate and print report</span>
<span class="n">final_report</span> <span class="o">=</span> <span class="n">generate_final_report</span><span class="p">(</span><span class="n">backtester</span><span class="p">,</span> <span class="n">prod_system</span><span class="p">,</span> <span class="n">comparison</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">final_report</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Final visualization</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

<span class="c1"># 1. Model comparison</span>
<span class="n">x</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">comparison</span><span class="p">))</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">comparison</span><span class="p">[</span><span class="s1">&#39;f1&#39;</span><span class="p">])</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">comparison</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">],</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;F1 Score&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Model Comparison&#39;</span><span class="p">)</span>

<span class="c1"># 2. Backtest equity curve</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;cumulative_returns&#39;</span><span class="p">])</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Trading Days&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Cumulative Return&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Backtest Equity Curve&#39;</span><span class="p">)</span>

<span class="c1"># 3. Production equity curve</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">prod_system</span><span class="o">.</span><span class="n">equity_curve</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Trading Days&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Capital ($)&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Production Simulation&#39;</span><span class="p">)</span>

<span class="c1"># 4. Fold accuracy distribution</span>
<span class="n">fold_accuracies</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">backtester</span><span class="o">.</span><span class="n">fold_results</span><span class="p">]</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">fold_accuracies</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Accuracy&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Frequency&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Walk-Forward Accuracy Distribution&#39;</span><span class="p">)</span>

<span class="c1"># 5. Rolling accuracy over time (production)</span>
<span class="k">if</span> <span class="n">prod_system</span><span class="o">.</span><span class="n">rolling_accuracy</span><span class="p">:</span>
    <span class="n">rolling_acc</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">prod_system</span><span class="o">.</span><span class="n">rolling_accuracy</span><span class="p">)</span>
    <span class="n">cumulative_acc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">rolling_acc</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">rolling_acc</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">cumulative_acc</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Prediction Number&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Cumulative Accuracy&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Production Accuracy Over Time&#39;</span><span class="p">)</span>

<span class="c1"># 6. Trade distribution</span>
<span class="k">if</span> <span class="n">prod_system</span><span class="o">.</span><span class="n">trades_log</span><span class="p">:</span>
    <span class="n">positions</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="p">[</span><span class="s1">&#39;new_position&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">prod_system</span><span class="o">.</span><span class="n">trades_log</span><span class="p">]</span>
    <span class="n">unique</span><span class="p">,</span> <span class="n">counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Short&#39;</span> <span class="k">if</span> <span class="n">p</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="k">else</span> <span class="s1">&#39;Long&#39;</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">unique</span><span class="p">]</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">counts</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Count&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Trade Distribution&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;CAPSTONE PROJECT COMPLETED&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell key-takeaways"><hr />
<h2>Project Summary</h2>
<p>In this capstone project, you built a complete end-to-end ML trading system that includes:</p>
<ol>
<li>
<p><strong>Data Generation</strong>: Created realistic multi-asset market data with regime switching and volatility clustering</p>
</li>
<li>
<p><strong>Feature Engineering</strong>: Built a comprehensive feature pipeline with price, volatility, technical, and volume features</p>
</li>
<li>
<p><strong>Model Training</strong>: Trained and compared multiple ML models (Logistic Regression, Random Forest, Gradient Boosting)</p>
</li>
<li>
<p><strong>Walk-Forward Backtesting</strong>: Implemented proper walk-forward validation with realistic transaction costs</p>
</li>
<li>
<p><strong>Production System</strong>: Designed a production-ready system with prediction, trading, and monitoring capabilities</p>
</li>
<li>
<p><strong>Performance Analysis</strong>: Generated comprehensive analysis and reporting</p>
</li>
</ol>
<h2>Key Takeaways</h2>
<ul>
<li>Proper feature engineering is crucial for ML trading systems</li>
<li>Walk-forward validation provides realistic performance estimates</li>
<li>Transaction costs significantly impact strategy returns</li>
<li>Production systems require monitoring and alert mechanisms</li>
<li>Continuous improvement and adaptation are essential</li>
</ul>
<h2>Congratulations!</h2>
<p>You have successfully completed the Machine Learning for Financial Markets course. You now have the skills to build, backtest, and deploy ML trading systems.</p></div>
        <div class="nav-buttons">
            <button class="nav-btn prev-btn disabled" type="button">
                <span class="nav-btn-label">‚Üê Previous</span>
                <span class="nav-btn-name"></span>
            </button>
            <button class="nav-btn next-btn disabled" type="button">
                <span class="nav-btn-label">Next ‚Üí</span>
                <span class="nav-btn-name"></span>
            </button>
        </div>
        </div>
    </main>

    <script>
        window.courseId = 'course4_ml_finance';
        
// State
let currentModule = 0;
const modules = document.querySelectorAll('.module-section');
const sidebarItems = document.querySelectorAll('.sidebar-item');
const sidebar = document.querySelector('.sidebar');
const overlay = document.querySelector('.sidebar-overlay');
const headerModule = document.querySelector('.header-module');

function showModule(idx) {
    if (idx < 0 || idx >= modules.length) return;

    // Hide all, show target
    modules.forEach(m => m.classList.remove('active'));
    modules[idx].classList.add('active');

    // Update sidebar active state
    sidebarItems.forEach(s => s.classList.remove('active'));
    sidebarItems[idx].classList.add('active');

    // Update header
    const label = sidebarItems[idx].textContent.trim();
    if (headerModule) headerModule.textContent = label;

    // Update prev/next buttons
    updateNavButtons(idx);

    // Save & scroll
    currentModule = idx;
    try { localStorage.setItem(window.courseId + '_module', idx); } catch(e) {}
    window.scrollTo(0, 0);

    // Close sidebar on mobile
    closeSidebar();
}

function updateNavButtons(idx) {
    const section = modules[idx];
    const prevBtn = section.querySelector('.prev-btn');
    const nextBtn = section.querySelector('.next-btn');

    if (prevBtn) {
        // Clone to remove old listeners
        const newPrev = prevBtn.cloneNode(true);
        prevBtn.parentNode.replaceChild(newPrev, prevBtn);
        if (idx === 0) {
            newPrev.classList.add('disabled');
            newPrev.querySelector('.nav-btn-name').textContent = '';
        } else {
            newPrev.classList.remove('disabled');
            newPrev.querySelector('.nav-btn-name').textContent = sidebarItems[idx - 1].textContent.trim();
            newPrev.addEventListener('click', () => showModule(idx - 1));
        }
    }
    if (nextBtn) {
        const newNext = nextBtn.cloneNode(true);
        nextBtn.parentNode.replaceChild(newNext, nextBtn);
        if (idx === modules.length - 1) {
            newNext.classList.add('disabled');
            newNext.querySelector('.nav-btn-name').textContent = '';
        } else {
            newNext.classList.remove('disabled');
            newNext.querySelector('.nav-btn-name').textContent = sidebarItems[idx + 1].textContent.trim();
            newNext.addEventListener('click', () => showModule(idx + 1));
        }
    }
}

function toggleSidebar() {
    sidebar.classList.toggle('open');
    overlay.classList.toggle('open');
}

function closeSidebar() {
    sidebar.classList.remove('open');
    overlay.classList.remove('open');
}

// Copy code button
function copyCode(btn) {
    const code = btn.parentElement.querySelector('pre code');
    const text = code.textContent;
    navigator.clipboard.writeText(text).then(() => {
        btn.textContent = '‚úì';
        btn.classList.add('copied');
        setTimeout(() => {
            btn.textContent = 'üìã';
            btn.classList.remove('copied');
        }, 1500);
    }).catch(() => {
        // Fallback
        const ta = document.createElement('textarea');
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand('copy');
        document.body.removeChild(ta);
        btn.textContent = '‚úì';
        btn.classList.add('copied');
        setTimeout(() => {
            btn.textContent = 'üìã';
            btn.classList.remove('copied');
        }, 1500);
    });
}

// Init: bind sidebar items
sidebarItems.forEach((item, idx) => {
    item.addEventListener('click', () => showModule(idx));
});

// Restore last viewed module
document.addEventListener('DOMContentLoaded', () => {
    let saved = 0;
    try { saved = parseInt(localStorage.getItem(window.courseId + '_module')) || 0; } catch(e) {}
    if (saved >= 0 && saved < modules.length) {
        showModule(saved);
    } else {
        showModule(0);
    }
});

// Keyboard navigation
document.addEventListener('keydown', (e) => {
    if (e.key === 'ArrowLeft' && currentModule > 0) showModule(currentModule - 1);
    if (e.key === 'ArrowRight' && currentModule < modules.length - 1) showModule(currentModule + 1);
    if (e.key === 'Escape') closeSidebar();
});

    </script>
</body>
</html>