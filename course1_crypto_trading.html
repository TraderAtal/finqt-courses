<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <title>Crypto Algo Trading â€” FinQT</title>
    <style>
/* === Reset & Base === */
*, *::before, *::after {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
}

:root {
    --bg: #0a0a0a;
    --bg-secondary: #111111;
    --bg-sidebar: #0d0d0d;
    --text: #e0e0e0;
    --text-dim: #888888;
    --green: #00c853;
    --green-dim: #1b5e20;
    --green-glow: rgba(0, 200, 83, 0.15);
    --code-bg: #141420;
    --border: #1e1e1e;
    --header-height: 52px;
}

html {
    font-size: 16px;
    -webkit-text-size-adjust: 100%;
}

body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    background: var(--bg);
    color: var(--text);
    line-height: 1.65;
    overflow-x: hidden;
    -webkit-font-smoothing: antialiased;
}

/* === Header === */
.header {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    height: var(--header-height);
    background: var(--bg-secondary);
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    padding: 0 16px;
    z-index: 1000;
    gap: 12px;
}

.hamburger {
    background: none;
    border: none;
    color: var(--text);
    font-size: 22px;
    cursor: pointer;
    padding: 6px;
    border-radius: 6px;
    line-height: 1;
    flex-shrink: 0;
}
.hamburger:hover {
    background: rgba(255,255,255,0.08);
}

.header-title {
    font-size: 15px;
    font-weight: 600;
    color: var(--green);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.header-module {
    font-size: 13px;
    color: var(--text-dim);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    margin-left: auto;
}

/* === Sidebar === */
.sidebar-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.6);
    z-index: 1001;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s;
}
.sidebar-overlay.open {
    opacity: 1;
    pointer-events: auto;
}

.sidebar {
    position: fixed;
    top: 0;
    left: 0;
    bottom: 0;
    width: 280px;
    max-width: 85vw;
    background: var(--bg-sidebar);
    border-right: 1px solid var(--border);
    z-index: 1002;
    transform: translateX(-100%);
    transition: transform 0.25s ease;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
    padding-top: 12px;
    padding-bottom: 24px;
}
.sidebar.open {
    transform: translateX(0);
}

.sidebar-header {
    padding: 12px 16px 16px;
    border-bottom: 1px solid var(--border);
    margin-bottom: 8px;
}
.sidebar-header h2 {
    font-size: 15px;
    color: var(--green);
    font-weight: 600;
}

.sidebar-part {
    padding: 10px 16px 4px;
    font-size: 11px;
    font-weight: 700;
    color: var(--text-dim);
    text-transform: uppercase;
    letter-spacing: 0.6px;
}

.sidebar-item {
    display: block;
    padding: 8px 16px 8px 24px;
    font-size: 13px;
    color: var(--text);
    text-decoration: none;
    cursor: pointer;
    border-left: 3px solid transparent;
    transition: all 0.15s;
}
.sidebar-item:hover {
    background: rgba(255,255,255,0.04);
}
.sidebar-item.active {
    color: var(--green);
    border-left-color: var(--green);
    background: var(--green-glow);
    font-weight: 600;
}

/* === Main Content === */
.main {
    margin-top: var(--header-height);
    padding: 20px 16px 80px;
    max-width: 800px;
    margin-left: auto;
    margin-right: auto;
}

.module-section {
    display: none;
}
.module-section.active {
    display: block;
}

/* === Typography === */
.md-cell h1 {
    font-size: 1.7rem;
    font-weight: 700;
    color: var(--green);
    margin: 1.5em 0 0.5em;
    line-height: 1.25;
}
.md-cell h2 {
    font-size: 1.35rem;
    font-weight: 600;
    color: var(--green);
    margin: 1.4em 0 0.4em;
    padding-bottom: 6px;
    border-bottom: 1px solid var(--border);
}
.md-cell h3 {
    font-size: 1.1rem;
    font-weight: 600;
    color: #cccccc;
    margin: 1.2em 0 0.3em;
}
.md-cell h4, .md-cell h5, .md-cell h6 {
    font-size: 1rem;
    font-weight: 600;
    color: #bbbbbb;
    margin: 1em 0 0.3em;
}

.md-cell p {
    margin: 0.6em 0;
}

.md-cell a {
    color: var(--green);
    text-decoration: none;
}
.md-cell a:hover {
    text-decoration: underline;
}

.md-cell strong {
    color: #f0f0f0;
}

.md-cell ul, .md-cell ol {
    margin: 0.5em 0;
    padding-left: 1.5em;
}
.md-cell li {
    margin: 0.25em 0;
}

.md-cell hr {
    border: none;
    border-top: 1px solid var(--border);
    margin: 1.5em 0;
}

.md-cell blockquote {
    border-left: 3px solid var(--green-dim);
    padding: 0.5em 1em;
    margin: 0.8em 0;
    color: var(--text-dim);
    background: rgba(255,255,255,0.02);
    border-radius: 0 6px 6px 0;
}

/* Inline code (not inside pre blocks) */
.md-cell code {
    background: rgba(255,255,255,0.08);
    padding: 2px 6px;
    border-radius: 3px;
    font-family: "SF Mono", "Fira Code", "Cascadia Code", Menlo, monospace;
    font-size: 0.88em;
    color: #e8e8e8;
}
.md-cell pre code {
    background: transparent !important;
    padding: 0;
    border-radius: 0;
    color: inherit;
}

/* Fenced code blocks inside markdown */
.md-cell pre {
    background: var(--code-bg);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 14px 16px;
    overflow-x: auto;
    margin: 0.8em 0;
    -webkit-overflow-scrolling: touch;
}
.md-cell pre code {
    background: none;
    padding: 0;
    border-radius: 0;
    font-size: 0.85rem;
    line-height: 1.5;
    color: #e8e8e8;
}

/* === Module Header (first cell) === */
.module-header {
    padding-bottom: 0.5em;
    margin-bottom: 0.5em;
}
.module-header h1 {
    font-size: 1.8rem;
    margin-top: 0;
}

/* === Tables === */
.table-wrapper {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    margin: 0.8em 0;
    border-radius: 8px;
    border: 1px solid var(--border);
}

.md-cell table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.88rem;
}
.md-cell th {
    background: var(--bg-secondary);
    color: var(--green);
    font-weight: 600;
    text-align: left;
    padding: 10px 12px;
    border-bottom: 2px solid var(--border);
    white-space: nowrap;
}
.md-cell td {
    padding: 8px 12px;
    border-bottom: 1px solid var(--border);
    vertical-align: top;
}
.md-cell tr:last-child td {
    border-bottom: none;
}

/* === Code Cells === */
.code-cell {
    position: relative;
    background: var(--code-bg);
    border: 1px solid var(--border);
    border-radius: 8px;
    margin: 0.6em 0;
    overflow: hidden;
}
.code-cell pre {
    margin: 0;
    padding: 14px 16px;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
}
.code-cell pre code {
    font-family: "SF Mono", "Fira Code", "Cascadia Code", Menlo, monospace;
    font-size: 0.82rem;
    line-height: 1.55;
    background: transparent !important;
    padding: 0;
    border-radius: 0;
}

.copy-btn {
    position: absolute;
    top: 6px;
    right: 6px;
    background: rgba(255,255,255,0.08);
    border: none;
    border-radius: 4px;
    padding: 4px 7px;
    font-size: 13px;
    cursor: pointer;
    opacity: 0;
    transition: opacity 0.15s;
    z-index: 5;
}
.code-cell:hover .copy-btn {
    opacity: 1;
}
.copy-btn:hover {
    background: rgba(255,255,255,0.15);
}
.copy-btn.copied {
    opacity: 1;
}

/* === Exercise Styling === */
.exercise-header {
    background: rgba(0, 200, 83, 0.04);
    border: 1px solid var(--green-dim);
    border-radius: 8px;
    padding: 12px 16px;
    margin: 1em 0 0.3em;
}
.exercise-header h3 {
    color: var(--green);
    margin-top: 0;
}

.exercise-code {
    border-color: var(--green-dim);
}

/* === Solution (details) blocks === */
.solution-block details {
    border-left: 3px solid var(--green);
    border-radius: 0 8px 8px 0;
    margin: 0.5em 0 1em;
    background: rgba(0, 200, 83, 0.03);
}
.solution-block summary {
    padding: 10px 14px;
    cursor: pointer;
    color: var(--green);
    font-weight: 600;
    font-size: 0.9rem;
    user-select: none;
    -webkit-user-select: none;
}
.solution-block summary:hover {
    background: rgba(0, 200, 83, 0.06);
}
.solution-block details[open] summary {
    border-bottom: 1px solid var(--border);
    margin-bottom: 0;
}
.solution-block details > :not(summary) {
    padding: 0 14px;
}
.solution-block details pre {
    margin: 10px 0;
}

/* === Module Project === */
.module-project {
    border: 1px solid var(--green-dim);
    border-radius: 8px;
    padding: 16px;
    margin: 1.5em 0;
    background: rgba(0, 200, 83, 0.03);
}
.module-project h1 {
    font-size: 1.4rem;
}

/* === Key Takeaways === */
.key-takeaways {
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 16px;
    margin: 1.5em 0;
}
.key-takeaways h1 {
    font-size: 1.3rem;
    margin-top: 0;
}

/* === Prev/Next Navigation === */
.nav-buttons {
    display: flex;
    gap: 12px;
    margin-top: 2em;
    padding-top: 1.5em;
    border-top: 1px solid var(--border);
}
.nav-btn {
    flex: 1;
    padding: 12px 16px;
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text);
    font-family: inherit;
    font-size: 0.9rem;
    cursor: pointer;
    text-align: center;
    transition: all 0.15s;
    text-decoration: none;
    -webkit-appearance: none;
    -webkit-tap-highlight-color: rgba(0, 200, 83, 0.2);
}
.nav-btn:hover {
    border-color: var(--green);
    color: var(--green);
}
.nav-btn.disabled {
    opacity: 0.3;
    pointer-events: none;
}
.nav-btn-label {
    display: block;
    font-size: 0.75rem;
    color: var(--text-dim);
    margin-bottom: 2px;
}

/* === Syntax Highlighting (Pygments Monokai) === */
pre { line-height: 125%; }
td.linenos .normal { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
span.linenos { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
td.linenos .special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
span.linenos.special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
.code-cell pre code .hll { background-color: #49483e }
.code-cell pre code { background: #272822; color: #f8f8f2 }
.code-cell pre code .c { color: #75715e } /* Comment */
.code-cell pre code .err { color: #960050; background-color: #1e0010 } /* Error */
.code-cell pre code .esc { color: #f8f8f2 } /* Escape */
.code-cell pre code .g { color: #f8f8f2 } /* Generic */
.code-cell pre code .k { color: #66d9ef } /* Keyword */
.code-cell pre code .l { color: #ae81ff } /* Literal */
.code-cell pre code .n { color: #f8f8f2 } /* Name */
.code-cell pre code .o { color: #f92672 } /* Operator */
.code-cell pre code .x { color: #f8f8f2 } /* Other */
.code-cell pre code .p { color: #f8f8f2 } /* Punctuation */
.code-cell pre code .ch { color: #75715e } /* Comment.Hashbang */
.code-cell pre code .cm { color: #75715e } /* Comment.Multiline */
.code-cell pre code .cp { color: #75715e } /* Comment.Preproc */
.code-cell pre code .cpf { color: #75715e } /* Comment.PreprocFile */
.code-cell pre code .c1 { color: #75715e } /* Comment.Single */
.code-cell pre code .cs { color: #75715e } /* Comment.Special */
.code-cell pre code .gd { color: #f92672 } /* Generic.Deleted */
.code-cell pre code .ge { color: #f8f8f2; font-style: italic } /* Generic.Emph */
.code-cell pre code .gr { color: #f8f8f2 } /* Generic.Error */
.code-cell pre code .gh { color: #f8f8f2 } /* Generic.Heading */
.code-cell pre code .gi { color: #a6e22e } /* Generic.Inserted */
.code-cell pre code .go { color: #66d9ef } /* Generic.Output */
.code-cell pre code .gp { color: #f92672; font-weight: bold } /* Generic.Prompt */
.code-cell pre code .gs { color: #f8f8f2; font-weight: bold } /* Generic.Strong */
.code-cell pre code .gu { color: #75715e } /* Generic.Subheading */
.code-cell pre code .gt { color: #f8f8f2 } /* Generic.Traceback */
.code-cell pre code .kc { color: #66d9ef } /* Keyword.Constant */
.code-cell pre code .kd { color: #66d9ef } /* Keyword.Declaration */
.code-cell pre code .kn { color: #f92672 } /* Keyword.Namespace */
.code-cell pre code .kp { color: #66d9ef } /* Keyword.Pseudo */
.code-cell pre code .kr { color: #66d9ef } /* Keyword.Reserved */
.code-cell pre code .kt { color: #66d9ef } /* Keyword.Type */
.code-cell pre code .ld { color: #e6db74 } /* Literal.Date */
.code-cell pre code .m { color: #ae81ff } /* Literal.Number */
.code-cell pre code .s { color: #e6db74 } /* Literal.String */
.code-cell pre code .na { color: #a6e22e } /* Name.Attribute */
.code-cell pre code .nb { color: #f8f8f2 } /* Name.Builtin */
.code-cell pre code .nc { color: #a6e22e } /* Name.Class */
.code-cell pre code .no { color: #66d9ef } /* Name.Constant */
.code-cell pre code .nd { color: #a6e22e } /* Name.Decorator */
.code-cell pre code .ni { color: #f8f8f2 } /* Name.Entity */
.code-cell pre code .ne { color: #a6e22e } /* Name.Exception */
.code-cell pre code .nf { color: #a6e22e } /* Name.Function */
.code-cell pre code .nl { color: #f8f8f2 } /* Name.Label */
.code-cell pre code .nn { color: #f8f8f2 } /* Name.Namespace */
.code-cell pre code .nx { color: #a6e22e } /* Name.Other */
.code-cell pre code .py { color: #f8f8f2 } /* Name.Property */
.code-cell pre code .nt { color: #f92672 } /* Name.Tag */
.code-cell pre code .nv { color: #f8f8f2 } /* Name.Variable */
.code-cell pre code .ow { color: #f92672 } /* Operator.Word */
.code-cell pre code .w { color: #f8f8f2 } /* Text.Whitespace */
.code-cell pre code .mb { color: #ae81ff } /* Literal.Number.Bin */
.code-cell pre code .mf { color: #ae81ff } /* Literal.Number.Float */
.code-cell pre code .mh { color: #ae81ff } /* Literal.Number.Hex */
.code-cell pre code .mi { color: #ae81ff } /* Literal.Number.Integer */
.code-cell pre code .mo { color: #ae81ff } /* Literal.Number.Oct */
.code-cell pre code .sa { color: #e6db74 } /* Literal.String.Affix */
.code-cell pre code .sb { color: #e6db74 } /* Literal.String.Backtick */
.code-cell pre code .sc { color: #e6db74 } /* Literal.String.Char */
.code-cell pre code .dl { color: #e6db74 } /* Literal.String.Delimiter */
.code-cell pre code .sd { color: #e6db74 } /* Literal.String.Doc */
.code-cell pre code .s2 { color: #e6db74 } /* Literal.String.Double */
.code-cell pre code .se { color: #ae81ff } /* Literal.String.Escape */
.code-cell pre code .sh { color: #e6db74 } /* Literal.String.Heredoc */
.code-cell pre code .si { color: #e6db74 } /* Literal.String.Interpol */
.code-cell pre code .sx { color: #e6db74 } /* Literal.String.Other */
.code-cell pre code .sr { color: #e6db74 } /* Literal.String.Regex */
.code-cell pre code .s1 { color: #e6db74 } /* Literal.String.Single */
.code-cell pre code .ss { color: #e6db74 } /* Literal.String.Symbol */
.code-cell pre code .bp { color: #f8f8f2 } /* Name.Builtin.Pseudo */
.code-cell pre code .fm { color: #a6e22e } /* Name.Function.Magic */
.code-cell pre code .vc { color: #f8f8f2 } /* Name.Variable.Class */
.code-cell pre code .vg { color: #f8f8f2 } /* Name.Variable.Global */
.code-cell pre code .vi { color: #f8f8f2 } /* Name.Variable.Instance */
.code-cell pre code .vm { color: #f8f8f2 } /* Name.Variable.Magic */
.code-cell pre code .il { color: #ae81ff } /* Literal.Number.Integer.Long */

/* === Responsive === */
@media (min-width: 1024px) {
    .sidebar {
        transform: translateX(0);
        top: var(--header-height);
        padding-top: 8px;
        border-top: none;
    }
    .sidebar-overlay {
        display: none;
    }
    .main {
        margin-left: 296px;
    }
    .hamburger {
        display: none;
    }
}

/* Scrollbar styling */
::-webkit-scrollbar {
    width: 6px;
    height: 6px;
}
::-webkit-scrollbar-track {
    background: transparent;
}
::-webkit-scrollbar-thumb {
    background: rgba(255,255,255,0.15);
    border-radius: 3px;
}
::-webkit-scrollbar-thumb:hover {
    background: rgba(255,255,255,0.25);
}
</style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <button class="hamburger" onclick="toggleSidebar()" aria-label="Menu">â˜°</button>
        <span class="header-title">Crypto Algo Trading</span>
        <span class="header-module"></span>
    </div>

    <!-- Sidebar Overlay -->
    <div class="sidebar-overlay" onclick="closeSidebar()"></div>

    <!-- Sidebar -->
    <nav class="sidebar">
        <div class="sidebar-header">
            <h2>Crypto Algo Trading</h2>
        </div>
        <div class="sidebar-part">Overview</div>
<div class="sidebar-item">Course Overview</div>
<div class="sidebar-part">Part 1: Markets &amp; Data</div>
<div class="sidebar-item">Module 1: Cryptocurrency Fundamentals</div>
<div class="sidebar-item">Module 2: Crypto Data Sources</div>
<div class="sidebar-item">Module 3: Crypto Technical Analysis</div>
<div class="sidebar-item">Module 4: On-Chain Analytics</div>
<div class="sidebar-part">Part 2: Strategy Development</div>
<div class="sidebar-item">Module 5: Crypto Trading Strategies</div>
<div class="sidebar-item">Module 6: Backtesting Crypto Strategies</div>
<div class="sidebar-item">Module 7: Risk Management</div>
<div class="sidebar-item">Module 8: Automation Fundamentals</div>
<div class="sidebar-part">Part 3: Exchange Integration</div>
<div class="sidebar-item">Module 9: Exchange APIs Deep Dive</div>
<div class="sidebar-item">Module 10: Order Execution</div>
<div class="sidebar-item">Module 11: Live Trading</div>
<div class="sidebar-part">Part 4: DeFi &amp; Advanced</div>
<div class="sidebar-item">Module 12: DeFi Fundamentals</div>
<div class="sidebar-item">Module 13: DEX Trading</div>
<div class="sidebar-item">Module 14: Advanced DeFi Strategies</div>
<div class="sidebar-item">Module 15: Advanced Crypto Topics</div>
<div class="sidebar-part">Capstone</div>
<div class="sidebar-item">Capstone Project</div>
    </nav>

    <!-- Main Content -->
    <main class="main">
        <div class="module-section active" data-idx="0"><div class="md-cell module-header"><h1>Course 1: Crypto Algorithmic Trading</h1>
<h2>finqt Trading Courses</h2>
<hr />
<h2>ğŸ¯ Course Overview</h2>
<p>Master algorithmic trading in cryptocurrency markets. Learn crypto-specific analysis, implement trading strategies, connect to exchanges, and explore DeFi and on-chain analytics. Build automated bots for 24/7 markets.</p>
<hr />
<div class="table-wrapper"><table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>ğŸ“Š <strong>Level</strong></td>
<td>Intermediate</td>
</tr>
<tr>
<td>â±ï¸ <strong>Duration</strong></td>
<td>~35 hours</td>
</tr>
<tr>
<td>ğŸ“‹ <strong>Prerequisites</strong></td>
<td>Python for Finance (Course 0)</td>
</tr>
<tr>
<td>ğŸ’ª <strong>Exercises</strong></td>
<td>~90</td>
</tr>
<tr>
<td>ğŸ“š <strong>Modules</strong></td>
<td>15 + Capstone</td>
</tr>
</tbody>
</table></div></div>
<div class="md-cell"><hr />
<h2>ğŸ“š Course Structure</h2>
<h3>Part 1: Crypto Markets &amp; Data</h3>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Module</th>
<th>Topic</th>
<th>Duration</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>Cryptocurrency Fundamentals</td>
<td>~2.5h</td>
</tr>
<tr>
<td>2</td>
<td>Crypto Data Sources</td>
<td>~2.5h</td>
</tr>
<tr>
<td>3</td>
<td>Crypto Technical Analysis</td>
<td>~2.5h</td>
</tr>
<tr>
<td>4</td>
<td>On-Chain Analytics</td>
<td>~2.5h</td>
</tr>
</tbody>
</table></div>
<h3>Part 2: Strategy Development</h3>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Module</th>
<th>Topic</th>
<th>Duration</th>
</tr>
</thead>
<tbody>
<tr>
<td>5</td>
<td>Crypto Trading Strategies</td>
<td>~2.5h</td>
</tr>
<tr>
<td>6</td>
<td>Backtesting Crypto Strategies</td>
<td>~2.5h</td>
</tr>
<tr>
<td>7</td>
<td>Risk Management</td>
<td>~2.5h</td>
</tr>
<tr>
<td>8</td>
<td>Automation Fundamentals</td>
<td>~2.5h</td>
</tr>
</tbody>
</table></div>
<h3>Part 3: Exchange Integration</h3>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Module</th>
<th>Topic</th>
<th>Duration</th>
</tr>
</thead>
<tbody>
<tr>
<td>9</td>
<td>Exchange APIs Deep Dive</td>
<td>~2.5h</td>
</tr>
<tr>
<td>10</td>
<td>Order Execution</td>
<td>~2.5h</td>
</tr>
<tr>
<td>11</td>
<td>Live Trading</td>
<td>~2.5h</td>
</tr>
</tbody>
</table></div>
<h3>Part 4: DeFi &amp; Advanced Topics</h3>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Module</th>
<th>Topic</th>
<th>Duration</th>
</tr>
</thead>
<tbody>
<tr>
<td>12</td>
<td>DeFi Fundamentals</td>
<td>~2.5h</td>
</tr>
<tr>
<td>13</td>
<td>DEX Trading</td>
<td>~2.5h</td>
</tr>
<tr>
<td>14</td>
<td>Advanced DeFi Strategies</td>
<td>~2.5h</td>
</tr>
<tr>
<td>15</td>
<td>Advanced Crypto Topics</td>
<td>~2.5h</td>
</tr>
</tbody>
</table></div>
<h3>Capstone Project</h3>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Project</th>
<th>Description</th>
<th>Duration</th>
</tr>
</thead>
<tbody>
<tr>
<td>Final</td>
<td>Complete Crypto Trading System</td>
<td>~8-12h</td>
</tr>
</tbody>
</table></div></div>
<div class="md-cell"><hr />
<h2>ğŸ› ï¸ Setup Requirements</h2>
<h3>Required Libraries</h3>
<div class="highlight"><pre><span></span><code>pip install ccxt pandas numpy matplotlib plotly requests websocket-client python-dotenv schedule
</code></pre></div>

<h3>For DeFi Modules (Part 4)</h3>
<div class="highlight"><pre><span></span><code>pip install web3
</code></pre></div>

<h3>Exchange API Setup</h3>
<p>You'll need API keys from at least one exchange:
- <strong>Binance</strong> (recommended): binance.com
- <strong>Coinbase</strong>: coinbase.com
- <strong>Kraken</strong>: kraken.com</p>
<blockquote>
<p>âš ï¸ <strong>Security Note:</strong> Never share your API keys. Use read-only permissions when possible. Start with testnet/paper trading.</p>
</blockquote></div>
<div class="md-cell"><hr />
<h2>ğŸ“ How to Use This Course</h2>
<h3>Each Module Contains:</h3>
<ol>
<li><strong>ğŸ“– Narrative Explanations</strong> - Concepts explained with crypto context</li>
<li><strong>ğŸ’» Code Examples</strong> - Runnable code cells</li>
<li><strong>âœï¸ Exercises</strong> - Practice with collapsible solutions</li>
<li><strong>ğŸ—ï¸ Module Project</strong> - Comprehensive integration exercise</li>
</ol>
<h3>Exercise Format</h3>
<p>Each exercise has a <strong>collapsible solution</strong>. Try solving it yourself first, then click to reveal the solution if you're stuck.</p>
<h3>Recommended Approach</h3>
<ol>
<li>Read the explanations carefully</li>
<li>Run and modify code examples</li>
<li>Attempt exercises before viewing solutions</li>
<li>Complete the module project</li>
<li>Review key takeaways</li>
</ol></div>
<div class="md-cell"><hr />
<h2>âš ï¸ Risk Disclaimer</h2>
<p><strong>Cryptocurrency trading involves substantial risk of loss.</strong> This course is for educational purposes only.</p>
<ul>
<li>Never trade with money you can't afford to lose</li>
<li>Always start with paper trading / testnet</li>
<li>Past performance doesn't guarantee future results</li>
<li>The strategies taught are for learning, not financial advice</li>
</ul>
<hr />
<h2>Let's Begin!</h2>
<p>Start with <strong>Module 1: Cryptocurrency Fundamentals</strong> â†’</p></div>
        <div class="nav-buttons">
            <button class="nav-btn prev-btn disabled" type="button">
                <span class="nav-btn-label">â† Previous</span>
                <span class="nav-btn-name"></span>
            </button>
            <button class="nav-btn next-btn disabled" type="button">
                <span class="nav-btn-label">Next â†’</span>
                <span class="nav-btn-name"></span>
            </button>
        </div>
        </div>
<div class="module-section" data-idx="1"><div class="md-cell module-header"><h1>Module 1: Cryptocurrency Fundamentals</h1>
<h2>Part 1: Crypto Markets &amp; Data</h2>
<hr />
<div class="table-wrapper"><table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>â±ï¸ <strong>Duration</strong></td>
<td>~2.5 hours</td>
</tr>
<tr>
<td>ğŸ“‹ <strong>Prerequisites</strong></td>
<td>Python for Finance</td>
</tr>
<tr>
<td>ğŸ’ª <strong>Exercises</strong></td>
<td>5 total</td>
</tr>
</tbody>
</table></div></div>
<div class="md-cell"><h2>ğŸ¯ Learning Objectives</h2>
<ul>
<li>Understand CEX vs DEX exchanges</li>
<li>Read and analyze order books</li>
<li>Understand trading pairs and conventions</li>
<li>Differentiate spot from derivatives</li>
<li>Understand funding rates</li>
<li>Assess crypto-specific risks</li>
</ul></div>
<div class="md-cell"><hr />
<h1>Section 1: How Crypto Markets Work</h1>
<h2>1.1 Centralized vs Decentralized Exchanges</h2>
<h3>CEX (Binance, Coinbase, Kraken)</h3>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Feature</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Custody</strong></td>
<td>Exchange holds funds</td>
</tr>
<tr>
<td><strong>Speed</strong></td>
<td>Fast (milliseconds)</td>
</tr>
<tr>
<td><strong>Liquidity</strong></td>
<td>High</td>
</tr>
<tr>
<td><strong>KYC</strong></td>
<td>Required</td>
</tr>
</tbody>
</table></div>
<h3>DEX (Uniswap, dYdX)</h3>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Feature</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Custody</strong></td>
<td>Self-custody</td>
</tr>
<tr>
<td><strong>Speed</strong></td>
<td>Block time dependent</td>
</tr>
<tr>
<td><strong>Liquidity</strong></td>
<td>Varies</td>
</tr>
<tr>
<td><strong>KYC</strong></td>
<td>None</td>
</tr>
</tbody>
</table></div></div>
<div class="md-cell"><h2>1.2 Order Books</h2>
<div class="highlight"><pre><span></span><code>â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        BTC/USDT ORDER BOOK
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    ASKS (Sells)
    43,150  â”‚  2.5 BTC  â† Best Ask
    43,175  â”‚  1.2 BTC
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    SPREAD: $50 (0.12%)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    BIDS (Buys)
    43,100  â”‚  3.1 BTC  â† Best Bid
    43,075  â”‚  2.0 BTC
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
</code></pre></div>

<p><strong>Key Terms:</strong>
- <strong>Bid</strong>: Highest buy price
- <strong>Ask</strong>: Lowest sell price
- <strong>Spread</strong>: Ask - Bid</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="c1"># Order book analysis example</span>
<span class="n">order_book</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;bids&#39;</span><span class="p">:</span> <span class="p">[[</span><span class="mi">43100</span><span class="p">,</span> <span class="mf">3.1</span><span class="p">],</span> <span class="p">[</span><span class="mi">43075</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">],</span> <span class="p">[</span><span class="mi">43050</span><span class="p">,</span> <span class="mf">4.5</span><span class="p">]],</span>
    <span class="s1">&#39;asks&#39;</span><span class="p">:</span> <span class="p">[[</span><span class="mi">43150</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">],</span> <span class="p">[</span><span class="mi">43175</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">],</span> <span class="p">[</span><span class="mi">43200</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">]]</span>
<span class="p">}</span>

<span class="n">best_bid</span> <span class="o">=</span> <span class="n">order_book</span><span class="p">[</span><span class="s1">&#39;bids&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<span class="n">best_ask</span> <span class="o">=</span> <span class="n">order_book</span><span class="p">[</span><span class="s1">&#39;asks&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<span class="n">spread</span> <span class="o">=</span> <span class="n">best_ask</span> <span class="o">-</span> <span class="n">best_bid</span>
<span class="n">spread_pct</span> <span class="o">=</span> <span class="p">(</span><span class="n">spread</span> <span class="o">/</span> <span class="n">best_bid</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Best Bid: $</span><span class="si">{</span><span class="n">best_bid</span><span class="si">:</span><span class="s1">,</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Best Ask: $</span><span class="si">{</span><span class="n">best_ask</span><span class="si">:</span><span class="s1">,</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Spread: $</span><span class="si">{</span><span class="n">spread</span><span class="si">}</span><span class="s1"> (</span><span class="si">{</span><span class="n">spread_pct</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">%)&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h3>âœï¸ Exercise 1.1: Analyze Order Book</h3>
<p>Calculate spread, depth, and price impact for a $50,000 market buy.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="c1"># Exercise 1.1</span>
<span class="n">order_book</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;bids&#39;</span><span class="p">:</span> <span class="p">[[</span><span class="mi">2240</span><span class="p">,</span> <span class="mi">10</span><span class="p">],</span> <span class="p">[</span><span class="mi">2235</span><span class="p">,</span> <span class="mi">15</span><span class="p">],</span> <span class="p">[</span><span class="mi">2230</span><span class="p">,</span> <span class="mi">25</span><span class="p">]],</span>
    <span class="s1">&#39;asks&#39;</span><span class="p">:</span> <span class="p">[[</span><span class="mi">2245</span><span class="p">,</span> <span class="mi">8</span><span class="p">],</span> <span class="p">[</span><span class="mi">2250</span><span class="p">,</span> <span class="mi">12</span><span class="p">],</span> <span class="p">[</span><span class="mi">2260</span><span class="p">,</span> <span class="mi">20</span><span class="p">]]</span>
<span class="p">}</span>

<span class="c1"># Your solution:</span>
<span class="n">best_bid</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># TODO</span>
<span class="n">best_ask</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># TODO</span>
<span class="n">spread</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># TODO</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="n">best_bid</span> <span class="o">=</span> <span class="n">order_book</span><span class="p">[</span><span class="s1">&#39;bids&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># 2240</span>
<span class="n">best_ask</span> <span class="o">=</span> <span class="n">order_book</span><span class="p">[</span><span class="s1">&#39;asks&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># 2245</span>
<span class="n">spread</span> <span class="o">=</span> <span class="n">best_ask</span> <span class="o">-</span> <span class="n">best_bid</span>  <span class="c1"># 5</span>
<span class="n">spread_pct</span> <span class="o">=</span> <span class="p">(</span><span class="n">spread</span> <span class="o">/</span> <span class="n">best_bid</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>  <span class="c1"># 0.223%</span>

<span class="n">bid_depth</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">p</span> <span class="o">*</span> <span class="n">a</span> <span class="k">for</span> <span class="n">p</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">order_book</span><span class="p">[</span><span class="s1">&#39;bids&#39;</span><span class="p">])</span>
<span class="n">ask_depth</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">p</span> <span class="o">*</span> <span class="n">a</span> <span class="k">for</span> <span class="n">p</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">order_book</span><span class="p">[</span><span class="s1">&#39;asks&#39;</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Spread: $</span><span class="si">{</span><span class="n">spread</span><span class="si">}</span><span class="s1"> (</span><span class="si">{</span><span class="n">spread_pct</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">%)&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Bid Depth: $</span><span class="si">{</span><span class="n">bid_depth</span><span class="si">:</span><span class="s1">,</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Ask Depth: $</span><span class="si">{</span><span class="n">ask_depth</span><span class="si">:</span><span class="s1">,</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>Section 2: Market Structure</h1>
<h2>2.1 Spot vs Derivatives</h2>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Feature</th>
<th>Spot</th>
<th>Futures</th>
</tr>
</thead>
<tbody>
<tr>
<td>Ownership</td>
<td>Actual asset</td>
<td>Contract</td>
</tr>
<tr>
<td>Leverage</td>
<td>1x</td>
<td>Up to 125x</td>
</tr>
<tr>
<td>Expiration</td>
<td>None</td>
<td>Quarterly/Perpetual</td>
</tr>
</tbody>
</table></div>
<h2>2.2 Perpetual Futures &amp; Funding Rates</h2>
<p>Funding keeps perp prices aligned with spot:
- <strong>Positive funding</strong>: Longs pay shorts
- <strong>Negative funding</strong>: Shorts pay longs
- Paid every 8 hours</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="c1"># Funding rate calculation</span>
<span class="k">def</span> <span class="nf">calculate_funding_cost</span><span class="p">(</span><span class="n">position_size</span><span class="p">,</span> <span class="n">funding_rate</span><span class="p">,</span> <span class="n">periods_per_day</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
    <span class="n">daily</span> <span class="o">=</span> <span class="n">position_size</span> <span class="o">*</span> <span class="p">(</span><span class="n">funding_rate</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span> <span class="o">*</span> <span class="n">periods_per_day</span>
    <span class="n">annual</span> <span class="o">=</span> <span class="n">daily</span> <span class="o">*</span> <span class="mi">365</span>
    <span class="n">annual_rate</span> <span class="o">=</span> <span class="p">(</span><span class="n">funding_rate</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span> <span class="o">*</span> <span class="n">periods_per_day</span> <span class="o">*</span> <span class="mi">365</span> <span class="o">*</span> <span class="mi">100</span>
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;daily&#39;</span><span class="p">:</span> <span class="n">daily</span><span class="p">,</span> <span class="s1">&#39;annual&#39;</span><span class="p">:</span> <span class="n">annual</span><span class="p">,</span> <span class="s1">&#39;annual_rate&#39;</span><span class="p">:</span> <span class="n">annual_rate</span><span class="p">}</span>

<span class="n">costs</span> <span class="o">=</span> <span class="n">calculate_funding_cost</span><span class="p">(</span><span class="mi">100000</span><span class="p">,</span> <span class="mf">0.03</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Daily funding cost: $</span><span class="si">{</span><span class="n">costs</span><span class="p">[</span><span class="s2">&quot;daily&quot;</span><span class="p">]</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Annualized rate: </span><span class="si">{</span><span class="n">costs</span><span class="p">[</span><span class="s2">&quot;annual_rate&quot;</span><span class="p">]</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">%&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h3>âœï¸ Exercise 1.2: Exchange Volume Comparison</h3>
<p>Calculate market share for each exchange.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="c1"># Exercise 1.2</span>
<span class="n">exchanges</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;Binance&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;volume_24h&#39;</span><span class="p">:</span> <span class="mi">15_000_000_000</span><span class="p">},</span>
    <span class="s1">&#39;Coinbase&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;volume_24h&#39;</span><span class="p">:</span> <span class="mi">3_000_000_000</span><span class="p">},</span>
    <span class="s1">&#39;Kraken&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;volume_24h&#39;</span><span class="p">:</span> <span class="mi">1_500_000_000</span><span class="p">}</span>
<span class="p">}</span>

<span class="c1"># Your solution:</span>
<span class="n">total_volume</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># TODO</span>
<span class="n">market_shares</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># TODO</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="n">total_volume</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="s1">&#39;volume_24h&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">exchanges</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
<span class="n">market_shares</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">name</span><span class="p">:</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;volume_24h&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">total_volume</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">exchanges</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
<span class="p">}</span>
<span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">share</span> <span class="ow">in</span> <span class="n">market_shares</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">share</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">%&#39;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>Section 3: Crypto Risks</h1>
<h2>3.1 Exchange Risks</h2>
<ul>
<li><strong>Mt. Gox (2014)</strong>: $450M lost</li>
<li><strong>FTX (2022)</strong>: $8B lost</li>
</ul>
<h2>3.2 Risk Mitigation</h2>
<ol>
<li>Don't keep all funds on exchange</li>
<li>Diversify across exchanges</li>
<li>Use hardware wallets</li>
<li>Enable 2FA</li>
</ol></div>
<div class="md-cell"><h3>âœï¸ Exercise 1.3: Risk Assessment</h3>
<p>Create a function scoring exchange safety (0-100).</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="c1"># Exercise 1.3</span>
<span class="k">def</span> <span class="nf">assess_exchange_risk</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="n">score</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="c1"># TODO: Add scoring logic</span>
    <span class="k">return</span> <span class="n">score</span>

<span class="n">exchange</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;years_operating&#39;</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span>
    <span class="s1">&#39;has_proof_of_reserves&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
    <span class="s1">&#39;regulated&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
    <span class="s1">&#39;hack_history&#39;</span><span class="p">:</span> <span class="kc">True</span>
<span class="p">}</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">assess_exchange_risk</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="n">score</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">score</span> <span class="o">+=</span> <span class="nb">min</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;years_operating&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;has_proof_of_reserves&#39;</span><span class="p">]:</span> <span class="n">score</span> <span class="o">+=</span> <span class="mi">25</span>
    <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;regulated&#39;</span><span class="p">]:</span> <span class="n">score</span> <span class="o">+=</span> <span class="mi">25</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;hack_history&#39;</span><span class="p">]:</span> <span class="n">score</span> <span class="o">+=</span> <span class="mi">20</span>
    <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Risk Score: </span><span class="si">{</span><span class="n">assess_exchange_risk</span><span class="p">(</span><span class="n">exchange</span><span class="p">)</span><span class="si">}</span><span class="s1">/100&#39;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>Section 4: 24/7 Markets &amp; Volatility</h1>
<h2>Trading Sessions</h2>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Session</th>
<th>UTC</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td>Asia</td>
<td>00:00-08:00</td>
<td>High activity</td>
</tr>
<tr>
<td>Europe</td>
<td>07:00-16:00</td>
<td>Moderate</td>
</tr>
<tr>
<td>US</td>
<td>13:00-22:00</td>
<td>Most volatile</td>
</tr>
</tbody>
</table></div>
<h2>Volatility Comparison</h2>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Asset</th>
<th>Daily Range</th>
<th>Annual Vol</th>
</tr>
</thead>
<tbody>
<tr>
<td>S&amp;P 500</td>
<td>0.5-1%</td>
<td>~15-20%</td>
</tr>
<tr>
<td><strong>Bitcoin</strong></td>
<td>2-5%</td>
<td>~60-80%</td>
</tr>
<tr>
<td><strong>Altcoins</strong></td>
<td>5-15%</td>
<td>~100-200%</td>
</tr>
</tbody>
</table></div></div>
<div class="md-cell"><h3>âœï¸ Exercise 1.4: Volatility Analysis</h3>
<p>Calculate daily returns and rolling volatility.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="c1"># Exercise 1.4</span>
<span class="n">prices</span> <span class="o">=</span> <span class="p">[</span><span class="mi">42000</span><span class="p">,</span> <span class="mi">42500</span><span class="p">,</span> <span class="mi">41800</span><span class="p">,</span> <span class="mi">43200</span><span class="p">,</span> <span class="mi">44100</span><span class="p">,</span> <span class="mi">43500</span><span class="p">,</span> <span class="mi">42800</span><span class="p">]</span>

<span class="c1"># Your solution:</span>
<span class="n">daily_returns</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># TODO</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="n">daily_returns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">((</span><span class="n">prices</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">prices</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="n">prices</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="mi">100</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">prices</span><span class="p">))</span>
<span class="p">]</span>
<span class="n">avg_return</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">daily_returns</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">daily_returns</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Daily returns: </span><span class="si">{</span><span class="n">daily_returns</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Avg daily return: </span><span class="si">{</span><span class="n">avg_return</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">%&#39;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>ğŸ—ï¸ Module Project: Market Overview Dashboard</h1>
<p>Build a function displaying market metrics, funding analysis, and risk warnings.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="c1"># Module Project</span>
<span class="k">def</span> <span class="nf">market_overview</span><span class="p">(</span><span class="n">btc_price</span><span class="p">,</span> <span class="n">volume_24h</span><span class="p">,</span> <span class="n">funding_rate</span><span class="p">,</span> <span class="n">spread_pct</span><span class="p">):</span>
    <span class="c1"># TODO: Build comprehensive dashboard</span>
    <span class="k">pass</span>

<span class="n">market_overview</span><span class="p">(</span><span class="mi">43000</span><span class="p">,</span> <span class="mi">25_000_000_000</span><span class="p">,</span> <span class="mf">0.015</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">market_overview</span><span class="p">(</span><span class="n">btc_price</span><span class="p">,</span> <span class="n">volume_24h</span><span class="p">,</span> <span class="n">funding_rate</span><span class="p">,</span> <span class="n">spread_pct</span><span class="p">):</span>
    <span class="n">annual_funding</span> <span class="o">=</span> <span class="n">funding_rate</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">*</span> <span class="mi">365</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=&#39;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;       CRYPTO MARKET OVERVIEW&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=&#39;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;BTC Price: $</span><span class="si">{</span><span class="n">btc_price</span><span class="si">:</span><span class="s1">,</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;24h Volume: $</span><span class="si">{</span><span class="n">volume_24h</span><span class="o">/</span><span class="mf">1e9</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">B&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Spread: </span><span class="si">{</span><span class="n">spread_pct</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">%&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Funding (8h): </span><span class="si">{</span><span class="n">funding_rate</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">%&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Funding (Annual): </span><span class="si">{</span><span class="n">annual_funding</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">%&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">funding_rate</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.05</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;âš ï¸ Extreme funding - crowded trade&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=&#39;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>

<span class="n">market_overview</span><span class="p">(</span><span class="mi">43000</span><span class="p">,</span> <span class="mi">25_000_000_000</span><span class="p">,</span> <span class="mf">0.015</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>ğŸ“ Key Takeaways</h1>
<ol>
<li><strong>CEX vs DEX</strong>: Speed vs self-custody tradeoff</li>
<li><strong>Order Books</strong>: Spread indicates liquidity</li>
<li><strong>Funding Rates</strong>: Cost of holding perpetual positions</li>
<li><strong>Risks</strong>: Exchange failures, hacks, manipulation</li>
<li><strong>24/7 Markets</strong>: Higher volatility than traditional assets</li>
</ol>
<hr />
<p><em>Next: Module 2 - Crypto Data Sources</em></p></div>
        <div class="nav-buttons">
            <button class="nav-btn prev-btn disabled" type="button">
                <span class="nav-btn-label">â† Previous</span>
                <span class="nav-btn-name"></span>
            </button>
            <button class="nav-btn next-btn disabled" type="button">
                <span class="nav-btn-label">Next â†’</span>
                <span class="nav-btn-name"></span>
            </button>
        </div>
        </div>
<div class="module-section" data-idx="2"><div class="md-cell module-header"><h1>Module 2: Crypto Data Sources</h1>
<h2>Part 1: Crypto Markets &amp; Data</h2>
<hr />
<div class="table-wrapper"><table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>â±ï¸ <strong>Duration</strong></td>
<td>~2.5 hours</td>
</tr>
<tr>
<td>ğŸ“‹ <strong>Prerequisites</strong></td>
<td>Module 1</td>
</tr>
<tr>
<td>ğŸ’ª <strong>Exercises</strong></td>
<td>5 total</td>
</tr>
</tbody>
</table></div></div>
<div class="md-cell"><h2>ğŸ¯ Learning Objectives</h2>
<ul>
<li>Connect to exchanges using CCXT</li>
<li>Download historical OHLCV data</li>
<li>Set up WebSocket streams</li>
<li>Access alternative data sources</li>
</ul></div>
<div class="md-cell"><hr />
<h1>Section 1: Exchange APIs with CCXT</h1>
<p>CCXT is a unified library supporting 100+ exchanges.</p>
<div class="highlight"><pre><span></span><code>pip install ccxt
</code></pre></div></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="kn">import</span> <span class="nn">ccxt</span>

<span class="c1"># List available exchanges</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Supported exchanges: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">ccxt</span><span class="o">.</span><span class="n">exchanges</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">ccxt</span><span class="o">.</span><span class="n">exchanges</span><span class="p">[:</span><span class="mi">10</span><span class="p">])</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="c1"># Connect to Binance (public data, no API key needed)</span>
<span class="n">exchange</span> <span class="o">=</span> <span class="n">ccxt</span><span class="o">.</span><span class="n">binance</span><span class="p">()</span>

<span class="c1"># Fetch ticker</span>
<span class="n">ticker</span> <span class="o">=</span> <span class="n">exchange</span><span class="o">.</span><span class="n">fetch_ticker</span><span class="p">(</span><span class="s1">&#39;BTC/USDT&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;BTC Price: $</span><span class="si">{</span><span class="n">ticker</span><span class="p">[</span><span class="s1">&#39;last&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">,.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;24h Volume: $</span><span class="si">{</span><span class="n">ticker</span><span class="p">[</span><span class="s1">&#39;quoteVolume&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">,.0f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h3>âœï¸ Exercise 2.1: Connect to Exchange</h3>
<p>Fetch ETH/USDT ticker and display price, volume, and 24h change.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="c1"># Exercise 2.1</span>
<span class="c1"># Your solution:</span>
<span class="n">exchange</span> <span class="o">=</span> <span class="n">ccxt</span><span class="o">.</span><span class="n">binance</span><span class="p">()</span>
<span class="c1"># TODO: Fetch ETH/USDT ticker</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="n">exchange</span> <span class="o">=</span> <span class="n">ccxt</span><span class="o">.</span><span class="n">binance</span><span class="p">()</span>
<span class="n">ticker</span> <span class="o">=</span> <span class="n">exchange</span><span class="o">.</span><span class="n">fetch_ticker</span><span class="p">(</span><span class="s1">&#39;ETH/USDT&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ETH Price: $</span><span class="si">{</span><span class="n">ticker</span><span class="p">[</span><span class="s1">&#39;last&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">,.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;24h Volume: $</span><span class="si">{</span><span class="n">ticker</span><span class="p">[</span><span class="s1">&#39;quoteVolume&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">,.0f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;24h Change: </span><span class="si">{</span><span class="n">ticker</span><span class="p">[</span><span class="s1">&#39;percentage&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>Section 2: Historical OHLCV Data</h1>
<p>OHLCV = Open, High, Low, Close, Volume</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="c1"># Fetch OHLCV data</span>
<span class="n">exchange</span> <span class="o">=</span> <span class="n">ccxt</span><span class="o">.</span><span class="n">binance</span><span class="p">()</span>
<span class="n">ohlcv</span> <span class="o">=</span> <span class="n">exchange</span><span class="o">.</span><span class="n">fetch_ohlcv</span><span class="p">(</span><span class="s1">&#39;BTC/USDT&#39;</span><span class="p">,</span> <span class="s1">&#39;1h&#39;</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>

<span class="c1"># Convert to DataFrame</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">ohlcv</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">,</span> <span class="s1">&#39;open&#39;</span><span class="p">,</span> <span class="s1">&#39;high&#39;</span><span class="p">,</span> <span class="s1">&#39;low&#39;</span><span class="p">,</span> <span class="s1">&#39;close&#39;</span><span class="p">,</span> <span class="s1">&#39;volume&#39;</span><span class="p">])</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">],</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;ms&#39;</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;timestamp&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">tail</span><span class="p">())</span>
</code></pre></div>
<div class="md-cell"><h3>âœï¸ Exercise 2.2: Build Data Pipeline</h3>
<p>Create function to download data for multiple symbols and timeframes.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="c1"># Exercise 2.2</span>
<span class="k">def</span> <span class="nf">fetch_crypto_data</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">timeframe</span><span class="o">=</span><span class="s1">&#39;1h&#39;</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
    <span class="c1"># TODO: Return DataFrame with OHLCV data</span>
    <span class="k">pass</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">fetch_crypto_data</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">timeframe</span><span class="o">=</span><span class="s1">&#39;1h&#39;</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
    <span class="n">exchange</span> <span class="o">=</span> <span class="n">ccxt</span><span class="o">.</span><span class="n">binance</span><span class="p">()</span>
    <span class="n">ohlcv</span> <span class="o">=</span> <span class="n">exchange</span><span class="o">.</span><span class="n">fetch_ohlcv</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">timeframe</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">)</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">ohlcv</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">,</span> <span class="s1">&#39;open&#39;</span><span class="p">,</span> <span class="s1">&#39;high&#39;</span><span class="p">,</span> <span class="s1">&#39;low&#39;</span><span class="p">,</span> <span class="s1">&#39;close&#39;</span><span class="p">,</span> <span class="s1">&#39;volume&#39;</span><span class="p">])</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">],</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;ms&#39;</span><span class="p">)</span>
    <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;timestamp&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;symbol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">symbol</span>

    <span class="k">return</span> <span class="n">df</span>

<span class="n">btc</span> <span class="o">=</span> <span class="n">fetch_crypto_data</span><span class="p">(</span><span class="s1">&#39;BTC/USDT&#39;</span><span class="p">,</span> <span class="s1">&#39;4h&#39;</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">btc</span><span class="o">.</span><span class="n">head</span><span class="p">())</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>Section 3: Real-Time WebSocket Data</h1>
<p>WebSockets provide streaming data without polling.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="c1"># Conceptual WebSocket example</span>
<span class="c1"># Note: This requires websocket-client library</span>

<span class="kn">import</span> <span class="nn">json</span>

<span class="c1"># Binance WebSocket URL for BTC/USDT trades</span>
<span class="n">ws_url</span> <span class="o">=</span> <span class="s1">&#39;wss://stream.binance.com:9443/ws/btcusdt@trade&#39;</span>

<span class="k">def</span> <span class="nf">on_message</span><span class="p">(</span><span class="n">ws</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
    <span class="n">price</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">])</span>
    <span class="n">qty</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;q&#39;</span><span class="p">])</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Trade: </span><span class="si">{</span><span class="n">qty</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> BTC @ $</span><span class="si">{</span><span class="n">price</span><span class="si">:</span><span class="s2">,.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># In practice: websocket.WebSocketApp(ws_url, on_message=on_message)</span>
</code></pre></div>
<div class="md-cell"><h3>âœï¸ Exercise 2.3: Real-Time Price Monitor</h3>
<p>Create a price monitor class that tracks latest price and calculates moving average.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="c1"># Exercise 2.3</span>
<span class="k">class</span> <span class="nc">PriceMonitor</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="mi">20</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prices</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">window</span> <span class="o">=</span> <span class="n">window</span>
    
    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">price</span><span class="p">):</span>
        <span class="c1"># TODO: Add price and calculate moving average</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">get_ma</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># TODO: Return moving average</span>
        <span class="k">pass</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">PriceMonitor</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="mi">20</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prices</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">window</span> <span class="o">=</span> <span class="n">window</span>

    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">price</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">price</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">window</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_ma</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_latest</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prices</span> <span class="k">else</span> <span class="kc">None</span>

<span class="n">monitor</span> <span class="o">=</span> <span class="n">PriceMonitor</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">102</span><span class="p">,</span> <span class="mi">98</span><span class="p">,</span> <span class="mi">105</span><span class="p">,</span> <span class="mi">103</span><span class="p">,</span> <span class="mi">107</span><span class="p">]:</span>
    <span class="n">monitor</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Price: </span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s1">, MA: </span><span class="si">{</span><span class="n">monitor</span><span class="o">.</span><span class="n">get_ma</span><span class="p">()</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>Section 4: Alternative Data Sources</h1>
<h2>4.1 Fear &amp; Greed Index</h2></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="kn">import</span> <span class="nn">requests</span>

<span class="k">def</span> <span class="nf">get_fear_greed</span><span class="p">():</span>
    <span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;https://api.alternative.me/fng/&#39;</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]),</span>
        <span class="s1">&#39;classification&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;value_classification&#39;</span><span class="p">]</span>
    <span class="p">}</span>

<span class="n">fg</span> <span class="o">=</span> <span class="n">get_fear_greed</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Fear &amp; Greed: </span><span class="si">{</span><span class="n">fg</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">fg</span><span class="p">[</span><span class="s1">&#39;classification&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h3>âœï¸ Exercise 2.4: Multi-Source Data Fetcher</h3>
<p>Create function fetching price, volume, and fear/greed in one call.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="c1"># Exercise 2.4</span>
<span class="k">def</span> <span class="nf">get_market_snapshot</span><span class="p">(</span><span class="n">symbol</span><span class="o">=</span><span class="s1">&#39;BTC/USDT&#39;</span><span class="p">):</span>
    <span class="c1"># TODO: Return dict with price, volume, fear_greed</span>
    <span class="k">pass</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">get_market_snapshot</span><span class="p">(</span><span class="n">symbol</span><span class="o">=</span><span class="s1">&#39;BTC/USDT&#39;</span><span class="p">):</span>
    <span class="c1"># Price data</span>
    <span class="n">exchange</span> <span class="o">=</span> <span class="n">ccxt</span><span class="o">.</span><span class="n">binance</span><span class="p">()</span>
    <span class="n">ticker</span> <span class="o">=</span> <span class="n">exchange</span><span class="o">.</span><span class="n">fetch_ticker</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>

    <span class="c1"># Fear &amp; Greed</span>
    <span class="n">fg</span> <span class="o">=</span> <span class="n">get_fear_greed</span><span class="p">()</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span>
        <span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="n">ticker</span><span class="p">[</span><span class="s1">&#39;last&#39;</span><span class="p">],</span>
        <span class="s1">&#39;volume_24h&#39;</span><span class="p">:</span> <span class="n">ticker</span><span class="p">[</span><span class="s1">&#39;quoteVolume&#39;</span><span class="p">],</span>
        <span class="s1">&#39;change_24h&#39;</span><span class="p">:</span> <span class="n">ticker</span><span class="p">[</span><span class="s1">&#39;percentage&#39;</span><span class="p">],</span>
        <span class="s1">&#39;fear_greed&#39;</span><span class="p">:</span> <span class="n">fg</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">],</span>
        <span class="s1">&#39;sentiment&#39;</span><span class="p">:</span> <span class="n">fg</span><span class="p">[</span><span class="s1">&#39;classification&#39;</span><span class="p">]</span>
    <span class="p">}</span>

<span class="n">snapshot</span> <span class="o">=</span> <span class="n">get_market_snapshot</span><span class="p">()</span>
<span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">snapshot</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>ğŸ—ï¸ Module Project: Comprehensive Data System</h1>
<p>Build a data system that fetches OHLCV, calculates returns, and includes sentiment.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="c1"># Module Project</span>
<span class="k">class</span> <span class="nc">CryptoDataSystem</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exchange_id</span><span class="o">=</span><span class="s1">&#39;binance&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span> <span class="o">=</span> <span class="n">ccxt</span><span class="o">.</span><span class="n">binance</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">get_ohlcv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">timeframe</span><span class="o">=</span><span class="s1">&#39;1h&#39;</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
        <span class="c1"># TODO</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">get_multiple_symbols</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbols</span><span class="p">,</span> <span class="n">timeframe</span><span class="o">=</span><span class="s1">&#39;1h&#39;</span><span class="p">):</span>
        <span class="c1"># TODO</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">generate_report</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">):</span>
        <span class="c1"># TODO</span>
        <span class="k">pass</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">CryptoDataSystem</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exchange_id</span><span class="o">=</span><span class="s1">&#39;binance&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">ccxt</span><span class="p">,</span> <span class="n">exchange_id</span><span class="p">)()</span>

    <span class="k">def</span> <span class="nf">get_ohlcv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">timeframe</span><span class="o">=</span><span class="s1">&#39;1h&#39;</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
        <span class="n">ohlcv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="o">.</span><span class="n">fetch_ohlcv</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">timeframe</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">ohlcv</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">,</span> <span class="s1">&#39;open&#39;</span><span class="p">,</span> <span class="s1">&#39;high&#39;</span><span class="p">,</span> <span class="s1">&#39;low&#39;</span><span class="p">,</span> <span class="s1">&#39;close&#39;</span><span class="p">,</span> <span class="s1">&#39;volume&#39;</span><span class="p">])</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">],</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;ms&#39;</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;timestamp&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;returns&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span> <span class="o">*</span> <span class="mi">100</span>
        <span class="k">return</span> <span class="n">df</span>

    <span class="k">def</span> <span class="nf">get_multiple_symbols</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbols</span><span class="p">,</span> <span class="n">timeframe</span><span class="o">=</span><span class="s1">&#39;1h&#39;</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="n">symbols</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ohlcv</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">timeframe</span><span class="p">,</span> <span class="n">limit</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data</span>

    <span class="k">def</span> <span class="nf">generate_report</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">):</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ohlcv</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
        <span class="n">ticker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="o">.</span><span class="n">fetch_ticker</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;=== </span><span class="si">{</span><span class="n">symbol</span><span class="si">}</span><span class="s1"> Report ===&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Price: $</span><span class="si">{</span><span class="n">ticker</span><span class="p">[</span><span class="s1">&#39;last&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">,.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;24h Change: </span><span class="si">{</span><span class="n">ticker</span><span class="p">[</span><span class="s1">&#39;percentage&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Avg Return: </span><span class="si">{</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;returns&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Volatility: </span><span class="si">{</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;returns&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>

<span class="n">system</span> <span class="o">=</span> <span class="n">CryptoDataSystem</span><span class="p">()</span>
<span class="n">system</span><span class="o">.</span><span class="n">generate_report</span><span class="p">(</span><span class="s1">&#39;BTC/USDT&#39;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>ğŸ“ Key Takeaways</h1>
<ol>
<li><strong>CCXT</strong>: Unified API for 100+ exchanges</li>
<li><strong>OHLCV</strong>: Standard format for price data</li>
<li><strong>WebSockets</strong>: Real-time streaming data</li>
<li><strong>Alternative Data</strong>: Fear/Greed, social metrics enhance analysis</li>
</ol>
<hr />
<p><em>Next: Module 3 - Technical Analysis</em></p></div>
        <div class="nav-buttons">
            <button class="nav-btn prev-btn disabled" type="button">
                <span class="nav-btn-label">â† Previous</span>
                <span class="nav-btn-name"></span>
            </button>
            <button class="nav-btn next-btn disabled" type="button">
                <span class="nav-btn-label">Next â†’</span>
                <span class="nav-btn-name"></span>
            </button>
        </div>
        </div>
<div class="module-section" data-idx="3"><div class="md-cell module-header"><h1>Module 3: Crypto Technical Analysis</h1>
<h2>Part 1: Crypto Markets &amp; Data</h2>
<hr />
<div class="table-wrapper"><table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>â±ï¸ <strong>Duration</strong></td>
<td>~2.5 hours</td>
</tr>
<tr>
<td>ğŸ“‹ <strong>Prerequisites</strong></td>
<td>Modules 1-2</td>
</tr>
<tr>
<td>ğŸ’ª <strong>Exercises</strong></td>
<td>5 total</td>
</tr>
</tbody>
</table></div></div>
<div class="md-cell"><h2>ğŸ¯ Learning Objectives</h2>
<ul>
<li>Identify chart patterns in crypto</li>
<li>Implement technical indicators from scratch</li>
<li>Analyze volume for whale activity</li>
<li>Build multi-timeframe analysis</li>
</ul></div>
<div class="md-cell"><hr />
<h1>Section 1: Chart Patterns</h1>
<h2>Support &amp; Resistance</h2>
<ul>
<li><strong>Support</strong>: Price level where buying pressure prevents further decline</li>
<li><strong>Resistance</strong>: Price level where selling pressure prevents further rise</li>
</ul>
<div class="highlight"><pre><span></span><code>Price
â”‚
â”‚     â•±â•²      â•±â•²
â”‚â”€â”€â”€â”€â•±â”€â”€â•²â”€â”€â”€â”€â•±â”€â”€â•²â”€â”€â”€â”€ Resistance
â”‚   â•±    â•²  â•±    â•²
â”‚â”€â”€â•±â”€â”€â”€â”€â”€â”€â•²â•±â”€â”€â”€â”€â”€â”€â•²â”€â”€ Support
â”‚ â•±
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º Time
</code></pre></div></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="k">def</span> <span class="nf">find_support_resistance</span><span class="p">(</span><span class="n">prices</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="mi">20</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Find support/resistance levels using rolling min/max.&quot;&quot;&quot;</span>
    <span class="n">support</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">resistance</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">support</span><span class="p">,</span> <span class="n">resistance</span>

<span class="n">prices</span> <span class="o">=</span> <span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">102</span><span class="p">,</span> <span class="mi">98</span><span class="p">,</span> <span class="mi">105</span><span class="p">,</span> <span class="mi">103</span><span class="p">,</span> <span class="mi">95</span><span class="p">,</span> <span class="mi">108</span><span class="p">,</span> <span class="mi">102</span><span class="p">,</span> <span class="mi">99</span><span class="p">,</span> <span class="mi">106</span><span class="p">]</span>
<span class="n">support</span><span class="p">,</span> <span class="n">resistance</span> <span class="o">=</span> <span class="n">find_support_resistance</span><span class="p">(</span><span class="n">prices</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Support: </span><span class="si">{</span><span class="n">support</span><span class="si">}</span><span class="s1">, Resistance: </span><span class="si">{</span><span class="n">resistance</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><hr />
<h1>Section 2: Technical Indicators</h1>
<h2>2.1 Moving Averages</h2></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="k">def</span> <span class="nf">sma</span><span class="p">(</span><span class="n">prices</span><span class="p">,</span> <span class="n">period</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Simple Moving Average&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">period</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">ema</span><span class="p">(</span><span class="n">prices</span><span class="p">,</span> <span class="n">period</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Exponential Moving Average&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span><span class="o">.</span><span class="n">ewm</span><span class="p">(</span><span class="n">span</span><span class="o">=</span><span class="n">period</span><span class="p">,</span> <span class="n">adjust</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

<span class="n">prices</span> <span class="o">=</span> <span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">102</span><span class="p">,</span> <span class="mi">104</span><span class="p">,</span> <span class="mi">103</span><span class="p">,</span> <span class="mi">105</span><span class="p">,</span> <span class="mi">107</span><span class="p">,</span> <span class="mi">106</span><span class="p">,</span> <span class="mi">108</span><span class="p">,</span> <span class="mi">110</span><span class="p">,</span> <span class="mi">109</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;SMA(5):&#39;</span><span class="p">,</span> <span class="n">sma</span><span class="p">(</span><span class="n">prices</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;EMA(5):&#39;</span><span class="p">,</span> <span class="n">ema</span><span class="p">(</span><span class="n">prices</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
</code></pre></div>
<div class="md-cell"><h2>2.2 RSI (Relative Strength Index)</h2></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="k">def</span> <span class="nf">rsi</span><span class="p">(</span><span class="n">prices</span><span class="p">,</span> <span class="n">period</span><span class="o">=</span><span class="mi">14</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Calculate RSI&quot;&quot;&quot;</span>
    <span class="n">prices</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span>
    <span class="n">delta</span> <span class="o">=</span> <span class="n">prices</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span>
    
    <span class="n">gain</span> <span class="o">=</span> <span class="n">delta</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">delta</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">delta</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">delta</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    
    <span class="n">avg_gain</span> <span class="o">=</span> <span class="n">gain</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">period</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">avg_loss</span> <span class="o">=</span> <span class="n">loss</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">period</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    
    <span class="n">rs</span> <span class="o">=</span> <span class="n">avg_gain</span> <span class="o">/</span> <span class="n">avg_loss</span>
    <span class="k">return</span> <span class="mi">100</span> <span class="o">-</span> <span class="p">(</span><span class="mi">100</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">rs</span><span class="p">))</span>

<span class="c1"># RSI interpretation:</span>
<span class="c1"># &gt; 70: Overbought</span>
<span class="c1"># &lt; 30: Oversold</span>
</code></pre></div>
<div class="md-cell"><h2>2.3 MACD</h2></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="k">def</span> <span class="nf">macd</span><span class="p">(</span><span class="n">prices</span><span class="p">,</span> <span class="n">fast</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">slow</span><span class="o">=</span><span class="mi">26</span><span class="p">,</span> <span class="n">signal</span><span class="o">=</span><span class="mi">9</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Calculate MACD&quot;&quot;&quot;</span>
    <span class="n">prices</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span>
    <span class="n">ema_fast</span> <span class="o">=</span> <span class="n">prices</span><span class="o">.</span><span class="n">ewm</span><span class="p">(</span><span class="n">span</span><span class="o">=</span><span class="n">fast</span><span class="p">,</span> <span class="n">adjust</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">ema_slow</span> <span class="o">=</span> <span class="n">prices</span><span class="o">.</span><span class="n">ewm</span><span class="p">(</span><span class="n">span</span><span class="o">=</span><span class="n">slow</span><span class="p">,</span> <span class="n">adjust</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    
    <span class="n">macd_line</span> <span class="o">=</span> <span class="n">ema_fast</span> <span class="o">-</span> <span class="n">ema_slow</span>
    <span class="n">signal_line</span> <span class="o">=</span> <span class="n">macd_line</span><span class="o">.</span><span class="n">ewm</span><span class="p">(</span><span class="n">span</span><span class="o">=</span><span class="n">signal</span><span class="p">,</span> <span class="n">adjust</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">histogram</span> <span class="o">=</span> <span class="n">macd_line</span> <span class="o">-</span> <span class="n">signal_line</span>
    
    <span class="k">return</span> <span class="n">macd_line</span><span class="p">,</span> <span class="n">signal_line</span><span class="p">,</span> <span class="n">histogram</span>
</code></pre></div>
<div class="md-cell"><h3>âœï¸ Exercise 3.1: Build Indicator Library</h3>
<p>Create a class containing all indicators.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="c1"># Exercise 3.1</span>
<span class="k">class</span> <span class="nc">TechnicalIndicators</span><span class="p">:</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">sma</span><span class="p">(</span><span class="n">prices</span><span class="p">,</span> <span class="n">period</span><span class="p">):</span>
        <span class="c1"># TODO</span>
        <span class="k">pass</span>
    
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">ema</span><span class="p">(</span><span class="n">prices</span><span class="p">,</span> <span class="n">period</span><span class="p">):</span>
        <span class="c1"># TODO</span>
        <span class="k">pass</span>
    
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">rsi</span><span class="p">(</span><span class="n">prices</span><span class="p">,</span> <span class="n">period</span><span class="o">=</span><span class="mi">14</span><span class="p">):</span>
        <span class="c1"># TODO</span>
        <span class="k">pass</span>
    
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">bollinger_bands</span><span class="p">(</span><span class="n">prices</span><span class="p">,</span> <span class="n">period</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">std_dev</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
        <span class="c1"># TODO</span>
        <span class="k">pass</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">TechnicalIndicators</span><span class="p">:</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">sma</span><span class="p">(</span><span class="n">prices</span><span class="p">,</span> <span class="n">period</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">period</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">ema</span><span class="p">(</span><span class="n">prices</span><span class="p">,</span> <span class="n">period</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span><span class="o">.</span><span class="n">ewm</span><span class="p">(</span><span class="n">span</span><span class="o">=</span><span class="n">period</span><span class="p">,</span> <span class="n">adjust</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">rsi</span><span class="p">(</span><span class="n">prices</span><span class="p">,</span> <span class="n">period</span><span class="o">=</span><span class="mi">14</span><span class="p">):</span>
        <span class="n">prices</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="n">prices</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span>
        <span class="n">gain</span> <span class="o">=</span> <span class="n">delta</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">delta</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">delta</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">delta</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">avg_gain</span> <span class="o">=</span> <span class="n">gain</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">period</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">avg_loss</span> <span class="o">=</span> <span class="n">loss</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">period</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">rs</span> <span class="o">=</span> <span class="n">avg_gain</span> <span class="o">/</span> <span class="n">avg_loss</span>
        <span class="k">return</span> <span class="mi">100</span> <span class="o">-</span> <span class="p">(</span><span class="mi">100</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">rs</span><span class="p">))</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">bollinger_bands</span><span class="p">(</span><span class="n">prices</span><span class="p">,</span> <span class="n">period</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">std_dev</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
        <span class="n">prices</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span>
        <span class="n">sma</span> <span class="o">=</span> <span class="n">prices</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">period</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">std</span> <span class="o">=</span> <span class="n">prices</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">period</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
        <span class="n">upper</span> <span class="o">=</span> <span class="n">sma</span> <span class="o">+</span> <span class="p">(</span><span class="n">std</span> <span class="o">*</span> <span class="n">std_dev</span><span class="p">)</span>
        <span class="n">lower</span> <span class="o">=</span> <span class="n">sma</span> <span class="o">-</span> <span class="p">(</span><span class="n">std</span> <span class="o">*</span> <span class="n">std_dev</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">upper</span><span class="p">,</span> <span class="n">sma</span><span class="p">,</span> <span class="n">lower</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>Section 3: Volume Analysis</h1>
<p>Volume confirms price moves:
- <strong>High volume + price up</strong> = Strong bullish
- <strong>Low volume + price up</strong> = Weak, possible reversal</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="k">def</span> <span class="nf">volume_profile</span><span class="p">(</span><span class="n">prices</span><span class="p">,</span> <span class="n">volumes</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Calculate volume at price levels.&quot;&quot;&quot;</span>
    <span class="n">price_min</span><span class="p">,</span> <span class="n">price_max</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">prices</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span>
    <span class="n">bin_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">price_max</span> <span class="o">-</span> <span class="n">price_min</span><span class="p">)</span> <span class="o">/</span> <span class="n">bins</span>
    
    <span class="n">profile</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">price</span><span class="p">,</span> <span class="n">vol</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">prices</span><span class="p">,</span> <span class="n">volumes</span><span class="p">):</span>
        <span class="n">bin_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">price</span> <span class="o">-</span> <span class="n">price_min</span><span class="p">)</span> <span class="o">/</span> <span class="n">bin_size</span><span class="p">)</span>
        <span class="n">bin_idx</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">bin_idx</span><span class="p">,</span> <span class="n">bins</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">level</span> <span class="o">=</span> <span class="n">price_min</span> <span class="o">+</span> <span class="p">(</span><span class="n">bin_idx</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">*</span> <span class="n">bin_size</span>
        <span class="n">profile</span><span class="p">[</span><span class="n">level</span><span class="p">]</span> <span class="o">=</span> <span class="n">profile</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">level</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">vol</span>
    
    <span class="k">return</span> <span class="n">profile</span>
</code></pre></div>
<div class="md-cell"><h3>âœï¸ Exercise 3.2: Whale Detection</h3>
<p>Detect unusually large volume spikes (potential whale activity).</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="c1"># Exercise 3.2</span>
<span class="k">def</span> <span class="nf">detect_whale_activity</span><span class="p">(</span><span class="n">volumes</span><span class="p">,</span> <span class="n">threshold_std</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return indices of whale activity (volume &gt; threshold_std standard deviations).&quot;&quot;&quot;</span>
    <span class="c1"># TODO</span>
    <span class="k">pass</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">detect_whale_activity</span><span class="p">(</span><span class="n">volumes</span><span class="p">,</span> <span class="n">threshold_std</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
    <span class="n">volumes</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">volumes</span><span class="p">)</span>
    <span class="n">mean_vol</span> <span class="o">=</span> <span class="n">volumes</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">std_vol</span> <span class="o">=</span> <span class="n">volumes</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
    <span class="n">threshold</span> <span class="o">=</span> <span class="n">mean_vol</span> <span class="o">+</span> <span class="p">(</span><span class="n">threshold_std</span> <span class="o">*</span> <span class="n">std_vol</span><span class="p">)</span>

    <span class="n">whale_indices</span> <span class="o">=</span> <span class="n">volumes</span><span class="p">[</span><span class="n">volumes</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">whale_indices</span><span class="p">,</span> <span class="n">threshold</span>

<span class="n">volumes</span> <span class="o">=</span> <span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="mi">110</span><span class="p">,</span> <span class="mi">95</span><span class="p">,</span> <span class="mi">800</span><span class="p">,</span> <span class="mi">105</span><span class="p">]</span>
<span class="n">whales</span><span class="p">,</span> <span class="n">thresh</span> <span class="o">=</span> <span class="n">detect_whale_activity</span><span class="p">(</span><span class="n">volumes</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Whale activity at indices: </span><span class="si">{</span><span class="n">whales</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Threshold: </span><span class="si">{</span><span class="n">thresh</span><span class="si">:</span><span class="s1">.0f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>Section 4: Multi-Timeframe Analysis</h1>
<p>Use higher timeframes for trend, lower for entry.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="k">def</span> <span class="nf">multi_timeframe_signal</span><span class="p">(</span><span class="n">daily_trend</span><span class="p">,</span> <span class="n">h4_trend</span><span class="p">,</span> <span class="n">h1_signal</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Combine multiple timeframe analysis.</span>
<span class="sd">    </span>
<span class="sd">    Returns: &#39;BUY&#39;, &#39;SELL&#39;, or &#39;NEUTRAL&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">daily_trend</span> <span class="o">==</span> <span class="s1">&#39;UP&#39;</span> <span class="ow">and</span> <span class="n">h4_trend</span> <span class="o">==</span> <span class="s1">&#39;UP&#39;</span> <span class="ow">and</span> <span class="n">h1_signal</span> <span class="o">==</span> <span class="s1">&#39;BUY&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;STRONG_BUY&#39;</span>
    <span class="k">elif</span> <span class="n">daily_trend</span> <span class="o">==</span> <span class="s1">&#39;DOWN&#39;</span> <span class="ow">and</span> <span class="n">h4_trend</span> <span class="o">==</span> <span class="s1">&#39;DOWN&#39;</span> <span class="ow">and</span> <span class="n">h1_signal</span> <span class="o">==</span> <span class="s1">&#39;SELL&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;STRONG_SELL&#39;</span>
    <span class="k">elif</span> <span class="n">daily_trend</span> <span class="o">==</span> <span class="n">h4_trend</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">h1_signal</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;NEUTRAL&#39;</span>

<span class="n">signal</span> <span class="o">=</span> <span class="n">multi_timeframe_signal</span><span class="p">(</span><span class="s1">&#39;UP&#39;</span><span class="p">,</span> <span class="s1">&#39;UP&#39;</span><span class="p">,</span> <span class="s1">&#39;BUY&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Signal: </span><span class="si">{</span><span class="n">signal</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h3>âœï¸ Exercise 3.3: MTF Strategy</h3>
<p>Build a complete multi-timeframe strategy function.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="c1"># Exercise 3.3</span>
<span class="k">def</span> <span class="nf">analyze_mtf</span><span class="p">(</span><span class="n">prices_daily</span><span class="p">,</span> <span class="n">prices_4h</span><span class="p">,</span> <span class="n">prices_1h</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Perform multi-timeframe analysis.</span>
<span class="sd">    </span>
<span class="sd">    Returns dict with trend for each timeframe and final signal.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO</span>
    <span class="k">pass</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">get_trend</span><span class="p">(</span><span class="n">prices</span><span class="p">):</span>
    <span class="n">sma_short</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">sma_long</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="s1">&#39;UP&#39;</span> <span class="k">if</span> <span class="n">sma_short</span> <span class="o">&gt;</span> <span class="n">sma_long</span> <span class="k">else</span> <span class="s1">&#39;DOWN&#39;</span>

<span class="k">def</span> <span class="nf">analyze_mtf</span><span class="p">(</span><span class="n">prices_daily</span><span class="p">,</span> <span class="n">prices_4h</span><span class="p">,</span> <span class="n">prices_1h</span><span class="p">):</span>
    <span class="n">daily_trend</span> <span class="o">=</span> <span class="n">get_trend</span><span class="p">(</span><span class="n">prices_daily</span><span class="p">)</span>
    <span class="n">h4_trend</span> <span class="o">=</span> <span class="n">get_trend</span><span class="p">(</span><span class="n">prices_4h</span><span class="p">)</span>
    <span class="n">h1_trend</span> <span class="o">=</span> <span class="n">get_trend</span><span class="p">(</span><span class="n">prices_1h</span><span class="p">)</span>

    <span class="c1"># Entry signal from 1h</span>
    <span class="n">rsi_val</span> <span class="o">=</span> <span class="n">TechnicalIndicators</span><span class="o">.</span><span class="n">rsi</span><span class="p">(</span><span class="n">prices_1h</span><span class="p">)</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">rsi_val</span> <span class="o">&lt;</span> <span class="mi">30</span><span class="p">:</span>
        <span class="n">h1_signal</span> <span class="o">=</span> <span class="s1">&#39;BUY&#39;</span>
    <span class="k">elif</span> <span class="n">rsi_val</span> <span class="o">&gt;</span> <span class="mi">70</span><span class="p">:</span>
        <span class="n">h1_signal</span> <span class="o">=</span> <span class="s1">&#39;SELL&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">h1_signal</span> <span class="o">=</span> <span class="s1">&#39;NEUTRAL&#39;</span>

    <span class="n">final</span> <span class="o">=</span> <span class="n">multi_timeframe_signal</span><span class="p">(</span><span class="n">daily_trend</span><span class="p">,</span> <span class="n">h4_trend</span><span class="p">,</span> <span class="n">h1_signal</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;daily&#39;</span><span class="p">:</span> <span class="n">daily_trend</span><span class="p">,</span>
        <span class="s1">&#39;4h&#39;</span><span class="p">:</span> <span class="n">h4_trend</span><span class="p">,</span>
        <span class="s1">&#39;1h&#39;</span><span class="p">:</span> <span class="n">h1_trend</span><span class="p">,</span>
        <span class="s1">&#39;rsi&#39;</span><span class="p">:</span> <span class="n">rsi_val</span><span class="p">,</span>
        <span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="n">final</span>
    <span class="p">}</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>ğŸ—ï¸ Module Project: Technical Analysis Toolkit</h1>
<p>Build a complete TA toolkit class.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="c1"># Module Project</span>
<span class="k">class</span> <span class="nc">TechnicalAnalysisToolkit</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prices</span><span class="p">,</span> <span class="n">volumes</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prices</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">volumes</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">volumes</span><span class="p">)</span> <span class="k">if</span> <span class="n">volumes</span> <span class="k">else</span> <span class="kc">None</span>
    
    <span class="k">def</span> <span class="nf">add_indicators</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># TODO: Add all indicators to a DataFrame</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">generate_signals</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># TODO: Generate buy/sell signals</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">summary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># TODO: Print analysis summary</span>
        <span class="k">pass</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">TechnicalAnalysisToolkit</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prices</span><span class="p">,</span> <span class="n">volumes</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prices</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">volumes</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">volumes</span><span class="p">)</span> <span class="k">if</span> <span class="n">volumes</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;close&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="p">})</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">volumes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;volume&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">volumes</span>

    <span class="k">def</span> <span class="nf">add_indicators</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;sma_20&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;sma_50&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;rsi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">TechnicalIndicators</span><span class="o">.</span><span class="n">rsi</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="p">)</span>
        <span class="n">upper</span><span class="p">,</span> <span class="n">mid</span><span class="p">,</span> <span class="n">lower</span> <span class="o">=</span> <span class="n">TechnicalIndicators</span><span class="o">.</span><span class="n">bollinger_bands</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;bb_upper&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">upper</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;bb_lower&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lower</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span>

    <span class="k">def</span> <span class="nf">generate_signals</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">signals</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">rsi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;rsi&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">price</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">sma_20</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;sma_20&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">rsi</span> <span class="o">&lt;</span> <span class="mi">30</span> <span class="ow">and</span> <span class="n">price</span> <span class="o">&gt;</span> <span class="n">sma_20</span><span class="p">:</span>
            <span class="n">signals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;RSI Oversold + Above SMA = BUY&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">rsi</span> <span class="o">&gt;</span> <span class="mi">70</span> <span class="ow">and</span> <span class="n">price</span> <span class="o">&lt;</span> <span class="n">sma_20</span><span class="p">:</span>
            <span class="n">signals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;RSI Overbought + Below SMA = SELL&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">signals</span>

    <span class="k">def</span> <span class="nf">summary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=== Technical Analysis Summary ===&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Price: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;RSI: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;rsi&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SMA(20): </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;sma_20&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Signals: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">generate_signals</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>ğŸ“ Key Takeaways</h1>
<ol>
<li><strong>Support/Resistance</strong>: Key price levels for entries/exits</li>
<li><strong>Moving Averages</strong>: Trend identification</li>
<li><strong>RSI</strong>: Overbought (&gt;70) / Oversold (&lt;30)</li>
<li><strong>Volume</strong>: Confirms price moves</li>
<li><strong>MTF</strong>: Higher TF for trend, lower for entry</li>
</ol>
<hr />
<p><em>Next: Module 4 - On-Chain Analytics</em></p></div>
        <div class="nav-buttons">
            <button class="nav-btn prev-btn disabled" type="button">
                <span class="nav-btn-label">â† Previous</span>
                <span class="nav-btn-name"></span>
            </button>
            <button class="nav-btn next-btn disabled" type="button">
                <span class="nav-btn-label">Next â†’</span>
                <span class="nav-btn-name"></span>
            </button>
        </div>
        </div>
<div class="module-section" data-idx="4"><div class="md-cell module-header"><h1>Module 4: On-Chain Analytics</h1>
<h2>Part 1: Crypto Markets &amp; Data</h2>
<hr />
<div class="table-wrapper"><table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>â±ï¸ <strong>Duration</strong></td>
<td>~2.5 hours</td>
</tr>
<tr>
<td>ğŸ“‹ <strong>Prerequisites</strong></td>
<td>Modules 1-3</td>
</tr>
<tr>
<td>ğŸ’ª <strong>Exercises</strong></td>
<td>5 total</td>
</tr>
</tbody>
</table></div></div>
<div class="md-cell"><h2>ğŸ¯ Learning Objectives</h2>
<ul>
<li>Understand on-chain analysis fundamentals</li>
<li>Track key metrics (active addresses, exchange flows)</li>
<li>Monitor whale activity</li>
<li>Analyze network health</li>
</ul></div>
<div class="md-cell"><hr />
<h1>Section 1: Introduction to On-Chain Data</h1>
<h2>What is On-Chain Analysis?</h2>
<p>On-chain data comes directly from the blockchain:
- <strong>Transactions</strong>: Every transfer recorded
- <strong>Addresses</strong>: Wallet activity visible
- <strong>Balances</strong>: Holdings are public</p>
<p>This gives unique insight unavailable in traditional markets.</p></div>
<div class="md-cell"><h2>Data Providers</h2>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Provider</th>
<th>Free Tier</th>
<th>Best For</th>
</tr>
</thead>
<tbody>
<tr>
<td>Glassnode</td>
<td>Limited</td>
<td>Professional metrics</td>
</tr>
<tr>
<td>CryptoQuant</td>
<td>Yes</td>
<td>Exchange flows</td>
</tr>
<tr>
<td>Blockchain.com</td>
<td>Yes</td>
<td>Basic BTC data</td>
</tr>
<tr>
<td>Etherscan</td>
<td>Yes</td>
<td>ETH transactions</td>
</tr>
</tbody>
</table></div></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="c1"># Simulated on-chain data structure</span>
<span class="n">onchain_data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;active_addresses&#39;</span><span class="p">:</span> <span class="mi">950000</span><span class="p">,</span>
    <span class="s1">&#39;transaction_count&#39;</span><span class="p">:</span> <span class="mi">320000</span><span class="p">,</span>
    <span class="s1">&#39;exchange_inflow&#39;</span><span class="p">:</span> <span class="mi">15000</span><span class="p">,</span>  <span class="c1"># BTC</span>
    <span class="s1">&#39;exchange_outflow&#39;</span><span class="p">:</span> <span class="mi">18000</span><span class="p">,</span>  <span class="c1"># BTC</span>
    <span class="s1">&#39;total_exchange_balance&#39;</span><span class="p">:</span> <span class="mi">2_400_000</span><span class="p">,</span>  <span class="c1"># BTC</span>
    <span class="s1">&#39;hash_rate&#39;</span><span class="p">:</span> <span class="mi">450_000_000</span><span class="p">,</span>  <span class="c1"># TH/s</span>
<span class="p">}</span>

<span class="c1"># Net flow (negative = outflow, bullish)</span>
<span class="n">net_flow</span> <span class="o">=</span> <span class="n">onchain_data</span><span class="p">[</span><span class="s1">&#39;exchange_inflow&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">onchain_data</span><span class="p">[</span><span class="s1">&#39;exchange_outflow&#39;</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Net Exchange Flow: </span><span class="si">{</span><span class="n">net_flow</span><span class="si">:</span><span class="s1">,</span><span class="si">}</span><span class="s1"> BTC&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><hr />
<h1>Section 2: Key On-Chain Metrics</h1>
<h2>2.1 Active Addresses</h2>
<ul>
<li>More active addresses = more adoption</li>
<li>Correlates with price over long term</li>
</ul></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="k">def</span> <span class="nf">analyze_active_addresses</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="n">avg_30d</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Assess network activity.&quot;&quot;&quot;</span>
    <span class="n">change_pct</span> <span class="o">=</span> <span class="p">((</span><span class="n">current</span> <span class="o">-</span> <span class="n">avg_30d</span><span class="p">)</span> <span class="o">/</span> <span class="n">avg_30d</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
    
    <span class="k">if</span> <span class="n">change_pct</span> <span class="o">&gt;</span> <span class="mi">20</span><span class="p">:</span>
        <span class="n">signal</span> <span class="o">=</span> <span class="s1">&#39;STRONG GROWTH&#39;</span>
    <span class="k">elif</span> <span class="n">change_pct</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">:</span>
        <span class="n">signal</span> <span class="o">=</span> <span class="s1">&#39;GROWING&#39;</span>
    <span class="k">elif</span> <span class="n">change_pct</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">5</span><span class="p">:</span>
        <span class="n">signal</span> <span class="o">=</span> <span class="s1">&#39;STABLE&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">signal</span> <span class="o">=</span> <span class="s1">&#39;DECLINING&#39;</span>
    
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;change_pct&#39;</span><span class="p">:</span> <span class="n">change_pct</span><span class="p">,</span> <span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="n">signal</span><span class="p">}</span>

<span class="n">result</span> <span class="o">=</span> <span class="n">analyze_active_addresses</span><span class="p">(</span><span class="mi">950000</span><span class="p">,</span> <span class="mi">850000</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Change: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;change_pct&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%, Signal: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h2>2.2 Exchange Flows</h2>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Flow</th>
<th>Meaning</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Inflow</strong></td>
<td>BTC moving TO exchanges (sell pressure)</td>
</tr>
<tr>
<td><strong>Outflow</strong></td>
<td>BTC leaving exchanges (accumulation)</td>
</tr>
</tbody>
</table></div></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="k">def</span> <span class="nf">analyze_exchange_flows</span><span class="p">(</span><span class="n">inflow</span><span class="p">,</span> <span class="n">outflow</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Analyze exchange flow for market sentiment.&quot;&quot;&quot;</span>
    <span class="n">net_flow</span> <span class="o">=</span> <span class="n">inflow</span> <span class="o">-</span> <span class="n">outflow</span>
    
    <span class="k">if</span> <span class="n">net_flow</span> <span class="o">&gt;</span> <span class="mi">1000</span><span class="p">:</span>
        <span class="n">signal</span> <span class="o">=</span> <span class="s1">&#39;BEARISH (selling pressure)&#39;</span>
    <span class="k">elif</span> <span class="n">net_flow</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">1000</span><span class="p">:</span>
        <span class="n">signal</span> <span class="o">=</span> <span class="s1">&#39;BULLISH (accumulation)&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">signal</span> <span class="o">=</span> <span class="s1">&#39;NEUTRAL&#39;</span>
    
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;net_flow&#39;</span><span class="p">:</span> <span class="n">net_flow</span><span class="p">,</span> <span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="n">signal</span><span class="p">}</span>

<span class="n">result</span> <span class="o">=</span> <span class="n">analyze_exchange_flows</span><span class="p">(</span><span class="mi">15000</span><span class="p">,</span> <span class="mi">18000</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Net Flow: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;net_flow&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2"> BTC&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Signal: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h3>âœï¸ Exercise 4.1: On-Chain Dashboard</h3>
<p>Create a function that displays all key metrics.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="c1"># Exercise 4.1</span>
<span class="k">def</span> <span class="nf">onchain_dashboard</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Display on-chain metrics dashboard.&quot;&quot;&quot;</span>
    <span class="c1"># TODO</span>
    <span class="k">pass</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">onchain_dashboard</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="n">net_flow</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;exchange_inflow&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;exchange_outflow&#39;</span><span class="p">]</span>
    <span class="n">flow_signal</span> <span class="o">=</span> <span class="s1">&#39;BULLISH&#39;</span> <span class="k">if</span> <span class="n">net_flow</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;BEARISH&#39;</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=&#39;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;         ON-CHAIN DASHBOARD&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=&#39;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Active Addresses: </span><span class="si">{</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;active_addresses&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Transaction Count: </span><span class="si">{</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;transaction_count&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-&#39;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;EXCHANGE FLOWS&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Inflow: </span><span class="si">{</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;exchange_inflow&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2"> BTC&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Outflow: </span><span class="si">{</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;exchange_outflow&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2"> BTC&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Net Flow: </span><span class="si">{</span><span class="n">net_flow</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2"> BTC (</span><span class="si">{</span><span class="n">flow_signal</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-&#39;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Hash Rate: </span><span class="si">{</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;hash_rate&#39;</span><span class="p">]</span><span class="o">/</span><span class="mf">1e6</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2"> EH/s&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=&#39;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>

<span class="n">onchain_dashboard</span><span class="p">(</span><span class="n">onchain_data</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>Section 3: Whale Watching</h1>
<p>Whales are wallets holding large amounts (&gt;1000 BTC).
Their movements can signal major price action.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="c1"># Simulated whale transactions</span>
<span class="n">whale_txs</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span><span class="s1">&#39;amount&#39;</span><span class="p">:</span> <span class="mi">500</span><span class="p">,</span> <span class="s1">&#39;to&#39;</span><span class="p">:</span> <span class="s1">&#39;exchange&#39;</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="s1">&#39;2024-01-15 10:30&#39;</span><span class="p">},</span>
    <span class="p">{</span><span class="s1">&#39;amount&#39;</span><span class="p">:</span> <span class="mi">1200</span><span class="p">,</span> <span class="s1">&#39;to&#39;</span><span class="p">:</span> <span class="s1">&#39;cold_wallet&#39;</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="s1">&#39;2024-01-15 11:45&#39;</span><span class="p">},</span>
    <span class="p">{</span><span class="s1">&#39;amount&#39;</span><span class="p">:</span> <span class="mi">2500</span><span class="p">,</span> <span class="s1">&#39;to&#39;</span><span class="p">:</span> <span class="s1">&#39;exchange&#39;</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="s1">&#39;2024-01-15 14:20&#39;</span><span class="p">},</span>
<span class="p">]</span>

<span class="k">def</span> <span class="nf">analyze_whale_txs</span><span class="p">(</span><span class="n">transactions</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Analyze whale transactions for market signal.&quot;&quot;&quot;</span>
    <span class="n">to_exchange</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">tx</span><span class="p">[</span><span class="s1">&#39;amount&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">tx</span> <span class="ow">in</span> <span class="n">transactions</span> <span class="k">if</span> <span class="n">tx</span><span class="p">[</span><span class="s1">&#39;to&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;exchange&#39;</span> <span class="ow">and</span> <span class="n">tx</span><span class="p">[</span><span class="s1">&#39;amount&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">threshold</span><span class="p">)</span>
    <span class="n">from_exchange</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">tx</span><span class="p">[</span><span class="s1">&#39;amount&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">tx</span> <span class="ow">in</span> <span class="n">transactions</span> <span class="k">if</span> <span class="n">tx</span><span class="p">[</span><span class="s1">&#39;to&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;exchange&#39;</span> <span class="ow">and</span> <span class="n">tx</span><span class="p">[</span><span class="s1">&#39;amount&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">threshold</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;to_exchange&#39;</span><span class="p">:</span> <span class="n">to_exchange</span><span class="p">,</span>
        <span class="s1">&#39;from_exchange&#39;</span><span class="p">:</span> <span class="n">from_exchange</span><span class="p">,</span>
        <span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="s1">&#39;BEARISH&#39;</span> <span class="k">if</span> <span class="n">to_exchange</span> <span class="o">&gt;</span> <span class="n">from_exchange</span> <span class="k">else</span> <span class="s1">&#39;BULLISH&#39;</span>
    <span class="p">}</span>

<span class="nb">print</span><span class="p">(</span><span class="n">analyze_whale_txs</span><span class="p">(</span><span class="n">whale_txs</span><span class="p">))</span>
</code></pre></div>
<div class="md-cell"><h3>âœï¸ Exercise 4.2: Whale Alert System</h3>
<p>Create an alert system for large transactions.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="c1"># Exercise 4.2</span>
<span class="k">class</span> <span class="nc">WhaleAlertSystem</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="o">=</span> <span class="n">threshold</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alerts</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">def</span> <span class="nf">check_transaction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tx</span><span class="p">):</span>
        <span class="c1"># TODO: Check if whale tx and create alert</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">get_alerts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># TODO: Return recent alerts</span>
        <span class="k">pass</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">WhaleAlertSystem</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="o">=</span> <span class="n">threshold</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alerts</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">check_transaction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tx</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">tx</span><span class="p">[</span><span class="s1">&#39;amount&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="p">:</span>
            <span class="n">direction</span> <span class="o">=</span> <span class="s1">&#39;â†’ Exchange&#39;</span> <span class="k">if</span> <span class="n">tx</span><span class="p">[</span><span class="s1">&#39;to&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;exchange&#39;</span> <span class="k">else</span> <span class="s1">&#39;â†’ Cold Storage&#39;</span>
            <span class="n">alert</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;amount&#39;</span><span class="p">:</span> <span class="n">tx</span><span class="p">[</span><span class="s1">&#39;amount&#39;</span><span class="p">],</span>
                <span class="s1">&#39;direction&#39;</span><span class="p">:</span> <span class="n">direction</span><span class="p">,</span>
                <span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="n">tx</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">],</span>
                <span class="s1">&#39;significance&#39;</span><span class="p">:</span> <span class="s1">&#39;HIGH&#39;</span> <span class="k">if</span> <span class="n">tx</span><span class="p">[</span><span class="s1">&#39;amount&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">5000</span> <span class="k">else</span> <span class="s1">&#39;MEDIUM&#39;</span>
            <span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">alerts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">alert</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">alert</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">get_alerts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">alerts</span><span class="p">[</span><span class="o">-</span><span class="n">limit</span><span class="p">:]</span>

<span class="n">alert_system</span> <span class="o">=</span> <span class="n">WhaleAlertSystem</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span>
<span class="k">for</span> <span class="n">tx</span> <span class="ow">in</span> <span class="n">whale_txs</span><span class="p">:</span>
    <span class="n">alert</span> <span class="o">=</span> <span class="n">alert_system</span><span class="o">.</span><span class="n">check_transaction</span><span class="p">(</span><span class="n">tx</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">alert</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ğŸ‹ WHALE ALERT: </span><span class="si">{</span><span class="n">alert</span><span class="p">[</span><span class="s1">&#39;amount&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> BTC </span><span class="si">{</span><span class="n">alert</span><span class="p">[</span><span class="s1">&#39;direction&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>Section 4: Network Health Metrics</h1>
<h2>Hash Rate</h2>
<ul>
<li>Measures network security</li>
<li>Higher = more secure, more miner confidence</li>
</ul>
<h2>Difficulty</h2>
<ul>
<li>Adjusts every 2016 blocks (~2 weeks)</li>
<li>Ensures consistent block times</li>
</ul></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="k">def</span> <span class="nf">analyze_network_health</span><span class="p">(</span><span class="n">hash_rate</span><span class="p">,</span> <span class="n">hash_rate_30d_avg</span><span class="p">,</span> <span class="n">difficulty_change</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Assess Bitcoin network health.&quot;&quot;&quot;</span>
    <span class="n">hash_change</span> <span class="o">=</span> <span class="p">((</span><span class="n">hash_rate</span> <span class="o">-</span> <span class="n">hash_rate_30d_avg</span><span class="p">)</span> <span class="o">/</span> <span class="n">hash_rate_30d_avg</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
    
    <span class="n">health</span> <span class="o">=</span> <span class="s1">&#39;HEALTHY&#39;</span>
    <span class="n">concerns</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">if</span> <span class="n">hash_change</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">10</span><span class="p">:</span>
        <span class="n">health</span> <span class="o">=</span> <span class="s1">&#39;CONCERNING&#39;</span>
        <span class="n">concerns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Hash rate declining significantly&#39;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">difficulty_change</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">5</span><span class="p">:</span>
        <span class="n">concerns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Difficulty adjustment negative (miners leaving)&#39;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;health&#39;</span><span class="p">:</span> <span class="n">health</span><span class="p">,</span>
        <span class="s1">&#39;hash_rate_change&#39;</span><span class="p">:</span> <span class="n">hash_change</span><span class="p">,</span>
        <span class="s1">&#39;concerns&#39;</span><span class="p">:</span> <span class="n">concerns</span>
    <span class="p">}</span>

<span class="n">result</span> <span class="o">=</span> <span class="n">analyze_network_health</span><span class="p">(</span><span class="mi">450_000_000</span><span class="p">,</span> <span class="mi">420_000_000</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Network Health: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;health&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Hash Rate Change: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;hash_rate_change&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h3>âœï¸ Exercise 4.3: Network Health Monitor</h3>
<p>Build a comprehensive network health monitoring class.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="c1"># Exercise 4.3</span>
<span class="k">class</span> <span class="nc">NetworkHealthMonitor</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics_history</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metrics</span><span class="p">):</span>
        <span class="c1"># TODO: Store metrics</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">get_health_score</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># TODO: Return 0-100 health score</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">get_report</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># TODO: Return full health report</span>
        <span class="k">pass</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">NetworkHealthMonitor</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics_history</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metrics</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics_history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metrics</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metrics_history</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">30</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metrics_history</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_health_score</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics_history</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">latest</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics_history</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">score</span> <span class="o">=</span> <span class="mi">50</span>  <span class="c1"># Base score</span>

        <span class="c1"># Hash rate trend</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metrics_history</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">prev</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics_history</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">latest</span><span class="p">[</span><span class="s1">&#39;hash_rate&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">prev</span><span class="p">[</span><span class="s1">&#39;hash_rate&#39;</span><span class="p">]:</span>
                <span class="n">score</span> <span class="o">+=</span> <span class="mi">20</span>
            <span class="k">elif</span> <span class="n">latest</span><span class="p">[</span><span class="s1">&#39;hash_rate&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">prev</span><span class="p">[</span><span class="s1">&#39;hash_rate&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.95</span><span class="p">:</span>
                <span class="n">score</span> <span class="o">-=</span> <span class="mi">20</span>

        <span class="c1"># Active addresses</span>
        <span class="k">if</span> <span class="n">latest</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;active_addresses&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">900000</span><span class="p">:</span>
            <span class="n">score</span> <span class="o">+=</span> <span class="mi">15</span>

        <span class="c1"># Exchange outflow (accumulation)</span>
        <span class="k">if</span> <span class="n">latest</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;exchange_outflow&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">latest</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;exchange_inflow&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">score</span> <span class="o">+=</span> <span class="mi">15</span>

        <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">100</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_report</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_health_score</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;health_score&#39;</span><span class="p">:</span> <span class="n">score</span><span class="p">,</span>
            <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;HEALTHY&#39;</span> <span class="k">if</span> <span class="n">score</span> <span class="o">&gt;</span> <span class="mi">70</span> <span class="k">else</span> <span class="s1">&#39;MODERATE&#39;</span> <span class="k">if</span> <span class="n">score</span> <span class="o">&gt;</span> <span class="mi">40</span> <span class="k">else</span> <span class="s1">&#39;CONCERNING&#39;</span><span class="p">,</span>
            <span class="s1">&#39;latest_metrics&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics_history</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics_history</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="p">}</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>ğŸ—ï¸ Module Project: On-Chain Analytics Dashboard</h1>
<p>Build a complete on-chain analytics system.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="c1"># Module Project</span>
<span class="k">class</span> <span class="nc">OnChainAnalytics</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">whale_system</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># WhaleAlertSystem</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">health_monitor</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># NetworkHealthMonitor</span>
    
    <span class="k">def</span> <span class="nf">update_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">onchain_data</span><span class="p">,</span> <span class="n">transactions</span><span class="p">):</span>
        <span class="c1"># TODO</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">get_market_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># TODO: Combine all signals</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">full_report</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># TODO: Print comprehensive report</span>
        <span class="k">pass</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">OnChainAnalytics</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">whale_system</span> <span class="o">=</span> <span class="n">WhaleAlertSystem</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">health_monitor</span> <span class="o">=</span> <span class="n">NetworkHealthMonitor</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">latest_data</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">update_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">onchain_data</span><span class="p">,</span> <span class="n">transactions</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">latest_data</span> <span class="o">=</span> <span class="n">onchain_data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">health_monitor</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">onchain_data</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">transactions</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">tx</span> <span class="ow">in</span> <span class="n">transactions</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">whale_system</span><span class="o">.</span><span class="n">check_transaction</span><span class="p">(</span><span class="n">tx</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_market_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">latest_data</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;NO DATA&#39;</span>

        <span class="n">signals</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Exchange flow signal</span>
        <span class="n">net_flow</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">latest_data</span><span class="p">[</span><span class="s1">&#39;exchange_inflow&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">latest_data</span><span class="p">[</span><span class="s1">&#39;exchange_outflow&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">net_flow</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">1000</span><span class="p">:</span>
            <span class="n">signals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;BULLISH (accumulation)&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">net_flow</span> <span class="o">&gt;</span> <span class="mi">1000</span><span class="p">:</span>
            <span class="n">signals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;BEARISH (distribution)&#39;</span><span class="p">)</span>

        <span class="c1"># Health signal</span>
        <span class="n">health</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">health_monitor</span><span class="o">.</span><span class="n">get_health_score</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">health</span> <span class="ow">and</span> <span class="n">health</span> <span class="o">&gt;</span> <span class="mi">70</span><span class="p">:</span>
            <span class="n">signals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;BULLISH (healthy network)&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">signals</span> <span class="k">if</span> <span class="n">signals</span> <span class="k">else</span> <span class="p">[</span><span class="s1">&#39;NEUTRAL&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">full_report</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=&#39;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;           ON-CHAIN ANALYTICS REPORT&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=&#39;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>

        <span class="n">onchain_dashboard</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">latest_data</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">WHALE ACTIVITY&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">alert</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">whale_system</span><span class="o">.</span><span class="n">get_alerts</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  ğŸ‹ </span><span class="si">{</span><span class="n">alert</span><span class="p">[</span><span class="s1">&#39;amount&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> BTC </span><span class="si">{</span><span class="n">alert</span><span class="p">[</span><span class="s1">&#39;direction&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">NETWORK HEALTH SCORE: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">health_monitor</span><span class="o">.</span><span class="n">get_health_score</span><span class="p">()</span><span class="si">}</span><span class="s1">/100&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">MARKET SIGNALS: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">get_market_signal</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=&#39;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>

<span class="c1"># Test</span>
<span class="n">analytics</span> <span class="o">=</span> <span class="n">OnChainAnalytics</span><span class="p">()</span>
<span class="n">analytics</span><span class="o">.</span><span class="n">update_data</span><span class="p">(</span><span class="n">onchain_data</span><span class="p">,</span> <span class="n">whale_txs</span><span class="p">)</span>
<span class="n">analytics</span><span class="o">.</span><span class="n">full_report</span><span class="p">()</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>ğŸ“ Key Takeaways</h1>
<ol>
<li><strong>On-Chain Data</strong>: Unique blockchain transparency</li>
<li><strong>Exchange Flows</strong>: Inflows = sell pressure, Outflows = accumulation</li>
<li><strong>Whale Watching</strong>: Large movements signal market direction</li>
<li><strong>Network Health</strong>: Hash rate, active addresses show fundamentals</li>
</ol>
<hr />
<p><em>Part 1 Complete! Next: Part 2 - Strategy Development</em></p></div>
        <div class="nav-buttons">
            <button class="nav-btn prev-btn disabled" type="button">
                <span class="nav-btn-label">â† Previous</span>
                <span class="nav-btn-name"></span>
            </button>
            <button class="nav-btn next-btn disabled" type="button">
                <span class="nav-btn-label">Next â†’</span>
                <span class="nav-btn-name"></span>
            </button>
        </div>
        </div>
<div class="module-section" data-idx="5"><div class="md-cell module-header"><h1>Module 5: Crypto Trading Strategies</h1>
<h2>Part 2: Strategy Development</h2>
<hr />
<div class="table-wrapper"><table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>â±ï¸ <strong>Duration</strong></td>
<td>~2.5 hours</td>
</tr>
<tr>
<td>ğŸ“‹ <strong>Prerequisites</strong></td>
<td>Part 1 (Modules 1-4)</td>
</tr>
<tr>
<td>ğŸ’ª <strong>Exercises</strong></td>
<td>5 total</td>
</tr>
</tbody>
</table></div></div>
<div class="md-cell"><h2>ğŸ¯ Learning Objectives</h2>
<ul>
<li>Implement trend following strategies</li>
<li>Build mean reversion systems</li>
<li>Create momentum ranking strategies</li>
<li>Develop range trading approaches</li>
</ul></div>
<div class="md-cell"><hr />
<h1>Section 1: Trend Following</h1>
<h2>Moving Average Crossover</h2>
<p>Classic strategy: Buy when fast MA crosses above slow MA.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="k">def</span> <span class="nf">ma_crossover_signals</span><span class="p">(</span><span class="n">prices</span><span class="p">,</span> <span class="n">fast</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">slow</span><span class="o">=</span><span class="mi">30</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Generate MA crossover signals.&quot;&quot;&quot;</span>
    <span class="n">prices</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span>
    <span class="n">fast_ma</span> <span class="o">=</span> <span class="n">prices</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">fast</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">slow_ma</span> <span class="o">=</span> <span class="n">prices</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">slow</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    
    <span class="n">signals</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">prices</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">fast_ma</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">slow_ma</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">and</span> <span class="n">fast_ma</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">slow_ma</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">signals</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;BUY&#39;</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">fast_ma</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">slow_ma</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">and</span> <span class="n">fast_ma</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">slow_ma</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">signals</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;SELL&#39;</span><span class="p">))</span>
    
    <span class="k">return</span> <span class="n">signals</span>

<span class="n">prices</span> <span class="o">=</span> <span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">102</span><span class="p">,</span> <span class="mi">105</span><span class="p">,</span> <span class="mi">103</span><span class="p">,</span> <span class="mi">108</span><span class="p">,</span> <span class="mi">112</span><span class="p">,</span> <span class="mi">115</span><span class="p">,</span> <span class="mi">113</span><span class="p">,</span> <span class="mi">118</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="mi">117</span><span class="p">,</span> <span class="mi">115</span><span class="p">,</span> <span class="mi">112</span><span class="p">,</span> <span class="mi">110</span><span class="p">,</span> <span class="mi">108</span><span class="p">]</span>
<span class="n">signals</span> <span class="o">=</span> <span class="n">ma_crossover_signals</span><span class="p">(</span><span class="n">prices</span><span class="p">,</span> <span class="n">fast</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">slow</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Signals: </span><span class="si">{</span><span class="n">signals</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h2>Breakout Strategy</h2>
<p>Buy when price breaks above recent highs.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="k">def</span> <span class="nf">breakout_signals</span><span class="p">(</span><span class="n">prices</span><span class="p">,</span> <span class="n">lookback</span><span class="o">=</span><span class="mi">20</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Generate breakout signals.&quot;&quot;&quot;</span>
    <span class="n">prices</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span>
    <span class="n">signals</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">lookback</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">prices</span><span class="p">)):</span>
        <span class="n">recent_high</span> <span class="o">=</span> <span class="n">prices</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="n">lookback</span><span class="p">:</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">recent_low</span> <span class="o">=</span> <span class="n">prices</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="n">lookback</span><span class="p">:</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="n">prices</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">recent_high</span><span class="p">:</span>
            <span class="n">signals</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;BUY&#39;</span><span class="p">,</span> <span class="n">prices</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
        <span class="k">elif</span> <span class="n">prices</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">recent_low</span><span class="p">:</span>
            <span class="n">signals</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;SELL&#39;</span><span class="p">,</span> <span class="n">prices</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
    
    <span class="k">return</span> <span class="n">signals</span>
</code></pre></div>
<div class="md-cell"><h3>âœï¸ Exercise 5.1: Trend Following System</h3>
<p>Build a complete trend following class with multiple filters.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="c1"># Exercise 5.1</span>
<span class="k">class</span> <span class="nc">TrendFollowingStrategy</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fast_ma</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">slow_ma</span><span class="o">=</span><span class="mi">30</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fast_ma</span> <span class="o">=</span> <span class="n">fast_ma</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slow_ma</span> <span class="o">=</span> <span class="n">slow_ma</span>
    
    <span class="k">def</span> <span class="nf">get_trend</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prices</span><span class="p">):</span>
        <span class="c1"># TODO: Return &#39;UP&#39;, &#39;DOWN&#39;, or &#39;NEUTRAL&#39;</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">generate_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prices</span><span class="p">):</span>
        <span class="c1"># TODO: Return signal with confidence</span>
        <span class="k">pass</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">TrendFollowingStrategy</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fast_ma</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">slow_ma</span><span class="o">=</span><span class="mi">30</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fast_ma</span> <span class="o">=</span> <span class="n">fast_ma</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slow_ma</span> <span class="o">=</span> <span class="n">slow_ma</span>

    <span class="k">def</span> <span class="nf">get_trend</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prices</span><span class="p">):</span>
        <span class="n">prices</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span>
        <span class="n">fast</span> <span class="o">=</span> <span class="n">prices</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fast_ma</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">slow</span> <span class="o">=</span> <span class="n">prices</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slow_ma</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">fast</span> <span class="o">&gt;</span> <span class="n">slow</span> <span class="o">*</span> <span class="mf">1.02</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;UP&#39;</span>
        <span class="k">elif</span> <span class="n">fast</span> <span class="o">&lt;</span> <span class="n">slow</span> <span class="o">*</span> <span class="mf">0.98</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;DOWN&#39;</span>
        <span class="k">return</span> <span class="s1">&#39;NEUTRAL&#39;</span>

    <span class="k">def</span> <span class="nf">generate_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prices</span><span class="p">):</span>
        <span class="n">trend</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_trend</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span>
        <span class="n">prices</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span>

        <span class="c1"># Calculate RSI for confirmation</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="n">prices</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span>
        <span class="n">gain</span> <span class="o">=</span> <span class="n">delta</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">delta</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">14</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">delta</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">delta</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">14</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">rs</span> <span class="o">=</span> <span class="n">gain</span> <span class="o">/</span> <span class="n">loss</span>
        <span class="n">rsi</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">-</span> <span class="p">(</span><span class="mi">100</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">rs</span><span class="p">))</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">trend</span> <span class="o">==</span> <span class="s1">&#39;UP&#39;</span> <span class="ow">and</span> <span class="n">rsi</span> <span class="o">&lt;</span> <span class="mi">70</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="s1">&#39;BUY&#39;</span><span class="p">,</span> <span class="s1">&#39;confidence&#39;</span><span class="p">:</span> <span class="s1">&#39;HIGH&#39;</span> <span class="k">if</span> <span class="n">rsi</span> <span class="o">&lt;</span> <span class="mi">50</span> <span class="k">else</span> <span class="s1">&#39;MEDIUM&#39;</span><span class="p">}</span>
        <span class="k">elif</span> <span class="n">trend</span> <span class="o">==</span> <span class="s1">&#39;DOWN&#39;</span> <span class="ow">and</span> <span class="n">rsi</span> <span class="o">&gt;</span> <span class="mi">30</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="s1">&#39;SELL&#39;</span><span class="p">,</span> <span class="s1">&#39;confidence&#39;</span><span class="p">:</span> <span class="s1">&#39;HIGH&#39;</span> <span class="k">if</span> <span class="n">rsi</span> <span class="o">&gt;</span> <span class="mi">50</span> <span class="k">else</span> <span class="s1">&#39;MEDIUM&#39;</span><span class="p">}</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="s1">&#39;HOLD&#39;</span><span class="p">,</span> <span class="s1">&#39;confidence&#39;</span><span class="p">:</span> <span class="s1">&#39;LOW&#39;</span><span class="p">}</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>Section 2: Mean Reversion</h1>
<h2>RSI Mean Reversion</h2>
<p>Buy oversold (RSI &lt; 30), sell overbought (RSI &gt; 70).</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="k">def</span> <span class="nf">rsi_mean_reversion</span><span class="p">(</span><span class="n">prices</span><span class="p">,</span> <span class="n">period</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">oversold</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">overbought</span><span class="o">=</span><span class="mi">70</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;RSI-based mean reversion signals.&quot;&quot;&quot;</span>
    <span class="n">prices</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span>
    <span class="n">delta</span> <span class="o">=</span> <span class="n">prices</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span>
    
    <span class="n">gain</span> <span class="o">=</span> <span class="n">delta</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">delta</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">period</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">delta</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">delta</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">period</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">rs</span> <span class="o">=</span> <span class="n">gain</span> <span class="o">/</span> <span class="n">loss</span>
    <span class="n">rsi</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">-</span> <span class="p">(</span><span class="mi">100</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">rs</span><span class="p">))</span>
    
    <span class="n">signals</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">prices</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">rsi</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">oversold</span> <span class="ow">and</span> <span class="n">rsi</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">oversold</span><span class="p">:</span>
            <span class="n">signals</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;BUY&#39;</span><span class="p">,</span> <span class="n">rsi</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
        <span class="k">elif</span> <span class="n">rsi</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">overbought</span> <span class="ow">and</span> <span class="n">rsi</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">overbought</span><span class="p">:</span>
            <span class="n">signals</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;SELL&#39;</span><span class="p">,</span> <span class="n">rsi</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
    
    <span class="k">return</span> <span class="n">signals</span>
</code></pre></div>
<div class="md-cell"><h2>Bollinger Band Mean Reversion</h2></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="k">def</span> <span class="nf">bollinger_mean_reversion</span><span class="p">(</span><span class="n">prices</span><span class="p">,</span> <span class="n">period</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">std_dev</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Bollinger Band mean reversion signals.&quot;&quot;&quot;</span>
    <span class="n">prices</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span>
    <span class="n">sma</span> <span class="o">=</span> <span class="n">prices</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">period</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">std</span> <span class="o">=</span> <span class="n">prices</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">period</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
    
    <span class="n">upper</span> <span class="o">=</span> <span class="n">sma</span> <span class="o">+</span> <span class="p">(</span><span class="n">std</span> <span class="o">*</span> <span class="n">std_dev</span><span class="p">)</span>
    <span class="n">lower</span> <span class="o">=</span> <span class="n">sma</span> <span class="o">-</span> <span class="p">(</span><span class="n">std</span> <span class="o">*</span> <span class="n">std_dev</span><span class="p">)</span>
    
    <span class="n">signals</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">prices</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">prices</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">lower</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
            <span class="n">signals</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;BUY&#39;</span><span class="p">,</span> <span class="s1">&#39;Below lower band&#39;</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">prices</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">upper</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
            <span class="n">signals</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;SELL&#39;</span><span class="p">,</span> <span class="s1">&#39;Above upper band&#39;</span><span class="p">))</span>
    
    <span class="k">return</span> <span class="n">signals</span>
</code></pre></div>
<div class="md-cell"><h3>âœï¸ Exercise 5.2: Mean Reversion System</h3>
<p>Build a mean reversion strategy combining RSI and Bollinger Bands.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="c1"># Exercise 5.2</span>
<span class="k">class</span> <span class="nc">MeanReversionStrategy</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">calculate_indicators</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prices</span><span class="p">):</span>
        <span class="c1"># TODO: Return RSI and BB values</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">generate_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prices</span><span class="p">):</span>
        <span class="c1"># TODO: Combine RSI + BB for signal</span>
        <span class="k">pass</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">MeanReversionStrategy</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rsi_period</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">bb_period</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">bb_std</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rsi_period</span> <span class="o">=</span> <span class="n">rsi_period</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bb_period</span> <span class="o">=</span> <span class="n">bb_period</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bb_std</span> <span class="o">=</span> <span class="n">bb_std</span>

    <span class="k">def</span> <span class="nf">calculate_indicators</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prices</span><span class="p">):</span>
        <span class="n">prices</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span>

        <span class="c1"># RSI</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="n">prices</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span>
        <span class="n">gain</span> <span class="o">=</span> <span class="n">delta</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">delta</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rsi_period</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">delta</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">delta</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rsi_period</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">rs</span> <span class="o">=</span> <span class="n">gain</span> <span class="o">/</span> <span class="n">loss</span>
        <span class="n">rsi</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">-</span> <span class="p">(</span><span class="mi">100</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">rs</span><span class="p">))</span>

        <span class="c1"># Bollinger Bands</span>
        <span class="n">sma</span> <span class="o">=</span> <span class="n">prices</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bb_period</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">std</span> <span class="o">=</span> <span class="n">prices</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bb_period</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
        <span class="n">bb_upper</span> <span class="o">=</span> <span class="n">sma</span> <span class="o">+</span> <span class="p">(</span><span class="n">std</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">bb_std</span><span class="p">)</span>
        <span class="n">bb_lower</span> <span class="o">=</span> <span class="n">sma</span> <span class="o">-</span> <span class="p">(</span><span class="n">std</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">bb_std</span><span class="p">)</span>
        <span class="n">bb_pct</span> <span class="o">=</span> <span class="p">(</span><span class="n">prices</span> <span class="o">-</span> <span class="n">bb_lower</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">bb_upper</span> <span class="o">-</span> <span class="n">bb_lower</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;rsi&#39;</span><span class="p">:</span> <span class="n">rsi</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;bb_pct&#39;</span><span class="p">:</span> <span class="n">bb_pct</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="n">prices</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]}</span>

    <span class="k">def</span> <span class="nf">generate_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prices</span><span class="p">):</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_indicators</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span>

        <span class="c1"># Strong buy: RSI oversold AND below lower BB</span>
        <span class="k">if</span> <span class="n">ind</span><span class="p">[</span><span class="s1">&#39;rsi&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">30</span> <span class="ow">and</span> <span class="n">ind</span><span class="p">[</span><span class="s1">&#39;bb_pct&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="s1">&#39;STRONG_BUY&#39;</span><span class="p">,</span> <span class="s1">&#39;rsi&#39;</span><span class="p">:</span> <span class="n">ind</span><span class="p">[</span><span class="s1">&#39;rsi&#39;</span><span class="p">],</span> <span class="s1">&#39;bb_pct&#39;</span><span class="p">:</span> <span class="n">ind</span><span class="p">[</span><span class="s1">&#39;bb_pct&#39;</span><span class="p">]}</span>
        <span class="c1"># Strong sell: RSI overbought AND above upper BB</span>
        <span class="k">elif</span> <span class="n">ind</span><span class="p">[</span><span class="s1">&#39;rsi&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">70</span> <span class="ow">and</span> <span class="n">ind</span><span class="p">[</span><span class="s1">&#39;bb_pct&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="s1">&#39;STRONG_SELL&#39;</span><span class="p">,</span> <span class="s1">&#39;rsi&#39;</span><span class="p">:</span> <span class="n">ind</span><span class="p">[</span><span class="s1">&#39;rsi&#39;</span><span class="p">],</span> <span class="s1">&#39;bb_pct&#39;</span><span class="p">:</span> <span class="n">ind</span><span class="p">[</span><span class="s1">&#39;bb_pct&#39;</span><span class="p">]}</span>
        <span class="c1"># Weak signals</span>
        <span class="k">elif</span> <span class="n">ind</span><span class="p">[</span><span class="s1">&#39;rsi&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">30</span> <span class="ow">or</span> <span class="n">ind</span><span class="p">[</span><span class="s1">&#39;bb_pct&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="s1">&#39;WEAK_BUY&#39;</span><span class="p">,</span> <span class="s1">&#39;rsi&#39;</span><span class="p">:</span> <span class="n">ind</span><span class="p">[</span><span class="s1">&#39;rsi&#39;</span><span class="p">],</span> <span class="s1">&#39;bb_pct&#39;</span><span class="p">:</span> <span class="n">ind</span><span class="p">[</span><span class="s1">&#39;bb_pct&#39;</span><span class="p">]}</span>
        <span class="k">elif</span> <span class="n">ind</span><span class="p">[</span><span class="s1">&#39;rsi&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">70</span> <span class="ow">or</span> <span class="n">ind</span><span class="p">[</span><span class="s1">&#39;bb_pct&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="s1">&#39;WEAK_SELL&#39;</span><span class="p">,</span> <span class="s1">&#39;rsi&#39;</span><span class="p">:</span> <span class="n">ind</span><span class="p">[</span><span class="s1">&#39;rsi&#39;</span><span class="p">],</span> <span class="s1">&#39;bb_pct&#39;</span><span class="p">:</span> <span class="n">ind</span><span class="p">[</span><span class="s1">&#39;bb_pct&#39;</span><span class="p">]}</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="s1">&#39;HOLD&#39;</span><span class="p">,</span> <span class="s1">&#39;rsi&#39;</span><span class="p">:</span> <span class="n">ind</span><span class="p">[</span><span class="s1">&#39;rsi&#39;</span><span class="p">],</span> <span class="s1">&#39;bb_pct&#39;</span><span class="p">:</span> <span class="n">ind</span><span class="p">[</span><span class="s1">&#39;bb_pct&#39;</span><span class="p">]}</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>Section 3: Momentum Strategies</h1>
<h2>Relative Strength Ranking</h2>
<p>Rank assets by recent performance, buy strongest.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="k">def</span> <span class="nf">momentum_ranking</span><span class="p">(</span><span class="n">price_data</span><span class="p">,</span> <span class="n">lookback</span><span class="o">=</span><span class="mi">30</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Rank assets by momentum.</span>
<span class="sd">    </span>
<span class="sd">    price_data: dict of {symbol: prices_list}</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rankings</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">for</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">prices</span> <span class="ow">in</span> <span class="n">price_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">lookback</span><span class="p">:</span>
            <span class="n">returns</span> <span class="o">=</span> <span class="p">(</span><span class="n">prices</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">prices</span><span class="p">[</span><span class="o">-</span><span class="n">lookback</span><span class="p">])</span> <span class="o">/</span> <span class="n">prices</span><span class="p">[</span><span class="o">-</span><span class="n">lookback</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span>
            <span class="n">rankings</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">symbol</span><span class="p">,</span> <span class="n">returns</span><span class="p">))</span>
    
    <span class="c1"># Sort by returns (highest first)</span>
    <span class="n">rankings</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">rankings</span>

<span class="c1"># Example</span>
<span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;BTC&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">40000</span><span class="p">,</span> <span class="mi">42000</span><span class="p">,</span> <span class="mi">44000</span><span class="p">,</span> <span class="mi">43000</span><span class="p">,</span> <span class="mi">45000</span><span class="p">],</span>
    <span class="s1">&#39;ETH&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">2000</span><span class="p">,</span> <span class="mi">2100</span><span class="p">,</span> <span class="mi">2050</span><span class="p">,</span> <span class="mi">2200</span><span class="p">,</span> <span class="mi">2300</span><span class="p">],</span>
    <span class="s1">&#39;SOL&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">95</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">105</span><span class="p">,</span> <span class="mi">120</span><span class="p">]</span>
<span class="p">}</span>
<span class="nb">print</span><span class="p">(</span><span class="n">momentum_ranking</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
</code></pre></div>
<div class="md-cell"><h3>âœï¸ Exercise 5.3: Momentum Ranker</h3>
<p>Build a momentum ranking system with multiple timeframes.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="c1"># Exercise 5.3</span>
<span class="k">class</span> <span class="nc">MomentumRanker</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lookbacks</span><span class="o">=</span><span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">30</span><span class="p">]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lookbacks</span> <span class="o">=</span> <span class="n">lookbacks</span>
    
    <span class="k">def</span> <span class="nf">calculate_momentum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prices</span><span class="p">,</span> <span class="n">lookback</span><span class="p">):</span>
        <span class="c1"># TODO</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">rank_assets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">price_data</span><span class="p">):</span>
        <span class="c1"># TODO: Rank by combined momentum score</span>
        <span class="k">pass</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">MomentumRanker</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lookbacks</span><span class="o">=</span><span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">30</span><span class="p">]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lookbacks</span> <span class="o">=</span> <span class="n">lookbacks</span>

    <span class="k">def</span> <span class="nf">calculate_momentum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prices</span><span class="p">,</span> <span class="n">lookback</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">lookback</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">prices</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">prices</span><span class="p">[</span><span class="o">-</span><span class="n">lookback</span><span class="p">])</span> <span class="o">/</span> <span class="n">prices</span><span class="p">[</span><span class="o">-</span><span class="n">lookback</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span>

    <span class="k">def</span> <span class="nf">rank_assets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">price_data</span><span class="p">):</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">prices</span> <span class="ow">in</span> <span class="n">price_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">momentum_scores</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">lb</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookbacks</span><span class="p">:</span>
                <span class="n">mom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_momentum</span><span class="p">(</span><span class="n">prices</span><span class="p">,</span> <span class="n">lb</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">mom</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">momentum_scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mom</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">momentum_scores</span><span class="p">:</span>
                <span class="n">avg_score</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">momentum_scores</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">momentum_scores</span><span class="p">)</span>
                <span class="n">scores</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span>
                    <span class="s1">&#39;avg_momentum&#39;</span><span class="p">:</span> <span class="n">avg_score</span><span class="p">,</span>
                    <span class="s1">&#39;details&#39;</span><span class="p">:</span> <span class="p">{</span><span class="n">lb</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_momentum</span><span class="p">(</span><span class="n">prices</span><span class="p">,</span> <span class="n">lb</span><span class="p">)</span> <span class="k">for</span> <span class="n">lb</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookbacks</span><span class="p">}</span>
                <span class="p">})</span>

        <span class="n">scores</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;avg_momentum&#39;</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">scores</span>

<span class="n">ranker</span> <span class="o">=</span> <span class="n">MomentumRanker</span><span class="p">([</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">])</span>
<span class="n">rankings</span> <span class="o">=</span> <span class="n">ranker</span><span class="o">.</span><span class="n">rank_assets</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">rankings</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;symbol&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;avg_momentum&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>Section 4: Range Trading</h1>
<h2>Identifying Ranges</h2></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="k">def</span> <span class="nf">identify_range</span><span class="p">(</span><span class="n">prices</span><span class="p">,</span> <span class="n">lookback</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.05</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Identify if price is in a range.&quot;&quot;&quot;</span>
    <span class="n">prices</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span>
    <span class="n">recent</span> <span class="o">=</span> <span class="n">prices</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="n">lookback</span><span class="p">:]</span>
    
    <span class="n">high</span> <span class="o">=</span> <span class="n">recent</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">low</span> <span class="o">=</span> <span class="n">recent</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="n">range_pct</span> <span class="o">=</span> <span class="p">(</span><span class="n">high</span> <span class="o">-</span> <span class="n">low</span><span class="p">)</span> <span class="o">/</span> <span class="n">low</span>
    
    <span class="n">current</span> <span class="o">=</span> <span class="n">prices</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">position</span> <span class="o">=</span> <span class="p">(</span><span class="n">current</span> <span class="o">-</span> <span class="n">low</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">high</span> <span class="o">-</span> <span class="n">low</span><span class="p">)</span> <span class="k">if</span> <span class="n">high</span> <span class="o">!=</span> <span class="n">low</span> <span class="k">else</span> <span class="mf">0.5</span>
    
    <span class="n">is_ranging</span> <span class="o">=</span> <span class="n">range_pct</span> <span class="o">&lt;</span> <span class="n">threshold</span>
    
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;is_ranging&#39;</span><span class="p">:</span> <span class="n">is_ranging</span><span class="p">,</span>
        <span class="s1">&#39;high&#39;</span><span class="p">:</span> <span class="n">high</span><span class="p">,</span>
        <span class="s1">&#39;low&#39;</span><span class="p">:</span> <span class="n">low</span><span class="p">,</span>
        <span class="s1">&#39;range_pct&#39;</span><span class="p">:</span> <span class="n">range_pct</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
        <span class="s1">&#39;position&#39;</span><span class="p">:</span> <span class="n">position</span>  <span class="c1"># 0 = at low, 1 = at high</span>
    <span class="p">}</span>
</code></pre></div>
<div class="md-cell"><h3>âœï¸ Exercise 5.4: Range Trading Strategy</h3>
<p>Build a range trading strategy that buys at support, sells at resistance.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="c1"># Exercise 5.4</span>
<span class="k">class</span> <span class="nc">RangeTradingStrategy</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lookback</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">buy_zone</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">sell_zone</span><span class="o">=</span><span class="mf">0.8</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lookback</span> <span class="o">=</span> <span class="n">lookback</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buy_zone</span> <span class="o">=</span> <span class="n">buy_zone</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sell_zone</span> <span class="o">=</span> <span class="n">sell_zone</span>
    
    <span class="k">def</span> <span class="nf">analyze</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prices</span><span class="p">):</span>
        <span class="c1"># TODO</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">generate_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prices</span><span class="p">):</span>
        <span class="c1"># TODO</span>
        <span class="k">pass</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">RangeTradingStrategy</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lookback</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">buy_zone</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">sell_zone</span><span class="o">=</span><span class="mf">0.8</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lookback</span> <span class="o">=</span> <span class="n">lookback</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buy_zone</span> <span class="o">=</span> <span class="n">buy_zone</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sell_zone</span> <span class="o">=</span> <span class="n">sell_zone</span>

    <span class="k">def</span> <span class="nf">analyze</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prices</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">identify_range</span><span class="p">(</span><span class="n">prices</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookback</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">generate_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prices</span><span class="p">):</span>
        <span class="n">analysis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;is_ranging&#39;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="s1">&#39;NO_TRADE&#39;</span><span class="p">,</span> <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="s1">&#39;Not in range&#39;</span><span class="p">}</span>

        <span class="n">position</span> <span class="o">=</span> <span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;position&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">position</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">buy_zone</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="s1">&#39;BUY&#39;</span><span class="p">,</span>
                <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;At support (</span><span class="si">{</span><span class="n">position</span><span class="si">:</span><span class="s1">.1%</span><span class="si">}</span><span class="s1"> of range)&#39;</span><span class="p">,</span>
                <span class="s1">&#39;target&#39;</span><span class="p">:</span> <span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;high&#39;</span><span class="p">],</span>
                <span class="s1">&#39;stop&#39;</span><span class="p">:</span> <span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;low&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.98</span>
            <span class="p">}</span>
        <span class="k">elif</span> <span class="n">position</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sell_zone</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="s1">&#39;SELL&#39;</span><span class="p">,</span>
                <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;At resistance (</span><span class="si">{</span><span class="n">position</span><span class="si">:</span><span class="s1">.1%</span><span class="si">}</span><span class="s1"> of range)&#39;</span><span class="p">,</span>
                <span class="s1">&#39;target&#39;</span><span class="p">:</span> <span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;low&#39;</span><span class="p">],</span>
                <span class="s1">&#39;stop&#39;</span><span class="p">:</span> <span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;high&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1.02</span>
            <span class="p">}</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="s1">&#39;HOLD&#39;</span><span class="p">,</span> <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="s1">&#39;Mid-range&#39;</span><span class="p">}</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>ğŸ—ï¸ Module Project: Multi-Strategy Signal System</h1>
<p>Combine all strategies into one signal generator.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="c1"># Module Project</span>
<span class="k">class</span> <span class="nc">MultiStrategySystem</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trend_strategy</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mean_reversion</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">range_strategy</span> <span class="o">=</span> <span class="kc">None</span>
    
    <span class="k">def</span> <span class="nf">analyze_market_regime</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prices</span><span class="p">):</span>
        <span class="c1"># TODO: Determine if trending or ranging</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">get_combined_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prices</span><span class="p">):</span>
        <span class="c1"># TODO: Use appropriate strategy based on regime</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">generate_report</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prices</span><span class="p">):</span>
        <span class="c1"># TODO: Full analysis report</span>
        <span class="k">pass</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">MultiStrategySystem</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trend_strategy</span> <span class="o">=</span> <span class="n">TrendFollowingStrategy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mean_reversion</span> <span class="o">=</span> <span class="n">MeanReversionStrategy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">range_strategy</span> <span class="o">=</span> <span class="n">RangeTradingStrategy</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">analyze_market_regime</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prices</span><span class="p">):</span>
        <span class="n">range_analysis</span> <span class="o">=</span> <span class="n">identify_range</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">range_analysis</span><span class="p">[</span><span class="s1">&#39;is_ranging&#39;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="s1">&#39;RANGING&#39;</span>

        <span class="n">trend</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trend_strategy</span><span class="o">.</span><span class="n">get_trend</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">trend</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;UP&#39;</span><span class="p">,</span> <span class="s1">&#39;DOWN&#39;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;TRENDING_</span><span class="si">{</span><span class="n">trend</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="k">return</span> <span class="s1">&#39;UNCLEAR&#39;</span>

    <span class="k">def</span> <span class="nf">get_combined_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prices</span><span class="p">):</span>
        <span class="n">regime</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_market_regime</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">regime</span> <span class="o">==</span> <span class="s1">&#39;RANGING&#39;</span><span class="p">:</span>
            <span class="n">signal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">range_strategy</span><span class="o">.</span><span class="n">generate_signal</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span>
            <span class="n">signal</span><span class="p">[</span><span class="s1">&#39;strategy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;RANGE&#39;</span>
        <span class="k">elif</span> <span class="n">regime</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;TRENDING&#39;</span><span class="p">):</span>
            <span class="n">signal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trend_strategy</span><span class="o">.</span><span class="n">generate_signal</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span>
            <span class="n">signal</span><span class="p">[</span><span class="s1">&#39;strategy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;TREND&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">signal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mean_reversion</span><span class="o">.</span><span class="n">generate_signal</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span>
            <span class="n">signal</span><span class="p">[</span><span class="s1">&#39;strategy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;MEAN_REVERSION&#39;</span>

        <span class="n">signal</span><span class="p">[</span><span class="s1">&#39;regime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">regime</span>
        <span class="k">return</span> <span class="n">signal</span>

    <span class="k">def</span> <span class="nf">generate_report</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prices</span><span class="p">):</span>
        <span class="n">signal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_combined_signal</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=&#39;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;     MULTI-STRATEGY ANALYSIS&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=&#39;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Market Regime: </span><span class="si">{</span><span class="n">signal</span><span class="p">[</span><span class="s1">&#39;regime&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Strategy Used: </span><span class="si">{</span><span class="n">signal</span><span class="p">[</span><span class="s1">&#39;strategy&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Signal: </span><span class="si">{</span><span class="n">signal</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;signal&#39;</span><span class="p">,</span> <span class="s1">&#39;N/A&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;confidence&#39;</span> <span class="ow">in</span> <span class="n">signal</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Confidence: </span><span class="si">{</span><span class="n">signal</span><span class="p">[</span><span class="s1">&#39;confidence&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=&#39;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>

<span class="n">system</span> <span class="o">=</span> <span class="n">MultiStrategySystem</span><span class="p">()</span>
<span class="n">system</span><span class="o">.</span><span class="n">generate_report</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>ğŸ“ Key Takeaways</h1>
<ol>
<li><strong>Trend Following</strong>: MA crossovers, breakouts - ride the trend</li>
<li><strong>Mean Reversion</strong>: RSI, Bollinger - fade extremes</li>
<li><strong>Momentum</strong>: Rank assets, buy winners</li>
<li><strong>Range Trading</strong>: Buy support, sell resistance</li>
<li><strong>Regime Detection</strong>: Use right strategy for market conditions</li>
</ol>
<hr />
<p><em>Next: Module 6 - Backtesting</em></p></div>
        <div class="nav-buttons">
            <button class="nav-btn prev-btn disabled" type="button">
                <span class="nav-btn-label">â† Previous</span>
                <span class="nav-btn-name"></span>
            </button>
            <button class="nav-btn next-btn disabled" type="button">
                <span class="nav-btn-label">Next â†’</span>
                <span class="nav-btn-name"></span>
            </button>
        </div>
        </div>
<div class="module-section" data-idx="6"><div class="md-cell module-header"><h1>Module 6: Backtesting Crypto Strategies</h1>
<h2>Part 2: Strategy Development</h2>
<hr />
<div class="table-wrapper"><table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>â±ï¸ <strong>Duration</strong></td>
<td>~2.5 hours</td>
</tr>
<tr>
<td>ğŸ“‹ <strong>Prerequisites</strong></td>
<td>Module 5</td>
</tr>
<tr>
<td>ğŸ’ª <strong>Exercises</strong></td>
<td>5 total</td>
</tr>
</tbody>
</table></div></div>
<div class="md-cell"><h2>ğŸ¯ Learning Objectives</h2>
<ul>
<li>Avoid common backtesting pitfalls</li>
<li>Build an event-driven backtester</li>
<li>Calculate proper performance metrics</li>
<li>Implement walk-forward optimization</li>
</ul></div>
<div class="md-cell"><hr />
<h1>Section 1: Backtesting Fundamentals</h1>
<h2>Common Pitfalls</h2>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Bias</th>
<th>Description</th>
<th>Solution</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Lookahead</strong></td>
<td>Using future data</td>
<td>Point-in-time data only</td>
</tr>
<tr>
<td><strong>Survivorship</strong></td>
<td>Only testing existing assets</td>
<td>Include delisted tokens</td>
</tr>
<tr>
<td><strong>Overfitting</strong></td>
<td>Curve-fitting to history</td>
<td>Out-of-sample testing</td>
</tr>
</tbody>
</table></div></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="c1"># Transaction costs in crypto</span>
<span class="k">class</span> <span class="nc">TransactionCosts</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">maker_fee</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">taker_fee</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">slippage</span><span class="o">=</span><span class="mf">0.001</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maker_fee</span> <span class="o">=</span> <span class="n">maker_fee</span>  <span class="c1"># 0.1%</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">taker_fee</span> <span class="o">=</span> <span class="n">taker_fee</span>  <span class="c1"># 0.1%</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slippage</span> <span class="o">=</span> <span class="n">slippage</span>    <span class="c1"># 0.1%</span>
    
    <span class="k">def</span> <span class="nf">calculate_cost</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trade_value</span><span class="p">,</span> <span class="n">order_type</span><span class="o">=</span><span class="s1">&#39;taker&#39;</span><span class="p">):</span>
        <span class="n">fee</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">taker_fee</span> <span class="k">if</span> <span class="n">order_type</span> <span class="o">==</span> <span class="s1">&#39;taker&#39;</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">maker_fee</span>
        <span class="n">total_cost</span> <span class="o">=</span> <span class="n">trade_value</span> <span class="o">*</span> <span class="p">(</span><span class="n">fee</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">slippage</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">total_cost</span>

<span class="n">costs</span> <span class="o">=</span> <span class="n">TransactionCosts</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Cost for $10,000 trade: $</span><span class="si">{</span><span class="n">costs</span><span class="o">.</span><span class="n">calculate_cost</span><span class="p">(</span><span class="mi">10000</span><span class="p">)</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h3>âœï¸ Exercise 6.1: Add Realistic Costs</h3>
<p>Create a function that calculates net returns after all costs.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="c1"># Exercise 6.1</span>
<span class="k">def</span> <span class="nf">calculate_net_returns</span><span class="p">(</span><span class="n">gross_pnl</span><span class="p">,</span> <span class="n">num_trades</span><span class="p">,</span> <span class="n">avg_trade_size</span><span class="p">,</span> <span class="n">costs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Calculate net returns after transaction costs.&quot;&quot;&quot;</span>
    <span class="c1"># TODO</span>
    <span class="k">pass</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">calculate_net_returns</span><span class="p">(</span><span class="n">gross_pnl</span><span class="p">,</span> <span class="n">num_trades</span><span class="p">,</span> <span class="n">avg_trade_size</span><span class="p">,</span> <span class="n">costs</span><span class="p">):</span>
    <span class="n">total_cost</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_trades</span><span class="p">):</span>
        <span class="c1"># Entry and exit costs</span>
        <span class="n">entry_cost</span> <span class="o">=</span> <span class="n">costs</span><span class="o">.</span><span class="n">calculate_cost</span><span class="p">(</span><span class="n">avg_trade_size</span><span class="p">)</span>
        <span class="n">exit_cost</span> <span class="o">=</span> <span class="n">costs</span><span class="o">.</span><span class="n">calculate_cost</span><span class="p">(</span><span class="n">avg_trade_size</span><span class="p">)</span>
        <span class="n">total_cost</span> <span class="o">+=</span> <span class="n">entry_cost</span> <span class="o">+</span> <span class="n">exit_cost</span>

    <span class="n">net_pnl</span> <span class="o">=</span> <span class="n">gross_pnl</span> <span class="o">-</span> <span class="n">total_cost</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;gross_pnl&#39;</span><span class="p">:</span> <span class="n">gross_pnl</span><span class="p">,</span>
        <span class="s1">&#39;total_costs&#39;</span><span class="p">:</span> <span class="n">total_cost</span><span class="p">,</span>
        <span class="s1">&#39;net_pnl&#39;</span><span class="p">:</span> <span class="n">net_pnl</span><span class="p">,</span>
        <span class="s1">&#39;cost_pct&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">total_cost</span> <span class="o">/</span> <span class="n">gross_pnl</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span> <span class="k">if</span> <span class="n">gross_pnl</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="p">}</span>

<span class="n">result</span> <span class="o">=</span> <span class="n">calculate_net_returns</span><span class="p">(</span><span class="mi">5000</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">10000</span><span class="p">,</span> <span class="n">costs</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Gross: $</span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;gross_pnl&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, Costs: $</span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;total_costs&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, Net: $</span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;net_pnl&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>Section 2: Building a Backtester</h1></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="k">class</span> <span class="nc">SimpleBacktester</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">initial_capital</span><span class="o">=</span><span class="mi">10000</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initial_capital</span> <span class="o">=</span> <span class="n">initial_capital</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">capital</span> <span class="o">=</span> <span class="n">initial_capital</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trades</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">equity_curve</span> <span class="o">=</span> <span class="p">[</span><span class="n">initial_capital</span><span class="p">]</span>
    
    <span class="k">def</span> <span class="nf">buy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">price</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">capital</span> <span class="o">/</span> <span class="n">price</span>
        <span class="n">cost</span> <span class="o">=</span> <span class="n">size</span> <span class="o">*</span> <span class="n">price</span> <span class="o">*</span> <span class="mf">1.001</span>  <span class="c1"># Include 0.1% fee</span>
        <span class="k">if</span> <span class="n">cost</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">capital</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">capital</span> <span class="o">-=</span> <span class="n">cost</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">+=</span> <span class="n">size</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trades</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;BUY&#39;</span><span class="p">,</span> <span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="n">price</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="n">size</span><span class="p">})</span>
    
    <span class="k">def</span> <span class="nf">sell</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">price</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">position</span>
        <span class="k">if</span> <span class="n">size</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">position</span><span class="p">:</span>
            <span class="n">revenue</span> <span class="o">=</span> <span class="n">size</span> <span class="o">*</span> <span class="n">price</span> <span class="o">*</span> <span class="mf">0.999</span>  <span class="c1"># Include 0.1% fee</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">capital</span> <span class="o">+=</span> <span class="n">revenue</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">-=</span> <span class="n">size</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trades</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;SELL&#39;</span><span class="p">,</span> <span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="n">price</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="n">size</span><span class="p">})</span>
    
    <span class="k">def</span> <span class="nf">update_equity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current_price</span><span class="p">):</span>
        <span class="n">equity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">capital</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">*</span> <span class="n">current_price</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">equity_curve</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">equity</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">get_results</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">final_equity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">equity_curve</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">total_return</span> <span class="o">=</span> <span class="p">(</span><span class="n">final_equity</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_capital</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_capital</span> <span class="o">*</span> <span class="mi">100</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;final_equity&#39;</span><span class="p">:</span> <span class="n">final_equity</span><span class="p">,</span>
            <span class="s1">&#39;total_return&#39;</span><span class="p">:</span> <span class="n">total_return</span><span class="p">,</span>
            <span class="s1">&#39;num_trades&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trades</span><span class="p">)</span>
        <span class="p">}</span>
</code></pre></div>
<div class="md-cell"><h3>âœï¸ Exercise 6.2: Complete Backtester</h3>
<p>Extend the backtester with position tracking and trade logging.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="c1"># Exercise 6.2</span>
<span class="k">class</span> <span class="nc">CryptoBacktester</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">initial_capital</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span> <span class="n">fee</span><span class="o">=</span><span class="mf">0.001</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initial_capital</span> <span class="o">=</span> <span class="n">initial_capital</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fee</span> <span class="o">=</span> <span class="n">fee</span>
        <span class="c1"># TODO: Initialize tracking variables</span>
    
    <span class="k">def</span> <span class="nf">run_backtest</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prices</span><span class="p">,</span> <span class="n">signals</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Run backtest given prices and signals list.&quot;&quot;&quot;</span>
        <span class="c1"># TODO</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">calculate_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># TODO: Return performance metrics</span>
        <span class="k">pass</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">CryptoBacktester</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">initial_capital</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span> <span class="n">fee</span><span class="o">=</span><span class="mf">0.001</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initial_capital</span> <span class="o">=</span> <span class="n">initial_capital</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fee</span> <span class="o">=</span> <span class="n">fee</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">capital</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_capital</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">entry_price</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trades</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">equity_curve</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">run_backtest</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prices</span><span class="p">,</span> <span class="n">signals</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">price</span><span class="p">,</span> <span class="n">signal</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">prices</span><span class="p">,</span> <span class="n">signals</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">signal</span> <span class="o">==</span> <span class="s1">&#39;BUY&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">capital</span> <span class="o">*</span> <span class="mf">0.95</span><span class="p">)</span> <span class="o">/</span> <span class="n">price</span>  <span class="c1"># Use 95% of capital</span>
                <span class="n">cost</span> <span class="o">=</span> <span class="n">size</span> <span class="o">*</span> <span class="n">price</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">fee</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">capital</span> <span class="o">-=</span> <span class="n">cost</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="n">size</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">entry_price</span> <span class="o">=</span> <span class="n">price</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">trades</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;BUY&#39;</span><span class="p">,</span> <span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="n">price</span><span class="p">,</span> <span class="s1">&#39;i&#39;</span><span class="p">:</span> <span class="n">i</span><span class="p">})</span>

            <span class="k">elif</span> <span class="n">signal</span> <span class="o">==</span> <span class="s1">&#39;SELL&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">revenue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">*</span> <span class="n">price</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">fee</span><span class="p">)</span>
                <span class="n">pnl</span> <span class="o">=</span> <span class="n">revenue</span> <span class="o">-</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">entry_price</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">capital</span> <span class="o">+=</span> <span class="n">revenue</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">trades</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;SELL&#39;</span><span class="p">,</span> <span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="n">price</span><span class="p">,</span> <span class="s1">&#39;pnl&#39;</span><span class="p">:</span> <span class="n">pnl</span><span class="p">,</span> <span class="s1">&#39;i&#39;</span><span class="p">:</span> <span class="n">i</span><span class="p">})</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="n">equity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">capital</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">*</span> <span class="n">price</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">equity_curve</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">equity</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_metrics</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">calculate_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">equity</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">equity_curve</span><span class="p">)</span>
        <span class="n">returns</span> <span class="o">=</span> <span class="n">equity</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

        <span class="n">total_return</span> <span class="o">=</span> <span class="p">(</span><span class="n">equity</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_capital</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_capital</span> <span class="o">*</span> <span class="mi">100</span>
        <span class="n">max_dd</span> <span class="o">=</span> <span class="p">((</span><span class="n">equity</span><span class="o">.</span><span class="n">cummax</span><span class="p">()</span> <span class="o">-</span> <span class="n">equity</span><span class="p">)</span> <span class="o">/</span> <span class="n">equity</span><span class="o">.</span><span class="n">cummax</span><span class="p">())</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">*</span> <span class="mi">100</span>
        <span class="n">sharpe</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">/</span> <span class="n">returns</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">365</span><span class="p">)</span> <span class="k">if</span> <span class="n">returns</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>

        <span class="n">wins</span> <span class="o">=</span> <span class="nb">len</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trades</span> <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pnl&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">])</span>
        <span class="n">total</span> <span class="o">=</span> <span class="nb">len</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trades</span> <span class="k">if</span> <span class="s1">&#39;pnl&#39;</span> <span class="ow">in</span> <span class="n">t</span><span class="p">])</span>
        <span class="n">win_rate</span> <span class="o">=</span> <span class="n">wins</span> <span class="o">/</span> <span class="n">total</span> <span class="o">*</span> <span class="mi">100</span> <span class="k">if</span> <span class="n">total</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;total_return&#39;</span><span class="p">:</span> <span class="n">total_return</span><span class="p">,</span>
            <span class="s1">&#39;max_drawdown&#39;</span><span class="p">:</span> <span class="n">max_dd</span><span class="p">,</span>
            <span class="s1">&#39;sharpe_ratio&#39;</span><span class="p">:</span> <span class="n">sharpe</span><span class="p">,</span>
            <span class="s1">&#39;num_trades&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trades</span><span class="p">),</span>
            <span class="s1">&#39;win_rate&#39;</span><span class="p">:</span> <span class="n">win_rate</span>
        <span class="p">}</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>Section 3: Performance Metrics</h1></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="k">def</span> <span class="nf">calculate_performance_metrics</span><span class="p">(</span><span class="n">equity_curve</span><span class="p">,</span> <span class="n">risk_free_rate</span><span class="o">=</span><span class="mf">0.02</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Calculate comprehensive performance metrics.&quot;&quot;&quot;</span>
    <span class="n">equity</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">equity_curve</span><span class="p">)</span>
    <span class="n">returns</span> <span class="o">=</span> <span class="n">equity</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
    
    <span class="c1"># Total Return</span>
    <span class="n">total_return</span> <span class="o">=</span> <span class="p">(</span><span class="n">equity</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">equity</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
    
    <span class="c1"># Sharpe Ratio (annualized)</span>
    <span class="n">excess_returns</span> <span class="o">=</span> <span class="n">returns</span> <span class="o">-</span> <span class="n">risk_free_rate</span><span class="o">/</span><span class="mi">365</span>
    <span class="n">sharpe</span> <span class="o">=</span> <span class="n">excess_returns</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">/</span> <span class="n">returns</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">365</span><span class="p">)</span> <span class="k">if</span> <span class="n">returns</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
    
    <span class="c1"># Sortino Ratio (downside risk only)</span>
    <span class="n">downside</span> <span class="o">=</span> <span class="n">returns</span><span class="p">[</span><span class="n">returns</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">sortino</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">/</span> <span class="n">downside</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">365</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">downside</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
    
    <span class="c1"># Maximum Drawdown</span>
    <span class="n">rolling_max</span> <span class="o">=</span> <span class="n">equity</span><span class="o">.</span><span class="n">cummax</span><span class="p">()</span>
    <span class="n">drawdown</span> <span class="o">=</span> <span class="p">(</span><span class="n">equity</span> <span class="o">-</span> <span class="n">rolling_max</span><span class="p">)</span> <span class="o">/</span> <span class="n">rolling_max</span>
    <span class="n">max_dd</span> <span class="o">=</span> <span class="n">drawdown</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">*</span> <span class="mi">100</span>
    
    <span class="c1"># Calmar Ratio</span>
    <span class="n">calmar</span> <span class="o">=</span> <span class="n">total_return</span> <span class="o">/</span> <span class="nb">abs</span><span class="p">(</span><span class="n">max_dd</span><span class="p">)</span> <span class="k">if</span> <span class="n">max_dd</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
    
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;total_return&#39;</span><span class="p">:</span> <span class="n">total_return</span><span class="p">,</span>
        <span class="s1">&#39;sharpe_ratio&#39;</span><span class="p">:</span> <span class="n">sharpe</span><span class="p">,</span>
        <span class="s1">&#39;sortino_ratio&#39;</span><span class="p">:</span> <span class="n">sortino</span><span class="p">,</span>
        <span class="s1">&#39;max_drawdown&#39;</span><span class="p">:</span> <span class="n">max_dd</span><span class="p">,</span>
        <span class="s1">&#39;calmar_ratio&#39;</span><span class="p">:</span> <span class="n">calmar</span>
    <span class="p">}</span>
</code></pre></div>
<div class="md-cell"><h3>âœï¸ Exercise 6.3: Performance Report</h3>
<p>Create a formatted performance report generator.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="c1"># Exercise 6.3</span>
<span class="k">def</span> <span class="nf">generate_performance_report</span><span class="p">(</span><span class="n">metrics</span><span class="p">,</span> <span class="n">trades</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Generate formatted performance report.&quot;&quot;&quot;</span>
    <span class="c1"># TODO</span>
    <span class="k">pass</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">generate_performance_report</span><span class="p">(</span><span class="n">metrics</span><span class="p">,</span> <span class="n">trades</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=&#39;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;           BACKTEST PERFORMANCE REPORT&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=&#39;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">RETURNS&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Total Return: </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;total_return&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Max Drawdown: </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;max_drawdown&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">RISK-ADJUSTED&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Sharpe Ratio: </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;sharpe_ratio&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Sortino Ratio: </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;sortino_ratio&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Calmar Ratio: </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;calmar_ratio&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">TRADING&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Total Trades: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">trades</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">trades</span><span class="p">:</span>
        <span class="n">pnls</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pnl&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">trades</span> <span class="k">if</span> <span class="s1">&#39;pnl&#39;</span> <span class="ow">in</span> <span class="n">t</span><span class="p">]</span>
        <span class="n">wins</span> <span class="o">=</span> <span class="nb">len</span><span class="p">([</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pnls</span> <span class="k">if</span> <span class="n">p</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">])</span>
        <span class="n">win_rate</span> <span class="o">=</span> <span class="n">wins</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">pnls</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span> <span class="k">if</span> <span class="n">pnls</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="n">avg_win</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pnls</span> <span class="k">if</span> <span class="n">p</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">p</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pnls</span><span class="p">)</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="n">avg_loss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pnls</span> <span class="k">if</span> <span class="n">p</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">p</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pnls</span><span class="p">)</span> <span class="k">else</span> <span class="mi">0</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Win Rate: </span><span class="si">{</span><span class="n">win_rate</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Avg Win: $</span><span class="si">{</span><span class="n">avg_win</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Avg Loss: $</span><span class="si">{</span><span class="n">avg_loss</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=&#39;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>Section 4: Walk-Forward Optimization</h1></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="k">def</span> <span class="nf">walk_forward_test</span><span class="p">(</span><span class="n">prices</span><span class="p">,</span> <span class="n">strategy_func</span><span class="p">,</span> <span class="n">train_size</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mi">30</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Walk-forward optimization.</span>
<span class="sd">    </span>
<span class="sd">    Train on &#39;train_size&#39; periods, test on next &#39;test_size&#39; periods.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">+</span> <span class="n">train_size</span> <span class="o">+</span> <span class="n">test_size</span> <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">prices</span><span class="p">):</span>
        <span class="c1"># Training period</span>
        <span class="n">train_data</span> <span class="o">=</span> <span class="n">prices</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">train_size</span><span class="p">]</span>
        <span class="c1"># Testing period</span>
        <span class="n">test_data</span> <span class="o">=</span> <span class="n">prices</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="n">train_size</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">train_size</span><span class="o">+</span><span class="n">test_size</span><span class="p">]</span>
        
        <span class="c1"># Optimize on training data (simplified)</span>
        <span class="n">best_params</span> <span class="o">=</span> <span class="n">strategy_func</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span><span class="n">train_data</span><span class="p">)</span>
        
        <span class="c1"># Test with optimized params</span>
        <span class="n">test_return</span> <span class="o">=</span> <span class="n">strategy_func</span><span class="o">.</span><span class="n">backtest</span><span class="p">(</span><span class="n">test_data</span><span class="p">,</span> <span class="n">best_params</span><span class="p">)</span>
        
        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;period&#39;</span><span class="p">:</span> <span class="n">i</span><span class="p">,</span>
            <span class="s1">&#39;train_end&#39;</span><span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="n">train_size</span><span class="p">,</span>
            <span class="s1">&#39;test_return&#39;</span><span class="p">:</span> <span class="n">test_return</span><span class="p">,</span>
            <span class="s1">&#39;params&#39;</span><span class="p">:</span> <span class="n">best_params</span>
        <span class="p">})</span>
        
        <span class="n">i</span> <span class="o">+=</span> <span class="n">test_size</span>  <span class="c1"># Move forward</span>
    
    <span class="k">return</span> <span class="n">results</span>
</code></pre></div>
<div class="md-cell"><h3>âœï¸ Exercise 6.4: Walk-Forward Backtester</h3>
<p>Implement a complete walk-forward testing system.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="c1"># Exercise 6.4</span>
<span class="k">class</span> <span class="nc">WalkForwardBacktester</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">train_pct</span><span class="o">=</span><span class="mf">0.7</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_pct</span> <span class="o">=</span> <span class="n">train_pct</span>
    
    <span class="k">def</span> <span class="nf">split_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prices</span><span class="p">):</span>
        <span class="c1"># TODO</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">run_walk_forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prices</span><span class="p">,</span> <span class="n">param_ranges</span><span class="p">):</span>
        <span class="c1"># TODO</span>
        <span class="k">pass</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">WalkForwardBacktester</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">train_pct</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">n_splits</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_pct</span> <span class="o">=</span> <span class="n">train_pct</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_splits</span> <span class="o">=</span> <span class="n">n_splits</span>

    <span class="k">def</span> <span class="nf">split_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prices</span><span class="p">):</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span>
        <span class="n">split_size</span> <span class="o">=</span> <span class="n">n</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_splits</span>

        <span class="n">splits</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_splits</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">train_end</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">split_size</span>
            <span class="n">test_end</span> <span class="o">=</span> <span class="nb">min</span><span class="p">((</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">split_size</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>

            <span class="n">train</span> <span class="o">=</span> <span class="n">prices</span><span class="p">[:</span><span class="n">train_end</span><span class="p">]</span>
            <span class="n">test</span> <span class="o">=</span> <span class="n">prices</span><span class="p">[</span><span class="n">train_end</span><span class="p">:</span><span class="n">test_end</span><span class="p">]</span>
            <span class="n">splits</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">train</span><span class="p">,</span> <span class="n">test</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">splits</span>

    <span class="k">def</span> <span class="nf">run_walk_forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prices</span><span class="p">,</span> <span class="n">strategy</span><span class="p">,</span> <span class="n">param_grid</span><span class="p">):</span>
        <span class="n">splits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_data</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">train</span><span class="p">,</span> <span class="n">test</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">splits</span><span class="p">):</span>
            <span class="c1"># Find best params on training data</span>
            <span class="n">best_return</span> <span class="o">=</span> <span class="o">-</span><span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
            <span class="n">best_params</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">for</span> <span class="n">params</span> <span class="ow">in</span> <span class="n">param_grid</span><span class="p">:</span>
                <span class="n">ret</span> <span class="o">=</span> <span class="n">strategy</span><span class="o">.</span><span class="n">backtest</span><span class="p">(</span><span class="n">train</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">ret</span> <span class="o">&gt;</span> <span class="n">best_return</span><span class="p">:</span>
                    <span class="n">best_return</span> <span class="o">=</span> <span class="n">ret</span>
                    <span class="n">best_params</span> <span class="o">=</span> <span class="n">params</span>

            <span class="c1"># Test with best params</span>
            <span class="n">test_return</span> <span class="o">=</span> <span class="n">strategy</span><span class="o">.</span><span class="n">backtest</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">best_params</span><span class="p">)</span>

            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;split&#39;</span><span class="p">:</span> <span class="n">i</span><span class="p">,</span>
                <span class="s1">&#39;train_return&#39;</span><span class="p">:</span> <span class="n">best_return</span><span class="p">,</span>
                <span class="s1">&#39;test_return&#39;</span><span class="p">:</span> <span class="n">test_return</span><span class="p">,</span>
                <span class="s1">&#39;params&#39;</span><span class="p">:</span> <span class="n">best_params</span>
            <span class="p">})</span>

        <span class="k">return</span> <span class="n">results</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>ğŸ—ï¸ Module Project: Complete Backtesting Framework</h1>
<p>Build a full backtesting system with all components.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="c1"># Module Project</span>
<span class="k">class</span> <span class="nc">BacktestingFramework</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">backtester</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="kc">None</span>
    
    <span class="k">def</span> <span class="nf">backtest_strategy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prices</span><span class="p">,</span> <span class="n">strategy</span><span class="p">):</span>
        <span class="c1"># TODO</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">optimize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prices</span><span class="p">,</span> <span class="n">strategy</span><span class="p">,</span> <span class="n">param_grid</span><span class="p">):</span>
        <span class="c1"># TODO</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">full_report</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># TODO</span>
        <span class="k">pass</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">BacktestingFramework</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">initial_capital</span><span class="o">=</span><span class="mi">10000</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">backtester</span> <span class="o">=</span> <span class="n">CryptoBacktester</span><span class="p">(</span><span class="n">initial_capital</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">equity_curve</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">backtest_strategy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prices</span><span class="p">,</span> <span class="n">strategy</span><span class="p">):</span>
        <span class="n">signals</span> <span class="o">=</span> <span class="p">[</span><span class="n">strategy</span><span class="o">.</span><span class="n">generate_signal</span><span class="p">(</span><span class="n">prices</span><span class="p">[:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;signal&#39;</span><span class="p">,</span> <span class="s1">&#39;HOLD&#39;</span><span class="p">)</span> 
                   <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">prices</span><span class="p">))]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">backtester</span><span class="o">.</span><span class="n">run_backtest</span><span class="p">(</span><span class="n">prices</span><span class="p">,</span> <span class="n">signals</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">equity_curve</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">backtester</span><span class="o">.</span><span class="n">equity_curve</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span>

    <span class="k">def</span> <span class="nf">optimize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prices</span><span class="p">,</span> <span class="n">strategy_class</span><span class="p">,</span> <span class="n">param_grid</span><span class="p">):</span>
        <span class="n">best_result</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">best_params</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">for</span> <span class="n">params</span> <span class="ow">in</span> <span class="n">param_grid</span><span class="p">:</span>
            <span class="n">strategy</span> <span class="o">=</span> <span class="n">strategy_class</span><span class="p">(</span><span class="o">**</span><span class="n">params</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">backtest_strategy</span><span class="p">(</span><span class="n">prices</span><span class="p">,</span> <span class="n">strategy</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">best_result</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;sharpe_ratio&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">best_result</span><span class="p">[</span><span class="s1">&#39;sharpe_ratio&#39;</span><span class="p">]:</span>
                <span class="n">best_result</span> <span class="o">=</span> <span class="n">result</span>
                <span class="n">best_params</span> <span class="o">=</span> <span class="n">params</span>

        <span class="k">return</span> <span class="n">best_params</span><span class="p">,</span> <span class="n">best_result</span>

    <span class="k">def</span> <span class="nf">full_report</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No backtest results available&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">metrics</span> <span class="o">=</span> <span class="n">calculate_performance_metrics</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">equity_curve</span><span class="p">)</span>
        <span class="n">generate_performance_report</span><span class="p">(</span><span class="n">metrics</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">backtester</span><span class="o">.</span><span class="n">trades</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>ğŸ“ Key Takeaways</h1>
<ol>
<li><strong>Avoid Biases</strong>: Lookahead, survivorship, overfitting</li>
<li><strong>Include Costs</strong>: Fees + slippage significantly impact results</li>
<li><strong>Key Metrics</strong>: Sharpe, Sortino, Max Drawdown, Win Rate</li>
<li><strong>Walk-Forward</strong>: Prevents overfitting to historical data</li>
</ol>
<hr />
<p><em>Next: Module 7 - Risk Management</em></p></div>
        <div class="nav-buttons">
            <button class="nav-btn prev-btn disabled" type="button">
                <span class="nav-btn-label">â† Previous</span>
                <span class="nav-btn-name"></span>
            </button>
            <button class="nav-btn next-btn disabled" type="button">
                <span class="nav-btn-label">Next â†’</span>
                <span class="nav-btn-name"></span>
            </button>
        </div>
        </div>
<div class="module-section" data-idx="7"><div class="md-cell module-header"><h1>Module 7: Risk Management</h1>
<h2>Part 2: Strategy Development</h2>
<hr />
<div class="table-wrapper"><table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>â±ï¸ <strong>Duration</strong></td>
<td>~2.5 hours</td>
</tr>
<tr>
<td>ğŸ“‹ <strong>Prerequisites</strong></td>
<td>Module 6</td>
</tr>
<tr>
<td>ğŸ’ª <strong>Exercises</strong></td>
<td>5 total</td>
</tr>
</tbody>
</table></div></div>
<div class="md-cell"><h2>ğŸ¯ Learning Objectives</h2>
<ul>
<li>Implement position sizing methods</li>
<li>Build stop loss systems</li>
<li>Manage portfolio-level risk</li>
<li>Handle exchange-specific risks</li>
</ul></div>
<div class="md-cell"><hr />
<h1>Section 1: Position Sizing</h1>
<h2>1.1 Fixed Amount</h2></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="k">def</span> <span class="nf">fixed_amount_size</span><span class="p">(</span><span class="n">capital</span><span class="p">,</span> <span class="n">fixed_usd</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Trade a fixed USD amount.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">fixed_usd</span><span class="p">,</span> <span class="n">capital</span> <span class="o">*</span> <span class="mf">0.95</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Position: $</span><span class="si">{</span><span class="n">fixed_amount_size</span><span class="p">(</span><span class="mi">10000</span><span class="p">)</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h2>1.2 Percent of Portfolio</h2></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="k">def</span> <span class="nf">percent_size</span><span class="p">(</span><span class="n">capital</span><span class="p">,</span> <span class="n">percent</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Trade a percentage of portfolio.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">capital</span> <span class="o">*</span> <span class="n">percent</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;10% of $10,000: $</span><span class="si">{</span><span class="n">percent_size</span><span class="p">(</span><span class="mi">10000</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h2>1.3 Volatility-Adjusted (ATR-based)</h2></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="k">def</span> <span class="nf">atr</span><span class="p">(</span><span class="n">high</span><span class="p">,</span> <span class="n">low</span><span class="p">,</span> <span class="n">close</span><span class="p">,</span> <span class="n">period</span><span class="o">=</span><span class="mi">14</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Calculate Average True Range.&quot;&quot;&quot;</span>
    <span class="n">high</span><span class="p">,</span> <span class="n">low</span><span class="p">,</span> <span class="n">close</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">high</span><span class="p">),</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">low</span><span class="p">),</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">close</span><span class="p">)</span>
    <span class="n">tr1</span> <span class="o">=</span> <span class="n">high</span> <span class="o">-</span> <span class="n">low</span>
    <span class="n">tr2</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">high</span> <span class="o">-</span> <span class="n">close</span><span class="o">.</span><span class="n">shift</span><span class="p">())</span>
    <span class="n">tr3</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">low</span> <span class="o">-</span> <span class="n">close</span><span class="o">.</span><span class="n">shift</span><span class="p">())</span>
    <span class="n">tr</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">tr1</span><span class="p">,</span> <span class="n">tr2</span><span class="p">,</span> <span class="n">tr3</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">tr</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">period</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">volatility_adjusted_size</span><span class="p">(</span><span class="n">capital</span><span class="p">,</span> <span class="n">price</span><span class="p">,</span> <span class="n">atr_value</span><span class="p">,</span> <span class="n">risk_pct</span><span class="o">=</span><span class="mf">0.02</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Size position based on volatility.&quot;&quot;&quot;</span>
    <span class="n">risk_amount</span> <span class="o">=</span> <span class="n">capital</span> <span class="o">*</span> <span class="n">risk_pct</span>
    <span class="n">position_size</span> <span class="o">=</span> <span class="n">risk_amount</span> <span class="o">/</span> <span class="n">atr_value</span>
    <span class="n">position_value</span> <span class="o">=</span> <span class="n">position_size</span> <span class="o">*</span> <span class="n">price</span>
    <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">position_value</span><span class="p">,</span> <span class="n">capital</span> <span class="o">*</span> <span class="mf">0.25</span><span class="p">)</span>  <span class="c1"># Max 25% in one position</span>

<span class="c1"># Example</span>
<span class="n">capital</span> <span class="o">=</span> <span class="mi">10000</span>
<span class="n">price</span> <span class="o">=</span> <span class="mi">43000</span>
<span class="n">atr_val</span> <span class="o">=</span> <span class="mi">1500</span>  <span class="c1"># $1500 ATR</span>
<span class="n">size</span> <span class="o">=</span> <span class="n">volatility_adjusted_size</span><span class="p">(</span><span class="n">capital</span><span class="p">,</span> <span class="n">price</span><span class="p">,</span> <span class="n">atr_val</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Position size: $</span><span class="si">{</span><span class="n">size</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h2>1.4 Kelly Criterion</h2></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="k">def</span> <span class="nf">kelly_criterion</span><span class="p">(</span><span class="n">win_rate</span><span class="p">,</span> <span class="n">avg_win</span><span class="p">,</span> <span class="n">avg_loss</span><span class="p">,</span> <span class="n">kelly_fraction</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Calculate Kelly optimal position size.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">avg_loss</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>
    
    <span class="n">b</span> <span class="o">=</span> <span class="n">avg_win</span> <span class="o">/</span> <span class="nb">abs</span><span class="p">(</span><span class="n">avg_loss</span><span class="p">)</span>  <span class="c1"># Win/loss ratio</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">win_rate</span>
    <span class="n">q</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">win_rate</span>
    
    <span class="n">kelly</span> <span class="o">=</span> <span class="p">(</span><span class="n">b</span> <span class="o">*</span> <span class="n">p</span> <span class="o">-</span> <span class="n">q</span><span class="p">)</span> <span class="o">/</span> <span class="n">b</span>
    
    <span class="c1"># Use fractional Kelly (safer)</span>
    <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">kelly</span> <span class="o">*</span> <span class="n">kelly_fraction</span><span class="p">)</span>

<span class="c1"># Example: 55% win rate, avg win $200, avg loss $150</span>
<span class="n">kelly</span> <span class="o">=</span> <span class="n">kelly_criterion</span><span class="p">(</span><span class="mf">0.55</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">150</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Kelly suggests: </span><span class="si">{</span><span class="n">kelly</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">% of capital&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h3>âœï¸ Exercise 7.1: Position Sizer</h3>
<p>Create a comprehensive position sizing class.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="c1"># Exercise 7.1</span>
<span class="k">class</span> <span class="nc">PositionSizer</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">capital</span><span class="p">,</span> <span class="n">max_risk_pct</span><span class="o">=</span><span class="mf">0.02</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">capital</span> <span class="o">=</span> <span class="n">capital</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_risk_pct</span> <span class="o">=</span> <span class="n">max_risk_pct</span>
    
    <span class="k">def</span> <span class="nf">fixed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
        <span class="c1"># TODO</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">percent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pct</span><span class="p">):</span>
        <span class="c1"># TODO</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">volatility_adjusted</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">price</span><span class="p">,</span> <span class="n">atr</span><span class="p">):</span>
        <span class="c1"># TODO</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">recommend</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">price</span><span class="p">,</span> <span class="n">atr</span><span class="p">,</span> <span class="n">win_rate</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">avg_win</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">avg_loss</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># TODO: Return recommended size with reasoning</span>
        <span class="k">pass</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">PositionSizer</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">capital</span><span class="p">,</span> <span class="n">max_risk_pct</span><span class="o">=</span><span class="mf">0.02</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">capital</span> <span class="o">=</span> <span class="n">capital</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_risk_pct</span> <span class="o">=</span> <span class="n">max_risk_pct</span>

    <span class="k">def</span> <span class="nf">fixed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">amount</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">capital</span> <span class="o">*</span> <span class="mf">0.95</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">percent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pct</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">capital</span> <span class="o">*</span> <span class="n">pct</span>

    <span class="k">def</span> <span class="nf">volatility_adjusted</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">price</span><span class="p">,</span> <span class="n">atr_val</span><span class="p">):</span>
        <span class="n">risk_amount</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">capital</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_risk_pct</span>
        <span class="n">size</span> <span class="o">=</span> <span class="n">risk_amount</span> <span class="o">/</span> <span class="n">atr_val</span>
        <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">size</span> <span class="o">*</span> <span class="n">price</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">capital</span> <span class="o">*</span> <span class="mf">0.25</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">recommend</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">price</span><span class="p">,</span> <span class="n">atr_val</span><span class="p">,</span> <span class="n">win_rate</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">avg_win</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">avg_loss</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">sizes</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;fixed_1k&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">fixed</span><span class="p">(</span><span class="mi">1000</span><span class="p">),</span>
            <span class="s1">&#39;percent_10&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">percent</span><span class="p">(</span><span class="mf">0.10</span><span class="p">),</span>
            <span class="s1">&#39;volatility&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">volatility_adjusted</span><span class="p">(</span><span class="n">price</span><span class="p">,</span> <span class="n">atr_val</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="nb">all</span><span class="p">([</span><span class="n">win_rate</span><span class="p">,</span> <span class="n">avg_win</span><span class="p">,</span> <span class="n">avg_loss</span><span class="p">]):</span>
            <span class="n">kelly</span> <span class="o">=</span> <span class="n">kelly_criterion</span><span class="p">(</span><span class="n">win_rate</span><span class="p">,</span> <span class="n">avg_win</span><span class="p">,</span> <span class="n">avg_loss</span><span class="p">)</span>
            <span class="n">sizes</span><span class="p">[</span><span class="s1">&#39;kelly&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">capital</span> <span class="o">*</span> <span class="n">kelly</span>

        <span class="c1"># Recommend most conservative</span>
        <span class="n">recommended</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">sizes</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;recommended&#39;</span><span class="p">:</span> <span class="n">recommended</span><span class="p">,</span>
            <span class="s1">&#39;all_methods&#39;</span><span class="p">:</span> <span class="n">sizes</span><span class="p">,</span>
            <span class="s1">&#39;max_position&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">capital</span> <span class="o">*</span> <span class="mf">0.25</span>
        <span class="p">}</span>

<span class="n">sizer</span> <span class="o">=</span> <span class="n">PositionSizer</span><span class="p">(</span><span class="mi">10000</span><span class="p">)</span>
<span class="n">rec</span> <span class="o">=</span> <span class="n">sizer</span><span class="o">.</span><span class="n">recommend</span><span class="p">(</span><span class="mi">43000</span><span class="p">,</span> <span class="mi">1500</span><span class="p">,</span> <span class="mf">0.55</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">150</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Recommended: $</span><span class="si">{</span><span class="n">rec</span><span class="p">[</span><span class="s1">&#39;recommended&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>Section 2: Stop Losses</h1></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">StopLossManager</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stops</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="k">def</span> <span class="nf">fixed_percent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entry_price</span><span class="p">,</span> <span class="n">percent</span><span class="o">=</span><span class="mf">0.05</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Fixed percentage stop.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">entry_price</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">percent</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">atr_based</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entry_price</span><span class="p">,</span> <span class="n">atr_value</span><span class="p">,</span> <span class="n">multiplier</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;ATR-based stop.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">entry_price</span> <span class="o">-</span> <span class="p">(</span><span class="n">atr_value</span> <span class="o">*</span> <span class="n">multiplier</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">trailing_stop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current_price</span><span class="p">,</span> <span class="n">highest_price</span><span class="p">,</span> <span class="n">trail_pct</span><span class="o">=</span><span class="mf">0.05</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Trailing stop that follows price up.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">highest_price</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">trail_pct</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">check_stop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current_price</span><span class="p">,</span> <span class="n">stop_price</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check if stop is triggered.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">current_price</span> <span class="o">&lt;=</span> <span class="n">stop_price</span>

<span class="n">stop_mgr</span> <span class="o">=</span> <span class="n">StopLossManager</span><span class="p">()</span>
<span class="n">entry</span> <span class="o">=</span> <span class="mi">43000</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;5% Stop: $</span><span class="si">{</span><span class="n">stop_mgr</span><span class="o">.</span><span class="n">fixed_percent</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">)</span><span class="si">:</span><span class="s1">,.0f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;ATR Stop: $</span><span class="si">{</span><span class="n">stop_mgr</span><span class="o">.</span><span class="n">atr_based</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="mi">1500</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="si">:</span><span class="s1">,.0f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h3>âœï¸ Exercise 7.2: Stop Loss System</h3>
<p>Build a comprehensive stop loss system with multiple stop types.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="c1"># Exercise 7.2</span>
<span class="k">class</span> <span class="nc">StopLossSystem</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">positions</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="k">def</span> <span class="nf">add_position</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">entry_price</span><span class="p">,</span> <span class="n">stop_type</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># TODO</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">update_trailing_stops</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">current_price</span><span class="p">):</span>
        <span class="c1"># TODO</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">check_all_stops</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prices</span><span class="p">):</span>
        <span class="c1"># TODO: Return list of triggered stops</span>
        <span class="k">pass</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">StopLossSystem</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">positions</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">add_position</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">entry_price</span><span class="p">,</span> <span class="n">stop_type</span><span class="o">=</span><span class="s1">&#39;percent&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">stop_type</span> <span class="o">==</span> <span class="s1">&#39;percent&#39;</span><span class="p">:</span>
            <span class="n">stop</span> <span class="o">=</span> <span class="n">entry_price</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pct&#39;</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">stop_type</span> <span class="o">==</span> <span class="s1">&#39;atr&#39;</span><span class="p">:</span>
            <span class="n">stop</span> <span class="o">=</span> <span class="n">entry_price</span> <span class="o">-</span> <span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;atr&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;mult&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">stop_type</span> <span class="o">==</span> <span class="s1">&#39;trailing&#39;</span><span class="p">:</span>
            <span class="n">stop</span> <span class="o">=</span> <span class="n">entry_price</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;trail_pct&#39;</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">stop</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;price&#39;</span><span class="p">,</span> <span class="n">entry_price</span> <span class="o">*</span> <span class="mf">0.95</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;entry&#39;</span><span class="p">:</span> <span class="n">entry_price</span><span class="p">,</span>
            <span class="s1">&#39;stop&#39;</span><span class="p">:</span> <span class="n">stop</span><span class="p">,</span>
            <span class="s1">&#39;highest&#39;</span><span class="p">:</span> <span class="n">entry_price</span><span class="p">,</span>
            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="n">stop_type</span><span class="p">,</span>
            <span class="s1">&#39;params&#39;</span><span class="p">:</span> <span class="n">kwargs</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">update_trailing_stops</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">current_price</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">symbol</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">pos</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;trailing&#39;</span> <span class="ow">and</span> <span class="n">current_price</span> <span class="o">&gt;</span> <span class="n">pos</span><span class="p">[</span><span class="s1">&#39;highest&#39;</span><span class="p">]:</span>
            <span class="n">pos</span><span class="p">[</span><span class="s1">&#39;highest&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_price</span>
            <span class="n">trail_pct</span> <span class="o">=</span> <span class="n">pos</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;trail_pct&#39;</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">)</span>
            <span class="n">pos</span><span class="p">[</span><span class="s1">&#39;stop&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_price</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">trail_pct</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">check_all_stops</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prices</span><span class="p">):</span>
        <span class="n">triggered</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">pos</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="n">prices</span><span class="p">:</span>
                <span class="n">current</span> <span class="o">=</span> <span class="n">prices</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">update_trailing_stops</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">current</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">current</span> <span class="o">&lt;=</span> <span class="n">pos</span><span class="p">[</span><span class="s1">&#39;stop&#39;</span><span class="p">]:</span>
                    <span class="n">triggered</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                        <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span>
                        <span class="s1">&#39;entry&#39;</span><span class="p">:</span> <span class="n">pos</span><span class="p">[</span><span class="s1">&#39;entry&#39;</span><span class="p">],</span>
                        <span class="s1">&#39;stop&#39;</span><span class="p">:</span> <span class="n">pos</span><span class="p">[</span><span class="s1">&#39;stop&#39;</span><span class="p">],</span>
                        <span class="s1">&#39;current&#39;</span><span class="p">:</span> <span class="n">current</span>
                    <span class="p">})</span>
        <span class="k">return</span> <span class="n">triggered</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>Section 3: Portfolio Risk</h1></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="k">def</span> <span class="nf">check_portfolio_risk</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="n">correlations</span><span class="p">,</span> <span class="n">max_correlated_exposure</span><span class="o">=</span><span class="mf">0.4</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check portfolio risk from correlated positions.</span>
<span class="sd">    </span>
<span class="sd">    positions: dict of {symbol: position_value}</span>
<span class="sd">    correlations: dict of {(sym1, sym2): correlation}</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">total_value</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">positions</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
    <span class="n">warnings</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">for</span> <span class="p">(</span><span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">),</span> <span class="n">corr</span> <span class="ow">in</span> <span class="n">correlations</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">corr</span> <span class="o">&gt;</span> <span class="mf">0.7</span><span class="p">:</span>  <span class="c1"># Highly correlated</span>
            <span class="k">if</span> <span class="n">s1</span> <span class="ow">in</span> <span class="n">positions</span> <span class="ow">and</span> <span class="n">s2</span> <span class="ow">in</span> <span class="n">positions</span><span class="p">:</span>
                <span class="n">combined</span> <span class="o">=</span> <span class="p">(</span><span class="n">positions</span><span class="p">[</span><span class="n">s1</span><span class="p">]</span> <span class="o">+</span> <span class="n">positions</span><span class="p">[</span><span class="n">s2</span><span class="p">])</span> <span class="o">/</span> <span class="n">total_value</span>
                <span class="k">if</span> <span class="n">combined</span> <span class="o">&gt;</span> <span class="n">max_correlated_exposure</span><span class="p">:</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">s1</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">s2</span><span class="si">}</span><span class="s1"> combined exposure </span><span class="si">{</span><span class="n">combined</span><span class="si">:</span><span class="s1">.1%</span><span class="si">}</span><span class="s1"> exceeds limit&#39;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">warnings</span>

<span class="c1"># Example</span>
<span class="n">positions</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;BTC&#39;</span><span class="p">:</span> <span class="mi">3000</span><span class="p">,</span> <span class="s1">&#39;ETH&#39;</span><span class="p">:</span> <span class="mi">2000</span><span class="p">,</span> <span class="s1">&#39;SOL&#39;</span><span class="p">:</span> <span class="mi">1500</span><span class="p">}</span>
<span class="n">correlations</span> <span class="o">=</span> <span class="p">{(</span><span class="s1">&#39;BTC&#39;</span><span class="p">,</span> <span class="s1">&#39;ETH&#39;</span><span class="p">):</span> <span class="mf">0.85</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;BTC&#39;</span><span class="p">,</span> <span class="s1">&#39;SOL&#39;</span><span class="p">):</span> <span class="mf">0.75</span><span class="p">}</span>
<span class="nb">print</span><span class="p">(</span><span class="n">check_portfolio_risk</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="n">correlations</span><span class="p">))</span>
</code></pre></div>
<div class="md-cell"><h3>âœï¸ Exercise 7.3: Portfolio Risk Checker</h3>
<p>Build a comprehensive portfolio risk monitoring system.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="c1"># Exercise 7.3</span>
<span class="k">class</span> <span class="nc">PortfolioRiskChecker</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_single_position</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">max_drawdown</span><span class="o">=</span><span class="mf">0.20</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_single</span> <span class="o">=</span> <span class="n">max_single_position</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_dd</span> <span class="o">=</span> <span class="n">max_drawdown</span>
    
    <span class="k">def</span> <span class="nf">check_concentration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">positions</span><span class="p">):</span>
        <span class="c1"># TODO</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">check_drawdown</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">equity_curve</span><span class="p">):</span>
        <span class="c1"># TODO</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">full_check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">positions</span><span class="p">,</span> <span class="n">equity_curve</span><span class="p">):</span>
        <span class="c1"># TODO: Return all risk warnings</span>
        <span class="k">pass</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">PortfolioRiskChecker</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_single_position</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">max_drawdown</span><span class="o">=</span><span class="mf">0.20</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_single</span> <span class="o">=</span> <span class="n">max_single_position</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_dd</span> <span class="o">=</span> <span class="n">max_drawdown</span>

    <span class="k">def</span> <span class="nf">check_concentration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">positions</span><span class="p">):</span>
        <span class="n">total</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">positions</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="n">warnings</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">positions</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">pct</span> <span class="o">=</span> <span class="n">value</span> <span class="o">/</span> <span class="n">total</span>
            <span class="k">if</span> <span class="n">pct</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_single</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">symbol</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">pct</span><span class="si">:</span><span class="s1">.1%</span><span class="si">}</span><span class="s1"> exceeds </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">max_single</span><span class="si">:</span><span class="s1">.1%</span><span class="si">}</span><span class="s1"> limit&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">warnings</span>

    <span class="k">def</span> <span class="nf">check_drawdown</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">equity_curve</span><span class="p">):</span>
        <span class="n">equity</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">equity_curve</span><span class="p">)</span>
        <span class="n">peak</span> <span class="o">=</span> <span class="n">equity</span><span class="o">.</span><span class="n">cummax</span><span class="p">()</span>
        <span class="n">dd</span> <span class="o">=</span> <span class="p">(</span><span class="n">equity</span> <span class="o">-</span> <span class="n">peak</span><span class="p">)</span> <span class="o">/</span> <span class="n">peak</span>
        <span class="n">current_dd</span> <span class="o">=</span> <span class="n">dd</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">max_dd</span> <span class="o">=</span> <span class="n">dd</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>

        <span class="n">warnings</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">current_dd</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_dd</span> <span class="o">*</span> <span class="mf">0.8</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Current DD </span><span class="si">{</span><span class="n">current_dd</span><span class="si">:</span><span class="s1">.1%</span><span class="si">}</span><span class="s1"> approaching limit&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">max_dd</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_dd</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Max DD </span><span class="si">{</span><span class="n">max_dd</span><span class="si">:</span><span class="s1">.1%</span><span class="si">}</span><span class="s1"> exceeded limit&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">warnings</span><span class="p">,</span> <span class="n">current_dd</span><span class="p">,</span> <span class="n">max_dd</span>

    <span class="k">def</span> <span class="nf">full_check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">positions</span><span class="p">,</span> <span class="n">equity_curve</span><span class="p">):</span>
        <span class="n">concentration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_concentration</span><span class="p">(</span><span class="n">positions</span><span class="p">)</span>
        <span class="n">dd_warnings</span><span class="p">,</span> <span class="n">current_dd</span><span class="p">,</span> <span class="n">max_dd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_drawdown</span><span class="p">(</span><span class="n">equity_curve</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;concentration_warnings&#39;</span><span class="p">:</span> <span class="n">concentration</span><span class="p">,</span>
            <span class="s1">&#39;drawdown_warnings&#39;</span><span class="p">:</span> <span class="n">dd_warnings</span><span class="p">,</span>
            <span class="s1">&#39;current_drawdown&#39;</span><span class="p">:</span> <span class="n">current_dd</span><span class="p">,</span>
            <span class="s1">&#39;max_drawdown&#39;</span><span class="p">:</span> <span class="n">max_dd</span><span class="p">,</span>
            <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;OK&#39;</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">concentration</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">dd_warnings</span> <span class="k">else</span> <span class="s1">&#39;WARNING&#39;</span>
        <span class="p">}</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>Section 4: Exchange Risk Management</h1></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">ExchangeRiskManager</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_per_exchange</span><span class="o">=</span><span class="mf">0.3</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_per_exchange</span> <span class="o">=</span> <span class="n">max_per_exchange</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">balances</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="k">def</span> <span class="nf">update_balance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exchange</span><span class="p">,</span> <span class="n">balance</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">balances</span><span class="p">[</span><span class="n">exchange</span><span class="p">]</span> <span class="o">=</span> <span class="n">balance</span>
    
    <span class="k">def</span> <span class="nf">check_limits</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">total_capital</span><span class="p">):</span>
        <span class="n">warnings</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">exchange</span><span class="p">,</span> <span class="n">balance</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">balances</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">pct</span> <span class="o">=</span> <span class="n">balance</span> <span class="o">/</span> <span class="n">total_capital</span>
            <span class="k">if</span> <span class="n">pct</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_per_exchange</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">exchange</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">pct</span><span class="si">:</span><span class="s1">.1%</span><span class="si">}</span><span class="s1"> exceeds </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">max_per_exchange</span><span class="si">:</span><span class="s1">.1%</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">warnings</span>
    
    <span class="k">def</span> <span class="nf">suggest_rebalance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">total_capital</span><span class="p">):</span>
        <span class="n">target_per_exchange</span> <span class="o">=</span> <span class="n">total_capital</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_per_exchange</span>
        <span class="n">suggestions</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">for</span> <span class="n">exchange</span><span class="p">,</span> <span class="n">balance</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">balances</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">balance</span> <span class="o">&gt;</span> <span class="n">target_per_exchange</span><span class="p">:</span>
                <span class="n">withdraw</span> <span class="o">=</span> <span class="n">balance</span> <span class="o">-</span> <span class="n">target_per_exchange</span>
                <span class="n">suggestions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Withdraw $</span><span class="si">{</span><span class="n">withdraw</span><span class="si">:</span><span class="s1">,.0f</span><span class="si">}</span><span class="s1"> from </span><span class="si">{</span><span class="n">exchange</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">suggestions</span>
</code></pre></div>
<div class="md-cell"><h3>âœï¸ Exercise 7.4: Risk Protocol</h3>
<p>Create a complete risk management protocol.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="c1"># Exercise 7.4</span>
<span class="k">class</span> <span class="nc">RiskProtocol</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
        <span class="c1"># TODO: Initialize all risk managers</span>
    
    <span class="k">def</span> <span class="nf">pre_trade_check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">price</span><span class="p">):</span>
        <span class="c1"># TODO: Check if trade is allowed</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">daily_risk_report</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># TODO: Generate daily risk report</span>
        <span class="k">pass</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">RiskProtocol</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">position_sizer</span> <span class="o">=</span> <span class="n">PositionSizer</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;capital&#39;</span><span class="p">],</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;max_risk&#39;</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stop_system</span> <span class="o">=</span> <span class="n">StopLossSystem</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">portfolio_checker</span> <span class="o">=</span> <span class="n">PortfolioRiskChecker</span><span class="p">(</span>
            <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;max_single&#39;</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">),</span>
            <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;max_dd&#39;</span><span class="p">,</span> <span class="mf">0.20</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exchange_mgr</span> <span class="o">=</span> <span class="n">ExchangeRiskManager</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;max_per_exchange&#39;</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">positions</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">equity_curve</span> <span class="o">=</span> <span class="p">[</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;capital&#39;</span><span class="p">]]</span>

    <span class="k">def</span> <span class="nf">pre_trade_check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">price</span><span class="p">):</span>
        <span class="n">checks</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Size check</span>
        <span class="n">max_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">position_sizer</span><span class="o">.</span><span class="n">percent</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;max_single&#39;</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="n">max_size</span><span class="p">:</span>
            <span class="n">checks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;FAIL: Size $</span><span class="si">{</span><span class="n">size</span><span class="si">}</span><span class="s1"> exceeds max $</span><span class="si">{</span><span class="n">max_size</span><span class="si">:</span><span class="s1">.0f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">checks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;PASS: Size within limits&#39;</span><span class="p">)</span>

        <span class="c1"># Portfolio concentration</span>
        <span class="n">test_positions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">test_positions</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span> <span class="o">=</span> <span class="n">test_positions</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">size</span>
        <span class="n">conc_warnings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">portfolio_checker</span><span class="o">.</span><span class="n">check_concentration</span><span class="p">(</span><span class="n">test_positions</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">conc_warnings</span><span class="p">:</span>
            <span class="n">checks</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="sa">f</span><span class="s1">&#39;FAIL: </span><span class="si">{</span><span class="n">w</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">conc_warnings</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">checks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;PASS: Portfolio concentration OK&#39;</span><span class="p">)</span>

        <span class="n">allowed</span> <span class="o">=</span> <span class="nb">all</span><span class="p">(</span><span class="s1">&#39;FAIL&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">checks</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;allowed&#39;</span><span class="p">:</span> <span class="n">allowed</span><span class="p">,</span> <span class="s1">&#39;checks&#39;</span><span class="p">:</span> <span class="n">checks</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">daily_risk_report</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=&#39;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;           DAILY RISK REPORT&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=&#39;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>

        <span class="c1"># Portfolio status</span>
        <span class="n">report</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">portfolio_checker</span><span class="o">.</span><span class="n">full_check</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">equity_curve</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Status: </span><span class="si">{</span><span class="n">report</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Current DD: </span><span class="si">{</span><span class="n">report</span><span class="p">[</span><span class="s1">&#39;current_drawdown&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.1%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Max DD: </span><span class="si">{</span><span class="n">report</span><span class="p">[</span><span class="s1">&#39;max_drawdown&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.1%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Warnings</span>
        <span class="n">all_warnings</span> <span class="o">=</span> <span class="n">report</span><span class="p">[</span><span class="s1">&#39;concentration_warnings&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">report</span><span class="p">[</span><span class="s1">&#39;drawdown_warnings&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">all_warnings</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">WARNINGS:&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">all_warnings</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;  âš ï¸ </span><span class="si">{</span><span class="n">w</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=&#39;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>ğŸ—ï¸ Module Project: Risk Management Module</h1>
<p>Build a complete integrated risk management system.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="c1"># Module Project: Combine all components into RiskManagementModule</span>
<span class="c1"># Your solution should integrate position sizing, stop losses,</span>
<span class="c1"># portfolio risk, and exchange risk into one cohesive system.</span>
</code></pre></div>
<div class="md-cell"><hr />
<h1>ğŸ“ Key Takeaways</h1>
<ol>
<li><strong>Position Sizing</strong>: Never risk more than 1-2% per trade</li>
<li><strong>Stop Losses</strong>: ATR-based stops adapt to volatility</li>
<li><strong>Portfolio Risk</strong>: Watch correlations and concentration</li>
<li><strong>Exchange Risk</strong>: Don't keep all funds on one exchange</li>
</ol>
<hr />
<p><em>Next: Module 8 - Automation Fundamentals</em></p></div>
        <div class="nav-buttons">
            <button class="nav-btn prev-btn disabled" type="button">
                <span class="nav-btn-label">â† Previous</span>
                <span class="nav-btn-name"></span>
            </button>
            <button class="nav-btn next-btn disabled" type="button">
                <span class="nav-btn-label">Next â†’</span>
                <span class="nav-btn-name"></span>
            </button>
        </div>
        </div>
<div class="module-section" data-idx="8"><div class="md-cell module-header"><h1>Module 8: Automation Fundamentals</h1>
<h2>Part 2: Strategy Development</h2>
<hr />
<div class="table-wrapper"><table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>â±ï¸ <strong>Duration</strong></td>
<td>~2.5 hours</td>
</tr>
<tr>
<td>ğŸ“‹ <strong>Prerequisites</strong></td>
<td>Module 7</td>
</tr>
<tr>
<td>ğŸ’ª <strong>Exercises</strong></td>
<td>5 total</td>
</tr>
</tbody>
</table></div></div>
<div class="md-cell"><h2>ğŸ¯ Learning Objectives</h2>
<ul>
<li>Schedule tasks for 24/7 operation</li>
<li>Build alert notification systems</li>
<li>Implement logging and monitoring</li>
<li>Create paper trading systems</li>
</ul></div>
<div class="md-cell"><hr />
<h1>Section 1: Scheduling for 24/7 Markets</h1>
<p>Crypto never sleeps - your bot needs to run continuously.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>

<span class="c1"># Using schedule library</span>
<span class="c1"># pip install schedule</span>

<span class="k">class</span> <span class="nc">TradingScheduler</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_heartbeat</span> <span class="o">=</span> <span class="kc">None</span>
    
    <span class="k">def</span> <span class="nf">heartbeat</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Health check - runs every minute.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_heartbeat</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">True</span>
    
    <span class="k">def</span> <span class="nf">check_signals</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check trading signals.&quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;[</span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="si">}</span><span class="s1">] Checking signals...&#39;</span><span class="p">)</span>
        <span class="c1"># Your signal logic here</span>
    
    <span class="k">def</span> <span class="nf">is_healthy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_gap_seconds</span><span class="o">=</span><span class="mi">120</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check if scheduler is running properly.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_heartbeat</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="n">gap</span> <span class="o">=</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_heartbeat</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">gap</span> <span class="o">&lt;</span> <span class="n">max_gap_seconds</span>

<span class="n">scheduler</span> <span class="o">=</span> <span class="n">TradingScheduler</span><span class="p">()</span>
<span class="n">scheduler</span><span class="o">.</span><span class="n">heartbeat</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Healthy: </span><span class="si">{</span><span class="n">scheduler</span><span class="o">.</span><span class="n">is_healthy</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h3>âœï¸ Exercise 8.1: Robust Scheduler</h3>
<p>Build a scheduler with error recovery and restarts.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="c1"># Exercise 8.1</span>
<span class="k">class</span> <span class="nc">RobustScheduler</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_retries</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_retries</span> <span class="o">=</span> <span class="n">max_retries</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">error_count</span> <span class="o">=</span> <span class="mi">0</span>
    
    <span class="k">def</span> <span class="nf">run_with_retry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
        <span class="c1"># TODO: Run function with retry logic</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">should_restart</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># TODO: Determine if scheduler needs restart</span>
        <span class="k">pass</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">RobustScheduler</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_retries</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">cooldown</span><span class="o">=</span><span class="mi">60</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_retries</span> <span class="o">=</span> <span class="n">max_retries</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cooldown</span> <span class="o">=</span> <span class="n">cooldown</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">error_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_error</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">consecutive_failures</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">run_with_retry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">attempt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_retries</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">consecutive_failures</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="n">result</span><span class="p">}</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">error_count</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">consecutive_failures</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">last_error</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Attempt </span><span class="si">{</span><span class="n">attempt</span> <span class="o">+</span> <span class="mi">1</span><span class="si">}</span><span class="s1"> failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">attempt</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_retries</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="n">attempt</span><span class="p">)</span>  <span class="c1"># Exponential backoff</span>

        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_error</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">should_restart</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">consecutive_failures</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_retries</span>

    <span class="k">def</span> <span class="nf">get_status</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;total_errors&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_count</span><span class="p">,</span>
            <span class="s1">&#39;consecutive_failures&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">consecutive_failures</span><span class="p">,</span>
            <span class="s1">&#39;last_error&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_error</span><span class="p">,</span>
            <span class="s1">&#39;needs_restart&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">should_restart</span><span class="p">()</span>
        <span class="p">}</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>Section 2: Alert Systems</h1></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">AlertManager</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alerts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">channels</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># email, telegram, etc.</span>
    
    <span class="k">def</span> <span class="nf">add_alert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alert_type</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="s1">&#39;normal&#39;</span><span class="p">):</span>
        <span class="n">alert</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="n">alert_type</span><span class="p">,</span>
            <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="n">message</span><span class="p">,</span>
            <span class="s1">&#39;priority&#39;</span><span class="p">:</span> <span class="n">priority</span><span class="p">,</span>
            <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
            <span class="s1">&#39;sent&#39;</span><span class="p">:</span> <span class="kc">False</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alerts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">alert</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">priority</span> <span class="o">==</span> <span class="s1">&#39;high&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">send_immediately</span><span class="p">(</span><span class="n">alert</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">alert</span>
    
    <span class="k">def</span> <span class="nf">send_immediately</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alert</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;ğŸš¨ HIGH PRIORITY: </span><span class="si">{</span><span class="n">alert</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">alert</span><span class="p">[</span><span class="s1">&#39;sent&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    
    <span class="k">def</span> <span class="nf">price_alert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">current</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">direction</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">direction</span> <span class="o">==</span> <span class="s1">&#39;above&#39;</span> <span class="ow">and</span> <span class="n">current</span> <span class="o">&gt;=</span> <span class="n">target</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_alert</span><span class="p">(</span><span class="s1">&#39;price&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">symbol</span><span class="si">}</span><span class="s1"> reached $</span><span class="si">{</span><span class="n">current</span><span class="si">:</span><span class="s1">,.0f</span><span class="si">}</span><span class="s1"> (target: $</span><span class="si">{</span><span class="n">target</span><span class="si">:</span><span class="s1">,.0f</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">,</span> <span class="s1">&#39;high&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">direction</span> <span class="o">==</span> <span class="s1">&#39;below&#39;</span> <span class="ow">and</span> <span class="n">current</span> <span class="o">&lt;=</span> <span class="n">target</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_alert</span><span class="p">(</span><span class="s1">&#39;price&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">symbol</span><span class="si">}</span><span class="s1"> dropped to $</span><span class="si">{</span><span class="n">current</span><span class="si">:</span><span class="s1">,.0f</span><span class="si">}</span><span class="s1"> (target: $</span><span class="si">{</span><span class="n">target</span><span class="si">:</span><span class="s1">,.0f</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">,</span> <span class="s1">&#39;high&#39;</span><span class="p">)</span>

<span class="n">alerts</span> <span class="o">=</span> <span class="n">AlertManager</span><span class="p">()</span>
<span class="n">alerts</span><span class="o">.</span><span class="n">price_alert</span><span class="p">(</span><span class="s1">&#39;BTC&#39;</span><span class="p">,</span> <span class="mi">45000</span><span class="p">,</span> <span class="mi">44000</span><span class="p">,</span> <span class="s1">&#39;above&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h3>âœï¸ Exercise 8.2: Multi-Channel Alerts</h3>
<p>Build an alert system supporting multiple notification channels.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="c1"># Exercise 8.2</span>
<span class="k">class</span> <span class="nc">MultiChannelAlerts</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">channels</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="k">def</span> <span class="nf">add_channel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">sender_func</span><span class="p">):</span>
        <span class="c1"># TODO</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">send_alert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">channels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="s1">&#39;normal&#39;</span><span class="p">):</span>
        <span class="c1"># TODO: Send to specified channels</span>
        <span class="k">pass</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">MultiChannelAlerts</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">channels</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alert_history</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">add_channel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">sender_func</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">sender_func</span>

    <span class="k">def</span> <span class="nf">send_alert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">channels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="s1">&#39;normal&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">channels</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">channels</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

        <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="n">channels</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">channel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="p">[</span><span class="n">channel</span><span class="p">](</span><span class="n">message</span><span class="p">,</span> <span class="n">priority</span><span class="p">)</span>
                    <span class="n">results</span><span class="p">[</span><span class="n">channel</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;sent&#39;</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">results</span><span class="p">[</span><span class="n">channel</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">alert_history</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="n">message</span><span class="p">,</span>
            <span class="s1">&#39;priority&#39;</span><span class="p">:</span> <span class="n">priority</span><span class="p">,</span>
            <span class="s1">&#39;channels&#39;</span><span class="p">:</span> <span class="n">results</span><span class="p">,</span>
            <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="p">})</span>

        <span class="k">return</span> <span class="n">results</span>

<span class="c1"># Example usage</span>
<span class="k">def</span> <span class="nf">console_sender</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">priority</span><span class="p">):</span>
    <span class="n">prefix</span> <span class="o">=</span> <span class="s1">&#39;ğŸš¨&#39;</span> <span class="k">if</span> <span class="n">priority</span> <span class="o">==</span> <span class="s1">&#39;high&#39;</span> <span class="k">else</span> <span class="s1">&#39;ğŸ“¢&#39;</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">msg</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">log_sender</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">priority</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;[LOG] </span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">msg</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="n">alerts</span> <span class="o">=</span> <span class="n">MultiChannelAlerts</span><span class="p">()</span>
<span class="n">alerts</span><span class="o">.</span><span class="n">add_channel</span><span class="p">(</span><span class="s1">&#39;console&#39;</span><span class="p">,</span> <span class="n">console_sender</span><span class="p">)</span>
<span class="n">alerts</span><span class="o">.</span><span class="n">add_channel</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">,</span> <span class="n">log_sender</span><span class="p">)</span>
<span class="n">alerts</span><span class="o">.</span><span class="n">send_alert</span><span class="p">(</span><span class="s1">&#39;BTC signal detected!&#39;</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="s1">&#39;high&#39;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>Section 3: Logging &amp; Monitoring</h1></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="kn">import</span> <span class="nn">logging</span>

<span class="k">def</span> <span class="nf">setup_logging</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;trading_bot&#39;</span><span class="p">):</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
    
    <span class="c1"># Console handler</span>
    <span class="n">console</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">()</span>
    <span class="n">console</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
    <span class="n">console</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1"> - </span><span class="si">%(levelname)s</span><span class="s1"> - </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">))</span>
    
    <span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">console</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">logger</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">setup_logging</span><span class="p">()</span>
<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Bot started&#39;</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Low balance detected&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">TradeLogger</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trades</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">daily_pnl</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="k">def</span> <span class="nf">log_trade</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">side</span><span class="p">,</span> <span class="n">price</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">pnl</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">trade</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
            <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span>
            <span class="s1">&#39;side&#39;</span><span class="p">:</span> <span class="n">side</span><span class="p">,</span>
            <span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="n">price</span><span class="p">,</span>
            <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="n">size</span><span class="p">,</span>
            <span class="s1">&#39;pnl&#39;</span><span class="p">:</span> <span class="n">pnl</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trades</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">trade</span><span class="p">)</span>
        
        <span class="c1"># Update daily PnL</span>
        <span class="n">date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">date</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">daily_pnl</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">daily_pnl</span><span class="p">[</span><span class="n">date</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">pnl</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">daily_pnl</span><span class="p">[</span><span class="n">date</span><span class="p">]</span> <span class="o">+=</span> <span class="n">pnl</span>
        
        <span class="k">return</span> <span class="n">trade</span>
    
    <span class="k">def</span> <span class="nf">get_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">total_pnl</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pnl&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trades</span><span class="p">)</span>
        <span class="n">wins</span> <span class="o">=</span> <span class="nb">len</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trades</span> <span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pnl&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">])</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;total_trades&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trades</span><span class="p">),</span>
            <span class="s1">&#39;total_pnl&#39;</span><span class="p">:</span> <span class="n">total_pnl</span><span class="p">,</span>
            <span class="s1">&#39;wins&#39;</span><span class="p">:</span> <span class="n">wins</span>
        <span class="p">}</span>
</code></pre></div>
<div class="md-cell"><h3>âœï¸ Exercise 8.3: Monitoring Dashboard</h3>
<p>Create a real-time monitoring dashboard class.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="c1"># Exercise 8.3</span>
<span class="k">class</span> <span class="nc">MonitoringDashboard</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="k">def</span> <span class="nf">update_metric</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="c1"># TODO</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">get_status</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># TODO: Return system status</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">display</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># TODO: Print dashboard</span>
        <span class="k">pass</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">MonitoringDashboard</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">update_metric</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;values&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;current&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;current&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;values&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">value</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()})</span>
        <span class="c1"># Keep last 1000 values</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;values&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1000</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;values&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">log_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">error</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">error</span><span class="p">),</span> <span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()})</span>

    <span class="k">def</span> <span class="nf">get_status</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">uptime</span> <span class="o">=</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">/</span> <span class="mi">3600</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;uptime_hours&#39;</span><span class="p">:</span> <span class="n">uptime</span><span class="p">,</span>
            <span class="s1">&#39;metrics_count&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">),</span>
            <span class="s1">&#39;error_count&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">errors</span><span class="p">),</span>
            <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;HEALTHY&#39;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">errors</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">5</span> <span class="k">else</span> <span class="s1">&#39;DEGRADED&#39;</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">display</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_status</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=&#39;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;       TRADING BOT DASHBOARD&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=&#39;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Status: </span><span class="si">{</span><span class="n">status</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Uptime: </span><span class="si">{</span><span class="n">status</span><span class="p">[</span><span class="s1">&#39;uptime_hours&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> hours&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Errors: </span><span class="si">{</span><span class="n">status</span><span class="p">[</span><span class="s1">&#39;error_count&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-&#39;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;METRICS:&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;current&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=&#39;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>Section 4: Paper Trading</h1></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">PaperTradingSystem</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">initial_balance</span><span class="o">=</span><span class="mi">10000</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">balance</span> <span class="o">=</span> <span class="n">initial_balance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">positions</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trades</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">order_id</span> <span class="o">=</span> <span class="mi">0</span>
    
    <span class="k">def</span> <span class="nf">get_balance</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">balance</span>
    
    <span class="k">def</span> <span class="nf">market_buy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">price</span><span class="p">):</span>
        <span class="n">cost</span> <span class="o">=</span> <span class="n">size</span> <span class="o">*</span> <span class="n">price</span> <span class="o">*</span> <span class="mf">1.001</span>  <span class="c1"># 0.1% fee</span>
        <span class="k">if</span> <span class="n">cost</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">balance</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Insufficient balance&#39;</span><span class="p">}</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">balance</span> <span class="o">-=</span> <span class="n">cost</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">size</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">order_id</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">trade</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">order_id</span><span class="p">,</span>
            <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span>
            <span class="s1">&#39;side&#39;</span><span class="p">:</span> <span class="s1">&#39;BUY&#39;</span><span class="p">,</span>
            <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="n">size</span><span class="p">,</span>
            <span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="n">price</span><span class="p">,</span>
            <span class="s1">&#39;cost&#39;</span><span class="p">:</span> <span class="n">cost</span><span class="p">,</span>
            <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trades</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">trade</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;trade&#39;</span><span class="p">:</span> <span class="n">trade</span><span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">market_sell</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">price</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">symbol</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Insufficient position&#39;</span><span class="p">}</span>
        
        <span class="n">revenue</span> <span class="o">=</span> <span class="n">size</span> <span class="o">*</span> <span class="n">price</span> <span class="o">*</span> <span class="mf">0.999</span>  <span class="c1"># 0.1% fee</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">balance</span> <span class="o">+=</span> <span class="n">revenue</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span> <span class="o">-=</span> <span class="n">size</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">order_id</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">trade</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">order_id</span><span class="p">,</span>
            <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span>
            <span class="s1">&#39;side&#39;</span><span class="p">:</span> <span class="s1">&#39;SELL&#39;</span><span class="p">,</span>
            <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="n">size</span><span class="p">,</span>
            <span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="n">price</span><span class="p">,</span>
            <span class="s1">&#39;revenue&#39;</span><span class="p">:</span> <span class="n">revenue</span><span class="p">,</span>
            <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trades</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">trade</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;trade&#39;</span><span class="p">:</span> <span class="n">trade</span><span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">get_portfolio_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prices</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">balance</span>
        <span class="k">for</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">size</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="n">prices</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">+=</span> <span class="n">size</span> <span class="o">*</span> <span class="n">prices</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">value</span>
</code></pre></div>
<div class="md-cell"><h3>âœï¸ Exercise 8.4: Paper Trading System</h3>
<p>Extend the paper trading system with limit orders and stop losses.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="c1"># Exercise 8.4</span>
<span class="k">class</span> <span class="nc">AdvancedPaperTrading</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">initial_balance</span><span class="o">=</span><span class="mi">10000</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">balance</span> <span class="o">=</span> <span class="n">initial_balance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">positions</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">open_orders</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">def</span> <span class="nf">limit_buy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">limit_price</span><span class="p">):</span>
        <span class="c1"># TODO: Place limit order</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">set_stop_loss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">stop_price</span><span class="p">):</span>
        <span class="c1"># TODO: Set stop loss for position</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">update_with_price</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">current_price</span><span class="p">):</span>
        <span class="c1"># TODO: Check and execute pending orders</span>
        <span class="k">pass</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">AdvancedPaperTrading</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">initial_balance</span><span class="o">=</span><span class="mi">10000</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">balance</span> <span class="o">=</span> <span class="n">initial_balance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">positions</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">open_orders</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stop_losses</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">order_id</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">limit_buy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">limit_price</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">order_id</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">order</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">order_id</span><span class="p">,</span>
            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;LIMIT_BUY&#39;</span><span class="p">,</span>
            <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span>
            <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="n">size</span><span class="p">,</span>
            <span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="n">limit_price</span><span class="p">,</span>
            <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;OPEN&#39;</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">open_orders</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">order</span>

    <span class="k">def</span> <span class="nf">set_stop_loss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">stop_price</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stop_losses</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span> <span class="o">=</span> <span class="n">stop_price</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;stop&#39;</span><span class="p">:</span> <span class="n">stop_price</span><span class="p">}</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;No position&#39;</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">update_with_price</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">current_price</span><span class="p">):</span>
        <span class="n">executed</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Check limit orders</span>
        <span class="k">for</span> <span class="n">order</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_orders</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">order</span><span class="p">[</span><span class="s1">&#39;symbol&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">symbol</span> <span class="ow">and</span> <span class="n">order</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;OPEN&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">order</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;LIMIT_BUY&#39;</span> <span class="ow">and</span> <span class="n">current_price</span> <span class="o">&lt;=</span> <span class="n">order</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]:</span>
                    <span class="n">cost</span> <span class="o">=</span> <span class="n">order</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">order</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1.001</span>
                    <span class="k">if</span> <span class="n">cost</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">balance</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">balance</span> <span class="o">-=</span> <span class="n">cost</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">order</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">]</span>
                        <span class="n">order</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;FILLED&#39;</span>
                        <span class="n">executed</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>

        <span class="c1"># Check stop losses</span>
        <span class="k">if</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop_losses</span> <span class="ow">and</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">current_price</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop_losses</span><span class="p">[</span><span class="n">symbol</span><span class="p">]:</span>
                <span class="n">size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span>
                <span class="n">revenue</span> <span class="o">=</span> <span class="n">size</span> <span class="o">*</span> <span class="n">current_price</span> <span class="o">*</span> <span class="mf">0.999</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">balance</span> <span class="o">+=</span> <span class="n">revenue</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop_losses</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span>
                <span class="n">executed</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;STOP_LOSS&#39;</span><span class="p">,</span> <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span> <span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="n">current_price</span><span class="p">})</span>

        <span class="k">return</span> <span class="n">executed</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>ğŸ—ï¸ Module Project: Automated Trading Framework</h1>
<p>Combine all automation components into a complete framework.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="c1"># Module Project</span>
<span class="k">class</span> <span class="nc">AutomatedTradingFramework</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span> <span class="o">=</span> <span class="n">RobustScheduler</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alerts</span> <span class="o">=</span> <span class="n">MultiChannelAlerts</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dashboard</span> <span class="o">=</span> <span class="n">MonitoringDashboard</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">paper_trading</span> <span class="o">=</span> <span class="n">PaperTradingSystem</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;capital&#39;</span><span class="p">,</span> <span class="mi">10000</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">setup_logging</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="kc">False</span>
    
    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Framework started&#39;</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Framework stopped&#39;</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">run_cycle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prices</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;One trading cycle.&quot;&quot;&quot;</span>
        <span class="c1"># Update dashboard</span>
        <span class="k">for</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">price</span> <span class="ow">in</span> <span class="n">prices</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dashboard</span><span class="o">.</span><span class="n">update_metric</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">symbol</span><span class="si">}</span><span class="s1">_price&#39;</span><span class="p">,</span> <span class="n">price</span><span class="p">)</span>
        
        <span class="c1"># Calculate portfolio value</span>
        <span class="n">pv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">paper_trading</span><span class="o">.</span><span class="n">get_portfolio_value</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dashboard</span><span class="o">.</span><span class="n">update_metric</span><span class="p">(</span><span class="s1">&#39;portfolio_value&#39;</span><span class="p">,</span> <span class="n">pv</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;portfolio_value&#39;</span><span class="p">:</span> <span class="n">pv</span><span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">status</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dashboard</span><span class="o">.</span><span class="n">get_status</span><span class="p">()</span>
</code></pre></div>
<div class="md-cell"><hr />
<h1>ğŸ“ Key Takeaways</h1>
<ol>
<li><strong>Scheduling</strong>: Use robust scheduling with error recovery</li>
<li><strong>Alerts</strong>: Multi-channel alerts for critical events</li>
<li><strong>Logging</strong>: Log everything for debugging and analysis</li>
<li><strong>Paper Trading</strong>: Always test before going live</li>
</ol>
<hr />
<p><em>Part 2 Complete! Next: Part 3 - Exchange Integration</em></p></div>
        <div class="nav-buttons">
            <button class="nav-btn prev-btn disabled" type="button">
                <span class="nav-btn-label">â† Previous</span>
                <span class="nav-btn-name"></span>
            </button>
            <button class="nav-btn next-btn disabled" type="button">
                <span class="nav-btn-label">Next â†’</span>
                <span class="nav-btn-name"></span>
            </button>
        </div>
        </div>
<div class="module-section" data-idx="9"><div class="md-cell module-header"><h1>Module 9: Exchange APIs Deep Dive</h1>
<h2>Part 3: Exchange Integration</h2>
<hr />
<div class="table-wrapper"><table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>â±ï¸ <strong>Duration</strong></td>
<td>~2.5 hours</td>
</tr>
<tr>
<td>ğŸ“‹ <strong>Prerequisites</strong></td>
<td>Part 2 (Modules 5-8)</td>
</tr>
<tr>
<td>ğŸ’ª <strong>Exercises</strong></td>
<td>5 total</td>
</tr>
</tbody>
</table></div></div>
<div class="md-cell"><h2>ğŸ¯ Learning Objectives</h2>
<ul>
<li>Set up secure API authentication</li>
<li>Fetch market data from exchanges</li>
<li>Access account information</li>
<li>Handle rate limits properly</li>
</ul></div>
<div class="md-cell"><hr />
<h1>Section 1: Authentication &amp; Security</h1>
<h2>1.1 API Key Management</h2>
<p><strong>NEVER</strong> hardcode API keys in your code. Use environment variables.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">dotenv</span> <span class="kn">import</span> <span class="n">load_dotenv</span>

<span class="c1"># Load from .env file</span>
<span class="n">load_dotenv</span><span class="p">()</span>

<span class="c1"># Access keys securely</span>
<span class="n">API_KEY</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;EXCHANGE_API_KEY&#39;</span><span class="p">)</span>
<span class="n">API_SECRET</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;EXCHANGE_API_SECRET&#39;</span><span class="p">)</span>

<span class="c1"># Verify keys are loaded (never print actual values!)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;API Key loaded: </span><span class="si">{</span><span class="n">API_KEY</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;API Secret loaded: </span><span class="si">{</span><span class="n">API_SECRET</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h2>1.2 Setting Up CCXT</h2>
<p>CCXT provides unified access to 100+ exchanges.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="c1"># pip install ccxt python-dotenv</span>
<span class="kn">import</span> <span class="nn">ccxt</span>

<span class="k">class</span> <span class="nc">SecureExchangeConnection</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exchange_id</span><span class="o">=</span><span class="s1">&#39;binance&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exchange_id</span> <span class="o">=</span> <span class="n">exchange_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span> <span class="o">=</span> <span class="kc">None</span>
    
    <span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sandbox</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Connect to exchange with credentials from environment.&quot;&quot;&quot;</span>
        <span class="n">api_key</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">exchange_id</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s1">_API_KEY&#39;</span><span class="p">)</span>
        <span class="n">api_secret</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">exchange_id</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s1">_API_SECRET&#39;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">api_key</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">api_secret</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Warning: No credentials for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">exchange_id</span><span class="si">}</span><span class="s1">, using public API only&#39;</span><span class="p">)</span>
        
        <span class="n">exchange_class</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">ccxt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">exchange_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span> <span class="o">=</span> <span class="n">exchange_class</span><span class="p">({</span>
            <span class="s1">&#39;apiKey&#39;</span><span class="p">:</span> <span class="n">api_key</span><span class="p">,</span>
            <span class="s1">&#39;secret&#39;</span><span class="p">:</span> <span class="n">api_secret</span><span class="p">,</span>
            <span class="s1">&#39;sandbox&#39;</span><span class="p">:</span> <span class="n">sandbox</span><span class="p">,</span>  <span class="c1"># Use testnet</span>
            <span class="s1">&#39;enableRateLimit&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>  <span class="c1"># Built-in rate limiting</span>
        <span class="p">})</span>
        
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span>
    
    <span class="k">def</span> <span class="nf">test_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Test if connection works.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="o">.</span><span class="n">load_markets</span><span class="p">()</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;markets&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="o">.</span><span class="n">markets</span><span class="p">)}</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>

<span class="c1"># Example (public API only without credentials)</span>
<span class="n">conn</span> <span class="o">=</span> <span class="n">SecureExchangeConnection</span><span class="p">(</span><span class="s1">&#39;binance&#39;</span><span class="p">)</span>
<span class="n">exchange</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">sandbox</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Connected to </span><span class="si">{</span><span class="n">exchange</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h2>1.3 Security Best Practices</h2>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Practice</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>IP Whitelisting</strong></td>
<td>Only allow API access from specific IPs</td>
</tr>
<tr>
<td><strong>Withdrawal Disabled</strong></td>
<td>Never enable withdrawal permission for trading bots</td>
</tr>
<tr>
<td><strong>Read-Only Keys</strong></td>
<td>Use separate keys for monitoring vs trading</td>
</tr>
<tr>
<td><strong>Key Rotation</strong></td>
<td>Rotate keys periodically</td>
</tr>
</tbody>
</table></div></div>
<div class="md-cell"><h3>âœï¸ Exercise 9.1: Secure API Setup</h3>
<p>Create a secure configuration manager for multiple exchanges.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="c1"># Exercise 9.1</span>
<span class="k">class</span> <span class="nc">ExchangeConfigManager</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exchanges</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="k">def</span> <span class="nf">add_exchange</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exchange_id</span><span class="p">):</span>
        <span class="c1"># TODO: Load credentials from env and create connection</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">get_exchange</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exchange_id</span><span class="p">):</span>
        <span class="c1"># TODO: Return configured exchange</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">validate_permissions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exchange_id</span><span class="p">):</span>
        <span class="c1"># TODO: Check what permissions the API key has</span>
        <span class="k">pass</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">ExchangeConfigManager</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exchanges</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connections</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">add_exchange</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exchange_id</span><span class="p">,</span> <span class="n">sandbox</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">api_key</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">exchange_id</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s1">_API_KEY&#39;</span><span class="p">)</span>
        <span class="n">api_secret</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">exchange_id</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s1">_API_SECRET&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">exchanges</span><span class="p">[</span><span class="n">exchange_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;has_credentials&#39;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="n">api_key</span> <span class="ow">and</span> <span class="n">api_secret</span><span class="p">),</span>
            <span class="s1">&#39;sandbox&#39;</span><span class="p">:</span> <span class="n">sandbox</span>
        <span class="p">}</span>

        <span class="n">exchange_class</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">ccxt</span><span class="p">,</span> <span class="n">exchange_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connections</span><span class="p">[</span><span class="n">exchange_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">exchange_class</span><span class="p">({</span>
            <span class="s1">&#39;apiKey&#39;</span><span class="p">:</span> <span class="n">api_key</span><span class="p">,</span>
            <span class="s1">&#39;secret&#39;</span><span class="p">:</span> <span class="n">api_secret</span><span class="p">,</span>
            <span class="s1">&#39;sandbox&#39;</span><span class="p">:</span> <span class="n">sandbox</span><span class="p">,</span>
            <span class="s1">&#39;enableRateLimit&#39;</span><span class="p">:</span> <span class="kc">True</span>
        <span class="p">})</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">exchanges</span><span class="p">[</span><span class="n">exchange_id</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">get_exchange</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exchange_id</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">exchange_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">connections</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_exchange</span><span class="p">(</span><span class="n">exchange_id</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">connections</span><span class="p">[</span><span class="n">exchange_id</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">validate_permissions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exchange_id</span><span class="p">):</span>
        <span class="n">exchange</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_exchange</span><span class="p">(</span><span class="n">exchange_id</span><span class="p">)</span>
        <span class="n">permissions</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;spot_trading&#39;</span><span class="p">:</span> <span class="n">exchange</span><span class="o">.</span><span class="n">has</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;createOrder&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
            <span class="s1">&#39;futures_trading&#39;</span><span class="p">:</span> <span class="n">exchange</span><span class="o">.</span><span class="n">has</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;createOrder&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
            <span class="s1">&#39;fetch_balance&#39;</span><span class="p">:</span> <span class="n">exchange</span><span class="o">.</span><span class="n">has</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fetchBalance&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
            <span class="s1">&#39;fetch_orders&#39;</span><span class="p">:</span> <span class="n">exchange</span><span class="o">.</span><span class="n">has</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fetchOrders&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">permissions</span>

<span class="n">config</span> <span class="o">=</span> <span class="n">ExchangeConfigManager</span><span class="p">()</span>
<span class="n">config</span><span class="o">.</span><span class="n">add_exchange</span><span class="p">(</span><span class="s1">&#39;binance&#39;</span><span class="p">,</span> <span class="n">sandbox</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">validate_permissions</span><span class="p">(</span><span class="s1">&#39;binance&#39;</span><span class="p">))</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>Section 2: Market Data Endpoints</h1>
<h2>2.1 Fetching Prices</h2></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="k">def</span> <span class="nf">fetch_ticker</span><span class="p">(</span><span class="n">exchange</span><span class="p">,</span> <span class="n">symbol</span><span class="o">=</span><span class="s1">&#39;BTC/USDT&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Fetch current ticker data.&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">ticker</span> <span class="o">=</span> <span class="n">exchange</span><span class="o">.</span><span class="n">fetch_ticker</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span>
            <span class="s1">&#39;last&#39;</span><span class="p">:</span> <span class="n">ticker</span><span class="p">[</span><span class="s1">&#39;last&#39;</span><span class="p">],</span>
            <span class="s1">&#39;bid&#39;</span><span class="p">:</span> <span class="n">ticker</span><span class="p">[</span><span class="s1">&#39;bid&#39;</span><span class="p">],</span>
            <span class="s1">&#39;ask&#39;</span><span class="p">:</span> <span class="n">ticker</span><span class="p">[</span><span class="s1">&#39;ask&#39;</span><span class="p">],</span>
            <span class="s1">&#39;volume&#39;</span><span class="p">:</span> <span class="n">ticker</span><span class="p">[</span><span class="s1">&#39;baseVolume&#39;</span><span class="p">],</span>
            <span class="s1">&#39;change_24h&#39;</span><span class="p">:</span> <span class="n">ticker</span><span class="p">[</span><span class="s1">&#39;percentage&#39;</span><span class="p">]</span>
        <span class="p">}</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>

<span class="c1"># Example</span>
<span class="n">ticker</span> <span class="o">=</span> <span class="n">fetch_ticker</span><span class="p">(</span><span class="n">exchange</span><span class="p">,</span> <span class="s1">&#39;BTC/USDT&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;BTC Price: $</span><span class="si">{</span><span class="n">ticker</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;last&#39;</span><span class="p">,</span> <span class="s1">&#39;N/A&#39;</span><span class="p">)</span><span class="si">:</span><span class="s2">,.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h2>2.2 Order Book Data</h2></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="k">def</span> <span class="nf">fetch_order_book</span><span class="p">(</span><span class="n">exchange</span><span class="p">,</span> <span class="n">symbol</span><span class="o">=</span><span class="s1">&#39;BTC/USDT&#39;</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Fetch order book with bids and asks.&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">book</span> <span class="o">=</span> <span class="n">exchange</span><span class="o">.</span><span class="n">fetch_order_book</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">limit</span><span class="p">)</span>
        
        <span class="c1"># Calculate spread</span>
        <span class="n">best_bid</span> <span class="o">=</span> <span class="n">book</span><span class="p">[</span><span class="s1">&#39;bids&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">book</span><span class="p">[</span><span class="s1">&#39;bids&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="n">best_ask</span> <span class="o">=</span> <span class="n">book</span><span class="p">[</span><span class="s1">&#39;asks&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">book</span><span class="p">[</span><span class="s1">&#39;asks&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="n">spread</span> <span class="o">=</span> <span class="p">(</span><span class="n">best_ask</span> <span class="o">-</span> <span class="n">best_bid</span><span class="p">)</span> <span class="o">/</span> <span class="n">best_bid</span> <span class="o">*</span> <span class="mi">100</span> <span class="k">if</span> <span class="n">best_bid</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span>
            <span class="s1">&#39;best_bid&#39;</span><span class="p">:</span> <span class="n">best_bid</span><span class="p">,</span>
            <span class="s1">&#39;best_ask&#39;</span><span class="p">:</span> <span class="n">best_ask</span><span class="p">,</span>
            <span class="s1">&#39;spread_pct&#39;</span><span class="p">:</span> <span class="n">spread</span><span class="p">,</span>
            <span class="s1">&#39;bids&#39;</span><span class="p">:</span> <span class="n">book</span><span class="p">[</span><span class="s1">&#39;bids&#39;</span><span class="p">][:</span><span class="mi">5</span><span class="p">],</span>
            <span class="s1">&#39;asks&#39;</span><span class="p">:</span> <span class="n">book</span><span class="p">[</span><span class="s1">&#39;asks&#39;</span><span class="p">][:</span><span class="mi">5</span><span class="p">]</span>
        <span class="p">}</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>

<span class="n">book</span> <span class="o">=</span> <span class="n">fetch_order_book</span><span class="p">(</span><span class="n">exchange</span><span class="p">,</span> <span class="s1">&#39;BTC/USDT&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Spread: </span><span class="si">{</span><span class="n">book</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;spread_pct&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h2>2.3 Historical OHLCV Data</h2></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>

<span class="k">def</span> <span class="nf">fetch_ohlcv</span><span class="p">(</span><span class="n">exchange</span><span class="p">,</span> <span class="n">symbol</span><span class="o">=</span><span class="s1">&#39;BTC/USDT&#39;</span><span class="p">,</span> <span class="n">timeframe</span><span class="o">=</span><span class="s1">&#39;1h&#39;</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Fetch historical OHLCV data.&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">ohlcv</span> <span class="o">=</span> <span class="n">exchange</span><span class="o">.</span><span class="n">fetch_ohlcv</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">timeframe</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">)</span>
        
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">ohlcv</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">,</span> <span class="s1">&#39;open&#39;</span><span class="p">,</span> <span class="s1">&#39;high&#39;</span><span class="p">,</span> <span class="s1">&#39;low&#39;</span><span class="p">,</span> <span class="s1">&#39;close&#39;</span><span class="p">,</span> <span class="s1">&#39;volume&#39;</span><span class="p">])</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">],</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;ms&#39;</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;timestamp&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">df</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">fetch_ohlcv</span><span class="p">(</span><span class="n">exchange</span><span class="p">,</span> <span class="s1">&#39;BTC/USDT&#39;</span><span class="p">,</span> <span class="s1">&#39;1h&#39;</span><span class="p">,</span> <span class="mi">24</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">tail</span><span class="p">())</span>
</code></pre></div>
<div class="md-cell"><h3>âœï¸ Exercise 9.2: Market Data Fetcher</h3>
<p>Build a comprehensive market data fetcher class.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="c1"># Exercise 9.2</span>
<span class="k">class</span> <span class="nc">MarketDataFetcher</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exchange</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span> <span class="o">=</span> <span class="n">exchange</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="k">def</span> <span class="nf">get_price</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">):</span>
        <span class="c1"># TODO</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">get_multiple_prices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbols</span><span class="p">):</span>
        <span class="c1"># TODO: Fetch prices for multiple symbols efficiently</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">get_ohlcv_dataframe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">timeframe</span><span class="p">,</span> <span class="n">limit</span><span class="p">):</span>
        <span class="c1"># TODO</span>
        <span class="k">pass</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">MarketDataFetcher</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exchange</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span> <span class="o">=</span> <span class="n">exchange</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache_ttl</span> <span class="o">=</span> <span class="mi">5</span>  <span class="c1"># seconds</span>

    <span class="k">def</span> <span class="nf">_is_cache_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="n">cached_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">timestamp</span><span class="p">()</span> <span class="o">-</span> <span class="n">cached_time</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_ttl</span>

    <span class="k">def</span> <span class="nf">get_price</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">):</span>
        <span class="n">cache_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;price_</span><span class="si">{</span><span class="n">symbol</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_cache_valid</span><span class="p">(</span><span class="n">cache_key</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">cache_key</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">]</span>

        <span class="n">ticker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="o">.</span><span class="n">fetch_ticker</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
        <span class="n">price_data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span>
            <span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="n">ticker</span><span class="p">[</span><span class="s1">&#39;last&#39;</span><span class="p">],</span>
            <span class="s1">&#39;bid&#39;</span><span class="p">:</span> <span class="n">ticker</span><span class="p">[</span><span class="s1">&#39;bid&#39;</span><span class="p">],</span>
            <span class="s1">&#39;ask&#39;</span><span class="p">:</span> <span class="n">ticker</span><span class="p">[</span><span class="s1">&#39;ask&#39;</span><span class="p">]</span>
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">cache_key</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="n">price_data</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">timestamp</span><span class="p">()}</span>
        <span class="k">return</span> <span class="n">price_data</span>

    <span class="k">def</span> <span class="nf">get_multiple_prices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbols</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Use fetch_tickers for efficiency</span>
            <span class="n">tickers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="o">.</span><span class="n">fetch_tickers</span><span class="p">(</span><span class="n">symbols</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span><span class="n">sym</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="n">t</span><span class="p">[</span><span class="s1">&#39;last&#39;</span><span class="p">],</span> <span class="s1">&#39;change&#39;</span><span class="p">:</span> <span class="n">t</span><span class="p">[</span><span class="s1">&#39;percentage&#39;</span><span class="p">]}</span> 
                    <span class="k">for</span> <span class="n">sym</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tickers</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="c1"># Fallback to individual fetches</span>
            <span class="k">return</span> <span class="p">{</span><span class="n">sym</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_price</span><span class="p">(</span><span class="n">sym</span><span class="p">)</span> <span class="k">for</span> <span class="n">sym</span> <span class="ow">in</span> <span class="n">symbols</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">get_ohlcv_dataframe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">timeframe</span><span class="o">=</span><span class="s1">&#39;1h&#39;</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
        <span class="n">ohlcv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="o">.</span><span class="n">fetch_ohlcv</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">timeframe</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">ohlcv</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">,</span> <span class="s1">&#39;open&#39;</span><span class="p">,</span> <span class="s1">&#39;high&#39;</span><span class="p">,</span> <span class="s1">&#39;low&#39;</span><span class="p">,</span> <span class="s1">&#39;close&#39;</span><span class="p">,</span> <span class="s1">&#39;volume&#39;</span><span class="p">])</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">],</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;ms&#39;</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;timestamp&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span>

<span class="n">fetcher</span> <span class="o">=</span> <span class="n">MarketDataFetcher</span><span class="p">(</span><span class="n">exchange</span><span class="p">)</span>
<span class="n">prices</span> <span class="o">=</span> <span class="n">fetcher</span><span class="o">.</span><span class="n">get_multiple_prices</span><span class="p">([</span><span class="s1">&#39;BTC/USDT&#39;</span><span class="p">,</span> <span class="s1">&#39;ETH/USDT&#39;</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>Section 3: Account Endpoints</h1>
<h2>3.1 Balance Information</h2>
<p><strong>Note:</strong> Requires authenticated API connection.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="k">def</span> <span class="nf">fetch_balance</span><span class="p">(</span><span class="n">exchange</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Fetch account balance.&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">balance</span> <span class="o">=</span> <span class="n">exchange</span><span class="o">.</span><span class="n">fetch_balance</span><span class="p">()</span>
        
        <span class="c1"># Filter non-zero balances</span>
        <span class="n">holdings</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">currency</span><span class="p">,</span> <span class="n">amounts</span> <span class="ow">in</span> <span class="n">balance</span><span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">amounts</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">holdings</span><span class="p">[</span><span class="n">currency</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;total&#39;</span><span class="p">:</span> <span class="n">amounts</span><span class="p">,</span>
                    <span class="s1">&#39;free&#39;</span><span class="p">:</span> <span class="n">balance</span><span class="p">[</span><span class="s1">&#39;free&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">currency</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                    <span class="s1">&#39;used&#39;</span><span class="p">:</span> <span class="n">balance</span><span class="p">[</span><span class="s1">&#39;used&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">currency</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="p">}</span>
        
        <span class="k">return</span> <span class="n">holdings</span>
    <span class="k">except</span> <span class="n">ccxt</span><span class="o">.</span><span class="n">AuthenticationError</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Authentication required&#39;</span><span class="p">}</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>

<span class="c1"># This would work with valid API credentials</span>
<span class="c1"># balance = fetch_balance(exchange)</span>
<span class="c1"># print(balance)</span>
</code></pre></div>
<div class="md-cell"><h2>3.2 Order History</h2></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="k">def</span> <span class="nf">fetch_order_history</span><span class="p">(</span><span class="n">exchange</span><span class="p">,</span> <span class="n">symbol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">50</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Fetch recent order history.&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">symbol</span><span class="p">:</span>
            <span class="n">orders</span> <span class="o">=</span> <span class="n">exchange</span><span class="o">.</span><span class="n">fetch_orders</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">orders</span> <span class="o">=</span> <span class="n">exchange</span><span class="o">.</span><span class="n">fetch_orders</span><span class="p">(</span><span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="p">[{</span>
            <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">o</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span>
            <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">o</span><span class="p">[</span><span class="s1">&#39;symbol&#39;</span><span class="p">],</span>
            <span class="s1">&#39;side&#39;</span><span class="p">:</span> <span class="n">o</span><span class="p">[</span><span class="s1">&#39;side&#39;</span><span class="p">],</span>
            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="n">o</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">],</span>
            <span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="n">o</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">],</span>
            <span class="s1">&#39;amount&#39;</span><span class="p">:</span> <span class="n">o</span><span class="p">[</span><span class="s1">&#39;amount&#39;</span><span class="p">],</span>
            <span class="s1">&#39;filled&#39;</span><span class="p">:</span> <span class="n">o</span><span class="p">[</span><span class="s1">&#39;filled&#39;</span><span class="p">],</span>
            <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="n">o</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">],</span>
            <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">o</span><span class="p">[</span><span class="s1">&#39;datetime&#39;</span><span class="p">]</span>
        <span class="p">}</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">orders</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>
</code></pre></div>
<div class="md-cell"><h3>âœï¸ Exercise 9.3: Account Dashboard</h3>
<p>Create an account information dashboard.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="c1"># Exercise 9.3</span>
<span class="k">class</span> <span class="nc">AccountDashboard</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exchange</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span> <span class="o">=</span> <span class="n">exchange</span>
    
    <span class="k">def</span> <span class="nf">get_portfolio_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">quote_currency</span><span class="o">=</span><span class="s1">&#39;USDT&#39;</span><span class="p">):</span>
        <span class="c1"># TODO: Calculate total portfolio value</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">get_open_orders</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># TODO</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">display_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># TODO: Print formatted summary</span>
        <span class="k">pass</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">AccountDashboard</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exchange</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span> <span class="o">=</span> <span class="n">exchange</span>

    <span class="k">def</span> <span class="nf">get_portfolio_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">quote_currency</span><span class="o">=</span><span class="s1">&#39;USDT&#39;</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">balance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="o">.</span><span class="n">fetch_balance</span><span class="p">()</span>
            <span class="n">total_value</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">holdings</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">currency</span><span class="p">,</span> <span class="n">amount</span> <span class="ow">in</span> <span class="n">balance</span><span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">amount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">currency</span> <span class="o">==</span> <span class="n">quote_currency</span><span class="p">:</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="n">amount</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">ticker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="o">.</span><span class="n">fetch_ticker</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">currency</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">quote_currency</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                            <span class="n">value</span> <span class="o">=</span> <span class="n">amount</span> <span class="o">*</span> <span class="n">ticker</span><span class="p">[</span><span class="s1">&#39;last&#39;</span><span class="p">]</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">value</span> <span class="o">=</span> <span class="mi">0</span>

                    <span class="k">if</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="mf">0.01</span><span class="p">:</span>  <span class="c1"># Filter dust</span>
                        <span class="n">holdings</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                            <span class="s1">&#39;currency&#39;</span><span class="p">:</span> <span class="n">currency</span><span class="p">,</span>
                            <span class="s1">&#39;amount&#39;</span><span class="p">:</span> <span class="n">amount</span><span class="p">,</span>
                            <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">value</span>
                        <span class="p">})</span>
                        <span class="n">total_value</span> <span class="o">+=</span> <span class="n">value</span>

            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;total_value&#39;</span><span class="p">:</span> <span class="n">total_value</span><span class="p">,</span> <span class="s1">&#39;holdings&#39;</span><span class="p">:</span> <span class="n">holdings</span><span class="p">}</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>

    <span class="k">def</span> <span class="nf">get_open_orders</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="o">.</span><span class="n">fetch_open_orders</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>

    <span class="k">def</span> <span class="nf">display_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=&#39;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;       ACCOUNT SUMMARY&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=&#39;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>

        <span class="n">portfolio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_portfolio_value</span><span class="p">()</span>
        <span class="k">if</span> <span class="s1">&#39;error&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">portfolio</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total Value: $</span><span class="si">{</span><span class="n">portfolio</span><span class="p">[</span><span class="s1">&#39;total_value&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">,.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Holdings:&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">portfolio</span><span class="p">[</span><span class="s1">&#39;holdings&#39;</span><span class="p">],</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">h</span><span class="p">[</span><span class="s1">&#39;currency&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">h</span><span class="p">[</span><span class="s1">&#39;amount&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> ($</span><span class="si">{</span><span class="n">h</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">,.2f</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

        <span class="n">open_orders</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_open_orders</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">open_orders</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Open Orders: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">open_orders</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=&#39;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>Section 4: Rate Limits &amp; Best Practices</h1>
<h2>4.1 Understanding Rate Limits</h2></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="kn">import</span> <span class="nn">time</span>

<span class="k">class</span> <span class="nc">RateLimitHandler</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">requests_per_minute</span><span class="o">=</span><span class="mi">60</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">requests_per_minute</span> <span class="o">=</span> <span class="n">requests_per_minute</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request_times</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">def</span> <span class="nf">wait_if_needed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Wait if we&#39;re approaching rate limit.&quot;&quot;&quot;</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">minute_ago</span> <span class="o">=</span> <span class="n">now</span> <span class="o">-</span> <span class="mi">60</span>
        
        <span class="c1"># Remove old requests</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request_times</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">request_times</span> <span class="k">if</span> <span class="n">t</span> <span class="o">&gt;</span> <span class="n">minute_ago</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request_times</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">requests_per_minute</span><span class="p">:</span>
            <span class="n">sleep_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request_times</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">minute_ago</span> <span class="o">+</span> <span class="mf">0.1</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Rate limit: sleeping </span><span class="si">{</span><span class="n">sleep_time</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">s&#39;</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">sleep_time</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">request_times</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">now</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">get_usage</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return current rate limit usage.&quot;&quot;&quot;</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">minute_ago</span> <span class="o">=</span> <span class="n">now</span> <span class="o">-</span> <span class="mi">60</span>
        <span class="n">recent</span> <span class="o">=</span> <span class="nb">len</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">request_times</span> <span class="k">if</span> <span class="n">t</span> <span class="o">&gt;</span> <span class="n">minute_ago</span><span class="p">])</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;used&#39;</span><span class="p">:</span> <span class="n">recent</span><span class="p">,</span>
            <span class="s1">&#39;limit&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">requests_per_minute</span><span class="p">,</span>
            <span class="s1">&#39;remaining&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">requests_per_minute</span> <span class="o">-</span> <span class="n">recent</span>
        <span class="p">}</span>
</code></pre></div>
<div class="md-cell"><h2>4.2 Exponential Backoff</h2></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="k">def</span> <span class="nf">fetch_with_retry</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">max_retries</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">base_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Execute function with exponential backoff on failure.&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">attempt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_retries</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">func</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">ccxt</span><span class="o">.</span><span class="n">RateLimitExceeded</span><span class="p">:</span>
            <span class="n">delay</span> <span class="o">=</span> <span class="n">base_delay</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="n">attempt</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Rate limited. Waiting </span><span class="si">{</span><span class="n">delay</span><span class="si">}</span><span class="s1">s...&#39;</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">delay</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">ccxt</span><span class="o">.</span><span class="n">NetworkError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">delay</span> <span class="o">=</span> <span class="n">base_delay</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="n">attempt</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Network error. Retrying in </span><span class="si">{</span><span class="n">delay</span><span class="si">}</span><span class="s1">s...&#39;</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">delay</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">raise</span>
    
    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Failed after </span><span class="si">{</span><span class="n">max_retries</span><span class="si">}</span><span class="s1"> attempts&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h3>âœï¸ Exercise 9.4: Rate Limit Handler</h3>
<p>Build a comprehensive rate limit handler with multiple strategies.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="c1"># Exercise 9.4</span>
<span class="k">class</span> <span class="nc">AdvancedRateLimiter</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exchange</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span> <span class="o">=</span> <span class="n">exchange</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request_history</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">def</span> <span class="nf">safe_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># TODO: Execute with rate limiting and retry</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">batch_requests</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">funcs</span><span class="p">):</span>
        <span class="c1"># TODO: Execute multiple requests with rate limiting</span>
        <span class="k">pass</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">AdvancedRateLimiter</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exchange</span><span class="p">,</span> <span class="n">requests_per_second</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span> <span class="o">=</span> <span class="n">exchange</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">requests_per_second</span> <span class="o">=</span> <span class="n">requests_per_second</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request_history</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">consecutive_errors</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">_wait_for_slot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">second_ago</span> <span class="o">=</span> <span class="n">now</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request_history</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">request_history</span> <span class="k">if</span> <span class="n">t</span> <span class="o">&gt;</span> <span class="n">second_ago</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request_history</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">requests_per_second</span><span class="p">:</span>
            <span class="n">sleep_time</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">request_history</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="mf">0.05</span>
            <span class="k">if</span> <span class="n">sleep_time</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">sleep_time</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">request_history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">safe_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">max_retries</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">attempt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_retries</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_wait_for_slot</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">consecutive_errors</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">return</span> <span class="n">result</span>
            <span class="k">except</span> <span class="n">ccxt</span><span class="o">.</span><span class="n">RateLimitExceeded</span><span class="p">:</span>
                <span class="n">delay</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">**</span> <span class="p">(</span><span class="n">attempt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Rate limited, waiting </span><span class="si">{</span><span class="n">delay</span><span class="si">}</span><span class="s1">s&#39;</span><span class="p">)</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">delay</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">consecutive_errors</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">except</span> <span class="n">ccxt</span><span class="o">.</span><span class="n">NetworkError</span><span class="p">:</span>
                <span class="n">delay</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">**</span> <span class="n">attempt</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">delay</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">consecutive_errors</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Max retries exceeded&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">batch_requests</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">funcs</span><span class="p">,</span> <span class="n">delay_between</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">func</span> <span class="ow">in</span> <span class="n">funcs</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">safe_request</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">delay_between</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">results</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>ğŸ—ï¸ Module Project: Exchange API Wrapper</h1>
<p>Build a complete exchange API wrapper combining all concepts.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="c1"># Module Project</span>
<span class="k">class</span> <span class="nc">ExchangeAPIWrapper</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exchange_id</span><span class="o">=</span><span class="s1">&#39;binance&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exchange_id</span> <span class="o">=</span> <span class="n">exchange_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rate_limiter</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connected</span> <span class="o">=</span> <span class="kc">False</span>
    
    <span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sandbox</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="c1"># TODO: Secure connection setup</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">get_price</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">):</span>
        <span class="c1"># TODO: Rate-limited price fetch</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">get_balance</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># TODO: Account balance</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">get_ohlcv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">timeframe</span><span class="p">,</span> <span class="n">limit</span><span class="p">):</span>
        <span class="c1"># TODO: Historical data</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">health_check</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># TODO: Verify connection health</span>
        <span class="k">pass</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">ExchangeAPIWrapper</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exchange_id</span><span class="o">=</span><span class="s1">&#39;binance&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exchange_id</span> <span class="o">=</span> <span class="n">exchange_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rate_limiter</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connected</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sandbox</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">api_key</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">exchange_id</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s1">_API_KEY&#39;</span><span class="p">)</span>
        <span class="n">api_secret</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">exchange_id</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s1">_API_SECRET&#39;</span><span class="p">)</span>

        <span class="n">exchange_class</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">ccxt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">exchange_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span> <span class="o">=</span> <span class="n">exchange_class</span><span class="p">({</span>
            <span class="s1">&#39;apiKey&#39;</span><span class="p">:</span> <span class="n">api_key</span><span class="p">,</span>
            <span class="s1">&#39;secret&#39;</span><span class="p">:</span> <span class="n">api_secret</span><span class="p">,</span>
            <span class="s1">&#39;sandbox&#39;</span><span class="p">:</span> <span class="n">sandbox</span><span class="p">,</span>
            <span class="s1">&#39;enableRateLimit&#39;</span><span class="p">:</span> <span class="kc">True</span>
        <span class="p">})</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">rate_limiter</span> <span class="o">=</span> <span class="n">AdvancedRateLimiter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="o">.</span><span class="n">load_markets</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connected</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">get_price</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">rate_limiter</span><span class="o">.</span><span class="n">safe_request</span><span class="p">(</span>
            <span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="o">.</span><span class="n">fetch_ticker</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_balance</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">rate_limiter</span><span class="o">.</span><span class="n">safe_request</span><span class="p">(</span>
            <span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="o">.</span><span class="n">fetch_balance</span><span class="p">()</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_ohlcv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">timeframe</span><span class="o">=</span><span class="s1">&#39;1h&#39;</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
        <span class="n">ohlcv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rate_limiter</span><span class="o">.</span><span class="n">safe_request</span><span class="p">(</span>
            <span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="o">.</span><span class="n">fetch_ohlcv</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">timeframe</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">ohlcv</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">,</span> <span class="s1">&#39;open&#39;</span><span class="p">,</span> <span class="s1">&#39;high&#39;</span><span class="p">,</span> <span class="s1">&#39;low&#39;</span><span class="p">,</span> <span class="s1">&#39;close&#39;</span><span class="p">,</span> <span class="s1">&#39;volume&#39;</span><span class="p">])</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">],</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;ms&#39;</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;timestamp&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span>

    <span class="k">def</span> <span class="nf">health_check</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="o">.</span><span class="n">fetch_status</span><span class="p">()</span>
            <span class="n">ticker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_price</span><span class="p">(</span><span class="s1">&#39;BTC/USDT&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s1">&#39;connected&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">connected</span><span class="p">,</span>
                <span class="s1">&#39;exchange_status&#39;</span><span class="p">:</span> <span class="n">status</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;status&#39;</span><span class="p">,</span> <span class="s1">&#39;unknown&#39;</span><span class="p">),</span>
                <span class="s1">&#39;btc_price&#39;</span><span class="p">:</span> <span class="n">ticker</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;last&#39;</span><span class="p">),</span>
                <span class="s1">&#39;healthy&#39;</span><span class="p">:</span> <span class="kc">True</span>
            <span class="p">}</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;healthy&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>

<span class="c1"># Usage</span>
<span class="n">api</span> <span class="o">=</span> <span class="n">ExchangeAPIWrapper</span><span class="p">(</span><span class="s1">&#39;binance&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">sandbox</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">api</span><span class="o">.</span><span class="n">health_check</span><span class="p">())</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>ğŸ“ Key Takeaways</h1>
<ol>
<li><strong>Security First</strong>: Never hardcode API keys; use environment variables</li>
<li><strong>CCXT Unified API</strong>: Access 100+ exchanges with same interface</li>
<li><strong>Rate Limits</strong>: Always implement proper rate limiting and backoff</li>
<li><strong>Caching</strong>: Cache frequently accessed data to reduce API calls</li>
</ol>
<hr />
<p><em>Next: Module 10 - Order Execution</em></p></div>
        <div class="nav-buttons">
            <button class="nav-btn prev-btn disabled" type="button">
                <span class="nav-btn-label">â† Previous</span>
                <span class="nav-btn-name"></span>
            </button>
            <button class="nav-btn next-btn disabled" type="button">
                <span class="nav-btn-label">Next â†’</span>
                <span class="nav-btn-name"></span>
            </button>
        </div>
        </div>
<div class="module-section" data-idx="10"><div class="md-cell module-header"><h1>Module 10: Order Execution</h1>
<h2>Part 3: Exchange Integration</h2>
<hr />
<div class="table-wrapper"><table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>â±ï¸ <strong>Duration</strong></td>
<td>~2.5 hours</td>
</tr>
<tr>
<td>ğŸ“‹ <strong>Prerequisites</strong></td>
<td>Module 9</td>
</tr>
<tr>
<td>ğŸ’ª <strong>Exercises</strong></td>
<td>5 total</td>
</tr>
</tbody>
</table></div></div>
<div class="md-cell"><h2>ğŸ¯ Learning Objectives</h2>
<ul>
<li>Understand different order types</li>
<li>Place orders programmatically</li>
<li>Manage open orders</li>
<li>Analyze execution quality</li>
</ul></div>
<div class="md-cell"><hr />
<h1>Section 1: Order Types</h1>
<h2>1.1 Market Orders</h2>
<p>Execute immediately at best available price.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="kn">import</span> <span class="nn">ccxt</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>

<span class="c1"># Order type comparison</span>
<span class="n">order_types</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;market&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;execution&#39;</span><span class="p">:</span> <span class="s1">&#39;Immediate&#39;</span><span class="p">,</span>
        <span class="s1">&#39;price_guarantee&#39;</span><span class="p">:</span> <span class="s1">&#39;No&#39;</span><span class="p">,</span>
        <span class="s1">&#39;best_for&#39;</span><span class="p">:</span> <span class="s1">&#39;Fast execution needed&#39;</span><span class="p">,</span>
        <span class="s1">&#39;risk&#39;</span><span class="p">:</span> <span class="s1">&#39;Slippage in volatile markets&#39;</span>
    <span class="p">},</span>
    <span class="s1">&#39;limit&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;execution&#39;</span><span class="p">:</span> <span class="s1">&#39;When price reached&#39;</span><span class="p">,</span>
        <span class="s1">&#39;price_guarantee&#39;</span><span class="p">:</span> <span class="s1">&#39;Yes&#39;</span><span class="p">,</span>
        <span class="s1">&#39;best_for&#39;</span><span class="p">:</span> <span class="s1">&#39;Price control&#39;</span><span class="p">,</span>
        <span class="s1">&#39;risk&#39;</span><span class="p">:</span> <span class="s1">&#39;May not fill&#39;</span>
    <span class="p">},</span>
    <span class="s1">&#39;stop&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;execution&#39;</span><span class="p">:</span> <span class="s1">&#39;When stop price hit&#39;</span><span class="p">,</span>
        <span class="s1">&#39;price_guarantee&#39;</span><span class="p">:</span> <span class="s1">&#39;No&#39;</span><span class="p">,</span>
        <span class="s1">&#39;best_for&#39;</span><span class="p">:</span> <span class="s1">&#39;Stop losses&#39;</span><span class="p">,</span>
        <span class="s1">&#39;risk&#39;</span><span class="p">:</span> <span class="s1">&#39;Gap through stop&#39;</span>
    <span class="p">},</span>
    <span class="s1">&#39;stop_limit&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;execution&#39;</span><span class="p">:</span> <span class="s1">&#39;Limit order after stop hit&#39;</span><span class="p">,</span>
        <span class="s1">&#39;price_guarantee&#39;</span><span class="p">:</span> <span class="s1">&#39;Yes (if filled)&#39;</span><span class="p">,</span>
        <span class="s1">&#39;best_for&#39;</span><span class="p">:</span> <span class="s1">&#39;Controlled stop losses&#39;</span><span class="p">,</span>
        <span class="s1">&#39;risk&#39;</span><span class="p">:</span> <span class="s1">&#39;May not fill in fast markets&#39;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">for</span> <span class="n">otype</span><span class="p">,</span> <span class="n">details</span> <span class="ow">in</span> <span class="n">order_types</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">otype</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">details</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h2>1.2 Order Parameters</h2></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">OrderBuilder</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Helper class to build valid orders.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exchange</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span> <span class="o">=</span> <span class="n">exchange</span>
    
    <span class="k">def</span> <span class="nf">market_buy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create market buy order parameters.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span>
            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;market&#39;</span><span class="p">,</span>
            <span class="s1">&#39;side&#39;</span><span class="p">:</span> <span class="s1">&#39;buy&#39;</span><span class="p">,</span>
            <span class="s1">&#39;amount&#39;</span><span class="p">:</span> <span class="n">amount</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">market_sell</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create market sell order parameters.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span>
            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;market&#39;</span><span class="p">,</span>
            <span class="s1">&#39;side&#39;</span><span class="p">:</span> <span class="s1">&#39;sell&#39;</span><span class="p">,</span>
            <span class="s1">&#39;amount&#39;</span><span class="p">:</span> <span class="n">amount</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">limit_buy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">price</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create limit buy order parameters.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span>
            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;limit&#39;</span><span class="p">,</span>
            <span class="s1">&#39;side&#39;</span><span class="p">:</span> <span class="s1">&#39;buy&#39;</span><span class="p">,</span>
            <span class="s1">&#39;amount&#39;</span><span class="p">:</span> <span class="n">amount</span><span class="p">,</span>
            <span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="n">price</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">limit_sell</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">price</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create limit sell order parameters.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span>
            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;limit&#39;</span><span class="p">,</span>
            <span class="s1">&#39;side&#39;</span><span class="p">:</span> <span class="s1">&#39;sell&#39;</span><span class="p">,</span>
            <span class="s1">&#39;amount&#39;</span><span class="p">:</span> <span class="n">amount</span><span class="p">,</span>
            <span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="n">price</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">stop_loss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">stop_price</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create stop loss order parameters.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span>
            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;stop&#39;</span><span class="p">,</span>
            <span class="s1">&#39;side&#39;</span><span class="p">:</span> <span class="s1">&#39;sell&#39;</span><span class="p">,</span>
            <span class="s1">&#39;amount&#39;</span><span class="p">:</span> <span class="n">amount</span><span class="p">,</span>
            <span class="s1">&#39;stopPrice&#39;</span><span class="p">:</span> <span class="n">stop_price</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">validate_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order_params</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Validate order against exchange limits.&quot;&quot;&quot;</span>
        <span class="n">symbol</span> <span class="o">=</span> <span class="n">order_params</span><span class="p">[</span><span class="s1">&#39;symbol&#39;</span><span class="p">]</span>
        <span class="n">market</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="o">.</span><span class="n">market</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
        
        <span class="n">checks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">amount</span> <span class="o">=</span> <span class="n">order_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;amount&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">price</span> <span class="o">=</span> <span class="n">order_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;price&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        
        <span class="c1"># Check minimum amount</span>
        <span class="n">min_amount</span> <span class="o">=</span> <span class="n">market</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;limits&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;amount&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;min&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">amount</span> <span class="o">&lt;</span> <span class="n">min_amount</span><span class="p">:</span>
            <span class="n">checks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Amount </span><span class="si">{</span><span class="n">amount</span><span class="si">}</span><span class="s1"> below minimum </span><span class="si">{</span><span class="n">min_amount</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        
        <span class="c1"># Check price precision</span>
        <span class="k">if</span> <span class="n">price</span><span class="p">:</span>
            <span class="n">precision</span> <span class="o">=</span> <span class="n">market</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;precision&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;price&#39;</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
            <span class="c1"># Round to precision</span>
            <span class="n">order_params</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">price</span><span class="p">,</span> <span class="n">precision</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;valid&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">checks</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;issues&#39;</span><span class="p">:</span> <span class="n">checks</span><span class="p">,</span> <span class="s1">&#39;order&#39;</span><span class="p">:</span> <span class="n">order_params</span><span class="p">}</span>
</code></pre></div>
<div class="md-cell"><h3>âœï¸ Exercise 10.1: Order Type Comparison</h3>
<p>Create a function that recommends the best order type based on market conditions.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="c1"># Exercise 10.1</span>
<span class="k">def</span> <span class="nf">recommend_order_type</span><span class="p">(</span><span class="n">urgency</span><span class="p">,</span> <span class="n">price_sensitivity</span><span class="p">,</span> <span class="n">volatility</span><span class="p">,</span> <span class="n">order_book_depth</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Recommend order type based on conditions.</span>
<span class="sd">    </span>
<span class="sd">    urgency: &#39;high&#39;, &#39;medium&#39;, &#39;low&#39;</span>
<span class="sd">    price_sensitivity: &#39;high&#39;, &#39;medium&#39;, &#39;low&#39;</span>
<span class="sd">    volatility: float (e.g., 0.05 for 5%)</span>
<span class="sd">    order_book_depth: &#39;deep&#39;, &#39;shallow&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO: Implement recommendation logic</span>
    <span class="k">pass</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">recommend_order_type</span><span class="p">(</span><span class="n">urgency</span><span class="p">,</span> <span class="n">price_sensitivity</span><span class="p">,</span> <span class="n">volatility</span><span class="p">,</span> <span class="n">order_book_depth</span><span class="p">):</span>
    <span class="n">recommendations</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># High urgency scenarios</span>
    <span class="k">if</span> <span class="n">urgency</span> <span class="o">==</span> <span class="s1">&#39;high&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">order_book_depth</span> <span class="o">==</span> <span class="s1">&#39;deep&#39;</span> <span class="ow">and</span> <span class="n">volatility</span> <span class="o">&lt;</span> <span class="mf">0.02</span><span class="p">:</span>
            <span class="n">recommendations</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;market&#39;</span><span class="p">,</span>
                <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="s1">&#39;Deep book with low volatility - market order safe&#39;</span>
            <span class="p">})</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">recommendations</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;limit&#39;</span><span class="p">,</span>
                <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="s1">&#39;Use aggressive limit (near best ask/bid) for protection&#39;</span><span class="p">,</span>
                <span class="s1">&#39;tip&#39;</span><span class="p">:</span> <span class="s1">&#39;Set limit slightly worse than current price&#39;</span>
            <span class="p">})</span>

    <span class="c1"># Price sensitive scenarios</span>
    <span class="k">elif</span> <span class="n">price_sensitivity</span> <span class="o">==</span> <span class="s1">&#39;high&#39;</span><span class="p">:</span>
        <span class="n">recommendations</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;limit&#39;</span><span class="p">,</span>
            <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="s1">&#39;Price guarantee important&#39;</span><span class="p">,</span>
            <span class="s1">&#39;tip&#39;</span><span class="p">:</span> <span class="s1">&#39;May need to wait for fill&#39;</span>
        <span class="p">})</span>

    <span class="c1"># Low urgency, low sensitivity</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">volatility</span> <span class="o">&gt;</span> <span class="mf">0.03</span><span class="p">:</span>
            <span class="n">recommendations</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;limit&#39;</span><span class="p">,</span>
                <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="s1">&#39;High volatility - wait for better price&#39;</span>
            <span class="p">})</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">recommendations</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;market&#39;</span><span class="p">,</span>
                <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="s1">&#39;Stable conditions - market order acceptable&#39;</span>
            <span class="p">})</span>

    <span class="k">return</span> <span class="n">recommendations</span>

<span class="c1"># Test</span>
<span class="n">rec</span> <span class="o">=</span> <span class="n">recommend_order_type</span><span class="p">(</span><span class="s1">&#39;high&#39;</span><span class="p">,</span> <span class="s1">&#39;low&#39;</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="s1">&#39;deep&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">rec</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>Section 2: Order Placement</h1></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">OrderExecutor</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Execute orders with proper error handling.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exchange</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span> <span class="o">=</span> <span class="n">exchange</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">order_history</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">def</span> <span class="nf">place_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">side</span><span class="p">,</span> <span class="n">order_type</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">price</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Place an order with comprehensive error handling.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">order_type</span> <span class="o">==</span> <span class="s1">&#39;market&#39;</span><span class="p">:</span>
                <span class="n">order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="o">.</span><span class="n">create_market_order</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">side</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">params</span> <span class="ow">or</span> <span class="p">{})</span>
            <span class="k">elif</span> <span class="n">order_type</span> <span class="o">==</span> <span class="s1">&#39;limit&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">price</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Limit orders require a price&#39;</span><span class="p">)</span>
                <span class="n">order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="o">.</span><span class="n">create_limit_order</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">side</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">price</span><span class="p">,</span> <span class="n">params</span> <span class="ow">or</span> <span class="p">{})</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="o">.</span><span class="n">create_order</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">order_type</span><span class="p">,</span> <span class="n">side</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">price</span><span class="p">,</span> <span class="n">params</span> <span class="ow">or</span> <span class="p">{})</span>
            
            <span class="c1"># Log the order</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">order_history</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
                <span class="s1">&#39;order&#39;</span><span class="p">:</span> <span class="n">order</span><span class="p">,</span>
                <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;placed&#39;</span>
            <span class="p">})</span>
            
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;order&#39;</span><span class="p">:</span> <span class="n">order</span><span class="p">}</span>
        
        <span class="k">except</span> <span class="n">ccxt</span><span class="o">.</span><span class="n">InsufficientFunds</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Insufficient funds&#39;</span><span class="p">,</span> <span class="s1">&#39;details&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>
        <span class="k">except</span> <span class="n">ccxt</span><span class="o">.</span><span class="n">InvalidOrder</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Invalid order&#39;</span><span class="p">,</span> <span class="s1">&#39;details&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>
        <span class="k">except</span> <span class="n">ccxt</span><span class="o">.</span><span class="n">NetworkError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Network error&#39;</span><span class="p">,</span> <span class="s1">&#39;details&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Unknown error&#39;</span><span class="p">,</span> <span class="s1">&#39;details&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>
    
    <span class="k">def</span> <span class="nf">place_with_confirmation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">side</span><span class="p">,</span> <span class="n">order_type</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">price</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Place order and wait for confirmation.&quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">place_order</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">side</span><span class="p">,</span> <span class="n">order_type</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">price</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;success&#39;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="n">result</span>
        
        <span class="n">order_id</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;order&#39;</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
        
        <span class="c1"># Poll for confirmation (for limit orders)</span>
        <span class="k">if</span> <span class="n">order_type</span> <span class="o">==</span> <span class="s1">&#39;limit&#39;</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">time</span>
            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>  <span class="c1"># Check up to 10 times</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="o">.</span><span class="n">fetch_order</span><span class="p">(</span><span class="n">order_id</span><span class="p">,</span> <span class="n">symbol</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">status</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;closed&#39;</span><span class="p">:</span>
                    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;order&#39;</span><span class="p">:</span> <span class="n">status</span><span class="p">,</span> <span class="s1">&#39;filled&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
                <span class="k">elif</span> <span class="n">status</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;canceled&#39;</span><span class="p">:</span>
                    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Order canceled&#39;</span><span class="p">}</span>
            
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;order&#39;</span><span class="p">:</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;order&#39;</span><span class="p">],</span> <span class="s1">&#39;filled&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;note&#39;</span><span class="p">:</span> <span class="s1">&#39;Still open&#39;</span><span class="p">}</span>
        
        <span class="k">return</span> <span class="n">result</span>
</code></pre></div>
<div class="md-cell"><h3>âœï¸ Exercise 10.2: Order Execution System</h3>
<p>Build a complete order execution system with pre-trade checks.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="c1"># Exercise 10.2</span>
<span class="k">class</span> <span class="nc">OrderExecutionSystem</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exchange</span><span class="p">,</span> <span class="n">max_slippage</span><span class="o">=</span><span class="mf">0.01</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span> <span class="o">=</span> <span class="n">exchange</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_slippage</span> <span class="o">=</span> <span class="n">max_slippage</span>
    
    <span class="k">def</span> <span class="nf">pre_trade_checks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">side</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">price</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># TODO: Check balance, market conditions, etc.</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">side</span><span class="p">,</span> <span class="n">order_type</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">price</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># TODO: Execute with pre-checks</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">calculate_expected_fill</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">side</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
        <span class="c1"># TODO: Estimate fill price from order book</span>
        <span class="k">pass</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">OrderExecutionSystem</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exchange</span><span class="p">,</span> <span class="n">max_slippage</span><span class="o">=</span><span class="mf">0.01</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span> <span class="o">=</span> <span class="n">exchange</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_slippage</span> <span class="o">=</span> <span class="n">max_slippage</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">executor</span> <span class="o">=</span> <span class="n">OrderExecutor</span><span class="p">(</span><span class="n">exchange</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">pre_trade_checks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">side</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">price</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">checks</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;passed&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;issues&#39;</span><span class="p">:</span> <span class="p">[]}</span>

        <span class="c1"># Check balance</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">balance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="o">.</span><span class="n">fetch_balance</span><span class="p">()</span>
            <span class="n">base</span><span class="p">,</span> <span class="n">quote</span> <span class="o">=</span> <span class="n">symbol</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">side</span> <span class="o">==</span> <span class="s1">&#39;buy&#39;</span><span class="p">:</span>
                <span class="n">required</span> <span class="o">=</span> <span class="n">amount</span> <span class="o">*</span> <span class="p">(</span><span class="n">price</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="o">.</span><span class="n">fetch_ticker</span><span class="p">(</span><span class="n">symbol</span><span class="p">)[</span><span class="s1">&#39;ask&#39;</span><span class="p">])</span>
                <span class="n">available</span> <span class="o">=</span> <span class="n">balance</span><span class="p">[</span><span class="s1">&#39;free&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">quote</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">required</span> <span class="o">&gt;</span> <span class="n">available</span><span class="p">:</span>
                    <span class="n">checks</span><span class="p">[</span><span class="s1">&#39;passed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">checks</span><span class="p">[</span><span class="s1">&#39;issues&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Insufficient </span><span class="si">{</span><span class="n">quote</span><span class="si">}</span><span class="s1">: need </span><span class="si">{</span><span class="n">required</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">, have </span><span class="si">{</span><span class="n">available</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">available</span> <span class="o">=</span> <span class="n">balance</span><span class="p">[</span><span class="s1">&#39;free&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">amount</span> <span class="o">&gt;</span> <span class="n">available</span><span class="p">:</span>
                    <span class="n">checks</span><span class="p">[</span><span class="s1">&#39;passed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">checks</span><span class="p">[</span><span class="s1">&#39;issues&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Insufficient </span><span class="si">{</span><span class="n">base</span><span class="si">}</span><span class="s1">: need </span><span class="si">{</span><span class="n">amount</span><span class="si">}</span><span class="s1">, have </span><span class="si">{</span><span class="n">available</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">checks</span><span class="p">[</span><span class="s1">&#39;issues&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Could not verify balance&#39;</span><span class="p">)</span>

        <span class="c1"># Check slippage</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_expected_fill</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">side</span><span class="p">,</span> <span class="n">amount</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">expected</span> <span class="ow">and</span> <span class="n">price</span><span class="p">:</span>
            <span class="n">slippage</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">expected</span> <span class="o">-</span> <span class="n">price</span><span class="p">)</span> <span class="o">/</span> <span class="n">price</span>
            <span class="k">if</span> <span class="n">slippage</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_slippage</span><span class="p">:</span>
                <span class="n">checks</span><span class="p">[</span><span class="s1">&#39;passed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">checks</span><span class="p">[</span><span class="s1">&#39;issues&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Expected slippage </span><span class="si">{</span><span class="n">slippage</span><span class="si">:</span><span class="s1">.2%</span><span class="si">}</span><span class="s1"> exceeds max </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">max_slippage</span><span class="si">:</span><span class="s1">.2%</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">checks</span>

    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">side</span><span class="p">,</span> <span class="n">order_type</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">price</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># Pre-checks</span>
        <span class="n">checks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre_trade_checks</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">side</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">price</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">checks</span><span class="p">[</span><span class="s1">&#39;passed&#39;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Pre-trade checks failed&#39;</span><span class="p">,</span> <span class="s1">&#39;issues&#39;</span><span class="p">:</span> <span class="n">checks</span><span class="p">[</span><span class="s1">&#39;issues&#39;</span><span class="p">]}</span>

        <span class="c1"># Execute</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">executor</span><span class="o">.</span><span class="n">place_order</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">side</span><span class="p">,</span> <span class="n">order_type</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">price</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">calculate_expected_fill</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">side</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">book</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="o">.</span><span class="n">fetch_order_book</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
            <span class="n">levels</span> <span class="o">=</span> <span class="n">book</span><span class="p">[</span><span class="s1">&#39;asks&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">side</span> <span class="o">==</span> <span class="s1">&#39;buy&#39;</span> <span class="k">else</span> <span class="n">book</span><span class="p">[</span><span class="s1">&#39;bids&#39;</span><span class="p">]</span>

            <span class="n">remaining</span> <span class="o">=</span> <span class="n">amount</span>
            <span class="n">total_cost</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="k">for</span> <span class="n">price</span><span class="p">,</span> <span class="n">size</span> <span class="ow">in</span> <span class="n">levels</span><span class="p">:</span>
                <span class="n">fill_size</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">remaining</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>
                <span class="n">total_cost</span> <span class="o">+=</span> <span class="n">fill_size</span> <span class="o">*</span> <span class="n">price</span>
                <span class="n">remaining</span> <span class="o">-=</span> <span class="n">fill_size</span>
                <span class="k">if</span> <span class="n">remaining</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">break</span>

            <span class="k">if</span> <span class="n">remaining</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>  <span class="c1"># Not enough liquidity</span>

            <span class="k">return</span> <span class="n">total_cost</span> <span class="o">/</span> <span class="n">amount</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>Section 3: Order Management</h1></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">OrderManager</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Manage open orders.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exchange</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span> <span class="o">=</span> <span class="n">exchange</span>
    
    <span class="k">def</span> <span class="nf">get_open_orders</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Fetch all open orders.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">symbol</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="o">.</span><span class="n">fetch_open_orders</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="o">.</span><span class="n">fetch_open_orders</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>
    
    <span class="k">def</span> <span class="nf">get_order_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order_id</span><span class="p">,</span> <span class="n">symbol</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get status of specific order.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="o">.</span><span class="n">fetch_order</span><span class="p">(</span><span class="n">order_id</span><span class="p">,</span> <span class="n">symbol</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">order</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span>
                <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="n">order</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">],</span>
                <span class="s1">&#39;filled&#39;</span><span class="p">:</span> <span class="n">order</span><span class="p">[</span><span class="s1">&#39;filled&#39;</span><span class="p">],</span>
                <span class="s1">&#39;remaining&#39;</span><span class="p">:</span> <span class="n">order</span><span class="p">[</span><span class="s1">&#39;remaining&#39;</span><span class="p">],</span>
                <span class="s1">&#39;average&#39;</span><span class="p">:</span> <span class="n">order</span><span class="p">[</span><span class="s1">&#39;average&#39;</span><span class="p">],</span>
                <span class="s1">&#39;cost&#39;</span><span class="p">:</span> <span class="n">order</span><span class="p">[</span><span class="s1">&#39;cost&#39;</span><span class="p">]</span>
            <span class="p">}</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>
    
    <span class="k">def</span> <span class="nf">cancel_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order_id</span><span class="p">,</span> <span class="n">symbol</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Cancel an open order.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="o">.</span><span class="n">cancel_order</span><span class="p">(</span><span class="n">order_id</span><span class="p">,</span> <span class="n">symbol</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="n">result</span><span class="p">}</span>
        <span class="k">except</span> <span class="n">ccxt</span><span class="o">.</span><span class="n">OrderNotFound</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Order not found&#39;</span><span class="p">}</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>
    
    <span class="k">def</span> <span class="nf">cancel_all_orders</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Cancel all open orders.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">symbol</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="o">.</span><span class="n">cancel_all_orders</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="o">.</span><span class="n">cancel_all_orders</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>
    
    <span class="k">def</span> <span class="nf">modify_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order_id</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">new_price</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">new_amount</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Modify an existing order (cancel and replace).&quot;&quot;&quot;</span>
        <span class="c1"># Most exchanges don&#39;t support true modification</span>
        <span class="c1"># So we cancel and create new order</span>
        
        <span class="c1"># Get original order</span>
        <span class="n">original</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="o">.</span><span class="n">fetch_order</span><span class="p">(</span><span class="n">order_id</span><span class="p">,</span> <span class="n">symbol</span><span class="p">)</span>
        
        <span class="c1"># Cancel it</span>
        <span class="n">cancel_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cancel_order</span><span class="p">(</span><span class="n">order_id</span><span class="p">,</span> <span class="n">symbol</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">cancel_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;success&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">cancel_result</span>
        
        <span class="c1"># Create new order</span>
        <span class="n">new_order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="o">.</span><span class="n">create_order</span><span class="p">(</span>
            <span class="n">symbol</span><span class="p">,</span>
            <span class="n">original</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">],</span>
            <span class="n">original</span><span class="p">[</span><span class="s1">&#39;side&#39;</span><span class="p">],</span>
            <span class="n">new_amount</span> <span class="ow">or</span> <span class="n">original</span><span class="p">[</span><span class="s1">&#39;remaining&#39;</span><span class="p">],</span>
            <span class="n">new_price</span> <span class="ow">or</span> <span class="n">original</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]</span>
        <span class="p">)</span>
        
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;old_order&#39;</span><span class="p">:</span> <span class="n">order_id</span><span class="p">,</span> <span class="s1">&#39;new_order&#39;</span><span class="p">:</span> <span class="n">new_order</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]}</span>
</code></pre></div>
<div class="md-cell"><h3>âœï¸ Exercise 10.3: Order Manager</h3>
<p>Build an advanced order manager with order tracking.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="c1"># Exercise 10.3</span>
<span class="k">class</span> <span class="nc">AdvancedOrderManager</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exchange</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span> <span class="o">=</span> <span class="n">exchange</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tracked_orders</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="k">def</span> <span class="nf">track_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order_id</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># TODO: Add order to tracking</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">update_all_statuses</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># TODO: Update status of all tracked orders</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">get_filled_orders</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># TODO: Return all filled orders</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">cleanup_completed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># TODO: Remove completed orders from tracking</span>
        <span class="k">pass</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">AdvancedOrderManager</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exchange</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span> <span class="o">=</span> <span class="n">exchange</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tracked_orders</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">track_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order_id</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tracked_orders</span><span class="p">[</span><span class="n">order_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span>
            <span class="s1">&#39;metadata&#39;</span><span class="p">:</span> <span class="n">metadata</span> <span class="ow">or</span> <span class="p">{},</span>
            <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;open&#39;</span><span class="p">,</span>
            <span class="s1">&#39;last_update&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
            <span class="s1">&#39;history&#39;</span><span class="p">:</span> <span class="p">[]</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">update_all_statuses</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">updated</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">order_id</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tracked_orders</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;open&#39;</span><span class="p">,</span> <span class="s1">&#39;partially_filled&#39;</span><span class="p">]:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="o">.</span><span class="n">fetch_order</span><span class="p">(</span><span class="n">order_id</span><span class="p">,</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;symbol&#39;</span><span class="p">])</span>
                    <span class="n">old_status</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span>
                    <span class="n">info</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">order</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span>
                    <span class="n">info</span><span class="p">[</span><span class="s1">&#39;filled&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">order</span><span class="p">[</span><span class="s1">&#39;filled&#39;</span><span class="p">]</span>
                    <span class="n">info</span><span class="p">[</span><span class="s1">&#39;average&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">order</span><span class="p">[</span><span class="s1">&#39;average&#39;</span><span class="p">]</span>
                    <span class="n">info</span><span class="p">[</span><span class="s1">&#39;last_update&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>

                    <span class="k">if</span> <span class="n">old_status</span> <span class="o">!=</span> <span class="n">order</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]:</span>
                        <span class="n">info</span><span class="p">[</span><span class="s1">&#39;history&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                            <span class="s1">&#39;from&#39;</span><span class="p">:</span> <span class="n">old_status</span><span class="p">,</span>
                            <span class="s1">&#39;to&#39;</span><span class="p">:</span> <span class="n">order</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">],</span>
                            <span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
                        <span class="p">})</span>
                        <span class="n">updated</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">order_id</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">info</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">updated</span>

    <span class="k">def</span> <span class="nf">get_filled_orders</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="n">oid</span><span class="p">:</span> <span class="n">info</span> <span class="k">for</span> <span class="n">oid</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tracked_orders</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;closed&#39;</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">get_open_orders</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="n">oid</span><span class="p">:</span> <span class="n">info</span> <span class="k">for</span> <span class="n">oid</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tracked_orders</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;open&#39;</span><span class="p">,</span> <span class="s1">&#39;partially_filled&#39;</span><span class="p">]</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">cleanup_completed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">completed</span> <span class="o">=</span> <span class="p">[</span><span class="n">oid</span> <span class="k">for</span> <span class="n">oid</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tracked_orders</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                     <span class="k">if</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;closed&#39;</span><span class="p">,</span> <span class="s1">&#39;canceled&#39;</span><span class="p">]]</span>
        <span class="k">for</span> <span class="n">oid</span> <span class="ow">in</span> <span class="n">completed</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">tracked_orders</span><span class="p">[</span><span class="n">oid</span><span class="p">]</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">completed</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>Section 4: Execution Quality</h1></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">ExecutionAnalyzer</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Analyze execution quality.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">executions</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">def</span> <span class="nf">record_execution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">intended_price</span><span class="p">,</span> <span class="n">actual_price</span><span class="p">,</span> <span class="n">side</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Record an execution for analysis.&quot;&quot;&quot;</span>
        <span class="n">slippage</span> <span class="o">=</span> <span class="p">(</span><span class="n">actual_price</span> <span class="o">-</span> <span class="n">intended_price</span><span class="p">)</span> <span class="o">/</span> <span class="n">intended_price</span>
        <span class="k">if</span> <span class="n">side</span> <span class="o">==</span> <span class="s1">&#39;sell&#39;</span><span class="p">:</span>
            <span class="n">slippage</span> <span class="o">=</span> <span class="o">-</span><span class="n">slippage</span>  <span class="c1"># For sells, getting less is bad</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">executions</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
            <span class="s1">&#39;intended&#39;</span><span class="p">:</span> <span class="n">intended_price</span><span class="p">,</span>
            <span class="s1">&#39;actual&#39;</span><span class="p">:</span> <span class="n">actual_price</span><span class="p">,</span>
            <span class="s1">&#39;side&#39;</span><span class="p">:</span> <span class="n">side</span><span class="p">,</span>
            <span class="s1">&#39;amount&#39;</span><span class="p">:</span> <span class="n">amount</span><span class="p">,</span>
            <span class="s1">&#39;slippage&#39;</span><span class="p">:</span> <span class="n">slippage</span><span class="p">,</span>
            <span class="s1">&#39;slippage_cost&#39;</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">actual_price</span> <span class="o">-</span> <span class="n">intended_price</span><span class="p">)</span> <span class="o">*</span> <span class="n">amount</span>
        <span class="p">})</span>
    
    <span class="k">def</span> <span class="nf">get_statistics</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculate execution statistics.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">executions</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;No executions recorded&#39;</span><span class="p">}</span>
        
        <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
        <span class="n">slippages</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span><span class="p">[</span><span class="s1">&#39;slippage&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">executions</span><span class="p">]</span>
        <span class="n">costs</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span><span class="p">[</span><span class="s1">&#39;slippage_cost&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">executions</span><span class="p">]</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;total_executions&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">executions</span><span class="p">),</span>
            <span class="s1">&#39;avg_slippage&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">slippages</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
            <span class="s1">&#39;max_slippage&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">slippages</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
            <span class="s1">&#39;total_slippage_cost&#39;</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="n">costs</span><span class="p">),</span>
            <span class="s1">&#39;positive_slippage_count&#39;</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">slippages</span> <span class="k">if</span> <span class="n">s</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">),</span>
            <span class="s1">&#39;negative_slippage_count&#39;</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">slippages</span> <span class="k">if</span> <span class="n">s</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">analyze_by_time</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Analyze execution quality by time of day.&quot;&quot;&quot;</span>
        <span class="n">by_hour</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">executions</span><span class="p">:</span>
            <span class="n">hour</span> <span class="o">=</span> <span class="n">e</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">hour</span>
            <span class="k">if</span> <span class="n">hour</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">by_hour</span><span class="p">:</span>
                <span class="n">by_hour</span><span class="p">[</span><span class="n">hour</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">by_hour</span><span class="p">[</span><span class="n">hour</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="s1">&#39;slippage&#39;</span><span class="p">])</span>
        
        <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="n">hour</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;avg_slippage&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">slips</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="s1">&#39;count&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">slips</span><span class="p">)}</span>
            <span class="k">for</span> <span class="n">hour</span><span class="p">,</span> <span class="n">slips</span> <span class="ow">in</span> <span class="n">by_hour</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">}</span>
</code></pre></div>
<div class="md-cell"><h3>âœï¸ Exercise 10.4: Execution Analyzer</h3>
<p>Build a comprehensive execution analysis system.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="c1"># Exercise 10.4</span>
<span class="k">class</span> <span class="nc">ComprehensiveExecutionAnalyzer</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trades</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">def</span> <span class="nf">add_trade</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">fill_info</span><span class="p">):</span>
        <span class="c1"># TODO: Record trade with fill information</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">calculate_vwap_slippage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trades</span><span class="p">):</span>
        <span class="c1"># TODO: Compare execution to VWAP</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">generate_report</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># TODO: Generate execution quality report</span>
        <span class="k">pass</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">ComprehensiveExecutionAnalyzer</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trades</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">add_trade</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">fill_info</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trades</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
            <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;symbol&#39;</span><span class="p">),</span>
            <span class="s1">&#39;side&#39;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;side&#39;</span><span class="p">),</span>
            <span class="s1">&#39;intended_price&#39;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;price&#39;</span><span class="p">),</span>
            <span class="s1">&#39;filled_price&#39;</span><span class="p">:</span> <span class="n">fill_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;average&#39;</span><span class="p">),</span>
            <span class="s1">&#39;amount&#39;</span><span class="p">:</span> <span class="n">fill_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;filled&#39;</span><span class="p">),</span>
            <span class="s1">&#39;fees&#39;</span><span class="p">:</span> <span class="n">fill_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fees&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
            <span class="s1">&#39;fill_time_ms&#39;</span><span class="p">:</span> <span class="n">fill_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fill_time_ms&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">})</span>

    <span class="k">def</span> <span class="nf">calculate_vwap_slippage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">execution_price</span><span class="p">,</span> <span class="n">market_vwap</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">execution_price</span> <span class="o">-</span> <span class="n">market_vwap</span><span class="p">)</span> <span class="o">/</span> <span class="n">market_vwap</span> <span class="o">*</span> <span class="mi">100</span>

    <span class="k">def</span> <span class="nf">generate_report</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">trades</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;No trades to analyze&#39;</span>

        <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

        <span class="n">slippages</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trades</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">t</span><span class="p">[</span><span class="s1">&#39;intended_price&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">t</span><span class="p">[</span><span class="s1">&#39;filled_price&#39;</span><span class="p">]:</span>
                <span class="n">slip</span> <span class="o">=</span> <span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="s1">&#39;filled_price&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">t</span><span class="p">[</span><span class="s1">&#39;intended_price&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="n">t</span><span class="p">[</span><span class="s1">&#39;intended_price&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">t</span><span class="p">[</span><span class="s1">&#39;side&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;sell&#39;</span><span class="p">:</span>
                    <span class="n">slip</span> <span class="o">=</span> <span class="o">-</span><span class="n">slip</span>
                <span class="n">slippages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">slip</span><span class="p">)</span>

        <span class="n">total_fees</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fees&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trades</span><span class="p">)</span>
        <span class="n">total_volume</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="s1">&#39;amount&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="s1">&#39;filled_price&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trades</span><span class="p">)</span>

        <span class="n">report</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;=&#39;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;     EXECUTION QUALITY REPORT&#39;</span><span class="p">)</span>
        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;=&#39;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Total Trades: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trades</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Total Volume: $</span><span class="si">{</span><span class="n">total_volume</span><span class="si">:</span><span class="s1">,.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Total Fees: $</span><span class="si">{</span><span class="n">total_fees</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;SLIPPAGE ANALYSIS:&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">slippages</span><span class="p">:</span>
            <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;  Average: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">slippages</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">%&#39;</span><span class="p">)</span>
            <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;  Std Dev: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">slippages</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">%&#39;</span><span class="p">)</span>
            <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;  Best: </span><span class="si">{</span><span class="nb">min</span><span class="p">(</span><span class="n">slippages</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">%&#39;</span><span class="p">)</span>
            <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;  Worst: </span><span class="si">{</span><span class="nb">max</span><span class="p">(</span><span class="n">slippages</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">%&#39;</span><span class="p">)</span>
        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;=&#39;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>

        <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">report</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>ğŸ—ï¸ Module Project: Order Execution System</h1>
<p>Build a complete order execution system.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="c1"># Module Project</span>
<span class="k">class</span> <span class="nc">CompleteOrderSystem</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exchange</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span> <span class="o">=</span> <span class="n">exchange</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">builder</span> <span class="o">=</span> <span class="n">OrderBuilder</span><span class="p">(</span><span class="n">exchange</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">executor</span> <span class="o">=</span> <span class="n">OrderExecutor</span><span class="p">(</span><span class="n">exchange</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">manager</span> <span class="o">=</span> <span class="n">OrderManager</span><span class="p">(</span><span class="n">exchange</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">analyzer</span> <span class="o">=</span> <span class="n">ExecutionAnalyzer</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">buy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">order_type</span><span class="o">=</span><span class="s1">&#39;market&#39;</span><span class="p">,</span> <span class="n">price</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># TODO: Complete buy flow</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">sell</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">order_type</span><span class="o">=</span><span class="s1">&#39;market&#39;</span><span class="p">,</span> <span class="n">price</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># TODO: Complete sell flow</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">get_execution_report</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># TODO: Return execution analytics</span>
        <span class="k">pass</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">CompleteOrderSystem</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exchange</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span> <span class="o">=</span> <span class="n">exchange</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">builder</span> <span class="o">=</span> <span class="n">OrderBuilder</span><span class="p">(</span><span class="n">exchange</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">executor</span> <span class="o">=</span> <span class="n">OrderExecutor</span><span class="p">(</span><span class="n">exchange</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">manager</span> <span class="o">=</span> <span class="n">OrderManager</span><span class="p">(</span><span class="n">exchange</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">analyzer</span> <span class="o">=</span> <span class="n">ExecutionAnalyzer</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">buy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">order_type</span><span class="o">=</span><span class="s1">&#39;market&#39;</span><span class="p">,</span> <span class="n">price</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># Build order</span>
        <span class="k">if</span> <span class="n">order_type</span> <span class="o">==</span> <span class="s1">&#39;market&#39;</span><span class="p">:</span>
            <span class="n">order_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">market_buy</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">amount</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">order_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">limit_buy</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">price</span><span class="p">)</span>

        <span class="c1"># Validate</span>
        <span class="n">validation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">validate_order</span><span class="p">(</span><span class="n">order_params</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">validation</span><span class="p">[</span><span class="s1">&#39;valid&#39;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;issues&#39;</span><span class="p">:</span> <span class="n">validation</span><span class="p">[</span><span class="s1">&#39;issues&#39;</span><span class="p">]}</span>

        <span class="c1"># Get pre-trade price</span>
        <span class="n">pre_price</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="o">.</span><span class="n">fetch_ticker</span><span class="p">(</span><span class="n">symbol</span><span class="p">)[</span><span class="s1">&#39;ask&#39;</span><span class="p">]</span>

        <span class="c1"># Execute</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">executor</span><span class="o">.</span><span class="n">place_order</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="s1">&#39;buy&#39;</span><span class="p">,</span> <span class="n">order_type</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">price</span><span class="p">)</span>

        <span class="c1"># Record for analysis</span>
        <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;success&#39;</span><span class="p">]:</span>
            <span class="n">actual_price</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;order&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;average&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;order&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;price&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">actual_price</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">analyzer</span><span class="o">.</span><span class="n">record_execution</span><span class="p">(</span><span class="n">pre_price</span><span class="p">,</span> <span class="n">actual_price</span><span class="p">,</span> <span class="s1">&#39;buy&#39;</span><span class="p">,</span> <span class="n">amount</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">sell</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">order_type</span><span class="o">=</span><span class="s1">&#39;market&#39;</span><span class="p">,</span> <span class="n">price</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">order_type</span> <span class="o">==</span> <span class="s1">&#39;market&#39;</span><span class="p">:</span>
            <span class="n">order_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">market_sell</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">amount</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">order_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">limit_sell</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">price</span><span class="p">)</span>

        <span class="n">validation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">validate_order</span><span class="p">(</span><span class="n">order_params</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">validation</span><span class="p">[</span><span class="s1">&#39;valid&#39;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;issues&#39;</span><span class="p">:</span> <span class="n">validation</span><span class="p">[</span><span class="s1">&#39;issues&#39;</span><span class="p">]}</span>

        <span class="n">pre_price</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="o">.</span><span class="n">fetch_ticker</span><span class="p">(</span><span class="n">symbol</span><span class="p">)[</span><span class="s1">&#39;bid&#39;</span><span class="p">]</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">executor</span><span class="o">.</span><span class="n">place_order</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="s1">&#39;sell&#39;</span><span class="p">,</span> <span class="n">order_type</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">price</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;success&#39;</span><span class="p">]:</span>
            <span class="n">actual_price</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;order&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;average&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;order&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;price&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">actual_price</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">analyzer</span><span class="o">.</span><span class="n">record_execution</span><span class="p">(</span><span class="n">pre_price</span><span class="p">,</span> <span class="n">actual_price</span><span class="p">,</span> <span class="s1">&#39;sell&#39;</span><span class="p">,</span> <span class="n">amount</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">get_execution_report</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyzer</span><span class="o">.</span><span class="n">get_statistics</span><span class="p">()</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>ğŸ“ Key Takeaways</h1>
<ol>
<li><strong>Order Types</strong>: Choose based on urgency vs price sensitivity</li>
<li><strong>Pre-Trade Checks</strong>: Always validate before placing orders</li>
<li><strong>Order Management</strong>: Track all orders and handle failures gracefully</li>
<li><strong>Execution Analysis</strong>: Monitor slippage to improve strategy</li>
</ol>
<hr />
<p><em>Next: Module 11 - Live Trading</em></p></div>
        <div class="nav-buttons">
            <button class="nav-btn prev-btn disabled" type="button">
                <span class="nav-btn-label">â† Previous</span>
                <span class="nav-btn-name"></span>
            </button>
            <button class="nav-btn next-btn disabled" type="button">
                <span class="nav-btn-label">Next â†’</span>
                <span class="nav-btn-name"></span>
            </button>
        </div>
        </div>
<div class="module-section" data-idx="11"><div class="md-cell module-header"><h1>Module 11: Live Trading</h1>
<h2>Part 3: Exchange Integration</h2>
<hr />
<div class="table-wrapper"><table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>â±ï¸ <strong>Duration</strong></td>
<td>~2.5 hours</td>
</tr>
<tr>
<td>ğŸ“‹ <strong>Prerequisites</strong></td>
<td>Module 10</td>
</tr>
<tr>
<td>ğŸ’ª <strong>Exercises</strong></td>
<td>5 total</td>
</tr>
</tbody>
</table></div></div>
<div class="md-cell"><h2>ğŸ¯ Learning Objectives</h2>
<ul>
<li>Complete pre-launch validation</li>
<li>Monitor live trades in real-time</li>
<li>Handle edge cases and errors</li>
<li>Track and report performance</li>
</ul></div>
<div class="md-cell"><hr />
<h1>Section 1: Pre-Launch Checklist</h1>
<h2>1.1 System Validation</h2></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="k">class</span> <span class="nc">PreLaunchValidator</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Validate all systems before going live.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exchange</span><span class="p">,</span> <span class="n">strategy</span><span class="p">,</span> <span class="n">risk_manager</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span> <span class="o">=</span> <span class="n">exchange</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">strategy</span> <span class="o">=</span> <span class="n">strategy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">risk_manager</span> <span class="o">=</span> <span class="n">risk_manager</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checks</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">def</span> <span class="nf">check_api_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Verify API connectivity.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="o">.</span><span class="n">fetch_ticker</span><span class="p">(</span><span class="s1">&#39;BTC/USDT&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;API Connection&#39;</span><span class="p">,</span> <span class="s1">&#39;passed&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;API Connection&#39;</span><span class="p">,</span> <span class="s1">&#39;passed&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>
    
    <span class="k">def</span> <span class="nf">check_balance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">min_balance</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Verify sufficient balance.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">balance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="o">.</span><span class="n">fetch_balance</span><span class="p">()</span>
            <span class="n">usdt</span> <span class="o">=</span> <span class="n">balance</span><span class="p">[</span><span class="s1">&#39;free&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;USDT&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Balance Check&#39;</span><span class="p">,</span>
                <span class="s1">&#39;passed&#39;</span><span class="p">:</span> <span class="n">usdt</span> <span class="o">&gt;=</span> <span class="n">min_balance</span><span class="p">,</span>
                <span class="s1">&#39;balance&#39;</span><span class="p">:</span> <span class="n">usdt</span><span class="p">,</span>
                <span class="s1">&#39;required&#39;</span><span class="p">:</span> <span class="n">min_balance</span>
            <span class="p">}</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Balance Check&#39;</span><span class="p">,</span> <span class="s1">&#39;passed&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>
    
    <span class="k">def</span> <span class="nf">check_trading_permissions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Verify trading is enabled.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Most exchanges require a small test order to verify</span>
            <span class="n">has_trading</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="o">.</span><span class="n">has</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;createOrder&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Trading Permissions&#39;</span><span class="p">,</span>
                <span class="s1">&#39;passed&#39;</span><span class="p">:</span> <span class="n">has_trading</span>
            <span class="p">}</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Trading Permissions&#39;</span><span class="p">,</span> <span class="s1">&#39;passed&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>
    
    <span class="k">def</span> <span class="nf">check_risk_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Verify risk parameters are set.&quot;&quot;&quot;</span>
        <span class="n">checks</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;max_position_size&#39;</span><span class="p">:</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">risk_manager</span><span class="p">,</span> <span class="s1">&#39;max_position&#39;</span><span class="p">),</span>
            <span class="s1">&#39;stop_loss_enabled&#39;</span><span class="p">:</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">risk_manager</span><span class="p">,</span> <span class="s1">&#39;stop_loss&#39;</span><span class="p">),</span>
            <span class="s1">&#39;max_daily_loss&#39;</span><span class="p">:</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">risk_manager</span><span class="p">,</span> <span class="s1">&#39;max_daily_loss&#39;</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Risk Parameters&#39;</span><span class="p">,</span>
            <span class="s1">&#39;passed&#39;</span><span class="p">:</span> <span class="nb">all</span><span class="p">(</span><span class="n">checks</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span>
            <span class="s1">&#39;details&#39;</span><span class="p">:</span> <span class="n">checks</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">run_all_checks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Run complete pre-launch validation.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checks</span> <span class="o">=</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_api_connection</span><span class="p">(),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_balance</span><span class="p">(),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_trading_permissions</span><span class="p">(),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_risk_parameters</span><span class="p">()</span>
        <span class="p">]</span>
        
        <span class="n">all_passed</span> <span class="o">=</span> <span class="nb">all</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;passed&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">checks</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;ready_to_launch&#39;</span><span class="p">:</span> <span class="n">all_passed</span><span class="p">,</span>
            <span class="s1">&#39;checks&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">checks</span><span class="p">,</span>
            <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">print_report</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Print formatted validation report.&quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=&#39;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;       PRE-LAUNCH VALIDATION REPORT&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=&#39;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">check</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">checks</span><span class="p">:</span>
            <span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;âœ…&#39;</span> <span class="k">if</span> <span class="n">check</span><span class="p">[</span><span class="s1">&#39;passed&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;âŒ&#39;</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">status</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">check</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;error&#39;</span> <span class="ow">in</span> <span class="n">check</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Error: </span><span class="si">{</span><span class="n">check</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;details&#39;</span> <span class="ow">in</span> <span class="n">check</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">check</span><span class="p">[</span><span class="s1">&#39;details&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="s1">&#39;âœ“&#39;</span> <span class="k">if</span> <span class="n">v</span> <span class="k">else</span> <span class="s1">&#39;âœ—&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=&#39;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h3>âœï¸ Exercise 11.1: Launch Checklist</h3>
<p>Create a comprehensive launch checklist with custom checks.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="c1"># Exercise 11.1</span>
<span class="k">class</span> <span class="nc">LaunchChecklist</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checks</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="k">def</span> <span class="nf">add_check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">check_func</span><span class="p">,</span> <span class="n">critical</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="c1"># TODO: Add custom check</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">run_all</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># TODO: Run all checks and return results</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">can_launch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># TODO: Return True only if all critical checks pass</span>
        <span class="k">pass</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">LaunchChecklist</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checks</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">add_check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">check_func</span><span class="p">,</span> <span class="n">critical</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checks</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;func&#39;</span><span class="p">:</span> <span class="n">check_func</span><span class="p">,</span>
            <span class="s1">&#39;critical&#39;</span><span class="p">:</span> <span class="n">critical</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">run_all</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">check</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">checks</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">check</span><span class="p">[</span><span class="s1">&#39;func&#39;</span><span class="p">]()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;passed&#39;</span><span class="p">:</span> <span class="n">result</span><span class="p">,</span>
                    <span class="s1">&#39;critical&#39;</span><span class="p">:</span> <span class="n">check</span><span class="p">[</span><span class="s1">&#39;critical&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="kc">None</span>
                <span class="p">}</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;passed&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="s1">&#39;critical&#39;</span><span class="p">:</span> <span class="n">check</span><span class="p">[</span><span class="s1">&#39;critical&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="p">}</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span>

    <span class="k">def</span> <span class="nf">can_launch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run_all</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;critical&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;passed&#39;</span><span class="p">]:</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">get_failures</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="n">name</span><span class="p">:</span> <span class="n">result</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;passed&#39;</span><span class="p">]</span>
        <span class="p">}</span>

<span class="c1"># Usage</span>
<span class="n">checklist</span> <span class="o">=</span> <span class="n">LaunchChecklist</span><span class="p">()</span>
<span class="n">checklist</span><span class="o">.</span><span class="n">add_check</span><span class="p">(</span><span class="s1">&#39;API&#39;</span><span class="p">,</span> <span class="k">lambda</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="n">critical</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">checklist</span><span class="o">.</span><span class="n">add_check</span><span class="p">(</span><span class="s1">&#39;Balance&#39;</span><span class="p">,</span> <span class="k">lambda</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="n">critical</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">checklist</span><span class="o">.</span><span class="n">add_check</span><span class="p">(</span><span class="s1">&#39;Backup&#39;</span><span class="p">,</span> <span class="k">lambda</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="n">critical</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">checklist</span><span class="o">.</span><span class="n">run_all</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Can launch: </span><span class="si">{</span><span class="n">checklist</span><span class="o">.</span><span class="n">can_launch</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>Section 2: Monitoring Live Trades</h1></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">LiveTradeMonitor</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Monitor live trading activity.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exchange</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span> <span class="o">=</span> <span class="n">exchange</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">positions</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">daily_pnl</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trades_today</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_balance</span> <span class="o">=</span> <span class="mi">0</span>
    
    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set starting state.&quot;&quot;&quot;</span>
        <span class="n">balance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="o">.</span><span class="n">fetch_balance</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_balance</span> <span class="o">=</span> <span class="n">balance</span><span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;USDT&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">daily_pnl</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trades_today</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_balance</span>
    
    <span class="k">def</span> <span class="nf">update_position</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">side</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">price</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update position tracking.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">symbol</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;amount&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;avg_price&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;realized_pnl&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
        
        <span class="n">pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="n">side</span> <span class="o">==</span> <span class="s1">&#39;buy&#39;</span><span class="p">:</span>
            <span class="c1"># Update average price</span>
            <span class="n">total_cost</span> <span class="o">=</span> <span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="s1">&#39;amount&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">pos</span><span class="p">[</span><span class="s1">&#39;avg_price&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="p">(</span><span class="n">amount</span> <span class="o">*</span> <span class="n">price</span><span class="p">)</span>
            <span class="n">pos</span><span class="p">[</span><span class="s1">&#39;amount&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">amount</span>
            <span class="n">pos</span><span class="p">[</span><span class="s1">&#39;avg_price&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">total_cost</span> <span class="o">/</span> <span class="n">pos</span><span class="p">[</span><span class="s1">&#39;amount&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">pos</span><span class="p">[</span><span class="s1">&#39;amount&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># sell</span>
            <span class="c1"># Calculate realized PnL</span>
            <span class="n">pnl</span> <span class="o">=</span> <span class="p">(</span><span class="n">price</span> <span class="o">-</span> <span class="n">pos</span><span class="p">[</span><span class="s1">&#39;avg_price&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="n">amount</span>
            <span class="n">pos</span><span class="p">[</span><span class="s1">&#39;realized_pnl&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">pnl</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">daily_pnl</span> <span class="o">+=</span> <span class="n">pnl</span>
            <span class="n">pos</span><span class="p">[</span><span class="s1">&#39;amount&#39;</span><span class="p">]</span> <span class="o">-=</span> <span class="n">amount</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">trades_today</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">pos</span>
    
    <span class="k">def</span> <span class="nf">get_unrealized_pnl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current_prices</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculate unrealized PnL for open positions.&quot;&quot;&quot;</span>
        <span class="n">unrealized</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">pos</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">pos</span><span class="p">[</span><span class="s1">&#39;amount&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="n">current_prices</span><span class="p">:</span>
                <span class="n">unrealized</span> <span class="o">+=</span> <span class="p">(</span><span class="n">current_prices</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span> <span class="o">-</span> <span class="n">pos</span><span class="p">[</span><span class="s1">&#39;avg_price&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="n">pos</span><span class="p">[</span><span class="s1">&#39;amount&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">unrealized</span>
    
    <span class="k">def</span> <span class="nf">get_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current_prices</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get current trading status.&quot;&quot;&quot;</span>
        <span class="n">current_prices</span> <span class="o">=</span> <span class="n">current_prices</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="n">unrealized</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_unrealized_pnl</span><span class="p">(</span><span class="n">current_prices</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;positions&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">,</span>
            <span class="s1">&#39;realized_pnl&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">daily_pnl</span><span class="p">,</span>
            <span class="s1">&#39;unrealized_pnl&#39;</span><span class="p">:</span> <span class="n">unrealized</span><span class="p">,</span>
            <span class="s1">&#39;total_pnl&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">daily_pnl</span> <span class="o">+</span> <span class="n">unrealized</span><span class="p">,</span>
            <span class="s1">&#39;trades_today&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">trades_today</span><span class="p">,</span>
            <span class="s1">&#39;return_pct&#39;</span><span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">daily_pnl</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_balance</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_balance</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="p">}</span>
</code></pre></div>
<div class="md-cell"><h3>âœï¸ Exercise 11.2: Live Monitor</h3>
<p>Create a real-time monitoring system with alerts.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="c1"># Exercise 11.2</span>
<span class="k">class</span> <span class="nc">RealTimeMonitor</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exchange</span><span class="p">,</span> <span class="n">alert_callback</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span> <span class="o">=</span> <span class="n">exchange</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alert_callback</span> <span class="o">=</span> <span class="n">alert_callback</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thresholds</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="k">def</span> <span class="nf">set_alert_threshold</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="s1">&#39;above&#39;</span><span class="p">):</span>
        <span class="c1"># TODO: Set alert threshold</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">check_alerts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current_status</span><span class="p">):</span>
        <span class="c1"># TODO: Check if any thresholds breached</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">display_dashboard</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status</span><span class="p">):</span>
        <span class="c1"># TODO: Print live dashboard</span>
        <span class="k">pass</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">RealTimeMonitor</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exchange</span><span class="p">,</span> <span class="n">alert_callback</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span> <span class="o">=</span> <span class="n">exchange</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alert_callback</span> <span class="o">=</span> <span class="n">alert_callback</span> <span class="ow">or</span> <span class="nb">print</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thresholds</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alert_history</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">set_alert_threshold</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="s1">&#39;above&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thresholds</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;threshold&#39;</span><span class="p">:</span> <span class="n">threshold</span><span class="p">,</span>
            <span class="s1">&#39;direction&#39;</span><span class="p">:</span> <span class="n">direction</span><span class="p">,</span>
            <span class="s1">&#39;triggered&#39;</span><span class="p">:</span> <span class="kc">False</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">check_alerts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current_status</span><span class="p">):</span>
        <span class="n">triggered</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">metric</span><span class="p">,</span> <span class="n">config</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">thresholds</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">current_status</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">should_trigger</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;direction&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;above&#39;</span> <span class="ow">and</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;threshold&#39;</span><span class="p">]:</span>
                <span class="n">should_trigger</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">elif</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;direction&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;below&#39;</span> <span class="ow">and</span> <span class="n">value</span> <span class="o">&lt;</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;threshold&#39;</span><span class="p">]:</span>
                <span class="n">should_trigger</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">if</span> <span class="n">should_trigger</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;triggered&#39;</span><span class="p">]:</span>
                <span class="n">alert</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;metric&#39;</span><span class="p">:</span> <span class="n">metric</span><span class="p">,</span>
                    <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">value</span><span class="p">,</span>
                    <span class="s1">&#39;threshold&#39;</span><span class="p">:</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;threshold&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
                <span class="p">}</span>
                <span class="n">triggered</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">alert</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">alert_callback</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ğŸš¨ ALERT: </span><span class="si">{</span><span class="n">metric</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;direction&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;threshold&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
                <span class="n">config</span><span class="p">[</span><span class="s1">&#39;triggered&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">should_trigger</span><span class="p">:</span>
                <span class="n">config</span><span class="p">[</span><span class="s1">&#39;triggered&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">alert_history</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">triggered</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">triggered</span>

    <span class="k">def</span> <span class="nf">display_dashboard</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[2J</span><span class="se">\033</span><span class="s1">[H&#39;</span><span class="p">)</span>  <span class="c1"># Clear screen</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=&#39;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;         LIVE TRADING DASHBOARD&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;         &#39;</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=&#39;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Realized P&amp;L:   $</span><span class="si">{</span><span class="n">status</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;realized_pnl&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="si">:</span><span class="s2">&gt;10,.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unrealized P&amp;L: $</span><span class="si">{</span><span class="n">status</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;unrealized_pnl&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="si">:</span><span class="s2">&gt;10,.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total P&amp;L:      $</span><span class="si">{</span><span class="n">status</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;total_pnl&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="si">:</span><span class="s2">&gt;10,.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Return:         </span><span class="si">{</span><span class="n">status</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;return_pct&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="si">:</span><span class="s2">&gt;10.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-&#39;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Trades Today: </span><span class="si">{</span><span class="n">status</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;trades_today&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=&#39;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>Section 3: Handling Edge Cases</h1></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">EdgeCaseHandler</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Handle edge cases in live trading.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exchange</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span> <span class="o">=</span> <span class="n">exchange</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logger</span> <span class="ow">or</span> <span class="nb">print</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">error_counts</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_retries</span> <span class="o">=</span> <span class="mi">3</span>
    
    <span class="k">def</span> <span class="nf">handle_network_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Retry on network errors.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">attempt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_retries</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">error_type</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">error_counts</span><span class="p">[</span><span class="n">error_type</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_counts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">error_type</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
                
                <span class="k">if</span> <span class="s1">&#39;network&#39;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">or</span> <span class="s1">&#39;timeout&#39;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                    <span class="n">wait</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">**</span> <span class="n">attempt</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Network error, retrying in </span><span class="si">{</span><span class="n">wait</span><span class="si">}</span><span class="s1">s...&#39;</span><span class="p">)</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">wait</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span>
        
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Failed after </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">max_retries</span><span class="si">}</span><span class="s1"> retries&#39;</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">handle_exchange_downtime</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Handle exchange maintenance/downtime.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="o">.</span><span class="n">fetch_status</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">status</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;status&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;maintenance&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">(</span><span class="s1">&#39;âš ï¸ Exchange in maintenance mode&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;available&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="s1">&#39;maintenance&#39;</span><span class="p">}</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;available&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;available&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="s1">&#39;unreachable&#39;</span><span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">reconcile_positions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Reconcile local positions with exchange.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">exchange_positions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="o">.</span><span class="n">fetch_balance</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">exchange_positions</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Reconciliation failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
    
    <span class="k">def</span> <span class="nf">emergency_close_all</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Emergency close all positions.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">(</span><span class="s1">&#39;ğŸš¨ EMERGENCY: Closing all positions&#39;</span><span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Cancel all open orders first</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="o">.</span><span class="n">cancel_all_orders</span><span class="p">()</span>
            
            <span class="c1"># Get current positions</span>
            <span class="n">balance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="o">.</span><span class="n">fetch_balance</span><span class="p">()</span>
            
            <span class="k">for</span> <span class="n">currency</span><span class="p">,</span> <span class="n">amount</span> <span class="ow">in</span> <span class="n">balance</span><span class="p">[</span><span class="s1">&#39;free&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">currency</span> <span class="o">!=</span> <span class="s1">&#39;USDT&#39;</span> <span class="ow">and</span> <span class="n">amount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">symbol</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">currency</span><span class="si">}</span><span class="s1">/USDT&#39;</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="o">.</span><span class="n">create_market_order</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="s1">&#39;sell&#39;</span><span class="p">,</span> <span class="n">amount</span><span class="p">)</span>
                        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span> <span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;order&#39;</span><span class="p">:</span> <span class="n">order</span><span class="p">})</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span> <span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)})</span>
            
            <span class="k">return</span> <span class="n">results</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Emergency close failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}]</span>
</code></pre></div>
<div class="md-cell"><h3>âœï¸ Exercise 11.3: Error Handler</h3>
<p>Build a comprehensive error handling system.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="c1"># Exercise 11.3</span>
<span class="k">class</span> <span class="nc">TradingErrorHandler</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">error_log</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">recovery_actions</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="k">def</span> <span class="nf">register_recovery</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">error_type</span><span class="p">,</span> <span class="n">recovery_func</span><span class="p">):</span>
        <span class="c1"># TODO: Register recovery action for error type</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">handle_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># TODO: Log error and attempt recovery</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">should_halt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># TODO: Determine if system should halt based on errors</span>
        <span class="k">pass</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">TradingErrorHandler</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_errors_per_hour</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">error_log</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">recovery_actions</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_errors_per_hour</span> <span class="o">=</span> <span class="n">max_errors_per_hour</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">critical_errors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;InsufficientFunds&#39;</span><span class="p">,</span> <span class="s1">&#39;AuthenticationError&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">register_recovery</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">error_type</span><span class="p">,</span> <span class="n">recovery_func</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">recovery_actions</span><span class="p">[</span><span class="n">error_type</span><span class="p">]</span> <span class="o">=</span> <span class="n">recovery_func</span>

    <span class="k">def</span> <span class="nf">handle_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">error_type</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">error</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span>

        <span class="n">log_entry</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="n">error_type</span><span class="p">,</span>
            <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">error</span><span class="p">),</span>
            <span class="s1">&#39;context&#39;</span><span class="p">:</span> <span class="n">context</span><span class="p">,</span>
            <span class="s1">&#39;recovered&#39;</span><span class="p">:</span> <span class="kc">False</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">error_log</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">log_entry</span><span class="p">)</span>

        <span class="c1"># Attempt recovery</span>
        <span class="k">if</span> <span class="n">error_type</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">recovery_actions</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">recovery_actions</span><span class="p">[</span><span class="n">error_type</span><span class="p">](</span><span class="n">error</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
                <span class="n">log_entry</span><span class="p">[</span><span class="s1">&#39;recovered&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;handled&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;recovered&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;handled&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;recovered&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;critical&#39;</span><span class="p">:</span> <span class="n">error_type</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">critical_errors</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">should_halt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Check recent error count</span>
        <span class="n">hour_ago</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">timestamp</span><span class="p">()</span> <span class="o">-</span> <span class="mi">3600</span>
        <span class="n">recent_errors</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_log</span>
            <span class="k">if</span> <span class="n">e</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">timestamp</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">hour_ago</span>
        <span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">recent_errors</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_errors_per_hour</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;Too many errors in past hour&#39;</span>

        <span class="c1"># Check for critical errors</span>
        <span class="n">critical</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">recent_errors</span> <span class="k">if</span> <span class="n">e</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">critical_errors</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">e</span><span class="p">[</span><span class="s1">&#39;recovered&#39;</span><span class="p">]]</span>
        <span class="k">if</span> <span class="n">critical</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;Critical error: </span><span class="si">{</span><span class="n">critical</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;type&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span>

        <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">get_error_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">by_type</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_log</span><span class="p">:</span>
            <span class="n">by_type</span><span class="p">[</span><span class="n">e</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">by_type</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">by_type</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>Section 4: Performance Tracking</h1></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="k">class</span> <span class="nc">PerformanceTracker</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Track trading performance over time.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">initial_capital</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initial_capital</span> <span class="o">=</span> <span class="n">initial_capital</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">daily_returns</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">equity_curve</span> <span class="o">=</span> <span class="p">[</span><span class="n">initial_capital</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trades</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">def</span> <span class="nf">record_day</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ending_equity</span><span class="p">,</span> <span class="n">trades_today</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Record end of day stats.&quot;&quot;&quot;</span>
        <span class="n">daily_return</span> <span class="o">=</span> <span class="p">(</span><span class="n">ending_equity</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">equity_curve</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">equity_curve</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">daily_returns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">daily_return</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">equity_curve</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ending_equity</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">record_trade</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trade_info</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Record individual trade.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trades</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="o">**</span><span class="n">trade_info</span><span class="p">,</span>
            <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="p">})</span>
    
    <span class="k">def</span> <span class="nf">calculate_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculate performance metrics.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">daily_returns</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;No data&#39;</span><span class="p">}</span>
        
        <span class="n">returns</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">daily_returns</span><span class="p">)</span>
        
        <span class="c1"># Total return</span>
        <span class="n">total_return</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">equity_curve</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_capital</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_capital</span>
        
        <span class="c1"># Sharpe ratio (annualized)</span>
        <span class="n">sharpe</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">returns</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">returns</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">365</span><span class="p">)</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">returns</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
        
        <span class="c1"># Max drawdown</span>
        <span class="n">equity</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">equity_curve</span><span class="p">)</span>
        <span class="n">peak</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="o">.</span><span class="n">accumulate</span><span class="p">(</span><span class="n">equity</span><span class="p">)</span>
        <span class="n">drawdown</span> <span class="o">=</span> <span class="p">(</span><span class="n">equity</span> <span class="o">-</span> <span class="n">peak</span><span class="p">)</span> <span class="o">/</span> <span class="n">peak</span>
        <span class="n">max_dd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">drawdown</span><span class="p">)</span>
        
        <span class="c1"># Win rate</span>
        <span class="n">winning_trades</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trades</span> <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pnl&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">total_trades</span> <span class="o">=</span> <span class="nb">len</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trades</span> <span class="k">if</span> <span class="s1">&#39;pnl&#39;</span> <span class="ow">in</span> <span class="n">t</span><span class="p">])</span>
        <span class="n">win_rate</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">winning_trades</span><span class="p">)</span> <span class="o">/</span> <span class="n">total_trades</span> <span class="k">if</span> <span class="n">total_trades</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;total_return&#39;</span><span class="p">:</span> <span class="n">total_return</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
            <span class="s1">&#39;sharpe_ratio&#39;</span><span class="p">:</span> <span class="n">sharpe</span><span class="p">,</span>
            <span class="s1">&#39;max_drawdown&#39;</span><span class="p">:</span> <span class="n">max_dd</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
            <span class="s1">&#39;win_rate&#39;</span><span class="p">:</span> <span class="n">win_rate</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
            <span class="s1">&#39;total_trades&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trades</span><span class="p">),</span>
            <span class="s1">&#39;trading_days&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">daily_returns</span><span class="p">)</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">generate_report</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generate performance report.&quot;&quot;&quot;</span>
        <span class="n">metrics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_metrics</span><span class="p">()</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=&#39;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;         PERFORMANCE REPORT&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=&#39;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Initial Capital: $</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">initial_capital</span><span class="si">:</span><span class="s2">,.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Current Equity:  $</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">equity_curve</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">,.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-&#39;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total Return:    </span><span class="si">{</span><span class="n">metrics</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;total_return&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sharpe Ratio:    </span><span class="si">{</span><span class="n">metrics</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sharpe_ratio&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Max Drawdown:    </span><span class="si">{</span><span class="n">metrics</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;max_drawdown&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Win Rate:        </span><span class="si">{</span><span class="n">metrics</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;win_rate&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total Trades:    </span><span class="si">{</span><span class="n">metrics</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;total_trades&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=&#39;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h3>âœï¸ Exercise 11.4: Performance Tracker</h3>
<p>Build an advanced performance tracking system.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="c1"># Exercise 11.4</span>
<span class="k">class</span> <span class="nc">AdvancedPerformanceTracker</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">initial_capital</span><span class="p">,</span> <span class="n">benchmark</span><span class="o">=</span><span class="s1">&#39;BTC&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initial_capital</span> <span class="o">=</span> <span class="n">initial_capital</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">benchmark</span> <span class="o">=</span> <span class="n">benchmark</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">def</span> <span class="nf">record_snapshot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">equity</span><span class="p">,</span> <span class="n">benchmark_price</span><span class="p">):</span>
        <span class="c1"># TODO: Record portfolio and benchmark values</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">calculate_alpha_beta</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># TODO: Calculate alpha and beta vs benchmark</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">get_risk_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># TODO: VaR, Sortino, etc.</span>
        <span class="k">pass</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">AdvancedPerformanceTracker</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">initial_capital</span><span class="p">,</span> <span class="n">benchmark</span><span class="o">=</span><span class="s1">&#39;BTC&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initial_capital</span> <span class="o">=</span> <span class="n">initial_capital</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">benchmark</span> <span class="o">=</span> <span class="n">benchmark</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initial_benchmark</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">record_snapshot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">equity</span><span class="p">,</span> <span class="n">benchmark_price</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_benchmark</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">initial_benchmark</span> <span class="o">=</span> <span class="n">benchmark_price</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
            <span class="s1">&#39;equity&#39;</span><span class="p">:</span> <span class="n">equity</span><span class="p">,</span>
            <span class="s1">&#39;benchmark_price&#39;</span><span class="p">:</span> <span class="n">benchmark_price</span>
        <span class="p">})</span>

    <span class="k">def</span> <span class="nf">calculate_alpha_beta</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Insufficient data&#39;</span><span class="p">}</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;portfolio_return&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;equity&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;benchmark_return&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;benchmark_price&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Insufficient data&#39;</span><span class="p">}</span>

        <span class="c1"># Calculate beta (covariance / variance)</span>
        <span class="n">cov</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;portfolio_return&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;benchmark_return&#39;</span><span class="p">])</span>
        <span class="n">var</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;benchmark_return&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">var</span><span class="p">()</span>
        <span class="n">beta</span> <span class="o">=</span> <span class="n">cov</span> <span class="o">/</span> <span class="n">var</span> <span class="k">if</span> <span class="n">var</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>

        <span class="c1"># Calculate alpha</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;portfolio_return&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">-</span> <span class="n">beta</span> <span class="o">*</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;benchmark_return&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">alpha_annualized</span> <span class="o">=</span> <span class="n">alpha</span> <span class="o">*</span> <span class="mi">365</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;alpha&#39;</span><span class="p">:</span> <span class="n">alpha_annualized</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
            <span class="s1">&#39;beta&#39;</span><span class="p">:</span> <span class="n">beta</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">get_risk_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Insufficient data&#39;</span><span class="p">}</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="n">returns</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;equity&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

        <span class="c1"># VaR (95%)</span>
        <span class="n">var_95</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">returns</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>

        <span class="c1"># Sortino ratio</span>
        <span class="n">downside</span> <span class="o">=</span> <span class="n">returns</span><span class="p">[</span><span class="n">returns</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">sortino</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">/</span> <span class="n">downside</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">365</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">downside</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>

        <span class="c1"># Calmar ratio</span>
        <span class="n">equity</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;equity&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">peak</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="o">.</span><span class="n">accumulate</span><span class="p">(</span><span class="n">equity</span><span class="p">)</span>
        <span class="n">max_dd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">((</span><span class="n">equity</span> <span class="o">-</span> <span class="n">peak</span><span class="p">)</span> <span class="o">/</span> <span class="n">peak</span><span class="p">)</span>
        <span class="n">total_return</span> <span class="o">=</span> <span class="p">(</span><span class="n">equity</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">equity</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="n">equity</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">calmar</span> <span class="o">=</span> <span class="n">total_return</span> <span class="o">/</span> <span class="nb">abs</span><span class="p">(</span><span class="n">max_dd</span><span class="p">)</span> <span class="k">if</span> <span class="n">max_dd</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;var_95&#39;</span><span class="p">:</span> <span class="n">var_95</span><span class="p">,</span>
            <span class="s1">&#39;sortino_ratio&#39;</span><span class="p">:</span> <span class="n">sortino</span><span class="p">,</span>
            <span class="s1">&#39;calmar_ratio&#39;</span><span class="p">:</span> <span class="n">calmar</span>
        <span class="p">}</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>ğŸ—ï¸ Module Project: Production Trading Bot</h1>
<p>Build a complete production-ready trading bot.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="c1"># Module Project</span>
<span class="k">class</span> <span class="nc">ProductionTradingBot</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validator</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">monitor</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">error_handler</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">performance</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="kc">False</span>
    
    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># TODO: Set up all components</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">validate_and_launch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># TODO: Run pre-launch checks and start</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">run_cycle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># TODO: One trading cycle</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">emergency_shutdown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># TODO: Emergency stop</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">get_status</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># TODO: Return current status</span>
        <span class="k">pass</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">ProductionTradingBot</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">monitor</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">error_handler</span> <span class="o">=</span> <span class="n">TradingErrorHandler</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">performance</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_cycle</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Set up exchange connection</span>
        <span class="kn">import</span> <span class="nn">ccxt</span>
        <span class="n">exchange_class</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">ccxt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;exchange&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span> <span class="o">=</span> <span class="n">exchange_class</span><span class="p">({</span>
            <span class="s1">&#39;apiKey&#39;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;exchange&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2">_API_KEY&quot;</span><span class="p">),</span>
            <span class="s1">&#39;secret&#39;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;exchange&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2">_API_SECRET&quot;</span><span class="p">),</span>
            <span class="s1">&#39;sandbox&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sandbox&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
            <span class="s1">&#39;enableRateLimit&#39;</span><span class="p">:</span> <span class="kc">True</span>
        <span class="p">})</span>

        <span class="c1"># Initialize components</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">monitor</span> <span class="o">=</span> <span class="n">LiveTradeMonitor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">performance</span> <span class="o">=</span> <span class="n">PerformanceTracker</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;capital&#39;</span><span class="p">,</span> <span class="mi">10000</span><span class="p">))</span>

        <span class="c1"># Set up error recovery</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">error_handler</span><span class="o">.</span><span class="n">register_recovery</span><span class="p">(</span>
            <span class="s1">&#39;NetworkError&#39;</span><span class="p">,</span>
            <span class="k">lambda</span> <span class="n">e</span><span class="p">,</span> <span class="n">ctx</span><span class="p">:</span> <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">validate_and_launch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">checklist</span> <span class="o">=</span> <span class="n">LaunchChecklist</span><span class="p">()</span>

        <span class="n">checklist</span><span class="o">.</span><span class="n">add_check</span><span class="p">(</span><span class="s1">&#39;exchange&#39;</span><span class="p">,</span> <span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">checklist</span><span class="o">.</span><span class="n">add_check</span><span class="p">(</span><span class="s1">&#39;balance&#39;</span><span class="p">,</span> <span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">monitor</span><span class="o">.</span><span class="n">initialize</span><span class="p">()</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;min_balance&#39;</span><span class="p">,</span> <span class="mi">100</span><span class="p">))</span>

        <span class="n">checklist</span><span class="o">.</span><span class="n">run_all</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">checklist</span><span class="o">.</span><span class="n">can_launch</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;Bot launched&#39;</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;failures&#39;</span><span class="p">:</span> <span class="n">checklist</span><span class="o">.</span><span class="n">get_failures</span><span class="p">()}</span>

    <span class="k">def</span> <span class="nf">run_cycle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">running</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Bot not running&#39;</span><span class="p">}</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Get current prices</span>
            <span class="n">ticker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="o">.</span><span class="n">fetch_ticker</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;symbol&#39;</span><span class="p">,</span> <span class="s1">&#39;BTC/USDT&#39;</span><span class="p">))</span>

            <span class="c1"># Get status</span>
            <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">monitor</span><span class="o">.</span><span class="n">get_status</span><span class="p">({</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;symbol&#39;</span><span class="p">):</span> <span class="n">ticker</span><span class="p">[</span><span class="s1">&#39;last&#39;</span><span class="p">]})</span>

            <span class="c1"># Check for halt conditions</span>
            <span class="n">should_halt</span><span class="p">,</span> <span class="n">reason</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_handler</span><span class="o">.</span><span class="n">should_halt</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">should_halt</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">emergency_shutdown</span><span class="p">()</span>
                <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;halted&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="n">reason</span><span class="p">}</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">last_cycle</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="n">status</span><span class="p">}</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">error_handler</span><span class="o">.</span><span class="n">handle_error</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;cycle&#39;</span><span class="p">:</span> <span class="s1">&#39;run&#39;</span><span class="p">})</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>

    <span class="k">def</span> <span class="nf">emergency_shutdown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ğŸš¨ EMERGENCY SHUTDOWN&#39;</span><span class="p">)</span>
        <span class="c1"># Cancel all orders, close positions if configured</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="o">.</span><span class="n">cancel_all_orders</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">get_status</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;running&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">running</span><span class="p">,</span>
            <span class="s1">&#39;last_cycle&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_cycle</span><span class="p">,</span>
            <span class="s1">&#39;errors&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_handler</span><span class="o">.</span><span class="n">get_error_summary</span><span class="p">(),</span>
            <span class="s1">&#39;performance&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">performance</span><span class="o">.</span><span class="n">calculate_metrics</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">performance</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="p">}</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>ğŸ“ Key Takeaways</h1>
<ol>
<li><strong>Pre-Launch Validation</strong>: Always validate before going live</li>
<li><strong>Real-Time Monitoring</strong>: Track positions, P&amp;L, and alerts continuously</li>
<li><strong>Error Handling</strong>: Prepare for network issues, exchange downtime, and edge cases</li>
<li><strong>Performance Tracking</strong>: Measure and analyze results continuously</li>
</ol>
<hr />
<p><em>Part 3 Complete! Next: Part 4 - DeFi &amp; Advanced Topics</em></p></div>
        <div class="nav-buttons">
            <button class="nav-btn prev-btn disabled" type="button">
                <span class="nav-btn-label">â† Previous</span>
                <span class="nav-btn-name"></span>
            </button>
            <button class="nav-btn next-btn disabled" type="button">
                <span class="nav-btn-label">Next â†’</span>
                <span class="nav-btn-name"></span>
            </button>
        </div>
        </div>
<div class="module-section" data-idx="12"><div class="md-cell module-header"><h1>Module 12: DeFi Fundamentals</h1>
<h2>Part 4: DeFi &amp; Advanced Topics</h2>
<hr />
<div class="table-wrapper"><table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>â±ï¸ <strong>Duration</strong></td>
<td>~2.5 hours</td>
</tr>
<tr>
<td>ğŸ“‹ <strong>Prerequisites</strong></td>
<td>Part 3 (Modules 9-11)</td>
</tr>
<tr>
<td>ğŸ’ª <strong>Exercises</strong></td>
<td>5 total</td>
</tr>
</tbody>
</table></div></div>
<div class="md-cell"><h2>ğŸ¯ Learning Objectives</h2>
<ul>
<li>Understand DeFi ecosystem and protocols</li>
<li>Connect to Ethereum with Web3.py</li>
<li>Learn AMM and DEX mechanics</li>
<li>Access DeFi data sources</li>
</ul></div>
<div class="md-cell"><hr />
<h1>Section 1: Introduction to DeFi</h1>
<h2>1.1 What is DeFi?</h2>
<p><strong>Decentralized Finance (DeFi)</strong> = Financial services built on blockchain without intermediaries.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="c1"># Key DeFi concepts</span>
<span class="n">defi_ecosystem</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;DEXs&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">&#39;Decentralized exchanges for token swaps&#39;</span><span class="p">,</span>
        <span class="s1">&#39;examples&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Uniswap&#39;</span><span class="p">,</span> <span class="s1">&#39;SushiSwap&#39;</span><span class="p">,</span> <span class="s1">&#39;Curve&#39;</span><span class="p">],</span>
        <span class="s1">&#39;tvl_billions&#39;</span><span class="p">:</span> <span class="mi">15</span>
    <span class="p">},</span>
    <span class="s1">&#39;Lending&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">&#39;Borrow/lend crypto without intermediaries&#39;</span><span class="p">,</span>
        <span class="s1">&#39;examples&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Aave&#39;</span><span class="p">,</span> <span class="s1">&#39;Compound&#39;</span><span class="p">,</span> <span class="s1">&#39;MakerDAO&#39;</span><span class="p">],</span>
        <span class="s1">&#39;tvl_billions&#39;</span><span class="p">:</span> <span class="mi">20</span>
    <span class="p">},</span>
    <span class="s1">&#39;Derivatives&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">&#39;On-chain futures, options, perpetuals&#39;</span><span class="p">,</span>
        <span class="s1">&#39;examples&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;dYdX&#39;</span><span class="p">,</span> <span class="s1">&#39;GMX&#39;</span><span class="p">,</span> <span class="s1">&#39;Synthetix&#39;</span><span class="p">],</span>
        <span class="s1">&#39;tvl_billions&#39;</span><span class="p">:</span> <span class="mi">5</span>
    <span class="p">},</span>
    <span class="s1">&#39;Yield&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">&#39;Yield optimization and aggregation&#39;</span><span class="p">,</span>
        <span class="s1">&#39;examples&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Yearn&#39;</span><span class="p">,</span> <span class="s1">&#39;Convex&#39;</span><span class="p">,</span> <span class="s1">&#39;Beefy&#39;</span><span class="p">],</span>
        <span class="s1">&#39;tvl_billions&#39;</span><span class="p">:</span> <span class="mi">8</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">for</span> <span class="n">category</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">defi_ecosystem</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">category</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Examples: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;examples&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  TVL: ~$</span><span class="si">{</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;tvl_billions&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">B&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h2>1.2 Smart Contracts Basics</h2>
<p>Smart contracts are self-executing code on blockchain.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="c1"># Key smart contract concepts for traders</span>
<span class="n">smart_contract_basics</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;address&#39;</span><span class="p">:</span> <span class="s1">&#39;Unique identifier (0x...) for the contract&#39;</span><span class="p">,</span>
    <span class="s1">&#39;abi&#39;</span><span class="p">:</span> <span class="s1">&#39;Application Binary Interface - defines how to interact&#39;</span><span class="p">,</span>
    <span class="s1">&#39;functions&#39;</span><span class="p">:</span> <span class="s1">&#39;Methods you can call (swap, deposit, etc.)&#39;</span><span class="p">,</span>
    <span class="s1">&#39;events&#39;</span><span class="p">:</span> <span class="s1">&#39;Logs emitted by contract (Transfer, Swap, etc.)&#39;</span><span class="p">,</span>
    <span class="s1">&#39;gas&#39;</span><span class="p">:</span> <span class="s1">&#39;Fee paid for computation&#39;</span>
<span class="p">}</span>

<span class="c1"># Example: Uniswap V2 Router address</span>
<span class="n">UNISWAP_V2_ROUTER</span> <span class="o">=</span> <span class="s1">&#39;0x7a250d5630B4cF539739dF2C5dAcb4c659F2488D&#39;</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Smart Contract Key Concepts:&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">concept</span><span class="p">,</span> <span class="n">desc</span> <span class="ow">in</span> <span class="n">smart_contract_basics</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;  </span><span class="si">{</span><span class="n">concept</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">desc</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h3>âœï¸ Exercise 12.1: DeFi Protocol Research</h3>
<p>Create a class to store and compare DeFi protocols.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="c1"># Exercise 12.1</span>
<span class="k">class</span> <span class="nc">DeFiProtocol</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">category</span><span class="p">,</span> <span class="n">chain</span><span class="p">,</span> <span class="n">tvl</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">category</span> <span class="o">=</span> <span class="n">category</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chain</span> <span class="o">=</span> <span class="n">chain</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tvl</span> <span class="o">=</span> <span class="n">tvl</span>
    
    <span class="k">def</span> <span class="nf">risk_score</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># TODO: Calculate risk score based on TVL, age, audits</span>
        <span class="k">pass</span>

<span class="k">class</span> <span class="nc">DeFiTracker</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">protocols</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">def</span> <span class="nf">add_protocol</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">protocol</span><span class="p">):</span>
        <span class="c1"># TODO</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">get_by_category</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">category</span><span class="p">):</span>
        <span class="c1"># TODO</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">top_by_tvl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
        <span class="c1"># TODO</span>
        <span class="k">pass</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">DeFiProtocol</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">category</span><span class="p">,</span> <span class="n">chain</span><span class="p">,</span> <span class="n">tvl</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">audited</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">age_months</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">category</span> <span class="o">=</span> <span class="n">category</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chain</span> <span class="o">=</span> <span class="n">chain</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tvl</span> <span class="o">=</span> <span class="n">tvl</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">audited</span> <span class="o">=</span> <span class="n">audited</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">age_months</span> <span class="o">=</span> <span class="n">age_months</span>

    <span class="k">def</span> <span class="nf">risk_score</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Lower is better. Scale 1-10.&quot;&quot;&quot;</span>
        <span class="n">score</span> <span class="o">=</span> <span class="mi">5</span>  <span class="c1"># Base score</span>

        <span class="c1"># TVL factor (higher TVL = lower risk)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tvl</span> <span class="o">&gt;</span> <span class="mi">1_000_000_000</span><span class="p">:</span>
            <span class="n">score</span> <span class="o">-=</span> <span class="mi">2</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">tvl</span> <span class="o">&gt;</span> <span class="mi">100_000_000</span><span class="p">:</span>
            <span class="n">score</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">tvl</span> <span class="o">&lt;</span> <span class="mi">10_000_000</span><span class="p">:</span>
            <span class="n">score</span> <span class="o">+=</span> <span class="mi">2</span>

        <span class="c1"># Audit factor</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">audited</span><span class="p">:</span>
            <span class="n">score</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">score</span> <span class="o">+=</span> <span class="mi">2</span>

        <span class="c1"># Age factor</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">age_months</span> <span class="o">&gt;</span> <span class="mi">24</span><span class="p">:</span>
            <span class="n">score</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">age_months</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">:</span>
            <span class="n">score</span> <span class="o">+=</span> <span class="mi">2</span>

        <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">score</span><span class="p">))</span>

<span class="k">class</span> <span class="nc">DeFiTracker</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">protocols</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">add_protocol</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">protocol</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">protocols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">protocol</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_by_category</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">category</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">protocols</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">category</span> <span class="o">==</span> <span class="n">category</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">top_by_tvl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">protocols</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">tvl</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)[:</span><span class="n">n</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">get_by_chain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chain</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">protocols</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">chain</span> <span class="o">==</span> <span class="n">chain</span><span class="p">]</span>

<span class="c1"># Usage</span>
<span class="n">tracker</span> <span class="o">=</span> <span class="n">DeFiTracker</span><span class="p">()</span>
<span class="n">tracker</span><span class="o">.</span><span class="n">add_protocol</span><span class="p">(</span><span class="n">DeFiProtocol</span><span class="p">(</span><span class="s1">&#39;Uniswap&#39;</span><span class="p">,</span> <span class="s1">&#39;DEX&#39;</span><span class="p">,</span> <span class="s1">&#39;Ethereum&#39;</span><span class="p">,</span> <span class="mi">5_000_000_000</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="mi">48</span><span class="p">))</span>
<span class="n">tracker</span><span class="o">.</span><span class="n">add_protocol</span><span class="p">(</span><span class="n">DeFiProtocol</span><span class="p">(</span><span class="s1">&#39;Aave&#39;</span><span class="p">,</span> <span class="s1">&#39;Lending&#39;</span><span class="p">,</span> <span class="s1">&#39;Ethereum&#39;</span><span class="p">,</span> <span class="mi">10_000_000_000</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="mi">36</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Top by TVL: </span><span class="si">{</span><span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">tracker</span><span class="o">.</span><span class="n">top_by_tvl</span><span class="p">(</span><span class="mi">2</span><span class="p">)]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>Section 2: Web3.py Basics</h1>
<h2>2.1 Connecting to Ethereum</h2></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="c1"># pip install web3</span>
<span class="kn">from</span> <span class="nn">web3</span> <span class="kn">import</span> <span class="n">Web3</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="k">class</span> <span class="nc">EthereumConnection</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Connect to Ethereum network.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rpc_url</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># Use provided URL or environment variable</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rpc_url</span> <span class="o">=</span> <span class="n">rpc_url</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;ETH_RPC_URL&#39;</span><span class="p">,</span> <span class="s1">&#39;https://eth.llamarpc.com&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w3</span> <span class="o">=</span> <span class="kc">None</span>
    
    <span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Establish connection.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w3</span> <span class="o">=</span> <span class="n">Web3</span><span class="p">(</span><span class="n">Web3</span><span class="o">.</span><span class="n">HTTPProvider</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rpc_url</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">w3</span><span class="o">.</span><span class="n">is_connected</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">get_block_number</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get latest block number.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">block_number</span>
    
    <span class="k">def</span> <span class="nf">get_gas_price</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get current gas price in Gwei.&quot;&quot;&quot;</span>
        <span class="n">gas_wei</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">gas_price</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">w3</span><span class="o">.</span><span class="n">from_wei</span><span class="p">(</span><span class="n">gas_wei</span><span class="p">,</span> <span class="s1">&#39;gwei&#39;</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">get_eth_balance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">address</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get ETH balance for address.&quot;&quot;&quot;</span>
        <span class="n">balance_wei</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">get_balance</span><span class="p">(</span><span class="n">address</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">w3</span><span class="o">.</span><span class="n">from_wei</span><span class="p">(</span><span class="n">balance_wei</span><span class="p">,</span> <span class="s1">&#39;ether&#39;</span><span class="p">)</span>

<span class="c1"># Example (will work with public RPC)</span>
<span class="n">eth</span> <span class="o">=</span> <span class="n">EthereumConnection</span><span class="p">()</span>
<span class="k">if</span> <span class="n">eth</span><span class="o">.</span><span class="n">connect</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Connected! Block: </span><span class="si">{</span><span class="n">eth</span><span class="o">.</span><span class="n">get_block_number</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Gas Price: </span><span class="si">{</span><span class="n">eth</span><span class="o">.</span><span class="n">get_gas_price</span><span class="p">()</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1"> Gwei&#39;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Connection failed&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h2>2.2 Reading Contract Data</h2></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="c1"># ERC20 ABI (minimal for reading)</span>
<span class="n">ERC20_ABI</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="s2">&quot;constant&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="s2">&quot;inputs&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span>
        <span class="s2">&quot;outputs&quot;</span><span class="p">:</span> <span class="p">[{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">}],</span>
        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;function&quot;</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="s2">&quot;constant&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="s2">&quot;inputs&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;symbol&quot;</span><span class="p">,</span>
        <span class="s2">&quot;outputs&quot;</span><span class="p">:</span> <span class="p">[{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">}],</span>
        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;function&quot;</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="s2">&quot;constant&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="s2">&quot;inputs&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;decimals&quot;</span><span class="p">,</span>
        <span class="s2">&quot;outputs&quot;</span><span class="p">:</span> <span class="p">[{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;uint8&quot;</span><span class="p">}],</span>
        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;function&quot;</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="s2">&quot;constant&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="s2">&quot;inputs&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;totalSupply&quot;</span><span class="p">,</span>
        <span class="s2">&quot;outputs&quot;</span><span class="p">:</span> <span class="p">[{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;uint256&quot;</span><span class="p">}],</span>
        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;function&quot;</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="s2">&quot;constant&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="s2">&quot;inputs&quot;</span><span class="p">:</span> <span class="p">[{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;_owner&quot;</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;address&quot;</span><span class="p">}],</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;balanceOf&quot;</span><span class="p">,</span>
        <span class="s2">&quot;outputs&quot;</span><span class="p">:</span> <span class="p">[{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;balance&quot;</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;uint256&quot;</span><span class="p">}],</span>
        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;function&quot;</span>
    <span class="p">}</span>
<span class="p">]</span>

<span class="k">class</span> <span class="nc">TokenReader</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Read ERC20 token data.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">w3</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w3</span> <span class="o">=</span> <span class="n">w3</span>
    
    <span class="k">def</span> <span class="nf">get_token_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token_address</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get basic token information.&quot;&quot;&quot;</span>
        <span class="n">contract</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">contract</span><span class="p">(</span>
            <span class="n">address</span><span class="o">=</span><span class="n">Web3</span><span class="o">.</span><span class="n">to_checksum_address</span><span class="p">(</span><span class="n">token_address</span><span class="p">),</span>
            <span class="n">abi</span><span class="o">=</span><span class="n">ERC20_ABI</span>
        <span class="p">)</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s1">&#39;address&#39;</span><span class="p">:</span> <span class="n">token_address</span><span class="p">,</span>
                <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">contract</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">name</span><span class="p">()</span><span class="o">.</span><span class="n">call</span><span class="p">(),</span>
                <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">contract</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">symbol</span><span class="p">()</span><span class="o">.</span><span class="n">call</span><span class="p">(),</span>
                <span class="s1">&#39;decimals&#39;</span><span class="p">:</span> <span class="n">contract</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">decimals</span><span class="p">()</span><span class="o">.</span><span class="n">call</span><span class="p">(),</span>
                <span class="s1">&#39;total_supply&#39;</span><span class="p">:</span> <span class="n">contract</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">totalSupply</span><span class="p">()</span><span class="o">.</span><span class="n">call</span><span class="p">()</span>
            <span class="p">}</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>
    
    <span class="k">def</span> <span class="nf">get_balance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token_address</span><span class="p">,</span> <span class="n">wallet_address</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get token balance for wallet.&quot;&quot;&quot;</span>
        <span class="n">contract</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">contract</span><span class="p">(</span>
            <span class="n">address</span><span class="o">=</span><span class="n">Web3</span><span class="o">.</span><span class="n">to_checksum_address</span><span class="p">(</span><span class="n">token_address</span><span class="p">),</span>
            <span class="n">abi</span><span class="o">=</span><span class="n">ERC20_ABI</span>
        <span class="p">)</span>
        
        <span class="n">balance</span> <span class="o">=</span> <span class="n">contract</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">balanceOf</span><span class="p">(</span>
            <span class="n">Web3</span><span class="o">.</span><span class="n">to_checksum_address</span><span class="p">(</span><span class="n">wallet_address</span><span class="p">)</span>
        <span class="p">)</span><span class="o">.</span><span class="n">call</span><span class="p">()</span>
        
        <span class="n">decimals</span> <span class="o">=</span> <span class="n">contract</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">decimals</span><span class="p">()</span><span class="o">.</span><span class="n">call</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">balance</span> <span class="o">/</span> <span class="p">(</span><span class="mi">10</span> <span class="o">**</span> <span class="n">decimals</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h3>âœï¸ Exercise 12.2: Web3 Connection Manager</h3>
<p>Create a multi-chain Web3 connection manager.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="c1"># Exercise 12.2</span>
<span class="k">class</span> <span class="nc">MultiChainWeb3</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connections</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rpcs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;ethereum&#39;</span><span class="p">:</span> <span class="s1">&#39;https://eth.llamarpc.com&#39;</span><span class="p">,</span>
            <span class="s1">&#39;polygon&#39;</span><span class="p">:</span> <span class="s1">&#39;https://polygon-rpc.com&#39;</span><span class="p">,</span>
            <span class="s1">&#39;arbitrum&#39;</span><span class="p">:</span> <span class="s1">&#39;https://arb1.arbitrum.io/rpc&#39;</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">connect_chain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chain</span><span class="p">):</span>
        <span class="c1"># TODO: Connect to specified chain</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">get_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chain</span><span class="p">):</span>
        <span class="c1"># TODO: Return Web3 instance for chain</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">check_all_connections</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># TODO: Return status of all connections</span>
        <span class="k">pass</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">MultiChainWeb3</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connections</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rpcs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;ethereum&#39;</span><span class="p">:</span> <span class="s1">&#39;https://eth.llamarpc.com&#39;</span><span class="p">,</span>
            <span class="s1">&#39;polygon&#39;</span><span class="p">:</span> <span class="s1">&#39;https://polygon-rpc.com&#39;</span><span class="p">,</span>
            <span class="s1">&#39;arbitrum&#39;</span><span class="p">:</span> <span class="s1">&#39;https://arb1.arbitrum.io/rpc&#39;</span><span class="p">,</span>
            <span class="s1">&#39;optimism&#39;</span><span class="p">:</span> <span class="s1">&#39;https://mainnet.optimism.io&#39;</span><span class="p">,</span>
            <span class="s1">&#39;base&#39;</span><span class="p">:</span> <span class="s1">&#39;https://mainnet.base.org&#39;</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">connect_chain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chain</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">chain</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rpcs</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Unknown chain: </span><span class="si">{</span><span class="n">chain</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">}</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">w3</span> <span class="o">=</span> <span class="n">Web3</span><span class="p">(</span><span class="n">Web3</span><span class="o">.</span><span class="n">HTTPProvider</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rpcs</span><span class="p">[</span><span class="n">chain</span><span class="p">]))</span>
            <span class="k">if</span> <span class="n">w3</span><span class="o">.</span><span class="n">is_connected</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">connections</span><span class="p">[</span><span class="n">chain</span><span class="p">]</span> <span class="o">=</span> <span class="n">w3</span>
                <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;block&#39;</span><span class="p">:</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">block_number</span><span class="p">}</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Connection failed&#39;</span><span class="p">}</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>

    <span class="k">def</span> <span class="nf">get_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chain</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">chain</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">connections</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">connect_chain</span><span class="p">(</span><span class="n">chain</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">connections</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">chain</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">connect_all</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">chain</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rpcs</span><span class="p">:</span>
            <span class="n">results</span><span class="p">[</span><span class="n">chain</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connect_chain</span><span class="p">(</span><span class="n">chain</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">results</span>

    <span class="k">def</span> <span class="nf">check_all_connections</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">status</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">chain</span><span class="p">,</span> <span class="n">w3</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">connections</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">status</span><span class="p">[</span><span class="n">chain</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;connected&#39;</span><span class="p">:</span> <span class="n">w3</span><span class="o">.</span><span class="n">is_connected</span><span class="p">(),</span>
                    <span class="s1">&#39;block&#39;</span><span class="p">:</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">block_number</span><span class="p">,</span>
                    <span class="s1">&#39;gas_gwei&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">w3</span><span class="o">.</span><span class="n">from_wei</span><span class="p">(</span><span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">gas_price</span><span class="p">,</span> <span class="s1">&#39;gwei&#39;</span><span class="p">))</span>
                <span class="p">}</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">status</span><span class="p">[</span><span class="n">chain</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;connected&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">status</span>

<span class="n">multi</span> <span class="o">=</span> <span class="n">MultiChainWeb3</span><span class="p">()</span>
<span class="n">multi</span><span class="o">.</span><span class="n">connect_chain</span><span class="p">(</span><span class="s1">&#39;ethereum&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">multi</span><span class="o">.</span><span class="n">check_all_connections</span><span class="p">())</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>Section 3: DEX Overview</h1>
<h2>3.1 Automated Market Makers (AMMs)</h2></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">AMMSimulator</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Simulate constant product AMM (x * y = k).</span>
<span class="sd">    Used by Uniswap V2, SushiSwap, etc.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reserve_a</span><span class="p">,</span> <span class="n">reserve_b</span><span class="p">,</span> <span class="n">fee</span><span class="o">=</span><span class="mf">0.003</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reserve_a</span> <span class="o">=</span> <span class="n">reserve_a</span>  <span class="c1"># e.g., ETH</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reserve_b</span> <span class="o">=</span> <span class="n">reserve_b</span>  <span class="c1"># e.g., USDC</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fee</span> <span class="o">=</span> <span class="n">fee</span>  <span class="c1"># 0.3% typical</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k</span> <span class="o">=</span> <span class="n">reserve_a</span> <span class="o">*</span> <span class="n">reserve_b</span>  <span class="c1"># Constant product</span>
    
    <span class="k">def</span> <span class="nf">get_price</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get current price of A in terms of B.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">reserve_b</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">reserve_a</span>
    
    <span class="k">def</span> <span class="nf">get_amount_out</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amount_in</span><span class="p">,</span> <span class="n">token_in</span><span class="o">=</span><span class="s1">&#39;A&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate output amount for a swap.</span>
<span class="sd">        </span>
<span class="sd">        Formula: amount_out = (reserve_out * amount_in * (1 - fee)) / (reserve_in + amount_in * (1 - fee))</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">amount_in_with_fee</span> <span class="o">=</span> <span class="n">amount_in</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">fee</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">token_in</span> <span class="o">==</span> <span class="s1">&#39;A&#39;</span><span class="p">:</span>
            <span class="n">amount_out</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reserve_b</span> <span class="o">*</span> <span class="n">amount_in_with_fee</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reserve_a</span> <span class="o">+</span> <span class="n">amount_in_with_fee</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">amount_out</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reserve_a</span> <span class="o">*</span> <span class="n">amount_in_with_fee</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reserve_b</span> <span class="o">+</span> <span class="n">amount_in_with_fee</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">amount_out</span>
    
    <span class="k">def</span> <span class="nf">get_price_impact</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amount_in</span><span class="p">,</span> <span class="n">token_in</span><span class="o">=</span><span class="s1">&#39;A&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculate price impact of a trade.&quot;&quot;&quot;</span>
        <span class="n">initial_price</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_price</span><span class="p">()</span>
        <span class="n">amount_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_amount_out</span><span class="p">(</span><span class="n">amount_in</span><span class="p">,</span> <span class="n">token_in</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">token_in</span> <span class="o">==</span> <span class="s1">&#39;A&#39;</span><span class="p">:</span>
            <span class="n">effective_price</span> <span class="o">=</span> <span class="n">amount_out</span> <span class="o">/</span> <span class="n">amount_in</span>
            <span class="n">impact</span> <span class="o">=</span> <span class="p">(</span><span class="n">initial_price</span> <span class="o">-</span> <span class="n">effective_price</span><span class="p">)</span> <span class="o">/</span> <span class="n">initial_price</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">effective_price</span> <span class="o">=</span> <span class="n">amount_in</span> <span class="o">/</span> <span class="n">amount_out</span>
            <span class="n">impact</span> <span class="o">=</span> <span class="p">(</span><span class="n">effective_price</span> <span class="o">-</span> <span class="n">initial_price</span><span class="p">)</span> <span class="o">/</span> <span class="n">initial_price</span>
        
        <span class="k">return</span> <span class="n">impact</span> <span class="o">*</span> <span class="mi">100</span>  <span class="c1"># Return as percentage</span>
    
    <span class="k">def</span> <span class="nf">simulate_swap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amount_in</span><span class="p">,</span> <span class="n">token_in</span><span class="o">=</span><span class="s1">&#39;A&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Simulate a swap and update reserves.&quot;&quot;&quot;</span>
        <span class="n">amount_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_amount_out</span><span class="p">(</span><span class="n">amount_in</span><span class="p">,</span> <span class="n">token_in</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">token_in</span> <span class="o">==</span> <span class="s1">&#39;A&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reserve_a</span> <span class="o">+=</span> <span class="n">amount_in</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reserve_b</span> <span class="o">-=</span> <span class="n">amount_out</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reserve_b</span> <span class="o">+=</span> <span class="n">amount_in</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reserve_a</span> <span class="o">-=</span> <span class="n">amount_out</span>
        
        <span class="k">return</span> <span class="n">amount_out</span>

<span class="c1"># Example: ETH/USDC pool</span>
<span class="n">pool</span> <span class="o">=</span> <span class="n">AMMSimulator</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">2_000_000</span><span class="p">)</span>  <span class="c1"># 1000 ETH, 2M USDC</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;ETH Price: $</span><span class="si">{</span><span class="n">pool</span><span class="o">.</span><span class="n">get_price</span><span class="p">()</span><span class="si">:</span><span class="s1">,.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Swap 10 ETH -&gt; </span><span class="si">{</span><span class="n">pool</span><span class="o">.</span><span class="n">get_amount_out</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="s2">&quot;A&quot;</span><span class="p">)</span><span class="si">:</span><span class="s1">,.2f</span><span class="si">}</span><span class="s1"> USDC&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Price Impact: </span><span class="si">{</span><span class="n">pool</span><span class="o">.</span><span class="n">get_price_impact</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="s2">&quot;A&quot;</span><span class="p">)</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">%&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h2>3.2 Liquidity Pools</h2></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">LiquidityPool</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Represent a liquidity pool with LP tokens.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token_a</span><span class="p">,</span> <span class="n">token_b</span><span class="p">,</span> <span class="n">reserve_a</span><span class="p">,</span> <span class="n">reserve_b</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">token_a</span> <span class="o">=</span> <span class="n">token_a</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">token_b</span> <span class="o">=</span> <span class="n">token_b</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reserve_a</span> <span class="o">=</span> <span class="n">reserve_a</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reserve_b</span> <span class="o">=</span> <span class="n">reserve_b</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">total_lp_tokens</span> <span class="o">=</span> <span class="p">(</span><span class="n">reserve_a</span> <span class="o">*</span> <span class="n">reserve_b</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lp_holders</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="k">def</span> <span class="nf">add_liquidity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">provider</span><span class="p">,</span> <span class="n">amount_a</span><span class="p">,</span> <span class="n">amount_b</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add liquidity and receive LP tokens.&quot;&quot;&quot;</span>
        <span class="c1"># Calculate LP tokens to mint</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_lp_tokens</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">lp_tokens</span> <span class="o">=</span> <span class="p">(</span><span class="n">amount_a</span> <span class="o">*</span> <span class="n">amount_b</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lp_tokens</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span>
                <span class="n">amount_a</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_lp_tokens</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">reserve_a</span><span class="p">,</span>
                <span class="n">amount_b</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_lp_tokens</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">reserve_b</span>
            <span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">reserve_a</span> <span class="o">+=</span> <span class="n">amount_a</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reserve_b</span> <span class="o">+=</span> <span class="n">amount_b</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">total_lp_tokens</span> <span class="o">+=</span> <span class="n">lp_tokens</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lp_holders</span><span class="p">[</span><span class="n">provider</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lp_holders</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">provider</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">lp_tokens</span>
        
        <span class="k">return</span> <span class="n">lp_tokens</span>
    
    <span class="k">def</span> <span class="nf">remove_liquidity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">provider</span><span class="p">,</span> <span class="n">lp_tokens</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove liquidity by burning LP tokens.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lp_holders</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">provider</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">lp_tokens</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Insufficient LP tokens&#39;</span><span class="p">}</span>
        
        <span class="n">share</span> <span class="o">=</span> <span class="n">lp_tokens</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_lp_tokens</span>
        <span class="n">amount_a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reserve_a</span> <span class="o">*</span> <span class="n">share</span>
        <span class="n">amount_b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reserve_b</span> <span class="o">*</span> <span class="n">share</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">reserve_a</span> <span class="o">-=</span> <span class="n">amount_a</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reserve_b</span> <span class="o">-=</span> <span class="n">amount_b</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">total_lp_tokens</span> <span class="o">-=</span> <span class="n">lp_tokens</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lp_holders</span><span class="p">[</span><span class="n">provider</span><span class="p">]</span> <span class="o">-=</span> <span class="n">lp_tokens</span>
        
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;amount_a&#39;</span><span class="p">:</span> <span class="n">amount_a</span><span class="p">,</span> <span class="s1">&#39;amount_b&#39;</span><span class="p">:</span> <span class="n">amount_b</span><span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">get_pool_share</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">provider</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get provider&#39;s share of the pool.&quot;&quot;&quot;</span>
        <span class="n">lp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lp_holders</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">provider</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_lp_tokens</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="n">lp</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_lp_tokens</span> <span class="o">*</span> <span class="mi">100</span>
</code></pre></div>
<div class="md-cell"><h3>âœï¸ Exercise 12.3: Impermanent Loss Calculator</h3>
<p>Build a calculator for impermanent loss.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="c1"># Exercise 12.3</span>
<span class="k">def</span> <span class="nf">calculate_impermanent_loss</span><span class="p">(</span><span class="n">price_ratio_change</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate impermanent loss based on price change.</span>
<span class="sd">    </span>
<span class="sd">    price_ratio_change: e.g., 2.0 means price doubled</span>
<span class="sd">    Returns: IL as percentage (negative = loss)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO: Implement IL formula</span>
    <span class="c1"># IL = 2 * sqrt(price_ratio) / (1 + price_ratio) - 1</span>
    <span class="k">pass</span>

<span class="k">class</span> <span class="nc">ImpermanentLossTracker</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">initial_price_a</span><span class="p">,</span> <span class="n">initial_price_b</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initial_price_a</span> <span class="o">=</span> <span class="n">initial_price_a</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initial_price_b</span> <span class="o">=</span> <span class="n">initial_price_b</span>
    
    <span class="k">def</span> <span class="nf">calculate_il</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current_price_a</span><span class="p">,</span> <span class="n">current_price_b</span><span class="p">):</span>
        <span class="c1"># TODO</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">breakeven_fees</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">il_percent</span><span class="p">):</span>
        <span class="c1"># TODO: Calculate fees needed to offset IL</span>
        <span class="k">pass</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">math</span>

<span class="k">def</span> <span class="nf">calculate_impermanent_loss</span><span class="p">(</span><span class="n">price_ratio_change</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate impermanent loss based on price change.</span>

<span class="sd">    IL = 2 * sqrt(price_ratio) / (1 + price_ratio) - 1</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sqrt_ratio</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">price_ratio_change</span><span class="p">)</span>
    <span class="n">il</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">sqrt_ratio</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">price_ratio_change</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">il</span> <span class="o">*</span> <span class="mi">100</span>  <span class="c1"># Return as percentage</span>

<span class="k">class</span> <span class="nc">ImpermanentLossTracker</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">initial_price_a</span><span class="p">,</span> <span class="n">initial_price_b</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initial_price_a</span> <span class="o">=</span> <span class="n">initial_price_a</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initial_price_b</span> <span class="o">=</span> <span class="n">initial_price_b</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initial_ratio</span> <span class="o">=</span> <span class="n">initial_price_a</span> <span class="o">/</span> <span class="n">initial_price_b</span>

    <span class="k">def</span> <span class="nf">calculate_il</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current_price_a</span><span class="p">,</span> <span class="n">current_price_b</span><span class="p">):</span>
        <span class="n">current_ratio</span> <span class="o">=</span> <span class="n">current_price_a</span> <span class="o">/</span> <span class="n">current_price_b</span>
        <span class="n">price_ratio_change</span> <span class="o">=</span> <span class="n">current_ratio</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_ratio</span>
        <span class="k">return</span> <span class="n">calculate_impermanent_loss</span><span class="p">(</span><span class="n">price_ratio_change</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">breakeven_fees</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">il_percent</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculate APR needed to offset IL.&quot;&quot;&quot;</span>
        <span class="c1"># If IL is -5%, need at least 5% in fees to break even</span>
        <span class="k">return</span> <span class="nb">abs</span><span class="p">(</span><span class="n">il_percent</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">analyze_scenarios</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Show IL for various price changes.&quot;&quot;&quot;</span>
        <span class="n">scenarios</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.25</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Price Change -&gt; Impermanent Loss&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-&#39;</span> <span class="o">*</span> <span class="mi">35</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ratio</span> <span class="ow">in</span> <span class="n">scenarios</span><span class="p">:</span>
            <span class="n">il</span> <span class="o">=</span> <span class="n">calculate_impermanent_loss</span><span class="p">(</span><span class="n">ratio</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ratio</span><span class="si">:</span><span class="s1">&gt;6.2f</span><span class="si">}</span><span class="s1">x      -&gt; </span><span class="si">{</span><span class="n">il</span><span class="si">:</span><span class="s1">&gt;6.2f</span><span class="si">}</span><span class="s1">%&#39;</span><span class="p">)</span>

<span class="n">tracker</span> <span class="o">=</span> <span class="n">ImpermanentLossTracker</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># ETH at $2000, USDC at $1</span>
<span class="n">tracker</span><span class="o">.</span><span class="n">analyze_scenarios</span><span class="p">()</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>Section 4: DeFi Data Sources</h1></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="kn">import</span> <span class="nn">requests</span>

<span class="k">class</span> <span class="nc">DeFiLlamaAPI</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Access DeFi Llama API for protocol data.&quot;&quot;&quot;</span>
    
    <span class="n">BASE_URL</span> <span class="o">=</span> <span class="s1">&#39;https://api.llama.fi&#39;</span>
    
    <span class="k">def</span> <span class="nf">get_protocols</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get all DeFi protocols.&quot;&quot;&quot;</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">BASE_URL</span><span class="si">}</span><span class="s1">/protocols&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">get_protocol</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">slug</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get specific protocol data.&quot;&quot;&quot;</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">BASE_URL</span><span class="si">}</span><span class="s1">/protocol/</span><span class="si">{</span><span class="n">slug</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">get_tvl_by_chain</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get TVL breakdown by chain.&quot;&quot;&quot;</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">BASE_URL</span><span class="si">}</span><span class="s1">/v2/chains&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">get_yields</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get yield farming opportunities.&quot;&quot;&quot;</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;https://yields.llama.fi/pools&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">top_protocols</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get top protocols by TVL.&quot;&quot;&quot;</span>
        <span class="n">protocols</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_protocols</span><span class="p">()</span>
        <span class="k">if</span> <span class="s1">&#39;error&#39;</span> <span class="ow">in</span> <span class="n">protocols</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">protocols</span>
        
        <span class="n">sorted_protocols</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">protocols</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tvl&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[{</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span>
            <span class="s1">&#39;tvl&#39;</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tvl&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
            <span class="s1">&#39;chain&#39;</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;chain&#39;</span><span class="p">,</span> <span class="s1">&#39;Multi&#39;</span><span class="p">),</span>
            <span class="s1">&#39;category&#39;</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;category&#39;</span><span class="p">,</span> <span class="s1">&#39;Unknown&#39;</span><span class="p">)</span>
        <span class="p">}</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">sorted_protocols</span><span class="p">[:</span><span class="n">n</span><span class="p">]]</span>
</code></pre></div>
<div class="md-cell"><h3>âœï¸ Exercise 12.4: DeFi Data Aggregator</h3>
<p>Build a comprehensive DeFi data aggregator.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="c1"># Exercise 12.4</span>
<span class="k">class</span> <span class="nc">DeFiDataAggregator</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">llama</span> <span class="o">=</span> <span class="n">DeFiLlamaAPI</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="k">def</span> <span class="nf">get_market_overview</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># TODO: Return total TVL, top chains, top protocols</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">find_yield_opportunities</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">min_tvl</span><span class="o">=</span><span class="mi">1_000_000</span><span class="p">,</span> <span class="n">min_apy</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
        <span class="c1"># TODO: Filter yield opportunities</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">compare_protocols</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">protocols</span><span class="p">):</span>
        <span class="c1"># TODO: Compare multiple protocols</span>
        <span class="k">pass</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">DeFiDataAggregator</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">llama</span> <span class="o">=</span> <span class="n">DeFiLlamaAPI</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache_ttl</span> <span class="o">=</span> <span class="mi">300</span>  <span class="c1"># 5 minutes</span>

    <span class="k">def</span> <span class="nf">get_market_overview</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">protocols</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">llama</span><span class="o">.</span><span class="n">get_protocols</span><span class="p">()</span>
        <span class="n">chains</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">llama</span><span class="o">.</span><span class="n">get_tvl_by_chain</span><span class="p">()</span>

        <span class="k">if</span> <span class="s1">&#39;error&#39;</span> <span class="ow">in</span> <span class="n">protocols</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">protocols</span>

        <span class="n">total_tvl</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tvl&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">protocols</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;total_tvl&#39;</span><span class="p">:</span> <span class="n">total_tvl</span><span class="p">,</span>
            <span class="s1">&#39;total_protocols&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">protocols</span><span class="p">),</span>
            <span class="s1">&#39;top_chains&#39;</span><span class="p">:</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">chains</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tvl&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)[:</span><span class="mi">5</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">chains</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="p">[],</span>
            <span class="s1">&#39;top_protocols&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">llama</span><span class="o">.</span><span class="n">top_protocols</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">find_yield_opportunities</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">min_tvl</span><span class="o">=</span><span class="mi">1_000_000</span><span class="p">,</span> <span class="n">min_apy</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">max_apy</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
        <span class="n">yields</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">llama</span><span class="o">.</span><span class="n">get_yields</span><span class="p">()</span>
        <span class="k">if</span> <span class="s1">&#39;error&#39;</span> <span class="ow">in</span> <span class="n">yields</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">yields</span>

        <span class="n">pools</span> <span class="o">=</span> <span class="n">yields</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="p">[])</span>

        <span class="n">filtered</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s1">&#39;pool&#39;</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pool&#39;</span><span class="p">),</span>
                <span class="s1">&#39;project&#39;</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;project&#39;</span><span class="p">),</span>
                <span class="s1">&#39;chain&#39;</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;chain&#39;</span><span class="p">),</span>
                <span class="s1">&#39;tvl&#39;</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tvlUsd&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                <span class="s1">&#39;apy&#39;</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;apy&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;symbol&#39;</span><span class="p">)</span>
            <span class="p">}</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pools</span>
            <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tvlUsd&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">min_tvl</span>
            <span class="ow">and</span> <span class="n">min_apy</span> <span class="o">&lt;=</span> <span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;apy&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">max_apy</span>
        <span class="p">]</span>

        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">filtered</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;apy&#39;</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)[:</span><span class="mi">20</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">compare_protocols</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">protocol_slugs</span><span class="p">):</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">slug</span> <span class="ow">in</span> <span class="n">protocol_slugs</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">llama</span><span class="o">.</span><span class="n">get_protocol</span><span class="p">(</span><span class="n">slug</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;error&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">),</span>
                    <span class="s1">&#39;tvl&#39;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tvl&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                    <span class="s1">&#39;chains&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;chainTvls&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
                    <span class="s1">&#39;category&#39;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;category&#39;</span><span class="p">)</span>
                <span class="p">})</span>
        <span class="k">return</span> <span class="n">results</span>

<span class="n">agg</span> <span class="o">=</span> <span class="n">DeFiDataAggregator</span><span class="p">()</span>
<span class="c1"># overview = agg.get_market_overview()</span>
<span class="c1"># print(f&quot;Total DeFi TVL: ${overview[&#39;total_tvl&#39;]:,.0f}&quot;)</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>ğŸ—ï¸ Module Project: DeFi Data Aggregator</h1>
<p>Build a complete DeFi monitoring dashboard.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="c1"># Module Project</span>
<span class="k">class</span> <span class="nc">DeFiDashboard</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">web3</span> <span class="o">=</span> <span class="n">MultiChainWeb3</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">DeFiDataAggregator</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tracked_protocols</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chains</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;ethereum&#39;</span><span class="p">]):</span>
        <span class="c1"># TODO: Connect to chains</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">track_protocol</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">slug</span><span class="p">):</span>
        <span class="c1"># TODO: Add protocol to watchlist</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">get_dashboard_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># TODO: Return complete dashboard data</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">display</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># TODO: Print formatted dashboard</span>
        <span class="k">pass</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">DeFiDashboard</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">web3</span> <span class="o">=</span> <span class="n">MultiChainWeb3</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">DeFiDataAggregator</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tracked_protocols</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chains</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;ethereum&#39;</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">chain</span> <span class="ow">in</span> <span class="n">chains</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">web3</span><span class="o">.</span><span class="n">connect_chain</span><span class="p">(</span><span class="n">chain</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">web3</span><span class="o">.</span><span class="n">check_all_connections</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">track_protocol</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">slug</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tracked_protocols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">slug</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_dashboard_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;market_overview&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get_market_overview</span><span class="p">(),</span>
            <span class="s1">&#39;connections&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">web3</span><span class="o">.</span><span class="n">check_all_connections</span><span class="p">(),</span>
            <span class="s1">&#39;tracked&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">compare_protocols</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tracked_protocols</span><span class="p">),</span>
            <span class="s1">&#39;top_yields&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">find_yield_opportunities</span><span class="p">(</span><span class="n">min_tvl</span><span class="o">=</span><span class="mi">10_000_000</span><span class="p">,</span> <span class="n">min_apy</span><span class="o">=</span><span class="mi">10</span><span class="p">)[:</span><span class="mi">5</span><span class="p">]</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">display</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_dashboard_data</span><span class="p">()</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=&#39;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;           DEFI DASHBOARD&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=&#39;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>

        <span class="c1"># Market overview</span>
        <span class="n">overview</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;market_overview&#39;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Total DeFi TVL: $</span><span class="si">{</span><span class="n">overview</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;total_tvl&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="si">:</span><span class="s2">,.0f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Protocols: </span><span class="si">{</span><span class="n">overview</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;total_protocols&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Connections</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Chain Connections:&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">chain</span><span class="p">,</span> <span class="n">status</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;connections&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">icon</span> <span class="o">=</span> <span class="s1">&#39;âœ…&#39;</span> <span class="k">if</span> <span class="n">status</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;connected&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;âŒ&#39;</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">icon</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">chain</span><span class="si">}</span><span class="s2">: Block </span><span class="si">{</span><span class="n">status</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;block&#39;</span><span class="p">,</span> <span class="s1">&#39;N/A&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Top yields</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Top Yield Opportunities:&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;top_yields&#39;</span><span class="p">,</span> <span class="p">[])[:</span><span class="mi">5</span><span class="p">]:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">y</span><span class="p">[</span><span class="s1">&#39;project&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">y</span><span class="p">[</span><span class="s1">&#39;symbol&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">y</span><span class="p">[</span><span class="s1">&#39;apy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">% APY ($</span><span class="si">{</span><span class="n">y</span><span class="p">[</span><span class="s1">&#39;tvl&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">,.0f</span><span class="si">}</span><span class="s2"> TVL)&quot;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=&#39;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>

<span class="c1"># Usage</span>
<span class="n">dashboard</span> <span class="o">=</span> <span class="n">DeFiDashboard</span><span class="p">()</span>
<span class="n">dashboard</span><span class="o">.</span><span class="n">initialize</span><span class="p">([</span><span class="s1">&#39;ethereum&#39;</span><span class="p">])</span>
<span class="n">dashboard</span><span class="o">.</span><span class="n">track_protocol</span><span class="p">(</span><span class="s1">&#39;uniswap&#39;</span><span class="p">)</span>
<span class="n">dashboard</span><span class="o">.</span><span class="n">track_protocol</span><span class="p">(</span><span class="s1">&#39;aave&#39;</span><span class="p">)</span>
<span class="c1"># dashboard.display()</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>ğŸ“ Key Takeaways</h1>
<ol>
<li><strong>DeFi Basics</strong>: DEXs, lending, yields - all without intermediaries</li>
<li><strong>Web3.py</strong>: Connect to Ethereum and read blockchain data</li>
<li><strong>AMMs</strong>: Constant product formula (x * y = k) determines prices</li>
<li><strong>Data Sources</strong>: DeFi Llama for TVL, yields, protocol data</li>
</ol>
<hr />
<p><em>Next: Module 13 - DEX Trading</em></p></div>
        <div class="nav-buttons">
            <button class="nav-btn prev-btn disabled" type="button">
                <span class="nav-btn-label">â† Previous</span>
                <span class="nav-btn-name"></span>
            </button>
            <button class="nav-btn next-btn disabled" type="button">
                <span class="nav-btn-label">Next â†’</span>
                <span class="nav-btn-name"></span>
            </button>
        </div>
        </div>
<div class="module-section" data-idx="13"><div class="md-cell module-header"><h1>Module 13: DEX Trading</h1>
<h2>Part 4: DeFi &amp; Advanced Topics</h2>
<hr />
<div class="table-wrapper"><table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>â±ï¸ <strong>Duration</strong></td>
<td>~2.5 hours</td>
</tr>
<tr>
<td>ğŸ“‹ <strong>Prerequisites</strong></td>
<td>Module 12</td>
</tr>
<tr>
<td>ğŸ’ª <strong>Exercises</strong></td>
<td>5 total</td>
</tr>
</tbody>
</table></div></div>
<div class="md-cell"><h2>ğŸ¯ Learning Objectives</h2>
<ul>
<li>Integrate with Uniswap for quotes and swaps</li>
<li>Execute DEX trades safely</li>
<li>Understand and protect against MEV</li>
<li>Use DEX aggregators for best execution</li>
</ul></div>
<div class="md-cell"><hr />
<h1>Section 1: Uniswap Integration</h1>
<h2>1.1 Getting Quotes</h2></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="kn">from</span> <span class="nn">web3</span> <span class="kn">import</span> <span class="n">Web3</span>
<span class="kn">import</span> <span class="nn">json</span>

<span class="c1"># Uniswap V2 Router ABI (minimal for quotes)</span>
<span class="n">UNISWAP_V2_ROUTER_ABI</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="s2">&quot;inputs&quot;</span><span class="p">:</span> <span class="p">[{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;amountIn&quot;</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;uint256&quot;</span><span class="p">},</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;path&quot;</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;address[]&quot;</span><span class="p">}],</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;getAmountsOut&quot;</span><span class="p">,</span>
        <span class="s2">&quot;outputs&quot;</span><span class="p">:</span> <span class="p">[{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;amounts&quot;</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;uint256[]&quot;</span><span class="p">}],</span>
        <span class="s2">&quot;stateMutability&quot;</span><span class="p">:</span> <span class="s2">&quot;view&quot;</span><span class="p">,</span>
        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;function&quot;</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="s2">&quot;inputs&quot;</span><span class="p">:</span> <span class="p">[{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;amountOut&quot;</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;uint256&quot;</span><span class="p">},</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;path&quot;</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;address[]&quot;</span><span class="p">}],</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;getAmountsIn&quot;</span><span class="p">,</span>
        <span class="s2">&quot;outputs&quot;</span><span class="p">:</span> <span class="p">[{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;amounts&quot;</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;uint256[]&quot;</span><span class="p">}],</span>
        <span class="s2">&quot;stateMutability&quot;</span><span class="p">:</span> <span class="s2">&quot;view&quot;</span><span class="p">,</span>
        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;function&quot;</span>
    <span class="p">}</span>
<span class="p">]</span>

<span class="k">class</span> <span class="nc">UniswapQuoter</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Get quotes from Uniswap V2.&quot;&quot;&quot;</span>
    
    <span class="n">ROUTER_ADDRESS</span> <span class="o">=</span> <span class="s1">&#39;0x7a250d5630B4cF539739dF2C5dAcb4c659F2488D&#39;</span>
    
    <span class="c1"># Common token addresses (Ethereum mainnet)</span>
    <span class="n">TOKENS</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;WETH&#39;</span><span class="p">:</span> <span class="s1">&#39;0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2&#39;</span><span class="p">,</span>
        <span class="s1">&#39;USDC&#39;</span><span class="p">:</span> <span class="s1">&#39;0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48&#39;</span><span class="p">,</span>
        <span class="s1">&#39;USDT&#39;</span><span class="p">:</span> <span class="s1">&#39;0xdAC17F958D2ee523a2206206994597C13D831ec7&#39;</span><span class="p">,</span>
        <span class="s1">&#39;DAI&#39;</span><span class="p">:</span> <span class="s1">&#39;0x6B175474E89094C44Da98b954EescdeCB5BE3386&#39;</span><span class="p">,</span>
        <span class="s1">&#39;WBTC&#39;</span><span class="p">:</span> <span class="s1">&#39;0x2260FAC5E5542a773Aa44fBCfeDf7C193bc2C599&#39;</span>
    <span class="p">}</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">w3</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w3</span> <span class="o">=</span> <span class="n">w3</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">router</span> <span class="o">=</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">contract</span><span class="p">(</span>
            <span class="n">address</span><span class="o">=</span><span class="n">Web3</span><span class="o">.</span><span class="n">to_checksum_address</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ROUTER_ADDRESS</span><span class="p">),</span>
            <span class="n">abi</span><span class="o">=</span><span class="n">UNISWAP_V2_ROUTER_ABI</span>
        <span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">get_quote</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token_in</span><span class="p">,</span> <span class="n">token_out</span><span class="p">,</span> <span class="n">amount_in</span><span class="p">,</span> <span class="n">decimals_in</span><span class="o">=</span><span class="mi">18</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get quote for swap.</span>
<span class="sd">        </span>
<span class="sd">        Returns amount out for given amount in.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Convert to Wei</span>
        <span class="n">amount_in_wei</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">amount_in</span> <span class="o">*</span> <span class="p">(</span><span class="mi">10</span> <span class="o">**</span> <span class="n">decimals_in</span><span class="p">))</span>
        
        <span class="c1"># Build path (through WETH if needed)</span>
        <span class="k">if</span> <span class="n">token_in</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">TOKENS</span><span class="p">[</span><span class="s1">&#39;WETH&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">token_out</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">TOKENS</span><span class="p">[</span><span class="s1">&#39;WETH&#39;</span><span class="p">]:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="p">[</span><span class="n">token_in</span><span class="p">,</span> <span class="n">token_out</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="p">[</span><span class="n">token_in</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">TOKENS</span><span class="p">[</span><span class="s1">&#39;WETH&#39;</span><span class="p">],</span> <span class="n">token_out</span><span class="p">]</span>
        
        <span class="n">path</span> <span class="o">=</span> <span class="p">[</span><span class="n">Web3</span><span class="o">.</span><span class="n">to_checksum_address</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">path</span><span class="p">]</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="n">amounts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">router</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">getAmountsOut</span><span class="p">(</span><span class="n">amount_in_wei</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">call</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">amounts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>
    
    <span class="k">def</span> <span class="nf">get_price_impact</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token_in</span><span class="p">,</span> <span class="n">token_out</span><span class="p">,</span> <span class="n">amount_in</span><span class="p">,</span> <span class="n">decimals_in</span><span class="o">=</span><span class="mi">18</span><span class="p">,</span> <span class="n">decimals_out</span><span class="o">=</span><span class="mi">18</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculate price impact for a trade.&quot;&quot;&quot;</span>
        <span class="c1"># Get quote for small amount (baseline price)</span>
        <span class="n">small_quote</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_quote</span><span class="p">(</span><span class="n">token_in</span><span class="p">,</span> <span class="n">token_out</span><span class="p">,</span> <span class="mf">0.001</span><span class="p">,</span> <span class="n">decimals_in</span><span class="p">)</span>
        
        <span class="c1"># Get quote for actual amount</span>
        <span class="n">actual_quote</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_quote</span><span class="p">(</span><span class="n">token_in</span><span class="p">,</span> <span class="n">token_out</span><span class="p">,</span> <span class="n">amount_in</span><span class="p">,</span> <span class="n">decimals_in</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">small_quote</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">actual_quote</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Could not get quotes&#39;</span><span class="p">}</span>
        
        <span class="c1"># Calculate effective prices</span>
        <span class="n">small_price</span> <span class="o">=</span> <span class="n">small_quote</span> <span class="o">/</span> <span class="p">(</span><span class="mf">0.001</span> <span class="o">*</span> <span class="mi">10</span> <span class="o">**</span> <span class="n">decimals_in</span><span class="p">)</span>
        <span class="n">actual_price</span> <span class="o">=</span> <span class="n">actual_quote</span> <span class="o">/</span> <span class="p">(</span><span class="n">amount_in</span> <span class="o">*</span> <span class="mi">10</span> <span class="o">**</span> <span class="n">decimals_in</span><span class="p">)</span>
        
        <span class="n">impact</span> <span class="o">=</span> <span class="p">(</span><span class="n">small_price</span> <span class="o">-</span> <span class="n">actual_price</span><span class="p">)</span> <span class="o">/</span> <span class="n">small_price</span> <span class="o">*</span> <span class="mi">100</span>
        <span class="k">return</span> <span class="n">impact</span>
</code></pre></div>
<div class="md-cell"><h3>âœï¸ Exercise 13.1: Multi-DEX Quoter</h3>
<p>Build a quoter that checks multiple DEXs.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="c1"># Exercise 13.1</span>
<span class="k">class</span> <span class="nc">MultiDEXQuoter</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">w3</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w3</span> <span class="o">=</span> <span class="n">w3</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dexes</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="k">def</span> <span class="nf">add_dex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">router_address</span><span class="p">,</span> <span class="n">abi</span><span class="p">):</span>
        <span class="c1"># TODO: Add DEX to quoter</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">get_best_quote</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token_in</span><span class="p">,</span> <span class="n">token_out</span><span class="p">,</span> <span class="n">amount_in</span><span class="p">):</span>
        <span class="c1"># TODO: Get quotes from all DEXs and return best</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">compare_quotes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token_in</span><span class="p">,</span> <span class="n">token_out</span><span class="p">,</span> <span class="n">amount_in</span><span class="p">):</span>
        <span class="c1"># TODO: Return comparison of all DEX quotes</span>
        <span class="k">pass</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">MultiDEXQuoter</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">w3</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w3</span> <span class="o">=</span> <span class="n">w3</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dexes</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">add_dex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">router_address</span><span class="p">,</span> <span class="n">abi</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dexes</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;router&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">contract</span><span class="p">(</span>
                <span class="n">address</span><span class="o">=</span><span class="n">Web3</span><span class="o">.</span><span class="n">to_checksum_address</span><span class="p">(</span><span class="n">router_address</span><span class="p">),</span>
                <span class="n">abi</span><span class="o">=</span><span class="n">abi</span>
            <span class="p">),</span>
            <span class="s1">&#39;address&#39;</span><span class="p">:</span> <span class="n">router_address</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">get_quote_from_dex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dex_name</span><span class="p">,</span> <span class="n">token_in</span><span class="p">,</span> <span class="n">token_out</span><span class="p">,</span> <span class="n">amount_in_wei</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">router</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dexes</span><span class="p">[</span><span class="n">dex_name</span><span class="p">][</span><span class="s1">&#39;router&#39;</span><span class="p">]</span>
            <span class="n">amounts</span> <span class="o">=</span> <span class="n">router</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">getAmountsOut</span><span class="p">(</span><span class="n">amount_in_wei</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">call</span><span class="p">()</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;dex&#39;</span><span class="p">:</span> <span class="n">dex_name</span><span class="p">,</span> <span class="s1">&#39;amount_out&#39;</span><span class="p">:</span> <span class="n">amounts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;dex&#39;</span><span class="p">:</span> <span class="n">dex_name</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">get_best_quote</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token_in</span><span class="p">,</span> <span class="n">token_out</span><span class="p">,</span> <span class="n">amount_in</span><span class="p">,</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">18</span><span class="p">):</span>
        <span class="n">amount_in_wei</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">amount_in</span> <span class="o">*</span> <span class="p">(</span><span class="mi">10</span> <span class="o">**</span> <span class="n">decimals</span><span class="p">))</span>
        <span class="n">path</span> <span class="o">=</span> <span class="p">[</span><span class="n">Web3</span><span class="o">.</span><span class="n">to_checksum_address</span><span class="p">(</span><span class="n">token_in</span><span class="p">),</span> <span class="n">Web3</span><span class="o">.</span><span class="n">to_checksum_address</span><span class="p">(</span><span class="n">token_out</span><span class="p">)]</span>

        <span class="n">quotes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">dex_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dexes</span><span class="p">:</span>
            <span class="n">quote</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_quote_from_dex</span><span class="p">(</span><span class="n">dex_name</span><span class="p">,</span> <span class="n">token_in</span><span class="p">,</span> <span class="n">token_out</span><span class="p">,</span> <span class="n">amount_in_wei</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">quote</span><span class="p">[</span><span class="s1">&#39;success&#39;</span><span class="p">]:</span>
                <span class="n">quotes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">quote</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">quotes</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;No valid quotes&#39;</span><span class="p">}</span>

        <span class="n">best</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">quotes</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;amount_out&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">best</span>

    <span class="k">def</span> <span class="nf">compare_quotes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token_in</span><span class="p">,</span> <span class="n">token_out</span><span class="p">,</span> <span class="n">amount_in</span><span class="p">,</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">18</span><span class="p">):</span>
        <span class="n">amount_in_wei</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">amount_in</span> <span class="o">*</span> <span class="p">(</span><span class="mi">10</span> <span class="o">**</span> <span class="n">decimals</span><span class="p">))</span>
        <span class="n">path</span> <span class="o">=</span> <span class="p">[</span><span class="n">Web3</span><span class="o">.</span><span class="n">to_checksum_address</span><span class="p">(</span><span class="n">token_in</span><span class="p">),</span> <span class="n">Web3</span><span class="o">.</span><span class="n">to_checksum_address</span><span class="p">(</span><span class="n">token_out</span><span class="p">)]</span>

        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">dex_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dexes</span><span class="p">:</span>
            <span class="n">quote</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_quote_from_dex</span><span class="p">(</span><span class="n">dex_name</span><span class="p">,</span> <span class="n">token_in</span><span class="p">,</span> <span class="n">token_out</span><span class="p">,</span> <span class="n">amount_in_wei</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">quote</span><span class="p">)</span>

        <span class="c1"># Sort by amount out</span>
        <span class="n">valid</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span> <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;success&#39;</span><span class="p">]]</span>
        <span class="n">valid</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;amount_out&#39;</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;quotes&#39;</span><span class="p">:</span> <span class="n">valid</span><span class="p">,</span> <span class="s1">&#39;best&#39;</span><span class="p">:</span> <span class="n">valid</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">valid</span> <span class="k">else</span> <span class="kc">None</span><span class="p">}</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>Section 2: Executing DEX Trades</h1>
<h2>2.1 Transaction Building</h2></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">DEXTrader</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Execute trades on Uniswap V2.&quot;&quot;&quot;</span>
    
    <span class="n">SWAP_ABI</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="s2">&quot;inputs&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;amountIn&quot;</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;uint256&quot;</span><span class="p">},</span>
                <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;amountOutMin&quot;</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;uint256&quot;</span><span class="p">},</span>
                <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;path&quot;</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;address[]&quot;</span><span class="p">},</span>
                <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;to&quot;</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;address&quot;</span><span class="p">},</span>
                <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;deadline&quot;</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;uint256&quot;</span><span class="p">}</span>
            <span class="p">],</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;swapExactTokensForTokens&quot;</span><span class="p">,</span>
            <span class="s2">&quot;outputs&quot;</span><span class="p">:</span> <span class="p">[{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;amounts&quot;</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;uint256[]&quot;</span><span class="p">}],</span>
            <span class="s2">&quot;stateMutability&quot;</span><span class="p">:</span> <span class="s2">&quot;nonpayable&quot;</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;function&quot;</span>
        <span class="p">}</span>
    <span class="p">]</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">w3</span><span class="p">,</span> <span class="n">router_address</span><span class="p">,</span> <span class="n">private_key</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w3</span> <span class="o">=</span> <span class="n">w3</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">router</span> <span class="o">=</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">contract</span><span class="p">(</span>
            <span class="n">address</span><span class="o">=</span><span class="n">Web3</span><span class="o">.</span><span class="n">to_checksum_address</span><span class="p">(</span><span class="n">router_address</span><span class="p">),</span>
            <span class="n">abi</span><span class="o">=</span><span class="n">UNISWAP_V2_ROUTER_ABI</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">SWAP_ABI</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">private_key</span> <span class="o">=</span> <span class="n">private_key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wallet</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">private_key</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wallet</span> <span class="o">=</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">account</span><span class="o">.</span><span class="n">from_key</span><span class="p">(</span><span class="n">private_key</span><span class="p">)</span><span class="o">.</span><span class="n">address</span>
    
    <span class="k">def</span> <span class="nf">build_swap_tx</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token_in</span><span class="p">,</span> <span class="n">token_out</span><span class="p">,</span> <span class="n">amount_in</span><span class="p">,</span> <span class="n">slippage</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">deadline_minutes</span><span class="o">=</span><span class="mi">20</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Build swap transaction (does not execute).</span>
<span class="sd">        </span>
<span class="sd">        slippage: Maximum acceptable slippage in percent</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">time</span>
        
        <span class="c1"># Get quote</span>
        <span class="n">path</span> <span class="o">=</span> <span class="p">[</span><span class="n">Web3</span><span class="o">.</span><span class="n">to_checksum_address</span><span class="p">(</span><span class="n">token_in</span><span class="p">),</span> <span class="n">Web3</span><span class="o">.</span><span class="n">to_checksum_address</span><span class="p">(</span><span class="n">token_out</span><span class="p">)]</span>
        <span class="n">amounts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">router</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">getAmountsOut</span><span class="p">(</span><span class="n">amount_in</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">call</span><span class="p">()</span>
        <span class="n">amount_out</span> <span class="o">=</span> <span class="n">amounts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        
        <span class="c1"># Calculate minimum out with slippage</span>
        <span class="n">amount_out_min</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">amount_out</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">slippage</span> <span class="o">/</span> <span class="mi">100</span><span class="p">))</span>
        
        <span class="c1"># Deadline</span>
        <span class="n">deadline</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span> <span class="o">+</span> <span class="p">(</span><span class="n">deadline_minutes</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
        
        <span class="c1"># Build transaction</span>
        <span class="n">tx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">router</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">swapExactTokensForTokens</span><span class="p">(</span>
            <span class="n">amount_in</span><span class="p">,</span>
            <span class="n">amount_out_min</span><span class="p">,</span>
            <span class="n">path</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wallet</span><span class="p">,</span>
            <span class="n">deadline</span>
        <span class="p">)</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;tx&#39;</span><span class="p">:</span> <span class="n">tx</span><span class="p">,</span>
            <span class="s1">&#39;amount_in&#39;</span><span class="p">:</span> <span class="n">amount_in</span><span class="p">,</span>
            <span class="s1">&#39;expected_out&#39;</span><span class="p">:</span> <span class="n">amount_out</span><span class="p">,</span>
            <span class="s1">&#39;min_out&#39;</span><span class="p">:</span> <span class="n">amount_out_min</span><span class="p">,</span>
            <span class="s1">&#39;slippage&#39;</span><span class="p">:</span> <span class="n">slippage</span><span class="p">,</span>
            <span class="s1">&#39;deadline&#39;</span><span class="p">:</span> <span class="n">deadline</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">estimate_gas</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tx_data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Estimate gas for transaction.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">gas</span> <span class="o">=</span> <span class="n">tx_data</span><span class="p">[</span><span class="s1">&#39;tx&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">estimate_gas</span><span class="p">({</span><span class="s1">&#39;from&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">wallet</span><span class="p">})</span>
            <span class="n">gas_price</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">gas_price</span>
            <span class="n">cost_wei</span> <span class="o">=</span> <span class="n">gas</span> <span class="o">*</span> <span class="n">gas_price</span>
            <span class="n">cost_eth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">w3</span><span class="o">.</span><span class="n">from_wei</span><span class="p">(</span><span class="n">cost_wei</span><span class="p">,</span> <span class="s1">&#39;ether&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s1">&#39;gas_units&#39;</span><span class="p">:</span> <span class="n">gas</span><span class="p">,</span>
                <span class="s1">&#39;gas_price_gwei&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">w3</span><span class="o">.</span><span class="n">from_wei</span><span class="p">(</span><span class="n">gas_price</span><span class="p">,</span> <span class="s1">&#39;gwei&#39;</span><span class="p">),</span>
                <span class="s1">&#39;cost_eth&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">cost_eth</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>
</code></pre></div>
<div class="md-cell"><h2>2.2 Slippage Protection</h2></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">SlippageProtection</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Calculate and manage slippage settings.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">default_slippage</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default_slippage</span> <span class="o">=</span> <span class="n">default_slippage</span>
    
    <span class="k">def</span> <span class="nf">calculate_min_output</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expected_output</span><span class="p">,</span> <span class="n">slippage_pct</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculate minimum acceptable output.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">expected_output</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">slippage_pct</span> <span class="o">/</span> <span class="mi">100</span><span class="p">))</span>
    
    <span class="k">def</span> <span class="nf">recommend_slippage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token_pair</span><span class="p">,</span> <span class="n">trade_size_usd</span><span class="p">,</span> <span class="n">liquidity_usd</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Recommend slippage based on trade size vs liquidity.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">trade_ratio</span> <span class="o">=</span> <span class="n">trade_size_usd</span> <span class="o">/</span> <span class="n">liquidity_usd</span>
        
        <span class="k">if</span> <span class="n">trade_ratio</span> <span class="o">&lt;</span> <span class="mf">0.001</span><span class="p">:</span>  <span class="c1"># &lt; 0.1% of liquidity</span>
            <span class="k">return</span> <span class="mf">0.1</span>
        <span class="k">elif</span> <span class="n">trade_ratio</span> <span class="o">&lt;</span> <span class="mf">0.01</span><span class="p">:</span>  <span class="c1"># &lt; 1% of liquidity</span>
            <span class="k">return</span> <span class="mf">0.5</span>
        <span class="k">elif</span> <span class="n">trade_ratio</span> <span class="o">&lt;</span> <span class="mf">0.05</span><span class="p">:</span>  <span class="c1"># &lt; 5% of liquidity</span>
            <span class="k">return</span> <span class="mf">1.0</span>
        <span class="k">elif</span> <span class="n">trade_ratio</span> <span class="o">&lt;</span> <span class="mf">0.1</span><span class="p">:</span>   <span class="c1"># &lt; 10% of liquidity</span>
            <span class="k">return</span> <span class="mf">2.0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">5.0</span>  <span class="c1"># Large trade, high slippage needed</span>
    
    <span class="k">def</span> <span class="nf">is_slippage_acceptable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expected</span><span class="p">,</span> <span class="n">actual</span><span class="p">,</span> <span class="n">max_slippage_pct</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check if actual slippage is within acceptable range.&quot;&quot;&quot;</span>
        <span class="n">actual_slippage</span> <span class="o">=</span> <span class="p">(</span><span class="n">expected</span> <span class="o">-</span> <span class="n">actual</span><span class="p">)</span> <span class="o">/</span> <span class="n">expected</span> <span class="o">*</span> <span class="mi">100</span>
        <span class="k">return</span> <span class="n">actual_slippage</span> <span class="o">&lt;=</span> <span class="n">max_slippage_pct</span>

<span class="n">slip</span> <span class="o">=</span> <span class="n">SlippageProtection</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Min output for 1000 with 0.5% slippage: </span><span class="si">{</span><span class="n">slip</span><span class="o">.</span><span class="n">calculate_min_output</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Recommended slippage for $10k trade in $1M pool: </span><span class="si">{</span><span class="n">slip</span><span class="o">.</span><span class="n">recommend_slippage</span><span class="p">(</span><span class="s2">&quot;ETH/USDC&quot;</span><span class="p">,</span> <span class="mi">10000</span><span class="p">,</span> <span class="mi">1000000</span><span class="p">)</span><span class="si">}</span><span class="s1">%&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h3>âœï¸ Exercise 13.2: Safe DEX Executor</h3>
<p>Build a DEX executor with safety checks.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="c1"># Exercise 13.2</span>
<span class="k">class</span> <span class="nc">SafeDEXExecutor</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">w3</span><span class="p">,</span> <span class="n">router_address</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w3</span> <span class="o">=</span> <span class="n">w3</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">router_address</span> <span class="o">=</span> <span class="n">router_address</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_slippage</span> <span class="o">=</span> <span class="mf">2.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_gas_gwei</span> <span class="o">=</span> <span class="mi">100</span>
    
    <span class="k">def</span> <span class="nf">pre_trade_checks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trade_params</span><span class="p">):</span>
        <span class="c1"># TODO: Validate trade parameters</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">execute_with_checks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token_in</span><span class="p">,</span> <span class="n">token_out</span><span class="p">,</span> <span class="n">amount_in</span><span class="p">,</span> <span class="n">slippage</span><span class="p">):</span>
        <span class="c1"># TODO: Execute trade with all safety checks</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">simulate_trade</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token_in</span><span class="p">,</span> <span class="n">token_out</span><span class="p">,</span> <span class="n">amount_in</span><span class="p">):</span>
        <span class="c1"># TODO: Simulate without executing</span>
        <span class="k">pass</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">SafeDEXExecutor</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">w3</span><span class="p">,</span> <span class="n">router_address</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w3</span> <span class="o">=</span> <span class="n">w3</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">router_address</span> <span class="o">=</span> <span class="n">router_address</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_slippage</span> <span class="o">=</span> <span class="mf">2.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_gas_gwei</span> <span class="o">=</span> <span class="mi">100</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slippage_calc</span> <span class="o">=</span> <span class="n">SlippageProtection</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">pre_trade_checks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trade_params</span><span class="p">):</span>
        <span class="n">checks</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;passed&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;issues&#39;</span><span class="p">:</span> <span class="p">[]}</span>

        <span class="c1"># Check slippage</span>
        <span class="k">if</span> <span class="n">trade_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;slippage&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_slippage</span><span class="p">:</span>
            <span class="n">checks</span><span class="p">[</span><span class="s1">&#39;issues&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Slippage </span><span class="si">{</span><span class="n">trade_params</span><span class="p">[</span><span class="s1">&#39;slippage&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">% exceeds max </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">max_slippage</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
            <span class="n">checks</span><span class="p">[</span><span class="s1">&#39;passed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Check gas price</span>
        <span class="n">current_gas</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">w3</span><span class="o">.</span><span class="n">from_wei</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">gas_price</span><span class="p">,</span> <span class="s1">&#39;gwei&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">current_gas</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_gas_gwei</span><span class="p">:</span>
            <span class="n">checks</span><span class="p">[</span><span class="s1">&#39;issues&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Gas </span><span class="si">{</span><span class="n">current_gas</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2"> gwei exceeds max </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">max_gas_gwei</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">checks</span><span class="p">[</span><span class="s1">&#39;passed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Check token addresses are valid</span>
        <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;token_in&#39;</span><span class="p">,</span> <span class="s1">&#39;token_out&#39;</span><span class="p">]:</span>
            <span class="n">addr</span> <span class="o">=</span> <span class="n">trade_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">addr</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">Web3</span><span class="o">.</span><span class="n">is_address</span><span class="p">(</span><span class="n">addr</span><span class="p">):</span>
                <span class="n">checks</span><span class="p">[</span><span class="s1">&#39;issues&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid </span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s2"> address&quot;</span><span class="p">)</span>
                <span class="n">checks</span><span class="p">[</span><span class="s1">&#39;passed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="n">checks</span>

    <span class="k">def</span> <span class="nf">simulate_trade</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token_in</span><span class="p">,</span> <span class="n">token_out</span><span class="p">,</span> <span class="n">amount_in</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Simulate trade without executing.&quot;&quot;&quot;</span>
        <span class="n">quoter</span> <span class="o">=</span> <span class="n">UniswapQuoter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">w3</span><span class="p">)</span>

        <span class="n">quote</span> <span class="o">=</span> <span class="n">quoter</span><span class="o">.</span><span class="n">get_quote</span><span class="p">(</span><span class="n">token_in</span><span class="p">,</span> <span class="n">token_out</span><span class="p">,</span> <span class="n">amount_in</span><span class="p">)</span>
        <span class="n">impact</span> <span class="o">=</span> <span class="n">quoter</span><span class="o">.</span><span class="n">get_price_impact</span><span class="p">(</span><span class="n">token_in</span><span class="p">,</span> <span class="n">token_out</span><span class="p">,</span> <span class="n">amount_in</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;amount_in&#39;</span><span class="p">:</span> <span class="n">amount_in</span><span class="p">,</span>
            <span class="s1">&#39;expected_out&#39;</span><span class="p">:</span> <span class="n">quote</span><span class="p">,</span>
            <span class="s1">&#39;price_impact&#39;</span><span class="p">:</span> <span class="n">impact</span><span class="p">,</span>
            <span class="s1">&#39;recommended_slippage&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">slippage_calc</span><span class="o">.</span><span class="n">recommend_slippage</span><span class="p">(</span><span class="s1">&#39;pair&#39;</span><span class="p">,</span> <span class="n">amount_in</span> <span class="o">*</span> <span class="mi">2000</span><span class="p">,</span> <span class="mi">10_000_000</span><span class="p">)</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">execute_with_checks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token_in</span><span class="p">,</span> <span class="n">token_out</span><span class="p">,</span> <span class="n">amount_in</span><span class="p">,</span> <span class="n">slippage</span><span class="p">):</span>
        <span class="c1"># Pre-checks</span>
        <span class="n">checks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre_trade_checks</span><span class="p">({</span>
            <span class="s1">&#39;token_in&#39;</span><span class="p">:</span> <span class="n">token_in</span><span class="p">,</span>
            <span class="s1">&#39;token_out&#39;</span><span class="p">:</span> <span class="n">token_out</span><span class="p">,</span>
            <span class="s1">&#39;slippage&#39;</span><span class="p">:</span> <span class="n">slippage</span>
        <span class="p">})</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">checks</span><span class="p">[</span><span class="s1">&#39;passed&#39;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Pre-checks failed&#39;</span><span class="p">,</span> <span class="s1">&#39;issues&#39;</span><span class="p">:</span> <span class="n">checks</span><span class="p">[</span><span class="s1">&#39;issues&#39;</span><span class="p">]}</span>

        <span class="c1"># Simulate first</span>
        <span class="n">sim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulate_trade</span><span class="p">(</span><span class="n">token_in</span><span class="p">,</span> <span class="n">token_out</span><span class="p">,</span> <span class="n">amount_in</span><span class="p">)</span>

        <span class="c1"># Check price impact</span>
        <span class="k">if</span> <span class="n">sim</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;price_impact&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">slippage</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Price impact </span><span class="si">{</span><span class="n">sim</span><span class="p">[</span><span class="s1">&#39;price_impact&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">% exceeds slippage </span><span class="si">{</span><span class="n">slippage</span><span class="si">}</span><span class="s2">%&quot;</span>
            <span class="p">}</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s1">&#39;simulation&#39;</span><span class="p">:</span> <span class="n">sim</span><span class="p">,</span>
            <span class="s1">&#39;note&#39;</span><span class="p">:</span> <span class="s1">&#39;Ready to execute (actual execution requires signed transaction)&#39;</span>
        <span class="p">}</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>Section 3: MEV Awareness</h1>
<h2>3.1 What is MEV?</h2></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="c1"># MEV (Maximal Extractable Value) types</span>
<span class="n">mev_types</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;frontrunning&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">&#39;Bots see your pending tx and trade before you&#39;</span><span class="p">,</span>
        <span class="s1">&#39;impact&#39;</span><span class="p">:</span> <span class="s1">&#39;You get worse price&#39;</span><span class="p">,</span>
        <span class="s1">&#39;example&#39;</span><span class="p">:</span> <span class="s1">&#39;You buy ETH, bot buys first, you pay more&#39;</span>
    <span class="p">},</span>
    <span class="s1">&#39;sandwich&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">&#39;Bot buys before you AND sells after you&#39;</span><span class="p">,</span>
        <span class="s1">&#39;impact&#39;</span><span class="p">:</span> <span class="s1">&#39;Bot profits from price movement you caused&#39;</span><span class="p">,</span>
        <span class="s1">&#39;example&#39;</span><span class="p">:</span> <span class="s1">&#39;Bot buys -&gt; Your trade -&gt; Bot sells = profit for bot&#39;</span>
    <span class="p">},</span>
    <span class="s1">&#39;backrunning&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">&#39;Bot trades immediately after your tx&#39;</span><span class="p">,</span>
        <span class="s1">&#39;impact&#39;</span><span class="p">:</span> <span class="s1">&#39;Bot captures arbitrage you created&#39;</span><span class="p">,</span>
        <span class="s1">&#39;example&#39;</span><span class="p">:</span> <span class="s1">&#39;Your large trade -&gt; Bot arbitrages the price difference&#39;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;MEV Attack Types:&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">attack</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">mev_types</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">attack</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  What: </span><span class="si">{</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Impact: </span><span class="si">{</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;impact&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Example: </span><span class="si">{</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;example&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h2>3.2 MEV Protection</h2></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">MEVProtection</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Strategies to protect against MEV.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">protection_methods</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;private_mempool&#39;</span><span class="p">:</span> <span class="s1">&#39;Submit tx to private mempool (Flashbots)&#39;</span><span class="p">,</span>
            <span class="s1">&#39;low_slippage&#39;</span><span class="p">:</span> <span class="s1">&#39;Use tight slippage to make sandwich unprofitable&#39;</span><span class="p">,</span>
            <span class="s1">&#39;split_orders&#39;</span><span class="p">:</span> <span class="s1">&#39;Split large orders into smaller chunks&#39;</span><span class="p">,</span>
            <span class="s1">&#39;limit_orders&#39;</span><span class="p">:</span> <span class="s1">&#39;Use DEX limit orders instead of market&#39;</span><span class="p">,</span>
            <span class="s1">&#39;timing&#39;</span><span class="p">:</span> <span class="s1">&#39;Trade during low activity periods&#39;</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">calculate_sandwich_profit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trade_size</span><span class="p">,</span> <span class="n">pool_liquidity</span><span class="p">,</span> <span class="n">fee</span><span class="o">=</span><span class="mf">0.003</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Estimate potential sandwich attack profit.</span>
<span class="sd">        </span>
<span class="sd">        If profit &lt; gas cost, sandwich is unprofitable.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Simplified model</span>
        <span class="n">price_impact</span> <span class="o">=</span> <span class="n">trade_size</span> <span class="o">/</span> <span class="n">pool_liquidity</span>
        <span class="n">potential_profit</span> <span class="o">=</span> <span class="n">trade_size</span> <span class="o">*</span> <span class="n">price_impact</span> <span class="o">*</span> <span class="mf">0.5</span>  <span class="c1"># Rough estimate</span>
        
        <span class="c1"># Subtract fees (attacker pays 2x: front + back)</span>
        <span class="n">profit_after_fees</span> <span class="o">=</span> <span class="n">potential_profit</span> <span class="o">-</span> <span class="p">(</span><span class="n">trade_size</span> <span class="o">*</span> <span class="n">fee</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;potential_profit&#39;</span><span class="p">:</span> <span class="n">potential_profit</span><span class="p">,</span>
            <span class="s1">&#39;profit_after_fees&#39;</span><span class="p">:</span> <span class="n">profit_after_fees</span><span class="p">,</span>
            <span class="s1">&#39;likely_target&#39;</span><span class="p">:</span> <span class="n">profit_after_fees</span> <span class="o">&gt;</span> <span class="mi">50</span>  <span class="c1"># $50 threshold</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">recommend_protection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trade_size_usd</span><span class="p">,</span> <span class="n">pool_liquidity_usd</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Recommend protection strategy based on trade size.&quot;&quot;&quot;</span>
        <span class="n">sandwich</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_sandwich_profit</span><span class="p">(</span><span class="n">trade_size_usd</span><span class="p">,</span> <span class="n">pool_liquidity_usd</span><span class="p">)</span>
        
        <span class="n">recommendations</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">if</span> <span class="n">sandwich</span><span class="p">[</span><span class="s1">&#39;likely_target&#39;</span><span class="p">]:</span>
            <span class="n">recommendations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Use Flashbots or private mempool&#39;</span><span class="p">)</span>
            <span class="n">recommendations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Consider splitting into smaller orders&#39;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">trade_size_usd</span> <span class="o">/</span> <span class="n">pool_liquidity_usd</span> <span class="o">&gt;</span> <span class="mf">0.01</span><span class="p">:</span>
            <span class="n">recommendations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Use tight slippage (0.3-0.5%)&#39;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">trade_size_usd</span> <span class="o">&gt;</span> <span class="mi">100000</span><span class="p">:</span>
            <span class="n">recommendations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Consider OTC or DEX aggregator&#39;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;trade_size&#39;</span><span class="p">:</span> <span class="n">trade_size_usd</span><span class="p">,</span>
            <span class="s1">&#39;mev_risk&#39;</span><span class="p">:</span> <span class="s1">&#39;HIGH&#39;</span> <span class="k">if</span> <span class="n">sandwich</span><span class="p">[</span><span class="s1">&#39;likely_target&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;LOW&#39;</span><span class="p">,</span>
            <span class="s1">&#39;recommendations&#39;</span><span class="p">:</span> <span class="n">recommendations</span>
        <span class="p">}</span>

<span class="n">mev</span> <span class="o">=</span> <span class="n">MEVProtection</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">mev</span><span class="o">.</span><span class="n">recommend_protection</span><span class="p">(</span><span class="mi">50000</span><span class="p">,</span> <span class="mi">10_000_000</span><span class="p">))</span>
</code></pre></div>
<div class="md-cell"><h3>âœï¸ Exercise 13.3: MEV Analysis Tool</h3>
<p>Build a tool to analyze MEV risk for trades.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="c1"># Exercise 13.3</span>
<span class="k">class</span> <span class="nc">MEVAnalyzer</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">historical_attacks</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">def</span> <span class="nf">analyze_trade</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trade_size</span><span class="p">,</span> <span class="n">pool_liquidity</span><span class="p">,</span> <span class="n">current_gas_gwei</span><span class="p">):</span>
        <span class="c1"># TODO: Comprehensive MEV risk analysis</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">optimal_execution_strategy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trade_size</span><span class="p">,</span> <span class="n">urgency</span><span class="o">=</span><span class="s1">&#39;medium&#39;</span><span class="p">):</span>
        <span class="c1"># TODO: Recommend best execution approach</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">estimate_mev_cost</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trade_size</span><span class="p">,</span> <span class="n">pool_liquidity</span><span class="p">):</span>
        <span class="c1"># TODO: Estimate how much MEV could cost you</span>
        <span class="k">pass</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">MEVAnalyzer</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">historical_attacks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">avg_gas_for_sandwich</span> <span class="o">=</span> <span class="mi">300000</span>  <span class="c1"># Gas units</span>

    <span class="k">def</span> <span class="nf">analyze_trade</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trade_size</span><span class="p">,</span> <span class="n">pool_liquidity</span><span class="p">,</span> <span class="n">current_gas_gwei</span><span class="p">):</span>
        <span class="c1"># Calculate sandwich profitability for attacker</span>
        <span class="n">price_impact</span> <span class="o">=</span> <span class="n">trade_size</span> <span class="o">/</span> <span class="n">pool_liquidity</span>
        <span class="n">potential_profit</span> <span class="o">=</span> <span class="n">trade_size</span> <span class="o">*</span> <span class="n">price_impact</span> <span class="o">*</span> <span class="mf">0.4</span>

        <span class="c1"># Gas cost for sandwich (2 transactions)</span>
        <span class="n">gas_cost_eth</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">avg_gas_for_sandwich</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">current_gas_gwei</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1e9</span>
        <span class="n">gas_cost_usd</span> <span class="o">=</span> <span class="n">gas_cost_eth</span> <span class="o">*</span> <span class="mi">2000</span>  <span class="c1"># Assume ETH = $2000</span>

        <span class="n">net_profit</span> <span class="o">=</span> <span class="n">potential_profit</span> <span class="o">-</span> <span class="n">gas_cost_usd</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;trade_size&#39;</span><span class="p">:</span> <span class="n">trade_size</span><span class="p">,</span>
            <span class="s1">&#39;price_impact_pct&#39;</span><span class="p">:</span> <span class="n">price_impact</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
            <span class="s1">&#39;potential_mev_profit&#39;</span><span class="p">:</span> <span class="n">potential_profit</span><span class="p">,</span>
            <span class="s1">&#39;attacker_gas_cost&#39;</span><span class="p">:</span> <span class="n">gas_cost_usd</span><span class="p">,</span>
            <span class="s1">&#39;net_attacker_profit&#39;</span><span class="p">:</span> <span class="n">net_profit</span><span class="p">,</span>
            <span class="s1">&#39;risk_level&#39;</span><span class="p">:</span> <span class="s1">&#39;HIGH&#39;</span> <span class="k">if</span> <span class="n">net_profit</span> <span class="o">&gt;</span> <span class="mi">100</span> <span class="k">else</span> <span class="s1">&#39;MEDIUM&#39;</span> <span class="k">if</span> <span class="n">net_profit</span> <span class="o">&gt;</span> <span class="mi">20</span> <span class="k">else</span> <span class="s1">&#39;LOW&#39;</span><span class="p">,</span>
            <span class="s1">&#39;recommendation&#39;</span><span class="p">:</span> <span class="s1">&#39;Use private mempool&#39;</span> <span class="k">if</span> <span class="n">net_profit</span> <span class="o">&gt;</span> <span class="mi">100</span> <span class="k">else</span> <span class="s1">&#39;Standard slippage OK&#39;</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">optimal_execution_strategy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trade_size</span><span class="p">,</span> <span class="n">urgency</span><span class="o">=</span><span class="s1">&#39;medium&#39;</span><span class="p">):</span>
        <span class="n">strategies</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">trade_size</span> <span class="o">&gt;</span> <span class="mi">100000</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">urgency</span> <span class="o">==</span> <span class="s1">&#39;low&#39;</span><span class="p">:</span>
                <span class="n">strategies</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;TWAP&#39;</span><span class="p">,</span> <span class="s1">&#39;Split into 10 orders over 1 hour&#39;</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">strategies</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;Flashbots&#39;</span><span class="p">,</span> <span class="s1">&#39;Private mempool submission&#39;</span><span class="p">))</span>
                <span class="n">strategies</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;Aggregator&#39;</span><span class="p">,</span> <span class="s1">&#39;Use 1inch/Paraswap for best routing&#39;</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">trade_size</span> <span class="o">&gt;</span> <span class="mi">10000</span><span class="p">:</span>
            <span class="n">strategies</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;Low slippage&#39;</span><span class="p">,</span> <span class="s1">&#39;Use 0.3</span><span class="si">% s</span><span class="s1">lippage&#39;</span><span class="p">))</span>
            <span class="n">strategies</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;Aggregator&#39;</span><span class="p">,</span> <span class="s1">&#39;Compare prices across DEXs&#39;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">strategies</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;Standard&#39;</span><span class="p">,</span> <span class="s1">&#39;Direct swap with 0.5</span><span class="si">% s</span><span class="s1">lippage&#39;</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">strategies</span>

    <span class="k">def</span> <span class="nf">estimate_mev_cost</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trade_size</span><span class="p">,</span> <span class="n">pool_liquidity</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Estimate expected MEV cost (worst case).&quot;&quot;&quot;</span>
        <span class="n">price_impact</span> <span class="o">=</span> <span class="n">trade_size</span> <span class="o">/</span> <span class="n">pool_liquidity</span>

        <span class="c1"># Attacker can capture ~30-50% of price impact</span>
        <span class="n">expected_loss</span> <span class="o">=</span> <span class="n">trade_size</span> <span class="o">*</span> <span class="n">price_impact</span> <span class="o">*</span> <span class="mf">0.4</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;expected_mev_loss&#39;</span><span class="p">:</span> <span class="n">expected_loss</span><span class="p">,</span>
            <span class="s1">&#39;as_percentage&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">expected_loss</span> <span class="o">/</span> <span class="n">trade_size</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
            <span class="s1">&#39;tip&#39;</span><span class="p">:</span> <span class="s1">&#39;Use private mempool to avoid this&#39;</span>
        <span class="p">}</span>

<span class="n">analyzer</span> <span class="o">=</span> <span class="n">MEVAnalyzer</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">analyzer</span><span class="o">.</span><span class="n">analyze_trade</span><span class="p">(</span><span class="mi">50000</span><span class="p">,</span> <span class="mi">5_000_000</span><span class="p">,</span> <span class="mi">30</span><span class="p">))</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>Section 4: DEX Aggregators</h1></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="kn">import</span> <span class="nn">requests</span>

<span class="k">class</span> <span class="nc">OneInchAPI</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Interface with 1inch DEX aggregator.&quot;&quot;&quot;</span>
    
    <span class="n">BASE_URL</span> <span class="o">=</span> <span class="s1">&#39;https://api.1inch.dev/swap/v5.2/1&#39;</span>  <span class="c1"># Ethereum mainnet</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">api_key</span> <span class="o">=</span> <span class="n">api_key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Authorization&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Bearer </span><span class="si">{</span><span class="n">api_key</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">}</span> <span class="k">if</span> <span class="n">api_key</span> <span class="k">else</span> <span class="p">{}</span>
    
    <span class="k">def</span> <span class="nf">get_quote</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">from_token</span><span class="p">,</span> <span class="n">to_token</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get quote from 1inch.</span>
<span class="sd">        </span>
<span class="sd">        amount: in smallest unit (wei for ETH)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;fromTokenAddress&#39;</span><span class="p">:</span> <span class="n">from_token</span><span class="p">,</span>
            <span class="s1">&#39;toTokenAddress&#39;</span><span class="p">:</span> <span class="n">to_token</span><span class="p">,</span>
            <span class="s1">&#39;amount&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">amount</span><span class="p">)</span>
        <span class="p">}</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">BASE_URL</span><span class="si">}</span><span class="s1">/quote&#39;</span><span class="p">,</span>
                <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span>
                <span class="n">headers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">headers</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
                <span class="k">return</span> <span class="p">{</span>
                    <span class="s1">&#39;from_token&#39;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fromToken&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;symbol&#39;</span><span class="p">),</span>
                    <span class="s1">&#39;to_token&#39;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;toToken&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;symbol&#39;</span><span class="p">),</span>
                    <span class="s1">&#39;from_amount&#39;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fromTokenAmount&#39;</span><span class="p">),</span>
                    <span class="s1">&#39;to_amount&#39;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;toTokenAmount&#39;</span><span class="p">),</span>
                    <span class="s1">&#39;protocols&#39;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;protocols&#39;</span><span class="p">,</span> <span class="p">[])</span>
                <span class="p">}</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Status </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">}</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>
    
    <span class="k">def</span> <span class="nf">get_swap_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">from_token</span><span class="p">,</span> <span class="n">to_token</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">from_address</span><span class="p">,</span> <span class="n">slippage</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get swap transaction data.&quot;&quot;&quot;</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;fromTokenAddress&#39;</span><span class="p">:</span> <span class="n">from_token</span><span class="p">,</span>
            <span class="s1">&#39;toTokenAddress&#39;</span><span class="p">:</span> <span class="n">to_token</span><span class="p">,</span>
            <span class="s1">&#39;amount&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">amount</span><span class="p">),</span>
            <span class="s1">&#39;fromAddress&#39;</span><span class="p">:</span> <span class="n">from_address</span><span class="p">,</span>
            <span class="s1">&#39;slippage&#39;</span><span class="p">:</span> <span class="n">slippage</span>
        <span class="p">}</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">BASE_URL</span><span class="si">}</span><span class="s1">/swap&#39;</span><span class="p">,</span>
                <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span>
                <span class="n">headers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">headers</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Status </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">}</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>
</code></pre></div>
<div class="md-cell"><h3>âœï¸ Exercise 13.4: Aggregator Comparison</h3>
<p>Build a tool to compare multiple aggregators.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="c1"># Exercise 13.4</span>
<span class="k">class</span> <span class="nc">AggregatorComparison</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aggregators</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="k">def</span> <span class="nf">add_aggregator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">api_class</span><span class="p">):</span>
        <span class="c1"># TODO</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">compare_quotes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">from_token</span><span class="p">,</span> <span class="n">to_token</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
        <span class="c1"># TODO: Get quotes from all aggregators</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">find_best_route</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">from_token</span><span class="p">,</span> <span class="n">to_token</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
        <span class="c1"># TODO: Return best aggregator and route</span>
        <span class="k">pass</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">AggregatorComparison</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aggregators</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">add_aggregator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">api_instance</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aggregators</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">api_instance</span>

    <span class="k">def</span> <span class="nf">compare_quotes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">from_token</span><span class="p">,</span> <span class="n">to_token</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">api</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">aggregators</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">quote</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_quote</span><span class="p">(</span><span class="n">from_token</span><span class="p">,</span> <span class="n">to_token</span><span class="p">,</span> <span class="n">amount</span><span class="p">)</span>
                <span class="k">if</span> <span class="s1">&#39;error&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">quote</span><span class="p">:</span>
                    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                        <span class="s1">&#39;aggregator&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                        <span class="s1">&#39;to_amount&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">quote</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;to_amount&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)),</span>
                        <span class="s1">&#39;protocols&#39;</span><span class="p">:</span> <span class="n">quote</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;protocols&#39;</span><span class="p">,</span> <span class="p">[])</span>
                    <span class="p">})</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                        <span class="s1">&#39;aggregator&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                        <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="n">quote</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">]</span>
                    <span class="p">})</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;aggregator&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)})</span>

        <span class="c1"># Sort by output amount</span>
        <span class="n">valid</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span> <span class="k">if</span> <span class="s1">&#39;to_amount&#39;</span> <span class="ow">in</span> <span class="n">r</span><span class="p">]</span>
        <span class="n">valid</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;to_amount&#39;</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;all_quotes&#39;</span><span class="p">:</span> <span class="n">results</span><span class="p">,</span>
            <span class="s1">&#39;ranked&#39;</span><span class="p">:</span> <span class="n">valid</span><span class="p">,</span>
            <span class="s1">&#39;best&#39;</span><span class="p">:</span> <span class="n">valid</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">valid</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">find_best_route</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">from_token</span><span class="p">,</span> <span class="n">to_token</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
        <span class="n">comparison</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compare_quotes</span><span class="p">(</span><span class="n">from_token</span><span class="p">,</span> <span class="n">to_token</span><span class="p">,</span> <span class="n">amount</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">comparison</span><span class="p">[</span><span class="s1">&#39;best&#39;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;No valid quotes&#39;</span><span class="p">}</span>

        <span class="n">best</span> <span class="o">=</span> <span class="n">comparison</span><span class="p">[</span><span class="s1">&#39;best&#39;</span><span class="p">]</span>

        <span class="c1"># Calculate savings vs worst</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">comparison</span><span class="p">[</span><span class="s1">&#39;ranked&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">worst</span> <span class="o">=</span> <span class="n">comparison</span><span class="p">[</span><span class="s1">&#39;ranked&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">savings</span> <span class="o">=</span> <span class="n">best</span><span class="p">[</span><span class="s1">&#39;to_amount&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">worst</span><span class="p">[</span><span class="s1">&#39;to_amount&#39;</span><span class="p">]</span>
            <span class="n">savings_pct</span> <span class="o">=</span> <span class="n">savings</span> <span class="o">/</span> <span class="n">worst</span><span class="p">[</span><span class="s1">&#39;to_amount&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">savings</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">savings_pct</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;best_aggregator&#39;</span><span class="p">:</span> <span class="n">best</span><span class="p">[</span><span class="s1">&#39;aggregator&#39;</span><span class="p">],</span>
            <span class="s1">&#39;output_amount&#39;</span><span class="p">:</span> <span class="n">best</span><span class="p">[</span><span class="s1">&#39;to_amount&#39;</span><span class="p">],</span>
            <span class="s1">&#39;savings_vs_worst&#39;</span><span class="p">:</span> <span class="n">savings</span><span class="p">,</span>
            <span class="s1">&#39;savings_pct&#39;</span><span class="p">:</span> <span class="n">savings_pct</span><span class="p">,</span>
            <span class="s1">&#39;routing&#39;</span><span class="p">:</span> <span class="n">best</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;protocols&#39;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="p">}</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>ğŸ—ï¸ Module Project: DEX Trading Bot</h1>
<p>Build a complete DEX trading bot with all safety features.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="c1"># Module Project</span>
<span class="k">class</span> <span class="nc">DEXTradingBot</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">w3</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w3</span> <span class="o">=</span> <span class="n">w3</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">quoter</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">executor</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mev_analyzer</span> <span class="o">=</span> <span class="kc">None</span>
    
    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># TODO: Set up all components</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">analyze_trade</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token_in</span><span class="p">,</span> <span class="n">token_out</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
        <span class="c1"># TODO: Full trade analysis</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">execute_safe_swap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token_in</span><span class="p">,</span> <span class="n">token_out</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">max_slippage</span><span class="p">):</span>
        <span class="c1"># TODO: Execute with all protections</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">get_best_execution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token_in</span><span class="p">,</span> <span class="n">token_out</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
        <span class="c1"># TODO: Find best execution path</span>
        <span class="k">pass</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">DEXTradingBot</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">w3</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w3</span> <span class="o">=</span> <span class="n">w3</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">quoter</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">executor</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mev_analyzer</span> <span class="o">=</span> <span class="n">MEVAnalyzer</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slippage</span> <span class="o">=</span> <span class="n">SlippageProtection</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;default_slippage&#39;</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">quoter</span> <span class="o">=</span> <span class="n">UniswapQuoter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">w3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">executor</span> <span class="o">=</span> <span class="n">SafeDEXExecutor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">w3</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;router_address&#39;</span><span class="p">))</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">analyze_trade</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token_in</span><span class="p">,</span> <span class="n">token_out</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
        <span class="c1"># Get quote</span>
        <span class="n">quote</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">quoter</span><span class="o">.</span><span class="n">get_quote</span><span class="p">(</span><span class="n">token_in</span><span class="p">,</span> <span class="n">token_out</span><span class="p">,</span> <span class="n">amount</span><span class="p">)</span>

        <span class="c1"># Get price impact</span>
        <span class="n">impact</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">quoter</span><span class="o">.</span><span class="n">get_price_impact</span><span class="p">(</span><span class="n">token_in</span><span class="p">,</span> <span class="n">token_out</span><span class="p">,</span> <span class="n">amount</span><span class="p">)</span>

        <span class="c1"># MEV analysis</span>
        <span class="n">gas_price</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">w3</span><span class="o">.</span><span class="n">from_wei</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">gas_price</span><span class="p">,</span> <span class="s1">&#39;gwei&#39;</span><span class="p">))</span>
        <span class="n">mev</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mev_analyzer</span><span class="o">.</span><span class="n">analyze_trade</span><span class="p">(</span><span class="n">amount</span> <span class="o">*</span> <span class="mi">2000</span><span class="p">,</span> <span class="mi">10_000_000</span><span class="p">,</span> <span class="n">gas_price</span><span class="p">)</span>  <span class="c1"># Assume $2k price</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;quote&#39;</span><span class="p">:</span> <span class="n">quote</span><span class="p">,</span>
            <span class="s1">&#39;price_impact&#39;</span><span class="p">:</span> <span class="n">impact</span><span class="p">,</span>
            <span class="s1">&#39;mev_risk&#39;</span><span class="p">:</span> <span class="n">mev</span><span class="p">[</span><span class="s1">&#39;risk_level&#39;</span><span class="p">],</span>
            <span class="s1">&#39;mev_recommendation&#39;</span><span class="p">:</span> <span class="n">mev</span><span class="p">[</span><span class="s1">&#39;recommendation&#39;</span><span class="p">],</span>
            <span class="s1">&#39;recommended_slippage&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">slippage</span><span class="o">.</span><span class="n">recommend_slippage</span><span class="p">(</span><span class="s1">&#39;pair&#39;</span><span class="p">,</span> <span class="n">amount</span> <span class="o">*</span> <span class="mi">2000</span><span class="p">,</span> <span class="mi">10_000_000</span><span class="p">)</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">execute_safe_swap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token_in</span><span class="p">,</span> <span class="n">token_out</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">max_slippage</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># Analyze first</span>
        <span class="n">analysis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_trade</span><span class="p">(</span><span class="n">token_in</span><span class="p">,</span> <span class="n">token_out</span><span class="p">,</span> <span class="n">amount</span><span class="p">)</span>

        <span class="c1"># Use recommended slippage if not specified</span>
        <span class="n">slippage</span> <span class="o">=</span> <span class="n">max_slippage</span> <span class="ow">or</span> <span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;recommended_slippage&#39;</span><span class="p">]</span>

        <span class="c1"># Check MEV risk</span>
        <span class="k">if</span> <span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;mev_risk&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;HIGH&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;High MEV risk - use private mempool&#39;</span><span class="p">,</span>
                <span class="s1">&#39;analysis&#39;</span><span class="p">:</span> <span class="n">analysis</span>
            <span class="p">}</span>

        <span class="c1"># Execute</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">executor</span><span class="o">.</span><span class="n">execute_with_checks</span><span class="p">(</span><span class="n">token_in</span><span class="p">,</span> <span class="n">token_out</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">slippage</span><span class="p">)</span>
        <span class="n">result</span><span class="p">[</span><span class="s1">&#39;analysis&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">analysis</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">get_best_execution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token_in</span><span class="p">,</span> <span class="n">token_out</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
        <span class="n">analysis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_trade</span><span class="p">(</span><span class="n">token_in</span><span class="p">,</span> <span class="n">token_out</span><span class="p">,</span> <span class="n">amount</span><span class="p">)</span>
        <span class="n">strategy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mev_analyzer</span><span class="o">.</span><span class="n">optimal_execution_strategy</span><span class="p">(</span><span class="n">amount</span> <span class="o">*</span> <span class="mi">2000</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;analysis&#39;</span><span class="p">:</span> <span class="n">analysis</span><span class="p">,</span>
            <span class="s1">&#39;recommended_strategy&#39;</span><span class="p">:</span> <span class="n">strategy</span><span class="p">,</span>
            <span class="s1">&#39;total_cost_estimate&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;slippage_cost&#39;</span><span class="p">:</span> <span class="n">amount</span> <span class="o">*</span> <span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;price_impact&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">100</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;price_impact&#39;</span><span class="p">],</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">))</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s1">&#39;potential_mev_cost&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">mev_analyzer</span><span class="o">.</span><span class="n">estimate_mev_cost</span><span class="p">(</span><span class="n">amount</span> <span class="o">*</span> <span class="mi">2000</span><span class="p">,</span> <span class="mi">10_000_000</span><span class="p">)[</span><span class="s1">&#39;expected_mev_loss&#39;</span><span class="p">]</span>
            <span class="p">}</span>
        <span class="p">}</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>ğŸ“ Key Takeaways</h1>
<ol>
<li><strong>Uniswap Integration</strong>: Get quotes, calculate price impact, build swaps</li>
<li><strong>Slippage Protection</strong>: Always set appropriate slippage based on trade size</li>
<li><strong>MEV Awareness</strong>: Large trades are targets - use private mempools</li>
<li><strong>Aggregators</strong>: Compare across DEXs for best execution</li>
</ol>
<hr />
<p><em>Next: Module 14 - Advanced DeFi Strategies</em></p></div>
        <div class="nav-buttons">
            <button class="nav-btn prev-btn disabled" type="button">
                <span class="nav-btn-label">â† Previous</span>
                <span class="nav-btn-name"></span>
            </button>
            <button class="nav-btn next-btn disabled" type="button">
                <span class="nav-btn-label">Next â†’</span>
                <span class="nav-btn-name"></span>
            </button>
        </div>
        </div>
<div class="module-section" data-idx="14"><div class="md-cell module-header"><h1>Module 14: Advanced DeFi Strategies</h1>
<h2>Part 4: DeFi &amp; Advanced Topics</h2>
<hr />
<div class="table-wrapper"><table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>â±ï¸ <strong>Duration</strong></td>
<td>~2.5 hours</td>
</tr>
<tr>
<td>ğŸ“‹ <strong>Prerequisites</strong></td>
<td>Module 13</td>
</tr>
<tr>
<td>ğŸ’ª <strong>Exercises</strong></td>
<td>5 total</td>
</tr>
</tbody>
</table></div></div>
<div class="md-cell"><h2>ğŸ¯ Learning Objectives</h2>
<ul>
<li>Identify and execute arbitrage opportunities</li>
<li>Analyze liquidity provision strategies</li>
<li>Evaluate yield farming opportunities</li>
<li>Understand flash loan mechanics</li>
</ul></div>
<div class="md-cell"><hr />
<h1>Section 1: Arbitrage Opportunities</h1>
<h2>1.1 CEX-DEX Arbitrage</h2></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">CEXDEXArbitrage</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Find arbitrage between centralized and decentralized exchanges.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cex_api</span><span class="p">,</span> <span class="n">dex_quoter</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cex</span> <span class="o">=</span> <span class="n">cex_api</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dex</span> <span class="o">=</span> <span class="n">dex_quoter</span>
    
    <span class="k">def</span> <span class="nf">get_prices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">dex_tokens</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get prices from both CEX and DEX.&quot;&quot;&quot;</span>
        <span class="c1"># CEX price</span>
        <span class="n">cex_ticker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cex</span><span class="o">.</span><span class="n">fetch_ticker</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
        <span class="n">cex_price</span> <span class="o">=</span> <span class="n">cex_ticker</span><span class="p">[</span><span class="s1">&#39;last&#39;</span><span class="p">]</span>
        <span class="n">cex_bid</span> <span class="o">=</span> <span class="n">cex_ticker</span><span class="p">[</span><span class="s1">&#39;bid&#39;</span><span class="p">]</span>
        <span class="n">cex_ask</span> <span class="o">=</span> <span class="n">cex_ticker</span><span class="p">[</span><span class="s1">&#39;ask&#39;</span><span class="p">]</span>
        
        <span class="c1"># DEX price (1 unit)</span>
        <span class="n">dex_quote</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dex</span><span class="o">.</span><span class="n">get_quote</span><span class="p">(</span>
            <span class="n">dex_tokens</span><span class="p">[</span><span class="s1">&#39;base&#39;</span><span class="p">],</span>
            <span class="n">dex_tokens</span><span class="p">[</span><span class="s1">&#39;quote&#39;</span><span class="p">],</span>
            <span class="mi">1</span>
        <span class="p">)</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;cex&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="n">cex_price</span><span class="p">,</span> <span class="s1">&#39;bid&#39;</span><span class="p">:</span> <span class="n">cex_bid</span><span class="p">,</span> <span class="s1">&#39;ask&#39;</span><span class="p">:</span> <span class="n">cex_ask</span><span class="p">},</span>
            <span class="s1">&#39;dex&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="n">dex_quote</span><span class="p">}</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">calculate_arbitrage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prices</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">fees</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate arbitrage opportunity.</span>
<span class="sd">        </span>
<span class="sd">        fees: dict with &#39;cex_fee&#39;, &#39;dex_fee&#39;, &#39;gas_cost_usd&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cex_price</span> <span class="o">=</span> <span class="n">prices</span><span class="p">[</span><span class="s1">&#39;cex&#39;</span><span class="p">][</span><span class="s1">&#39;price&#39;</span><span class="p">]</span>
        <span class="n">dex_price</span> <span class="o">=</span> <span class="n">prices</span><span class="p">[</span><span class="s1">&#39;dex&#39;</span><span class="p">][</span><span class="s1">&#39;price&#39;</span><span class="p">]</span>
        
        <span class="n">spread_pct</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">cex_price</span> <span class="o">-</span> <span class="n">dex_price</span><span class="p">)</span> <span class="o">/</span> <span class="nb">min</span><span class="p">(</span><span class="n">cex_price</span><span class="p">,</span> <span class="n">dex_price</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
        
        <span class="c1"># Calculate profit for each direction</span>
        <span class="k">if</span> <span class="n">cex_price</span> <span class="o">&gt;</span> <span class="n">dex_price</span><span class="p">:</span>
            <span class="c1"># Buy on DEX, sell on CEX</span>
            <span class="n">direction</span> <span class="o">=</span> <span class="s1">&#39;DEX -&gt; CEX&#39;</span>
            <span class="n">buy_cost</span> <span class="o">=</span> <span class="n">amount</span> <span class="o">*</span> <span class="n">dex_price</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">fees</span><span class="p">[</span><span class="s1">&#39;dex_fee&#39;</span><span class="p">])</span>
            <span class="n">sell_revenue</span> <span class="o">=</span> <span class="n">amount</span> <span class="o">*</span> <span class="n">prices</span><span class="p">[</span><span class="s1">&#39;cex&#39;</span><span class="p">][</span><span class="s1">&#39;bid&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">fees</span><span class="p">[</span><span class="s1">&#39;cex_fee&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Buy on CEX, sell on DEX</span>
            <span class="n">direction</span> <span class="o">=</span> <span class="s1">&#39;CEX -&gt; DEX&#39;</span>
            <span class="n">buy_cost</span> <span class="o">=</span> <span class="n">amount</span> <span class="o">*</span> <span class="n">prices</span><span class="p">[</span><span class="s1">&#39;cex&#39;</span><span class="p">][</span><span class="s1">&#39;ask&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">fees</span><span class="p">[</span><span class="s1">&#39;cex_fee&#39;</span><span class="p">])</span>
            <span class="n">sell_revenue</span> <span class="o">=</span> <span class="n">amount</span> <span class="o">*</span> <span class="n">dex_price</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">fees</span><span class="p">[</span><span class="s1">&#39;dex_fee&#39;</span><span class="p">])</span>
        
        <span class="n">gross_profit</span> <span class="o">=</span> <span class="n">sell_revenue</span> <span class="o">-</span> <span class="n">buy_cost</span>
        <span class="n">net_profit</span> <span class="o">=</span> <span class="n">gross_profit</span> <span class="o">-</span> <span class="n">fees</span><span class="p">[</span><span class="s1">&#39;gas_cost_usd&#39;</span><span class="p">]</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;direction&#39;</span><span class="p">:</span> <span class="n">direction</span><span class="p">,</span>
            <span class="s1">&#39;spread_pct&#39;</span><span class="p">:</span> <span class="n">spread_pct</span><span class="p">,</span>
            <span class="s1">&#39;gross_profit&#39;</span><span class="p">:</span> <span class="n">gross_profit</span><span class="p">,</span>
            <span class="s1">&#39;net_profit&#39;</span><span class="p">:</span> <span class="n">net_profit</span><span class="p">,</span>
            <span class="s1">&#39;profitable&#39;</span><span class="p">:</span> <span class="n">net_profit</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="p">}</span>
</code></pre></div>
<div class="md-cell"><h2>1.2 DEX-DEX Arbitrage</h2></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">DEXArbitrageFinder</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Find arbitrage between different DEXs.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dexes</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="k">def</span> <span class="nf">add_dex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">quoter</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dexes</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">quoter</span>
    
    <span class="k">def</span> <span class="nf">find_arbitrage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token_a</span><span class="p">,</span> <span class="n">token_b</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Find best arbitrage across DEXs.&quot;&quot;&quot;</span>
        <span class="n">quotes</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">quoter</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dexes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">quote</span> <span class="o">=</span> <span class="n">quoter</span><span class="o">.</span><span class="n">get_quote</span><span class="p">(</span><span class="n">token_a</span><span class="p">,</span> <span class="n">token_b</span><span class="p">,</span> <span class="n">amount</span><span class="p">)</span>
                <span class="n">quotes</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">quote</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">continue</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">quotes</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Need at least 2 DEXs&#39;</span><span class="p">}</span>
        
        <span class="c1"># Find best buy and sell</span>
        <span class="n">best_buy</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">quotes</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># Lowest price to buy</span>
        <span class="n">best_sell</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">quotes</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># Highest price to sell</span>
        
        <span class="n">spread</span> <span class="o">=</span> <span class="p">(</span><span class="n">best_sell</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">best_buy</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="n">best_buy</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;buy_on&#39;</span><span class="p">:</span> <span class="n">best_buy</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="s1">&#39;buy_price&#39;</span><span class="p">:</span> <span class="n">best_buy</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="s1">&#39;sell_on&#39;</span><span class="p">:</span> <span class="n">best_sell</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="s1">&#39;sell_price&#39;</span><span class="p">:</span> <span class="n">best_sell</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="s1">&#39;spread_pct&#39;</span><span class="p">:</span> <span class="n">spread</span><span class="p">,</span>
            <span class="s1">&#39;profitable&#39;</span><span class="p">:</span> <span class="n">spread</span> <span class="o">&gt;</span> <span class="mf">0.6</span>  <span class="c1"># Need &gt;0.6% to cover fees</span>
        <span class="p">}</span>
</code></pre></div>
<div class="md-cell"><h2>1.3 Triangular Arbitrage</h2></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">TriangularArbitrage</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Find triangular arbitrage opportunities.</span>
<span class="sd">    </span>
<span class="sd">    Example: USDC -&gt; ETH -&gt; BTC -&gt; USDC</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">quoter</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">quoter</span> <span class="o">=</span> <span class="n">quoter</span>
    
    <span class="k">def</span> <span class="nf">calculate_triangular</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">initial_amount</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate return for triangular path.</span>
<span class="sd">        </span>
<span class="sd">        path: list of 3 tokens, e.g., [&#39;USDC&#39;, &#39;ETH&#39;, &#39;BTC&#39;]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Path must have exactly 3 tokens&#39;</span><span class="p">}</span>
        
        <span class="c1"># Trade 1: A -&gt; B</span>
        <span class="n">amount_b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">quoter</span><span class="o">.</span><span class="n">get_quote</span><span class="p">(</span><span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">path</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">initial_amount</span><span class="p">)</span>
        
        <span class="c1"># Trade 2: B -&gt; C</span>
        <span class="n">amount_c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">quoter</span><span class="o">.</span><span class="n">get_quote</span><span class="p">(</span><span class="n">path</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">path</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">amount_b</span><span class="p">)</span>
        
        <span class="c1"># Trade 3: C -&gt; A (back to start)</span>
        <span class="n">final_amount</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">quoter</span><span class="o">.</span><span class="n">get_quote</span><span class="p">(</span><span class="n">path</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">amount_c</span><span class="p">)</span>
        
        <span class="n">profit</span> <span class="o">=</span> <span class="n">final_amount</span> <span class="o">-</span> <span class="n">initial_amount</span>
        <span class="n">profit_pct</span> <span class="o">=</span> <span class="p">(</span><span class="n">profit</span> <span class="o">/</span> <span class="n">initial_amount</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="s1">&#39; -&gt; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39; -&gt; </span><span class="si">{</span><span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="s1">&#39;initial&#39;</span><span class="p">:</span> <span class="n">initial_amount</span><span class="p">,</span>
            <span class="s1">&#39;final&#39;</span><span class="p">:</span> <span class="n">final_amount</span><span class="p">,</span>
            <span class="s1">&#39;profit&#39;</span><span class="p">:</span> <span class="n">profit</span><span class="p">,</span>
            <span class="s1">&#39;profit_pct&#39;</span><span class="p">:</span> <span class="n">profit_pct</span><span class="p">,</span>
            <span class="s1">&#39;profitable&#39;</span><span class="p">:</span> <span class="n">profit_pct</span> <span class="o">&gt;</span> <span class="mf">0.3</span>  <span class="c1"># Need &gt;0.3% after 3 trades</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">scan_all_paths</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tokens</span><span class="p">,</span> <span class="n">initial_amount</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Scan all possible triangular paths.&quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">permutations</span>
        
        <span class="n">opportunities</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">permutations</span><span class="p">(</span><span class="n">tokens</span><span class="p">,</span> <span class="mi">3</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_triangular</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">path</span><span class="p">),</span> <span class="n">initial_amount</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;profitable&#39;</span><span class="p">):</span>
                    <span class="n">opportunities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">continue</span>
        
        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">opportunities</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;profit_pct&#39;</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h3>âœï¸ Exercise 14.1: Arbitrage Finder</h3>
<p>Build a comprehensive arbitrage detection system.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="c1"># Exercise 14.1</span>
<span class="k">class</span> <span class="nc">ArbitrageScanner</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">opportunities</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">def</span> <span class="nf">scan_cex_dex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pairs</span><span class="p">,</span> <span class="n">cex</span><span class="p">,</span> <span class="n">dex</span><span class="p">):</span>
        <span class="c1"># TODO: Scan for CEX-DEX arbitrage</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">scan_dex_dex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pairs</span><span class="p">,</span> <span class="n">dexes</span><span class="p">):</span>
        <span class="c1"># TODO: Scan for DEX-DEX arbitrage</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">estimate_execution_cost</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">opportunity</span><span class="p">):</span>
        <span class="c1"># TODO: Calculate total cost including gas</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">get_actionable_opportunities</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">min_profit_usd</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
        <span class="c1"># TODO: Filter for profitable opportunities</span>
        <span class="k">pass</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">ArbitrageScanner</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gas_price_gwei</span><span class="o">=</span><span class="mi">30</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">opportunities</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gas_price_gwei</span> <span class="o">=</span> <span class="n">gas_price_gwei</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eth_price</span> <span class="o">=</span> <span class="mi">2000</span>  <span class="c1"># Update dynamically</span>

    <span class="k">def</span> <span class="nf">scan_cex_dex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pairs</span><span class="p">,</span> <span class="n">cex</span><span class="p">,</span> <span class="n">dex</span><span class="p">):</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">pairs</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">cex_ticker</span> <span class="o">=</span> <span class="n">cex</span><span class="o">.</span><span class="n">fetch_ticker</span><span class="p">(</span><span class="n">pair</span><span class="p">[</span><span class="s1">&#39;cex_symbol&#39;</span><span class="p">])</span>
                <span class="n">dex_quote</span> <span class="o">=</span> <span class="n">dex</span><span class="o">.</span><span class="n">get_quote</span><span class="p">(</span><span class="n">pair</span><span class="p">[</span><span class="s1">&#39;dex_base&#39;</span><span class="p">],</span> <span class="n">pair</span><span class="p">[</span><span class="s1">&#39;dex_quote&#39;</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>

                <span class="n">spread</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">cex_ticker</span><span class="p">[</span><span class="s1">&#39;last&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">dex_quote</span><span class="p">)</span> <span class="o">/</span> <span class="nb">min</span><span class="p">(</span><span class="n">cex_ticker</span><span class="p">[</span><span class="s1">&#39;last&#39;</span><span class="p">],</span> <span class="n">dex_quote</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>

                <span class="k">if</span> <span class="n">spread</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">:</span>  <span class="c1"># Minimum spread threshold</span>
                    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                        <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;CEX-DEX&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;pair&#39;</span><span class="p">:</span> <span class="n">pair</span><span class="p">[</span><span class="s1">&#39;cex_symbol&#39;</span><span class="p">],</span>
                        <span class="s1">&#39;cex_price&#39;</span><span class="p">:</span> <span class="n">cex_ticker</span><span class="p">[</span><span class="s1">&#39;last&#39;</span><span class="p">],</span>
                        <span class="s1">&#39;dex_price&#39;</span><span class="p">:</span> <span class="n">dex_quote</span><span class="p">,</span>
                        <span class="s1">&#39;spread_pct&#39;</span><span class="p">:</span> <span class="n">spread</span>
                    <span class="p">})</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">continue</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">opportunities</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">results</span>

    <span class="k">def</span> <span class="nf">scan_dex_dex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token_pairs</span><span class="p">,</span> <span class="n">dexes</span><span class="p">):</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">token_pairs</span><span class="p">:</span>
            <span class="n">quotes</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">dex_name</span><span class="p">,</span> <span class="n">dex</span> <span class="ow">in</span> <span class="n">dexes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">quotes</span><span class="p">[</span><span class="n">dex_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">dex</span><span class="o">.</span><span class="n">get_quote</span><span class="p">(</span><span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">continue</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">quotes</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">prices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">quotes</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
                <span class="n">spread</span> <span class="o">=</span> <span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="n">prices</span><span class="p">))</span> <span class="o">/</span> <span class="nb">min</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>

                <span class="k">if</span> <span class="n">spread</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">:</span>
                    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                        <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;DEX-DEX&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;pair&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;quotes&#39;</span><span class="p">:</span> <span class="n">quotes</span><span class="p">,</span>
                        <span class="s1">&#39;spread_pct&#39;</span><span class="p">:</span> <span class="n">spread</span>
                    <span class="p">})</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">opportunities</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">results</span>

    <span class="k">def</span> <span class="nf">estimate_execution_cost</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">opportunity</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">opportunity</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;CEX-DEX&#39;</span><span class="p">:</span>
            <span class="n">gas_units</span> <span class="o">=</span> <span class="mi">250000</span>  <span class="c1"># Swap + withdrawal/deposit</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">gas_units</span> <span class="o">=</span> <span class="mi">300000</span>  <span class="c1"># Two swaps</span>

        <span class="n">gas_cost_eth</span> <span class="o">=</span> <span class="p">(</span><span class="n">gas_units</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">gas_price_gwei</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1e9</span>
        <span class="n">gas_cost_usd</span> <span class="o">=</span> <span class="n">gas_cost_eth</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">eth_price</span>

        <span class="k">return</span> <span class="n">gas_cost_usd</span>

    <span class="k">def</span> <span class="nf">get_actionable_opportunities</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">min_profit_usd</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">trade_size_usd</span><span class="o">=</span><span class="mi">10000</span><span class="p">):</span>
        <span class="n">actionable</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">opp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">opportunities</span><span class="p">:</span>
            <span class="n">gas_cost</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">estimate_execution_cost</span><span class="p">(</span><span class="n">opp</span><span class="p">)</span>
            <span class="n">gross_profit</span> <span class="o">=</span> <span class="n">trade_size_usd</span> <span class="o">*</span> <span class="n">opp</span><span class="p">[</span><span class="s1">&#39;spread_pct&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">100</span>
            <span class="n">net_profit</span> <span class="o">=</span> <span class="n">gross_profit</span> <span class="o">-</span> <span class="n">gas_cost</span>

            <span class="k">if</span> <span class="n">net_profit</span> <span class="o">&gt;=</span> <span class="n">min_profit_usd</span><span class="p">:</span>
                <span class="n">opp</span><span class="p">[</span><span class="s1">&#39;gas_cost_usd&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gas_cost</span>
                <span class="n">opp</span><span class="p">[</span><span class="s1">&#39;estimated_profit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">net_profit</span>
                <span class="n">actionable</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">opp</span><span class="p">)</span>

        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">actionable</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;estimated_profit&#39;</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>Section 2: Liquidity Provision</h1></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="kn">import</span> <span class="nn">math</span>

<span class="k">class</span> <span class="nc">LiquidityAnalyzer</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Analyze liquidity provision opportunities.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="nf">calculate_impermanent_loss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">price_ratio</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate IL for a given price change ratio.</span>
<span class="sd">        </span>
<span class="sd">        price_ratio: new_price / old_price (e.g., 2.0 = price doubled)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sqrt_ratio</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">price_ratio</span><span class="p">)</span>
        <span class="n">il</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">sqrt_ratio</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">price_ratio</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">il</span> <span class="o">*</span> <span class="mi">100</span>  <span class="c1"># Return as percentage</span>
    
    <span class="k">def</span> <span class="nf">calculate_lp_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">initial_token_a</span><span class="p">,</span> <span class="n">initial_token_b</span><span class="p">,</span> 
                           <span class="n">initial_price</span><span class="p">,</span> <span class="n">current_price</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate current value of LP position vs holding.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">price_ratio</span> <span class="o">=</span> <span class="n">current_price</span> <span class="o">/</span> <span class="n">initial_price</span>
        
        <span class="c1"># Value if just held</span>
        <span class="n">held_value</span> <span class="o">=</span> <span class="n">initial_token_a</span> <span class="o">*</span> <span class="n">current_price</span> <span class="o">+</span> <span class="n">initial_token_b</span>
        
        <span class="c1"># LP position value (rebalances automatically)</span>
        <span class="n">k</span> <span class="o">=</span> <span class="n">initial_token_a</span> <span class="o">*</span> <span class="n">initial_token_b</span>
        <span class="n">new_token_a</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">k</span> <span class="o">/</span> <span class="n">price_ratio</span><span class="p">)</span>
        <span class="n">new_token_b</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">k</span> <span class="o">*</span> <span class="n">price_ratio</span><span class="p">)</span>
        <span class="n">lp_value</span> <span class="o">=</span> <span class="n">new_token_a</span> <span class="o">*</span> <span class="n">current_price</span> <span class="o">+</span> <span class="n">new_token_b</span>
        
        <span class="n">il_pct</span> <span class="o">=</span> <span class="p">(</span><span class="n">lp_value</span> <span class="o">-</span> <span class="n">held_value</span><span class="p">)</span> <span class="o">/</span> <span class="n">held_value</span> <span class="o">*</span> <span class="mi">100</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;held_value&#39;</span><span class="p">:</span> <span class="n">held_value</span><span class="p">,</span>
            <span class="s1">&#39;lp_value&#39;</span><span class="p">:</span> <span class="n">lp_value</span><span class="p">,</span>
            <span class="s1">&#39;impermanent_loss_pct&#39;</span><span class="p">:</span> <span class="n">il_pct</span><span class="p">,</span>
            <span class="s1">&#39;new_token_a&#39;</span><span class="p">:</span> <span class="n">new_token_a</span><span class="p">,</span>
            <span class="s1">&#39;new_token_b&#39;</span><span class="p">:</span> <span class="n">new_token_b</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">breakeven_apr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expected_price_change_pct</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate APR needed to offset expected IL.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">price_ratio</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">expected_price_change_pct</span> <span class="o">/</span> <span class="mi">100</span>
        <span class="n">il</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calculate_impermanent_loss</span><span class="p">(</span><span class="n">price_ratio</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">il</span>  <span class="c1"># Need at least this APR to break even</span>

<span class="n">analyzer</span> <span class="o">=</span> <span class="n">LiquidityAnalyzer</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;IL for various price changes:&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">change</span> <span class="ow">in</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">]:</span>
    <span class="n">il</span> <span class="o">=</span> <span class="n">analyzer</span><span class="o">.</span><span class="n">calculate_impermanent_loss</span><span class="p">(</span><span class="n">change</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;  </span><span class="si">{</span><span class="n">change</span><span class="si">}</span><span class="s1">x price: </span><span class="si">{</span><span class="n">il</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">% IL&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h3>âœï¸ Exercise 14.2: LP Position Analyzer</h3>
<p>Build a comprehensive LP position analyzer.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="c1"># Exercise 14.2</span>
<span class="k">class</span> <span class="nc">LPPositionAnalyzer</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">positions</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">def</span> <span class="nf">add_position</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pool</span><span class="p">,</span> <span class="n">token_a_amount</span><span class="p">,</span> <span class="n">token_b_amount</span><span class="p">,</span> <span class="n">entry_price</span><span class="p">):</span>
        <span class="c1"># TODO</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">calculate_pnl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">position</span><span class="p">,</span> <span class="n">current_price</span><span class="p">,</span> <span class="n">fees_earned</span><span class="p">):</span>
        <span class="c1"># TODO: Calculate total PnL including fees and IL</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">should_exit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">position</span><span class="p">,</span> <span class="n">current_price</span><span class="p">,</span> <span class="n">fees_earned</span><span class="p">):</span>
        <span class="c1"># TODO: Recommend whether to exit position</span>
        <span class="k">pass</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">LPPositionAnalyzer</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">positions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">analyzer</span> <span class="o">=</span> <span class="n">LiquidityAnalyzer</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">add_position</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pool</span><span class="p">,</span> <span class="n">token_a_amount</span><span class="p">,</span> <span class="n">token_b_amount</span><span class="p">,</span> <span class="n">entry_price</span><span class="p">):</span>
        <span class="n">position</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;pool&#39;</span><span class="p">:</span> <span class="n">pool</span><span class="p">,</span>
            <span class="s1">&#39;token_a_initial&#39;</span><span class="p">:</span> <span class="n">token_a_amount</span><span class="p">,</span>
            <span class="s1">&#39;token_b_initial&#39;</span><span class="p">:</span> <span class="n">token_b_amount</span><span class="p">,</span>
            <span class="s1">&#39;entry_price&#39;</span><span class="p">:</span> <span class="n">entry_price</span><span class="p">,</span>
            <span class="s1">&#39;entry_value&#39;</span><span class="p">:</span> <span class="n">token_a_amount</span> <span class="o">*</span> <span class="n">entry_price</span> <span class="o">+</span> <span class="n">token_b_amount</span><span class="p">,</span>
            <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">position</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">position</span>

    <span class="k">def</span> <span class="nf">calculate_pnl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">position</span><span class="p">,</span> <span class="n">current_price</span><span class="p">,</span> <span class="n">fees_earned</span><span class="p">):</span>
        <span class="c1"># Calculate LP value with IL</span>
        <span class="n">lp_calc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyzer</span><span class="o">.</span><span class="n">calculate_lp_value</span><span class="p">(</span>
            <span class="n">position</span><span class="p">[</span><span class="s1">&#39;token_a_initial&#39;</span><span class="p">],</span>
            <span class="n">position</span><span class="p">[</span><span class="s1">&#39;token_b_initial&#39;</span><span class="p">],</span>
            <span class="n">position</span><span class="p">[</span><span class="s1">&#39;entry_price&#39;</span><span class="p">],</span>
            <span class="n">current_price</span>
        <span class="p">)</span>

        <span class="c1"># Total PnL</span>
        <span class="n">current_value</span> <span class="o">=</span> <span class="n">lp_calc</span><span class="p">[</span><span class="s1">&#39;lp_value&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">fees_earned</span>
        <span class="n">total_pnl</span> <span class="o">=</span> <span class="n">current_value</span> <span class="o">-</span> <span class="n">position</span><span class="p">[</span><span class="s1">&#39;entry_value&#39;</span><span class="p">]</span>
        <span class="n">total_pnl_pct</span> <span class="o">=</span> <span class="n">total_pnl</span> <span class="o">/</span> <span class="n">position</span><span class="p">[</span><span class="s1">&#39;entry_value&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;entry_value&#39;</span><span class="p">:</span> <span class="n">position</span><span class="p">[</span><span class="s1">&#39;entry_value&#39;</span><span class="p">],</span>
            <span class="s1">&#39;lp_value&#39;</span><span class="p">:</span> <span class="n">lp_calc</span><span class="p">[</span><span class="s1">&#39;lp_value&#39;</span><span class="p">],</span>
            <span class="s1">&#39;fees_earned&#39;</span><span class="p">:</span> <span class="n">fees_earned</span><span class="p">,</span>
            <span class="s1">&#39;current_value&#39;</span><span class="p">:</span> <span class="n">current_value</span><span class="p">,</span>
            <span class="s1">&#39;impermanent_loss_pct&#39;</span><span class="p">:</span> <span class="n">lp_calc</span><span class="p">[</span><span class="s1">&#39;impermanent_loss_pct&#39;</span><span class="p">],</span>
            <span class="s1">&#39;total_pnl&#39;</span><span class="p">:</span> <span class="n">total_pnl</span><span class="p">,</span>
            <span class="s1">&#39;total_pnl_pct&#39;</span><span class="p">:</span> <span class="n">total_pnl_pct</span><span class="p">,</span>
            <span class="s1">&#39;fees_offset_il&#39;</span><span class="p">:</span> <span class="n">fees_earned</span> <span class="o">&gt;</span> <span class="nb">abs</span><span class="p">(</span><span class="n">lp_calc</span><span class="p">[</span><span class="s1">&#39;impermanent_loss_pct&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">position</span><span class="p">[</span><span class="s1">&#39;entry_value&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">should_exit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">position</span><span class="p">,</span> <span class="n">current_price</span><span class="p">,</span> <span class="n">fees_earned</span><span class="p">,</span> <span class="n">price_outlook</span><span class="o">=</span><span class="s1">&#39;neutral&#39;</span><span class="p">):</span>
        <span class="n">pnl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_pnl</span><span class="p">(</span><span class="n">position</span><span class="p">,</span> <span class="n">current_price</span><span class="p">,</span> <span class="n">fees_earned</span><span class="p">)</span>

        <span class="n">reasons_to_exit</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">reasons_to_stay</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Check IL</span>
        <span class="k">if</span> <span class="n">pnl</span><span class="p">[</span><span class="s1">&#39;impermanent_loss_pct&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">10</span><span class="p">:</span>
            <span class="n">reasons_to_exit</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;High IL: </span><span class="si">{</span><span class="n">pnl</span><span class="p">[</span><span class="s1">&#39;impermanent_loss_pct&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>

        <span class="c1"># Check if fees covering IL</span>
        <span class="k">if</span> <span class="n">pnl</span><span class="p">[</span><span class="s1">&#39;fees_offset_il&#39;</span><span class="p">]:</span>
            <span class="n">reasons_to_stay</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Fees are covering IL&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">reasons_to_exit</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Fees not covering IL&#39;</span><span class="p">)</span>

        <span class="c1"># Price outlook</span>
        <span class="k">if</span> <span class="n">price_outlook</span> <span class="o">==</span> <span class="s1">&#39;volatile&#39;</span><span class="p">:</span>
            <span class="n">reasons_to_exit</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Expected volatility will increase IL&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">price_outlook</span> <span class="o">==</span> <span class="s1">&#39;stable&#39;</span><span class="p">:</span>
            <span class="n">reasons_to_stay</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Stable prices minimize IL risk&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;recommendation&#39;</span><span class="p">:</span> <span class="s1">&#39;EXIT&#39;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">reasons_to_exit</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">reasons_to_stay</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;HOLD&#39;</span><span class="p">,</span>
            <span class="s1">&#39;reasons_to_exit&#39;</span><span class="p">:</span> <span class="n">reasons_to_exit</span><span class="p">,</span>
            <span class="s1">&#39;reasons_to_stay&#39;</span><span class="p">:</span> <span class="n">reasons_to_stay</span><span class="p">,</span>
            <span class="s1">&#39;current_pnl&#39;</span><span class="p">:</span> <span class="n">pnl</span>
        <span class="p">}</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>Section 3: Yield Farming Analysis</h1></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">YieldFarmingAnalyzer</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Analyze and compare yield farming opportunities.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="nf">calculate_apy_from_apr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">apr</span><span class="p">,</span> <span class="n">compounds_per_year</span><span class="o">=</span><span class="mi">365</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convert APR to APY with compounding.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">apr</span> <span class="o">/</span> <span class="n">compounds_per_year</span><span class="p">)</span> <span class="o">**</span> <span class="n">compounds_per_year</span> <span class="o">-</span> <span class="mi">1</span>
    
    <span class="k">def</span> <span class="nf">calculate_real_yield</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base_apy</span><span class="p">,</span> <span class="n">token_inflation</span><span class="p">,</span> <span class="n">token_price_change_expected</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate real yield accounting for token emissions.</span>
<span class="sd">        </span>
<span class="sd">        Many farms pay rewards in inflationary tokens.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># If reward token is expected to decrease in value</span>
        <span class="n">adjusted_apy</span> <span class="o">=</span> <span class="n">base_apy</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">token_price_change_expected</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;advertised_apy&#39;</span><span class="p">:</span> <span class="n">base_apy</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
            <span class="s1">&#39;adjusted_apy&#39;</span><span class="p">:</span> <span class="n">adjusted_apy</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
            <span class="s1">&#39;warning&#39;</span><span class="p">:</span> <span class="s1">&#39;Reward token may decrease in value&#39;</span> <span class="k">if</span> <span class="n">token_price_change_expected</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">risk_score</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tvl</span><span class="p">,</span> <span class="n">age_days</span><span class="p">,</span> <span class="n">audited</span><span class="p">,</span> <span class="n">token_emissions</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate risk score for a farm (1-10, lower is safer).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">score</span> <span class="o">=</span> <span class="mi">5</span>
        
        <span class="c1"># TVL factor</span>
        <span class="k">if</span> <span class="n">tvl</span> <span class="o">&gt;</span> <span class="mi">100_000_000</span><span class="p">:</span>
            <span class="n">score</span> <span class="o">-=</span> <span class="mi">2</span>
        <span class="k">elif</span> <span class="n">tvl</span> <span class="o">&gt;</span> <span class="mi">10_000_000</span><span class="p">:</span>
            <span class="n">score</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">tvl</span> <span class="o">&lt;</span> <span class="mi">1_000_000</span><span class="p">:</span>
            <span class="n">score</span> <span class="o">+=</span> <span class="mi">2</span>
        
        <span class="c1"># Age factor</span>
        <span class="k">if</span> <span class="n">age_days</span> <span class="o">&gt;</span> <span class="mi">365</span><span class="p">:</span>
            <span class="n">score</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">age_days</span> <span class="o">&lt;</span> <span class="mi">30</span><span class="p">:</span>
            <span class="n">score</span> <span class="o">+=</span> <span class="mi">2</span>
        
        <span class="c1"># Audit factor</span>
        <span class="k">if</span> <span class="n">audited</span><span class="p">:</span>
            <span class="n">score</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">score</span> <span class="o">+=</span> <span class="mi">2</span>
        
        <span class="c1"># Emissions factor (high emissions = high risk)</span>
        <span class="k">if</span> <span class="n">token_emissions</span> <span class="o">&gt;</span> <span class="mi">50</span><span class="p">:</span>  <span class="c1"># &gt;50% APY from emissions</span>
            <span class="n">score</span> <span class="o">+=</span> <span class="mi">1</span>
        
        <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">score</span><span class="p">))</span>
    
    <span class="k">def</span> <span class="nf">compare_opportunities</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">farms</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compare multiple farming opportunities.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">farm</span> <span class="ow">in</span> <span class="n">farms</span><span class="p">:</span>
            <span class="n">farm</span><span class="p">[</span><span class="s1">&#39;risk_score&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">risk_score</span><span class="p">(</span>
                <span class="n">farm</span><span class="p">[</span><span class="s1">&#39;tvl&#39;</span><span class="p">],</span>
                <span class="n">farm</span><span class="p">[</span><span class="s1">&#39;age_days&#39;</span><span class="p">],</span>
                <span class="n">farm</span><span class="p">[</span><span class="s1">&#39;audited&#39;</span><span class="p">],</span>
                <span class="n">farm</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;emission_apy&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">farm</span><span class="p">[</span><span class="s1">&#39;risk_adjusted_apy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">farm</span><span class="p">[</span><span class="s1">&#39;apy&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">farm</span><span class="p">[</span><span class="s1">&#39;risk_score&#39;</span><span class="p">]</span>
        
        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">farms</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;risk_adjusted_apy&#39;</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h3>âœï¸ Exercise 14.3: Yield Tracker</h3>
<p>Build a yield farming tracker and optimizer.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="c1"># Exercise 14.3</span>
<span class="k">class</span> <span class="nc">YieldTracker</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">active_positions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">historical_yields</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">def</span> <span class="nf">add_position</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">protocol</span><span class="p">,</span> <span class="n">pool</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">entry_apy</span><span class="p">):</span>
        <span class="c1"># TODO</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">calculate_earnings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">position</span><span class="p">,</span> <span class="n">days</span><span class="p">):</span>
        <span class="c1"># TODO</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">optimize_allocation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">total_capital</span><span class="p">,</span> <span class="n">opportunities</span><span class="p">,</span> <span class="n">risk_tolerance</span><span class="o">=</span><span class="s1">&#39;medium&#39;</span><span class="p">):</span>
        <span class="c1"># TODO: Suggest optimal allocation</span>
        <span class="k">pass</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">YieldTracker</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">active_positions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">historical_yields</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">analyzer</span> <span class="o">=</span> <span class="n">YieldFarmingAnalyzer</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">add_position</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">protocol</span><span class="p">,</span> <span class="n">pool</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">entry_apy</span><span class="p">):</span>
        <span class="n">position</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">active_positions</span><span class="p">),</span>
            <span class="s1">&#39;protocol&#39;</span><span class="p">:</span> <span class="n">protocol</span><span class="p">,</span>
            <span class="s1">&#39;pool&#39;</span><span class="p">:</span> <span class="n">pool</span><span class="p">,</span>
            <span class="s1">&#39;principal&#39;</span><span class="p">:</span> <span class="n">amount</span><span class="p">,</span>
            <span class="s1">&#39;entry_apy&#39;</span><span class="p">:</span> <span class="n">entry_apy</span><span class="p">,</span>
            <span class="s1">&#39;entry_date&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
            <span class="s1">&#39;accumulated_yield&#39;</span><span class="p">:</span> <span class="mi">0</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">active_positions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">position</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">position</span>

    <span class="k">def</span> <span class="nf">calculate_earnings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">position</span><span class="p">,</span> <span class="n">days</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">days</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">days</span> <span class="o">=</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">position</span><span class="p">[</span><span class="s1">&#39;entry_date&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">days</span>

        <span class="n">daily_rate</span> <span class="o">=</span> <span class="n">position</span><span class="p">[</span><span class="s1">&#39;entry_apy&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">365</span>
        <span class="n">earnings</span> <span class="o">=</span> <span class="n">position</span><span class="p">[</span><span class="s1">&#39;principal&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">daily_rate</span> <span class="o">*</span> <span class="n">days</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;principal&#39;</span><span class="p">:</span> <span class="n">position</span><span class="p">[</span><span class="s1">&#39;principal&#39;</span><span class="p">],</span>
            <span class="s1">&#39;days&#39;</span><span class="p">:</span> <span class="n">days</span><span class="p">,</span>
            <span class="s1">&#39;earnings&#39;</span><span class="p">:</span> <span class="n">earnings</span><span class="p">,</span>
            <span class="s1">&#39;total_value&#39;</span><span class="p">:</span> <span class="n">position</span><span class="p">[</span><span class="s1">&#39;principal&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">earnings</span><span class="p">,</span>
            <span class="s1">&#39;effective_apy&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">earnings</span> <span class="o">/</span> <span class="n">position</span><span class="p">[</span><span class="s1">&#39;principal&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="mi">365</span> <span class="o">/</span> <span class="n">days</span><span class="p">)</span> <span class="k">if</span> <span class="n">days</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">optimize_allocation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">total_capital</span><span class="p">,</span> <span class="n">opportunities</span><span class="p">,</span> <span class="n">risk_tolerance</span><span class="o">=</span><span class="s1">&#39;medium&#39;</span><span class="p">):</span>
        <span class="c1"># Risk tolerance -&gt; max risk score</span>
        <span class="n">risk_limits</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;low&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;medium&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;high&#39;</span><span class="p">:</span> <span class="mi">8</span><span class="p">}</span>
        <span class="n">max_risk</span> <span class="o">=</span> <span class="n">risk_limits</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">risk_tolerance</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>

        <span class="c1"># Filter by risk</span>
        <span class="n">eligible</span> <span class="o">=</span> <span class="p">[</span><span class="n">o</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">opportunities</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyzer</span><span class="o">.</span><span class="n">risk_score</span><span class="p">(</span>
            <span class="n">o</span><span class="p">[</span><span class="s1">&#39;tvl&#39;</span><span class="p">],</span> <span class="n">o</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;age_days&#39;</span><span class="p">,</span> <span class="mi">30</span><span class="p">),</span> <span class="n">o</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;audited&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span> <span class="n">o</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;emission_apy&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">)</span> <span class="o">&lt;=</span> <span class="n">max_risk</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">eligible</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;No eligible opportunities for risk tolerance&#39;</span><span class="p">}</span>

        <span class="c1"># Sort by risk-adjusted APY</span>
        <span class="n">ranked</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyzer</span><span class="o">.</span><span class="n">compare_opportunities</span><span class="p">(</span><span class="n">eligible</span><span class="p">)</span>

        <span class="c1"># Allocate (simple: split among top 3)</span>
        <span class="n">top_n</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ranked</span><span class="p">))</span>
        <span class="n">allocation_per</span> <span class="o">=</span> <span class="n">total_capital</span> <span class="o">/</span> <span class="n">top_n</span>

        <span class="n">allocations</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">total_expected_apy</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">opp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ranked</span><span class="p">[:</span><span class="n">top_n</span><span class="p">]):</span>
            <span class="n">allocations</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;protocol&#39;</span><span class="p">:</span> <span class="n">opp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;protocol&#39;</span><span class="p">,</span> <span class="s1">&#39;Unknown&#39;</span><span class="p">),</span>
                <span class="s1">&#39;pool&#39;</span><span class="p">:</span> <span class="n">opp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pool&#39;</span><span class="p">,</span> <span class="s1">&#39;Unknown&#39;</span><span class="p">),</span>
                <span class="s1">&#39;amount&#39;</span><span class="p">:</span> <span class="n">allocation_per</span><span class="p">,</span>
                <span class="s1">&#39;apy&#39;</span><span class="p">:</span> <span class="n">opp</span><span class="p">[</span><span class="s1">&#39;apy&#39;</span><span class="p">],</span>
                <span class="s1">&#39;risk_score&#39;</span><span class="p">:</span> <span class="n">opp</span><span class="p">[</span><span class="s1">&#39;risk_score&#39;</span><span class="p">]</span>
            <span class="p">})</span>
            <span class="n">total_expected_apy</span> <span class="o">+=</span> <span class="n">opp</span><span class="p">[</span><span class="s1">&#39;apy&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">top_n</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;allocations&#39;</span><span class="p">:</span> <span class="n">allocations</span><span class="p">,</span>
            <span class="s1">&#39;total_capital&#39;</span><span class="p">:</span> <span class="n">total_capital</span><span class="p">,</span>
            <span class="s1">&#39;weighted_apy&#39;</span><span class="p">:</span> <span class="n">total_expected_apy</span><span class="p">,</span>
            <span class="s1">&#39;expected_daily_yield&#39;</span><span class="p">:</span> <span class="n">total_capital</span> <span class="o">*</span> <span class="n">total_expected_apy</span> <span class="o">/</span> <span class="mi">365</span>
        <span class="p">}</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>Section 4: Flash Loans</h1></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">FlashLoanSimulator</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Simulate flash loan mechanics.</span>
<span class="sd">    </span>
<span class="sd">    Flash loans allow borrowing without collateral,</span>
<span class="sd">    but must be repaid in the same transaction.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c1"># Flash loan providers and their fees</span>
    <span class="n">PROVIDERS</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;Aave&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;fee&#39;</span><span class="p">:</span> <span class="mf">0.0009</span><span class="p">,</span> <span class="s1">&#39;max_amount&#39;</span><span class="p">:</span> <span class="s1">&#39;pool_liquidity&#39;</span><span class="p">},</span>  <span class="c1"># 0.09%</span>
        <span class="s1">&#39;dYdX&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;fee&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;max_amount&#39;</span><span class="p">:</span> <span class="s1">&#39;pool_liquidity&#39;</span><span class="p">},</span>       <span class="c1"># Free!</span>
        <span class="s1">&#39;Uniswap&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;fee&#39;</span><span class="p">:</span> <span class="mf">0.003</span><span class="p">,</span> <span class="s1">&#39;max_amount&#39;</span><span class="p">:</span> <span class="s1">&#39;pool_liquidity&#39;</span><span class="p">}</span> <span class="c1"># 0.3%</span>
    <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">calculate_loan_cost</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">provider</span><span class="o">=</span><span class="s1">&#39;Aave&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculate cost of flash loan.&quot;&quot;&quot;</span>
        <span class="n">fee_rate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">PROVIDERS</span><span class="p">[</span><span class="n">provider</span><span class="p">][</span><span class="s1">&#39;fee&#39;</span><span class="p">]</span>
        <span class="n">fee</span> <span class="o">=</span> <span class="n">amount</span> <span class="o">*</span> <span class="n">fee_rate</span>
        <span class="n">repayment</span> <span class="o">=</span> <span class="n">amount</span> <span class="o">+</span> <span class="n">fee</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;borrowed&#39;</span><span class="p">:</span> <span class="n">amount</span><span class="p">,</span>
            <span class="s1">&#39;fee_rate&#39;</span><span class="p">:</span> <span class="n">fee_rate</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
            <span class="s1">&#39;fee&#39;</span><span class="p">:</span> <span class="n">fee</span><span class="p">,</span>
            <span class="s1">&#39;total_repayment&#39;</span><span class="p">:</span> <span class="n">repayment</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">simulate_arbitrage_with_flash_loan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">profit_pct</span><span class="p">,</span> <span class="n">provider</span><span class="o">=</span><span class="s1">&#39;Aave&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Simulate using flash loan for arbitrage.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">loan_cost</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_loan_cost</span><span class="p">(</span><span class="n">amount</span><span class="p">,</span> <span class="n">provider</span><span class="p">)</span>
        
        <span class="c1"># Gross profit from arbitrage</span>
        <span class="n">gross_profit</span> <span class="o">=</span> <span class="n">amount</span> <span class="o">*</span> <span class="n">profit_pct</span> <span class="o">/</span> <span class="mi">100</span>
        
        <span class="c1"># Net profit after loan fee</span>
        <span class="n">net_profit</span> <span class="o">=</span> <span class="n">gross_profit</span> <span class="o">-</span> <span class="n">loan_cost</span><span class="p">[</span><span class="s1">&#39;fee&#39;</span><span class="p">]</span>
        
        <span class="c1"># Gas cost (rough estimate)</span>
        <span class="n">gas_cost_usd</span> <span class="o">=</span> <span class="mi">50</span>  <span class="c1"># Depends on complexity</span>
        
        <span class="n">final_profit</span> <span class="o">=</span> <span class="n">net_profit</span> <span class="o">-</span> <span class="n">gas_cost_usd</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;flash_loan_amount&#39;</span><span class="p">:</span> <span class="n">amount</span><span class="p">,</span>
            <span class="s1">&#39;loan_fee&#39;</span><span class="p">:</span> <span class="n">loan_cost</span><span class="p">[</span><span class="s1">&#39;fee&#39;</span><span class="p">],</span>
            <span class="s1">&#39;gross_arbitrage_profit&#39;</span><span class="p">:</span> <span class="n">gross_profit</span><span class="p">,</span>
            <span class="s1">&#39;net_profit_after_fee&#39;</span><span class="p">:</span> <span class="n">net_profit</span><span class="p">,</span>
            <span class="s1">&#39;estimated_gas&#39;</span><span class="p">:</span> <span class="n">gas_cost_usd</span><span class="p">,</span>
            <span class="s1">&#39;final_profit&#39;</span><span class="p">:</span> <span class="n">final_profit</span><span class="p">,</span>
            <span class="s1">&#39;profitable&#39;</span><span class="p">:</span> <span class="n">final_profit</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;capital_required&#39;</span><span class="p">:</span> <span class="n">gas_cost_usd</span>  <span class="c1"># Only need gas!</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">minimum_profit_for_break_even</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">provider</span><span class="o">=</span><span class="s1">&#39;Aave&#39;</span><span class="p">,</span> <span class="n">gas_cost</span><span class="o">=</span><span class="mi">50</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculate minimum arbitrage profit needed to break even.&quot;&quot;&quot;</span>
        <span class="n">loan_cost</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_loan_cost</span><span class="p">(</span><span class="n">amount</span><span class="p">,</span> <span class="n">provider</span><span class="p">)</span>
        <span class="n">total_cost</span> <span class="o">=</span> <span class="n">loan_cost</span><span class="p">[</span><span class="s1">&#39;fee&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">gas_cost</span>
        <span class="n">min_profit_pct</span> <span class="o">=</span> <span class="p">(</span><span class="n">total_cost</span> <span class="o">/</span> <span class="n">amount</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;min_profit_pct&#39;</span><span class="p">:</span> <span class="n">min_profit_pct</span><span class="p">,</span>
            <span class="s1">&#39;min_profit_usd&#39;</span><span class="p">:</span> <span class="n">total_cost</span><span class="p">,</span>
            <span class="s1">&#39;breakdown&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;loan_fee&#39;</span><span class="p">:</span> <span class="n">loan_cost</span><span class="p">[</span><span class="s1">&#39;fee&#39;</span><span class="p">],</span>
                <span class="s1">&#39;gas&#39;</span><span class="p">:</span> <span class="n">gas_cost</span>
            <span class="p">}</span>
        <span class="p">}</span>

<span class="n">fl</span> <span class="o">=</span> <span class="n">FlashLoanSimulator</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">fl</span><span class="o">.</span><span class="n">simulate_arbitrage_with_flash_loan</span><span class="p">(</span><span class="mi">1_000_000</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">))</span>  <span class="c1"># $1M loan, 0.5% arb</span>
</code></pre></div>
<div class="md-cell"><h3>âœï¸ Exercise 14.4: Flash Loan Strategy Analyzer</h3>
<p>Build a flash loan opportunity analyzer.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="c1"># Exercise 14.4</span>
<span class="k">class</span> <span class="nc">FlashLoanAnalyzer</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">simulator</span> <span class="o">=</span> <span class="n">FlashLoanSimulator</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">analyze_arbitrage_opportunity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">buy_price</span><span class="p">,</span> <span class="n">sell_price</span><span class="p">,</span> <span class="n">available_liquidity</span><span class="p">):</span>
        <span class="c1"># TODO: Determine if flash loan arbitrage is profitable</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">optimal_loan_amount</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spread_pct</span><span class="p">,</span> <span class="n">max_liquidity</span><span class="p">):</span>
        <span class="c1"># TODO: Find optimal loan size</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">compare_providers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
        <span class="c1"># TODO: Compare flash loan providers</span>
        <span class="k">pass</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">FlashLoanAnalyzer</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">simulator</span> <span class="o">=</span> <span class="n">FlashLoanSimulator</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">analyze_arbitrage_opportunity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">buy_price</span><span class="p">,</span> <span class="n">sell_price</span><span class="p">,</span> <span class="n">available_liquidity</span><span class="p">,</span> <span class="n">gas_cost</span><span class="o">=</span><span class="mi">50</span><span class="p">):</span>
        <span class="n">spread_pct</span> <span class="o">=</span> <span class="p">(</span><span class="n">sell_price</span> <span class="o">-</span> <span class="n">buy_price</span><span class="p">)</span> <span class="o">/</span> <span class="n">buy_price</span> <span class="o">*</span> <span class="mi">100</span>

        <span class="c1"># Try different loan amounts</span>
        <span class="n">best_result</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">for</span> <span class="n">pct</span> <span class="ow">in</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]:</span>  <span class="c1"># % of available liquidity</span>
            <span class="n">amount</span> <span class="o">=</span> <span class="n">available_liquidity</span> <span class="o">*</span> <span class="n">pct</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulator</span><span class="o">.</span><span class="n">simulate_arbitrage_with_flash_loan</span><span class="p">(</span>
                <span class="n">amount</span><span class="p">,</span> <span class="n">spread_pct</span><span class="p">,</span> <span class="s1">&#39;Aave&#39;</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;profitable&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">best_result</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;final_profit&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">best_result</span><span class="p">[</span><span class="s1">&#39;final_profit&#39;</span><span class="p">]:</span>
                    <span class="n">best_result</span> <span class="o">=</span> <span class="n">result</span>
                    <span class="n">best_result</span><span class="p">[</span><span class="s1">&#39;loan_pct_of_liquidity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pct</span> <span class="o">*</span> <span class="mi">100</span>

        <span class="k">return</span> <span class="n">best_result</span> <span class="ow">or</span> <span class="p">{</span><span class="s1">&#39;profitable&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="s1">&#39;Spread too small&#39;</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">optimal_loan_amount</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spread_pct</span><span class="p">,</span> <span class="n">max_liquidity</span><span class="p">,</span> <span class="n">gas_cost</span><span class="o">=</span><span class="mi">50</span><span class="p">):</span>
        <span class="c1"># Larger loans = more profit but more price impact</span>
        <span class="c1"># Simple model: price impact increases with size</span>

        <span class="n">best_profit</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">best_amount</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">pct</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">101</span><span class="p">,</span> <span class="mi">5</span><span class="p">):</span>  <span class="c1"># 1% to 100% in 5% steps</span>
            <span class="n">amount</span> <span class="o">=</span> <span class="n">max_liquidity</span> <span class="o">*</span> <span class="n">pct</span> <span class="o">/</span> <span class="mi">100</span>

            <span class="c1"># Simulate price impact (larger trades = worse execution)</span>
            <span class="n">effective_spread</span> <span class="o">=</span> <span class="n">spread_pct</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">pct</span><span class="o">/</span><span class="mi">200</span><span class="p">)</span>  <span class="c1"># Spread decreases with size</span>

            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulator</span><span class="o">.</span><span class="n">simulate_arbitrage_with_flash_loan</span><span class="p">(</span>
                <span class="n">amount</span><span class="p">,</span> <span class="n">effective_spread</span><span class="p">,</span> <span class="s1">&#39;Aave&#39;</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;final_profit&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">best_profit</span><span class="p">:</span>
                <span class="n">best_profit</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;final_profit&#39;</span><span class="p">]</span>
                <span class="n">best_amount</span> <span class="o">=</span> <span class="n">amount</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;optimal_amount&#39;</span><span class="p">:</span> <span class="n">best_amount</span><span class="p">,</span>
            <span class="s1">&#39;expected_profit&#39;</span><span class="p">:</span> <span class="n">best_profit</span><span class="p">,</span>
            <span class="s1">&#39;pct_of_liquidity&#39;</span><span class="p">:</span> <span class="n">best_amount</span> <span class="o">/</span> <span class="n">max_liquidity</span> <span class="o">*</span> <span class="mi">100</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">compare_providers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">provider</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulator</span><span class="o">.</span><span class="n">PROVIDERS</span><span class="p">:</span>
            <span class="n">cost</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulator</span><span class="o">.</span><span class="n">calculate_loan_cost</span><span class="p">(</span><span class="n">amount</span><span class="p">,</span> <span class="n">provider</span><span class="p">)</span>
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;provider&#39;</span><span class="p">:</span> <span class="n">provider</span><span class="p">,</span>
                <span class="s1">&#39;fee&#39;</span><span class="p">:</span> <span class="n">cost</span><span class="p">[</span><span class="s1">&#39;fee&#39;</span><span class="p">],</span>
                <span class="s1">&#39;fee_pct&#39;</span><span class="p">:</span> <span class="n">cost</span><span class="p">[</span><span class="s1">&#39;fee_rate&#39;</span><span class="p">]</span>
            <span class="p">})</span>

        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;fee&#39;</span><span class="p">])</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>ğŸ—ï¸ Module Project: DeFi Opportunity Scanner</h1>
<p>Build a comprehensive DeFi opportunity scanner.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="c1"># Module Project</span>
<span class="k">class</span> <span class="nc">DeFiOpportunityScanner</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">arbitrage</span> <span class="o">=</span> <span class="n">ArbitrageScanner</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lp_analyzer</span> <span class="o">=</span> <span class="n">LPPositionAnalyzer</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">yield_tracker</span> <span class="o">=</span> <span class="n">YieldTracker</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flash_loan</span> <span class="o">=</span> <span class="n">FlashLoanAnalyzer</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">scan_all_opportunities</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">capital</span><span class="p">):</span>
        <span class="c1"># TODO: Scan arbitrage, yield, LP opportunities</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">rank_opportunities</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">opportunities</span><span class="p">):</span>
        <span class="c1"># TODO: Rank by risk-adjusted return</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">generate_report</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># TODO: Generate opportunity report</span>
        <span class="k">pass</span>
</code></pre></div>
<div class="md-cell"><hr />
<h1>ğŸ“ Key Takeaways</h1>
<ol>
<li><strong>Arbitrage</strong>: CEX-DEX and DEX-DEX spreads can be profitable with proper execution</li>
<li><strong>Liquidity Provision</strong>: Understand IL before providing - fees must exceed IL</li>
<li><strong>Yield Farming</strong>: High APY often means high risk - calculate real yield</li>
<li><strong>Flash Loans</strong>: Borrow millions with no collateral - repay in same tx</li>
</ol>
<hr />
<p><em>Next: Module 15 - Advanced Crypto Topics</em></p></div>
        <div class="nav-buttons">
            <button class="nav-btn prev-btn disabled" type="button">
                <span class="nav-btn-label">â† Previous</span>
                <span class="nav-btn-name"></span>
            </button>
            <button class="nav-btn next-btn disabled" type="button">
                <span class="nav-btn-label">Next â†’</span>
                <span class="nav-btn-name"></span>
            </button>
        </div>
        </div>
<div class="module-section" data-idx="15"><div class="md-cell module-header"><h1>Module 15: Advanced Crypto Topics</h1>
<h2>Part 4: DeFi &amp; Advanced Topics</h2>
<hr />
<div class="table-wrapper"><table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>â±ï¸ <strong>Duration</strong></td>
<td>~2.5 hours</td>
</tr>
<tr>
<td>ğŸ“‹ <strong>Prerequisites</strong></td>
<td>Module 14</td>
</tr>
<tr>
<td>ğŸ’ª <strong>Exercises</strong></td>
<td>5 total</td>
</tr>
</tbody>
</table></div></div>
<div class="md-cell"><h2>ğŸ¯ Learning Objectives</h2>
<ul>
<li>Trade funding rate strategies on perpetuals</li>
<li>Understand crypto options basics</li>
<li>Learn market making concepts</li>
<li>Implement cross-exchange strategies</li>
</ul></div>
<div class="md-cell"><hr />
<h1>Section 1: Funding Rate Strategies</h1>
<h2>1.1 Understanding Perpetual Funding</h2></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">FundingRateAnalyzer</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Analyze perpetual futures funding rates.</span>
<span class="sd">    </span>
<span class="sd">    Funding Rate = (Perp Price - Spot Price) / Spot Price</span>
<span class="sd">    Paid every 8 hours on most exchanges.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">funding_history</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">def</span> <span class="nf">calculate_funding_rate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">perp_price</span><span class="p">,</span> <span class="n">spot_price</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculate current funding rate.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">perp_price</span> <span class="o">-</span> <span class="n">spot_price</span><span class="p">)</span> <span class="o">/</span> <span class="n">spot_price</span>
    
    <span class="k">def</span> <span class="nf">annualized_funding</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rate</span><span class="p">,</span> <span class="n">payments_per_day</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convert funding rate to annualized percentage.&quot;&quot;&quot;</span>
        <span class="n">daily</span> <span class="o">=</span> <span class="n">rate</span> <span class="o">*</span> <span class="n">payments_per_day</span>
        <span class="n">annual</span> <span class="o">=</span> <span class="n">daily</span> <span class="o">*</span> <span class="mi">365</span>
        <span class="k">return</span> <span class="n">annual</span> <span class="o">*</span> <span class="mi">100</span>
    
    <span class="k">def</span> <span class="nf">funding_pnl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">position_size</span><span class="p">,</span> <span class="n">funding_rate</span><span class="p">,</span> <span class="n">is_long</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate PnL from funding.</span>
<span class="sd">        </span>
<span class="sd">        - Positive funding: Longs pay shorts</span>
<span class="sd">        - Negative funding: Shorts pay longs</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">is_long</span><span class="p">:</span>
            <span class="c1"># Longs pay when positive, receive when negative</span>
            <span class="n">pnl</span> <span class="o">=</span> <span class="o">-</span><span class="n">position_size</span> <span class="o">*</span> <span class="n">funding_rate</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Shorts receive when positive, pay when negative</span>
            <span class="n">pnl</span> <span class="o">=</span> <span class="n">position_size</span> <span class="o">*</span> <span class="n">funding_rate</span>
        
        <span class="k">return</span> <span class="n">pnl</span>
    
    <span class="k">def</span> <span class="nf">cash_and_carry_return</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spot_price</span><span class="p">,</span> <span class="n">perp_price</span><span class="p">,</span> <span class="n">funding_rate</span><span class="p">,</span> <span class="n">days</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate cash and carry arbitrage return.</span>
<span class="sd">        </span>
<span class="sd">        Strategy: Long spot + Short perp = Earn funding</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Funding income (3 payments per day)</span>
        <span class="n">total_funding</span> <span class="o">=</span> <span class="n">funding_rate</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">days</span>
        <span class="n">funding_income</span> <span class="o">=</span> <span class="n">spot_price</span> <span class="o">*</span> <span class="n">total_funding</span>
        
        <span class="c1"># Basis at entry (could be positive or negative)</span>
        <span class="n">basis</span> <span class="o">=</span> <span class="n">perp_price</span> <span class="o">-</span> <span class="n">spot_price</span>
        
        <span class="c1"># Total return</span>
        <span class="n">total_return</span> <span class="o">=</span> <span class="n">funding_income</span> <span class="o">+</span> <span class="n">basis</span>  <span class="c1"># Basis converges to 0</span>
        <span class="n">return_pct</span> <span class="o">=</span> <span class="n">total_return</span> <span class="o">/</span> <span class="n">spot_price</span> <span class="o">*</span> <span class="mi">100</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;funding_income&#39;</span><span class="p">:</span> <span class="n">funding_income</span><span class="p">,</span>
            <span class="s1">&#39;basis&#39;</span><span class="p">:</span> <span class="n">basis</span><span class="p">,</span>
            <span class="s1">&#39;total_return&#39;</span><span class="p">:</span> <span class="n">total_return</span><span class="p">,</span>
            <span class="s1">&#39;return_pct&#39;</span><span class="p">:</span> <span class="n">return_pct</span><span class="p">,</span>
            <span class="s1">&#39;annualized_return&#39;</span><span class="p">:</span> <span class="n">return_pct</span> <span class="o">*</span> <span class="mi">365</span> <span class="o">/</span> <span class="n">days</span>
        <span class="p">}</span>

<span class="n">fr</span> <span class="o">=</span> <span class="n">FundingRateAnalyzer</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;0.01% funding = </span><span class="si">{</span><span class="n">fr</span><span class="o">.</span><span class="n">annualized_funding</span><span class="p">(</span><span class="mf">0.0001</span><span class="p">)</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">% annualized&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;0.05% funding = </span><span class="si">{</span><span class="n">fr</span><span class="o">.</span><span class="n">annualized_funding</span><span class="p">(</span><span class="mf">0.0005</span><span class="p">)</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">% annualized&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h2>1.2 Funding Rate Strategies</h2></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">FundingStrategy</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Strategies based on funding rates.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">analyzer</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">analyzer</span> <span class="o">=</span> <span class="n">analyzer</span>
    
    <span class="k">def</span> <span class="nf">cash_and_carry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">capital</span><span class="p">,</span> <span class="n">spot_price</span><span class="p">,</span> <span class="n">perp_price</span><span class="p">,</span> <span class="n">funding_rate</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Cash and carry: Long spot, short perp.</span>
<span class="sd">        Delta neutral, earn funding.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Split capital between spot and margin</span>
        <span class="n">spot_allocation</span> <span class="o">=</span> <span class="n">capital</span> <span class="o">*</span> <span class="mf">0.5</span>
        <span class="n">margin_allocation</span> <span class="o">=</span> <span class="n">capital</span> <span class="o">*</span> <span class="mf">0.5</span>
        
        <span class="c1"># Position sizes</span>
        <span class="n">spot_size</span> <span class="o">=</span> <span class="n">spot_allocation</span> <span class="o">/</span> <span class="n">spot_price</span>
        <span class="n">perp_size</span> <span class="o">=</span> <span class="n">spot_size</span>  <span class="c1"># Match sizes for delta neutral</span>
        
        <span class="c1"># Required margin (assume 10x leverage)</span>
        <span class="n">margin_required</span> <span class="o">=</span> <span class="n">perp_size</span> <span class="o">*</span> <span class="n">perp_price</span> <span class="o">/</span> <span class="mi">10</span>
        
        <span class="k">if</span> <span class="n">margin_required</span> <span class="o">&gt;</span> <span class="n">margin_allocation</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Insufficient margin&#39;</span><span class="p">}</span>
        
        <span class="c1"># Expected funding per payment</span>
        <span class="n">funding_per_payment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyzer</span><span class="o">.</span><span class="n">funding_pnl</span><span class="p">(</span><span class="n">perp_size</span> <span class="o">*</span> <span class="n">perp_price</span><span class="p">,</span> <span class="n">funding_rate</span><span class="p">,</span> <span class="n">is_long</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;strategy&#39;</span><span class="p">:</span> <span class="s1">&#39;Cash and Carry&#39;</span><span class="p">,</span>
            <span class="s1">&#39;spot_position&#39;</span><span class="p">:</span> <span class="n">spot_size</span><span class="p">,</span>
            <span class="s1">&#39;perp_position&#39;</span><span class="p">:</span> <span class="o">-</span><span class="n">perp_size</span><span class="p">,</span>  <span class="c1"># Short</span>
            <span class="s1">&#39;capital_used&#39;</span><span class="p">:</span> <span class="n">capital</span><span class="p">,</span>
            <span class="s1">&#39;funding_per_8h&#39;</span><span class="p">:</span> <span class="n">funding_per_payment</span><span class="p">,</span>
            <span class="s1">&#39;daily_funding&#39;</span><span class="p">:</span> <span class="n">funding_per_payment</span> <span class="o">*</span> <span class="mi">3</span><span class="p">,</span>
            <span class="s1">&#39;annual_return_pct&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyzer</span><span class="o">.</span><span class="n">annualized_funding</span><span class="p">(</span><span class="n">funding_rate</span><span class="p">)</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">funding_arbitrage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exchange_a_rate</span><span class="p">,</span> <span class="n">exchange_b_rate</span><span class="p">,</span> <span class="n">capital</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Arbitrage funding differences between exchanges.</span>
<span class="sd">        Long on low-funding exchange, short on high-funding exchange.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">rate_diff</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">exchange_a_rate</span> <span class="o">-</span> <span class="n">exchange_b_rate</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">exchange_a_rate</span> <span class="o">&gt;</span> <span class="n">exchange_b_rate</span><span class="p">:</span>
            <span class="c1"># Short on A, Long on B</span>
            <span class="n">strategy</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;short&#39;</span><span class="p">:</span> <span class="s1">&#39;Exchange A&#39;</span><span class="p">,</span> <span class="s1">&#39;long&#39;</span><span class="p">:</span> <span class="s1">&#39;Exchange B&#39;</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">strategy</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;short&#39;</span><span class="p">:</span> <span class="s1">&#39;Exchange B&#39;</span><span class="p">,</span> <span class="s1">&#39;long&#39;</span><span class="p">:</span> <span class="s1">&#39;Exchange A&#39;</span><span class="p">}</span>
        
        <span class="c1"># Assume 5x leverage each side</span>
        <span class="n">position_size</span> <span class="o">=</span> <span class="n">capital</span> <span class="o">*</span> <span class="mi">5</span> <span class="o">/</span> <span class="mi">2</span>  <span class="c1"># Split between exchanges</span>
        
        <span class="n">net_funding</span> <span class="o">=</span> <span class="n">position_size</span> <span class="o">*</span> <span class="n">rate_diff</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;strategy&#39;</span><span class="p">:</span> <span class="s1">&#39;Funding Arbitrage&#39;</span><span class="p">,</span>
            <span class="s1">&#39;rate_differential&#39;</span><span class="p">:</span> <span class="n">rate_diff</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
            <span class="o">**</span><span class="n">strategy</span><span class="p">,</span>
            <span class="s1">&#39;net_funding_per_8h&#39;</span><span class="p">:</span> <span class="n">net_funding</span><span class="p">,</span>
            <span class="s1">&#39;annualized_return&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyzer</span><span class="o">.</span><span class="n">annualized_funding</span><span class="p">(</span><span class="n">rate_diff</span><span class="p">)</span>
        <span class="p">}</span>
</code></pre></div>
<div class="md-cell"><h3>âœï¸ Exercise 15.1: Funding Rate Tracker</h3>
<p>Build a funding rate monitoring and trading system.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="c1"># Exercise 15.1</span>
<span class="k">class</span> <span class="nc">FundingRateTracker</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rates</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">history</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">def</span> <span class="nf">update_rate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exchange</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">rate</span><span class="p">):</span>
        <span class="c1"># TODO</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">find_opportunities</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">min_rate</span><span class="o">=</span><span class="mf">0.0003</span><span class="p">):</span>
        <span class="c1"># TODO: Find high funding rate opportunities</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">backtest_strategy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">days</span><span class="p">,</span> <span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;cash_and_carry&#39;</span><span class="p">):</span>
        <span class="c1"># TODO: Backtest funding strategy</span>
        <span class="k">pass</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>

<span class="k">class</span> <span class="nc">FundingRateTracker</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rates</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># {exchange: {symbol: rate}}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">history</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># Historical rates for backtesting</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">analyzer</span> <span class="o">=</span> <span class="n">FundingRateAnalyzer</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">update_rate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exchange</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">rate</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">exchange</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rates</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rates</span><span class="p">[</span><span class="n">exchange</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">rates</span><span class="p">[</span><span class="n">exchange</span><span class="p">][</span><span class="n">symbol</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;rate&#39;</span><span class="p">:</span> <span class="n">rate</span><span class="p">,</span>
            <span class="s1">&#39;annualized&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyzer</span><span class="o">.</span><span class="n">annualized_funding</span><span class="p">(</span><span class="n">rate</span><span class="p">),</span>
            <span class="s1">&#39;updated&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;exchange&#39;</span><span class="p">:</span> <span class="n">exchange</span><span class="p">,</span>
            <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span>
            <span class="s1">&#39;rate&#39;</span><span class="p">:</span> <span class="n">rate</span><span class="p">,</span>
            <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="p">})</span>

    <span class="k">def</span> <span class="nf">find_opportunities</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">min_rate</span><span class="o">=</span><span class="mf">0.0003</span><span class="p">):</span>
        <span class="n">opportunities</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">exchange</span><span class="p">,</span> <span class="n">symbols</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rates</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">symbols</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;rate&#39;</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="n">min_rate</span><span class="p">:</span>
                    <span class="n">opportunities</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                        <span class="s1">&#39;exchange&#39;</span><span class="p">:</span> <span class="n">exchange</span><span class="p">,</span>
                        <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span>
                        <span class="s1">&#39;rate&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;rate&#39;</span><span class="p">],</span>
                        <span class="s1">&#39;annualized&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;annualized&#39;</span><span class="p">],</span>
                        <span class="s1">&#39;direction&#39;</span><span class="p">:</span> <span class="s1">&#39;Short&#39;</span> <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;rate&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;Long&#39;</span>
                    <span class="p">})</span>

        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">opportunities</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;rate&#39;</span><span class="p">]),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">find_arbitrage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">):</span>
        <span class="n">symbol_rates</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">exchange</span><span class="p">,</span> <span class="n">symbols</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rates</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="n">symbols</span><span class="p">:</span>
                <span class="n">symbol_rates</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">exchange</span><span class="p">,</span> <span class="n">symbols</span><span class="p">[</span><span class="n">symbol</span><span class="p">][</span><span class="s1">&#39;rate&#39;</span><span class="p">]))</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">symbol_rates</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">symbol_rates</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">lowest</span> <span class="o">=</span> <span class="n">symbol_rates</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">highest</span> <span class="o">=</span> <span class="n">symbol_rates</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">spread</span> <span class="o">=</span> <span class="n">highest</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">lowest</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span>
            <span class="s1">&#39;long_on&#39;</span><span class="p">:</span> <span class="n">lowest</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="s1">&#39;short_on&#39;</span><span class="p">:</span> <span class="n">highest</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="s1">&#39;spread&#39;</span><span class="p">:</span> <span class="n">spread</span><span class="p">,</span>
            <span class="s1">&#39;annualized_arb&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyzer</span><span class="o">.</span><span class="n">annualized_funding</span><span class="p">(</span><span class="n">spread</span><span class="p">)</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">backtest_strategy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">historical_rates</span><span class="p">,</span> <span class="n">capital</span><span class="p">,</span> <span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;cash_and_carry&#39;</span><span class="p">):</span>
        <span class="n">total_funding</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">rate_data</span> <span class="ow">in</span> <span class="n">historical_rates</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">strategy</span> <span class="o">==</span> <span class="s1">&#39;cash_and_carry&#39;</span> <span class="ow">and</span> <span class="n">rate_data</span><span class="p">[</span><span class="s1">&#39;rate&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># Earn positive funding by shorting perp</span>
                <span class="n">funding</span> <span class="o">=</span> <span class="n">capital</span> <span class="o">*</span> <span class="n">rate_data</span><span class="p">[</span><span class="s1">&#39;rate&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">funding</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">total_funding</span> <span class="o">+=</span> <span class="n">funding</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;total_funding_earned&#39;</span><span class="p">:</span> <span class="n">total_funding</span><span class="p">,</span>
            <span class="s1">&#39;periods&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">historical_rates</span><span class="p">),</span>
            <span class="s1">&#39;avg_per_period&#39;</span><span class="p">:</span> <span class="n">total_funding</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">historical_rates</span><span class="p">)</span> <span class="k">if</span> <span class="n">historical_rates</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="p">}</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>Section 2: Crypto Options Basics</h1></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="kn">import</span> <span class="nn">math</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">norm</span>

<span class="k">class</span> <span class="nc">CryptoOptionsAnalyzer</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Basic crypto options analysis.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="nf">black_scholes_call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">sigma</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Black-Scholes call option price.</span>
<span class="sd">        </span>
<span class="sd">        S: Current price</span>
<span class="sd">        K: Strike price</span>
<span class="sd">        T: Time to expiry (years)</span>
<span class="sd">        r: Risk-free rate</span>
<span class="sd">        sigma: Volatility</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">T</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">S</span> <span class="o">-</span> <span class="n">K</span><span class="p">)</span>
        
        <span class="n">d1</span> <span class="o">=</span> <span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">S</span><span class="o">/</span><span class="n">K</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">r</span> <span class="o">+</span> <span class="n">sigma</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">T</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">sigma</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">T</span><span class="p">))</span>
        <span class="n">d2</span> <span class="o">=</span> <span class="n">d1</span> <span class="o">-</span> <span class="n">sigma</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">T</span><span class="p">)</span>
        
        <span class="n">call</span> <span class="o">=</span> <span class="n">S</span><span class="o">*</span><span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">d1</span><span class="p">)</span> <span class="o">-</span> <span class="n">K</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">r</span><span class="o">*</span><span class="n">T</span><span class="p">)</span><span class="o">*</span><span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">d2</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">call</span>
    
    <span class="k">def</span> <span class="nf">black_scholes_put</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">sigma</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Black-Scholes put option price.&quot;&quot;&quot;</span>
        <span class="n">call</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">black_scholes_call</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
        <span class="n">put</span> <span class="o">=</span> <span class="n">call</span> <span class="o">-</span> <span class="n">S</span> <span class="o">+</span> <span class="n">K</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">r</span><span class="o">*</span><span class="n">T</span><span class="p">)</span>  <span class="c1"># Put-call parity</span>
        <span class="k">return</span> <span class="n">put</span>
    
    <span class="k">def</span> <span class="nf">calculate_greeks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">sigma</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculate option Greeks.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">T</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;delta&#39;</span><span class="p">:</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">S</span> <span class="o">&gt;</span> <span class="n">K</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;gamma&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;theta&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;vega&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
        
        <span class="n">d1</span> <span class="o">=</span> <span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">S</span><span class="o">/</span><span class="n">K</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">r</span> <span class="o">+</span> <span class="n">sigma</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">T</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">sigma</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">T</span><span class="p">))</span>
        <span class="n">d2</span> <span class="o">=</span> <span class="n">d1</span> <span class="o">-</span> <span class="n">sigma</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">T</span><span class="p">)</span>
        
        <span class="n">delta</span> <span class="o">=</span> <span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">d1</span><span class="p">)</span>
        <span class="n">gamma</span> <span class="o">=</span> <span class="n">norm</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">d1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">S</span> <span class="o">*</span> <span class="n">sigma</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">T</span><span class="p">))</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">S</span> <span class="o">*</span> <span class="n">norm</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">d1</span><span class="p">)</span> <span class="o">*</span> <span class="n">sigma</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">T</span><span class="p">))</span> <span class="o">-</span> <span class="n">r</span><span class="o">*</span><span class="n">K</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">r</span><span class="o">*</span><span class="n">T</span><span class="p">)</span><span class="o">*</span><span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">d2</span><span class="p">))</span> <span class="o">/</span> <span class="mi">365</span>
        <span class="n">vega</span> <span class="o">=</span> <span class="n">S</span> <span class="o">*</span> <span class="n">norm</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">d1</span><span class="p">)</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">T</span><span class="p">)</span> <span class="o">/</span> <span class="mi">100</span>  <span class="c1"># Per 1% vol change</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;delta&#39;</span><span class="p">:</span> <span class="n">delta</span><span class="p">,</span>
            <span class="s1">&#39;gamma&#39;</span><span class="p">:</span> <span class="n">gamma</span><span class="p">,</span>
            <span class="s1">&#39;theta&#39;</span><span class="p">:</span> <span class="n">theta</span><span class="p">,</span>
            <span class="s1">&#39;vega&#39;</span><span class="p">:</span> <span class="n">vega</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">implied_volatility</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">option_price</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">option_type</span><span class="o">=</span><span class="s1">&#39;call&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculate implied volatility using Newton-Raphson.&quot;&quot;&quot;</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="mf">0.5</span>  <span class="c1"># Initial guess</span>
        
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">option_type</span> <span class="o">==</span> <span class="s1">&#39;call&#39;</span><span class="p">:</span>
                <span class="n">price</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">black_scholes_call</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">price</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">black_scholes_put</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
            
            <span class="n">vega</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_greeks</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)[</span><span class="s1">&#39;vega&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span>
            
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">vega</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-10</span><span class="p">:</span>
                <span class="k">break</span>
            
            <span class="n">sigma</span> <span class="o">=</span> <span class="n">sigma</span> <span class="o">-</span> <span class="p">(</span><span class="n">price</span> <span class="o">-</span> <span class="n">option_price</span><span class="p">)</span> <span class="o">/</span> <span class="n">vega</span>
            <span class="n">sigma</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.01</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">sigma</span><span class="p">))</span>  <span class="c1"># Bounds</span>
            
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">price</span> <span class="o">-</span> <span class="n">option_price</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.01</span><span class="p">:</span>
                <span class="k">break</span>
        
        <span class="k">return</span> <span class="n">sigma</span>

<span class="n">opt</span> <span class="o">=</span> <span class="n">CryptoOptionsAnalyzer</span><span class="p">()</span>
<span class="c1"># ETH at $2000, $2100 strike, 30 days, 80% vol</span>
<span class="n">call_price</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">black_scholes_call</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span> <span class="mi">2100</span><span class="p">,</span> <span class="mi">30</span><span class="o">/</span><span class="mi">365</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Call price: $</span><span class="si">{</span><span class="n">call_price</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Greeks: </span><span class="si">{</span><span class="n">opt</span><span class="o">.</span><span class="n">calculate_greeks</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span> <span class="mi">2100</span><span class="p">,</span> <span class="mi">30</span><span class="o">/</span><span class="mi">365</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h3>âœï¸ Exercise 15.2: Options Strategy Analyzer</h3>
<p>Build an options strategy analysis tool.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="c1"># Exercise 15.2</span>
<span class="k">class</span> <span class="nc">OptionsStrategyAnalyzer</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">analyzer</span> <span class="o">=</span> <span class="n">CryptoOptionsAnalyzer</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">straddle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">sigma</span><span class="p">):</span>
        <span class="c1"># TODO: Long call + Long put at same strike</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">strangle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">K_put</span><span class="p">,</span> <span class="n">K_call</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">sigma</span><span class="p">):</span>
        <span class="c1"># TODO: Long OTM put + Long OTM call</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">covered_call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">entry_price</span><span class="p">):</span>
        <span class="c1"># TODO: Long spot + Short call</span>
        <span class="k">pass</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">OptionsStrategyAnalyzer</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">analyzer</span> <span class="o">=</span> <span class="n">CryptoOptionsAnalyzer</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">straddle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">sigma</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Long straddle: Buy call + put at same strike.&quot;&quot;&quot;</span>
        <span class="n">call</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyzer</span><span class="o">.</span><span class="n">black_scholes_call</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
        <span class="n">put</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyzer</span><span class="o">.</span><span class="n">black_scholes_put</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>

        <span class="n">total_cost</span> <span class="o">=</span> <span class="n">call</span> <span class="o">+</span> <span class="n">put</span>
        <span class="n">breakeven_up</span> <span class="o">=</span> <span class="n">K</span> <span class="o">+</span> <span class="n">total_cost</span>
        <span class="n">breakeven_down</span> <span class="o">=</span> <span class="n">K</span> <span class="o">-</span> <span class="n">total_cost</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;strategy&#39;</span><span class="p">:</span> <span class="s1">&#39;Long Straddle&#39;</span><span class="p">,</span>
            <span class="s1">&#39;call_cost&#39;</span><span class="p">:</span> <span class="n">call</span><span class="p">,</span>
            <span class="s1">&#39;put_cost&#39;</span><span class="p">:</span> <span class="n">put</span><span class="p">,</span>
            <span class="s1">&#39;total_cost&#39;</span><span class="p">:</span> <span class="n">total_cost</span><span class="p">,</span>
            <span class="s1">&#39;breakeven_up&#39;</span><span class="p">:</span> <span class="n">breakeven_up</span><span class="p">,</span>
            <span class="s1">&#39;breakeven_down&#39;</span><span class="p">:</span> <span class="n">breakeven_down</span><span class="p">,</span>
            <span class="s1">&#39;max_loss&#39;</span><span class="p">:</span> <span class="n">total_cost</span><span class="p">,</span>
            <span class="s1">&#39;max_profit&#39;</span><span class="p">:</span> <span class="s1">&#39;Unlimited&#39;</span><span class="p">,</span>
            <span class="s1">&#39;profit_if&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Price moves more than $</span><span class="si">{</span><span class="n">total_cost</span><span class="si">:</span><span class="s1">.0f</span><span class="si">}</span><span class="s1"> from $</span><span class="si">{</span><span class="n">K</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">strangle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">K_put</span><span class="p">,</span> <span class="n">K_call</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">sigma</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Long strangle: Buy OTM put + OTM call.&quot;&quot;&quot;</span>
        <span class="n">call</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyzer</span><span class="o">.</span><span class="n">black_scholes_call</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">K_call</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
        <span class="n">put</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyzer</span><span class="o">.</span><span class="n">black_scholes_put</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">K_put</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>

        <span class="n">total_cost</span> <span class="o">=</span> <span class="n">call</span> <span class="o">+</span> <span class="n">put</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;strategy&#39;</span><span class="p">:</span> <span class="s1">&#39;Long Strangle&#39;</span><span class="p">,</span>
            <span class="s1">&#39;call_strike&#39;</span><span class="p">:</span> <span class="n">K_call</span><span class="p">,</span>
            <span class="s1">&#39;put_strike&#39;</span><span class="p">:</span> <span class="n">K_put</span><span class="p">,</span>
            <span class="s1">&#39;total_cost&#39;</span><span class="p">:</span> <span class="n">total_cost</span><span class="p">,</span>
            <span class="s1">&#39;breakeven_up&#39;</span><span class="p">:</span> <span class="n">K_call</span> <span class="o">+</span> <span class="n">total_cost</span><span class="p">,</span>
            <span class="s1">&#39;breakeven_down&#39;</span><span class="p">:</span> <span class="n">K_put</span> <span class="o">-</span> <span class="n">total_cost</span><span class="p">,</span>
            <span class="s1">&#39;max_loss&#39;</span><span class="p">:</span> <span class="n">total_cost</span><span class="p">,</span>
            <span class="s1">&#39;cheaper_than_straddle&#39;</span><span class="p">:</span> <span class="kc">True</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">covered_call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">entry_price</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Covered call: Long spot + Short call.&quot;&quot;&quot;</span>
        <span class="n">call_premium</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyzer</span><span class="o">.</span><span class="n">black_scholes_call</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>

        <span class="c1"># Max profit if price &gt;= strike at expiry</span>
        <span class="n">max_profit</span> <span class="o">=</span> <span class="p">(</span><span class="n">K</span> <span class="o">-</span> <span class="n">entry_price</span><span class="p">)</span> <span class="o">+</span> <span class="n">call_premium</span>

        <span class="c1"># Breakeven</span>
        <span class="n">breakeven</span> <span class="o">=</span> <span class="n">entry_price</span> <span class="o">-</span> <span class="n">call_premium</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;strategy&#39;</span><span class="p">:</span> <span class="s1">&#39;Covered Call&#39;</span><span class="p">,</span>
            <span class="s1">&#39;spot_entry&#39;</span><span class="p">:</span> <span class="n">entry_price</span><span class="p">,</span>
            <span class="s1">&#39;call_strike&#39;</span><span class="p">:</span> <span class="n">K</span><span class="p">,</span>
            <span class="s1">&#39;premium_received&#39;</span><span class="p">:</span> <span class="n">call_premium</span><span class="p">,</span>
            <span class="s1">&#39;max_profit&#39;</span><span class="p">:</span> <span class="n">max_profit</span><span class="p">,</span>
            <span class="s1">&#39;breakeven&#39;</span><span class="p">:</span> <span class="n">breakeven</span><span class="p">,</span>
            <span class="s1">&#39;yield_if_called&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">max_profit</span> <span class="o">/</span> <span class="n">entry_price</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
            <span class="s1">&#39;yield_from_premium&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">call_premium</span> <span class="o">/</span> <span class="n">entry_price</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
        <span class="p">}</span>

<span class="n">strat</span> <span class="o">=</span> <span class="n">OptionsStrategyAnalyzer</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">strat</span><span class="o">.</span><span class="n">straddle</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span> <span class="mi">2000</span><span class="p">,</span> <span class="mi">30</span><span class="o">/</span><span class="mi">365</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">))</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>Section 3: Market Making Concepts</h1></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">SimpleMarketMaker</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Simple market making simulation.</span>
<span class="sd">    </span>
<span class="sd">    Market makers provide liquidity by placing both</span>
<span class="sd">    buy and sell orders, profiting from the spread.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base_spread</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">inventory_limit</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_spread</span> <span class="o">=</span> <span class="n">base_spread</span>  <span class="c1"># 0.1%</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inventory_limit</span> <span class="o">=</span> <span class="n">inventory_limit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inventory</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cash</span> <span class="o">=</span> <span class="mi">10000</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trades</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">def</span> <span class="nf">calculate_quotes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mid_price</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate bid and ask prices.</span>
<span class="sd">        </span>
<span class="sd">        Adjusts spread based on inventory to reduce risk.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Inventory skew: if we&#39;re long, lower bid to buy less</span>
        <span class="n">inventory_skew</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inventory</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">inventory_limit</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_spread</span>
        
        <span class="n">half_spread</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_spread</span> <span class="o">/</span> <span class="mi">2</span>
        
        <span class="n">bid</span> <span class="o">=</span> <span class="n">mid_price</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">half_spread</span> <span class="o">-</span> <span class="n">inventory_skew</span><span class="p">)</span>
        <span class="n">ask</span> <span class="o">=</span> <span class="n">mid_price</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">half_spread</span> <span class="o">-</span> <span class="n">inventory_skew</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;bid&#39;</span><span class="p">:</span> <span class="n">bid</span><span class="p">,</span> <span class="s1">&#39;ask&#39;</span><span class="p">:</span> <span class="n">ask</span><span class="p">,</span> <span class="s1">&#39;spread&#39;</span><span class="p">:</span> <span class="n">ask</span> <span class="o">-</span> <span class="n">bid</span><span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">on_fill</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">side</span><span class="p">,</span> <span class="n">price</span><span class="p">,</span> <span class="n">size</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Process a fill.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">side</span> <span class="o">==</span> <span class="s1">&#39;buy&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inventory</span> <span class="o">+=</span> <span class="n">size</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cash</span> <span class="o">-=</span> <span class="n">price</span> <span class="o">*</span> <span class="n">size</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inventory</span> <span class="o">-=</span> <span class="n">size</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cash</span> <span class="o">+=</span> <span class="n">price</span> <span class="o">*</span> <span class="n">size</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">trades</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;side&#39;</span><span class="p">:</span> <span class="n">side</span><span class="p">,</span>
            <span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="n">price</span><span class="p">,</span>
            <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="n">size</span><span class="p">,</span>
            <span class="s1">&#39;inventory_after&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">inventory</span>
        <span class="p">})</span>
    
    <span class="k">def</span> <span class="nf">get_pnl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current_price</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculate current PnL.&quot;&quot;&quot;</span>
        <span class="n">inventory_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inventory</span> <span class="o">*</span> <span class="n">current_price</span>
        <span class="n">total_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cash</span> <span class="o">+</span> <span class="n">inventory_value</span>
        <span class="n">pnl</span> <span class="o">=</span> <span class="n">total_value</span> <span class="o">-</span> <span class="mi">10000</span>  <span class="c1"># Starting cash</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;cash&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cash</span><span class="p">,</span>
            <span class="s1">&#39;inventory&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">inventory</span><span class="p">,</span>
            <span class="s1">&#39;inventory_value&#39;</span><span class="p">:</span> <span class="n">inventory_value</span><span class="p">,</span>
            <span class="s1">&#39;total_value&#39;</span><span class="p">:</span> <span class="n">total_value</span><span class="p">,</span>
            <span class="s1">&#39;pnl&#39;</span><span class="p">:</span> <span class="n">pnl</span><span class="p">,</span>
            <span class="s1">&#39;num_trades&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trades</span><span class="p">)</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">simulate_trading</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prices</span><span class="p">,</span> <span class="n">fill_probability</span><span class="o">=</span><span class="mf">0.3</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Simulate market making over price series.&quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">random</span>
        
        <span class="k">for</span> <span class="n">price</span> <span class="ow">in</span> <span class="n">prices</span><span class="p">:</span>
            <span class="n">quotes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_quotes</span><span class="p">(</span><span class="n">price</span><span class="p">)</span>
            
            <span class="c1"># Random fills (simplified)</span>
            <span class="k">if</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">fill_probability</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="p">:</span>
                    <span class="c1"># Buy fill</span>
                    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inventory</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">inventory_limit</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">on_fill</span><span class="p">(</span><span class="s1">&#39;buy&#39;</span><span class="p">,</span> <span class="n">quotes</span><span class="p">[</span><span class="s1">&#39;bid&#39;</span><span class="p">],</span> <span class="mf">0.1</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Sell fill</span>
                    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inventory</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">inventory_limit</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">on_fill</span><span class="p">(</span><span class="s1">&#39;sell&#39;</span><span class="p">,</span> <span class="n">quotes</span><span class="p">[</span><span class="s1">&#39;ask&#39;</span><span class="p">],</span> <span class="mf">0.1</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_pnl</span><span class="p">(</span><span class="n">prices</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</code></pre></div>
<div class="md-cell"><h3>âœï¸ Exercise 15.3: Market Maker Simulator</h3>
<p>Build a more sophisticated market maker.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="c1"># Exercise 15.3</span>
<span class="k">class</span> <span class="nc">AdvancedMarketMaker</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inventory</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">orders</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;bids&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;asks&#39;</span><span class="p">:</span> <span class="p">[]}</span>
    
    <span class="k">def</span> <span class="nf">calculate_optimal_spread</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">volatility</span><span class="p">,</span> <span class="n">inventory</span><span class="p">):</span>
        <span class="c1"># TODO: Adjust spread based on volatility and inventory</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">place_orders</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mid_price</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
        <span class="c1"># TODO: Place multiple orders at different levels</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">manage_inventory_risk</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># TODO: Hedge or adjust if inventory too large</span>
        <span class="k">pass</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">AdvancedMarketMaker</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_spread</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;base_spread&#39;</span><span class="p">,</span> <span class="mf">0.001</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inventory_limit</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;inventory_limit&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inventory</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">orders</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;bids&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;asks&#39;</span><span class="p">:</span> <span class="p">[]}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pnl_history</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">calculate_optimal_spread</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">volatility</span><span class="p">,</span> <span class="n">inventory</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Widen spread in volatile markets or when inventory is high.&quot;&quot;&quot;</span>
        <span class="c1"># Volatility adjustment</span>
        <span class="n">vol_multiplier</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">volatility</span> <span class="o">*</span> <span class="mi">10</span>  <span class="c1"># Higher vol = wider spread</span>

        <span class="c1"># Inventory adjustment</span>
        <span class="n">inv_ratio</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">inventory</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">inventory_limit</span>
        <span class="n">inv_multiplier</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">inv_ratio</span> <span class="o">*</span> <span class="mf">0.5</span>

        <span class="n">optimal_spread</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_spread</span> <span class="o">*</span> <span class="n">vol_multiplier</span> <span class="o">*</span> <span class="n">inv_multiplier</span>

        <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">optimal_spread</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">)</span>  <span class="c1"># Cap at 1%</span>

    <span class="k">def</span> <span class="nf">place_orders</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mid_price</span><span class="p">,</span> <span class="n">volatility</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Place orders at multiple price levels.&quot;&quot;&quot;</span>
        <span class="n">spread</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_optimal_spread</span><span class="p">(</span><span class="n">volatility</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">inventory</span><span class="p">)</span>

        <span class="c1"># Inventory skew</span>
        <span class="n">skew</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inventory</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">inventory_limit</span><span class="p">)</span> <span class="o">*</span> <span class="n">spread</span> <span class="o">*</span> <span class="mf">0.5</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">orders</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;bids&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;asks&#39;</span><span class="p">:</span> <span class="p">[]}</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">depth</span><span class="p">):</span>
            <span class="n">level_spread</span> <span class="o">=</span> <span class="n">spread</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mf">0.2</span><span class="p">)</span>  <span class="c1"># Wider at further levels</span>

            <span class="n">bid_price</span> <span class="o">=</span> <span class="n">mid_price</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">level_spread</span><span class="o">/</span><span class="mi">2</span> <span class="o">-</span> <span class="n">skew</span><span class="p">)</span>
            <span class="n">ask_price</span> <span class="o">=</span> <span class="n">mid_price</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">level_spread</span><span class="o">/</span><span class="mi">2</span> <span class="o">-</span> <span class="n">skew</span><span class="p">)</span>

            <span class="c1"># Smaller sizes at further levels</span>
            <span class="n">size</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">orders</span><span class="p">[</span><span class="s1">&#39;bids&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="n">bid_price</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="n">size</span><span class="p">,</span> <span class="s1">&#39;level&#39;</span><span class="p">:</span> <span class="n">i</span><span class="p">})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">orders</span><span class="p">[</span><span class="s1">&#39;asks&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="n">ask_price</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="n">size</span><span class="p">,</span> <span class="s1">&#39;level&#39;</span><span class="p">:</span> <span class="n">i</span><span class="p">})</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">orders</span>

    <span class="k">def</span> <span class="nf">manage_inventory_risk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current_price</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Manage inventory risk.&quot;&quot;&quot;</span>
        <span class="n">inv_ratio</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inventory</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">inventory_limit</span>

        <span class="n">actions</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">inv_ratio</span> <span class="o">&gt;</span> <span class="mf">0.8</span><span class="p">:</span>
            <span class="c1"># High inventory - need to reduce</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inventory</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">actions</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="s1">&#39;REDUCE_LONG&#39;</span><span class="p">,</span> <span class="s1">&#39;urgency&#39;</span><span class="p">:</span> <span class="s1">&#39;HIGH&#39;</span><span class="p">})</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">actions</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="s1">&#39;REDUCE_SHORT&#39;</span><span class="p">,</span> <span class="s1">&#39;urgency&#39;</span><span class="p">:</span> <span class="s1">&#39;HIGH&#39;</span><span class="p">})</span>
        <span class="k">elif</span> <span class="n">inv_ratio</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">:</span>
            <span class="n">actions</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="s1">&#39;WIDEN_SPREAD&#39;</span><span class="p">,</span> <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="s1">&#39;Moderate inventory&#39;</span><span class="p">})</span>

        <span class="c1"># Calculate inventory PnL risk</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inventory</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">risk_1pct</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inventory</span> <span class="o">*</span> <span class="n">current_price</span> <span class="o">*</span> <span class="mf">0.01</span><span class="p">)</span>
            <span class="n">actions</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;inventory_risk_1pct_move&#39;</span><span class="p">:</span> <span class="n">risk_1pct</span><span class="p">})</span>

        <span class="k">return</span> <span class="n">actions</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>Section 4: Cross-Exchange Strategies</h1></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">CrossExchangeTrader</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Trade across multiple exchanges.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exchanges</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">balances</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="k">def</span> <span class="nf">add_exchange</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">api</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exchanges</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">api</span>
    
    <span class="k">def</span> <span class="nf">get_all_prices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get prices from all exchanges.&quot;&quot;&quot;</span>
        <span class="n">prices</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">api</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">exchanges</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ticker</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">fetch_ticker</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
                <span class="n">prices</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;bid&#39;</span><span class="p">:</span> <span class="n">ticker</span><span class="p">[</span><span class="s1">&#39;bid&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;ask&#39;</span><span class="p">:</span> <span class="n">ticker</span><span class="p">[</span><span class="s1">&#39;ask&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;last&#39;</span><span class="p">:</span> <span class="n">ticker</span><span class="p">[</span><span class="s1">&#39;last&#39;</span><span class="p">]</span>
                <span class="p">}</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">continue</span>
        <span class="k">return</span> <span class="n">prices</span>
    
    <span class="k">def</span> <span class="nf">find_price_discrepancy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">min_spread</span><span class="o">=</span><span class="mf">0.001</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Find price discrepancies between exchanges.&quot;&quot;&quot;</span>
        <span class="n">prices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_all_prices</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        
        <span class="c1"># Find best bid (where to sell) and best ask (where to buy)</span>
        <span class="n">best_bid</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">prices</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;bid&#39;</span><span class="p">])</span>
        <span class="n">best_ask</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">prices</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;ask&#39;</span><span class="p">])</span>
        
        <span class="n">spread</span> <span class="o">=</span> <span class="p">(</span><span class="n">best_bid</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;bid&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">best_ask</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;ask&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="n">best_ask</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;ask&#39;</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="n">spread</span> <span class="o">&gt;</span> <span class="n">min_spread</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s1">&#39;buy_on&#39;</span><span class="p">:</span> <span class="n">best_ask</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="s1">&#39;buy_price&#39;</span><span class="p">:</span> <span class="n">best_ask</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;ask&#39;</span><span class="p">],</span>
                <span class="s1">&#39;sell_on&#39;</span><span class="p">:</span> <span class="n">best_bid</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="s1">&#39;sell_price&#39;</span><span class="p">:</span> <span class="n">best_bid</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;bid&#39;</span><span class="p">],</span>
                <span class="s1">&#39;spread_pct&#39;</span><span class="p">:</span> <span class="n">spread</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
                <span class="s1">&#39;all_prices&#39;</span><span class="p">:</span> <span class="n">prices</span>
            <span class="p">}</span>
        <span class="k">return</span> <span class="kc">None</span>
    
    <span class="k">def</span> <span class="nf">calculate_arbitrage_profit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">opportunity</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">fees</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate net profit from cross-exchange arbitrage.</span>
<span class="sd">        </span>
<span class="sd">        fees: dict with exchange fees</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">buy_cost</span> <span class="o">=</span> <span class="n">amount</span> <span class="o">*</span> <span class="n">opportunity</span><span class="p">[</span><span class="s1">&#39;buy_price&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">fees</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">opportunity</span><span class="p">[</span><span class="s1">&#39;buy_on&#39;</span><span class="p">],</span> <span class="mf">0.001</span><span class="p">))</span>
        <span class="n">sell_revenue</span> <span class="o">=</span> <span class="n">amount</span> <span class="o">*</span> <span class="n">opportunity</span><span class="p">[</span><span class="s1">&#39;sell_price&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">fees</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">opportunity</span><span class="p">[</span><span class="s1">&#39;sell_on&#39;</span><span class="p">],</span> <span class="mf">0.001</span><span class="p">))</span>
        
        <span class="n">gross_profit</span> <span class="o">=</span> <span class="n">sell_revenue</span> <span class="o">-</span> <span class="n">buy_cost</span>
        
        <span class="c1"># Withdrawal/transfer fees</span>
        <span class="n">transfer_fee</span> <span class="o">=</span> <span class="n">fees</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;transfer&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        
        <span class="n">net_profit</span> <span class="o">=</span> <span class="n">gross_profit</span> <span class="o">-</span> <span class="n">transfer_fee</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;gross_profit&#39;</span><span class="p">:</span> <span class="n">gross_profit</span><span class="p">,</span>
            <span class="s1">&#39;net_profit&#39;</span><span class="p">:</span> <span class="n">net_profit</span><span class="p">,</span>
            <span class="s1">&#39;profitable&#39;</span><span class="p">:</span> <span class="n">net_profit</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;return_pct&#39;</span><span class="p">:</span> <span class="n">net_profit</span> <span class="o">/</span> <span class="n">buy_cost</span> <span class="o">*</span> <span class="mi">100</span>
        <span class="p">}</span>
</code></pre></div>
<div class="md-cell"><h3>âœï¸ Exercise 15.4: Cross-Exchange Monitor</h3>
<p>Build a cross-exchange monitoring system.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="c1"># Exercise 15.4</span>
<span class="k">class</span> <span class="nc">CrossExchangeMonitor</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exchanges</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">opportunities</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">def</span> <span class="nf">add_exchange</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">api</span><span class="p">):</span>
        <span class="c1"># TODO</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">scan_for_opportunities</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbols</span><span class="p">):</span>
        <span class="c1"># TODO: Scan all symbols across all exchanges</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">alert_on_opportunity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">min_profit_pct</span><span class="o">=</span><span class="mf">0.3</span><span class="p">):</span>
        <span class="c1"># TODO: Alert when profitable opportunity found</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">generate_report</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># TODO: Summary of all opportunities</span>
        <span class="k">pass</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">CrossExchangeMonitor</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exchanges</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">opportunities</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trader</span> <span class="o">=</span> <span class="n">CrossExchangeTrader</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fees</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">add_exchange</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">api</span><span class="p">,</span> <span class="n">fee</span><span class="o">=</span><span class="mf">0.001</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exchanges</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">api</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trader</span><span class="o">.</span><span class="n">add_exchange</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">api</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fees</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">fee</span>

    <span class="k">def</span> <span class="nf">scan_for_opportunities</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbols</span><span class="p">,</span> <span class="n">min_spread</span><span class="o">=</span><span class="mf">0.002</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">opportunities</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="n">symbols</span><span class="p">:</span>
            <span class="n">opp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trader</span><span class="o">.</span><span class="n">find_price_discrepancy</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">min_spread</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">opp</span><span class="p">:</span>
                <span class="c1"># Calculate profit</span>
                <span class="n">profit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trader</span><span class="o">.</span><span class="n">calculate_arbitrage_profit</span><span class="p">(</span><span class="n">opp</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fees</span><span class="p">)</span>
                <span class="n">opp</span><span class="p">[</span><span class="s1">&#39;profit_info&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">profit</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">opportunities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">opp</span><span class="p">)</span>

        <span class="c1"># Sort by spread</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">opportunities</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;spread_pct&#39;</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">opportunities</span>

    <span class="k">def</span> <span class="nf">alert_on_opportunity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">min_profit_pct</span><span class="o">=</span><span class="mf">0.3</span><span class="p">):</span>
        <span class="n">alerts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">opp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">opportunities</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">opp</span><span class="p">[</span><span class="s1">&#39;profit_info&#39;</span><span class="p">][</span><span class="s1">&#39;return_pct&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">min_profit_pct</span><span class="p">:</span>
                <span class="n">alerts</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s1">&#39;alert&#39;</span><span class="p">:</span> <span class="s1">&#39;ARBITRAGE OPPORTUNITY&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;buy&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">opp</span><span class="p">[</span><span class="s1">&#39;buy_on&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> @ </span><span class="si">{</span><span class="n">opp</span><span class="p">[</span><span class="s1">&#39;buy_price&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="s1">&#39;sell&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">opp</span><span class="p">[</span><span class="s1">&#39;sell_on&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> @ </span><span class="si">{</span><span class="n">opp</span><span class="p">[</span><span class="s1">&#39;sell_price&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="s1">&#39;profit_pct&#39;</span><span class="p">:</span> <span class="n">opp</span><span class="p">[</span><span class="s1">&#39;profit_info&#39;</span><span class="p">][</span><span class="s1">&#39;return_pct&#39;</span><span class="p">]</span>
                <span class="p">})</span>
        <span class="k">return</span> <span class="n">alerts</span>

    <span class="k">def</span> <span class="nf">generate_report</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">report</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;=&#39;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;     CROSS-EXCHANGE OPPORTUNITY REPORT&#39;</span><span class="p">)</span>
        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;=&#39;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Exchanges: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exchanges</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Opportunities found: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">opportunities</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">opp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">opportunities</span><span class="p">[:</span><span class="mi">5</span><span class="p">]):</span>
            <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s1">. Spread: </span><span class="si">{</span><span class="n">opp</span><span class="p">[</span><span class="s2">&quot;spread_pct&quot;</span><span class="p">]</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">%&#39;</span><span class="p">)</span>
            <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;   Buy on </span><span class="si">{</span><span class="n">opp</span><span class="p">[</span><span class="s2">&quot;buy_on&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1"> @ </span><span class="si">{</span><span class="n">opp</span><span class="p">[</span><span class="s2">&quot;buy_price&quot;</span><span class="p">]</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;   Sell on </span><span class="si">{</span><span class="n">opp</span><span class="p">[</span><span class="s2">&quot;sell_on&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1"> @ </span><span class="si">{</span><span class="n">opp</span><span class="p">[</span><span class="s2">&quot;sell_price&quot;</span><span class="p">]</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;   Net Profit: </span><span class="si">{</span><span class="n">opp</span><span class="p">[</span><span class="s2">&quot;profit_info&quot;</span><span class="p">][</span><span class="s2">&quot;return_pct&quot;</span><span class="p">]</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">%&#39;</span><span class="p">)</span>
            <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;=&#39;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">report</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>ğŸ—ï¸ Module Project: Advanced Strategy Toolkit</h1>
<p>Build a comprehensive advanced trading toolkit.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="c1"># Module Project</span>
<span class="k">class</span> <span class="nc">AdvancedStrategyToolkit</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">funding_tracker</span> <span class="o">=</span> <span class="n">FundingRateTracker</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options_analyzer</span> <span class="o">=</span> <span class="n">OptionsStrategyAnalyzer</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">market_maker</span> <span class="o">=</span> <span class="n">AdvancedMarketMaker</span><span class="p">({</span><span class="s1">&#39;base_spread&#39;</span><span class="p">:</span> <span class="mf">0.001</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cross_exchange</span> <span class="o">=</span> <span class="n">CrossExchangeMonitor</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">scan_all_opportunities</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># TODO: Scan funding, options, cross-exchange</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">recommend_strategy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">capital</span><span class="p">,</span> <span class="n">risk_tolerance</span><span class="p">):</span>
        <span class="c1"># TODO: Recommend best strategy based on market conditions</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">generate_daily_report</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># TODO: Comprehensive daily report</span>
        <span class="k">pass</span>
</code></pre></div>
<div class="md-cell"><hr />
<h1>ğŸ“ Key Takeaways</h1>
<ol>
<li><strong>Funding Rates</strong>: Cash and carry earns 20-100%+ APY in crypto</li>
<li><strong>Options</strong>: High volatility = expensive options, good for selling</li>
<li><strong>Market Making</strong>: Profit from spreads, manage inventory risk carefully</li>
<li><strong>Cross-Exchange</strong>: Price differences exist, but speed and fees matter</li>
</ol>
<hr />
<p><em>Part 4 Complete! Next: Capstone Project</em></p></div>
        <div class="nav-buttons">
            <button class="nav-btn prev-btn disabled" type="button">
                <span class="nav-btn-label">â† Previous</span>
                <span class="nav-btn-name"></span>
            </button>
            <button class="nav-btn next-btn disabled" type="button">
                <span class="nav-btn-label">Next â†’</span>
                <span class="nav-btn-name"></span>
            </button>
        </div>
        </div>
<div class="module-section" data-idx="16"><div class="md-cell module-header"><h1>ğŸ† Capstone Project: Complete Crypto Trading System</h1>
<h2>Course 1: Crypto Algorithmic Trading</h2>
<hr />
<div class="table-wrapper"><table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>â±ï¸ <strong>Duration</strong></td>
<td>~8-12 hours</td>
</tr>
<tr>
<td>ğŸ“‹ <strong>Prerequisites</strong></td>
<td>All modules (1-15)</td>
</tr>
<tr>
<td>ğŸ¯ <strong>Outcome</strong></td>
<td>Production-ready trading system</td>
</tr>
</tbody>
</table></div></div>
<div class="md-cell"><h2>ğŸ¯ Project Overview</h2>
<p>Build a <strong>complete crypto trading system</strong> that integrates everything you've learned:</p>
<ol>
<li><strong>Multi-Exchange Connectivity</strong> - CEX + DEX integration</li>
<li><strong>Signal Generation</strong> - Technical + on-chain signals</li>
<li><strong>DeFi Monitoring</strong> - Yield and arbitrage opportunities</li>
<li><strong>Automated Execution</strong> - Order management with safety checks</li>
<li><strong>Risk Management</strong> - Position sizing, stops, portfolio limits</li>
<li><strong>Real-Time Monitoring</strong> - Dashboard with alerts</li>
<li><strong>Performance Analytics</strong> - Tracking and reporting</li>
</ol>
<hr /></div>
<div class="md-cell"><h2>ğŸ“ Project Structure</h2>
<div class="highlight"><pre><span></span><code>crypto_trading_system/
â”œâ”€â”€ config/
â”‚   â”œâ”€â”€ settings.py
â”‚   â””â”€â”€ .env.example
â”œâ”€â”€ data/
â”‚   â”œâ”€â”€ market_data.py
â”‚   â”œâ”€â”€ onchain_data.py
â”‚   â””â”€â”€ defi_data.py
â”œâ”€â”€ strategies/
â”‚   â”œâ”€â”€ base_strategy.py
â”‚   â”œâ”€â”€ trend_strategy.py
â”‚   â”œâ”€â”€ mean_reversion.py
â”‚   â””â”€â”€ defi_strategy.py
â”œâ”€â”€ execution/
â”‚   â”œâ”€â”€ cex_executor.py
â”‚   â”œâ”€â”€ dex_executor.py
â”‚   â””â”€â”€ order_manager.py
â”œâ”€â”€ risk/
â”‚   â”œâ”€â”€ position_sizer.py
â”‚   â”œâ”€â”€ risk_manager.py
â”‚   â””â”€â”€ portfolio_manager.py
â”œâ”€â”€ monitoring/
â”‚   â”œâ”€â”€ dashboard.py
â”‚   â”œâ”€â”€ alerts.py
â”‚   â””â”€â”€ performance.py
â”œâ”€â”€ utils/
â”‚   â”œâ”€â”€ logger.py
â”‚   â””â”€â”€ helpers.py
â”œâ”€â”€ main.py
â””â”€â”€ requirements.txt
</code></pre></div></div>
<div class="md-cell"><hr />
<h1>Part 1: Core Infrastructure</h1>
<h2>1.1 Configuration Management</h2></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="c1"># config/settings.py</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">dotenv</span> <span class="kn">import</span> <span class="n">load_dotenv</span>
<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span>

<span class="n">load_dotenv</span><span class="p">()</span>

<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">ExchangeConfig</span><span class="p">:</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">api_key</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">api_secret</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">sandbox</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">rate_limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span>

<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">TradingConfig</span><span class="p">:</span>
    <span class="n">symbols</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
    <span class="n">timeframes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
    <span class="n">max_position_size</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">max_daily_loss</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">default_leverage</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span>

<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">RiskConfig</span><span class="p">:</span>
    <span class="n">max_position_pct</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span>  <span class="c1"># 10% max per position</span>
    <span class="n">max_portfolio_risk</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.2</span>  <span class="c1"># 20% max total risk</span>
    <span class="n">stop_loss_pct</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.02</span>  <span class="c1"># 2% stop loss</span>
    <span class="n">max_correlation</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.7</span>

<span class="k">class</span> <span class="nc">Settings</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Central configuration management.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exchanges</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_exchanges</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trading</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_trading_config</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">risk</span> <span class="o">=</span> <span class="n">RiskConfig</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">web3_rpc</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;ETH_RPC_URL&#39;</span><span class="p">,</span> <span class="s1">&#39;https://eth.llamarpc.com&#39;</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">_load_exchanges</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ExchangeConfig</span><span class="p">]:</span>
        <span class="n">exchanges</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="c1"># Binance</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;BINANCE_API_KEY&#39;</span><span class="p">):</span>
            <span class="n">exchanges</span><span class="p">[</span><span class="s1">&#39;binance&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ExchangeConfig</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s1">&#39;binance&#39;</span><span class="p">,</span>
                <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;BINANCE_API_KEY&#39;</span><span class="p">),</span>
                <span class="n">api_secret</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;BINANCE_API_SECRET&#39;</span><span class="p">),</span>
                <span class="n">sandbox</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;BINANCE_SANDBOX&#39;</span><span class="p">,</span> <span class="s1">&#39;true&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span>
            <span class="p">)</span>
        
        <span class="k">return</span> <span class="n">exchanges</span>
    
    <span class="k">def</span> <span class="nf">_load_trading_config</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TradingConfig</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">TradingConfig</span><span class="p">(</span>
            <span class="n">symbols</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;BTC/USDT&#39;</span><span class="p">,</span> <span class="s1">&#39;ETH/USDT&#39;</span><span class="p">],</span>
            <span class="n">timeframes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;1h&#39;</span><span class="p">,</span> <span class="s1">&#39;4h&#39;</span><span class="p">,</span> <span class="s1">&#39;1d&#39;</span><span class="p">],</span>
            <span class="n">max_position_size</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;MAX_POSITION_SIZE&#39;</span><span class="p">,</span> <span class="s1">&#39;1000&#39;</span><span class="p">)),</span>
            <span class="n">max_daily_loss</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;MAX_DAILY_LOSS&#39;</span><span class="p">,</span> <span class="s1">&#39;100&#39;</span><span class="p">))</span>
        <span class="p">)</span>

<span class="c1"># Global settings instance</span>
<span class="n">settings</span> <span class="o">=</span> <span class="n">Settings</span><span class="p">()</span>
</code></pre></div>
<div class="md-cell"><h2>1.2 Logging Setup</h2></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="c1"># utils/logger.py</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">import</span> <span class="nn">json</span>

<span class="k">class</span> <span class="nc">TradingLogger</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Structured logging for trading system.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;trading_system&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
        
        <span class="c1"># Console handler</span>
        <span class="n">console</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">()</span>
        <span class="n">console</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
        <span class="n">console</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span>
            <span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1"> | </span><span class="si">%(levelname)s</span><span class="s1"> | </span><span class="si">%(message)s</span><span class="s1">&#39;</span>
        <span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">console</span><span class="p">)</span>
        
        <span class="c1"># File handler for trades</span>
        <span class="n">trade_handler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">FileHandler</span><span class="p">(</span><span class="s1">&#39;trades.log&#39;</span><span class="p">)</span>
        <span class="n">trade_handler</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">trade_handler</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">log_trade</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trade_info</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Log trade execution.&quot;&quot;&quot;</span>
        <span class="n">trade_info</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;TRADE: </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">trade_info</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">log_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">signal_info</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Log trading signal.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SIGNAL: </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">signal_info</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">log_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">error_msg</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Log error with context.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ERROR: </span><span class="si">{</span><span class="n">error_msg</span><span class="si">}</span><span class="s2"> | Context: </span><span class="si">{</span><span class="n">context</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">log_risk_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">details</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Log risk management events.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;RISK: </span><span class="si">{</span><span class="n">event</span><span class="si">}</span><span class="s2"> | </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">details</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">TradingLogger</span><span class="p">()</span>
</code></pre></div>
<div class="md-cell"><hr />
<h1>Part 2: Data Layer</h1>
<h2>2.1 Multi-Source Market Data</h2></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="c1"># data/market_data.py</span>
<span class="kn">import</span> <span class="nn">ccxt</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="k">class</span> <span class="nc">MarketDataManager</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Unified market data from multiple exchanges.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">settings</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">settings</span> <span class="o">=</span> <span class="n">settings</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exchanges</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache_ttl</span> <span class="o">=</span> <span class="mi">5</span>  <span class="c1"># seconds</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_exchanges</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">_init_exchanges</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">config</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">exchanges</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">exchange_class</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">ccxt</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exchanges</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">exchange_class</span><span class="p">({</span>
                <span class="s1">&#39;apiKey&#39;</span><span class="p">:</span> <span class="n">config</span><span class="o">.</span><span class="n">api_key</span><span class="p">,</span>
                <span class="s1">&#39;secret&#39;</span><span class="p">:</span> <span class="n">config</span><span class="o">.</span><span class="n">api_secret</span><span class="p">,</span>
                <span class="s1">&#39;sandbox&#39;</span><span class="p">:</span> <span class="n">config</span><span class="o">.</span><span class="n">sandbox</span><span class="p">,</span>
                <span class="s1">&#39;enableRateLimit&#39;</span><span class="p">:</span> <span class="kc">True</span>
            <span class="p">})</span>
    
    <span class="k">def</span> <span class="nf">get_ticker</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">exchange</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get current ticker from best exchange.&quot;&quot;&quot;</span>
        <span class="n">exchange</span> <span class="o">=</span> <span class="n">exchange</span> <span class="ow">or</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exchanges</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
        
        <span class="n">cache_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;ticker_</span><span class="si">{</span><span class="n">exchange</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">symbol</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_cache_valid</span><span class="p">(</span><span class="n">cache_key</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">cache_key</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">]</span>
        
        <span class="n">ticker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exchanges</span><span class="p">[</span><span class="n">exchange</span><span class="p">]</span><span class="o">.</span><span class="n">fetch_ticker</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_cache</span><span class="p">(</span><span class="n">cache_key</span><span class="p">,</span> <span class="n">ticker</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span>
            <span class="s1">&#39;exchange&#39;</span><span class="p">:</span> <span class="n">exchange</span><span class="p">,</span>
            <span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="n">ticker</span><span class="p">[</span><span class="s1">&#39;last&#39;</span><span class="p">],</span>
            <span class="s1">&#39;bid&#39;</span><span class="p">:</span> <span class="n">ticker</span><span class="p">[</span><span class="s1">&#39;bid&#39;</span><span class="p">],</span>
            <span class="s1">&#39;ask&#39;</span><span class="p">:</span> <span class="n">ticker</span><span class="p">[</span><span class="s1">&#39;ask&#39;</span><span class="p">],</span>
            <span class="s1">&#39;volume&#39;</span><span class="p">:</span> <span class="n">ticker</span><span class="p">[</span><span class="s1">&#39;baseVolume&#39;</span><span class="p">],</span>
            <span class="s1">&#39;change_24h&#39;</span><span class="p">:</span> <span class="n">ticker</span><span class="p">[</span><span class="s1">&#39;percentage&#39;</span><span class="p">]</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">get_ohlcv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">timeframe</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;1h&#39;</span><span class="p">,</span> 
                  <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span> <span class="n">exchange</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get OHLCV data as DataFrame.&quot;&quot;&quot;</span>
        <span class="n">exchange</span> <span class="o">=</span> <span class="n">exchange</span> <span class="ow">or</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exchanges</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
        
        <span class="n">ohlcv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exchanges</span><span class="p">[</span><span class="n">exchange</span><span class="p">]</span><span class="o">.</span><span class="n">fetch_ohlcv</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">timeframe</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">)</span>
        
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">ohlcv</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">,</span> <span class="s1">&#39;open&#39;</span><span class="p">,</span> <span class="s1">&#39;high&#39;</span><span class="p">,</span> <span class="s1">&#39;low&#39;</span><span class="p">,</span> <span class="s1">&#39;close&#39;</span><span class="p">,</span> <span class="s1">&#39;volume&#39;</span><span class="p">])</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">],</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;ms&#39;</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;timestamp&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">df</span>
    
    <span class="k">def</span> <span class="nf">get_order_book</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span> <span class="n">exchange</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get order book data.&quot;&quot;&quot;</span>
        <span class="n">exchange</span> <span class="o">=</span> <span class="n">exchange</span> <span class="ow">or</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exchanges</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">book</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exchanges</span><span class="p">[</span><span class="n">exchange</span><span class="p">]</span><span class="o">.</span><span class="n">fetch_order_book</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">limit</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;bids&#39;</span><span class="p">:</span> <span class="n">book</span><span class="p">[</span><span class="s1">&#39;bids&#39;</span><span class="p">][:</span><span class="mi">10</span><span class="p">],</span>
            <span class="s1">&#39;asks&#39;</span><span class="p">:</span> <span class="n">book</span><span class="p">[</span><span class="s1">&#39;asks&#39;</span><span class="p">][:</span><span class="mi">10</span><span class="p">],</span>
            <span class="s1">&#39;spread&#39;</span><span class="p">:</span> <span class="n">book</span><span class="p">[</span><span class="s1">&#39;asks&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">book</span><span class="p">[</span><span class="s1">&#39;bids&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">book</span><span class="p">[</span><span class="s1">&#39;asks&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">book</span><span class="p">[</span><span class="s1">&#39;bids&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">get_multi_exchange_prices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get prices from all connected exchanges.&quot;&quot;&quot;</span>
        <span class="n">prices</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">exchange</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">exchanges</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ticker</span> <span class="o">=</span> <span class="n">exchange</span><span class="o">.</span><span class="n">fetch_ticker</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
                <span class="n">prices</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;bid&#39;</span><span class="p">:</span> <span class="n">ticker</span><span class="p">[</span><span class="s1">&#39;bid&#39;</span><span class="p">],</span> <span class="s1">&#39;ask&#39;</span><span class="p">:</span> <span class="n">ticker</span><span class="p">[</span><span class="s1">&#39;ask&#39;</span><span class="p">],</span> <span class="s1">&#39;last&#39;</span><span class="p">:</span> <span class="n">ticker</span><span class="p">[</span><span class="s1">&#39;last&#39;</span><span class="p">]}</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">continue</span>
        <span class="k">return</span> <span class="n">prices</span>
    
    <span class="k">def</span> <span class="nf">_is_cache_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">timestamp</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;time&#39;</span><span class="p">])</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_ttl</span>
    
    <span class="k">def</span> <span class="nf">_update_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">timestamp</span><span class="p">()}</span>
</code></pre></div>
<div class="md-cell"><h2>2.2 On-Chain Data Integration</h2></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="c1"># data/onchain_data.py</span>
<span class="kn">from</span> <span class="nn">web3</span> <span class="kn">import</span> <span class="n">Web3</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Optional</span>

<span class="k">class</span> <span class="nc">OnChainDataManager</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;On-chain analytics data.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rpc_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w3</span> <span class="o">=</span> <span class="n">Web3</span><span class="p">(</span><span class="n">Web3</span><span class="o">.</span><span class="n">HTTPProvider</span><span class="p">(</span><span class="n">rpc_url</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connected</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">w3</span><span class="o">.</span><span class="n">is_connected</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">get_gas_price</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get current gas prices.&quot;&quot;&quot;</span>
        <span class="n">gas_wei</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">gas_price</span>
        <span class="n">gas_gwei</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">w3</span><span class="o">.</span><span class="n">from_wei</span><span class="p">(</span><span class="n">gas_wei</span><span class="p">,</span> <span class="s1">&#39;gwei&#39;</span><span class="p">))</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;gas_gwei&#39;</span><span class="p">:</span> <span class="n">gas_gwei</span><span class="p">,</span>
            <span class="s1">&#39;fast&#39;</span><span class="p">:</span> <span class="n">gas_gwei</span> <span class="o">*</span> <span class="mf">1.2</span><span class="p">,</span>
            <span class="s1">&#39;slow&#39;</span><span class="p">:</span> <span class="n">gas_gwei</span> <span class="o">*</span> <span class="mf">0.8</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">get_whale_transactions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">min_value_eth</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">100</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Monitor large transactions (simplified).&quot;&quot;&quot;</span>
        <span class="c1"># In production, use services like Whale Alert API</span>
        <span class="k">return</span> <span class="p">[]</span>
    
    <span class="k">def</span> <span class="nf">get_exchange_flows</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get exchange inflow/outflow data.&quot;&quot;&quot;</span>
        <span class="c1"># In production, use Glassnode, CryptoQuant, etc.</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;btc_exchange_netflow&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;eth_exchange_netflow&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;interpretation&#39;</span><span class="p">:</span> <span class="s1">&#39;neutral&#39;</span>
        <span class="p">}</span>
</code></pre></div>
<div class="md-cell"><h2>2.3 DeFi Data</h2></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="c1"># data/defi_data.py</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span>

<span class="k">class</span> <span class="nc">DeFiDataManager</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;DeFi protocol data from various sources.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">llama_base</span> <span class="o">=</span> <span class="s1">&#39;https://api.llama.fi&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">yields_base</span> <span class="o">=</span> <span class="s1">&#39;https://yields.llama.fi&#39;</span>
    
    <span class="k">def</span> <span class="nf">get_top_yields</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">min_tvl</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">1_000_000</span><span class="p">,</span> <span class="n">max_results</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Get top yield opportunities.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">yields_base</span><span class="si">}</span><span class="s1">/pools&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">[]</span>
            
            <span class="n">pools</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="p">[])</span>
            
            <span class="c1"># Filter and sort</span>
            <span class="n">filtered</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s1">&#39;pool&#39;</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pool&#39;</span><span class="p">),</span>
                    <span class="s1">&#39;project&#39;</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;project&#39;</span><span class="p">),</span>
                    <span class="s1">&#39;chain&#39;</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;chain&#39;</span><span class="p">),</span>
                    <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;symbol&#39;</span><span class="p">),</span>
                    <span class="s1">&#39;tvl&#39;</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tvlUsd&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                    <span class="s1">&#39;apy&#39;</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;apy&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="p">}</span>
                <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pools</span>
                <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tvlUsd&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">min_tvl</span> <span class="ow">and</span> <span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;apy&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="p">]</span>
            
            <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">filtered</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;apy&#39;</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)[:</span><span class="n">max_results</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>
    
    <span class="k">def</span> <span class="nf">get_protocol_tvl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">protocol</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get TVL for specific protocol.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">llama_base</span><span class="si">}</span><span class="s1">/protocol/</span><span class="si">{</span><span class="n">protocol</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
                <span class="k">return</span> <span class="p">{</span>
                    <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">),</span>
                    <span class="s1">&#39;tvl&#39;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tvl&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                    <span class="s1">&#39;chains&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;chainTvls&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                <span class="p">}</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">return</span> <span class="p">{}</span>
</code></pre></div>
<div class="md-cell"><hr />
<h1>Part 3: Strategy Engine</h1>
<h2>3.1 Base Strategy Class</h2></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="c1"># strategies/base_strategy.py</span>
<span class="kn">from</span> <span class="nn">abc</span> <span class="kn">import</span> <span class="n">ABC</span><span class="p">,</span> <span class="n">abstractmethod</span>
<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Dict</span>
<span class="kn">from</span> <span class="nn">enum</span> <span class="kn">import</span> <span class="n">Enum</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="k">class</span> <span class="nc">SignalType</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
    <span class="n">BUY</span> <span class="o">=</span> <span class="s1">&#39;buy&#39;</span>
    <span class="n">SELL</span> <span class="o">=</span> <span class="s1">&#39;sell&#39;</span>
    <span class="n">HOLD</span> <span class="o">=</span> <span class="s1">&#39;hold&#39;</span>

<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">Signal</span><span class="p">:</span>
    <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">signal_type</span><span class="p">:</span> <span class="n">SignalType</span>
    <span class="n">strength</span><span class="p">:</span> <span class="nb">float</span>  <span class="c1"># 0-1</span>
    <span class="n">price</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">stop_loss</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">take_profit</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">metadata</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="kc">None</span>

<span class="k">class</span> <span class="nc">BaseStrategy</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Base class for all trading strategies.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">params</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">signals_generated</span> <span class="o">=</span> <span class="mi">0</span>
    
    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">generate_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Signal</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Generate trading signal from data.&quot;&quot;&quot;</span>
        <span class="k">pass</span>
    
    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">calculate_indicators</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate strategy-specific indicators.&quot;&quot;&quot;</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">validate_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">signal</span><span class="p">:</span> <span class="n">Signal</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Validate signal before returning.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">signal</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">signal</span><span class="o">.</span><span class="n">strength</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;min_strength&#39;</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span>
</code></pre></div>
<div class="md-cell"><h2>3.2 Trend Following Strategy</h2></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="c1"># strategies/trend_strategy.py</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span>

<span class="k">class</span> <span class="nc">TrendStrategy</span><span class="p">(</span><span class="n">BaseStrategy</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Trend following using multiple moving averages.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">default_params</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;fast_ma&#39;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
            <span class="s1">&#39;slow_ma&#39;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span>
            <span class="s1">&#39;atr_period&#39;</span><span class="p">:</span> <span class="mi">14</span><span class="p">,</span>
            <span class="s1">&#39;atr_multiplier&#39;</span><span class="p">:</span> <span class="mf">2.0</span><span class="p">,</span>
            <span class="s1">&#39;min_strength&#39;</span><span class="p">:</span> <span class="mf">0.6</span>
        <span class="p">}</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">default_params</span><span class="p">,</span> <span class="o">**</span><span class="p">(</span><span class="n">params</span> <span class="ow">or</span> <span class="p">{})}</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s1">&#39;TrendFollowing&#39;</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">calculate_indicators</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        
        <span class="c1"># Moving averages</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;fast_ma&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;fast_ma&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;slow_ma&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;slow_ma&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        
        <span class="c1"># ATR for stops</span>
        <span class="n">high_low</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;high&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;low&#39;</span><span class="p">]</span>
        <span class="n">high_close</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;high&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">())</span>
        <span class="n">low_close</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;low&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">())</span>
        <span class="n">tr</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">high_low</span><span class="p">,</span> <span class="n">high_close</span><span class="p">,</span> <span class="n">low_close</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;atr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tr</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;atr_period&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        
        <span class="c1"># Trend strength</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;trend&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;fast_ma&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;slow_ma&#39;</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;ma_diff&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;fast_ma&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;slow_ma&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;slow_ma&#39;</span><span class="p">]</span>
        
        <span class="k">return</span> <span class="n">df</span>
    
    <span class="k">def</span> <span class="nf">generate_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Signal</span><span class="p">]:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_indicators</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;slow_ma&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        
        <span class="n">current</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">previous</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
        
        <span class="c1"># Crossover detection</span>
        <span class="n">bullish_cross</span> <span class="o">=</span> <span class="n">previous</span><span class="p">[</span><span class="s1">&#39;fast_ma&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">previous</span><span class="p">[</span><span class="s1">&#39;slow_ma&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">current</span><span class="p">[</span><span class="s1">&#39;fast_ma&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">current</span><span class="p">[</span><span class="s1">&#39;slow_ma&#39;</span><span class="p">]</span>
        <span class="n">bearish_cross</span> <span class="o">=</span> <span class="n">previous</span><span class="p">[</span><span class="s1">&#39;fast_ma&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">previous</span><span class="p">[</span><span class="s1">&#39;slow_ma&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">current</span><span class="p">[</span><span class="s1">&#39;fast_ma&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">current</span><span class="p">[</span><span class="s1">&#39;slow_ma&#39;</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="n">bullish_cross</span><span class="p">:</span>
            <span class="n">strength</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">current</span><span class="p">[</span><span class="s1">&#39;ma_diff&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="mi">10</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
            <span class="n">stop_loss</span> <span class="o">=</span> <span class="n">current</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">current</span><span class="p">[</span><span class="s1">&#39;atr&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;atr_multiplier&#39;</span><span class="p">]</span>
            <span class="n">take_profit</span> <span class="o">=</span> <span class="n">current</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">current</span><span class="p">[</span><span class="s1">&#39;atr&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;atr_multiplier&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span>
            
            <span class="n">signal</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">(</span>
                <span class="n">symbol</span><span class="o">=</span><span class="n">symbol</span><span class="p">,</span>
                <span class="n">signal_type</span><span class="o">=</span><span class="n">SignalType</span><span class="o">.</span><span class="n">BUY</span><span class="p">,</span>
                <span class="n">strength</span><span class="o">=</span><span class="n">strength</span><span class="p">,</span>
                <span class="n">price</span><span class="o">=</span><span class="n">current</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">],</span>
                <span class="n">stop_loss</span><span class="o">=</span><span class="n">stop_loss</span><span class="p">,</span>
                <span class="n">take_profit</span><span class="o">=</span><span class="n">take_profit</span><span class="p">,</span>
                <span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;strategy&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;ma_diff&#39;</span><span class="p">:</span> <span class="n">current</span><span class="p">[</span><span class="s1">&#39;ma_diff&#39;</span><span class="p">]}</span>
            <span class="p">)</span>
            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_signal</span><span class="p">(</span><span class="n">signal</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">signals_generated</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">return</span> <span class="n">signal</span>
        
        <span class="k">elif</span> <span class="n">bearish_cross</span><span class="p">:</span>
            <span class="n">strength</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">current</span><span class="p">[</span><span class="s1">&#39;ma_diff&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="mi">10</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
            <span class="n">stop_loss</span> <span class="o">=</span> <span class="n">current</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">current</span><span class="p">[</span><span class="s1">&#39;atr&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;atr_multiplier&#39;</span><span class="p">]</span>
            <span class="n">take_profit</span> <span class="o">=</span> <span class="n">current</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">current</span><span class="p">[</span><span class="s1">&#39;atr&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;atr_multiplier&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span>
            
            <span class="n">signal</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">(</span>
                <span class="n">symbol</span><span class="o">=</span><span class="n">symbol</span><span class="p">,</span>
                <span class="n">signal_type</span><span class="o">=</span><span class="n">SignalType</span><span class="o">.</span><span class="n">SELL</span><span class="p">,</span>
                <span class="n">strength</span><span class="o">=</span><span class="n">strength</span><span class="p">,</span>
                <span class="n">price</span><span class="o">=</span><span class="n">current</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">],</span>
                <span class="n">stop_loss</span><span class="o">=</span><span class="n">stop_loss</span><span class="p">,</span>
                <span class="n">take_profit</span><span class="o">=</span><span class="n">take_profit</span><span class="p">,</span>
                <span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;strategy&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;ma_diff&#39;</span><span class="p">:</span> <span class="n">current</span><span class="p">[</span><span class="s1">&#39;ma_diff&#39;</span><span class="p">]}</span>
            <span class="p">)</span>
            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_signal</span><span class="p">(</span><span class="n">signal</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">signals_generated</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">return</span> <span class="n">signal</span>
        
        <span class="k">return</span> <span class="kc">None</span>
</code></pre></div>
<div class="md-cell"><h2>3.3 Mean Reversion Strategy</h2></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="c1"># strategies/mean_reversion.py</span>

<span class="k">class</span> <span class="nc">MeanReversionStrategy</span><span class="p">(</span><span class="n">BaseStrategy</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Mean reversion using RSI and Bollinger Bands.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">default_params</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;rsi_period&#39;</span><span class="p">:</span> <span class="mi">14</span><span class="p">,</span>
            <span class="s1">&#39;rsi_oversold&#39;</span><span class="p">:</span> <span class="mi">30</span><span class="p">,</span>
            <span class="s1">&#39;rsi_overbought&#39;</span><span class="p">:</span> <span class="mi">70</span><span class="p">,</span>
            <span class="s1">&#39;bb_period&#39;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
            <span class="s1">&#39;bb_std&#39;</span><span class="p">:</span> <span class="mf">2.0</span><span class="p">,</span>
            <span class="s1">&#39;min_strength&#39;</span><span class="p">:</span> <span class="mf">0.6</span>
        <span class="p">}</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">default_params</span><span class="p">,</span> <span class="o">**</span><span class="p">(</span><span class="n">params</span> <span class="ow">or</span> <span class="p">{})}</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s1">&#39;MeanReversion&#39;</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">calculate_indicators</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        
        <span class="c1"># RSI</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span>
        <span class="n">gain</span> <span class="o">=</span> <span class="n">delta</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">delta</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;rsi_period&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">delta</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">delta</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;rsi_period&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">rs</span> <span class="o">=</span> <span class="n">gain</span> <span class="o">/</span> <span class="n">loss</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;rsi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">-</span> <span class="p">(</span><span class="mi">100</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">rs</span><span class="p">))</span>
        
        <span class="c1"># Bollinger Bands</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;bb_mid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;bb_period&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;bb_std&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;bb_period&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;bb_upper&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;bb_mid&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;bb_std&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;bb_std&#39;</span><span class="p">]</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;bb_lower&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;bb_mid&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;bb_std&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;bb_std&#39;</span><span class="p">]</span>
        
        <span class="c1"># BB position (0 = at lower, 1 = at upper)</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;bb_position&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;bb_lower&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;bb_upper&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;bb_lower&#39;</span><span class="p">])</span>
        
        <span class="k">return</span> <span class="n">df</span>
    
    <span class="k">def</span> <span class="nf">generate_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Signal</span><span class="p">]:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_indicators</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;bb_period&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        
        <span class="n">current</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        
        <span class="c1"># Oversold condition</span>
        <span class="k">if</span> <span class="n">current</span><span class="p">[</span><span class="s1">&#39;rsi&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;rsi_oversold&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">current</span><span class="p">[</span><span class="s1">&#39;bb_position&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.1</span><span class="p">:</span>
            <span class="n">strength</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;rsi_oversold&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">current</span><span class="p">[</span><span class="s1">&#39;rsi&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;rsi_oversold&#39;</span><span class="p">]</span>
            
            <span class="n">signal</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">(</span>
                <span class="n">symbol</span><span class="o">=</span><span class="n">symbol</span><span class="p">,</span>
                <span class="n">signal_type</span><span class="o">=</span><span class="n">SignalType</span><span class="o">.</span><span class="n">BUY</span><span class="p">,</span>
                <span class="n">strength</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="n">strength</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span>
                <span class="n">price</span><span class="o">=</span><span class="n">current</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">],</span>
                <span class="n">stop_loss</span><span class="o">=</span><span class="n">current</span><span class="p">[</span><span class="s1">&#39;bb_lower&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.98</span><span class="p">,</span>
                <span class="n">take_profit</span><span class="o">=</span><span class="n">current</span><span class="p">[</span><span class="s1">&#39;bb_mid&#39;</span><span class="p">],</span>
                <span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;strategy&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;rsi&#39;</span><span class="p">:</span> <span class="n">current</span><span class="p">[</span><span class="s1">&#39;rsi&#39;</span><span class="p">],</span> <span class="s1">&#39;bb_pos&#39;</span><span class="p">:</span> <span class="n">current</span><span class="p">[</span><span class="s1">&#39;bb_position&#39;</span><span class="p">]}</span>
            <span class="p">)</span>
            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_signal</span><span class="p">(</span><span class="n">signal</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">signal</span>
        
        <span class="c1"># Overbought condition</span>
        <span class="k">elif</span> <span class="n">current</span><span class="p">[</span><span class="s1">&#39;rsi&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;rsi_overbought&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">current</span><span class="p">[</span><span class="s1">&#39;bb_position&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.9</span><span class="p">:</span>
            <span class="n">strength</span> <span class="o">=</span> <span class="p">(</span><span class="n">current</span><span class="p">[</span><span class="s1">&#39;rsi&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;rsi_overbought&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="mi">100</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;rsi_overbought&#39;</span><span class="p">])</span>
            
            <span class="n">signal</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">(</span>
                <span class="n">symbol</span><span class="o">=</span><span class="n">symbol</span><span class="p">,</span>
                <span class="n">signal_type</span><span class="o">=</span><span class="n">SignalType</span><span class="o">.</span><span class="n">SELL</span><span class="p">,</span>
                <span class="n">strength</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="n">strength</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span>
                <span class="n">price</span><span class="o">=</span><span class="n">current</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">],</span>
                <span class="n">stop_loss</span><span class="o">=</span><span class="n">current</span><span class="p">[</span><span class="s1">&#39;bb_upper&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1.02</span><span class="p">,</span>
                <span class="n">take_profit</span><span class="o">=</span><span class="n">current</span><span class="p">[</span><span class="s1">&#39;bb_mid&#39;</span><span class="p">],</span>
                <span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;strategy&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;rsi&#39;</span><span class="p">:</span> <span class="n">current</span><span class="p">[</span><span class="s1">&#39;rsi&#39;</span><span class="p">],</span> <span class="s1">&#39;bb_pos&#39;</span><span class="p">:</span> <span class="n">current</span><span class="p">[</span><span class="s1">&#39;bb_position&#39;</span><span class="p">]}</span>
            <span class="p">)</span>
            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_signal</span><span class="p">(</span><span class="n">signal</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">signal</span>
        
        <span class="k">return</span> <span class="kc">None</span>
</code></pre></div>
<div class="md-cell"><h2>3.4 Strategy Manager</h2></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="c1"># strategies/strategy_manager.py</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Optional</span>

<span class="k">class</span> <span class="nc">StrategyManager</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Manage multiple strategies and combine signals.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">strategies</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">BaseStrategy</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="k">def</span> <span class="nf">add_strategy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">strategy</span><span class="p">:</span> <span class="n">BaseStrategy</span><span class="p">,</span> <span class="n">weight</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">strategies</span><span class="p">[</span><span class="n">strategy</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">strategy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">[</span><span class="n">strategy</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">weight</span>
    
    <span class="k">def</span> <span class="nf">get_signals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Signal</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Get signals from all strategies.&quot;&quot;&quot;</span>
        <span class="n">signals</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">strategy</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">strategies</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">signal</span> <span class="o">=</span> <span class="n">strategy</span><span class="o">.</span><span class="n">generate_signal</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">symbol</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">signal</span><span class="p">:</span>
                <span class="n">signal</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;weight&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
                <span class="n">signals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">signal</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">signals</span>
    
    <span class="k">def</span> <span class="nf">get_combined_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Signal</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Combine signals from all strategies.&quot;&quot;&quot;</span>
        <span class="n">signals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_signals</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">symbol</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">signals</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        
        <span class="c1"># Weight signals</span>
        <span class="n">buy_score</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">sell_score</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">total_weight</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="k">for</span> <span class="n">signal</span> <span class="ow">in</span> <span class="n">signals</span><span class="p">:</span>
            <span class="n">weight</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;weight&#39;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">signal</span><span class="o">.</span><span class="n">signal_type</span> <span class="o">==</span> <span class="n">SignalType</span><span class="o">.</span><span class="n">BUY</span><span class="p">:</span>
                <span class="n">buy_score</span> <span class="o">+=</span> <span class="n">signal</span><span class="o">.</span><span class="n">strength</span> <span class="o">*</span> <span class="n">weight</span>
            <span class="k">elif</span> <span class="n">signal</span><span class="o">.</span><span class="n">signal_type</span> <span class="o">==</span> <span class="n">SignalType</span><span class="o">.</span><span class="n">SELL</span><span class="p">:</span>
                <span class="n">sell_score</span> <span class="o">+=</span> <span class="n">signal</span><span class="o">.</span><span class="n">strength</span> <span class="o">*</span> <span class="n">weight</span>
            <span class="n">total_weight</span> <span class="o">+=</span> <span class="n">weight</span>
        
        <span class="k">if</span> <span class="n">total_weight</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        
        <span class="c1"># Determine combined signal</span>
        <span class="n">buy_score</span> <span class="o">/=</span> <span class="n">total_weight</span>
        <span class="n">sell_score</span> <span class="o">/=</span> <span class="n">total_weight</span>
        
        <span class="k">if</span> <span class="n">buy_score</span> <span class="o">&gt;</span> <span class="n">sell_score</span> <span class="ow">and</span> <span class="n">buy_score</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">:</span>
            <span class="c1"># Use average of buy signals for stops</span>
            <span class="n">buy_signals</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">signals</span> <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">signal_type</span> <span class="o">==</span> <span class="n">SignalType</span><span class="o">.</span><span class="n">BUY</span><span class="p">]</span>
            <span class="n">avg_stop</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">stop_loss</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">buy_signals</span> <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">stop_loss</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">buy_signals</span><span class="p">)</span>
            <span class="n">avg_tp</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">take_profit</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">buy_signals</span> <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">take_profit</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">buy_signals</span><span class="p">)</span>
            
            <span class="k">return</span> <span class="n">Signal</span><span class="p">(</span>
                <span class="n">symbol</span><span class="o">=</span><span class="n">symbol</span><span class="p">,</span>
                <span class="n">signal_type</span><span class="o">=</span><span class="n">SignalType</span><span class="o">.</span><span class="n">BUY</span><span class="p">,</span>
                <span class="n">strength</span><span class="o">=</span><span class="n">buy_score</span><span class="p">,</span>
                <span class="n">price</span><span class="o">=</span><span class="n">signals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">price</span><span class="p">,</span>
                <span class="n">stop_loss</span><span class="o">=</span><span class="n">avg_stop</span><span class="p">,</span>
                <span class="n">take_profit</span><span class="o">=</span><span class="n">avg_tp</span><span class="p">,</span>
                <span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;combined&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;strategies&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;strategy&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">buy_signals</span><span class="p">]}</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">sell_score</span> <span class="o">&gt;</span> <span class="n">buy_score</span> <span class="ow">and</span> <span class="n">sell_score</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">:</span>
            <span class="n">sell_signals</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">signals</span> <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">signal_type</span> <span class="o">==</span> <span class="n">SignalType</span><span class="o">.</span><span class="n">SELL</span><span class="p">]</span>
            <span class="n">avg_stop</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">stop_loss</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sell_signals</span> <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">stop_loss</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">sell_signals</span><span class="p">)</span>
            <span class="n">avg_tp</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">take_profit</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sell_signals</span> <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">take_profit</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">sell_signals</span><span class="p">)</span>
            
            <span class="k">return</span> <span class="n">Signal</span><span class="p">(</span>
                <span class="n">symbol</span><span class="o">=</span><span class="n">symbol</span><span class="p">,</span>
                <span class="n">signal_type</span><span class="o">=</span><span class="n">SignalType</span><span class="o">.</span><span class="n">SELL</span><span class="p">,</span>
                <span class="n">strength</span><span class="o">=</span><span class="n">sell_score</span><span class="p">,</span>
                <span class="n">price</span><span class="o">=</span><span class="n">signals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">price</span><span class="p">,</span>
                <span class="n">stop_loss</span><span class="o">=</span><span class="n">avg_stop</span><span class="p">,</span>
                <span class="n">take_profit</span><span class="o">=</span><span class="n">avg_tp</span><span class="p">,</span>
                <span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;combined&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;strategies&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;strategy&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sell_signals</span><span class="p">]}</span>
            <span class="p">)</span>
        
        <span class="k">return</span> <span class="kc">None</span>
</code></pre></div>
<div class="md-cell"><hr />
<h1>Part 4: Execution Engine</h1>
<h2>4.1 Order Manager</h2></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="c1"># execution/order_manager.py</span>
<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">enum</span> <span class="kn">import</span> <span class="n">Enum</span>

<span class="k">class</span> <span class="nc">OrderStatus</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
    <span class="n">PENDING</span> <span class="o">=</span> <span class="s1">&#39;pending&#39;</span>
    <span class="n">OPEN</span> <span class="o">=</span> <span class="s1">&#39;open&#39;</span>
    <span class="n">FILLED</span> <span class="o">=</span> <span class="s1">&#39;filled&#39;</span>
    <span class="n">CANCELLED</span> <span class="o">=</span> <span class="s1">&#39;cancelled&#39;</span>
    <span class="n">FAILED</span> <span class="o">=</span> <span class="s1">&#39;failed&#39;</span>

<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">Order</span><span class="p">:</span>
    <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">side</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">order_type</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">amount</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">price</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span>
    <span class="n">status</span><span class="p">:</span> <span class="n">OrderStatus</span>
    <span class="n">created_at</span><span class="p">:</span> <span class="n">datetime</span>
    <span class="n">filled_at</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">datetime</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">filled_price</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">exchange</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;binance&#39;</span>

<span class="k">class</span> <span class="nc">OrderManager</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Manage order lifecycle.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exchange</span><span class="p">,</span> <span class="n">logger</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span> <span class="o">=</span> <span class="n">exchange</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logger</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">orders</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Order</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pending_orders</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">def</span> <span class="nf">create_market_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">side</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">amount</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Order</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Create and submit market order.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="o">.</span><span class="n">create_market_order</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">side</span><span class="p">,</span> <span class="n">amount</span><span class="p">)</span>
            
            <span class="n">order</span> <span class="o">=</span> <span class="n">Order</span><span class="p">(</span>
                <span class="nb">id</span><span class="o">=</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span>
                <span class="n">symbol</span><span class="o">=</span><span class="n">symbol</span><span class="p">,</span>
                <span class="n">side</span><span class="o">=</span><span class="n">side</span><span class="p">,</span>
                <span class="n">order_type</span><span class="o">=</span><span class="s1">&#39;market&#39;</span><span class="p">,</span>
                <span class="n">amount</span><span class="o">=</span><span class="n">amount</span><span class="p">,</span>
                <span class="n">price</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">status</span><span class="o">=</span><span class="n">OrderStatus</span><span class="o">.</span><span class="n">FILLED</span><span class="p">,</span>
                <span class="n">created_at</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
                <span class="n">filled_at</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
                <span class="n">filled_price</span><span class="o">=</span><span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;average&#39;</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;price&#39;</span><span class="p">))</span>
            <span class="p">)</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">orders</span><span class="p">[</span><span class="n">order</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">order</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log_trade</span><span class="p">({</span>
                <span class="s1">&#39;order_id&#39;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span>
                <span class="s1">&#39;side&#39;</span><span class="p">:</span> <span class="n">side</span><span class="p">,</span>
                <span class="s1">&#39;amount&#39;</span><span class="p">:</span> <span class="n">amount</span><span class="p">,</span>
                <span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">filled_price</span>
            <span class="p">})</span>
            
            <span class="k">return</span> <span class="n">order</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log_error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Order failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span> <span class="s1">&#39;side&#39;</span><span class="p">:</span> <span class="n">side</span><span class="p">})</span>
            <span class="k">raise</span>
    
    <span class="k">def</span> <span class="nf">create_limit_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">side</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">amount</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">price</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Order</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Create limit order.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="o">.</span><span class="n">create_limit_order</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">side</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">price</span><span class="p">)</span>
            
            <span class="n">order</span> <span class="o">=</span> <span class="n">Order</span><span class="p">(</span>
                <span class="nb">id</span><span class="o">=</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span>
                <span class="n">symbol</span><span class="o">=</span><span class="n">symbol</span><span class="p">,</span>
                <span class="n">side</span><span class="o">=</span><span class="n">side</span><span class="p">,</span>
                <span class="n">order_type</span><span class="o">=</span><span class="s1">&#39;limit&#39;</span><span class="p">,</span>
                <span class="n">amount</span><span class="o">=</span><span class="n">amount</span><span class="p">,</span>
                <span class="n">price</span><span class="o">=</span><span class="n">price</span><span class="p">,</span>
                <span class="n">status</span><span class="o">=</span><span class="n">OrderStatus</span><span class="o">.</span><span class="n">OPEN</span><span class="p">,</span>
                <span class="n">created_at</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
            <span class="p">)</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">orders</span><span class="p">[</span><span class="n">order</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">order</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pending_orders</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">order</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
            
            <span class="k">return</span> <span class="n">order</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log_error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Limit order failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">})</span>
            <span class="k">raise</span>
    
    <span class="k">def</span> <span class="nf">cancel_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Cancel an open order.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="o">.</span><span class="n">cancel_order</span><span class="p">(</span><span class="n">order_id</span><span class="p">,</span> <span class="n">symbol</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">order_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">orders</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">orders</span><span class="p">[</span><span class="n">order_id</span><span class="p">]</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">OrderStatus</span><span class="o">.</span><span class="n">CANCELLED</span>
            <span class="k">if</span> <span class="n">order_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pending_orders</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pending_orders</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">order_id</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log_error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Cancel failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;order_id&#39;</span><span class="p">:</span> <span class="n">order_id</span><span class="p">})</span>
            <span class="k">return</span> <span class="kc">False</span>
    
    <span class="k">def</span> <span class="nf">update_order_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update status of pending order.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="o">.</span><span class="n">fetch_order</span><span class="p">(</span><span class="n">order_id</span><span class="p">,</span> <span class="n">symbol</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">order_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">orders</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;closed&#39;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">orders</span><span class="p">[</span><span class="n">order_id</span><span class="p">]</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">OrderStatus</span><span class="o">.</span><span class="n">FILLED</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">orders</span><span class="p">[</span><span class="n">order_id</span><span class="p">]</span><span class="o">.</span><span class="n">filled_at</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">orders</span><span class="p">[</span><span class="n">order_id</span><span class="p">]</span><span class="o">.</span><span class="n">filled_price</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;average&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">order_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pending_orders</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">pending_orders</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">order_id</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log_error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Status update failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;order_id&#39;</span><span class="p">:</span> <span class="n">order_id</span><span class="p">})</span>
</code></pre></div>
<div class="md-cell"><hr />
<h1>Part 5: Risk Management</h1>
<h2>5.1 Position Sizer</h2></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="c1"># risk/position_sizer.py</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span>

<span class="k">class</span> <span class="nc">PositionSizer</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Calculate position sizes based on risk parameters.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_position_pct</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">max_position_pct</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_risk_per_trade</span> <span class="o">=</span> <span class="mf">0.02</span>  <span class="c1"># 2% risk per trade</span>
    
    <span class="k">def</span> <span class="nf">calculate_position_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">capital</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">entry_price</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                                  <span class="n">stop_loss</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">signal_strength</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate position size based on risk.</span>
<span class="sd">        </span>
<span class="sd">        Uses the formula: Position = (Capital * Risk%) / (Entry - Stop)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Risk amount</span>
        <span class="n">risk_amount</span> <span class="o">=</span> <span class="n">capital</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_risk_per_trade</span> <span class="o">*</span> <span class="n">signal_strength</span>
        
        <span class="c1"># Distance to stop</span>
        <span class="n">stop_distance</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">entry_price</span> <span class="o">-</span> <span class="n">stop_loss</span><span class="p">)</span>
        <span class="n">stop_pct</span> <span class="o">=</span> <span class="n">stop_distance</span> <span class="o">/</span> <span class="n">entry_price</span>
        
        <span class="k">if</span> <span class="n">stop_distance</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Invalid stop loss&#39;</span><span class="p">}</span>
        
        <span class="c1"># Position size in units</span>
        <span class="n">position_units</span> <span class="o">=</span> <span class="n">risk_amount</span> <span class="o">/</span> <span class="n">stop_distance</span>
        <span class="n">position_value</span> <span class="o">=</span> <span class="n">position_units</span> <span class="o">*</span> <span class="n">entry_price</span>
        
        <span class="c1"># Apply maximum position limit</span>
        <span class="n">max_position</span> <span class="o">=</span> <span class="n">capital</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_position_pct</span>
        <span class="k">if</span> <span class="n">position_value</span> <span class="o">&gt;</span> <span class="n">max_position</span><span class="p">:</span>
            <span class="n">position_value</span> <span class="o">=</span> <span class="n">max_position</span>
            <span class="n">position_units</span> <span class="o">=</span> <span class="n">position_value</span> <span class="o">/</span> <span class="n">entry_price</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="n">position_units</span><span class="p">,</span>
            <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">position_value</span><span class="p">,</span>
            <span class="s1">&#39;risk_amount&#39;</span><span class="p">:</span> <span class="nb">min</span><span class="p">(</span><span class="n">risk_amount</span><span class="p">,</span> <span class="n">position_value</span> <span class="o">*</span> <span class="n">stop_pct</span><span class="p">),</span>
            <span class="s1">&#39;risk_pct&#39;</span><span class="p">:</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_risk_per_trade</span><span class="p">,</span> <span class="n">position_value</span> <span class="o">*</span> <span class="n">stop_pct</span> <span class="o">/</span> <span class="n">capital</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
            <span class="s1">&#39;position_pct&#39;</span><span class="p">:</span> <span class="n">position_value</span> <span class="o">/</span> <span class="n">capital</span> <span class="o">*</span> <span class="mi">100</span>
        <span class="p">}</span>
</code></pre></div>
<div class="md-cell"><h2>5.2 Risk Manager</h2></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="c1"># risk/risk_manager.py</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>

<span class="k">class</span> <span class="nc">RiskManager</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Central risk management.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">logger</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logger</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">daily_pnl</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">daily_trades</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_reset</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">position_tracker</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="k">def</span> <span class="nf">can_trade</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">signal</span><span class="p">,</span> <span class="n">current_positions</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Check if trade is allowed based on risk rules.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_daily_reset</span><span class="p">()</span>
        
        <span class="n">checks</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;allowed&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s1">&#39;reasons&#39;</span><span class="p">:</span> <span class="p">[]</span>
        <span class="p">}</span>
        
        <span class="c1"># Check daily loss limit</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">daily_pnl</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">max_daily_loss</span><span class="p">:</span>
            <span class="n">checks</span><span class="p">[</span><span class="s1">&#39;allowed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">checks</span><span class="p">[</span><span class="s1">&#39;reasons&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Daily loss limit reached: $</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">daily_pnl</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log_risk_event</span><span class="p">(</span><span class="s1">&#39;DAILY_LOSS_LIMIT&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;pnl&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">daily_pnl</span><span class="p">})</span>
        
        <span class="c1"># Check if already in position for this symbol</span>
        <span class="k">if</span> <span class="n">signal</span><span class="o">.</span><span class="n">symbol</span> <span class="ow">in</span> <span class="n">current_positions</span><span class="p">:</span>
            <span class="n">existing</span> <span class="o">=</span> <span class="n">current_positions</span><span class="p">[</span><span class="n">signal</span><span class="o">.</span><span class="n">symbol</span><span class="p">]</span>
            <span class="c1"># Don&#39;t add to losing positions</span>
            <span class="k">if</span> <span class="n">existing</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;unrealized_pnl&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">checks</span><span class="p">[</span><span class="s1">&#39;allowed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">checks</span><span class="p">[</span><span class="s1">&#39;reasons&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Already in losing position for this symbol&#39;</span><span class="p">)</span>
        
        <span class="c1"># Check portfolio concentration</span>
        <span class="n">total_exposure</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">current_positions</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">total_exposure</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">max_portfolio_risk</span><span class="p">:</span>
            <span class="n">checks</span><span class="p">[</span><span class="s1">&#39;allowed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">checks</span><span class="p">[</span><span class="s1">&#39;reasons&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Portfolio exposure limit reached&#39;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">checks</span>
    
    <span class="k">def</span> <span class="nf">record_trade_result</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pnl</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Record trade PnL.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">daily_pnl</span> <span class="o">+=</span> <span class="n">pnl</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">daily_trades</span> <span class="o">+=</span> <span class="mi">1</span>
    
    <span class="k">def</span> <span class="nf">check_stop_loss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">position</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">current_price</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Check if stop loss is hit.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">position</span><span class="p">[</span><span class="s1">&#39;side&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;long&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">current_price</span> <span class="o">&lt;=</span> <span class="n">position</span><span class="p">[</span><span class="s1">&#39;stop_loss&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">current_price</span> <span class="o">&gt;=</span> <span class="n">position</span><span class="p">[</span><span class="s1">&#39;stop_loss&#39;</span><span class="p">]</span>
    
    <span class="k">def</span> <span class="nf">_check_daily_reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Reset daily counters if new day.&quot;&quot;&quot;</span>
        <span class="n">today</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">today</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_reset</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">daily_pnl</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">daily_trades</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">last_reset</span> <span class="o">=</span> <span class="n">today</span>
</code></pre></div>
<div class="md-cell"><hr />
<h1>Part 6: Monitoring &amp; Dashboard</h1>
<h2>6.1 Performance Tracker</h2></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="c1"># monitoring/performance.py</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>

<span class="k">class</span> <span class="nc">PerformanceTracker</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Track and analyze trading performance.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">initial_capital</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initial_capital</span> <span class="o">=</span> <span class="n">initial_capital</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_capital</span> <span class="o">=</span> <span class="n">initial_capital</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trades</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">equity_curve</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">initial_capital</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">daily_returns</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">def</span> <span class="nf">record_trade</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trade</span><span class="p">:</span> <span class="n">Dict</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Record completed trade.&quot;&quot;&quot;</span>
        <span class="n">trade</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trades</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">trade</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_capital</span> <span class="o">+=</span> <span class="n">trade</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pnl&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">equity_curve</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_capital</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">calculate_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate performance metrics.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">trades</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;No trades&#39;</span><span class="p">}</span>
        
        <span class="n">pnls</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pnl&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trades</span><span class="p">]</span>
        <span class="n">winners</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pnls</span> <span class="k">if</span> <span class="n">p</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">losers</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pnls</span> <span class="k">if</span> <span class="n">p</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span>
        
        <span class="n">total_return</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_capital</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_capital</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_capital</span> <span class="o">*</span> <span class="mi">100</span>
        
        <span class="c1"># Sharpe ratio (simplified)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pnls</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">pnls</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">sharpe</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">pnls</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">pnls</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">365</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sharpe</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="c1"># Max drawdown</span>
        <span class="n">equity</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">equity_curve</span><span class="p">)</span>
        <span class="n">peak</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="o">.</span><span class="n">accumulate</span><span class="p">(</span><span class="n">equity</span><span class="p">)</span>
        <span class="n">drawdown</span> <span class="o">=</span> <span class="p">(</span><span class="n">equity</span> <span class="o">-</span> <span class="n">peak</span><span class="p">)</span> <span class="o">/</span> <span class="n">peak</span>
        <span class="n">max_dd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">drawdown</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;total_trades&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trades</span><span class="p">),</span>
            <span class="s1">&#39;winning_trades&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">winners</span><span class="p">),</span>
            <span class="s1">&#39;losing_trades&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">losers</span><span class="p">),</span>
            <span class="s1">&#39;win_rate&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">winners</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trades</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">trades</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;total_pnl&#39;</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="n">pnls</span><span class="p">),</span>
            <span class="s1">&#39;total_return_pct&#39;</span><span class="p">:</span> <span class="n">total_return</span><span class="p">,</span>
            <span class="s1">&#39;average_win&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">winners</span><span class="p">)</span> <span class="k">if</span> <span class="n">winners</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;average_loss&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">losers</span><span class="p">)</span> <span class="k">if</span> <span class="n">losers</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;profit_factor&#39;</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">winners</span><span class="p">)</span> <span class="o">/</span> <span class="nb">sum</span><span class="p">(</span><span class="n">losers</span><span class="p">))</span> <span class="k">if</span> <span class="n">losers</span> <span class="ow">and</span> <span class="nb">sum</span><span class="p">(</span><span class="n">losers</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">),</span>
            <span class="s1">&#39;sharpe_ratio&#39;</span><span class="p">:</span> <span class="n">sharpe</span><span class="p">,</span>
            <span class="s1">&#39;max_drawdown_pct&#39;</span><span class="p">:</span> <span class="n">max_dd</span><span class="p">,</span>
            <span class="s1">&#39;current_capital&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_capital</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">generate_report</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Generate performance report.&quot;&quot;&quot;</span>
        <span class="n">metrics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_metrics</span><span class="p">()</span>
        
        <span class="n">report</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;=&#39;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;         PERFORMANCE REPORT&#39;</span><span class="p">)</span>
        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;=&#39;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Initial Capital: $</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">initial_capital</span><span class="si">:</span><span class="s2">,.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Current Capital: $</span><span class="si">{</span><span class="n">metrics</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;current_capital&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="si">:</span><span class="s2">,.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total Return: </span><span class="si">{</span><span class="n">metrics</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;total_return_pct&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;-&#39;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total Trades: </span><span class="si">{</span><span class="n">metrics</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;total_trades&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Win Rate: </span><span class="si">{</span><span class="n">metrics</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;win_rate&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Profit Factor: </span><span class="si">{</span><span class="n">metrics</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;profit_factor&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sharpe Ratio: </span><span class="si">{</span><span class="n">metrics</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sharpe_ratio&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Max Drawdown: </span><span class="si">{</span><span class="n">metrics</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;max_drawdown_pct&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;=&#39;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">report</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h2>6.2 Alert System</h2></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="c1"># monitoring/alerts.py</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>

<span class="k">class</span> <span class="nc">AlertSystem</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Multi-channel alert system.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">handlers</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alert_history</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thresholds</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="k">def</span> <span class="nf">add_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">handler</span><span class="p">:</span> <span class="n">Callable</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add alert handler (email, telegram, etc.).&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">handlers</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">handler</span>
    
    <span class="k">def</span> <span class="nf">set_threshold</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metric</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">direction</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;above&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set alert threshold.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thresholds</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">value</span><span class="p">,</span> <span class="s1">&#39;direction&#39;</span><span class="p">:</span> <span class="n">direction</span><span class="p">,</span> <span class="s1">&#39;triggered&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">check_thresholds</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current_values</span><span class="p">:</span> <span class="n">Dict</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check all thresholds and trigger alerts.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">metric</span><span class="p">,</span> <span class="n">config</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">thresholds</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">metric</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">current_values</span><span class="p">:</span>
                <span class="k">continue</span>
            
            <span class="n">value</span> <span class="o">=</span> <span class="n">current_values</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span>
            <span class="n">should_trigger</span> <span class="o">=</span> <span class="kc">False</span>
            
            <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;direction&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;above&#39;</span> <span class="ow">and</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]:</span>
                <span class="n">should_trigger</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">elif</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;direction&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;below&#39;</span> <span class="ow">and</span> <span class="n">value</span> <span class="o">&lt;</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]:</span>
                <span class="n">should_trigger</span> <span class="o">=</span> <span class="kc">True</span>
            
            <span class="k">if</span> <span class="n">should_trigger</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;triggered&#39;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">send_alert</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;THRESHOLD: </span><span class="si">{</span><span class="n">metric</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;direction&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
                <span class="n">config</span><span class="p">[</span><span class="s1">&#39;triggered&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">should_trigger</span><span class="p">:</span>
                <span class="n">config</span><span class="p">[</span><span class="s1">&#39;triggered&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    
    <span class="k">def</span> <span class="nf">send_alert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">level</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;INFO&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Send alert through all handlers.&quot;&quot;&quot;</span>
        <span class="n">alert</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
            <span class="s1">&#39;level&#39;</span><span class="p">:</span> <span class="n">level</span><span class="p">,</span>
            <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="n">message</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alert_history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">alert</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">handler</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">handlers</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">handler</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">level</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Alert handler </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1"> failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">send_trade_alert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trade</span><span class="p">:</span> <span class="n">Dict</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Send trade execution alert.&quot;&quot;&quot;</span>
        <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;TRADE: </span><span class="si">{</span><span class="n">trade</span><span class="p">[</span><span class="s1">&#39;side&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">trade</span><span class="p">[</span><span class="s1">&#39;amount&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">trade</span><span class="p">[</span><span class="s1">&#39;symbol&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> @ </span><span class="si">{</span><span class="n">trade</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_alert</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="s1">&#39;TRADE&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><hr />
<h1>Part 7: Main Trading System</h1>
<h2>7.1 Complete System Integration</h2></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="c1"># main.py</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>

<span class="k">class</span> <span class="nc">CryptoTradingSystem</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Complete crypto trading system.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="kc">False</span>
        
        <span class="c1"># Initialize components</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">TradingLogger</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">market_data</span> <span class="o">=</span> <span class="n">MarketDataManager</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">onchain_data</span> <span class="o">=</span> <span class="n">OnChainDataManager</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">web3_rpc</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">defi_data</span> <span class="o">=</span> <span class="n">DeFiDataManager</span><span class="p">()</span>
        
        <span class="c1"># Strategies</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">strategy_manager</span> <span class="o">=</span> <span class="n">StrategyManager</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">strategy_manager</span><span class="o">.</span><span class="n">add_strategy</span><span class="p">(</span><span class="n">TrendStrategy</span><span class="p">(),</span> <span class="n">weight</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">strategy_manager</span><span class="o">.</span><span class="n">add_strategy</span><span class="p">(</span><span class="n">MeanReversionStrategy</span><span class="p">(),</span> <span class="n">weight</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
        
        <span class="c1"># Execution</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">order_manager</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Initialize when running</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">position_sizer</span> <span class="o">=</span> <span class="n">PositionSizer</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">risk</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">risk_manager</span> <span class="o">=</span> <span class="n">RiskManager</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">risk</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">)</span>
        
        <span class="c1"># Monitoring</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">performance</span> <span class="o">=</span> <span class="n">PerformanceTracker</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">trading</span><span class="o">.</span><span class="n">max_position_size</span> <span class="o">*</span> <span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alerts</span> <span class="o">=</span> <span class="n">AlertSystem</span><span class="p">()</span>
        
        <span class="c1"># State</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">positions</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_signals</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize all components.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Initializing trading system...&#39;</span><span class="p">)</span>
        
        <span class="c1"># Set up alerts</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alerts</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="s1">&#39;console&#39;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">msg</span><span class="p">,</span> <span class="n">lvl</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;[</span><span class="si">{</span><span class="n">lvl</span><span class="si">}</span><span class="s1">] </span><span class="si">{</span><span class="n">msg</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alerts</span><span class="o">.</span><span class="n">set_threshold</span><span class="p">(</span><span class="s1">&#39;daily_pnl&#39;</span><span class="p">,</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">trading</span><span class="o">.</span><span class="n">max_daily_loss</span><span class="p">,</span> <span class="s1">&#39;below&#39;</span><span class="p">)</span>
        
        <span class="c1"># Initialize order manager with first exchange</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">market_data</span><span class="o">.</span><span class="n">exchanges</span><span class="p">:</span>
            <span class="n">exchange</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">market_data</span><span class="o">.</span><span class="n">exchanges</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">order_manager</span> <span class="o">=</span> <span class="n">OrderManager</span><span class="p">(</span><span class="n">exchange</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;System initialized&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>
    
    <span class="k">def</span> <span class="nf">run_cycle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Run one trading cycle.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">trading</span><span class="o">.</span><span class="n">symbols</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Get market data</span>
                <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">market_data</span><span class="o">.</span><span class="n">get_ohlcv</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="s1">&#39;1h&#39;</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
                <span class="n">ticker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">market_data</span><span class="o">.</span><span class="n">get_ticker</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
                
                <span class="c1"># Generate signals</span>
                <span class="n">signal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">strategy_manager</span><span class="o">.</span><span class="n">get_combined_signal</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">symbol</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="n">signal</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log_signal</span><span class="p">({</span>
                        <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span>
                        <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="n">signal</span><span class="o">.</span><span class="n">signal_type</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                        <span class="s1">&#39;strength&#39;</span><span class="p">:</span> <span class="n">signal</span><span class="o">.</span><span class="n">strength</span><span class="p">,</span>
                        <span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="n">signal</span><span class="o">.</span><span class="n">price</span>
                    <span class="p">})</span>
                    
                    <span class="c1"># Check risk</span>
                    <span class="n">risk_check</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">risk_manager</span><span class="o">.</span><span class="n">can_trade</span><span class="p">(</span><span class="n">signal</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">)</span>
                    
                    <span class="k">if</span> <span class="n">risk_check</span><span class="p">[</span><span class="s1">&#39;allowed&#39;</span><span class="p">]:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_execute_signal</span><span class="p">(</span><span class="n">signal</span><span class="p">,</span> <span class="n">ticker</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Signal blocked: </span><span class="si">{</span><span class="n">risk_check</span><span class="p">[</span><span class="s1">&#39;reasons&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                
                <span class="c1"># Check existing positions for stops</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_check_positions</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">ticker</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">])</span>
                
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log_error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Cycle error for </span><span class="si">{</span><span class="n">symbol</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)})</span>
        
        <span class="c1"># Check alerts</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alerts</span><span class="o">.</span><span class="n">check_thresholds</span><span class="p">({</span><span class="s1">&#39;daily_pnl&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">risk_manager</span><span class="o">.</span><span class="n">daily_pnl</span><span class="p">})</span>
    
    <span class="k">def</span> <span class="nf">_execute_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">signal</span><span class="p">,</span> <span class="n">ticker</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Execute trading signal.&quot;&quot;&quot;</span>
        <span class="c1"># Calculate position size</span>
        <span class="n">sizing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">position_sizer</span><span class="o">.</span><span class="n">calculate_position_size</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">performance</span><span class="o">.</span><span class="n">current_capital</span><span class="p">,</span>
            <span class="n">signal</span><span class="o">.</span><span class="n">price</span><span class="p">,</span>
            <span class="n">signal</span><span class="o">.</span><span class="n">stop_loss</span><span class="p">,</span>
            <span class="n">signal</span><span class="o">.</span><span class="n">strength</span>
        <span class="p">)</span>
        
        <span class="k">if</span> <span class="s1">&#39;error&#39;</span> <span class="ow">in</span> <span class="n">sizing</span><span class="p">:</span>
            <span class="k">return</span>
        
        <span class="c1"># Execute trade</span>
        <span class="n">side</span> <span class="o">=</span> <span class="s1">&#39;buy&#39;</span> <span class="k">if</span> <span class="n">signal</span><span class="o">.</span><span class="n">signal_type</span> <span class="o">==</span> <span class="n">SignalType</span><span class="o">.</span><span class="n">BUY</span> <span class="k">else</span> <span class="s1">&#39;sell&#39;</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="n">order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">order_manager</span><span class="o">.</span><span class="n">create_market_order</span><span class="p">(</span>
                <span class="n">signal</span><span class="o">.</span><span class="n">symbol</span><span class="p">,</span>
                <span class="n">side</span><span class="p">,</span>
                <span class="n">sizing</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span>
            <span class="p">)</span>
            
            <span class="c1"># Track position</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">signal</span><span class="o">.</span><span class="n">symbol</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;side&#39;</span><span class="p">:</span> <span class="s1">&#39;long&#39;</span> <span class="k">if</span> <span class="n">side</span> <span class="o">==</span> <span class="s1">&#39;buy&#39;</span> <span class="k">else</span> <span class="s1">&#39;short&#39;</span><span class="p">,</span>
                <span class="s1">&#39;entry_price&#39;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">filled_price</span><span class="p">,</span>
                <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="n">sizing</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">],</span>
                <span class="s1">&#39;stop_loss&#39;</span><span class="p">:</span> <span class="n">signal</span><span class="o">.</span><span class="n">stop_loss</span><span class="p">,</span>
                <span class="s1">&#39;take_profit&#39;</span><span class="p">:</span> <span class="n">signal</span><span class="o">.</span><span class="n">take_profit</span><span class="p">,</span>
                <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">sizing</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
            <span class="p">}</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">alerts</span><span class="o">.</span><span class="n">send_trade_alert</span><span class="p">({</span>
                <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">signal</span><span class="o">.</span><span class="n">symbol</span><span class="p">,</span>
                <span class="s1">&#39;side&#39;</span><span class="p">:</span> <span class="n">side</span><span class="p">,</span>
                <span class="s1">&#39;amount&#39;</span><span class="p">:</span> <span class="n">sizing</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">],</span>
                <span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">filled_price</span>
            <span class="p">})</span>
            
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log_error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Execution failed&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)})</span>
    
    <span class="k">def</span> <span class="nf">_check_positions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">current_price</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check positions for stop loss/take profit.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">symbol</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">:</span>
            <span class="k">return</span>
        
        <span class="n">position</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span>
        
        <span class="c1"># Check stop loss</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">risk_manager</span><span class="o">.</span><span class="n">check_stop_loss</span><span class="p">(</span><span class="n">position</span><span class="p">,</span> <span class="n">current_price</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_close_position</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">current_price</span><span class="p">,</span> <span class="s1">&#39;STOP_LOSS&#39;</span><span class="p">)</span>
        
        <span class="c1"># Check take profit</span>
        <span class="k">if</span> <span class="n">position</span><span class="p">[</span><span class="s1">&#39;side&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;long&#39;</span> <span class="ow">and</span> <span class="n">current_price</span> <span class="o">&gt;=</span> <span class="n">position</span><span class="p">[</span><span class="s1">&#39;take_profit&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_close_position</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">current_price</span><span class="p">,</span> <span class="s1">&#39;TAKE_PROFIT&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">position</span><span class="p">[</span><span class="s1">&#39;side&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;short&#39;</span> <span class="ow">and</span> <span class="n">current_price</span> <span class="o">&lt;=</span> <span class="n">position</span><span class="p">[</span><span class="s1">&#39;take_profit&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_close_position</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">current_price</span><span class="p">,</span> <span class="s1">&#39;TAKE_PROFIT&#39;</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">_close_position</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">price</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">reason</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Close a position.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">symbol</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">:</span>
            <span class="k">return</span>
        
        <span class="n">position</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span>
        <span class="n">side</span> <span class="o">=</span> <span class="s1">&#39;sell&#39;</span> <span class="k">if</span> <span class="n">position</span><span class="p">[</span><span class="s1">&#39;side&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;long&#39;</span> <span class="k">else</span> <span class="s1">&#39;buy&#39;</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="n">order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">order_manager</span><span class="o">.</span><span class="n">create_market_order</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">side</span><span class="p">,</span> <span class="n">position</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">])</span>
            
            <span class="c1"># Calculate PnL</span>
            <span class="k">if</span> <span class="n">position</span><span class="p">[</span><span class="s1">&#39;side&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;long&#39;</span><span class="p">:</span>
                <span class="n">pnl</span> <span class="o">=</span> <span class="p">(</span><span class="n">price</span> <span class="o">-</span> <span class="n">position</span><span class="p">[</span><span class="s1">&#39;entry_price&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="n">position</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pnl</span> <span class="o">=</span> <span class="p">(</span><span class="n">position</span><span class="p">[</span><span class="s1">&#39;entry_price&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">price</span><span class="p">)</span> <span class="o">*</span> <span class="n">position</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">]</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">performance</span><span class="o">.</span><span class="n">record_trade</span><span class="p">({</span>
                <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span>
                <span class="s1">&#39;side&#39;</span><span class="p">:</span> <span class="n">position</span><span class="p">[</span><span class="s1">&#39;side&#39;</span><span class="p">],</span>
                <span class="s1">&#39;entry_price&#39;</span><span class="p">:</span> <span class="n">position</span><span class="p">[</span><span class="s1">&#39;entry_price&#39;</span><span class="p">],</span>
                <span class="s1">&#39;exit_price&#39;</span><span class="p">:</span> <span class="n">price</span><span class="p">,</span>
                <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="n">position</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">],</span>
                <span class="s1">&#39;pnl&#39;</span><span class="p">:</span> <span class="n">pnl</span><span class="p">,</span>
                <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="n">reason</span>
            <span class="p">})</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">risk_manager</span><span class="o">.</span><span class="n">record_trade_result</span><span class="p">(</span><span class="n">pnl</span><span class="p">)</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log_trade</span><span class="p">({</span>
                <span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="s1">&#39;CLOSE&#39;</span><span class="p">,</span>
                <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span>
                <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="n">reason</span><span class="p">,</span>
                <span class="s1">&#39;pnl&#39;</span><span class="p">:</span> <span class="n">pnl</span>
            <span class="p">})</span>
            
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log_error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Close position failed&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)})</span>
    
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">interval_seconds</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">60</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Run the trading system.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Starting trading system, interval: </span><span class="si">{</span><span class="n">interval_seconds</span><span class="si">}</span><span class="s1">s&#39;</span><span class="p">)</span>
        
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">running</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">cycle_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">run_cycle</span><span class="p">()</span>
                
                <span class="c1"># Wait for next cycle</span>
                <span class="n">elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">cycle_start</span>
                <span class="n">sleep_time</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">interval_seconds</span> <span class="o">-</span> <span class="n">elapsed</span><span class="p">)</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">sleep_time</span><span class="p">)</span>
                
            <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Shutdown requested&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
                <span class="k">break</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log_error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Main loop error&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)})</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">shutdown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Graceful shutdown.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Shutting down...&#39;</span><span class="p">)</span>
        
        <span class="c1"># Close all positions</span>
        <span class="k">for</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="n">ticker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">market_data</span><span class="o">.</span><span class="n">get_ticker</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_close_position</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">ticker</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">],</span> <span class="s1">&#39;SHUTDOWN&#39;</span><span class="p">)</span>
        
        <span class="c1"># Generate final report</span>
        <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">performance</span><span class="o">.</span><span class="n">generate_report</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Shutdown complete&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><hr />
<h1>Part 8: Running the System</h1></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ğŸ“‹</button><pre><code><span class="c1"># Example usage</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="c1"># Load settings</span>
    <span class="n">settings</span> <span class="o">=</span> <span class="n">Settings</span><span class="p">()</span>
    
    <span class="c1"># Create system</span>
    <span class="n">system</span> <span class="o">=</span> <span class="n">CryptoTradingSystem</span><span class="p">(</span><span class="n">settings</span><span class="p">)</span>
    
    <span class="c1"># Initialize</span>
    <span class="k">if</span> <span class="n">system</span><span class="o">.</span><span class="n">initialize</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;System initialized successfully&#39;</span><span class="p">)</span>
        
        <span class="c1"># Run in paper trading mode first!</span>
        <span class="c1"># system.run(interval_seconds=60)</span>
        
        <span class="c1"># For testing, just run one cycle</span>
        <span class="n">system</span><span class="o">.</span><span class="n">run_cycle</span><span class="p">()</span>
        
        <span class="c1"># Show performance</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">system</span><span class="o">.</span><span class="n">performance</span><span class="o">.</span><span class="n">generate_report</span><span class="p">())</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Initialization failed&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><hr />
<h1>ğŸ“‹ Capstone Checklist</h1>
<h2>Core Features</h2>
<ul>
<li>[ ] Multi-exchange connectivity (CCXT)</li>
<li>[ ] Real-time market data</li>
<li>[ ] Technical indicators (MA, RSI, Bollinger)</li>
<li>[ ] Multiple strategy support</li>
<li>[ ] Signal combination/weighting</li>
<li>[ ] Order execution with error handling</li>
<li>[ ] Position tracking</li>
<li>[ ] Stop loss/take profit management</li>
</ul>
<h2>Risk Management</h2>
<ul>
<li>[ ] Position sizing based on risk</li>
<li>[ ] Maximum position limits</li>
<li>[ ] Daily loss limits</li>
<li>[ ] Portfolio exposure limits</li>
</ul>
<h2>Monitoring</h2>
<ul>
<li>[ ] Trade logging</li>
<li>[ ] Performance tracking</li>
<li>[ ] Alert system</li>
<li>[ ] Performance reports</li>
</ul>
<h2>Advanced (Optional)</h2>
<ul>
<li>[ ] On-chain data integration</li>
<li>[ ] DeFi yield monitoring</li>
<li>[ ] Web dashboard (Streamlit)</li>
<li>[ ] Telegram/Discord alerts</li>
<li>[ ] Database storage</li>
<li>[ ] Backtesting framework</li>
</ul>
<hr />
<h1>ğŸ‰ Congratulations!</h1>
<p>You've completed the <strong>Crypto Algorithmic Trading</strong> course!</p>
<h2>What You've Learned:</h2>
<ol>
<li>Cryptocurrency market fundamentals</li>
<li>Data sourcing and technical analysis</li>
<li>On-chain analytics</li>
<li>Strategy development and backtesting</li>
<li>Risk management</li>
<li>Exchange API integration</li>
<li>DeFi protocols and DEX trading</li>
<li>Advanced strategies (funding, options, market making)</li>
<li>Production system development</li>
</ol>
<h2>Next Steps:</h2>
<ol>
<li><strong>Paper Trade</strong> - Run your system in paper trading mode</li>
<li><strong>Iterate</strong> - Improve strategies based on results</li>
<li><strong>Go Live</strong> - Start with small capital</li>
<li><strong>Continue Learning</strong> - Course 2 (Stocks), Course 3 (Quant Finance), Course 4 (ML)</li>
</ol></div>
        <div class="nav-buttons">
            <button class="nav-btn prev-btn disabled" type="button">
                <span class="nav-btn-label">â† Previous</span>
                <span class="nav-btn-name"></span>
            </button>
            <button class="nav-btn next-btn disabled" type="button">
                <span class="nav-btn-label">Next â†’</span>
                <span class="nav-btn-name"></span>
            </button>
        </div>
        </div>
    </main>

    <script>
        window.courseId = 'course1_crypto_trading';
        
// State
let currentModule = 0;
const modules = document.querySelectorAll('.module-section');
const sidebarItems = document.querySelectorAll('.sidebar-item');
const sidebar = document.querySelector('.sidebar');
const overlay = document.querySelector('.sidebar-overlay');
const headerModule = document.querySelector('.header-module');

function showModule(idx) {
    if (idx < 0 || idx >= modules.length) return;

    // Hide all, show target
    modules.forEach(m => m.classList.remove('active'));
    modules[idx].classList.add('active');

    // Update sidebar active state
    sidebarItems.forEach(s => s.classList.remove('active'));
    sidebarItems[idx].classList.add('active');

    // Update header
    const label = sidebarItems[idx].textContent.trim();
    if (headerModule) headerModule.textContent = label;

    // Update prev/next buttons
    updateNavButtons(idx);

    // Save & scroll
    currentModule = idx;
    try { localStorage.setItem(window.courseId + '_module', idx); } catch(e) {}
    window.scrollTo(0, 0);

    // Close sidebar on mobile
    closeSidebar();
}

function updateNavButtons(idx) {
    const section = modules[idx];
    const prevBtn = section.querySelector('.prev-btn');
    const nextBtn = section.querySelector('.next-btn');

    if (prevBtn) {
        // Clone to remove old listeners
        const newPrev = prevBtn.cloneNode(true);
        prevBtn.parentNode.replaceChild(newPrev, prevBtn);
        if (idx === 0) {
            newPrev.classList.add('disabled');
            newPrev.querySelector('.nav-btn-name').textContent = '';
        } else {
            newPrev.classList.remove('disabled');
            newPrev.querySelector('.nav-btn-name').textContent = sidebarItems[idx - 1].textContent.trim();
            newPrev.addEventListener('click', () => showModule(idx - 1));
        }
    }
    if (nextBtn) {
        const newNext = nextBtn.cloneNode(true);
        nextBtn.parentNode.replaceChild(newNext, nextBtn);
        if (idx === modules.length - 1) {
            newNext.classList.add('disabled');
            newNext.querySelector('.nav-btn-name').textContent = '';
        } else {
            newNext.classList.remove('disabled');
            newNext.querySelector('.nav-btn-name').textContent = sidebarItems[idx + 1].textContent.trim();
            newNext.addEventListener('click', () => showModule(idx + 1));
        }
    }
}

function toggleSidebar() {
    sidebar.classList.toggle('open');
    overlay.classList.toggle('open');
}

function closeSidebar() {
    sidebar.classList.remove('open');
    overlay.classList.remove('open');
}

// Copy code button
function copyCode(btn) {
    const code = btn.parentElement.querySelector('pre code');
    const text = code.textContent;
    navigator.clipboard.writeText(text).then(() => {
        btn.textContent = 'âœ“';
        btn.classList.add('copied');
        setTimeout(() => {
            btn.textContent = 'ğŸ“‹';
            btn.classList.remove('copied');
        }, 1500);
    }).catch(() => {
        // Fallback
        const ta = document.createElement('textarea');
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand('copy');
        document.body.removeChild(ta);
        btn.textContent = 'âœ“';
        btn.classList.add('copied');
        setTimeout(() => {
            btn.textContent = 'ğŸ“‹';
            btn.classList.remove('copied');
        }, 1500);
    });
}

// Init: bind sidebar items
sidebarItems.forEach((item, idx) => {
    item.addEventListener('click', () => showModule(idx));
});

// Restore last viewed module
document.addEventListener('DOMContentLoaded', () => {
    let saved = 0;
    try { saved = parseInt(localStorage.getItem(window.courseId + '_module')) || 0; } catch(e) {}
    if (saved >= 0 && saved < modules.length) {
        showModule(saved);
    } else {
        showModule(0);
    }
});

// Keyboard navigation
document.addEventListener('keydown', (e) => {
    if (e.key === 'ArrowLeft' && currentModule > 0) showModule(currentModule - 1);
    if (e.key === 'ArrowRight' && currentModule < modules.length - 1) showModule(currentModule + 1);
    if (e.key === 'Escape') closeSidebar();
});

    </script>
</body>
</html>