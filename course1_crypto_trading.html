<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <title>Crypto Algo Trading â€” FinQT</title>
    <style>
/* === Reset & Base === */
*, *::before, *::after {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
}

:root {
    --bg: #0a0a0a;
    --bg-secondary: #111111;
    --bg-sidebar: #0d0d0d;
    --text: #e0e0e0;
    --text-dim: #888888;
    --green: #00c853;
    --green-dim: #1b5e20;
    --green-glow: rgba(0, 200, 83, 0.15);
    --code-bg: #141420;
    --border: #1e1e1e;
    --header-height: 52px;
}

html {
    font-size: 16px;
    -webkit-text-size-adjust: 100%;
}

body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    background: var(--bg);
    color: var(--text);
    line-height: 1.65;
    overflow-x: hidden;
    -webkit-font-smoothing: antialiased;
}

/* === Header === */
.header {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    height: var(--header-height);
    background: var(--bg-secondary);
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    padding: 0 16px;
    z-index: 1000;
    gap: 12px;
}

.hamburger {
    background: none;
    border: none;
    color: var(--text);
    font-size: 22px;
    cursor: pointer;
    padding: 6px;
    border-radius: 6px;
    line-height: 1;
    flex-shrink: 0;
}
.hamburger:hover {
    background: rgba(255,255,255,0.08);
}

.header-title {
    font-size: 15px;
    font-weight: 600;
    color: var(--green);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.header-module {
    font-size: 13px;
    color: var(--text-dim);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    margin-left: auto;
}

/* === Sidebar === */
.sidebar-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.6);
    z-index: 1001;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s;
}
.sidebar-overlay.open {
    opacity: 1;
    pointer-events: auto;
}

.sidebar {
    position: fixed;
    top: 0;
    left: 0;
    bottom: 0;
    width: 280px;
    max-width: 85vw;
    background: var(--bg-sidebar);
    border-right: 1px solid var(--border);
    z-index: 1002;
    transform: translateX(-100%);
    transition: transform 0.25s ease;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
    padding-top: 12px;
    padding-bottom: 24px;
}
.sidebar.open {
    transform: translateX(0);
}

.sidebar-header {
    padding: 12px 16px 16px;
    border-bottom: 1px solid var(--border);
    margin-bottom: 8px;
}
.sidebar-header h2 {
    font-size: 15px;
    color: var(--green);
    font-weight: 600;
}

.sidebar-part {
    padding: 10px 16px 4px;
    font-size: 11px;
    font-weight: 700;
    color: var(--text-dim);
    text-transform: uppercase;
    letter-spacing: 0.6px;
}

.sidebar-item {
    display: block;
    padding: 8px 16px 8px 24px;
    font-size: 13px;
    color: var(--text);
    text-decoration: none;
    cursor: pointer;
    border-left: 3px solid transparent;
    transition: all 0.15s;
}
.sidebar-item:hover {
    background: rgba(255,255,255,0.04);
}
.sidebar-item.active {
    color: var(--green);
    border-left-color: var(--green);
    background: var(--green-glow);
    font-weight: 600;
}

/* === Main Content === */
.main {
    margin-top: var(--header-height);
    padding: 20px 16px 80px;
    max-width: 800px;
    margin-left: auto;
    margin-right: auto;
}

.module-section {
    display: none;
}
.module-section.active {
    display: block;
}

/* === Typography === */
.md-cell h1 {
    font-size: 1.7rem;
    font-weight: 700;
    color: var(--green);
    margin: 1.5em 0 0.5em;
    line-height: 1.25;
}
.md-cell h2 {
    font-size: 1.35rem;
    font-weight: 600;
    color: var(--green);
    margin: 1.4em 0 0.4em;
    padding-bottom: 6px;
    border-bottom: 1px solid var(--border);
}
.md-cell h3 {
    font-size: 1.1rem;
    font-weight: 600;
    color: #cccccc;
    margin: 1.2em 0 0.3em;
}
.md-cell h4, .md-cell h5, .md-cell h6 {
    font-size: 1rem;
    font-weight: 600;
    color: #bbbbbb;
    margin: 1em 0 0.3em;
}

.md-cell p {
    margin: 0.6em 0;
}

.md-cell a {
    color: var(--green);
    text-decoration: none;
}
.md-cell a:hover {
    text-decoration: underline;
}

.md-cell strong {
    color: #f0f0f0;
}

.md-cell ul, .md-cell ol {
    margin: 0.5em 0;
    padding-left: 1.5em;
}
.md-cell li {
    margin: 0.25em 0;
}

.md-cell hr {
    border: none;
    border-top: 1px solid var(--border);
    margin: 1.5em 0;
}

.md-cell blockquote {
    border-left: 3px solid var(--green-dim);
    padding: 0.5em 1em;
    margin: 0.8em 0;
    color: var(--text-dim);
    background: rgba(255,255,255,0.02);
    border-radius: 0 6px 6px 0;
}

/* Inline code (not inside pre blocks) */
.md-cell code {
    background: rgba(255,255,255,0.08);
    padding: 2px 6px;
    border-radius: 3px;
    font-family: "SF Mono", "Fira Code", "Cascadia Code", Menlo, monospace;
    font-size: 0.88em;
    color: #e8e8e8;
}
.md-cell pre code {
    background: transparent !important;
    padding: 0;
    border-radius: 0;
    color: inherit;
}

/* Fenced code blocks inside markdown */
.md-cell pre {
    background: var(--code-bg);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 14px 16px;
    overflow-x: auto;
    margin: 0.8em 0;
    -webkit-overflow-scrolling: touch;
}
.md-cell pre code {
    background: none;
    padding: 0;
    border-radius: 0;
    font-size: 0.85rem;
    line-height: 1.5;
    color: #e8e8e8;
}

/* === Module Header (first cell) === */
.module-header {
    padding-bottom: 0.5em;
    margin-bottom: 0.5em;
}
.module-header h1 {
    font-size: 1.8rem;
    margin-top: 0;
}

/* === Tables === */
.table-wrapper {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    margin: 0.8em 0;
    border-radius: 8px;
    border: 1px solid var(--border);
}

.md-cell table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.88rem;
}
.md-cell th {
    background: var(--bg-secondary);
    color: var(--green);
    font-weight: 600;
    text-align: left;
    padding: 10px 12px;
    border-bottom: 2px solid var(--border);
    white-space: nowrap;
}
.md-cell td {
    padding: 8px 12px;
    border-bottom: 1px solid var(--border);
    vertical-align: top;
}
.md-cell tr:last-child td {
    border-bottom: none;
}

/* === Code Cells === */
.code-cell {
    position: relative;
    background: var(--code-bg);
    border: 1px solid var(--border);
    border-radius: 8px;
    margin: 0.6em 0;
    overflow: clip;
}
.code-cell pre {
    margin: 0;
    padding: 14px 16px;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
}
.code-cell pre code {
    font-family: "SF Mono", "Fira Code", "Cascadia Code", Menlo, monospace;
    font-size: 0.82rem;
    line-height: 1.55;
    background: transparent !important;
    padding: 0;
    border-radius: 0;
}

/* === Cell Toolbar === */
.cell-toolbar {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 6px 10px;
    background: rgba(255,255,255,0.03);
    border-bottom: 1px solid var(--border);
}

.cell-label {
    font-size: 0.7rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--green);
    margin-right: auto;
}

.run-btn, .reset-btn, .copy-btn {
    background: rgba(255,255,255,0.06);
    border: 1px solid var(--border);
    border-radius: 4px;
    color: var(--text-dim);
    font-family: inherit;
    font-size: 0.75rem;
    font-weight: 600;
    padding: 4px 12px;
    cursor: pointer;
    min-height: 28px;
    -webkit-tap-highlight-color: rgba(0, 200, 83, 0.2);
    -webkit-appearance: none;
    transition: all 0.15s;
}

.run-btn {
    background: rgba(0, 200, 83, 0.1);
    border-color: var(--green-dim);
    color: var(--green);
}

.run-btn:hover, .reset-btn:hover, .copy-btn:hover {
    background: rgba(0, 200, 83, 0.2);
    border-color: var(--green);
    color: var(--green);
}

.run-btn:active, .reset-btn:active, .copy-btn:active {
    transform: scale(0.97);
}

.run-btn.running {
    opacity: 0.5;
    pointer-events: none;
}

.copy-btn.copied {
    color: var(--green);
    border-color: var(--green);
}

/* === Code Editor (exercise textarea) === */
.code-editor {
    display: block;
    width: 100%;
    min-height: 120px;
    padding: 14px 16px;
    background: var(--code-bg);
    color: #f8f8f2;
    border: none;
    outline: none;
    resize: vertical;
    font-family: "SF Mono", "Fira Code", "Cascadia Code", Menlo, monospace;
    font-size: 0.82rem;
    line-height: 1.55;
    tab-size: 4;
    -moz-tab-size: 4;
    white-space: pre;
    overflow-x: auto;
    -webkit-text-size-adjust: 100%;
    /* iOS Safari touch fixes */
    position: relative;
    z-index: 1;
    touch-action: manipulation;
    -webkit-user-select: text;
    user-select: text;
    -webkit-transform: translateZ(0);
    transform: translateZ(0);
}

.code-editor:focus {
    box-shadow: inset 0 0 0 2px rgba(0, 200, 83, 0.3);
}

/* iOS Safari: ensure textareas are always interactive */
.code-cell textarea,
.code-cell input {
    -webkit-user-select: text !important;
    user-select: text !important;
    -webkit-touch-callout: default;
    pointer-events: auto !important;
}

/* === Code Output === */
.code-output {
    display: none;
    padding: 10px 16px;
    background: #0c0c14;
    border-top: 1px solid var(--border);
    font-family: "SF Mono", Menlo, monospace;
    font-size: 0.8rem;
    line-height: 1.5;
    color: #c0c0c0;
    max-height: 400px;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
    white-space: pre-wrap;
    word-wrap: break-word;
}

.code-output.visible {
    display: block;
}

.code-output .error {
    color: #ff5252;
}

.code-output .plot-image {
    max-width: 100%;
    height: auto;
    margin: 8px 0;
    border-radius: 4px;
}

/* === Pyodide Loading Indicator === */
.pyodide-loading {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 4px 0;
    color: var(--text-dim);
    font-size: 0.8rem;
}

.pyodide-loading .spinner {
    width: 14px;
    height: 14px;
    border: 2px solid var(--border);
    border-top-color: var(--green);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    flex-shrink: 0;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* === Exercise Styling === */
.exercise-header {
    background: rgba(0, 200, 83, 0.04);
    border: 1px solid var(--green-dim);
    border-radius: 8px;
    padding: 12px 16px;
    margin: 1em 0 0.3em;
}
.exercise-header h3 {
    color: var(--green);
    margin-top: 0;
}

.exercise-code {
    border-color: var(--green-dim);
}

/* === Solution (details) blocks === */
.solution-block details {
    border-left: 3px solid var(--green);
    border-radius: 0 8px 8px 0;
    margin: 0.5em 0 1em;
    background: rgba(0, 200, 83, 0.03);
}
.solution-block summary {
    padding: 10px 14px;
    cursor: pointer;
    color: var(--green);
    font-weight: 600;
    font-size: 0.9rem;
    user-select: none;
    -webkit-user-select: none;
}
.solution-block summary:hover {
    background: rgba(0, 200, 83, 0.06);
}
.solution-block details[open] summary {
    border-bottom: 1px solid var(--border);
    margin-bottom: 0;
}
.solution-block details > :not(summary) {
    padding: 0 14px;
}
.solution-block details pre {
    margin: 10px 0;
}

/* === Module Project === */
.module-project {
    border: 1px solid var(--green-dim);
    border-radius: 8px;
    padding: 16px;
    margin: 1.5em 0;
    background: rgba(0, 200, 83, 0.03);
}
.module-project h1 {
    font-size: 1.4rem;
}

/* === Key Takeaways === */
.key-takeaways {
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 16px;
    margin: 1.5em 0;
}
.key-takeaways h1 {
    font-size: 1.3rem;
    margin-top: 0;
}

/* === Prev/Next Navigation === */
.nav-buttons {
    display: flex;
    gap: 12px;
    margin-top: 2em;
    padding-top: 1.5em;
    border-top: 1px solid var(--border);
}
.nav-btn {
    flex: 1;
    padding: 12px 16px;
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text);
    font-family: inherit;
    font-size: 0.9rem;
    cursor: pointer;
    text-align: center;
    transition: all 0.15s;
    text-decoration: none;
    -webkit-appearance: none;
    -webkit-tap-highlight-color: rgba(0, 200, 83, 0.2);
}
.nav-btn:hover {
    border-color: var(--green);
    color: var(--green);
}
.nav-btn.disabled {
    opacity: 0.3;
    pointer-events: none;
}
.nav-btn-label {
    display: block;
    font-size: 0.75rem;
    color: var(--text-dim);
    margin-bottom: 2px;
}

/* === Syntax Highlighting (Pygments Monokai) === */
pre { line-height: 125%; }
td.linenos .normal { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
span.linenos { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
td.linenos .special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
span.linenos.special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
.code-cell pre code .hll { background-color: #49483e }
.code-cell pre code { background: #272822; color: #f8f8f2 }
.code-cell pre code .c { color: #75715e } /* Comment */
.code-cell pre code .err { color: #960050; background-color: #1e0010 } /* Error */
.code-cell pre code .esc { color: #f8f8f2 } /* Escape */
.code-cell pre code .g { color: #f8f8f2 } /* Generic */
.code-cell pre code .k { color: #66d9ef } /* Keyword */
.code-cell pre code .l { color: #ae81ff } /* Literal */
.code-cell pre code .n { color: #f8f8f2 } /* Name */
.code-cell pre code .o { color: #f92672 } /* Operator */
.code-cell pre code .x { color: #f8f8f2 } /* Other */
.code-cell pre code .p { color: #f8f8f2 } /* Punctuation */
.code-cell pre code .ch { color: #75715e } /* Comment.Hashbang */
.code-cell pre code .cm { color: #75715e } /* Comment.Multiline */
.code-cell pre code .cp { color: #75715e } /* Comment.Preproc */
.code-cell pre code .cpf { color: #75715e } /* Comment.PreprocFile */
.code-cell pre code .c1 { color: #75715e } /* Comment.Single */
.code-cell pre code .cs { color: #75715e } /* Comment.Special */
.code-cell pre code .gd { color: #f92672 } /* Generic.Deleted */
.code-cell pre code .ge { color: #f8f8f2; font-style: italic } /* Generic.Emph */
.code-cell pre code .gr { color: #f8f8f2 } /* Generic.Error */
.code-cell pre code .gh { color: #f8f8f2 } /* Generic.Heading */
.code-cell pre code .gi { color: #a6e22e } /* Generic.Inserted */
.code-cell pre code .go { color: #66d9ef } /* Generic.Output */
.code-cell pre code .gp { color: #f92672; font-weight: bold } /* Generic.Prompt */
.code-cell pre code .gs { color: #f8f8f2; font-weight: bold } /* Generic.Strong */
.code-cell pre code .gu { color: #75715e } /* Generic.Subheading */
.code-cell pre code .gt { color: #f8f8f2 } /* Generic.Traceback */
.code-cell pre code .kc { color: #66d9ef } /* Keyword.Constant */
.code-cell pre code .kd { color: #66d9ef } /* Keyword.Declaration */
.code-cell pre code .kn { color: #f92672 } /* Keyword.Namespace */
.code-cell pre code .kp { color: #66d9ef } /* Keyword.Pseudo */
.code-cell pre code .kr { color: #66d9ef } /* Keyword.Reserved */
.code-cell pre code .kt { color: #66d9ef } /* Keyword.Type */
.code-cell pre code .ld { color: #e6db74 } /* Literal.Date */
.code-cell pre code .m { color: #ae81ff } /* Literal.Number */
.code-cell pre code .s { color: #e6db74 } /* Literal.String */
.code-cell pre code .na { color: #a6e22e } /* Name.Attribute */
.code-cell pre code .nb { color: #f8f8f2 } /* Name.Builtin */
.code-cell pre code .nc { color: #a6e22e } /* Name.Class */
.code-cell pre code .no { color: #66d9ef } /* Name.Constant */
.code-cell pre code .nd { color: #a6e22e } /* Name.Decorator */
.code-cell pre code .ni { color: #f8f8f2 } /* Name.Entity */
.code-cell pre code .ne { color: #a6e22e } /* Name.Exception */
.code-cell pre code .nf { color: #a6e22e } /* Name.Function */
.code-cell pre code .nl { color: #f8f8f2 } /* Name.Label */
.code-cell pre code .nn { color: #f8f8f2 } /* Name.Namespace */
.code-cell pre code .nx { color: #a6e22e } /* Name.Other */
.code-cell pre code .py { color: #f8f8f2 } /* Name.Property */
.code-cell pre code .nt { color: #f92672 } /* Name.Tag */
.code-cell pre code .nv { color: #f8f8f2 } /* Name.Variable */
.code-cell pre code .ow { color: #f92672 } /* Operator.Word */
.code-cell pre code .w { color: #f8f8f2 } /* Text.Whitespace */
.code-cell pre code .mb { color: #ae81ff } /* Literal.Number.Bin */
.code-cell pre code .mf { color: #ae81ff } /* Literal.Number.Float */
.code-cell pre code .mh { color: #ae81ff } /* Literal.Number.Hex */
.code-cell pre code .mi { color: #ae81ff } /* Literal.Number.Integer */
.code-cell pre code .mo { color: #ae81ff } /* Literal.Number.Oct */
.code-cell pre code .sa { color: #e6db74 } /* Literal.String.Affix */
.code-cell pre code .sb { color: #e6db74 } /* Literal.String.Backtick */
.code-cell pre code .sc { color: #e6db74 } /* Literal.String.Char */
.code-cell pre code .dl { color: #e6db74 } /* Literal.String.Delimiter */
.code-cell pre code .sd { color: #e6db74 } /* Literal.String.Doc */
.code-cell pre code .s2 { color: #e6db74 } /* Literal.String.Double */
.code-cell pre code .se { color: #ae81ff } /* Literal.String.Escape */
.code-cell pre code .sh { color: #e6db74 } /* Literal.String.Heredoc */
.code-cell pre code .si { color: #e6db74 } /* Literal.String.Interpol */
.code-cell pre code .sx { color: #e6db74 } /* Literal.String.Other */
.code-cell pre code .sr { color: #e6db74 } /* Literal.String.Regex */
.code-cell pre code .s1 { color: #e6db74 } /* Literal.String.Single */
.code-cell pre code .ss { color: #e6db74 } /* Literal.String.Symbol */
.code-cell pre code .bp { color: #f8f8f2 } /* Name.Builtin.Pseudo */
.code-cell pre code .fm { color: #a6e22e } /* Name.Function.Magic */
.code-cell pre code .vc { color: #f8f8f2 } /* Name.Variable.Class */
.code-cell pre code .vg { color: #f8f8f2 } /* Name.Variable.Global */
.code-cell pre code .vi { color: #f8f8f2 } /* Name.Variable.Instance */
.code-cell pre code .vm { color: #f8f8f2 } /* Name.Variable.Magic */
.code-cell pre code .il { color: #ae81ff } /* Literal.Number.Integer.Long */

/* === Responsive === */
/* === Mobile Overrides === */
@media (max-width: 768px) {
    .cell-toolbar {
        padding: 8px 12px;
    }
    .run-btn, .reset-btn, .copy-btn {
        min-height: 44px;
        min-width: 60px;
        font-size: 0.85rem;
        padding: 8px 16px;
    }
    .code-editor {
        font-size: 16px;  /* prevents iOS auto-zoom on focus */
        min-height: 100px;
    }
}

/* === Desktop === */
@media (min-width: 1024px) {
    .sidebar {
        transform: translateX(0);
        top: var(--header-height);
        padding-top: 8px;
        border-top: none;
    }
    .sidebar-overlay {
        display: none;
    }
    .main {
        margin-left: 296px;
    }
    .hamburger {
        display: none;
    }
}

/* Scrollbar styling */
::-webkit-scrollbar {
    width: 6px;
    height: 6px;
}
::-webkit-scrollbar-track {
    background: transparent;
}
::-webkit-scrollbar-thumb {
    background: rgba(255,255,255,0.15);
    border-radius: 3px;
}
::-webkit-scrollbar-thumb:hover {
    background: rgba(255,255,255,0.25);
}
</style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <button class="hamburger" onclick="toggleSidebar()" aria-label="Menu">â˜°</button>
        <span class="header-title">Crypto Algo Trading</span>
        <span class="header-module"></span>
    </div>

    <!-- Sidebar Overlay -->
    <div class="sidebar-overlay" onclick="closeSidebar()"></div>

    <!-- Sidebar -->
    <nav class="sidebar">
        <div class="sidebar-header">
            <h2>Crypto Algo Trading</h2>
        </div>
        <div class="sidebar-part">Overview</div>
<div class="sidebar-item">Course Overview</div>
<div class="sidebar-part">Part 1: Markets &amp; Data</div>
<div class="sidebar-item">Module 1: Cryptocurrency Fundamentals</div>
<div class="sidebar-item">Module 2: Crypto Data Sources</div>
<div class="sidebar-item">Module 3: Crypto Technical Analysis</div>
<div class="sidebar-item">Module 4: On-Chain Analytics</div>
<div class="sidebar-part">Part 2: Strategy Development</div>
<div class="sidebar-item">Module 5: Crypto Trading Strategies</div>
<div class="sidebar-item">Module 6: Backtesting Crypto Strategies</div>
<div class="sidebar-item">Module 7: Risk Management</div>
<div class="sidebar-item">Module 8: Automation Fundamentals</div>
<div class="sidebar-part">Part 3: Exchange Integration</div>
<div class="sidebar-item">Module 9: Exchange APIs Deep Dive</div>
<div class="sidebar-item">Module 10: Order Execution</div>
<div class="sidebar-item">Module 11: Live Trading</div>
<div class="sidebar-part">Part 4: DeFi &amp; Advanced</div>
<div class="sidebar-item">Module 12: DeFi Fundamentals</div>
<div class="sidebar-item">Module 13: DEX Trading</div>
<div class="sidebar-item">Module 14: Advanced DeFi Strategies</div>
<div class="sidebar-item">Module 15: Advanced Crypto Topics</div>
<div class="sidebar-part">Capstone</div>
<div class="sidebar-item">Capstone Project</div>
    </nav>

    <!-- Main Content -->
    <main class="main">
        <div class="module-section active" data-idx="0"><div class="md-cell module-header"><h1>Course 1: Crypto Algorithmic Trading</h1>
<h2>finqt Trading Courses</h2>
<hr />
<h2>ğŸ¯ Course Overview</h2>
<p>Master algorithmic trading in cryptocurrency markets. Learn crypto-specific analysis, implement trading strategies, connect to exchanges, and explore DeFi and on-chain analytics. Build automated bots for 24/7 markets.</p>
<hr />
<div class="table-wrapper"><table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>ğŸ“Š <strong>Level</strong></td>
<td>Intermediate</td>
</tr>
<tr>
<td>â±ï¸ <strong>Duration</strong></td>
<td>~35 hours</td>
</tr>
<tr>
<td>ğŸ“‹ <strong>Prerequisites</strong></td>
<td>Python for Finance (Course 0)</td>
</tr>
<tr>
<td>ğŸ’ª <strong>Exercises</strong></td>
<td>~90</td>
</tr>
<tr>
<td>ğŸ“š <strong>Modules</strong></td>
<td>15 + Capstone</td>
</tr>
</tbody>
</table></div></div>
<div class="md-cell"><hr />
<h2>ğŸ“š Course Structure</h2>
<h3>Part 1: Crypto Markets &amp; Data</h3>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Module</th>
<th>Topic</th>
<th>Duration</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>Cryptocurrency Fundamentals</td>
<td>~2.5h</td>
</tr>
<tr>
<td>2</td>
<td>Crypto Data Sources</td>
<td>~2.5h</td>
</tr>
<tr>
<td>3</td>
<td>Crypto Technical Analysis</td>
<td>~2.5h</td>
</tr>
<tr>
<td>4</td>
<td>On-Chain Analytics</td>
<td>~2.5h</td>
</tr>
</tbody>
</table></div>
<h3>Part 2: Strategy Development</h3>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Module</th>
<th>Topic</th>
<th>Duration</th>
</tr>
</thead>
<tbody>
<tr>
<td>5</td>
<td>Crypto Trading Strategies</td>
<td>~2.5h</td>
</tr>
<tr>
<td>6</td>
<td>Backtesting Crypto Strategies</td>
<td>~2.5h</td>
</tr>
<tr>
<td>7</td>
<td>Risk Management</td>
<td>~2.5h</td>
</tr>
<tr>
<td>8</td>
<td>Automation Fundamentals</td>
<td>~2.5h</td>
</tr>
</tbody>
</table></div>
<h3>Part 3: Exchange Integration</h3>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Module</th>
<th>Topic</th>
<th>Duration</th>
</tr>
</thead>
<tbody>
<tr>
<td>9</td>
<td>Exchange APIs Deep Dive</td>
<td>~2.5h</td>
</tr>
<tr>
<td>10</td>
<td>Order Execution</td>
<td>~2.5h</td>
</tr>
<tr>
<td>11</td>
<td>Live Trading</td>
<td>~2.5h</td>
</tr>
</tbody>
</table></div>
<h3>Part 4: DeFi &amp; Advanced Topics</h3>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Module</th>
<th>Topic</th>
<th>Duration</th>
</tr>
</thead>
<tbody>
<tr>
<td>12</td>
<td>DeFi Fundamentals</td>
<td>~2.5h</td>
</tr>
<tr>
<td>13</td>
<td>DEX Trading</td>
<td>~2.5h</td>
</tr>
<tr>
<td>14</td>
<td>Advanced DeFi Strategies</td>
<td>~2.5h</td>
</tr>
<tr>
<td>15</td>
<td>Advanced Crypto Topics</td>
<td>~2.5h</td>
</tr>
</tbody>
</table></div>
<h3>Capstone Project</h3>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Project</th>
<th>Description</th>
<th>Duration</th>
</tr>
</thead>
<tbody>
<tr>
<td>Final</td>
<td>Complete Crypto Trading System</td>
<td>~8-12h</td>
</tr>
</tbody>
</table></div></div>
<div class="md-cell"><hr />
<h2>ğŸ› ï¸ Setup Requirements</h2>
<h3>Required Libraries</h3>
<div class="highlight"><pre><span></span><code>pip install ccxt pandas numpy matplotlib plotly requests websocket-client python-dotenv schedule
</code></pre></div>

<h3>For DeFi Modules (Part 4)</h3>
<div class="highlight"><pre><span></span><code>pip install web3
</code></pre></div>

<h3>Exchange API Setup</h3>
<p>You'll need API keys from at least one exchange:
- <strong>Binance</strong> (recommended): binance.com
- <strong>Coinbase</strong>: coinbase.com
- <strong>Kraken</strong>: kraken.com</p>
<blockquote>
<p>âš ï¸ <strong>Security Note:</strong> Never share your API keys. Use read-only permissions when possible. Start with testnet/paper trading.</p>
</blockquote></div>
<div class="md-cell"><hr />
<h2>ğŸ“ How to Use This Course</h2>
<h3>Each Module Contains:</h3>
<ol>
<li><strong>ğŸ“– Narrative Explanations</strong> - Concepts explained with crypto context</li>
<li><strong>ğŸ’» Code Examples</strong> - Runnable code cells</li>
<li><strong>âœï¸ Exercises</strong> - Practice with collapsible solutions</li>
<li><strong>ğŸ—ï¸ Module Project</strong> - Comprehensive integration exercise</li>
</ol>
<h3>Exercise Format</h3>
<p>Each exercise has a <strong>collapsible solution</strong>. Try solving it yourself first, then click to reveal the solution if you're stuck.</p>
<h3>Recommended Approach</h3>
<ol>
<li>Read the explanations carefully</li>
<li>Run and modify code examples</li>
<li>Attempt exercises before viewing solutions</li>
<li>Complete the module project</li>
<li>Review key takeaways</li>
</ol></div>
<div class="md-cell"><hr />
<h2>âš ï¸ Risk Disclaimer</h2>
<p><strong>Cryptocurrency trading involves substantial risk of loss.</strong> This course is for educational purposes only.</p>
<ul>
<li>Never trade with money you can't afford to lose</li>
<li>Always start with paper trading / testnet</li>
<li>Past performance doesn't guarantee future results</li>
<li>The strategies taught are for learning, not financial advice</li>
</ul>
<hr />
<h2>Let's Begin!</h2>
<p>Start with <strong>Module 1: Cryptocurrency Fundamentals</strong> â†’</p></div>
        <div class="nav-buttons">
            <button class="nav-btn prev-btn disabled" type="button">
                <span class="nav-btn-label">â† Previous</span>
                <span class="nav-btn-name"></span>
            </button>
            <button class="nav-btn next-btn disabled" type="button">
                <span class="nav-btn-label">Next â†’</span>
                <span class="nav-btn-name"></span>
            </button>
        </div>
        </div>
<div class="module-section" data-idx="1"><div class="md-cell module-header"><h1>Module 1: Cryptocurrency Fundamentals</h1>
<h2>Part 1: Crypto Markets &amp; Data</h2>
<hr />
<div class="table-wrapper"><table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>â±ï¸ <strong>Duration</strong></td>
<td>~2.5 hours</td>
</tr>
<tr>
<td>ğŸ“‹ <strong>Prerequisites</strong></td>
<td>Python for Finance</td>
</tr>
<tr>
<td>ğŸ’ª <strong>Exercises</strong></td>
<td>5 total</td>
</tr>
</tbody>
</table></div></div>
<div class="md-cell"><h2>ğŸ¯ Learning Objectives</h2>
<ul>
<li>Understand CEX vs DEX exchanges</li>
<li>Read and analyze order books</li>
<li>Understand trading pairs and conventions</li>
<li>Differentiate spot from derivatives</li>
<li>Understand funding rates</li>
<li>Assess crypto-specific risks</li>
</ul></div>
<div class="md-cell"><hr />
<h1>Section 1: How Crypto Markets Work</h1>
<h2>1.1 Centralized vs Decentralized Exchanges</h2>
<h3>CEX (Binance, Coinbase, Kraken)</h3>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Feature</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Custody</strong></td>
<td>Exchange holds funds</td>
</tr>
<tr>
<td><strong>Speed</strong></td>
<td>Fast (milliseconds)</td>
</tr>
<tr>
<td><strong>Liquidity</strong></td>
<td>High</td>
</tr>
<tr>
<td><strong>KYC</strong></td>
<td>Required</td>
</tr>
</tbody>
</table></div>
<h3>DEX (Uniswap, dYdX)</h3>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Feature</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Custody</strong></td>
<td>Self-custody</td>
</tr>
<tr>
<td><strong>Speed</strong></td>
<td>Block time dependent</td>
</tr>
<tr>
<td><strong>Liquidity</strong></td>
<td>Varies</td>
</tr>
<tr>
<td><strong>KYC</strong></td>
<td>None</td>
</tr>
</tbody>
</table></div></div>
<div class="md-cell"><h2>1.2 Order Books</h2>
<div class="highlight"><pre><span></span><code>â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        BTC/USDT ORDER BOOK
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    ASKS (Sells)
    43,150  â”‚  2.5 BTC  â† Best Ask
    43,175  â”‚  1.2 BTC
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    SPREAD: $50 (0.12%)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    BIDS (Buys)
    43,100  â”‚  3.1 BTC  â† Best Bid
    43,075  â”‚  2.0 BTC
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
</code></pre></div>

<p><strong>Key Terms:</strong>
- <strong>Bid</strong>: Highest buy price
- <strong>Ask</strong>: Lowest sell price
- <strong>Spread</strong>: Ask - Bid</p></div>
<div class="code-cell" id="cell-1-0" data-source="IyBPcmRlciBib29rIGFuYWx5c2lzIGV4YW1wbGUKb3JkZXJfYm9vayA9IHsKICAgICdiaWRzJzogW1s0MzEwMCwgMy4xXSwgWzQzMDc1LCAyLjBdLCBbNDMwNTAsIDQuNV1dLAogICAgJ2Fza3MnOiBbWzQzMTUwLCAyLjVdLCBbNDMxNzUsIDEuMl0sIFs0MzIwMCwgNS4wXV0KfQoKYmVzdF9iaWQgPSBvcmRlcl9ib29rWydiaWRzJ11bMF1bMF0KYmVzdF9hc2sgPSBvcmRlcl9ib29rWydhc2tzJ11bMF1bMF0Kc3ByZWFkID0gYmVzdF9hc2sgLSBiZXN0X2JpZApzcHJlYWRfcGN0ID0gKHNwcmVhZCAvIGJlc3RfYmlkKSAqIDEwMAoKcHJpbnQoZidCZXN0IEJpZDogJHtiZXN0X2JpZDosfScpCnByaW50KGYnQmVzdCBBc2s6ICR7YmVzdF9hc2s6LH0nKQpwcmludChmJ1NwcmVhZDogJHtzcHJlYWR9ICh7c3ByZWFkX3BjdDouM2Z9JSknKQ=="><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-1-0')" type="button">Run</button></div><pre><code><span class="c1"># Order book analysis example</span>
<span class="n">order_book</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;bids&#39;</span><span class="p">:</span> <span class="p">[[</span><span class="mi">43100</span><span class="p">,</span> <span class="mf">3.1</span><span class="p">],</span> <span class="p">[</span><span class="mi">43075</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">],</span> <span class="p">[</span><span class="mi">43050</span><span class="p">,</span> <span class="mf">4.5</span><span class="p">]],</span>
    <span class="s1">&#39;asks&#39;</span><span class="p">:</span> <span class="p">[[</span><span class="mi">43150</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">],</span> <span class="p">[</span><span class="mi">43175</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">],</span> <span class="p">[</span><span class="mi">43200</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">]]</span>
<span class="p">}</span>

<span class="n">best_bid</span> <span class="o">=</span> <span class="n">order_book</span><span class="p">[</span><span class="s1">&#39;bids&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<span class="n">best_ask</span> <span class="o">=</span> <span class="n">order_book</span><span class="p">[</span><span class="s1">&#39;asks&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<span class="n">spread</span> <span class="o">=</span> <span class="n">best_ask</span> <span class="o">-</span> <span class="n">best_bid</span>
<span class="n">spread_pct</span> <span class="o">=</span> <span class="p">(</span><span class="n">spread</span> <span class="o">/</span> <span class="n">best_bid</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Best Bid: $</span><span class="si">{</span><span class="n">best_bid</span><span class="si">:</span><span class="s1">,</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Best Ask: $</span><span class="si">{</span><span class="n">best_ask</span><span class="si">:</span><span class="s1">,</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Spread: $</span><span class="si">{</span><span class="n">spread</span><span class="si">}</span><span class="s1"> (</span><span class="si">{</span><span class="n">spread_pct</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">%)&#39;</span><span class="p">)</span>
</code></pre><div class="code-output" id="output-cell-1-0"></div></div>
<div class="md-cell"><h3>âœï¸ Exercise 1.1: Analyze Order Book</h3>
<p>Calculate spread, depth, and price impact for a $50,000 market buy.</p></div>
<div class="code-cell" id="cell-1-1" data-source="IyBFeGVyY2lzZSAxLjEKb3JkZXJfYm9vayA9IHsKICAgICdiaWRzJzogW1syMjQwLCAxMF0sIFsyMjM1LCAxNV0sIFsyMjMwLCAyNV1dLAogICAgJ2Fza3MnOiBbWzIyNDUsIDhdLCBbMjI1MCwgMTJdLCBbMjI2MCwgMjBdXQp9CgojIFlvdXIgc29sdXRpb246CmJlc3RfYmlkID0gTm9uZSAgIyBUT0RPCmJlc3RfYXNrID0gTm9uZSAgIyBUT0RPCnNwcmVhZCA9IE5vbmUgICMgVE9ETw=="><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-1-1')" type="button">Run</button></div><pre><code><span class="c1"># Exercise 1.1</span>
<span class="n">order_book</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;bids&#39;</span><span class="p">:</span> <span class="p">[[</span><span class="mi">2240</span><span class="p">,</span> <span class="mi">10</span><span class="p">],</span> <span class="p">[</span><span class="mi">2235</span><span class="p">,</span> <span class="mi">15</span><span class="p">],</span> <span class="p">[</span><span class="mi">2230</span><span class="p">,</span> <span class="mi">25</span><span class="p">]],</span>
    <span class="s1">&#39;asks&#39;</span><span class="p">:</span> <span class="p">[[</span><span class="mi">2245</span><span class="p">,</span> <span class="mi">8</span><span class="p">],</span> <span class="p">[</span><span class="mi">2250</span><span class="p">,</span> <span class="mi">12</span><span class="p">],</span> <span class="p">[</span><span class="mi">2260</span><span class="p">,</span> <span class="mi">20</span><span class="p">]]</span>
<span class="p">}</span>

<span class="c1"># Your solution:</span>
<span class="n">best_bid</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># TODO</span>
<span class="n">best_ask</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># TODO</span>
<span class="n">spread</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># TODO</span>
</code></pre><div class="code-output" id="output-cell-1-1"></div></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="n">best_bid</span> <span class="o">=</span> <span class="n">order_book</span><span class="p">[</span><span class="s1">&#39;bids&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># 2240</span>
<span class="n">best_ask</span> <span class="o">=</span> <span class="n">order_book</span><span class="p">[</span><span class="s1">&#39;asks&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># 2245</span>
<span class="n">spread</span> <span class="o">=</span> <span class="n">best_ask</span> <span class="o">-</span> <span class="n">best_bid</span>  <span class="c1"># 5</span>
<span class="n">spread_pct</span> <span class="o">=</span> <span class="p">(</span><span class="n">spread</span> <span class="o">/</span> <span class="n">best_bid</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>  <span class="c1"># 0.223%</span>

<span class="n">bid_depth</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">p</span> <span class="o">*</span> <span class="n">a</span> <span class="k">for</span> <span class="n">p</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">order_book</span><span class="p">[</span><span class="s1">&#39;bids&#39;</span><span class="p">])</span>
<span class="n">ask_depth</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">p</span> <span class="o">*</span> <span class="n">a</span> <span class="k">for</span> <span class="n">p</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">order_book</span><span class="p">[</span><span class="s1">&#39;asks&#39;</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Spread: $</span><span class="si">{</span><span class="n">spread</span><span class="si">}</span><span class="s1"> (</span><span class="si">{</span><span class="n">spread_pct</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">%)&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Bid Depth: $</span><span class="si">{</span><span class="n">bid_depth</span><span class="si">:</span><span class="s1">,</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Ask Depth: $</span><span class="si">{</span><span class="n">ask_depth</span><span class="si">:</span><span class="s1">,</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>Section 2: Market Structure</h1>
<h2>2.1 Spot vs Derivatives</h2>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Feature</th>
<th>Spot</th>
<th>Futures</th>
</tr>
</thead>
<tbody>
<tr>
<td>Ownership</td>
<td>Actual asset</td>
<td>Contract</td>
</tr>
<tr>
<td>Leverage</td>
<td>1x</td>
<td>Up to 125x</td>
</tr>
<tr>
<td>Expiration</td>
<td>None</td>
<td>Quarterly/Perpetual</td>
</tr>
</tbody>
</table></div>
<h2>2.2 Perpetual Futures &amp; Funding Rates</h2>
<p>Funding keeps perp prices aligned with spot:
- <strong>Positive funding</strong>: Longs pay shorts
- <strong>Negative funding</strong>: Shorts pay longs
- Paid every 8 hours</p></div>
<div class="code-cell" id="cell-1-2" data-source="IyBGdW5kaW5nIHJhdGUgY2FsY3VsYXRpb24KZGVmIGNhbGN1bGF0ZV9mdW5kaW5nX2Nvc3QocG9zaXRpb25fc2l6ZSwgZnVuZGluZ19yYXRlLCBwZXJpb2RzX3Blcl9kYXk9Myk6CiAgICBkYWlseSA9IHBvc2l0aW9uX3NpemUgKiAoZnVuZGluZ19yYXRlIC8gMTAwKSAqIHBlcmlvZHNfcGVyX2RheQogICAgYW5udWFsID0gZGFpbHkgKiAzNjUKICAgIGFubnVhbF9yYXRlID0gKGZ1bmRpbmdfcmF0ZSAvIDEwMCkgKiBwZXJpb2RzX3Blcl9kYXkgKiAzNjUgKiAxMDAKICAgIHJldHVybiB7J2RhaWx5JzogZGFpbHksICdhbm51YWwnOiBhbm51YWwsICdhbm51YWxfcmF0ZSc6IGFubnVhbF9yYXRlfQoKY29zdHMgPSBjYWxjdWxhdGVfZnVuZGluZ19jb3N0KDEwMDAwMCwgMC4wMykKcHJpbnQoZidEYWlseSBmdW5kaW5nIGNvc3Q6ICR7Y29zdHNbImRhaWx5Il06LjJmfScpCnByaW50KGYnQW5udWFsaXplZCByYXRlOiB7Y29zdHNbImFubnVhbF9yYXRlIl06LjFmfSUnKQ=="><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-1-2')" type="button">Run</button></div><pre><code><span class="c1"># Funding rate calculation</span>
<span class="k">def</span> <span class="nf">calculate_funding_cost</span><span class="p">(</span><span class="n">position_size</span><span class="p">,</span> <span class="n">funding_rate</span><span class="p">,</span> <span class="n">periods_per_day</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
    <span class="n">daily</span> <span class="o">=</span> <span class="n">position_size</span> <span class="o">*</span> <span class="p">(</span><span class="n">funding_rate</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span> <span class="o">*</span> <span class="n">periods_per_day</span>
    <span class="n">annual</span> <span class="o">=</span> <span class="n">daily</span> <span class="o">*</span> <span class="mi">365</span>
    <span class="n">annual_rate</span> <span class="o">=</span> <span class="p">(</span><span class="n">funding_rate</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span> <span class="o">*</span> <span class="n">periods_per_day</span> <span class="o">*</span> <span class="mi">365</span> <span class="o">*</span> <span class="mi">100</span>
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;daily&#39;</span><span class="p">:</span> <span class="n">daily</span><span class="p">,</span> <span class="s1">&#39;annual&#39;</span><span class="p">:</span> <span class="n">annual</span><span class="p">,</span> <span class="s1">&#39;annual_rate&#39;</span><span class="p">:</span> <span class="n">annual_rate</span><span class="p">}</span>

<span class="n">costs</span> <span class="o">=</span> <span class="n">calculate_funding_cost</span><span class="p">(</span><span class="mi">100000</span><span class="p">,</span> <span class="mf">0.03</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Daily funding cost: $</span><span class="si">{</span><span class="n">costs</span><span class="p">[</span><span class="s2">&quot;daily&quot;</span><span class="p">]</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Annualized rate: </span><span class="si">{</span><span class="n">costs</span><span class="p">[</span><span class="s2">&quot;annual_rate&quot;</span><span class="p">]</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">%&#39;</span><span class="p">)</span>
</code></pre><div class="code-output" id="output-cell-1-2"></div></div>
<div class="md-cell"><h3>âœï¸ Exercise 1.2: Exchange Volume Comparison</h3>
<p>Calculate market share for each exchange.</p></div>
<div class="code-cell" id="cell-1-3" data-source="IyBFeGVyY2lzZSAxLjIKZXhjaGFuZ2VzID0gewogICAgJ0JpbmFuY2UnOiB7J3ZvbHVtZV8yNGgnOiAxNV8wMDBfMDAwXzAwMH0sCiAgICAnQ29pbmJhc2UnOiB7J3ZvbHVtZV8yNGgnOiAzXzAwMF8wMDBfMDAwfSwKICAgICdLcmFrZW4nOiB7J3ZvbHVtZV8yNGgnOiAxXzUwMF8wMDBfMDAwfQp9CgojIFlvdXIgc29sdXRpb246CnRvdGFsX3ZvbHVtZSA9IE5vbmUgICMgVE9ETwptYXJrZXRfc2hhcmVzID0ge30gICMgVE9ETw=="><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-1-3')" type="button">Run</button></div><pre><code><span class="c1"># Exercise 1.2</span>
<span class="n">exchanges</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;Binance&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;volume_24h&#39;</span><span class="p">:</span> <span class="mi">15_000_000_000</span><span class="p">},</span>
    <span class="s1">&#39;Coinbase&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;volume_24h&#39;</span><span class="p">:</span> <span class="mi">3_000_000_000</span><span class="p">},</span>
    <span class="s1">&#39;Kraken&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;volume_24h&#39;</span><span class="p">:</span> <span class="mi">1_500_000_000</span><span class="p">}</span>
<span class="p">}</span>

<span class="c1"># Your solution:</span>
<span class="n">total_volume</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># TODO</span>
<span class="n">market_shares</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># TODO</span>
</code></pre><div class="code-output" id="output-cell-1-3"></div></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="n">total_volume</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="s1">&#39;volume_24h&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">exchanges</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
<span class="n">market_shares</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">name</span><span class="p">:</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;volume_24h&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">total_volume</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">exchanges</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
<span class="p">}</span>
<span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">share</span> <span class="ow">in</span> <span class="n">market_shares</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">share</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">%&#39;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>Section 3: Crypto Risks</h1>
<h2>3.1 Exchange Risks</h2>
<ul>
<li><strong>Mt. Gox (2014)</strong>: $450M lost</li>
<li><strong>FTX (2022)</strong>: $8B lost</li>
</ul>
<h2>3.2 Risk Mitigation</h2>
<ol>
<li>Don't keep all funds on exchange</li>
<li>Diversify across exchanges</li>
<li>Use hardware wallets</li>
<li>Enable 2FA</li>
</ol></div>
<div class="md-cell"><h3>âœï¸ Exercise 1.3: Risk Assessment</h3>
<p>Create a function scoring exchange safety (0-100).</p></div>
<div class="code-cell" id="cell-1-4" data-source="IyBFeGVyY2lzZSAxLjMKZGVmIGFzc2Vzc19leGNoYW5nZV9yaXNrKGRhdGEpOgogICAgc2NvcmUgPSAwCiAgICAjIFRPRE86IEFkZCBzY29yaW5nIGxvZ2ljCiAgICByZXR1cm4gc2NvcmUKCmV4Y2hhbmdlID0gewogICAgJ3llYXJzX29wZXJhdGluZyc6IDcsCiAgICAnaGFzX3Byb29mX29mX3Jlc2VydmVzJzogVHJ1ZSwKICAgICdyZWd1bGF0ZWQnOiBGYWxzZSwKICAgICdoYWNrX2hpc3RvcnknOiBUcnVlCn0="><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-1-4')" type="button">Run</button></div><pre><code><span class="c1"># Exercise 1.3</span>
<span class="k">def</span> <span class="nf">assess_exchange_risk</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="n">score</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="c1"># TODO: Add scoring logic</span>
    <span class="k">return</span> <span class="n">score</span>

<span class="n">exchange</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;years_operating&#39;</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span>
    <span class="s1">&#39;has_proof_of_reserves&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
    <span class="s1">&#39;regulated&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
    <span class="s1">&#39;hack_history&#39;</span><span class="p">:</span> <span class="kc">True</span>
<span class="p">}</span>
</code></pre><div class="code-output" id="output-cell-1-4"></div></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">assess_exchange_risk</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="n">score</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">score</span> <span class="o">+=</span> <span class="nb">min</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;years_operating&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;has_proof_of_reserves&#39;</span><span class="p">]:</span> <span class="n">score</span> <span class="o">+=</span> <span class="mi">25</span>
    <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;regulated&#39;</span><span class="p">]:</span> <span class="n">score</span> <span class="o">+=</span> <span class="mi">25</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;hack_history&#39;</span><span class="p">]:</span> <span class="n">score</span> <span class="o">+=</span> <span class="mi">20</span>
    <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Risk Score: </span><span class="si">{</span><span class="n">assess_exchange_risk</span><span class="p">(</span><span class="n">exchange</span><span class="p">)</span><span class="si">}</span><span class="s1">/100&#39;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>Section 4: 24/7 Markets &amp; Volatility</h1>
<h2>Trading Sessions</h2>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Session</th>
<th>UTC</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td>Asia</td>
<td>00:00-08:00</td>
<td>High activity</td>
</tr>
<tr>
<td>Europe</td>
<td>07:00-16:00</td>
<td>Moderate</td>
</tr>
<tr>
<td>US</td>
<td>13:00-22:00</td>
<td>Most volatile</td>
</tr>
</tbody>
</table></div>
<h2>Volatility Comparison</h2>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Asset</th>
<th>Daily Range</th>
<th>Annual Vol</th>
</tr>
</thead>
<tbody>
<tr>
<td>S&amp;P 500</td>
<td>0.5-1%</td>
<td>~15-20%</td>
</tr>
<tr>
<td><strong>Bitcoin</strong></td>
<td>2-5%</td>
<td>~60-80%</td>
</tr>
<tr>
<td><strong>Altcoins</strong></td>
<td>5-15%</td>
<td>~100-200%</td>
</tr>
</tbody>
</table></div></div>
<div class="md-cell"><h3>âœï¸ Exercise 1.4: Volatility Analysis</h3>
<p>Calculate daily returns and rolling volatility.</p></div>
<div class="code-cell" id="cell-1-5" data-source="IyBFeGVyY2lzZSAxLjQKcHJpY2VzID0gWzQyMDAwLCA0MjUwMCwgNDE4MDAsIDQzMjAwLCA0NDEwMCwgNDM1MDAsIDQyODAwXQoKIyBZb3VyIHNvbHV0aW9uOgpkYWlseV9yZXR1cm5zID0gW10gICMgVE9ETw=="><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-1-5')" type="button">Run</button></div><pre><code><span class="c1"># Exercise 1.4</span>
<span class="n">prices</span> <span class="o">=</span> <span class="p">[</span><span class="mi">42000</span><span class="p">,</span> <span class="mi">42500</span><span class="p">,</span> <span class="mi">41800</span><span class="p">,</span> <span class="mi">43200</span><span class="p">,</span> <span class="mi">44100</span><span class="p">,</span> <span class="mi">43500</span><span class="p">,</span> <span class="mi">42800</span><span class="p">]</span>

<span class="c1"># Your solution:</span>
<span class="n">daily_returns</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># TODO</span>
</code></pre><div class="code-output" id="output-cell-1-5"></div></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="n">daily_returns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">((</span><span class="n">prices</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">prices</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="n">prices</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="mi">100</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">prices</span><span class="p">))</span>
<span class="p">]</span>
<span class="n">avg_return</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">daily_returns</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">daily_returns</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Daily returns: </span><span class="si">{</span><span class="n">daily_returns</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Avg daily return: </span><span class="si">{</span><span class="n">avg_return</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">%&#39;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>ğŸ—ï¸ Module Project: Market Overview Dashboard</h1>
<p>Build a function displaying market metrics, funding analysis, and risk warnings.</p></div>
<div class="code-cell" id="cell-1-6" data-source="IyBNb2R1bGUgUHJvamVjdApkZWYgbWFya2V0X292ZXJ2aWV3KGJ0Y19wcmljZSwgdm9sdW1lXzI0aCwgZnVuZGluZ19yYXRlLCBzcHJlYWRfcGN0KToKICAgICMgVE9ETzogQnVpbGQgY29tcHJlaGVuc2l2ZSBkYXNoYm9hcmQKICAgIHBhc3MKCm1hcmtldF9vdmVydmlldyg0MzAwMCwgMjVfMDAwXzAwMF8wMDAsIDAuMDE1LCAwLjA1KQ=="><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-1-6')" type="button">Run</button></div><pre><code><span class="c1"># Module Project</span>
<span class="k">def</span> <span class="nf">market_overview</span><span class="p">(</span><span class="n">btc_price</span><span class="p">,</span> <span class="n">volume_24h</span><span class="p">,</span> <span class="n">funding_rate</span><span class="p">,</span> <span class="n">spread_pct</span><span class="p">):</span>
    <span class="c1"># TODO: Build comprehensive dashboard</span>
    <span class="k">pass</span>

<span class="n">market_overview</span><span class="p">(</span><span class="mi">43000</span><span class="p">,</span> <span class="mi">25_000_000_000</span><span class="p">,</span> <span class="mf">0.015</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">)</span>
</code></pre><div class="code-output" id="output-cell-1-6"></div></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">market_overview</span><span class="p">(</span><span class="n">btc_price</span><span class="p">,</span> <span class="n">volume_24h</span><span class="p">,</span> <span class="n">funding_rate</span><span class="p">,</span> <span class="n">spread_pct</span><span class="p">):</span>
    <span class="n">annual_funding</span> <span class="o">=</span> <span class="n">funding_rate</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">*</span> <span class="mi">365</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=&#39;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;       CRYPTO MARKET OVERVIEW&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=&#39;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;BTC Price: $</span><span class="si">{</span><span class="n">btc_price</span><span class="si">:</span><span class="s1">,</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;24h Volume: $</span><span class="si">{</span><span class="n">volume_24h</span><span class="o">/</span><span class="mf">1e9</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">B&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Spread: </span><span class="si">{</span><span class="n">spread_pct</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">%&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Funding (8h): </span><span class="si">{</span><span class="n">funding_rate</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">%&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Funding (Annual): </span><span class="si">{</span><span class="n">annual_funding</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">%&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">funding_rate</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.05</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;âš ï¸ Extreme funding - crowded trade&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=&#39;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>

<span class="n">market_overview</span><span class="p">(</span><span class="mi">43000</span><span class="p">,</span> <span class="mi">25_000_000_000</span><span class="p">,</span> <span class="mf">0.015</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>ğŸ“ Key Takeaways</h1>
<ol>
<li><strong>CEX vs DEX</strong>: Speed vs self-custody tradeoff</li>
<li><strong>Order Books</strong>: Spread indicates liquidity</li>
<li><strong>Funding Rates</strong>: Cost of holding perpetual positions</li>
<li><strong>Risks</strong>: Exchange failures, hacks, manipulation</li>
<li><strong>24/7 Markets</strong>: Higher volatility than traditional assets</li>
</ol>
<hr />
<p><em>Next: Module 2 - Crypto Data Sources</em></p></div>
        <div class="nav-buttons">
            <button class="nav-btn prev-btn disabled" type="button">
                <span class="nav-btn-label">â† Previous</span>
                <span class="nav-btn-name"></span>
            </button>
            <button class="nav-btn next-btn disabled" type="button">
                <span class="nav-btn-label">Next â†’</span>
                <span class="nav-btn-name"></span>
            </button>
        </div>
        </div>
<div class="module-section" data-idx="2"><div class="md-cell module-header"><h1>Module 2: Crypto Data Sources</h1>
<h2>Part 1: Crypto Markets &amp; Data</h2>
<hr />
<div class="table-wrapper"><table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>â±ï¸ <strong>Duration</strong></td>
<td>~2.5 hours</td>
</tr>
<tr>
<td>ğŸ“‹ <strong>Prerequisites</strong></td>
<td>Module 1</td>
</tr>
<tr>
<td>ğŸ’ª <strong>Exercises</strong></td>
<td>5 total</td>
</tr>
</tbody>
</table></div></div>
<div class="md-cell"><h2>ğŸ¯ Learning Objectives</h2>
<ul>
<li>Connect to exchanges using CCXT</li>
<li>Download historical OHLCV data</li>
<li>Set up WebSocket streams</li>
<li>Access alternative data sources</li>
</ul></div>
<div class="md-cell"><hr />
<h1>Section 1: Exchange APIs with CCXT</h1>
<p>CCXT is a unified library supporting 100+ exchanges.</p>
<div class="highlight"><pre><span></span><code>pip install ccxt
</code></pre></div></div>
<div class="code-cell" id="cell-2-0" data-source="aW1wb3J0IGNjeHQKCiMgTGlzdCBhdmFpbGFibGUgZXhjaGFuZ2VzCnByaW50KGYnU3VwcG9ydGVkIGV4Y2hhbmdlczoge2xlbihjY3h0LmV4Y2hhbmdlcyl9JykKcHJpbnQoY2N4dC5leGNoYW5nZXNbOjEwXSk="><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-2-0')" type="button">Run</button></div><pre><code><span class="kn">import</span> <span class="nn">ccxt</span>

<span class="c1"># List available exchanges</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Supported exchanges: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">ccxt</span><span class="o">.</span><span class="n">exchanges</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">ccxt</span><span class="o">.</span><span class="n">exchanges</span><span class="p">[:</span><span class="mi">10</span><span class="p">])</span>
</code></pre><div class="code-output" id="output-cell-2-0"></div></div>
<div class="code-cell" id="cell-2-1" data-source="IyBDb25uZWN0IHRvIEJpbmFuY2UgKHB1YmxpYyBkYXRhLCBubyBBUEkga2V5IG5lZWRlZCkKZXhjaGFuZ2UgPSBjY3h0LmJpbmFuY2UoKQoKIyBGZXRjaCB0aWNrZXIKdGlja2VyID0gZXhjaGFuZ2UuZmV0Y2hfdGlja2VyKCdCVEMvVVNEVCcpCnByaW50KGYiQlRDIFByaWNlOiAke3RpY2tlclsnbGFzdCddOiwuMmZ9IikKcHJpbnQoZiIyNGggVm9sdW1lOiAke3RpY2tlclsncXVvdGVWb2x1bWUnXTosLjBmfSIp"><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-2-1')" type="button">Run</button></div><pre><code><span class="c1"># Connect to Binance (public data, no API key needed)</span>
<span class="n">exchange</span> <span class="o">=</span> <span class="n">ccxt</span><span class="o">.</span><span class="n">binance</span><span class="p">()</span>

<span class="c1"># Fetch ticker</span>
<span class="n">ticker</span> <span class="o">=</span> <span class="n">exchange</span><span class="o">.</span><span class="n">fetch_ticker</span><span class="p">(</span><span class="s1">&#39;BTC/USDT&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;BTC Price: $</span><span class="si">{</span><span class="n">ticker</span><span class="p">[</span><span class="s1">&#39;last&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">,.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;24h Volume: $</span><span class="si">{</span><span class="n">ticker</span><span class="p">[</span><span class="s1">&#39;quoteVolume&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">,.0f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre><div class="code-output" id="output-cell-2-1"></div></div>
<div class="md-cell"><h3>âœï¸ Exercise 2.1: Connect to Exchange</h3>
<p>Fetch ETH/USDT ticker and display price, volume, and 24h change.</p></div>
<div class="code-cell" id="cell-2-2" data-source="IyBFeGVyY2lzZSAyLjEKIyBZb3VyIHNvbHV0aW9uOgpleGNoYW5nZSA9IGNjeHQuYmluYW5jZSgpCiMgVE9ETzogRmV0Y2ggRVRIL1VTRFQgdGlja2Vy"><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-2-2')" type="button">Run</button></div><pre><code><span class="c1"># Exercise 2.1</span>
<span class="c1"># Your solution:</span>
<span class="n">exchange</span> <span class="o">=</span> <span class="n">ccxt</span><span class="o">.</span><span class="n">binance</span><span class="p">()</span>
<span class="c1"># TODO: Fetch ETH/USDT ticker</span>
</code></pre><div class="code-output" id="output-cell-2-2"></div></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="n">exchange</span> <span class="o">=</span> <span class="n">ccxt</span><span class="o">.</span><span class="n">binance</span><span class="p">()</span>
<span class="n">ticker</span> <span class="o">=</span> <span class="n">exchange</span><span class="o">.</span><span class="n">fetch_ticker</span><span class="p">(</span><span class="s1">&#39;ETH/USDT&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ETH Price: $</span><span class="si">{</span><span class="n">ticker</span><span class="p">[</span><span class="s1">&#39;last&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">,.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;24h Volume: $</span><span class="si">{</span><span class="n">ticker</span><span class="p">[</span><span class="s1">&#39;quoteVolume&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">,.0f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;24h Change: </span><span class="si">{</span><span class="n">ticker</span><span class="p">[</span><span class="s1">&#39;percentage&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>Section 2: Historical OHLCV Data</h1>
<p>OHLCV = Open, High, Low, Close, Volume</p></div>
<div class="code-cell" id="cell-2-3" data-source="aW1wb3J0IHBhbmRhcyBhcyBwZAoKIyBGZXRjaCBPSExDViBkYXRhCmV4Y2hhbmdlID0gY2N4dC5iaW5hbmNlKCkKb2hsY3YgPSBleGNoYW5nZS5mZXRjaF9vaGxjdignQlRDL1VTRFQnLCAnMWgnLCBsaW1pdD0xMDApCgojIENvbnZlcnQgdG8gRGF0YUZyYW1lCmRmID0gcGQuRGF0YUZyYW1lKG9obGN2LCBjb2x1bW5zPVsndGltZXN0YW1wJywgJ29wZW4nLCAnaGlnaCcsICdsb3cnLCAnY2xvc2UnLCAndm9sdW1lJ10pCmRmWyd0aW1lc3RhbXAnXSA9IHBkLnRvX2RhdGV0aW1lKGRmWyd0aW1lc3RhbXAnXSwgdW5pdD0nbXMnKQpkZi5zZXRfaW5kZXgoJ3RpbWVzdGFtcCcsIGlucGxhY2U9VHJ1ZSkKCnByaW50KGRmLnRhaWwoKSk="><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-2-3')" type="button">Run</button></div><pre><code><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="c1"># Fetch OHLCV data</span>
<span class="n">exchange</span> <span class="o">=</span> <span class="n">ccxt</span><span class="o">.</span><span class="n">binance</span><span class="p">()</span>
<span class="n">ohlcv</span> <span class="o">=</span> <span class="n">exchange</span><span class="o">.</span><span class="n">fetch_ohlcv</span><span class="p">(</span><span class="s1">&#39;BTC/USDT&#39;</span><span class="p">,</span> <span class="s1">&#39;1h&#39;</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>

<span class="c1"># Convert to DataFrame</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">ohlcv</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">,</span> <span class="s1">&#39;open&#39;</span><span class="p">,</span> <span class="s1">&#39;high&#39;</span><span class="p">,</span> <span class="s1">&#39;low&#39;</span><span class="p">,</span> <span class="s1">&#39;close&#39;</span><span class="p">,</span> <span class="s1">&#39;volume&#39;</span><span class="p">])</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">],</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;ms&#39;</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;timestamp&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">tail</span><span class="p">())</span>
</code></pre><div class="code-output" id="output-cell-2-3"></div></div>
<div class="md-cell"><h3>âœï¸ Exercise 2.2: Build Data Pipeline</h3>
<p>Create function to download data for multiple symbols and timeframes.</p></div>
<div class="code-cell" id="cell-2-4" data-source="IyBFeGVyY2lzZSAyLjIKZGVmIGZldGNoX2NyeXB0b19kYXRhKHN5bWJvbCwgdGltZWZyYW1lPScxaCcsIGxpbWl0PTEwMCk6CiAgICAjIFRPRE86IFJldHVybiBEYXRhRnJhbWUgd2l0aCBPSExDViBkYXRhCiAgICBwYXNz"><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-2-4')" type="button">Run</button></div><pre><code><span class="c1"># Exercise 2.2</span>
<span class="k">def</span> <span class="nf">fetch_crypto_data</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">timeframe</span><span class="o">=</span><span class="s1">&#39;1h&#39;</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
    <span class="c1"># TODO: Return DataFrame with OHLCV data</span>
    <span class="k">pass</span>
</code></pre><div class="code-output" id="output-cell-2-4"></div></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">fetch_crypto_data</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">timeframe</span><span class="o">=</span><span class="s1">&#39;1h&#39;</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
    <span class="n">exchange</span> <span class="o">=</span> <span class="n">ccxt</span><span class="o">.</span><span class="n">binance</span><span class="p">()</span>
    <span class="n">ohlcv</span> <span class="o">=</span> <span class="n">exchange</span><span class="o">.</span><span class="n">fetch_ohlcv</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">timeframe</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">)</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">ohlcv</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">,</span> <span class="s1">&#39;open&#39;</span><span class="p">,</span> <span class="s1">&#39;high&#39;</span><span class="p">,</span> <span class="s1">&#39;low&#39;</span><span class="p">,</span> <span class="s1">&#39;close&#39;</span><span class="p">,</span> <span class="s1">&#39;volume&#39;</span><span class="p">])</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">],</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;ms&#39;</span><span class="p">)</span>
    <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;timestamp&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;symbol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">symbol</span>

    <span class="k">return</span> <span class="n">df</span>

<span class="n">btc</span> <span class="o">=</span> <span class="n">fetch_crypto_data</span><span class="p">(</span><span class="s1">&#39;BTC/USDT&#39;</span><span class="p">,</span> <span class="s1">&#39;4h&#39;</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">btc</span><span class="o">.</span><span class="n">head</span><span class="p">())</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>Section 3: Real-Time WebSocket Data</h1>
<p>WebSockets provide streaming data without polling.</p></div>
<div class="code-cell" id="cell-2-5" data-source="IyBDb25jZXB0dWFsIFdlYlNvY2tldCBleGFtcGxlCiMgTm90ZTogVGhpcyByZXF1aXJlcyB3ZWJzb2NrZXQtY2xpZW50IGxpYnJhcnkKCmltcG9ydCBqc29uCgojIEJpbmFuY2UgV2ViU29ja2V0IFVSTCBmb3IgQlRDL1VTRFQgdHJhZGVzCndzX3VybCA9ICd3c3M6Ly9zdHJlYW0uYmluYW5jZS5jb206OTQ0My93cy9idGN1c2R0QHRyYWRlJwoKZGVmIG9uX21lc3NhZ2Uod3MsIG1lc3NhZ2UpOgogICAgZGF0YSA9IGpzb24ubG9hZHMobWVzc2FnZSkKICAgIHByaWNlID0gZmxvYXQoZGF0YVsncCddKQogICAgcXR5ID0gZmxvYXQoZGF0YVsncSddKQogICAgcHJpbnQoZiJUcmFkZToge3F0eTouNGZ9IEJUQyBAICR7cHJpY2U6LC4yZn0iKQoKIyBJbiBwcmFjdGljZTogd2Vic29ja2V0LldlYlNvY2tldEFwcCh3c191cmwsIG9uX21lc3NhZ2U9b25fbWVzc2FnZSk="><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-2-5')" type="button">Run</button></div><pre><code><span class="c1"># Conceptual WebSocket example</span>
<span class="c1"># Note: This requires websocket-client library</span>

<span class="kn">import</span> <span class="nn">json</span>

<span class="c1"># Binance WebSocket URL for BTC/USDT trades</span>
<span class="n">ws_url</span> <span class="o">=</span> <span class="s1">&#39;wss://stream.binance.com:9443/ws/btcusdt@trade&#39;</span>

<span class="k">def</span> <span class="nf">on_message</span><span class="p">(</span><span class="n">ws</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
    <span class="n">price</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">])</span>
    <span class="n">qty</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;q&#39;</span><span class="p">])</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Trade: </span><span class="si">{</span><span class="n">qty</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> BTC @ $</span><span class="si">{</span><span class="n">price</span><span class="si">:</span><span class="s2">,.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># In practice: websocket.WebSocketApp(ws_url, on_message=on_message)</span>
</code></pre><div class="code-output" id="output-cell-2-5"></div></div>
<div class="md-cell"><h3>âœï¸ Exercise 2.3: Real-Time Price Monitor</h3>
<p>Create a price monitor class that tracks latest price and calculates moving average.</p></div>
<div class="code-cell" id="cell-2-6" data-source="IyBFeGVyY2lzZSAyLjMKY2xhc3MgUHJpY2VNb25pdG9yOgogICAgZGVmIF9faW5pdF9fKHNlbGYsIHdpbmRvdz0yMCk6CiAgICAgICAgc2VsZi5wcmljZXMgPSBbXQogICAgICAgIHNlbGYud2luZG93ID0gd2luZG93CiAgICAKICAgIGRlZiB1cGRhdGUoc2VsZiwgcHJpY2UpOgogICAgICAgICMgVE9ETzogQWRkIHByaWNlIGFuZCBjYWxjdWxhdGUgbW92aW5nIGF2ZXJhZ2UKICAgICAgICBwYXNzCiAgICAKICAgIGRlZiBnZXRfbWEoc2VsZik6CiAgICAgICAgIyBUT0RPOiBSZXR1cm4gbW92aW5nIGF2ZXJhZ2UKICAgICAgICBwYXNz"><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-2-6')" type="button">Run</button></div><pre><code><span class="c1"># Exercise 2.3</span>
<span class="k">class</span> <span class="nc">PriceMonitor</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="mi">20</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prices</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">window</span> <span class="o">=</span> <span class="n">window</span>
    
    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">price</span><span class="p">):</span>
        <span class="c1"># TODO: Add price and calculate moving average</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">get_ma</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># TODO: Return moving average</span>
        <span class="k">pass</span>
</code></pre><div class="code-output" id="output-cell-2-6"></div></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">PriceMonitor</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="mi">20</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prices</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">window</span> <span class="o">=</span> <span class="n">window</span>

    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">price</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">price</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">window</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_ma</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_latest</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prices</span> <span class="k">else</span> <span class="kc">None</span>

<span class="n">monitor</span> <span class="o">=</span> <span class="n">PriceMonitor</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">102</span><span class="p">,</span> <span class="mi">98</span><span class="p">,</span> <span class="mi">105</span><span class="p">,</span> <span class="mi">103</span><span class="p">,</span> <span class="mi">107</span><span class="p">]:</span>
    <span class="n">monitor</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Price: </span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s1">, MA: </span><span class="si">{</span><span class="n">monitor</span><span class="o">.</span><span class="n">get_ma</span><span class="p">()</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>Section 4: Alternative Data Sources</h1>
<h2>4.1 Fear &amp; Greed Index</h2></div>
<div class="code-cell" id="cell-2-7" data-source="aW1wb3J0IHJlcXVlc3RzCgpkZWYgZ2V0X2ZlYXJfZ3JlZWQoKToKICAgIHVybCA9ICdodHRwczovL2FwaS5hbHRlcm5hdGl2ZS5tZS9mbmcvJwogICAgcmVzcG9uc2UgPSByZXF1ZXN0cy5nZXQodXJsKQogICAgZGF0YSA9IHJlc3BvbnNlLmpzb24oKVsnZGF0YSddWzBdCiAgICByZXR1cm4gewogICAgICAgICd2YWx1ZSc6IGludChkYXRhWyd2YWx1ZSddKSwKICAgICAgICAnY2xhc3NpZmljYXRpb24nOiBkYXRhWyd2YWx1ZV9jbGFzc2lmaWNhdGlvbiddCiAgICB9CgpmZyA9IGdldF9mZWFyX2dyZWVkKCkKcHJpbnQoZiJGZWFyICYgR3JlZWQ6IHtmZ1sndmFsdWUnXX0gKHtmZ1snY2xhc3NpZmljYXRpb24nXX0pIik="><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-2-7')" type="button">Run</button></div><pre><code><span class="kn">import</span> <span class="nn">requests</span>

<span class="k">def</span> <span class="nf">get_fear_greed</span><span class="p">():</span>
    <span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;https://api.alternative.me/fng/&#39;</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]),</span>
        <span class="s1">&#39;classification&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;value_classification&#39;</span><span class="p">]</span>
    <span class="p">}</span>

<span class="n">fg</span> <span class="o">=</span> <span class="n">get_fear_greed</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Fear &amp; Greed: </span><span class="si">{</span><span class="n">fg</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">fg</span><span class="p">[</span><span class="s1">&#39;classification&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</code></pre><div class="code-output" id="output-cell-2-7"></div></div>
<div class="md-cell"><h3>âœï¸ Exercise 2.4: Multi-Source Data Fetcher</h3>
<p>Create function fetching price, volume, and fear/greed in one call.</p></div>
<div class="code-cell" id="cell-2-8" data-source="IyBFeGVyY2lzZSAyLjQKZGVmIGdldF9tYXJrZXRfc25hcHNob3Qoc3ltYm9sPSdCVEMvVVNEVCcpOgogICAgIyBUT0RPOiBSZXR1cm4gZGljdCB3aXRoIHByaWNlLCB2b2x1bWUsIGZlYXJfZ3JlZWQKICAgIHBhc3M="><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-2-8')" type="button">Run</button></div><pre><code><span class="c1"># Exercise 2.4</span>
<span class="k">def</span> <span class="nf">get_market_snapshot</span><span class="p">(</span><span class="n">symbol</span><span class="o">=</span><span class="s1">&#39;BTC/USDT&#39;</span><span class="p">):</span>
    <span class="c1"># TODO: Return dict with price, volume, fear_greed</span>
    <span class="k">pass</span>
</code></pre><div class="code-output" id="output-cell-2-8"></div></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">get_market_snapshot</span><span class="p">(</span><span class="n">symbol</span><span class="o">=</span><span class="s1">&#39;BTC/USDT&#39;</span><span class="p">):</span>
    <span class="c1"># Price data</span>
    <span class="n">exchange</span> <span class="o">=</span> <span class="n">ccxt</span><span class="o">.</span><span class="n">binance</span><span class="p">()</span>
    <span class="n">ticker</span> <span class="o">=</span> <span class="n">exchange</span><span class="o">.</span><span class="n">fetch_ticker</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>

    <span class="c1"># Fear &amp; Greed</span>
    <span class="n">fg</span> <span class="o">=</span> <span class="n">get_fear_greed</span><span class="p">()</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span>
        <span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="n">ticker</span><span class="p">[</span><span class="s1">&#39;last&#39;</span><span class="p">],</span>
        <span class="s1">&#39;volume_24h&#39;</span><span class="p">:</span> <span class="n">ticker</span><span class="p">[</span><span class="s1">&#39;quoteVolume&#39;</span><span class="p">],</span>
        <span class="s1">&#39;change_24h&#39;</span><span class="p">:</span> <span class="n">ticker</span><span class="p">[</span><span class="s1">&#39;percentage&#39;</span><span class="p">],</span>
        <span class="s1">&#39;fear_greed&#39;</span><span class="p">:</span> <span class="n">fg</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">],</span>
        <span class="s1">&#39;sentiment&#39;</span><span class="p">:</span> <span class="n">fg</span><span class="p">[</span><span class="s1">&#39;classification&#39;</span><span class="p">]</span>
    <span class="p">}</span>

<span class="n">snapshot</span> <span class="o">=</span> <span class="n">get_market_snapshot</span><span class="p">()</span>
<span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">snapshot</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>ğŸ—ï¸ Module Project: Comprehensive Data System</h1>
<p>Build a data system that fetches OHLCV, calculates returns, and includes sentiment.</p></div>
<div class="code-cell" id="cell-2-9" data-source="IyBNb2R1bGUgUHJvamVjdApjbGFzcyBDcnlwdG9EYXRhU3lzdGVtOgogICAgZGVmIF9faW5pdF9fKHNlbGYsIGV4Y2hhbmdlX2lkPSdiaW5hbmNlJyk6CiAgICAgICAgc2VsZi5leGNoYW5nZSA9IGNjeHQuYmluYW5jZSgpCiAgICAKICAgIGRlZiBnZXRfb2hsY3Yoc2VsZiwgc3ltYm9sLCB0aW1lZnJhbWU9JzFoJywgbGltaXQ9MTAwKToKICAgICAgICAjIFRPRE8KICAgICAgICBwYXNzCiAgICAKICAgIGRlZiBnZXRfbXVsdGlwbGVfc3ltYm9scyhzZWxmLCBzeW1ib2xzLCB0aW1lZnJhbWU9JzFoJyk6CiAgICAgICAgIyBUT0RPCiAgICAgICAgcGFzcwogICAgCiAgICBkZWYgZ2VuZXJhdGVfcmVwb3J0KHNlbGYsIHN5bWJvbCk6CiAgICAgICAgIyBUT0RPCiAgICAgICAgcGFzcw=="><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-2-9')" type="button">Run</button></div><pre><code><span class="c1"># Module Project</span>
<span class="k">class</span> <span class="nc">CryptoDataSystem</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exchange_id</span><span class="o">=</span><span class="s1">&#39;binance&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span> <span class="o">=</span> <span class="n">ccxt</span><span class="o">.</span><span class="n">binance</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">get_ohlcv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">timeframe</span><span class="o">=</span><span class="s1">&#39;1h&#39;</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
        <span class="c1"># TODO</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">get_multiple_symbols</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbols</span><span class="p">,</span> <span class="n">timeframe</span><span class="o">=</span><span class="s1">&#39;1h&#39;</span><span class="p">):</span>
        <span class="c1"># TODO</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">generate_report</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">):</span>
        <span class="c1"># TODO</span>
        <span class="k">pass</span>
</code></pre><div class="code-output" id="output-cell-2-9"></div></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">CryptoDataSystem</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exchange_id</span><span class="o">=</span><span class="s1">&#39;binance&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">ccxt</span><span class="p">,</span> <span class="n">exchange_id</span><span class="p">)()</span>

    <span class="k">def</span> <span class="nf">get_ohlcv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">timeframe</span><span class="o">=</span><span class="s1">&#39;1h&#39;</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
        <span class="n">ohlcv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="o">.</span><span class="n">fetch_ohlcv</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">timeframe</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">ohlcv</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">,</span> <span class="s1">&#39;open&#39;</span><span class="p">,</span> <span class="s1">&#39;high&#39;</span><span class="p">,</span> <span class="s1">&#39;low&#39;</span><span class="p">,</span> <span class="s1">&#39;close&#39;</span><span class="p">,</span> <span class="s1">&#39;volume&#39;</span><span class="p">])</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">],</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;ms&#39;</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;timestamp&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;returns&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span> <span class="o">*</span> <span class="mi">100</span>
        <span class="k">return</span> <span class="n">df</span>

    <span class="k">def</span> <span class="nf">get_multiple_symbols</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbols</span><span class="p">,</span> <span class="n">timeframe</span><span class="o">=</span><span class="s1">&#39;1h&#39;</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="n">symbols</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ohlcv</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">timeframe</span><span class="p">,</span> <span class="n">limit</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data</span>

    <span class="k">def</span> <span class="nf">generate_report</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">):</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ohlcv</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
        <span class="n">ticker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="o">.</span><span class="n">fetch_ticker</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;=== </span><span class="si">{</span><span class="n">symbol</span><span class="si">}</span><span class="s1"> Report ===&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Price: $</span><span class="si">{</span><span class="n">ticker</span><span class="p">[</span><span class="s1">&#39;last&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">,.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;24h Change: </span><span class="si">{</span><span class="n">ticker</span><span class="p">[</span><span class="s1">&#39;percentage&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Avg Return: </span><span class="si">{</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;returns&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Volatility: </span><span class="si">{</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;returns&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>

<span class="n">system</span> <span class="o">=</span> <span class="n">CryptoDataSystem</span><span class="p">()</span>
<span class="n">system</span><span class="o">.</span><span class="n">generate_report</span><span class="p">(</span><span class="s1">&#39;BTC/USDT&#39;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>ğŸ“ Key Takeaways</h1>
<ol>
<li><strong>CCXT</strong>: Unified API for 100+ exchanges</li>
<li><strong>OHLCV</strong>: Standard format for price data</li>
<li><strong>WebSockets</strong>: Real-time streaming data</li>
<li><strong>Alternative Data</strong>: Fear/Greed, social metrics enhance analysis</li>
</ol>
<hr />
<p><em>Next: Module 3 - Technical Analysis</em></p></div>
        <div class="nav-buttons">
            <button class="nav-btn prev-btn disabled" type="button">
                <span class="nav-btn-label">â† Previous</span>
                <span class="nav-btn-name"></span>
            </button>
            <button class="nav-btn next-btn disabled" type="button">
                <span class="nav-btn-label">Next â†’</span>
                <span class="nav-btn-name"></span>
            </button>
        </div>
        </div>
<div class="module-section" data-idx="3"><div class="md-cell module-header"><h1>Module 3: Crypto Technical Analysis</h1>
<h2>Part 1: Crypto Markets &amp; Data</h2>
<hr />
<div class="table-wrapper"><table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>â±ï¸ <strong>Duration</strong></td>
<td>~2.5 hours</td>
</tr>
<tr>
<td>ğŸ“‹ <strong>Prerequisites</strong></td>
<td>Modules 1-2</td>
</tr>
<tr>
<td>ğŸ’ª <strong>Exercises</strong></td>
<td>5 total</td>
</tr>
</tbody>
</table></div></div>
<div class="md-cell"><h2>ğŸ¯ Learning Objectives</h2>
<ul>
<li>Identify chart patterns in crypto</li>
<li>Implement technical indicators from scratch</li>
<li>Analyze volume for whale activity</li>
<li>Build multi-timeframe analysis</li>
</ul></div>
<div class="md-cell"><hr />
<h1>Section 1: Chart Patterns</h1>
<h2>Support &amp; Resistance</h2>
<ul>
<li><strong>Support</strong>: Price level where buying pressure prevents further decline</li>
<li><strong>Resistance</strong>: Price level where selling pressure prevents further rise</li>
</ul>
<div class="highlight"><pre><span></span><code>Price
â”‚
â”‚     â•±â•²      â•±â•²
â”‚â”€â”€â”€â”€â•±â”€â”€â•²â”€â”€â”€â”€â•±â”€â”€â•²â”€â”€â”€â”€ Resistance
â”‚   â•±    â•²  â•±    â•²
â”‚â”€â”€â•±â”€â”€â”€â”€â”€â”€â•²â•±â”€â”€â”€â”€â”€â”€â•²â”€â”€ Support
â”‚ â•±
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º Time
</code></pre></div></div>
<div class="code-cell" id="cell-3-0" data-source="aW1wb3J0IHBhbmRhcyBhcyBwZAppbXBvcnQgbnVtcHkgYXMgbnAKCmRlZiBmaW5kX3N1cHBvcnRfcmVzaXN0YW5jZShwcmljZXMsIHdpbmRvdz0yMCk6CiAgICAiIiJGaW5kIHN1cHBvcnQvcmVzaXN0YW5jZSBsZXZlbHMgdXNpbmcgcm9sbGluZyBtaW4vbWF4LiIiIgogICAgc3VwcG9ydCA9IHBkLlNlcmllcyhwcmljZXMpLnJvbGxpbmcod2luZG93KS5taW4oKS5pbG9jWy0xXQogICAgcmVzaXN0YW5jZSA9IHBkLlNlcmllcyhwcmljZXMpLnJvbGxpbmcod2luZG93KS5tYXgoKS5pbG9jWy0xXQogICAgcmV0dXJuIHN1cHBvcnQsIHJlc2lzdGFuY2UKCnByaWNlcyA9IFsxMDAsIDEwMiwgOTgsIDEwNSwgMTAzLCA5NSwgMTA4LCAxMDIsIDk5LCAxMDZdCnN1cHBvcnQsIHJlc2lzdGFuY2UgPSBmaW5kX3N1cHBvcnRfcmVzaXN0YW5jZShwcmljZXMsIDUpCnByaW50KGYnU3VwcG9ydDoge3N1cHBvcnR9LCBSZXNpc3RhbmNlOiB7cmVzaXN0YW5jZX0nKQ=="><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-3-0')" type="button">Run</button></div><pre><code><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="k">def</span> <span class="nf">find_support_resistance</span><span class="p">(</span><span class="n">prices</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="mi">20</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Find support/resistance levels using rolling min/max.&quot;&quot;&quot;</span>
    <span class="n">support</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">resistance</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">support</span><span class="p">,</span> <span class="n">resistance</span>

<span class="n">prices</span> <span class="o">=</span> <span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">102</span><span class="p">,</span> <span class="mi">98</span><span class="p">,</span> <span class="mi">105</span><span class="p">,</span> <span class="mi">103</span><span class="p">,</span> <span class="mi">95</span><span class="p">,</span> <span class="mi">108</span><span class="p">,</span> <span class="mi">102</span><span class="p">,</span> <span class="mi">99</span><span class="p">,</span> <span class="mi">106</span><span class="p">]</span>
<span class="n">support</span><span class="p">,</span> <span class="n">resistance</span> <span class="o">=</span> <span class="n">find_support_resistance</span><span class="p">(</span><span class="n">prices</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Support: </span><span class="si">{</span><span class="n">support</span><span class="si">}</span><span class="s1">, Resistance: </span><span class="si">{</span><span class="n">resistance</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</code></pre><div class="code-output" id="output-cell-3-0"></div></div>
<div class="md-cell"><hr />
<h1>Section 2: Technical Indicators</h1>
<h2>2.1 Moving Averages</h2></div>
<div class="code-cell" id="cell-3-1" data-source="ZGVmIHNtYShwcmljZXMsIHBlcmlvZCk6CiAgICAiIiJTaW1wbGUgTW92aW5nIEF2ZXJhZ2UiIiIKICAgIHJldHVybiBwZC5TZXJpZXMocHJpY2VzKS5yb2xsaW5nKHBlcmlvZCkubWVhbigpCgpkZWYgZW1hKHByaWNlcywgcGVyaW9kKToKICAgICIiIkV4cG9uZW50aWFsIE1vdmluZyBBdmVyYWdlIiIiCiAgICByZXR1cm4gcGQuU2VyaWVzKHByaWNlcykuZXdtKHNwYW49cGVyaW9kLCBhZGp1c3Q9RmFsc2UpLm1lYW4oKQoKcHJpY2VzID0gWzEwMCwgMTAyLCAxMDQsIDEwMywgMTA1LCAxMDcsIDEwNiwgMTA4LCAxMTAsIDEwOV0KcHJpbnQoJ1NNQSg1KTonLCBzbWEocHJpY2VzLCA1KS50b2xpc3QoKSkKcHJpbnQoJ0VNQSg1KTonLCBlbWEocHJpY2VzLCA1KS50b2xpc3QoKSk="><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-3-1')" type="button">Run</button></div><pre><code><span class="k">def</span> <span class="nf">sma</span><span class="p">(</span><span class="n">prices</span><span class="p">,</span> <span class="n">period</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Simple Moving Average&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">period</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">ema</span><span class="p">(</span><span class="n">prices</span><span class="p">,</span> <span class="n">period</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Exponential Moving Average&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span><span class="o">.</span><span class="n">ewm</span><span class="p">(</span><span class="n">span</span><span class="o">=</span><span class="n">period</span><span class="p">,</span> <span class="n">adjust</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

<span class="n">prices</span> <span class="o">=</span> <span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">102</span><span class="p">,</span> <span class="mi">104</span><span class="p">,</span> <span class="mi">103</span><span class="p">,</span> <span class="mi">105</span><span class="p">,</span> <span class="mi">107</span><span class="p">,</span> <span class="mi">106</span><span class="p">,</span> <span class="mi">108</span><span class="p">,</span> <span class="mi">110</span><span class="p">,</span> <span class="mi">109</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;SMA(5):&#39;</span><span class="p">,</span> <span class="n">sma</span><span class="p">(</span><span class="n">prices</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;EMA(5):&#39;</span><span class="p">,</span> <span class="n">ema</span><span class="p">(</span><span class="n">prices</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
</code></pre><div class="code-output" id="output-cell-3-1"></div></div>
<div class="md-cell"><h2>2.2 RSI (Relative Strength Index)</h2></div>
<div class="code-cell" id="cell-3-2" data-source="ZGVmIHJzaShwcmljZXMsIHBlcmlvZD0xNCk6CiAgICAiIiJDYWxjdWxhdGUgUlNJIiIiCiAgICBwcmljZXMgPSBwZC5TZXJpZXMocHJpY2VzKQogICAgZGVsdGEgPSBwcmljZXMuZGlmZigpCiAgICAKICAgIGdhaW4gPSBkZWx0YS53aGVyZShkZWx0YSA+IDAsIDApCiAgICBsb3NzID0gKC1kZWx0YSkud2hlcmUoZGVsdGEgPCAwLCAwKQogICAgCiAgICBhdmdfZ2FpbiA9IGdhaW4ucm9sbGluZyhwZXJpb2QpLm1lYW4oKQogICAgYXZnX2xvc3MgPSBsb3NzLnJvbGxpbmcocGVyaW9kKS5tZWFuKCkKICAgIAogICAgcnMgPSBhdmdfZ2FpbiAvIGF2Z19sb3NzCiAgICByZXR1cm4gMTAwIC0gKDEwMCAvICgxICsgcnMpKQoKIyBSU0kgaW50ZXJwcmV0YXRpb246CiMgPiA3MDogT3ZlcmJvdWdodAojIDwgMzA6IE92ZXJzb2xk"><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-3-2')" type="button">Run</button></div><pre><code><span class="k">def</span> <span class="nf">rsi</span><span class="p">(</span><span class="n">prices</span><span class="p">,</span> <span class="n">period</span><span class="o">=</span><span class="mi">14</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Calculate RSI&quot;&quot;&quot;</span>
    <span class="n">prices</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span>
    <span class="n">delta</span> <span class="o">=</span> <span class="n">prices</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span>
    
    <span class="n">gain</span> <span class="o">=</span> <span class="n">delta</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">delta</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">delta</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">delta</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    
    <span class="n">avg_gain</span> <span class="o">=</span> <span class="n">gain</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">period</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">avg_loss</span> <span class="o">=</span> <span class="n">loss</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">period</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    
    <span class="n">rs</span> <span class="o">=</span> <span class="n">avg_gain</span> <span class="o">/</span> <span class="n">avg_loss</span>
    <span class="k">return</span> <span class="mi">100</span> <span class="o">-</span> <span class="p">(</span><span class="mi">100</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">rs</span><span class="p">))</span>

<span class="c1"># RSI interpretation:</span>
<span class="c1"># &gt; 70: Overbought</span>
<span class="c1"># &lt; 30: Oversold</span>
</code></pre><div class="code-output" id="output-cell-3-2"></div></div>
<div class="md-cell"><h2>2.3 MACD</h2></div>
<div class="code-cell" id="cell-3-3" data-source="ZGVmIG1hY2QocHJpY2VzLCBmYXN0PTEyLCBzbG93PTI2LCBzaWduYWw9OSk6CiAgICAiIiJDYWxjdWxhdGUgTUFDRCIiIgogICAgcHJpY2VzID0gcGQuU2VyaWVzKHByaWNlcykKICAgIGVtYV9mYXN0ID0gcHJpY2VzLmV3bShzcGFuPWZhc3QsIGFkanVzdD1GYWxzZSkubWVhbigpCiAgICBlbWFfc2xvdyA9IHByaWNlcy5ld20oc3Bhbj1zbG93LCBhZGp1c3Q9RmFsc2UpLm1lYW4oKQogICAgCiAgICBtYWNkX2xpbmUgPSBlbWFfZmFzdCAtIGVtYV9zbG93CiAgICBzaWduYWxfbGluZSA9IG1hY2RfbGluZS5ld20oc3Bhbj1zaWduYWwsIGFkanVzdD1GYWxzZSkubWVhbigpCiAgICBoaXN0b2dyYW0gPSBtYWNkX2xpbmUgLSBzaWduYWxfbGluZQogICAgCiAgICByZXR1cm4gbWFjZF9saW5lLCBzaWduYWxfbGluZSwgaGlzdG9ncmFt"><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-3-3')" type="button">Run</button></div><pre><code><span class="k">def</span> <span class="nf">macd</span><span class="p">(</span><span class="n">prices</span><span class="p">,</span> <span class="n">fast</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">slow</span><span class="o">=</span><span class="mi">26</span><span class="p">,</span> <span class="n">signal</span><span class="o">=</span><span class="mi">9</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Calculate MACD&quot;&quot;&quot;</span>
    <span class="n">prices</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span>
    <span class="n">ema_fast</span> <span class="o">=</span> <span class="n">prices</span><span class="o">.</span><span class="n">ewm</span><span class="p">(</span><span class="n">span</span><span class="o">=</span><span class="n">fast</span><span class="p">,</span> <span class="n">adjust</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">ema_slow</span> <span class="o">=</span> <span class="n">prices</span><span class="o">.</span><span class="n">ewm</span><span class="p">(</span><span class="n">span</span><span class="o">=</span><span class="n">slow</span><span class="p">,</span> <span class="n">adjust</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    
    <span class="n">macd_line</span> <span class="o">=</span> <span class="n">ema_fast</span> <span class="o">-</span> <span class="n">ema_slow</span>
    <span class="n">signal_line</span> <span class="o">=</span> <span class="n">macd_line</span><span class="o">.</span><span class="n">ewm</span><span class="p">(</span><span class="n">span</span><span class="o">=</span><span class="n">signal</span><span class="p">,</span> <span class="n">adjust</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">histogram</span> <span class="o">=</span> <span class="n">macd_line</span> <span class="o">-</span> <span class="n">signal_line</span>
    
    <span class="k">return</span> <span class="n">macd_line</span><span class="p">,</span> <span class="n">signal_line</span><span class="p">,</span> <span class="n">histogram</span>
</code></pre><div class="code-output" id="output-cell-3-3"></div></div>
<div class="md-cell"><h3>âœï¸ Exercise 3.1: Build Indicator Library</h3>
<p>Create a class containing all indicators.</p></div>
<div class="code-cell" id="cell-3-4" data-source="IyBFeGVyY2lzZSAzLjEKY2xhc3MgVGVjaG5pY2FsSW5kaWNhdG9yczoKICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiBzbWEocHJpY2VzLCBwZXJpb2QpOgogICAgICAgICMgVE9ETwogICAgICAgIHBhc3MKICAgIAogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIGVtYShwcmljZXMsIHBlcmlvZCk6CiAgICAgICAgIyBUT0RPCiAgICAgICAgcGFzcwogICAgCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgcnNpKHByaWNlcywgcGVyaW9kPTE0KToKICAgICAgICAjIFRPRE8KICAgICAgICBwYXNzCiAgICAKICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiBib2xsaW5nZXJfYmFuZHMocHJpY2VzLCBwZXJpb2Q9MjAsIHN0ZF9kZXY9Mik6CiAgICAgICAgIyBUT0RPCiAgICAgICAgcGFzcw=="><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-3-4')" type="button">Run</button></div><pre><code><span class="c1"># Exercise 3.1</span>
<span class="k">class</span> <span class="nc">TechnicalIndicators</span><span class="p">:</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">sma</span><span class="p">(</span><span class="n">prices</span><span class="p">,</span> <span class="n">period</span><span class="p">):</span>
        <span class="c1"># TODO</span>
        <span class="k">pass</span>
    
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">ema</span><span class="p">(</span><span class="n">prices</span><span class="p">,</span> <span class="n">period</span><span class="p">):</span>
        <span class="c1"># TODO</span>
        <span class="k">pass</span>
    
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">rsi</span><span class="p">(</span><span class="n">prices</span><span class="p">,</span> <span class="n">period</span><span class="o">=</span><span class="mi">14</span><span class="p">):</span>
        <span class="c1"># TODO</span>
        <span class="k">pass</span>
    
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">bollinger_bands</span><span class="p">(</span><span class="n">prices</span><span class="p">,</span> <span class="n">period</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">std_dev</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
        <span class="c1"># TODO</span>
        <span class="k">pass</span>
</code></pre><div class="code-output" id="output-cell-3-4"></div></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">TechnicalIndicators</span><span class="p">:</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">sma</span><span class="p">(</span><span class="n">prices</span><span class="p">,</span> <span class="n">period</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">period</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">ema</span><span class="p">(</span><span class="n">prices</span><span class="p">,</span> <span class="n">period</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span><span class="o">.</span><span class="n">ewm</span><span class="p">(</span><span class="n">span</span><span class="o">=</span><span class="n">period</span><span class="p">,</span> <span class="n">adjust</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">rsi</span><span class="p">(</span><span class="n">prices</span><span class="p">,</span> <span class="n">period</span><span class="o">=</span><span class="mi">14</span><span class="p">):</span>
        <span class="n">prices</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="n">prices</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span>
        <span class="n">gain</span> <span class="o">=</span> <span class="n">delta</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">delta</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">delta</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">delta</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">avg_gain</span> <span class="o">=</span> <span class="n">gain</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">period</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">avg_loss</span> <span class="o">=</span> <span class="n">loss</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">period</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">rs</span> <span class="o">=</span> <span class="n">avg_gain</span> <span class="o">/</span> <span class="n">avg_loss</span>
        <span class="k">return</span> <span class="mi">100</span> <span class="o">-</span> <span class="p">(</span><span class="mi">100</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">rs</span><span class="p">))</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">bollinger_bands</span><span class="p">(</span><span class="n">prices</span><span class="p">,</span> <span class="n">period</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">std_dev</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
        <span class="n">prices</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span>
        <span class="n">sma</span> <span class="o">=</span> <span class="n">prices</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">period</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">std</span> <span class="o">=</span> <span class="n">prices</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">period</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
        <span class="n">upper</span> <span class="o">=</span> <span class="n">sma</span> <span class="o">+</span> <span class="p">(</span><span class="n">std</span> <span class="o">*</span> <span class="n">std_dev</span><span class="p">)</span>
        <span class="n">lower</span> <span class="o">=</span> <span class="n">sma</span> <span class="o">-</span> <span class="p">(</span><span class="n">std</span> <span class="o">*</span> <span class="n">std_dev</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">upper</span><span class="p">,</span> <span class="n">sma</span><span class="p">,</span> <span class="n">lower</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>Section 3: Volume Analysis</h1>
<p>Volume confirms price moves:
- <strong>High volume + price up</strong> = Strong bullish
- <strong>Low volume + price up</strong> = Weak, possible reversal</p></div>
<div class="code-cell" id="cell-3-5" data-source="ZGVmIHZvbHVtZV9wcm9maWxlKHByaWNlcywgdm9sdW1lcywgYmlucz0xMCk6CiAgICAiIiJDYWxjdWxhdGUgdm9sdW1lIGF0IHByaWNlIGxldmVscy4iIiIKICAgIHByaWNlX21pbiwgcHJpY2VfbWF4ID0gbWluKHByaWNlcyksIG1heChwcmljZXMpCiAgICBiaW5fc2l6ZSA9IChwcmljZV9tYXggLSBwcmljZV9taW4pIC8gYmlucwogICAgCiAgICBwcm9maWxlID0ge30KICAgIGZvciBwcmljZSwgdm9sIGluIHppcChwcmljZXMsIHZvbHVtZXMpOgogICAgICAgIGJpbl9pZHggPSBpbnQoKHByaWNlIC0gcHJpY2VfbWluKSAvIGJpbl9zaXplKQogICAgICAgIGJpbl9pZHggPSBtaW4oYmluX2lkeCwgYmlucyAtIDEpCiAgICAgICAgbGV2ZWwgPSBwcmljZV9taW4gKyAoYmluX2lkeCArIDAuNSkgKiBiaW5fc2l6ZQogICAgICAgIHByb2ZpbGVbbGV2ZWxdID0gcHJvZmlsZS5nZXQobGV2ZWwsIDApICsgdm9sCiAgICAKICAgIHJldHVybiBwcm9maWxl"><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-3-5')" type="button">Run</button></div><pre><code><span class="k">def</span> <span class="nf">volume_profile</span><span class="p">(</span><span class="n">prices</span><span class="p">,</span> <span class="n">volumes</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Calculate volume at price levels.&quot;&quot;&quot;</span>
    <span class="n">price_min</span><span class="p">,</span> <span class="n">price_max</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">prices</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span>
    <span class="n">bin_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">price_max</span> <span class="o">-</span> <span class="n">price_min</span><span class="p">)</span> <span class="o">/</span> <span class="n">bins</span>
    
    <span class="n">profile</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">price</span><span class="p">,</span> <span class="n">vol</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">prices</span><span class="p">,</span> <span class="n">volumes</span><span class="p">):</span>
        <span class="n">bin_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">price</span> <span class="o">-</span> <span class="n">price_min</span><span class="p">)</span> <span class="o">/</span> <span class="n">bin_size</span><span class="p">)</span>
        <span class="n">bin_idx</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">bin_idx</span><span class="p">,</span> <span class="n">bins</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">level</span> <span class="o">=</span> <span class="n">price_min</span> <span class="o">+</span> <span class="p">(</span><span class="n">bin_idx</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">*</span> <span class="n">bin_size</span>
        <span class="n">profile</span><span class="p">[</span><span class="n">level</span><span class="p">]</span> <span class="o">=</span> <span class="n">profile</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">level</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">vol</span>
    
    <span class="k">return</span> <span class="n">profile</span>
</code></pre><div class="code-output" id="output-cell-3-5"></div></div>
<div class="md-cell"><h3>âœï¸ Exercise 3.2: Whale Detection</h3>
<p>Detect unusually large volume spikes (potential whale activity).</p></div>
<div class="code-cell" id="cell-3-6" data-source="IyBFeGVyY2lzZSAzLjIKZGVmIGRldGVjdF93aGFsZV9hY3Rpdml0eSh2b2x1bWVzLCB0aHJlc2hvbGRfc3RkPTIpOgogICAgIiIiUmV0dXJuIGluZGljZXMgb2Ygd2hhbGUgYWN0aXZpdHkgKHZvbHVtZSA+IHRocmVzaG9sZF9zdGQgc3RhbmRhcmQgZGV2aWF0aW9ucykuIiIiCiAgICAjIFRPRE8KICAgIHBhc3M="><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-3-6')" type="button">Run</button></div><pre><code><span class="c1"># Exercise 3.2</span>
<span class="k">def</span> <span class="nf">detect_whale_activity</span><span class="p">(</span><span class="n">volumes</span><span class="p">,</span> <span class="n">threshold_std</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return indices of whale activity (volume &gt; threshold_std standard deviations).&quot;&quot;&quot;</span>
    <span class="c1"># TODO</span>
    <span class="k">pass</span>
</code></pre><div class="code-output" id="output-cell-3-6"></div></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">detect_whale_activity</span><span class="p">(</span><span class="n">volumes</span><span class="p">,</span> <span class="n">threshold_std</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
    <span class="n">volumes</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">volumes</span><span class="p">)</span>
    <span class="n">mean_vol</span> <span class="o">=</span> <span class="n">volumes</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">std_vol</span> <span class="o">=</span> <span class="n">volumes</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
    <span class="n">threshold</span> <span class="o">=</span> <span class="n">mean_vol</span> <span class="o">+</span> <span class="p">(</span><span class="n">threshold_std</span> <span class="o">*</span> <span class="n">std_vol</span><span class="p">)</span>

    <span class="n">whale_indices</span> <span class="o">=</span> <span class="n">volumes</span><span class="p">[</span><span class="n">volumes</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">whale_indices</span><span class="p">,</span> <span class="n">threshold</span>

<span class="n">volumes</span> <span class="o">=</span> <span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="mi">110</span><span class="p">,</span> <span class="mi">95</span><span class="p">,</span> <span class="mi">800</span><span class="p">,</span> <span class="mi">105</span><span class="p">]</span>
<span class="n">whales</span><span class="p">,</span> <span class="n">thresh</span> <span class="o">=</span> <span class="n">detect_whale_activity</span><span class="p">(</span><span class="n">volumes</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Whale activity at indices: </span><span class="si">{</span><span class="n">whales</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Threshold: </span><span class="si">{</span><span class="n">thresh</span><span class="si">:</span><span class="s1">.0f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>Section 4: Multi-Timeframe Analysis</h1>
<p>Use higher timeframes for trend, lower for entry.</p></div>
<div class="code-cell" id="cell-3-7" data-source="ZGVmIG11bHRpX3RpbWVmcmFtZV9zaWduYWwoZGFpbHlfdHJlbmQsIGg0X3RyZW5kLCBoMV9zaWduYWwpOgogICAgIiIiCiAgICBDb21iaW5lIG11bHRpcGxlIHRpbWVmcmFtZSBhbmFseXNpcy4KICAgIAogICAgUmV0dXJuczogJ0JVWScsICdTRUxMJywgb3IgJ05FVVRSQUwnCiAgICAiIiIKICAgIGlmIGRhaWx5X3RyZW5kID09ICdVUCcgYW5kIGg0X3RyZW5kID09ICdVUCcgYW5kIGgxX3NpZ25hbCA9PSAnQlVZJzoKICAgICAgICByZXR1cm4gJ1NUUk9OR19CVVknCiAgICBlbGlmIGRhaWx5X3RyZW5kID09ICdET1dOJyBhbmQgaDRfdHJlbmQgPT0gJ0RPV04nIGFuZCBoMV9zaWduYWwgPT0gJ1NFTEwnOgogICAgICAgIHJldHVybiAnU1RST05HX1NFTEwnCiAgICBlbGlmIGRhaWx5X3RyZW5kID09IGg0X3RyZW5kOgogICAgICAgIHJldHVybiBoMV9zaWduYWwKICAgIGVsc2U6CiAgICAgICAgcmV0dXJuICdORVVUUkFMJwoKc2lnbmFsID0gbXVsdGlfdGltZWZyYW1lX3NpZ25hbCgnVVAnLCAnVVAnLCAnQlVZJykKcHJpbnQoZidTaWduYWw6IHtzaWduYWx9Jyk="><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-3-7')" type="button">Run</button></div><pre><code><span class="k">def</span> <span class="nf">multi_timeframe_signal</span><span class="p">(</span><span class="n">daily_trend</span><span class="p">,</span> <span class="n">h4_trend</span><span class="p">,</span> <span class="n">h1_signal</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Combine multiple timeframe analysis.</span>
<span class="sd">    </span>
<span class="sd">    Returns: &#39;BUY&#39;, &#39;SELL&#39;, or &#39;NEUTRAL&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">daily_trend</span> <span class="o">==</span> <span class="s1">&#39;UP&#39;</span> <span class="ow">and</span> <span class="n">h4_trend</span> <span class="o">==</span> <span class="s1">&#39;UP&#39;</span> <span class="ow">and</span> <span class="n">h1_signal</span> <span class="o">==</span> <span class="s1">&#39;BUY&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;STRONG_BUY&#39;</span>
    <span class="k">elif</span> <span class="n">daily_trend</span> <span class="o">==</span> <span class="s1">&#39;DOWN&#39;</span> <span class="ow">and</span> <span class="n">h4_trend</span> <span class="o">==</span> <span class="s1">&#39;DOWN&#39;</span> <span class="ow">and</span> <span class="n">h1_signal</span> <span class="o">==</span> <span class="s1">&#39;SELL&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;STRONG_SELL&#39;</span>
    <span class="k">elif</span> <span class="n">daily_trend</span> <span class="o">==</span> <span class="n">h4_trend</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">h1_signal</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;NEUTRAL&#39;</span>

<span class="n">signal</span> <span class="o">=</span> <span class="n">multi_timeframe_signal</span><span class="p">(</span><span class="s1">&#39;UP&#39;</span><span class="p">,</span> <span class="s1">&#39;UP&#39;</span><span class="p">,</span> <span class="s1">&#39;BUY&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Signal: </span><span class="si">{</span><span class="n">signal</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</code></pre><div class="code-output" id="output-cell-3-7"></div></div>
<div class="md-cell"><h3>âœï¸ Exercise 3.3: MTF Strategy</h3>
<p>Build a complete multi-timeframe strategy function.</p></div>
<div class="code-cell" id="cell-3-8" data-source="IyBFeGVyY2lzZSAzLjMKZGVmIGFuYWx5emVfbXRmKHByaWNlc19kYWlseSwgcHJpY2VzXzRoLCBwcmljZXNfMWgpOgogICAgIiIiCiAgICBQZXJmb3JtIG11bHRpLXRpbWVmcmFtZSBhbmFseXNpcy4KICAgIAogICAgUmV0dXJucyBkaWN0IHdpdGggdHJlbmQgZm9yIGVhY2ggdGltZWZyYW1lIGFuZCBmaW5hbCBzaWduYWwuCiAgICAiIiIKICAgICMgVE9ETwogICAgcGFzcw=="><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-3-8')" type="button">Run</button></div><pre><code><span class="c1"># Exercise 3.3</span>
<span class="k">def</span> <span class="nf">analyze_mtf</span><span class="p">(</span><span class="n">prices_daily</span><span class="p">,</span> <span class="n">prices_4h</span><span class="p">,</span> <span class="n">prices_1h</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Perform multi-timeframe analysis.</span>
<span class="sd">    </span>
<span class="sd">    Returns dict with trend for each timeframe and final signal.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO</span>
    <span class="k">pass</span>
</code></pre><div class="code-output" id="output-cell-3-8"></div></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">get_trend</span><span class="p">(</span><span class="n">prices</span><span class="p">):</span>
    <span class="n">sma_short</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">sma_long</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="s1">&#39;UP&#39;</span> <span class="k">if</span> <span class="n">sma_short</span> <span class="o">&gt;</span> <span class="n">sma_long</span> <span class="k">else</span> <span class="s1">&#39;DOWN&#39;</span>

<span class="k">def</span> <span class="nf">analyze_mtf</span><span class="p">(</span><span class="n">prices_daily</span><span class="p">,</span> <span class="n">prices_4h</span><span class="p">,</span> <span class="n">prices_1h</span><span class="p">):</span>
    <span class="n">daily_trend</span> <span class="o">=</span> <span class="n">get_trend</span><span class="p">(</span><span class="n">prices_daily</span><span class="p">)</span>
    <span class="n">h4_trend</span> <span class="o">=</span> <span class="n">get_trend</span><span class="p">(</span><span class="n">prices_4h</span><span class="p">)</span>
    <span class="n">h1_trend</span> <span class="o">=</span> <span class="n">get_trend</span><span class="p">(</span><span class="n">prices_1h</span><span class="p">)</span>

    <span class="c1"># Entry signal from 1h</span>
    <span class="n">rsi_val</span> <span class="o">=</span> <span class="n">TechnicalIndicators</span><span class="o">.</span><span class="n">rsi</span><span class="p">(</span><span class="n">prices_1h</span><span class="p">)</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">rsi_val</span> <span class="o">&lt;</span> <span class="mi">30</span><span class="p">:</span>
        <span class="n">h1_signal</span> <span class="o">=</span> <span class="s1">&#39;BUY&#39;</span>
    <span class="k">elif</span> <span class="n">rsi_val</span> <span class="o">&gt;</span> <span class="mi">70</span><span class="p">:</span>
        <span class="n">h1_signal</span> <span class="o">=</span> <span class="s1">&#39;SELL&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">h1_signal</span> <span class="o">=</span> <span class="s1">&#39;NEUTRAL&#39;</span>

    <span class="n">final</span> <span class="o">=</span> <span class="n">multi_timeframe_signal</span><span class="p">(</span><span class="n">daily_trend</span><span class="p">,</span> <span class="n">h4_trend</span><span class="p">,</span> <span class="n">h1_signal</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;daily&#39;</span><span class="p">:</span> <span class="n">daily_trend</span><span class="p">,</span>
        <span class="s1">&#39;4h&#39;</span><span class="p">:</span> <span class="n">h4_trend</span><span class="p">,</span>
        <span class="s1">&#39;1h&#39;</span><span class="p">:</span> <span class="n">h1_trend</span><span class="p">,</span>
        <span class="s1">&#39;rsi&#39;</span><span class="p">:</span> <span class="n">rsi_val</span><span class="p">,</span>
        <span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="n">final</span>
    <span class="p">}</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>ğŸ—ï¸ Module Project: Technical Analysis Toolkit</h1>
<p>Build a complete TA toolkit class.</p></div>
<div class="code-cell" id="cell-3-9" data-source="IyBNb2R1bGUgUHJvamVjdApjbGFzcyBUZWNobmljYWxBbmFseXNpc1Rvb2xraXQ6CiAgICBkZWYgX19pbml0X18oc2VsZiwgcHJpY2VzLCB2b2x1bWVzPU5vbmUpOgogICAgICAgIHNlbGYucHJpY2VzID0gcGQuU2VyaWVzKHByaWNlcykKICAgICAgICBzZWxmLnZvbHVtZXMgPSBwZC5TZXJpZXModm9sdW1lcykgaWYgdm9sdW1lcyBlbHNlIE5vbmUKICAgIAogICAgZGVmIGFkZF9pbmRpY2F0b3JzKHNlbGYpOgogICAgICAgICMgVE9ETzogQWRkIGFsbCBpbmRpY2F0b3JzIHRvIGEgRGF0YUZyYW1lCiAgICAgICAgcGFzcwogICAgCiAgICBkZWYgZ2VuZXJhdGVfc2lnbmFscyhzZWxmKToKICAgICAgICAjIFRPRE86IEdlbmVyYXRlIGJ1eS9zZWxsIHNpZ25hbHMKICAgICAgICBwYXNzCiAgICAKICAgIGRlZiBzdW1tYXJ5KHNlbGYpOgogICAgICAgICMgVE9ETzogUHJpbnQgYW5hbHlzaXMgc3VtbWFyeQogICAgICAgIHBhc3M="><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-3-9')" type="button">Run</button></div><pre><code><span class="c1"># Module Project</span>
<span class="k">class</span> <span class="nc">TechnicalAnalysisToolkit</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prices</span><span class="p">,</span> <span class="n">volumes</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prices</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">volumes</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">volumes</span><span class="p">)</span> <span class="k">if</span> <span class="n">volumes</span> <span class="k">else</span> <span class="kc">None</span>
    
    <span class="k">def</span> <span class="nf">add_indicators</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># TODO: Add all indicators to a DataFrame</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">generate_signals</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># TODO: Generate buy/sell signals</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">summary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># TODO: Print analysis summary</span>
        <span class="k">pass</span>
</code></pre><div class="code-output" id="output-cell-3-9"></div></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">TechnicalAnalysisToolkit</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prices</span><span class="p">,</span> <span class="n">volumes</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prices</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">volumes</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">volumes</span><span class="p">)</span> <span class="k">if</span> <span class="n">volumes</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;close&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="p">})</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">volumes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;volume&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">volumes</span>

    <span class="k">def</span> <span class="nf">add_indicators</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;sma_20&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;sma_50&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;rsi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">TechnicalIndicators</span><span class="o">.</span><span class="n">rsi</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="p">)</span>
        <span class="n">upper</span><span class="p">,</span> <span class="n">mid</span><span class="p">,</span> <span class="n">lower</span> <span class="o">=</span> <span class="n">TechnicalIndicators</span><span class="o">.</span><span class="n">bollinger_bands</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;bb_upper&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">upper</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;bb_lower&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lower</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span>

    <span class="k">def</span> <span class="nf">generate_signals</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">signals</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">rsi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;rsi&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">price</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">sma_20</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;sma_20&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">rsi</span> <span class="o">&lt;</span> <span class="mi">30</span> <span class="ow">and</span> <span class="n">price</span> <span class="o">&gt;</span> <span class="n">sma_20</span><span class="p">:</span>
            <span class="n">signals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;RSI Oversold + Above SMA = BUY&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">rsi</span> <span class="o">&gt;</span> <span class="mi">70</span> <span class="ow">and</span> <span class="n">price</span> <span class="o">&lt;</span> <span class="n">sma_20</span><span class="p">:</span>
            <span class="n">signals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;RSI Overbought + Below SMA = SELL&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">signals</span>

    <span class="k">def</span> <span class="nf">summary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=== Technical Analysis Summary ===&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Price: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;RSI: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;rsi&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SMA(20): </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;sma_20&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Signals: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">generate_signals</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>ğŸ“ Key Takeaways</h1>
<ol>
<li><strong>Support/Resistance</strong>: Key price levels for entries/exits</li>
<li><strong>Moving Averages</strong>: Trend identification</li>
<li><strong>RSI</strong>: Overbought (&gt;70) / Oversold (&lt;30)</li>
<li><strong>Volume</strong>: Confirms price moves</li>
<li><strong>MTF</strong>: Higher TF for trend, lower for entry</li>
</ol>
<hr />
<p><em>Next: Module 4 - On-Chain Analytics</em></p></div>
        <div class="nav-buttons">
            <button class="nav-btn prev-btn disabled" type="button">
                <span class="nav-btn-label">â† Previous</span>
                <span class="nav-btn-name"></span>
            </button>
            <button class="nav-btn next-btn disabled" type="button">
                <span class="nav-btn-label">Next â†’</span>
                <span class="nav-btn-name"></span>
            </button>
        </div>
        </div>
<div class="module-section" data-idx="4"><div class="md-cell module-header"><h1>Module 4: On-Chain Analytics</h1>
<h2>Part 1: Crypto Markets &amp; Data</h2>
<hr />
<div class="table-wrapper"><table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>â±ï¸ <strong>Duration</strong></td>
<td>~2.5 hours</td>
</tr>
<tr>
<td>ğŸ“‹ <strong>Prerequisites</strong></td>
<td>Modules 1-3</td>
</tr>
<tr>
<td>ğŸ’ª <strong>Exercises</strong></td>
<td>5 total</td>
</tr>
</tbody>
</table></div></div>
<div class="md-cell"><h2>ğŸ¯ Learning Objectives</h2>
<ul>
<li>Understand on-chain analysis fundamentals</li>
<li>Track key metrics (active addresses, exchange flows)</li>
<li>Monitor whale activity</li>
<li>Analyze network health</li>
</ul></div>
<div class="md-cell"><hr />
<h1>Section 1: Introduction to On-Chain Data</h1>
<h2>What is On-Chain Analysis?</h2>
<p>On-chain data comes directly from the blockchain:
- <strong>Transactions</strong>: Every transfer recorded
- <strong>Addresses</strong>: Wallet activity visible
- <strong>Balances</strong>: Holdings are public</p>
<p>This gives unique insight unavailable in traditional markets.</p></div>
<div class="md-cell"><h2>Data Providers</h2>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Provider</th>
<th>Free Tier</th>
<th>Best For</th>
</tr>
</thead>
<tbody>
<tr>
<td>Glassnode</td>
<td>Limited</td>
<td>Professional metrics</td>
</tr>
<tr>
<td>CryptoQuant</td>
<td>Yes</td>
<td>Exchange flows</td>
</tr>
<tr>
<td>Blockchain.com</td>
<td>Yes</td>
<td>Basic BTC data</td>
</tr>
<tr>
<td>Etherscan</td>
<td>Yes</td>
<td>ETH transactions</td>
</tr>
</tbody>
</table></div></div>
<div class="code-cell" id="cell-4-0" data-source="IyBTaW11bGF0ZWQgb24tY2hhaW4gZGF0YSBzdHJ1Y3R1cmUKb25jaGFpbl9kYXRhID0gewogICAgJ2FjdGl2ZV9hZGRyZXNzZXMnOiA5NTAwMDAsCiAgICAndHJhbnNhY3Rpb25fY291bnQnOiAzMjAwMDAsCiAgICAnZXhjaGFuZ2VfaW5mbG93JzogMTUwMDAsICAjIEJUQwogICAgJ2V4Y2hhbmdlX291dGZsb3cnOiAxODAwMCwgICMgQlRDCiAgICAndG90YWxfZXhjaGFuZ2VfYmFsYW5jZSc6IDJfNDAwXzAwMCwgICMgQlRDCiAgICAnaGFzaF9yYXRlJzogNDUwXzAwMF8wMDAsICAjIFRIL3MKfQoKIyBOZXQgZmxvdyAobmVnYXRpdmUgPSBvdXRmbG93LCBidWxsaXNoKQpuZXRfZmxvdyA9IG9uY2hhaW5fZGF0YVsnZXhjaGFuZ2VfaW5mbG93J10gLSBvbmNoYWluX2RhdGFbJ2V4Y2hhbmdlX291dGZsb3cnXQpwcmludChmJ05ldCBFeGNoYW5nZSBGbG93OiB7bmV0X2Zsb3c6LH0gQlRDJyk="><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-4-0')" type="button">Run</button></div><pre><code><span class="c1"># Simulated on-chain data structure</span>
<span class="n">onchain_data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;active_addresses&#39;</span><span class="p">:</span> <span class="mi">950000</span><span class="p">,</span>
    <span class="s1">&#39;transaction_count&#39;</span><span class="p">:</span> <span class="mi">320000</span><span class="p">,</span>
    <span class="s1">&#39;exchange_inflow&#39;</span><span class="p">:</span> <span class="mi">15000</span><span class="p">,</span>  <span class="c1"># BTC</span>
    <span class="s1">&#39;exchange_outflow&#39;</span><span class="p">:</span> <span class="mi">18000</span><span class="p">,</span>  <span class="c1"># BTC</span>
    <span class="s1">&#39;total_exchange_balance&#39;</span><span class="p">:</span> <span class="mi">2_400_000</span><span class="p">,</span>  <span class="c1"># BTC</span>
    <span class="s1">&#39;hash_rate&#39;</span><span class="p">:</span> <span class="mi">450_000_000</span><span class="p">,</span>  <span class="c1"># TH/s</span>
<span class="p">}</span>

<span class="c1"># Net flow (negative = outflow, bullish)</span>
<span class="n">net_flow</span> <span class="o">=</span> <span class="n">onchain_data</span><span class="p">[</span><span class="s1">&#39;exchange_inflow&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">onchain_data</span><span class="p">[</span><span class="s1">&#39;exchange_outflow&#39;</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Net Exchange Flow: </span><span class="si">{</span><span class="n">net_flow</span><span class="si">:</span><span class="s1">,</span><span class="si">}</span><span class="s1"> BTC&#39;</span><span class="p">)</span>
</code></pre><div class="code-output" id="output-cell-4-0"></div></div>
<div class="md-cell"><hr />
<h1>Section 2: Key On-Chain Metrics</h1>
<h2>2.1 Active Addresses</h2>
<ul>
<li>More active addresses = more adoption</li>
<li>Correlates with price over long term</li>
</ul></div>
<div class="code-cell" id="cell-4-1" data-source="ZGVmIGFuYWx5emVfYWN0aXZlX2FkZHJlc3NlcyhjdXJyZW50LCBhdmdfMzBkKToKICAgICIiIkFzc2VzcyBuZXR3b3JrIGFjdGl2aXR5LiIiIgogICAgY2hhbmdlX3BjdCA9ICgoY3VycmVudCAtIGF2Z18zMGQpIC8gYXZnXzMwZCkgKiAxMDAKICAgIAogICAgaWYgY2hhbmdlX3BjdCA+IDIwOgogICAgICAgIHNpZ25hbCA9ICdTVFJPTkcgR1JPV1RIJwogICAgZWxpZiBjaGFuZ2VfcGN0ID4gNToKICAgICAgICBzaWduYWwgPSAnR1JPV0lORycKICAgIGVsaWYgY2hhbmdlX3BjdCA+IC01OgogICAgICAgIHNpZ25hbCA9ICdTVEFCTEUnCiAgICBlbHNlOgogICAgICAgIHNpZ25hbCA9ICdERUNMSU5JTkcnCiAgICAKICAgIHJldHVybiB7J2NoYW5nZV9wY3QnOiBjaGFuZ2VfcGN0LCAnc2lnbmFsJzogc2lnbmFsfQoKcmVzdWx0ID0gYW5hbHl6ZV9hY3RpdmVfYWRkcmVzc2VzKDk1MDAwMCwgODUwMDAwKQpwcmludChmIkNoYW5nZToge3Jlc3VsdFsnY2hhbmdlX3BjdCddOi4xZn0lLCBTaWduYWw6IHtyZXN1bHRbJ3NpZ25hbCddfSIp"><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-4-1')" type="button">Run</button></div><pre><code><span class="k">def</span> <span class="nf">analyze_active_addresses</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="n">avg_30d</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Assess network activity.&quot;&quot;&quot;</span>
    <span class="n">change_pct</span> <span class="o">=</span> <span class="p">((</span><span class="n">current</span> <span class="o">-</span> <span class="n">avg_30d</span><span class="p">)</span> <span class="o">/</span> <span class="n">avg_30d</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
    
    <span class="k">if</span> <span class="n">change_pct</span> <span class="o">&gt;</span> <span class="mi">20</span><span class="p">:</span>
        <span class="n">signal</span> <span class="o">=</span> <span class="s1">&#39;STRONG GROWTH&#39;</span>
    <span class="k">elif</span> <span class="n">change_pct</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">:</span>
        <span class="n">signal</span> <span class="o">=</span> <span class="s1">&#39;GROWING&#39;</span>
    <span class="k">elif</span> <span class="n">change_pct</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">5</span><span class="p">:</span>
        <span class="n">signal</span> <span class="o">=</span> <span class="s1">&#39;STABLE&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">signal</span> <span class="o">=</span> <span class="s1">&#39;DECLINING&#39;</span>
    
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;change_pct&#39;</span><span class="p">:</span> <span class="n">change_pct</span><span class="p">,</span> <span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="n">signal</span><span class="p">}</span>

<span class="n">result</span> <span class="o">=</span> <span class="n">analyze_active_addresses</span><span class="p">(</span><span class="mi">950000</span><span class="p">,</span> <span class="mi">850000</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Change: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;change_pct&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%, Signal: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre><div class="code-output" id="output-cell-4-1"></div></div>
<div class="md-cell"><h2>2.2 Exchange Flows</h2>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Flow</th>
<th>Meaning</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Inflow</strong></td>
<td>BTC moving TO exchanges (sell pressure)</td>
</tr>
<tr>
<td><strong>Outflow</strong></td>
<td>BTC leaving exchanges (accumulation)</td>
</tr>
</tbody>
</table></div></div>
<div class="code-cell" id="cell-4-2" data-source="ZGVmIGFuYWx5emVfZXhjaGFuZ2VfZmxvd3MoaW5mbG93LCBvdXRmbG93KToKICAgICIiIkFuYWx5emUgZXhjaGFuZ2UgZmxvdyBmb3IgbWFya2V0IHNlbnRpbWVudC4iIiIKICAgIG5ldF9mbG93ID0gaW5mbG93IC0gb3V0ZmxvdwogICAgCiAgICBpZiBuZXRfZmxvdyA+IDEwMDA6CiAgICAgICAgc2lnbmFsID0gJ0JFQVJJU0ggKHNlbGxpbmcgcHJlc3N1cmUpJwogICAgZWxpZiBuZXRfZmxvdyA8IC0xMDAwOgogICAgICAgIHNpZ25hbCA9ICdCVUxMSVNIIChhY2N1bXVsYXRpb24pJwogICAgZWxzZToKICAgICAgICBzaWduYWwgPSAnTkVVVFJBTCcKICAgIAogICAgcmV0dXJuIHsnbmV0X2Zsb3cnOiBuZXRfZmxvdywgJ3NpZ25hbCc6IHNpZ25hbH0KCnJlc3VsdCA9IGFuYWx5emVfZXhjaGFuZ2VfZmxvd3MoMTUwMDAsIDE4MDAwKQpwcmludChmIk5ldCBGbG93OiB7cmVzdWx0WyduZXRfZmxvdyddOix9IEJUQyIpCnByaW50KGYiU2lnbmFsOiB7cmVzdWx0WydzaWduYWwnXX0iKQ=="><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-4-2')" type="button">Run</button></div><pre><code><span class="k">def</span> <span class="nf">analyze_exchange_flows</span><span class="p">(</span><span class="n">inflow</span><span class="p">,</span> <span class="n">outflow</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Analyze exchange flow for market sentiment.&quot;&quot;&quot;</span>
    <span class="n">net_flow</span> <span class="o">=</span> <span class="n">inflow</span> <span class="o">-</span> <span class="n">outflow</span>
    
    <span class="k">if</span> <span class="n">net_flow</span> <span class="o">&gt;</span> <span class="mi">1000</span><span class="p">:</span>
        <span class="n">signal</span> <span class="o">=</span> <span class="s1">&#39;BEARISH (selling pressure)&#39;</span>
    <span class="k">elif</span> <span class="n">net_flow</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">1000</span><span class="p">:</span>
        <span class="n">signal</span> <span class="o">=</span> <span class="s1">&#39;BULLISH (accumulation)&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">signal</span> <span class="o">=</span> <span class="s1">&#39;NEUTRAL&#39;</span>
    
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;net_flow&#39;</span><span class="p">:</span> <span class="n">net_flow</span><span class="p">,</span> <span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="n">signal</span><span class="p">}</span>

<span class="n">result</span> <span class="o">=</span> <span class="n">analyze_exchange_flows</span><span class="p">(</span><span class="mi">15000</span><span class="p">,</span> <span class="mi">18000</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Net Flow: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;net_flow&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2"> BTC&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Signal: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre><div class="code-output" id="output-cell-4-2"></div></div>
<div class="md-cell"><h3>âœï¸ Exercise 4.1: On-Chain Dashboard</h3>
<p>Create a function that displays all key metrics.</p></div>
<div class="code-cell" id="cell-4-3" data-source="IyBFeGVyY2lzZSA0LjEKZGVmIG9uY2hhaW5fZGFzaGJvYXJkKGRhdGEpOgogICAgIiIiRGlzcGxheSBvbi1jaGFpbiBtZXRyaWNzIGRhc2hib2FyZC4iIiIKICAgICMgVE9ETwogICAgcGFzcw=="><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-4-3')" type="button">Run</button></div><pre><code><span class="c1"># Exercise 4.1</span>
<span class="k">def</span> <span class="nf">onchain_dashboard</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Display on-chain metrics dashboard.&quot;&quot;&quot;</span>
    <span class="c1"># TODO</span>
    <span class="k">pass</span>
</code></pre><div class="code-output" id="output-cell-4-3"></div></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">onchain_dashboard</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="n">net_flow</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;exchange_inflow&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;exchange_outflow&#39;</span><span class="p">]</span>
    <span class="n">flow_signal</span> <span class="o">=</span> <span class="s1">&#39;BULLISH&#39;</span> <span class="k">if</span> <span class="n">net_flow</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;BEARISH&#39;</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=&#39;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;         ON-CHAIN DASHBOARD&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=&#39;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Active Addresses: </span><span class="si">{</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;active_addresses&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Transaction Count: </span><span class="si">{</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;transaction_count&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-&#39;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;EXCHANGE FLOWS&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Inflow: </span><span class="si">{</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;exchange_inflow&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2"> BTC&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Outflow: </span><span class="si">{</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;exchange_outflow&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2"> BTC&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Net Flow: </span><span class="si">{</span><span class="n">net_flow</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2"> BTC (</span><span class="si">{</span><span class="n">flow_signal</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-&#39;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Hash Rate: </span><span class="si">{</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;hash_rate&#39;</span><span class="p">]</span><span class="o">/</span><span class="mf">1e6</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2"> EH/s&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=&#39;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>

<span class="n">onchain_dashboard</span><span class="p">(</span><span class="n">onchain_data</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>Section 3: Whale Watching</h1>
<p>Whales are wallets holding large amounts (&gt;1000 BTC).
Their movements can signal major price action.</p></div>
<div class="code-cell" id="cell-4-4" data-source="IyBTaW11bGF0ZWQgd2hhbGUgdHJhbnNhY3Rpb25zCndoYWxlX3R4cyA9IFsKICAgIHsnYW1vdW50JzogNTAwLCAndG8nOiAnZXhjaGFuZ2UnLCAndGltZSc6ICcyMDI0LTAxLTE1IDEwOjMwJ30sCiAgICB7J2Ftb3VudCc6IDEyMDAsICd0byc6ICdjb2xkX3dhbGxldCcsICd0aW1lJzogJzIwMjQtMDEtMTUgMTE6NDUnfSwKICAgIHsnYW1vdW50JzogMjUwMCwgJ3RvJzogJ2V4Y2hhbmdlJywgJ3RpbWUnOiAnMjAyNC0wMS0xNSAxNDoyMCd9LApdCgpkZWYgYW5hbHl6ZV93aGFsZV90eHModHJhbnNhY3Rpb25zLCB0aHJlc2hvbGQ9MTAwMCk6CiAgICAiIiJBbmFseXplIHdoYWxlIHRyYW5zYWN0aW9ucyBmb3IgbWFya2V0IHNpZ25hbC4iIiIKICAgIHRvX2V4Y2hhbmdlID0gc3VtKHR4WydhbW91bnQnXSBmb3IgdHggaW4gdHJhbnNhY3Rpb25zIGlmIHR4Wyd0byddID09ICdleGNoYW5nZScgYW5kIHR4WydhbW91bnQnXSA+PSB0aHJlc2hvbGQpCiAgICBmcm9tX2V4Y2hhbmdlID0gc3VtKHR4WydhbW91bnQnXSBmb3IgdHggaW4gdHJhbnNhY3Rpb25zIGlmIHR4Wyd0byddICE9ICdleGNoYW5nZScgYW5kIHR4WydhbW91bnQnXSA+PSB0aHJlc2hvbGQpCiAgICAKICAgIHJldHVybiB7CiAgICAgICAgJ3RvX2V4Y2hhbmdlJzogdG9fZXhjaGFuZ2UsCiAgICAgICAgJ2Zyb21fZXhjaGFuZ2UnOiBmcm9tX2V4Y2hhbmdlLAogICAgICAgICdzaWduYWwnOiAnQkVBUklTSCcgaWYgdG9fZXhjaGFuZ2UgPiBmcm9tX2V4Y2hhbmdlIGVsc2UgJ0JVTExJU0gnCiAgICB9CgpwcmludChhbmFseXplX3doYWxlX3R4cyh3aGFsZV90eHMpKQ=="><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-4-4')" type="button">Run</button></div><pre><code><span class="c1"># Simulated whale transactions</span>
<span class="n">whale_txs</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span><span class="s1">&#39;amount&#39;</span><span class="p">:</span> <span class="mi">500</span><span class="p">,</span> <span class="s1">&#39;to&#39;</span><span class="p">:</span> <span class="s1">&#39;exchange&#39;</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="s1">&#39;2024-01-15 10:30&#39;</span><span class="p">},</span>
    <span class="p">{</span><span class="s1">&#39;amount&#39;</span><span class="p">:</span> <span class="mi">1200</span><span class="p">,</span> <span class="s1">&#39;to&#39;</span><span class="p">:</span> <span class="s1">&#39;cold_wallet&#39;</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="s1">&#39;2024-01-15 11:45&#39;</span><span class="p">},</span>
    <span class="p">{</span><span class="s1">&#39;amount&#39;</span><span class="p">:</span> <span class="mi">2500</span><span class="p">,</span> <span class="s1">&#39;to&#39;</span><span class="p">:</span> <span class="s1">&#39;exchange&#39;</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="s1">&#39;2024-01-15 14:20&#39;</span><span class="p">},</span>
<span class="p">]</span>

<span class="k">def</span> <span class="nf">analyze_whale_txs</span><span class="p">(</span><span class="n">transactions</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Analyze whale transactions for market signal.&quot;&quot;&quot;</span>
    <span class="n">to_exchange</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">tx</span><span class="p">[</span><span class="s1">&#39;amount&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">tx</span> <span class="ow">in</span> <span class="n">transactions</span> <span class="k">if</span> <span class="n">tx</span><span class="p">[</span><span class="s1">&#39;to&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;exchange&#39;</span> <span class="ow">and</span> <span class="n">tx</span><span class="p">[</span><span class="s1">&#39;amount&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">threshold</span><span class="p">)</span>
    <span class="n">from_exchange</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">tx</span><span class="p">[</span><span class="s1">&#39;amount&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">tx</span> <span class="ow">in</span> <span class="n">transactions</span> <span class="k">if</span> <span class="n">tx</span><span class="p">[</span><span class="s1">&#39;to&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;exchange&#39;</span> <span class="ow">and</span> <span class="n">tx</span><span class="p">[</span><span class="s1">&#39;amount&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">threshold</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;to_exchange&#39;</span><span class="p">:</span> <span class="n">to_exchange</span><span class="p">,</span>
        <span class="s1">&#39;from_exchange&#39;</span><span class="p">:</span> <span class="n">from_exchange</span><span class="p">,</span>
        <span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="s1">&#39;BEARISH&#39;</span> <span class="k">if</span> <span class="n">to_exchange</span> <span class="o">&gt;</span> <span class="n">from_exchange</span> <span class="k">else</span> <span class="s1">&#39;BULLISH&#39;</span>
    <span class="p">}</span>

<span class="nb">print</span><span class="p">(</span><span class="n">analyze_whale_txs</span><span class="p">(</span><span class="n">whale_txs</span><span class="p">))</span>
</code></pre><div class="code-output" id="output-cell-4-4"></div></div>
<div class="md-cell"><h3>âœï¸ Exercise 4.2: Whale Alert System</h3>
<p>Create an alert system for large transactions.</p></div>
<div class="code-cell" id="cell-4-5" data-source="IyBFeGVyY2lzZSA0LjIKY2xhc3MgV2hhbGVBbGVydFN5c3RlbToKICAgIGRlZiBfX2luaXRfXyhzZWxmLCB0aHJlc2hvbGQ9MTAwMCk6CiAgICAgICAgc2VsZi50aHJlc2hvbGQgPSB0aHJlc2hvbGQKICAgICAgICBzZWxmLmFsZXJ0cyA9IFtdCiAgICAKICAgIGRlZiBjaGVja190cmFuc2FjdGlvbihzZWxmLCB0eCk6CiAgICAgICAgIyBUT0RPOiBDaGVjayBpZiB3aGFsZSB0eCBhbmQgY3JlYXRlIGFsZXJ0CiAgICAgICAgcGFzcwogICAgCiAgICBkZWYgZ2V0X2FsZXJ0cyhzZWxmKToKICAgICAgICAjIFRPRE86IFJldHVybiByZWNlbnQgYWxlcnRzCiAgICAgICAgcGFzcw=="><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-4-5')" type="button">Run</button></div><pre><code><span class="c1"># Exercise 4.2</span>
<span class="k">class</span> <span class="nc">WhaleAlertSystem</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="o">=</span> <span class="n">threshold</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alerts</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">def</span> <span class="nf">check_transaction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tx</span><span class="p">):</span>
        <span class="c1"># TODO: Check if whale tx and create alert</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">get_alerts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># TODO: Return recent alerts</span>
        <span class="k">pass</span>
</code></pre><div class="code-output" id="output-cell-4-5"></div></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">WhaleAlertSystem</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="o">=</span> <span class="n">threshold</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alerts</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">check_transaction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tx</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">tx</span><span class="p">[</span><span class="s1">&#39;amount&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="p">:</span>
            <span class="n">direction</span> <span class="o">=</span> <span class="s1">&#39;â†’ Exchange&#39;</span> <span class="k">if</span> <span class="n">tx</span><span class="p">[</span><span class="s1">&#39;to&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;exchange&#39;</span> <span class="k">else</span> <span class="s1">&#39;â†’ Cold Storage&#39;</span>
            <span class="n">alert</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;amount&#39;</span><span class="p">:</span> <span class="n">tx</span><span class="p">[</span><span class="s1">&#39;amount&#39;</span><span class="p">],</span>
                <span class="s1">&#39;direction&#39;</span><span class="p">:</span> <span class="n">direction</span><span class="p">,</span>
                <span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="n">tx</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">],</span>
                <span class="s1">&#39;significance&#39;</span><span class="p">:</span> <span class="s1">&#39;HIGH&#39;</span> <span class="k">if</span> <span class="n">tx</span><span class="p">[</span><span class="s1">&#39;amount&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">5000</span> <span class="k">else</span> <span class="s1">&#39;MEDIUM&#39;</span>
            <span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">alerts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">alert</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">alert</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">get_alerts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">alerts</span><span class="p">[</span><span class="o">-</span><span class="n">limit</span><span class="p">:]</span>

<span class="n">alert_system</span> <span class="o">=</span> <span class="n">WhaleAlertSystem</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span>
<span class="k">for</span> <span class="n">tx</span> <span class="ow">in</span> <span class="n">whale_txs</span><span class="p">:</span>
    <span class="n">alert</span> <span class="o">=</span> <span class="n">alert_system</span><span class="o">.</span><span class="n">check_transaction</span><span class="p">(</span><span class="n">tx</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">alert</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ğŸ‹ WHALE ALERT: </span><span class="si">{</span><span class="n">alert</span><span class="p">[</span><span class="s1">&#39;amount&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> BTC </span><span class="si">{</span><span class="n">alert</span><span class="p">[</span><span class="s1">&#39;direction&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>Section 4: Network Health Metrics</h1>
<h2>Hash Rate</h2>
<ul>
<li>Measures network security</li>
<li>Higher = more secure, more miner confidence</li>
</ul>
<h2>Difficulty</h2>
<ul>
<li>Adjusts every 2016 blocks (~2 weeks)</li>
<li>Ensures consistent block times</li>
</ul></div>
<div class="code-cell" id="cell-4-6" data-source="ZGVmIGFuYWx5emVfbmV0d29ya19oZWFsdGgoaGFzaF9yYXRlLCBoYXNoX3JhdGVfMzBkX2F2ZywgZGlmZmljdWx0eV9jaGFuZ2UpOgogICAgIiIiQXNzZXNzIEJpdGNvaW4gbmV0d29yayBoZWFsdGguIiIiCiAgICBoYXNoX2NoYW5nZSA9ICgoaGFzaF9yYXRlIC0gaGFzaF9yYXRlXzMwZF9hdmcpIC8gaGFzaF9yYXRlXzMwZF9hdmcpICogMTAwCiAgICAKICAgIGhlYWx0aCA9ICdIRUFMVEhZJwogICAgY29uY2VybnMgPSBbXQogICAgCiAgICBpZiBoYXNoX2NoYW5nZSA8IC0xMDoKICAgICAgICBoZWFsdGggPSAnQ09OQ0VSTklORycKICAgICAgICBjb25jZXJucy5hcHBlbmQoJ0hhc2ggcmF0ZSBkZWNsaW5pbmcgc2lnbmlmaWNhbnRseScpCiAgICAKICAgIGlmIGRpZmZpY3VsdHlfY2hhbmdlIDwgLTU6CiAgICAgICAgY29uY2VybnMuYXBwZW5kKCdEaWZmaWN1bHR5IGFkanVzdG1lbnQgbmVnYXRpdmUgKG1pbmVycyBsZWF2aW5nKScpCiAgICAKICAgIHJldHVybiB7CiAgICAgICAgJ2hlYWx0aCc6IGhlYWx0aCwKICAgICAgICAnaGFzaF9yYXRlX2NoYW5nZSc6IGhhc2hfY2hhbmdlLAogICAgICAgICdjb25jZXJucyc6IGNvbmNlcm5zCiAgICB9CgpyZXN1bHQgPSBhbmFseXplX25ldHdvcmtfaGVhbHRoKDQ1MF8wMDBfMDAwLCA0MjBfMDAwXzAwMCwgMi41KQpwcmludChmIk5ldHdvcmsgSGVhbHRoOiB7cmVzdWx0WydoZWFsdGgnXX0iKQpwcmludChmIkhhc2ggUmF0ZSBDaGFuZ2U6IHtyZXN1bHRbJ2hhc2hfcmF0ZV9jaGFuZ2UnXTouMWZ9JSIp"><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-4-6')" type="button">Run</button></div><pre><code><span class="k">def</span> <span class="nf">analyze_network_health</span><span class="p">(</span><span class="n">hash_rate</span><span class="p">,</span> <span class="n">hash_rate_30d_avg</span><span class="p">,</span> <span class="n">difficulty_change</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Assess Bitcoin network health.&quot;&quot;&quot;</span>
    <span class="n">hash_change</span> <span class="o">=</span> <span class="p">((</span><span class="n">hash_rate</span> <span class="o">-</span> <span class="n">hash_rate_30d_avg</span><span class="p">)</span> <span class="o">/</span> <span class="n">hash_rate_30d_avg</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
    
    <span class="n">health</span> <span class="o">=</span> <span class="s1">&#39;HEALTHY&#39;</span>
    <span class="n">concerns</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">if</span> <span class="n">hash_change</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">10</span><span class="p">:</span>
        <span class="n">health</span> <span class="o">=</span> <span class="s1">&#39;CONCERNING&#39;</span>
        <span class="n">concerns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Hash rate declining significantly&#39;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">difficulty_change</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">5</span><span class="p">:</span>
        <span class="n">concerns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Difficulty adjustment negative (miners leaving)&#39;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;health&#39;</span><span class="p">:</span> <span class="n">health</span><span class="p">,</span>
        <span class="s1">&#39;hash_rate_change&#39;</span><span class="p">:</span> <span class="n">hash_change</span><span class="p">,</span>
        <span class="s1">&#39;concerns&#39;</span><span class="p">:</span> <span class="n">concerns</span>
    <span class="p">}</span>

<span class="n">result</span> <span class="o">=</span> <span class="n">analyze_network_health</span><span class="p">(</span><span class="mi">450_000_000</span><span class="p">,</span> <span class="mi">420_000_000</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Network Health: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;health&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Hash Rate Change: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;hash_rate_change&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
</code></pre><div class="code-output" id="output-cell-4-6"></div></div>
<div class="md-cell"><h3>âœï¸ Exercise 4.3: Network Health Monitor</h3>
<p>Build a comprehensive network health monitoring class.</p></div>
<div class="code-cell" id="cell-4-7" data-source="IyBFeGVyY2lzZSA0LjMKY2xhc3MgTmV0d29ya0hlYWx0aE1vbml0b3I6CiAgICBkZWYgX19pbml0X18oc2VsZik6CiAgICAgICAgc2VsZi5tZXRyaWNzX2hpc3RvcnkgPSBbXQogICAgCiAgICBkZWYgdXBkYXRlKHNlbGYsIG1ldHJpY3MpOgogICAgICAgICMgVE9ETzogU3RvcmUgbWV0cmljcwogICAgICAgIHBhc3MKICAgIAogICAgZGVmIGdldF9oZWFsdGhfc2NvcmUoc2VsZik6CiAgICAgICAgIyBUT0RPOiBSZXR1cm4gMC0xMDAgaGVhbHRoIHNjb3JlCiAgICAgICAgcGFzcwogICAgCiAgICBkZWYgZ2V0X3JlcG9ydChzZWxmKToKICAgICAgICAjIFRPRE86IFJldHVybiBmdWxsIGhlYWx0aCByZXBvcnQKICAgICAgICBwYXNz"><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-4-7')" type="button">Run</button></div><pre><code><span class="c1"># Exercise 4.3</span>
<span class="k">class</span> <span class="nc">NetworkHealthMonitor</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics_history</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metrics</span><span class="p">):</span>
        <span class="c1"># TODO: Store metrics</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">get_health_score</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># TODO: Return 0-100 health score</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">get_report</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># TODO: Return full health report</span>
        <span class="k">pass</span>
</code></pre><div class="code-output" id="output-cell-4-7"></div></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">NetworkHealthMonitor</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics_history</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metrics</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics_history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metrics</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metrics_history</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">30</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metrics_history</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_health_score</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics_history</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">latest</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics_history</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">score</span> <span class="o">=</span> <span class="mi">50</span>  <span class="c1"># Base score</span>

        <span class="c1"># Hash rate trend</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metrics_history</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">prev</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics_history</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">latest</span><span class="p">[</span><span class="s1">&#39;hash_rate&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">prev</span><span class="p">[</span><span class="s1">&#39;hash_rate&#39;</span><span class="p">]:</span>
                <span class="n">score</span> <span class="o">+=</span> <span class="mi">20</span>
            <span class="k">elif</span> <span class="n">latest</span><span class="p">[</span><span class="s1">&#39;hash_rate&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">prev</span><span class="p">[</span><span class="s1">&#39;hash_rate&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.95</span><span class="p">:</span>
                <span class="n">score</span> <span class="o">-=</span> <span class="mi">20</span>

        <span class="c1"># Active addresses</span>
        <span class="k">if</span> <span class="n">latest</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;active_addresses&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">900000</span><span class="p">:</span>
            <span class="n">score</span> <span class="o">+=</span> <span class="mi">15</span>

        <span class="c1"># Exchange outflow (accumulation)</span>
        <span class="k">if</span> <span class="n">latest</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;exchange_outflow&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">latest</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;exchange_inflow&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">score</span> <span class="o">+=</span> <span class="mi">15</span>

        <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">100</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_report</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_health_score</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;health_score&#39;</span><span class="p">:</span> <span class="n">score</span><span class="p">,</span>
            <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;HEALTHY&#39;</span> <span class="k">if</span> <span class="n">score</span> <span class="o">&gt;</span> <span class="mi">70</span> <span class="k">else</span> <span class="s1">&#39;MODERATE&#39;</span> <span class="k">if</span> <span class="n">score</span> <span class="o">&gt;</span> <span class="mi">40</span> <span class="k">else</span> <span class="s1">&#39;CONCERNING&#39;</span><span class="p">,</span>
            <span class="s1">&#39;latest_metrics&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics_history</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics_history</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="p">}</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>ğŸ—ï¸ Module Project: On-Chain Analytics Dashboard</h1>
<p>Build a complete on-chain analytics system.</p></div>
<div class="code-cell" id="cell-4-8" data-source="IyBNb2R1bGUgUHJvamVjdApjbGFzcyBPbkNoYWluQW5hbHl0aWNzOgogICAgZGVmIF9faW5pdF9fKHNlbGYpOgogICAgICAgIHNlbGYud2hhbGVfc3lzdGVtID0gTm9uZSAgIyBXaGFsZUFsZXJ0U3lzdGVtCiAgICAgICAgc2VsZi5oZWFsdGhfbW9uaXRvciA9IE5vbmUgICMgTmV0d29ya0hlYWx0aE1vbml0b3IKICAgIAogICAgZGVmIHVwZGF0ZV9kYXRhKHNlbGYsIG9uY2hhaW5fZGF0YSwgdHJhbnNhY3Rpb25zKToKICAgICAgICAjIFRPRE8KICAgICAgICBwYXNzCiAgICAKICAgIGRlZiBnZXRfbWFya2V0X3NpZ25hbChzZWxmKToKICAgICAgICAjIFRPRE86IENvbWJpbmUgYWxsIHNpZ25hbHMKICAgICAgICBwYXNzCiAgICAKICAgIGRlZiBmdWxsX3JlcG9ydChzZWxmKToKICAgICAgICAjIFRPRE86IFByaW50IGNvbXByZWhlbnNpdmUgcmVwb3J0CiAgICAgICAgcGFzcw=="><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-4-8')" type="button">Run</button></div><pre><code><span class="c1"># Module Project</span>
<span class="k">class</span> <span class="nc">OnChainAnalytics</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">whale_system</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># WhaleAlertSystem</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">health_monitor</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># NetworkHealthMonitor</span>
    
    <span class="k">def</span> <span class="nf">update_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">onchain_data</span><span class="p">,</span> <span class="n">transactions</span><span class="p">):</span>
        <span class="c1"># TODO</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">get_market_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># TODO: Combine all signals</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">full_report</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># TODO: Print comprehensive report</span>
        <span class="k">pass</span>
</code></pre><div class="code-output" id="output-cell-4-8"></div></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">OnChainAnalytics</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">whale_system</span> <span class="o">=</span> <span class="n">WhaleAlertSystem</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">health_monitor</span> <span class="o">=</span> <span class="n">NetworkHealthMonitor</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">latest_data</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">update_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">onchain_data</span><span class="p">,</span> <span class="n">transactions</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">latest_data</span> <span class="o">=</span> <span class="n">onchain_data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">health_monitor</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">onchain_data</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">transactions</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">tx</span> <span class="ow">in</span> <span class="n">transactions</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">whale_system</span><span class="o">.</span><span class="n">check_transaction</span><span class="p">(</span><span class="n">tx</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_market_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">latest_data</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;NO DATA&#39;</span>

        <span class="n">signals</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Exchange flow signal</span>
        <span class="n">net_flow</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">latest_data</span><span class="p">[</span><span class="s1">&#39;exchange_inflow&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">latest_data</span><span class="p">[</span><span class="s1">&#39;exchange_outflow&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">net_flow</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">1000</span><span class="p">:</span>
            <span class="n">signals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;BULLISH (accumulation)&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">net_flow</span> <span class="o">&gt;</span> <span class="mi">1000</span><span class="p">:</span>
            <span class="n">signals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;BEARISH (distribution)&#39;</span><span class="p">)</span>

        <span class="c1"># Health signal</span>
        <span class="n">health</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">health_monitor</span><span class="o">.</span><span class="n">get_health_score</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">health</span> <span class="ow">and</span> <span class="n">health</span> <span class="o">&gt;</span> <span class="mi">70</span><span class="p">:</span>
            <span class="n">signals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;BULLISH (healthy network)&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">signals</span> <span class="k">if</span> <span class="n">signals</span> <span class="k">else</span> <span class="p">[</span><span class="s1">&#39;NEUTRAL&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">full_report</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=&#39;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;           ON-CHAIN ANALYTICS REPORT&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=&#39;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>

        <span class="n">onchain_dashboard</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">latest_data</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">WHALE ACTIVITY&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">alert</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">whale_system</span><span class="o">.</span><span class="n">get_alerts</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  ğŸ‹ </span><span class="si">{</span><span class="n">alert</span><span class="p">[</span><span class="s1">&#39;amount&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> BTC </span><span class="si">{</span><span class="n">alert</span><span class="p">[</span><span class="s1">&#39;direction&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">NETWORK HEALTH SCORE: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">health_monitor</span><span class="o">.</span><span class="n">get_health_score</span><span class="p">()</span><span class="si">}</span><span class="s1">/100&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">MARKET SIGNALS: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">get_market_signal</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=&#39;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>

<span class="c1"># Test</span>
<span class="n">analytics</span> <span class="o">=</span> <span class="n">OnChainAnalytics</span><span class="p">()</span>
<span class="n">analytics</span><span class="o">.</span><span class="n">update_data</span><span class="p">(</span><span class="n">onchain_data</span><span class="p">,</span> <span class="n">whale_txs</span><span class="p">)</span>
<span class="n">analytics</span><span class="o">.</span><span class="n">full_report</span><span class="p">()</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>ğŸ“ Key Takeaways</h1>
<ol>
<li><strong>On-Chain Data</strong>: Unique blockchain transparency</li>
<li><strong>Exchange Flows</strong>: Inflows = sell pressure, Outflows = accumulation</li>
<li><strong>Whale Watching</strong>: Large movements signal market direction</li>
<li><strong>Network Health</strong>: Hash rate, active addresses show fundamentals</li>
</ol>
<hr />
<p><em>Part 1 Complete! Next: Part 2 - Strategy Development</em></p></div>
        <div class="nav-buttons">
            <button class="nav-btn prev-btn disabled" type="button">
                <span class="nav-btn-label">â† Previous</span>
                <span class="nav-btn-name"></span>
            </button>
            <button class="nav-btn next-btn disabled" type="button">
                <span class="nav-btn-label">Next â†’</span>
                <span class="nav-btn-name"></span>
            </button>
        </div>
        </div>
<div class="module-section" data-idx="5"><div class="md-cell module-header"><h1>Module 5: Crypto Trading Strategies</h1>
<h2>Part 2: Strategy Development</h2>
<hr />
<div class="table-wrapper"><table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>â±ï¸ <strong>Duration</strong></td>
<td>~2.5 hours</td>
</tr>
<tr>
<td>ğŸ“‹ <strong>Prerequisites</strong></td>
<td>Part 1 (Modules 1-4)</td>
</tr>
<tr>
<td>ğŸ’ª <strong>Exercises</strong></td>
<td>5 total</td>
</tr>
</tbody>
</table></div></div>
<div class="md-cell"><h2>ğŸ¯ Learning Objectives</h2>
<ul>
<li>Implement trend following strategies</li>
<li>Build mean reversion systems</li>
<li>Create momentum ranking strategies</li>
<li>Develop range trading approaches</li>
</ul></div>
<div class="md-cell"><hr />
<h1>Section 1: Trend Following</h1>
<h2>Moving Average Crossover</h2>
<p>Classic strategy: Buy when fast MA crosses above slow MA.</p></div>
<div class="code-cell" id="cell-5-0" data-source="aW1wb3J0IHBhbmRhcyBhcyBwZAppbXBvcnQgbnVtcHkgYXMgbnAKCmRlZiBtYV9jcm9zc292ZXJfc2lnbmFscyhwcmljZXMsIGZhc3Q9MTAsIHNsb3c9MzApOgogICAgIiIiR2VuZXJhdGUgTUEgY3Jvc3NvdmVyIHNpZ25hbHMuIiIiCiAgICBwcmljZXMgPSBwZC5TZXJpZXMocHJpY2VzKQogICAgZmFzdF9tYSA9IHByaWNlcy5yb2xsaW5nKGZhc3QpLm1lYW4oKQogICAgc2xvd19tYSA9IHByaWNlcy5yb2xsaW5nKHNsb3cpLm1lYW4oKQogICAgCiAgICBzaWduYWxzID0gW10KICAgIGZvciBpIGluIHJhbmdlKDEsIGxlbihwcmljZXMpKToKICAgICAgICBpZiBmYXN0X21hLmlsb2NbaV0gPiBzbG93X21hLmlsb2NbaV0gYW5kIGZhc3RfbWEuaWxvY1tpLTFdIDw9IHNsb3dfbWEuaWxvY1tpLTFdOgogICAgICAgICAgICBzaWduYWxzLmFwcGVuZCgoaSwgJ0JVWScpKQogICAgICAgIGVsaWYgZmFzdF9tYS5pbG9jW2ldIDwgc2xvd19tYS5pbG9jW2ldIGFuZCBmYXN0X21hLmlsb2NbaS0xXSA+PSBzbG93X21hLmlsb2NbaS0xXToKICAgICAgICAgICAgc2lnbmFscy5hcHBlbmQoKGksICdTRUxMJykpCiAgICAKICAgIHJldHVybiBzaWduYWxzCgpwcmljZXMgPSBbMTAwLCAxMDIsIDEwNSwgMTAzLCAxMDgsIDExMiwgMTE1LCAxMTMsIDExOCwgMTIwLCAxMTcsIDExNSwgMTEyLCAxMTAsIDEwOF0Kc2lnbmFscyA9IG1hX2Nyb3Nzb3Zlcl9zaWduYWxzKHByaWNlcywgZmFzdD0zLCBzbG93PTUpCnByaW50KGYnU2lnbmFsczoge3NpZ25hbHN9Jyk="><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-5-0')" type="button">Run</button></div><pre><code><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="k">def</span> <span class="nf">ma_crossover_signals</span><span class="p">(</span><span class="n">prices</span><span class="p">,</span> <span class="n">fast</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">slow</span><span class="o">=</span><span class="mi">30</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Generate MA crossover signals.&quot;&quot;&quot;</span>
    <span class="n">prices</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span>
    <span class="n">fast_ma</span> <span class="o">=</span> <span class="n">prices</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">fast</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">slow_ma</span> <span class="o">=</span> <span class="n">prices</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">slow</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    
    <span class="n">signals</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">prices</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">fast_ma</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">slow_ma</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">and</span> <span class="n">fast_ma</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">slow_ma</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">signals</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;BUY&#39;</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">fast_ma</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">slow_ma</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">and</span> <span class="n">fast_ma</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">slow_ma</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">signals</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;SELL&#39;</span><span class="p">))</span>
    
    <span class="k">return</span> <span class="n">signals</span>

<span class="n">prices</span> <span class="o">=</span> <span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">102</span><span class="p">,</span> <span class="mi">105</span><span class="p">,</span> <span class="mi">103</span><span class="p">,</span> <span class="mi">108</span><span class="p">,</span> <span class="mi">112</span><span class="p">,</span> <span class="mi">115</span><span class="p">,</span> <span class="mi">113</span><span class="p">,</span> <span class="mi">118</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="mi">117</span><span class="p">,</span> <span class="mi">115</span><span class="p">,</span> <span class="mi">112</span><span class="p">,</span> <span class="mi">110</span><span class="p">,</span> <span class="mi">108</span><span class="p">]</span>
<span class="n">signals</span> <span class="o">=</span> <span class="n">ma_crossover_signals</span><span class="p">(</span><span class="n">prices</span><span class="p">,</span> <span class="n">fast</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">slow</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Signals: </span><span class="si">{</span><span class="n">signals</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</code></pre><div class="code-output" id="output-cell-5-0"></div></div>
<div class="md-cell"><h2>Breakout Strategy</h2>
<p>Buy when price breaks above recent highs.</p></div>
<div class="code-cell" id="cell-5-1" data-source="ZGVmIGJyZWFrb3V0X3NpZ25hbHMocHJpY2VzLCBsb29rYmFjaz0yMCk6CiAgICAiIiJHZW5lcmF0ZSBicmVha291dCBzaWduYWxzLiIiIgogICAgcHJpY2VzID0gcGQuU2VyaWVzKHByaWNlcykKICAgIHNpZ25hbHMgPSBbXQogICAgCiAgICBmb3IgaSBpbiByYW5nZShsb29rYmFjaywgbGVuKHByaWNlcykpOgogICAgICAgIHJlY2VudF9oaWdoID0gcHJpY2VzLmlsb2NbaS1sb29rYmFjazppXS5tYXgoKQogICAgICAgIHJlY2VudF9sb3cgPSBwcmljZXMuaWxvY1tpLWxvb2tiYWNrOmldLm1pbigpCiAgICAgICAgCiAgICAgICAgaWYgcHJpY2VzLmlsb2NbaV0gPiByZWNlbnRfaGlnaDoKICAgICAgICAgICAgc2lnbmFscy5hcHBlbmQoKGksICdCVVknLCBwcmljZXMuaWxvY1tpXSkpCiAgICAgICAgZWxpZiBwcmljZXMuaWxvY1tpXSA8IHJlY2VudF9sb3c6CiAgICAgICAgICAgIHNpZ25hbHMuYXBwZW5kKChpLCAnU0VMTCcsIHByaWNlcy5pbG9jW2ldKSkKICAgIAogICAgcmV0dXJuIHNpZ25hbHM="><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-5-1')" type="button">Run</button></div><pre><code><span class="k">def</span> <span class="nf">breakout_signals</span><span class="p">(</span><span class="n">prices</span><span class="p">,</span> <span class="n">lookback</span><span class="o">=</span><span class="mi">20</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Generate breakout signals.&quot;&quot;&quot;</span>
    <span class="n">prices</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span>
    <span class="n">signals</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">lookback</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">prices</span><span class="p">)):</span>
        <span class="n">recent_high</span> <span class="o">=</span> <span class="n">prices</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="n">lookback</span><span class="p">:</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">recent_low</span> <span class="o">=</span> <span class="n">prices</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="n">lookback</span><span class="p">:</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="n">prices</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">recent_high</span><span class="p">:</span>
            <span class="n">signals</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;BUY&#39;</span><span class="p">,</span> <span class="n">prices</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
        <span class="k">elif</span> <span class="n">prices</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">recent_low</span><span class="p">:</span>
            <span class="n">signals</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;SELL&#39;</span><span class="p">,</span> <span class="n">prices</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
    
    <span class="k">return</span> <span class="n">signals</span>
</code></pre><div class="code-output" id="output-cell-5-1"></div></div>
<div class="md-cell"><h3>âœï¸ Exercise 5.1: Trend Following System</h3>
<p>Build a complete trend following class with multiple filters.</p></div>
<div class="code-cell" id="cell-5-2" data-source="IyBFeGVyY2lzZSA1LjEKY2xhc3MgVHJlbmRGb2xsb3dpbmdTdHJhdGVneToKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBmYXN0X21hPTEwLCBzbG93X21hPTMwKToKICAgICAgICBzZWxmLmZhc3RfbWEgPSBmYXN0X21hCiAgICAgICAgc2VsZi5zbG93X21hID0gc2xvd19tYQogICAgCiAgICBkZWYgZ2V0X3RyZW5kKHNlbGYsIHByaWNlcyk6CiAgICAgICAgIyBUT0RPOiBSZXR1cm4gJ1VQJywgJ0RPV04nLCBvciAnTkVVVFJBTCcKICAgICAgICBwYXNzCiAgICAKICAgIGRlZiBnZW5lcmF0ZV9zaWduYWwoc2VsZiwgcHJpY2VzKToKICAgICAgICAjIFRPRE86IFJldHVybiBzaWduYWwgd2l0aCBjb25maWRlbmNlCiAgICAgICAgcGFzcw=="><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-5-2')" type="button">Run</button></div><pre><code><span class="c1"># Exercise 5.1</span>
<span class="k">class</span> <span class="nc">TrendFollowingStrategy</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fast_ma</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">slow_ma</span><span class="o">=</span><span class="mi">30</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fast_ma</span> <span class="o">=</span> <span class="n">fast_ma</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slow_ma</span> <span class="o">=</span> <span class="n">slow_ma</span>
    
    <span class="k">def</span> <span class="nf">get_trend</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prices</span><span class="p">):</span>
        <span class="c1"># TODO: Return &#39;UP&#39;, &#39;DOWN&#39;, or &#39;NEUTRAL&#39;</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">generate_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prices</span><span class="p">):</span>
        <span class="c1"># TODO: Return signal with confidence</span>
        <span class="k">pass</span>
</code></pre><div class="code-output" id="output-cell-5-2"></div></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">TrendFollowingStrategy</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fast_ma</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">slow_ma</span><span class="o">=</span><span class="mi">30</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fast_ma</span> <span class="o">=</span> <span class="n">fast_ma</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slow_ma</span> <span class="o">=</span> <span class="n">slow_ma</span>

    <span class="k">def</span> <span class="nf">get_trend</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prices</span><span class="p">):</span>
        <span class="n">prices</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span>
        <span class="n">fast</span> <span class="o">=</span> <span class="n">prices</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fast_ma</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">slow</span> <span class="o">=</span> <span class="n">prices</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slow_ma</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">fast</span> <span class="o">&gt;</span> <span class="n">slow</span> <span class="o">*</span> <span class="mf">1.02</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;UP&#39;</span>
        <span class="k">elif</span> <span class="n">fast</span> <span class="o">&lt;</span> <span class="n">slow</span> <span class="o">*</span> <span class="mf">0.98</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;DOWN&#39;</span>
        <span class="k">return</span> <span class="s1">&#39;NEUTRAL&#39;</span>

    <span class="k">def</span> <span class="nf">generate_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prices</span><span class="p">):</span>
        <span class="n">trend</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_trend</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span>
        <span class="n">prices</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span>

        <span class="c1"># Calculate RSI for confirmation</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="n">prices</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span>
        <span class="n">gain</span> <span class="o">=</span> <span class="n">delta</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">delta</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">14</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">delta</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">delta</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">14</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">rs</span> <span class="o">=</span> <span class="n">gain</span> <span class="o">/</span> <span class="n">loss</span>
        <span class="n">rsi</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">-</span> <span class="p">(</span><span class="mi">100</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">rs</span><span class="p">))</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">trend</span> <span class="o">==</span> <span class="s1">&#39;UP&#39;</span> <span class="ow">and</span> <span class="n">rsi</span> <span class="o">&lt;</span> <span class="mi">70</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="s1">&#39;BUY&#39;</span><span class="p">,</span> <span class="s1">&#39;confidence&#39;</span><span class="p">:</span> <span class="s1">&#39;HIGH&#39;</span> <span class="k">if</span> <span class="n">rsi</span> <span class="o">&lt;</span> <span class="mi">50</span> <span class="k">else</span> <span class="s1">&#39;MEDIUM&#39;</span><span class="p">}</span>
        <span class="k">elif</span> <span class="n">trend</span> <span class="o">==</span> <span class="s1">&#39;DOWN&#39;</span> <span class="ow">and</span> <span class="n">rsi</span> <span class="o">&gt;</span> <span class="mi">30</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="s1">&#39;SELL&#39;</span><span class="p">,</span> <span class="s1">&#39;confidence&#39;</span><span class="p">:</span> <span class="s1">&#39;HIGH&#39;</span> <span class="k">if</span> <span class="n">rsi</span> <span class="o">&gt;</span> <span class="mi">50</span> <span class="k">else</span> <span class="s1">&#39;MEDIUM&#39;</span><span class="p">}</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="s1">&#39;HOLD&#39;</span><span class="p">,</span> <span class="s1">&#39;confidence&#39;</span><span class="p">:</span> <span class="s1">&#39;LOW&#39;</span><span class="p">}</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>Section 2: Mean Reversion</h1>
<h2>RSI Mean Reversion</h2>
<p>Buy oversold (RSI &lt; 30), sell overbought (RSI &gt; 70).</p></div>
<div class="code-cell" id="cell-5-3" data-source="ZGVmIHJzaV9tZWFuX3JldmVyc2lvbihwcmljZXMsIHBlcmlvZD0xNCwgb3ZlcnNvbGQ9MzAsIG92ZXJib3VnaHQ9NzApOgogICAgIiIiUlNJLWJhc2VkIG1lYW4gcmV2ZXJzaW9uIHNpZ25hbHMuIiIiCiAgICBwcmljZXMgPSBwZC5TZXJpZXMocHJpY2VzKQogICAgZGVsdGEgPSBwcmljZXMuZGlmZigpCiAgICAKICAgIGdhaW4gPSBkZWx0YS53aGVyZShkZWx0YSA+IDAsIDApLnJvbGxpbmcocGVyaW9kKS5tZWFuKCkKICAgIGxvc3MgPSAoLWRlbHRhKS53aGVyZShkZWx0YSA8IDAsIDApLnJvbGxpbmcocGVyaW9kKS5tZWFuKCkKICAgIHJzID0gZ2FpbiAvIGxvc3MKICAgIHJzaSA9IDEwMCAtICgxMDAgLyAoMSArIHJzKSkKICAgIAogICAgc2lnbmFscyA9IFtdCiAgICBmb3IgaSBpbiByYW5nZShwZXJpb2QsIGxlbihwcmljZXMpKToKICAgICAgICBpZiByc2kuaWxvY1tpXSA8IG92ZXJzb2xkIGFuZCByc2kuaWxvY1tpLTFdID49IG92ZXJzb2xkOgogICAgICAgICAgICBzaWduYWxzLmFwcGVuZCgoaSwgJ0JVWScsIHJzaS5pbG9jW2ldKSkKICAgICAgICBlbGlmIHJzaS5pbG9jW2ldID4gb3ZlcmJvdWdodCBhbmQgcnNpLmlsb2NbaS0xXSA8PSBvdmVyYm91Z2h0OgogICAgICAgICAgICBzaWduYWxzLmFwcGVuZCgoaSwgJ1NFTEwnLCByc2kuaWxvY1tpXSkpCiAgICAKICAgIHJldHVybiBzaWduYWxz"><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-5-3')" type="button">Run</button></div><pre><code><span class="k">def</span> <span class="nf">rsi_mean_reversion</span><span class="p">(</span><span class="n">prices</span><span class="p">,</span> <span class="n">period</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">oversold</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">overbought</span><span class="o">=</span><span class="mi">70</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;RSI-based mean reversion signals.&quot;&quot;&quot;</span>
    <span class="n">prices</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span>
    <span class="n">delta</span> <span class="o">=</span> <span class="n">prices</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span>
    
    <span class="n">gain</span> <span class="o">=</span> <span class="n">delta</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">delta</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">period</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">delta</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">delta</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">period</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">rs</span> <span class="o">=</span> <span class="n">gain</span> <span class="o">/</span> <span class="n">loss</span>
    <span class="n">rsi</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">-</span> <span class="p">(</span><span class="mi">100</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">rs</span><span class="p">))</span>
    
    <span class="n">signals</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">prices</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">rsi</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">oversold</span> <span class="ow">and</span> <span class="n">rsi</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">oversold</span><span class="p">:</span>
            <span class="n">signals</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;BUY&#39;</span><span class="p">,</span> <span class="n">rsi</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
        <span class="k">elif</span> <span class="n">rsi</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">overbought</span> <span class="ow">and</span> <span class="n">rsi</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">overbought</span><span class="p">:</span>
            <span class="n">signals</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;SELL&#39;</span><span class="p">,</span> <span class="n">rsi</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
    
    <span class="k">return</span> <span class="n">signals</span>
</code></pre><div class="code-output" id="output-cell-5-3"></div></div>
<div class="md-cell"><h2>Bollinger Band Mean Reversion</h2></div>
<div class="code-cell" id="cell-5-4" data-source="ZGVmIGJvbGxpbmdlcl9tZWFuX3JldmVyc2lvbihwcmljZXMsIHBlcmlvZD0yMCwgc3RkX2Rldj0yKToKICAgICIiIkJvbGxpbmdlciBCYW5kIG1lYW4gcmV2ZXJzaW9uIHNpZ25hbHMuIiIiCiAgICBwcmljZXMgPSBwZC5TZXJpZXMocHJpY2VzKQogICAgc21hID0gcHJpY2VzLnJvbGxpbmcocGVyaW9kKS5tZWFuKCkKICAgIHN0ZCA9IHByaWNlcy5yb2xsaW5nKHBlcmlvZCkuc3RkKCkKICAgIAogICAgdXBwZXIgPSBzbWEgKyAoc3RkICogc3RkX2RldikKICAgIGxvd2VyID0gc21hIC0gKHN0ZCAqIHN0ZF9kZXYpCiAgICAKICAgIHNpZ25hbHMgPSBbXQogICAgZm9yIGkgaW4gcmFuZ2UocGVyaW9kLCBsZW4ocHJpY2VzKSk6CiAgICAgICAgaWYgcHJpY2VzLmlsb2NbaV0gPCBsb3dlci5pbG9jW2ldOgogICAgICAgICAgICBzaWduYWxzLmFwcGVuZCgoaSwgJ0JVWScsICdCZWxvdyBsb3dlciBiYW5kJykpCiAgICAgICAgZWxpZiBwcmljZXMuaWxvY1tpXSA+IHVwcGVyLmlsb2NbaV06CiAgICAgICAgICAgIHNpZ25hbHMuYXBwZW5kKChpLCAnU0VMTCcsICdBYm92ZSB1cHBlciBiYW5kJykpCiAgICAKICAgIHJldHVybiBzaWduYWxz"><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-5-4')" type="button">Run</button></div><pre><code><span class="k">def</span> <span class="nf">bollinger_mean_reversion</span><span class="p">(</span><span class="n">prices</span><span class="p">,</span> <span class="n">period</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">std_dev</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Bollinger Band mean reversion signals.&quot;&quot;&quot;</span>
    <span class="n">prices</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span>
    <span class="n">sma</span> <span class="o">=</span> <span class="n">prices</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">period</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">std</span> <span class="o">=</span> <span class="n">prices</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">period</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
    
    <span class="n">upper</span> <span class="o">=</span> <span class="n">sma</span> <span class="o">+</span> <span class="p">(</span><span class="n">std</span> <span class="o">*</span> <span class="n">std_dev</span><span class="p">)</span>
    <span class="n">lower</span> <span class="o">=</span> <span class="n">sma</span> <span class="o">-</span> <span class="p">(</span><span class="n">std</span> <span class="o">*</span> <span class="n">std_dev</span><span class="p">)</span>
    
    <span class="n">signals</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">prices</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">prices</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">lower</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
            <span class="n">signals</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;BUY&#39;</span><span class="p">,</span> <span class="s1">&#39;Below lower band&#39;</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">prices</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">upper</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
            <span class="n">signals</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;SELL&#39;</span><span class="p">,</span> <span class="s1">&#39;Above upper band&#39;</span><span class="p">))</span>
    
    <span class="k">return</span> <span class="n">signals</span>
</code></pre><div class="code-output" id="output-cell-5-4"></div></div>
<div class="md-cell"><h3>âœï¸ Exercise 5.2: Mean Reversion System</h3>
<p>Build a mean reversion strategy combining RSI and Bollinger Bands.</p></div>
<div class="code-cell" id="cell-5-5" data-source="IyBFeGVyY2lzZSA1LjIKY2xhc3MgTWVhblJldmVyc2lvblN0cmF0ZWd5OgogICAgZGVmIF9faW5pdF9fKHNlbGYpOgogICAgICAgIHBhc3MKICAgIAogICAgZGVmIGNhbGN1bGF0ZV9pbmRpY2F0b3JzKHNlbGYsIHByaWNlcyk6CiAgICAgICAgIyBUT0RPOiBSZXR1cm4gUlNJIGFuZCBCQiB2YWx1ZXMKICAgICAgICBwYXNzCiAgICAKICAgIGRlZiBnZW5lcmF0ZV9zaWduYWwoc2VsZiwgcHJpY2VzKToKICAgICAgICAjIFRPRE86IENvbWJpbmUgUlNJICsgQkIgZm9yIHNpZ25hbAogICAgICAgIHBhc3M="><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-5-5')" type="button">Run</button></div><pre><code><span class="c1"># Exercise 5.2</span>
<span class="k">class</span> <span class="nc">MeanReversionStrategy</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">calculate_indicators</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prices</span><span class="p">):</span>
        <span class="c1"># TODO: Return RSI and BB values</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">generate_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prices</span><span class="p">):</span>
        <span class="c1"># TODO: Combine RSI + BB for signal</span>
        <span class="k">pass</span>
</code></pre><div class="code-output" id="output-cell-5-5"></div></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">MeanReversionStrategy</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rsi_period</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">bb_period</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">bb_std</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rsi_period</span> <span class="o">=</span> <span class="n">rsi_period</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bb_period</span> <span class="o">=</span> <span class="n">bb_period</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bb_std</span> <span class="o">=</span> <span class="n">bb_std</span>

    <span class="k">def</span> <span class="nf">calculate_indicators</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prices</span><span class="p">):</span>
        <span class="n">prices</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span>

        <span class="c1"># RSI</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="n">prices</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span>
        <span class="n">gain</span> <span class="o">=</span> <span class="n">delta</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">delta</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rsi_period</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">delta</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">delta</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rsi_period</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">rs</span> <span class="o">=</span> <span class="n">gain</span> <span class="o">/</span> <span class="n">loss</span>
        <span class="n">rsi</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">-</span> <span class="p">(</span><span class="mi">100</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">rs</span><span class="p">))</span>

        <span class="c1"># Bollinger Bands</span>
        <span class="n">sma</span> <span class="o">=</span> <span class="n">prices</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bb_period</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">std</span> <span class="o">=</span> <span class="n">prices</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bb_period</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
        <span class="n">bb_upper</span> <span class="o">=</span> <span class="n">sma</span> <span class="o">+</span> <span class="p">(</span><span class="n">std</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">bb_std</span><span class="p">)</span>
        <span class="n">bb_lower</span> <span class="o">=</span> <span class="n">sma</span> <span class="o">-</span> <span class="p">(</span><span class="n">std</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">bb_std</span><span class="p">)</span>
        <span class="n">bb_pct</span> <span class="o">=</span> <span class="p">(</span><span class="n">prices</span> <span class="o">-</span> <span class="n">bb_lower</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">bb_upper</span> <span class="o">-</span> <span class="n">bb_lower</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;rsi&#39;</span><span class="p">:</span> <span class="n">rsi</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;bb_pct&#39;</span><span class="p">:</span> <span class="n">bb_pct</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="n">prices</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]}</span>

    <span class="k">def</span> <span class="nf">generate_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prices</span><span class="p">):</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_indicators</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span>

        <span class="c1"># Strong buy: RSI oversold AND below lower BB</span>
        <span class="k">if</span> <span class="n">ind</span><span class="p">[</span><span class="s1">&#39;rsi&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">30</span> <span class="ow">and</span> <span class="n">ind</span><span class="p">[</span><span class="s1">&#39;bb_pct&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="s1">&#39;STRONG_BUY&#39;</span><span class="p">,</span> <span class="s1">&#39;rsi&#39;</span><span class="p">:</span> <span class="n">ind</span><span class="p">[</span><span class="s1">&#39;rsi&#39;</span><span class="p">],</span> <span class="s1">&#39;bb_pct&#39;</span><span class="p">:</span> <span class="n">ind</span><span class="p">[</span><span class="s1">&#39;bb_pct&#39;</span><span class="p">]}</span>
        <span class="c1"># Strong sell: RSI overbought AND above upper BB</span>
        <span class="k">elif</span> <span class="n">ind</span><span class="p">[</span><span class="s1">&#39;rsi&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">70</span> <span class="ow">and</span> <span class="n">ind</span><span class="p">[</span><span class="s1">&#39;bb_pct&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="s1">&#39;STRONG_SELL&#39;</span><span class="p">,</span> <span class="s1">&#39;rsi&#39;</span><span class="p">:</span> <span class="n">ind</span><span class="p">[</span><span class="s1">&#39;rsi&#39;</span><span class="p">],</span> <span class="s1">&#39;bb_pct&#39;</span><span class="p">:</span> <span class="n">ind</span><span class="p">[</span><span class="s1">&#39;bb_pct&#39;</span><span class="p">]}</span>
        <span class="c1"># Weak signals</span>
        <span class="k">elif</span> <span class="n">ind</span><span class="p">[</span><span class="s1">&#39;rsi&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">30</span> <span class="ow">or</span> <span class="n">ind</span><span class="p">[</span><span class="s1">&#39;bb_pct&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="s1">&#39;WEAK_BUY&#39;</span><span class="p">,</span> <span class="s1">&#39;rsi&#39;</span><span class="p">:</span> <span class="n">ind</span><span class="p">[</span><span class="s1">&#39;rsi&#39;</span><span class="p">],</span> <span class="s1">&#39;bb_pct&#39;</span><span class="p">:</span> <span class="n">ind</span><span class="p">[</span><span class="s1">&#39;bb_pct&#39;</span><span class="p">]}</span>
        <span class="k">elif</span> <span class="n">ind</span><span class="p">[</span><span class="s1">&#39;rsi&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">70</span> <span class="ow">or</span> <span class="n">ind</span><span class="p">[</span><span class="s1">&#39;bb_pct&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="s1">&#39;WEAK_SELL&#39;</span><span class="p">,</span> <span class="s1">&#39;rsi&#39;</span><span class="p">:</span> <span class="n">ind</span><span class="p">[</span><span class="s1">&#39;rsi&#39;</span><span class="p">],</span> <span class="s1">&#39;bb_pct&#39;</span><span class="p">:</span> <span class="n">ind</span><span class="p">[</span><span class="s1">&#39;bb_pct&#39;</span><span class="p">]}</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="s1">&#39;HOLD&#39;</span><span class="p">,</span> <span class="s1">&#39;rsi&#39;</span><span class="p">:</span> <span class="n">ind</span><span class="p">[</span><span class="s1">&#39;rsi&#39;</span><span class="p">],</span> <span class="s1">&#39;bb_pct&#39;</span><span class="p">:</span> <span class="n">ind</span><span class="p">[</span><span class="s1">&#39;bb_pct&#39;</span><span class="p">]}</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>Section 3: Momentum Strategies</h1>
<h2>Relative Strength Ranking</h2>
<p>Rank assets by recent performance, buy strongest.</p></div>
<div class="code-cell" id="cell-5-6" data-source="ZGVmIG1vbWVudHVtX3JhbmtpbmcocHJpY2VfZGF0YSwgbG9va2JhY2s9MzApOgogICAgIiIiCiAgICBSYW5rIGFzc2V0cyBieSBtb21lbnR1bS4KICAgIAogICAgcHJpY2VfZGF0YTogZGljdCBvZiB7c3ltYm9sOiBwcmljZXNfbGlzdH0KICAgICIiIgogICAgcmFua2luZ3MgPSBbXQogICAgCiAgICBmb3Igc3ltYm9sLCBwcmljZXMgaW4gcHJpY2VfZGF0YS5pdGVtcygpOgogICAgICAgIGlmIGxlbihwcmljZXMpID49IGxvb2tiYWNrOgogICAgICAgICAgICByZXR1cm5zID0gKHByaWNlc1stMV0gLSBwcmljZXNbLWxvb2tiYWNrXSkgLyBwcmljZXNbLWxvb2tiYWNrXSAqIDEwMAogICAgICAgICAgICByYW5raW5ncy5hcHBlbmQoKHN5bWJvbCwgcmV0dXJucykpCiAgICAKICAgICMgU29ydCBieSByZXR1cm5zIChoaWdoZXN0IGZpcnN0KQogICAgcmFua2luZ3Muc29ydChrZXk9bGFtYmRhIHg6IHhbMV0sIHJldmVyc2U9VHJ1ZSkKICAgIHJldHVybiByYW5raW5ncwoKIyBFeGFtcGxlCmRhdGEgPSB7CiAgICAnQlRDJzogWzQwMDAwLCA0MjAwMCwgNDQwMDAsIDQzMDAwLCA0NTAwMF0sCiAgICAnRVRIJzogWzIwMDAsIDIxMDAsIDIwNTAsIDIyMDAsIDIzMDBdLAogICAgJ1NPTCc6IFsxMDAsIDk1LCA5MCwgMTA1LCAxMjBdCn0KcHJpbnQobW9tZW50dW1fcmFua2luZyhkYXRhLCAzKSk="><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-5-6')" type="button">Run</button></div><pre><code><span class="k">def</span> <span class="nf">momentum_ranking</span><span class="p">(</span><span class="n">price_data</span><span class="p">,</span> <span class="n">lookback</span><span class="o">=</span><span class="mi">30</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Rank assets by momentum.</span>
<span class="sd">    </span>
<span class="sd">    price_data: dict of {symbol: prices_list}</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rankings</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">for</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">prices</span> <span class="ow">in</span> <span class="n">price_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">lookback</span><span class="p">:</span>
            <span class="n">returns</span> <span class="o">=</span> <span class="p">(</span><span class="n">prices</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">prices</span><span class="p">[</span><span class="o">-</span><span class="n">lookback</span><span class="p">])</span> <span class="o">/</span> <span class="n">prices</span><span class="p">[</span><span class="o">-</span><span class="n">lookback</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span>
            <span class="n">rankings</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">symbol</span><span class="p">,</span> <span class="n">returns</span><span class="p">))</span>
    
    <span class="c1"># Sort by returns (highest first)</span>
    <span class="n">rankings</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">rankings</span>

<span class="c1"># Example</span>
<span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;BTC&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">40000</span><span class="p">,</span> <span class="mi">42000</span><span class="p">,</span> <span class="mi">44000</span><span class="p">,</span> <span class="mi">43000</span><span class="p">,</span> <span class="mi">45000</span><span class="p">],</span>
    <span class="s1">&#39;ETH&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">2000</span><span class="p">,</span> <span class="mi">2100</span><span class="p">,</span> <span class="mi">2050</span><span class="p">,</span> <span class="mi">2200</span><span class="p">,</span> <span class="mi">2300</span><span class="p">],</span>
    <span class="s1">&#39;SOL&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">95</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">105</span><span class="p">,</span> <span class="mi">120</span><span class="p">]</span>
<span class="p">}</span>
<span class="nb">print</span><span class="p">(</span><span class="n">momentum_ranking</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
</code></pre><div class="code-output" id="output-cell-5-6"></div></div>
<div class="md-cell"><h3>âœï¸ Exercise 5.3: Momentum Ranker</h3>
<p>Build a momentum ranking system with multiple timeframes.</p></div>
<div class="code-cell" id="cell-5-7" data-source="IyBFeGVyY2lzZSA1LjMKY2xhc3MgTW9tZW50dW1SYW5rZXI6CiAgICBkZWYgX19pbml0X18oc2VsZiwgbG9va2JhY2tzPVs3LCAxNCwgMzBdKToKICAgICAgICBzZWxmLmxvb2tiYWNrcyA9IGxvb2tiYWNrcwogICAgCiAgICBkZWYgY2FsY3VsYXRlX21vbWVudHVtKHNlbGYsIHByaWNlcywgbG9va2JhY2spOgogICAgICAgICMgVE9ETwogICAgICAgIHBhc3MKICAgIAogICAgZGVmIHJhbmtfYXNzZXRzKHNlbGYsIHByaWNlX2RhdGEpOgogICAgICAgICMgVE9ETzogUmFuayBieSBjb21iaW5lZCBtb21lbnR1bSBzY29yZQogICAgICAgIHBhc3M="><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-5-7')" type="button">Run</button></div><pre><code><span class="c1"># Exercise 5.3</span>
<span class="k">class</span> <span class="nc">MomentumRanker</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lookbacks</span><span class="o">=</span><span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">30</span><span class="p">]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lookbacks</span> <span class="o">=</span> <span class="n">lookbacks</span>
    
    <span class="k">def</span> <span class="nf">calculate_momentum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prices</span><span class="p">,</span> <span class="n">lookback</span><span class="p">):</span>
        <span class="c1"># TODO</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">rank_assets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">price_data</span><span class="p">):</span>
        <span class="c1"># TODO: Rank by combined momentum score</span>
        <span class="k">pass</span>
</code></pre><div class="code-output" id="output-cell-5-7"></div></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">MomentumRanker</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lookbacks</span><span class="o">=</span><span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">30</span><span class="p">]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lookbacks</span> <span class="o">=</span> <span class="n">lookbacks</span>

    <span class="k">def</span> <span class="nf">calculate_momentum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prices</span><span class="p">,</span> <span class="n">lookback</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">lookback</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">prices</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">prices</span><span class="p">[</span><span class="o">-</span><span class="n">lookback</span><span class="p">])</span> <span class="o">/</span> <span class="n">prices</span><span class="p">[</span><span class="o">-</span><span class="n">lookback</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span>

    <span class="k">def</span> <span class="nf">rank_assets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">price_data</span><span class="p">):</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">prices</span> <span class="ow">in</span> <span class="n">price_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">momentum_scores</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">lb</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookbacks</span><span class="p">:</span>
                <span class="n">mom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_momentum</span><span class="p">(</span><span class="n">prices</span><span class="p">,</span> <span class="n">lb</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">mom</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">momentum_scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mom</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">momentum_scores</span><span class="p">:</span>
                <span class="n">avg_score</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">momentum_scores</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">momentum_scores</span><span class="p">)</span>
                <span class="n">scores</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span>
                    <span class="s1">&#39;avg_momentum&#39;</span><span class="p">:</span> <span class="n">avg_score</span><span class="p">,</span>
                    <span class="s1">&#39;details&#39;</span><span class="p">:</span> <span class="p">{</span><span class="n">lb</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_momentum</span><span class="p">(</span><span class="n">prices</span><span class="p">,</span> <span class="n">lb</span><span class="p">)</span> <span class="k">for</span> <span class="n">lb</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookbacks</span><span class="p">}</span>
                <span class="p">})</span>

        <span class="n">scores</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;avg_momentum&#39;</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">scores</span>

<span class="n">ranker</span> <span class="o">=</span> <span class="n">MomentumRanker</span><span class="p">([</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">])</span>
<span class="n">rankings</span> <span class="o">=</span> <span class="n">ranker</span><span class="o">.</span><span class="n">rank_assets</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">rankings</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;symbol&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;avg_momentum&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>Section 4: Range Trading</h1>
<h2>Identifying Ranges</h2></div>
<div class="code-cell" id="cell-5-8" data-source="ZGVmIGlkZW50aWZ5X3JhbmdlKHByaWNlcywgbG9va2JhY2s9MjAsIHRocmVzaG9sZD0wLjA1KToKICAgICIiIklkZW50aWZ5IGlmIHByaWNlIGlzIGluIGEgcmFuZ2UuIiIiCiAgICBwcmljZXMgPSBwZC5TZXJpZXMocHJpY2VzKQogICAgcmVjZW50ID0gcHJpY2VzLmlsb2NbLWxvb2tiYWNrOl0KICAgIAogICAgaGlnaCA9IHJlY2VudC5tYXgoKQogICAgbG93ID0gcmVjZW50Lm1pbigpCiAgICByYW5nZV9wY3QgPSAoaGlnaCAtIGxvdykgLyBsb3cKICAgIAogICAgY3VycmVudCA9IHByaWNlcy5pbG9jWy0xXQogICAgcG9zaXRpb24gPSAoY3VycmVudCAtIGxvdykgLyAoaGlnaCAtIGxvdykgaWYgaGlnaCAhPSBsb3cgZWxzZSAwLjUKICAgIAogICAgaXNfcmFuZ2luZyA9IHJhbmdlX3BjdCA8IHRocmVzaG9sZAogICAgCiAgICByZXR1cm4gewogICAgICAgICdpc19yYW5naW5nJzogaXNfcmFuZ2luZywKICAgICAgICAnaGlnaCc6IGhpZ2gsCiAgICAgICAgJ2xvdyc6IGxvdywKICAgICAgICAncmFuZ2VfcGN0JzogcmFuZ2VfcGN0ICogMTAwLAogICAgICAgICdwb3NpdGlvbic6IHBvc2l0aW9uICAjIDAgPSBhdCBsb3csIDEgPSBhdCBoaWdoCiAgICB9"><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-5-8')" type="button">Run</button></div><pre><code><span class="k">def</span> <span class="nf">identify_range</span><span class="p">(</span><span class="n">prices</span><span class="p">,</span> <span class="n">lookback</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.05</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Identify if price is in a range.&quot;&quot;&quot;</span>
    <span class="n">prices</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span>
    <span class="n">recent</span> <span class="o">=</span> <span class="n">prices</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="n">lookback</span><span class="p">:]</span>
    
    <span class="n">high</span> <span class="o">=</span> <span class="n">recent</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">low</span> <span class="o">=</span> <span class="n">recent</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="n">range_pct</span> <span class="o">=</span> <span class="p">(</span><span class="n">high</span> <span class="o">-</span> <span class="n">low</span><span class="p">)</span> <span class="o">/</span> <span class="n">low</span>
    
    <span class="n">current</span> <span class="o">=</span> <span class="n">prices</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">position</span> <span class="o">=</span> <span class="p">(</span><span class="n">current</span> <span class="o">-</span> <span class="n">low</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">high</span> <span class="o">-</span> <span class="n">low</span><span class="p">)</span> <span class="k">if</span> <span class="n">high</span> <span class="o">!=</span> <span class="n">low</span> <span class="k">else</span> <span class="mf">0.5</span>
    
    <span class="n">is_ranging</span> <span class="o">=</span> <span class="n">range_pct</span> <span class="o">&lt;</span> <span class="n">threshold</span>
    
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;is_ranging&#39;</span><span class="p">:</span> <span class="n">is_ranging</span><span class="p">,</span>
        <span class="s1">&#39;high&#39;</span><span class="p">:</span> <span class="n">high</span><span class="p">,</span>
        <span class="s1">&#39;low&#39;</span><span class="p">:</span> <span class="n">low</span><span class="p">,</span>
        <span class="s1">&#39;range_pct&#39;</span><span class="p">:</span> <span class="n">range_pct</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
        <span class="s1">&#39;position&#39;</span><span class="p">:</span> <span class="n">position</span>  <span class="c1"># 0 = at low, 1 = at high</span>
    <span class="p">}</span>
</code></pre><div class="code-output" id="output-cell-5-8"></div></div>
<div class="md-cell"><h3>âœï¸ Exercise 5.4: Range Trading Strategy</h3>
<p>Build a range trading strategy that buys at support, sells at resistance.</p></div>
<div class="code-cell" id="cell-5-9" data-source="IyBFeGVyY2lzZSA1LjQKY2xhc3MgUmFuZ2VUcmFkaW5nU3RyYXRlZ3k6CiAgICBkZWYgX19pbml0X18oc2VsZiwgbG9va2JhY2s9MjAsIGJ1eV96b25lPTAuMiwgc2VsbF96b25lPTAuOCk6CiAgICAgICAgc2VsZi5sb29rYmFjayA9IGxvb2tiYWNrCiAgICAgICAgc2VsZi5idXlfem9uZSA9IGJ1eV96b25lCiAgICAgICAgc2VsZi5zZWxsX3pvbmUgPSBzZWxsX3pvbmUKICAgIAogICAgZGVmIGFuYWx5emUoc2VsZiwgcHJpY2VzKToKICAgICAgICAjIFRPRE8KICAgICAgICBwYXNzCiAgICAKICAgIGRlZiBnZW5lcmF0ZV9zaWduYWwoc2VsZiwgcHJpY2VzKToKICAgICAgICAjIFRPRE8KICAgICAgICBwYXNz"><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-5-9')" type="button">Run</button></div><pre><code><span class="c1"># Exercise 5.4</span>
<span class="k">class</span> <span class="nc">RangeTradingStrategy</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lookback</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">buy_zone</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">sell_zone</span><span class="o">=</span><span class="mf">0.8</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lookback</span> <span class="o">=</span> <span class="n">lookback</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buy_zone</span> <span class="o">=</span> <span class="n">buy_zone</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sell_zone</span> <span class="o">=</span> <span class="n">sell_zone</span>
    
    <span class="k">def</span> <span class="nf">analyze</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prices</span><span class="p">):</span>
        <span class="c1"># TODO</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">generate_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prices</span><span class="p">):</span>
        <span class="c1"># TODO</span>
        <span class="k">pass</span>
</code></pre><div class="code-output" id="output-cell-5-9"></div></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">RangeTradingStrategy</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lookback</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">buy_zone</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">sell_zone</span><span class="o">=</span><span class="mf">0.8</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lookback</span> <span class="o">=</span> <span class="n">lookback</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buy_zone</span> <span class="o">=</span> <span class="n">buy_zone</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sell_zone</span> <span class="o">=</span> <span class="n">sell_zone</span>

    <span class="k">def</span> <span class="nf">analyze</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prices</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">identify_range</span><span class="p">(</span><span class="n">prices</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookback</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">generate_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prices</span><span class="p">):</span>
        <span class="n">analysis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;is_ranging&#39;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="s1">&#39;NO_TRADE&#39;</span><span class="p">,</span> <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="s1">&#39;Not in range&#39;</span><span class="p">}</span>

        <span class="n">position</span> <span class="o">=</span> <span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;position&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">position</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">buy_zone</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="s1">&#39;BUY&#39;</span><span class="p">,</span>
                <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;At support (</span><span class="si">{</span><span class="n">position</span><span class="si">:</span><span class="s1">.1%</span><span class="si">}</span><span class="s1"> of range)&#39;</span><span class="p">,</span>
                <span class="s1">&#39;target&#39;</span><span class="p">:</span> <span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;high&#39;</span><span class="p">],</span>
                <span class="s1">&#39;stop&#39;</span><span class="p">:</span> <span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;low&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.98</span>
            <span class="p">}</span>
        <span class="k">elif</span> <span class="n">position</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sell_zone</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="s1">&#39;SELL&#39;</span><span class="p">,</span>
                <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;At resistance (</span><span class="si">{</span><span class="n">position</span><span class="si">:</span><span class="s1">.1%</span><span class="si">}</span><span class="s1"> of range)&#39;</span><span class="p">,</span>
                <span class="s1">&#39;target&#39;</span><span class="p">:</span> <span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;low&#39;</span><span class="p">],</span>
                <span class="s1">&#39;stop&#39;</span><span class="p">:</span> <span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;high&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1.02</span>
            <span class="p">}</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="s1">&#39;HOLD&#39;</span><span class="p">,</span> <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="s1">&#39;Mid-range&#39;</span><span class="p">}</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>ğŸ—ï¸ Module Project: Multi-Strategy Signal System</h1>
<p>Combine all strategies into one signal generator.</p></div>
<div class="code-cell" id="cell-5-10" data-source="IyBNb2R1bGUgUHJvamVjdApjbGFzcyBNdWx0aVN0cmF0ZWd5U3lzdGVtOgogICAgZGVmIF9faW5pdF9fKHNlbGYpOgogICAgICAgIHNlbGYudHJlbmRfc3RyYXRlZ3kgPSBOb25lCiAgICAgICAgc2VsZi5tZWFuX3JldmVyc2lvbiA9IE5vbmUKICAgICAgICBzZWxmLnJhbmdlX3N0cmF0ZWd5ID0gTm9uZQogICAgCiAgICBkZWYgYW5hbHl6ZV9tYXJrZXRfcmVnaW1lKHNlbGYsIHByaWNlcyk6CiAgICAgICAgIyBUT0RPOiBEZXRlcm1pbmUgaWYgdHJlbmRpbmcgb3IgcmFuZ2luZwogICAgICAgIHBhc3MKICAgIAogICAgZGVmIGdldF9jb21iaW5lZF9zaWduYWwoc2VsZiwgcHJpY2VzKToKICAgICAgICAjIFRPRE86IFVzZSBhcHByb3ByaWF0ZSBzdHJhdGVneSBiYXNlZCBvbiByZWdpbWUKICAgICAgICBwYXNzCiAgICAKICAgIGRlZiBnZW5lcmF0ZV9yZXBvcnQoc2VsZiwgcHJpY2VzKToKICAgICAgICAjIFRPRE86IEZ1bGwgYW5hbHlzaXMgcmVwb3J0CiAgICAgICAgcGFzcw=="><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-5-10')" type="button">Run</button></div><pre><code><span class="c1"># Module Project</span>
<span class="k">class</span> <span class="nc">MultiStrategySystem</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trend_strategy</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mean_reversion</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">range_strategy</span> <span class="o">=</span> <span class="kc">None</span>
    
    <span class="k">def</span> <span class="nf">analyze_market_regime</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prices</span><span class="p">):</span>
        <span class="c1"># TODO: Determine if trending or ranging</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">get_combined_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prices</span><span class="p">):</span>
        <span class="c1"># TODO: Use appropriate strategy based on regime</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">generate_report</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prices</span><span class="p">):</span>
        <span class="c1"># TODO: Full analysis report</span>
        <span class="k">pass</span>
</code></pre><div class="code-output" id="output-cell-5-10"></div></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">MultiStrategySystem</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trend_strategy</span> <span class="o">=</span> <span class="n">TrendFollowingStrategy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mean_reversion</span> <span class="o">=</span> <span class="n">MeanReversionStrategy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">range_strategy</span> <span class="o">=</span> <span class="n">RangeTradingStrategy</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">analyze_market_regime</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prices</span><span class="p">):</span>
        <span class="n">range_analysis</span> <span class="o">=</span> <span class="n">identify_range</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">range_analysis</span><span class="p">[</span><span class="s1">&#39;is_ranging&#39;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="s1">&#39;RANGING&#39;</span>

        <span class="n">trend</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trend_strategy</span><span class="o">.</span><span class="n">get_trend</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">trend</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;UP&#39;</span><span class="p">,</span> <span class="s1">&#39;DOWN&#39;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;TRENDING_</span><span class="si">{</span><span class="n">trend</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="k">return</span> <span class="s1">&#39;UNCLEAR&#39;</span>

    <span class="k">def</span> <span class="nf">get_combined_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prices</span><span class="p">):</span>
        <span class="n">regime</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_market_regime</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">regime</span> <span class="o">==</span> <span class="s1">&#39;RANGING&#39;</span><span class="p">:</span>
            <span class="n">signal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">range_strategy</span><span class="o">.</span><span class="n">generate_signal</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span>
            <span class="n">signal</span><span class="p">[</span><span class="s1">&#39;strategy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;RANGE&#39;</span>
        <span class="k">elif</span> <span class="n">regime</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;TRENDING&#39;</span><span class="p">):</span>
            <span class="n">signal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trend_strategy</span><span class="o">.</span><span class="n">generate_signal</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span>
            <span class="n">signal</span><span class="p">[</span><span class="s1">&#39;strategy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;TREND&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">signal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mean_reversion</span><span class="o">.</span><span class="n">generate_signal</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span>
            <span class="n">signal</span><span class="p">[</span><span class="s1">&#39;strategy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;MEAN_REVERSION&#39;</span>

        <span class="n">signal</span><span class="p">[</span><span class="s1">&#39;regime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">regime</span>
        <span class="k">return</span> <span class="n">signal</span>

    <span class="k">def</span> <span class="nf">generate_report</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prices</span><span class="p">):</span>
        <span class="n">signal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_combined_signal</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=&#39;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;     MULTI-STRATEGY ANALYSIS&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=&#39;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Market Regime: </span><span class="si">{</span><span class="n">signal</span><span class="p">[</span><span class="s1">&#39;regime&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Strategy Used: </span><span class="si">{</span><span class="n">signal</span><span class="p">[</span><span class="s1">&#39;strategy&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Signal: </span><span class="si">{</span><span class="n">signal</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;signal&#39;</span><span class="p">,</span> <span class="s1">&#39;N/A&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;confidence&#39;</span> <span class="ow">in</span> <span class="n">signal</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Confidence: </span><span class="si">{</span><span class="n">signal</span><span class="p">[</span><span class="s1">&#39;confidence&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=&#39;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>

<span class="n">system</span> <span class="o">=</span> <span class="n">MultiStrategySystem</span><span class="p">()</span>
<span class="n">system</span><span class="o">.</span><span class="n">generate_report</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>ğŸ“ Key Takeaways</h1>
<ol>
<li><strong>Trend Following</strong>: MA crossovers, breakouts - ride the trend</li>
<li><strong>Mean Reversion</strong>: RSI, Bollinger - fade extremes</li>
<li><strong>Momentum</strong>: Rank assets, buy winners</li>
<li><strong>Range Trading</strong>: Buy support, sell resistance</li>
<li><strong>Regime Detection</strong>: Use right strategy for market conditions</li>
</ol>
<hr />
<p><em>Next: Module 6 - Backtesting</em></p></div>
        <div class="nav-buttons">
            <button class="nav-btn prev-btn disabled" type="button">
                <span class="nav-btn-label">â† Previous</span>
                <span class="nav-btn-name"></span>
            </button>
            <button class="nav-btn next-btn disabled" type="button">
                <span class="nav-btn-label">Next â†’</span>
                <span class="nav-btn-name"></span>
            </button>
        </div>
        </div>
<div class="module-section" data-idx="6"><div class="md-cell module-header"><h1>Module 6: Backtesting Crypto Strategies</h1>
<h2>Part 2: Strategy Development</h2>
<hr />
<div class="table-wrapper"><table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>â±ï¸ <strong>Duration</strong></td>
<td>~2.5 hours</td>
</tr>
<tr>
<td>ğŸ“‹ <strong>Prerequisites</strong></td>
<td>Module 5</td>
</tr>
<tr>
<td>ğŸ’ª <strong>Exercises</strong></td>
<td>5 total</td>
</tr>
</tbody>
</table></div></div>
<div class="md-cell"><h2>ğŸ¯ Learning Objectives</h2>
<ul>
<li>Avoid common backtesting pitfalls</li>
<li>Build an event-driven backtester</li>
<li>Calculate proper performance metrics</li>
<li>Implement walk-forward optimization</li>
</ul></div>
<div class="md-cell"><hr />
<h1>Section 1: Backtesting Fundamentals</h1>
<h2>Common Pitfalls</h2>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Bias</th>
<th>Description</th>
<th>Solution</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Lookahead</strong></td>
<td>Using future data</td>
<td>Point-in-time data only</td>
</tr>
<tr>
<td><strong>Survivorship</strong></td>
<td>Only testing existing assets</td>
<td>Include delisted tokens</td>
</tr>
<tr>
<td><strong>Overfitting</strong></td>
<td>Curve-fitting to history</td>
<td>Out-of-sample testing</td>
</tr>
</tbody>
</table></div></div>
<div class="code-cell" id="cell-6-0" data-source="IyBUcmFuc2FjdGlvbiBjb3N0cyBpbiBjcnlwdG8KY2xhc3MgVHJhbnNhY3Rpb25Db3N0czoKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBtYWtlcl9mZWU9MC4wMDEsIHRha2VyX2ZlZT0wLjAwMSwgc2xpcHBhZ2U9MC4wMDEpOgogICAgICAgIHNlbGYubWFrZXJfZmVlID0gbWFrZXJfZmVlICAjIDAuMSUKICAgICAgICBzZWxmLnRha2VyX2ZlZSA9IHRha2VyX2ZlZSAgIyAwLjElCiAgICAgICAgc2VsZi5zbGlwcGFnZSA9IHNsaXBwYWdlICAgICMgMC4xJQogICAgCiAgICBkZWYgY2FsY3VsYXRlX2Nvc3Qoc2VsZiwgdHJhZGVfdmFsdWUsIG9yZGVyX3R5cGU9J3Rha2VyJyk6CiAgICAgICAgZmVlID0gc2VsZi50YWtlcl9mZWUgaWYgb3JkZXJfdHlwZSA9PSAndGFrZXInIGVsc2Ugc2VsZi5tYWtlcl9mZWUKICAgICAgICB0b3RhbF9jb3N0ID0gdHJhZGVfdmFsdWUgKiAoZmVlICsgc2VsZi5zbGlwcGFnZSkKICAgICAgICByZXR1cm4gdG90YWxfY29zdAoKY29zdHMgPSBUcmFuc2FjdGlvbkNvc3RzKCkKcHJpbnQoZidDb3N0IGZvciAkMTAsMDAwIHRyYWRlOiAke2Nvc3RzLmNhbGN1bGF0ZV9jb3N0KDEwMDAwKTouMmZ9Jyk="><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-6-0')" type="button">Run</button></div><pre><code><span class="c1"># Transaction costs in crypto</span>
<span class="k">class</span> <span class="nc">TransactionCosts</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">maker_fee</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">taker_fee</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">slippage</span><span class="o">=</span><span class="mf">0.001</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maker_fee</span> <span class="o">=</span> <span class="n">maker_fee</span>  <span class="c1"># 0.1%</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">taker_fee</span> <span class="o">=</span> <span class="n">taker_fee</span>  <span class="c1"># 0.1%</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slippage</span> <span class="o">=</span> <span class="n">slippage</span>    <span class="c1"># 0.1%</span>
    
    <span class="k">def</span> <span class="nf">calculate_cost</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trade_value</span><span class="p">,</span> <span class="n">order_type</span><span class="o">=</span><span class="s1">&#39;taker&#39;</span><span class="p">):</span>
        <span class="n">fee</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">taker_fee</span> <span class="k">if</span> <span class="n">order_type</span> <span class="o">==</span> <span class="s1">&#39;taker&#39;</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">maker_fee</span>
        <span class="n">total_cost</span> <span class="o">=</span> <span class="n">trade_value</span> <span class="o">*</span> <span class="p">(</span><span class="n">fee</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">slippage</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">total_cost</span>

<span class="n">costs</span> <span class="o">=</span> <span class="n">TransactionCosts</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Cost for $10,000 trade: $</span><span class="si">{</span><span class="n">costs</span><span class="o">.</span><span class="n">calculate_cost</span><span class="p">(</span><span class="mi">10000</span><span class="p">)</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</code></pre><div class="code-output" id="output-cell-6-0"></div></div>
<div class="md-cell"><h3>âœï¸ Exercise 6.1: Add Realistic Costs</h3>
<p>Create a function that calculates net returns after all costs.</p></div>
<div class="code-cell" id="cell-6-1" data-source="IyBFeGVyY2lzZSA2LjEKZGVmIGNhbGN1bGF0ZV9uZXRfcmV0dXJucyhncm9zc19wbmwsIG51bV90cmFkZXMsIGF2Z190cmFkZV9zaXplLCBjb3N0cyk6CiAgICAiIiJDYWxjdWxhdGUgbmV0IHJldHVybnMgYWZ0ZXIgdHJhbnNhY3Rpb24gY29zdHMuIiIiCiAgICAjIFRPRE8KICAgIHBhc3M="><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-6-1')" type="button">Run</button></div><pre><code><span class="c1"># Exercise 6.1</span>
<span class="k">def</span> <span class="nf">calculate_net_returns</span><span class="p">(</span><span class="n">gross_pnl</span><span class="p">,</span> <span class="n">num_trades</span><span class="p">,</span> <span class="n">avg_trade_size</span><span class="p">,</span> <span class="n">costs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Calculate net returns after transaction costs.&quot;&quot;&quot;</span>
    <span class="c1"># TODO</span>
    <span class="k">pass</span>
</code></pre><div class="code-output" id="output-cell-6-1"></div></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">calculate_net_returns</span><span class="p">(</span><span class="n">gross_pnl</span><span class="p">,</span> <span class="n">num_trades</span><span class="p">,</span> <span class="n">avg_trade_size</span><span class="p">,</span> <span class="n">costs</span><span class="p">):</span>
    <span class="n">total_cost</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_trades</span><span class="p">):</span>
        <span class="c1"># Entry and exit costs</span>
        <span class="n">entry_cost</span> <span class="o">=</span> <span class="n">costs</span><span class="o">.</span><span class="n">calculate_cost</span><span class="p">(</span><span class="n">avg_trade_size</span><span class="p">)</span>
        <span class="n">exit_cost</span> <span class="o">=</span> <span class="n">costs</span><span class="o">.</span><span class="n">calculate_cost</span><span class="p">(</span><span class="n">avg_trade_size</span><span class="p">)</span>
        <span class="n">total_cost</span> <span class="o">+=</span> <span class="n">entry_cost</span> <span class="o">+</span> <span class="n">exit_cost</span>

    <span class="n">net_pnl</span> <span class="o">=</span> <span class="n">gross_pnl</span> <span class="o">-</span> <span class="n">total_cost</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;gross_pnl&#39;</span><span class="p">:</span> <span class="n">gross_pnl</span><span class="p">,</span>
        <span class="s1">&#39;total_costs&#39;</span><span class="p">:</span> <span class="n">total_cost</span><span class="p">,</span>
        <span class="s1">&#39;net_pnl&#39;</span><span class="p">:</span> <span class="n">net_pnl</span><span class="p">,</span>
        <span class="s1">&#39;cost_pct&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">total_cost</span> <span class="o">/</span> <span class="n">gross_pnl</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span> <span class="k">if</span> <span class="n">gross_pnl</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="p">}</span>

<span class="n">result</span> <span class="o">=</span> <span class="n">calculate_net_returns</span><span class="p">(</span><span class="mi">5000</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">10000</span><span class="p">,</span> <span class="n">costs</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Gross: $</span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;gross_pnl&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, Costs: $</span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;total_costs&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, Net: $</span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;net_pnl&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>Section 2: Building a Backtester</h1></div>
<div class="code-cell" id="cell-6-2" data-source="aW1wb3J0IHBhbmRhcyBhcyBwZAppbXBvcnQgbnVtcHkgYXMgbnAKCmNsYXNzIFNpbXBsZUJhY2t0ZXN0ZXI6CiAgICBkZWYgX19pbml0X18oc2VsZiwgaW5pdGlhbF9jYXBpdGFsPTEwMDAwKToKICAgICAgICBzZWxmLmluaXRpYWxfY2FwaXRhbCA9IGluaXRpYWxfY2FwaXRhbAogICAgICAgIHNlbGYuY2FwaXRhbCA9IGluaXRpYWxfY2FwaXRhbAogICAgICAgIHNlbGYucG9zaXRpb24gPSAwCiAgICAgICAgc2VsZi50cmFkZXMgPSBbXQogICAgICAgIHNlbGYuZXF1aXR5X2N1cnZlID0gW2luaXRpYWxfY2FwaXRhbF0KICAgIAogICAgZGVmIGJ1eShzZWxmLCBwcmljZSwgc2l6ZT1Ob25lKToKICAgICAgICBpZiBzaXplIGlzIE5vbmU6CiAgICAgICAgICAgIHNpemUgPSBzZWxmLmNhcGl0YWwgLyBwcmljZQogICAgICAgIGNvc3QgPSBzaXplICogcHJpY2UgKiAxLjAwMSAgIyBJbmNsdWRlIDAuMSUgZmVlCiAgICAgICAgaWYgY29zdCA8PSBzZWxmLmNhcGl0YWw6CiAgICAgICAgICAgIHNlbGYuY2FwaXRhbCAtPSBjb3N0CiAgICAgICAgICAgIHNlbGYucG9zaXRpb24gKz0gc2l6ZQogICAgICAgICAgICBzZWxmLnRyYWRlcy5hcHBlbmQoeyd0eXBlJzogJ0JVWScsICdwcmljZSc6IHByaWNlLCAnc2l6ZSc6IHNpemV9KQogICAgCiAgICBkZWYgc2VsbChzZWxmLCBwcmljZSwgc2l6ZT1Ob25lKToKICAgICAgICBpZiBzaXplIGlzIE5vbmU6CiAgICAgICAgICAgIHNpemUgPSBzZWxmLnBvc2l0aW9uCiAgICAgICAgaWYgc2l6ZSA8PSBzZWxmLnBvc2l0aW9uOgogICAgICAgICAgICByZXZlbnVlID0gc2l6ZSAqIHByaWNlICogMC45OTkgICMgSW5jbHVkZSAwLjElIGZlZQogICAgICAgICAgICBzZWxmLmNhcGl0YWwgKz0gcmV2ZW51ZQogICAgICAgICAgICBzZWxmLnBvc2l0aW9uIC09IHNpemUKICAgICAgICAgICAgc2VsZi50cmFkZXMuYXBwZW5kKHsndHlwZSc6ICdTRUxMJywgJ3ByaWNlJzogcHJpY2UsICdzaXplJzogc2l6ZX0pCiAgICAKICAgIGRlZiB1cGRhdGVfZXF1aXR5KHNlbGYsIGN1cnJlbnRfcHJpY2UpOgogICAgICAgIGVxdWl0eSA9IHNlbGYuY2FwaXRhbCArIChzZWxmLnBvc2l0aW9uICogY3VycmVudF9wcmljZSkKICAgICAgICBzZWxmLmVxdWl0eV9jdXJ2ZS5hcHBlbmQoZXF1aXR5KQogICAgCiAgICBkZWYgZ2V0X3Jlc3VsdHMoc2VsZik6CiAgICAgICAgZmluYWxfZXF1aXR5ID0gc2VsZi5lcXVpdHlfY3VydmVbLTFdCiAgICAgICAgdG90YWxfcmV0dXJuID0gKGZpbmFsX2VxdWl0eSAtIHNlbGYuaW5pdGlhbF9jYXBpdGFsKSAvIHNlbGYuaW5pdGlhbF9jYXBpdGFsICogMTAwCiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgJ2ZpbmFsX2VxdWl0eSc6IGZpbmFsX2VxdWl0eSwKICAgICAgICAgICAgJ3RvdGFsX3JldHVybic6IHRvdGFsX3JldHVybiwKICAgICAgICAgICAgJ251bV90cmFkZXMnOiBsZW4oc2VsZi50cmFkZXMpCiAgICAgICAgfQ=="><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-6-2')" type="button">Run</button></div><pre><code><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="k">class</span> <span class="nc">SimpleBacktester</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">initial_capital</span><span class="o">=</span><span class="mi">10000</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initial_capital</span> <span class="o">=</span> <span class="n">initial_capital</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">capital</span> <span class="o">=</span> <span class="n">initial_capital</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trades</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">equity_curve</span> <span class="o">=</span> <span class="p">[</span><span class="n">initial_capital</span><span class="p">]</span>
    
    <span class="k">def</span> <span class="nf">buy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">price</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">capital</span> <span class="o">/</span> <span class="n">price</span>
        <span class="n">cost</span> <span class="o">=</span> <span class="n">size</span> <span class="o">*</span> <span class="n">price</span> <span class="o">*</span> <span class="mf">1.001</span>  <span class="c1"># Include 0.1% fee</span>
        <span class="k">if</span> <span class="n">cost</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">capital</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">capital</span> <span class="o">-=</span> <span class="n">cost</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">+=</span> <span class="n">size</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trades</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;BUY&#39;</span><span class="p">,</span> <span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="n">price</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="n">size</span><span class="p">})</span>
    
    <span class="k">def</span> <span class="nf">sell</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">price</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">position</span>
        <span class="k">if</span> <span class="n">size</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">position</span><span class="p">:</span>
            <span class="n">revenue</span> <span class="o">=</span> <span class="n">size</span> <span class="o">*</span> <span class="n">price</span> <span class="o">*</span> <span class="mf">0.999</span>  <span class="c1"># Include 0.1% fee</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">capital</span> <span class="o">+=</span> <span class="n">revenue</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">-=</span> <span class="n">size</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trades</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;SELL&#39;</span><span class="p">,</span> <span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="n">price</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="n">size</span><span class="p">})</span>
    
    <span class="k">def</span> <span class="nf">update_equity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current_price</span><span class="p">):</span>
        <span class="n">equity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">capital</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">*</span> <span class="n">current_price</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">equity_curve</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">equity</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">get_results</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">final_equity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">equity_curve</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">total_return</span> <span class="o">=</span> <span class="p">(</span><span class="n">final_equity</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_capital</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_capital</span> <span class="o">*</span> <span class="mi">100</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;final_equity&#39;</span><span class="p">:</span> <span class="n">final_equity</span><span class="p">,</span>
            <span class="s1">&#39;total_return&#39;</span><span class="p">:</span> <span class="n">total_return</span><span class="p">,</span>
            <span class="s1">&#39;num_trades&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trades</span><span class="p">)</span>
        <span class="p">}</span>
</code></pre><div class="code-output" id="output-cell-6-2"></div></div>
<div class="md-cell"><h3>âœï¸ Exercise 6.2: Complete Backtester</h3>
<p>Extend the backtester with position tracking and trade logging.</p></div>
<div class="code-cell" id="cell-6-3" data-source="IyBFeGVyY2lzZSA2LjIKY2xhc3MgQ3J5cHRvQmFja3Rlc3RlcjoKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBpbml0aWFsX2NhcGl0YWw9MTAwMDAsIGZlZT0wLjAwMSk6CiAgICAgICAgc2VsZi5pbml0aWFsX2NhcGl0YWwgPSBpbml0aWFsX2NhcGl0YWwKICAgICAgICBzZWxmLmZlZSA9IGZlZQogICAgICAgICMgVE9ETzogSW5pdGlhbGl6ZSB0cmFja2luZyB2YXJpYWJsZXMKICAgIAogICAgZGVmIHJ1bl9iYWNrdGVzdChzZWxmLCBwcmljZXMsIHNpZ25hbHMpOgogICAgICAgICIiIlJ1biBiYWNrdGVzdCBnaXZlbiBwcmljZXMgYW5kIHNpZ25hbHMgbGlzdC4iIiIKICAgICAgICAjIFRPRE8KICAgICAgICBwYXNzCiAgICAKICAgIGRlZiBjYWxjdWxhdGVfbWV0cmljcyhzZWxmKToKICAgICAgICAjIFRPRE86IFJldHVybiBwZXJmb3JtYW5jZSBtZXRyaWNzCiAgICAgICAgcGFzcw=="><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-6-3')" type="button">Run</button></div><pre><code><span class="c1"># Exercise 6.2</span>
<span class="k">class</span> <span class="nc">CryptoBacktester</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">initial_capital</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span> <span class="n">fee</span><span class="o">=</span><span class="mf">0.001</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initial_capital</span> <span class="o">=</span> <span class="n">initial_capital</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fee</span> <span class="o">=</span> <span class="n">fee</span>
        <span class="c1"># TODO: Initialize tracking variables</span>
    
    <span class="k">def</span> <span class="nf">run_backtest</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prices</span><span class="p">,</span> <span class="n">signals</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Run backtest given prices and signals list.&quot;&quot;&quot;</span>
        <span class="c1"># TODO</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">calculate_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># TODO: Return performance metrics</span>
        <span class="k">pass</span>
</code></pre><div class="code-output" id="output-cell-6-3"></div></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">CryptoBacktester</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">initial_capital</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span> <span class="n">fee</span><span class="o">=</span><span class="mf">0.001</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initial_capital</span> <span class="o">=</span> <span class="n">initial_capital</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fee</span> <span class="o">=</span> <span class="n">fee</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">capital</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_capital</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">entry_price</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trades</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">equity_curve</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">run_backtest</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prices</span><span class="p">,</span> <span class="n">signals</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">price</span><span class="p">,</span> <span class="n">signal</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">prices</span><span class="p">,</span> <span class="n">signals</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">signal</span> <span class="o">==</span> <span class="s1">&#39;BUY&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">capital</span> <span class="o">*</span> <span class="mf">0.95</span><span class="p">)</span> <span class="o">/</span> <span class="n">price</span>  <span class="c1"># Use 95% of capital</span>
                <span class="n">cost</span> <span class="o">=</span> <span class="n">size</span> <span class="o">*</span> <span class="n">price</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">fee</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">capital</span> <span class="o">-=</span> <span class="n">cost</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="n">size</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">entry_price</span> <span class="o">=</span> <span class="n">price</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">trades</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;BUY&#39;</span><span class="p">,</span> <span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="n">price</span><span class="p">,</span> <span class="s1">&#39;i&#39;</span><span class="p">:</span> <span class="n">i</span><span class="p">})</span>

            <span class="k">elif</span> <span class="n">signal</span> <span class="o">==</span> <span class="s1">&#39;SELL&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">revenue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">*</span> <span class="n">price</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">fee</span><span class="p">)</span>
                <span class="n">pnl</span> <span class="o">=</span> <span class="n">revenue</span> <span class="o">-</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">entry_price</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">capital</span> <span class="o">+=</span> <span class="n">revenue</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">trades</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;SELL&#39;</span><span class="p">,</span> <span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="n">price</span><span class="p">,</span> <span class="s1">&#39;pnl&#39;</span><span class="p">:</span> <span class="n">pnl</span><span class="p">,</span> <span class="s1">&#39;i&#39;</span><span class="p">:</span> <span class="n">i</span><span class="p">})</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="n">equity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">capital</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">*</span> <span class="n">price</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">equity_curve</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">equity</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_metrics</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">calculate_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">equity</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">equity_curve</span><span class="p">)</span>
        <span class="n">returns</span> <span class="o">=</span> <span class="n">equity</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

        <span class="n">total_return</span> <span class="o">=</span> <span class="p">(</span><span class="n">equity</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_capital</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_capital</span> <span class="o">*</span> <span class="mi">100</span>
        <span class="n">max_dd</span> <span class="o">=</span> <span class="p">((</span><span class="n">equity</span><span class="o">.</span><span class="n">cummax</span><span class="p">()</span> <span class="o">-</span> <span class="n">equity</span><span class="p">)</span> <span class="o">/</span> <span class="n">equity</span><span class="o">.</span><span class="n">cummax</span><span class="p">())</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">*</span> <span class="mi">100</span>
        <span class="n">sharpe</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">/</span> <span class="n">returns</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">365</span><span class="p">)</span> <span class="k">if</span> <span class="n">returns</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>

        <span class="n">wins</span> <span class="o">=</span> <span class="nb">len</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trades</span> <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pnl&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">])</span>
        <span class="n">total</span> <span class="o">=</span> <span class="nb">len</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trades</span> <span class="k">if</span> <span class="s1">&#39;pnl&#39;</span> <span class="ow">in</span> <span class="n">t</span><span class="p">])</span>
        <span class="n">win_rate</span> <span class="o">=</span> <span class="n">wins</span> <span class="o">/</span> <span class="n">total</span> <span class="o">*</span> <span class="mi">100</span> <span class="k">if</span> <span class="n">total</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;total_return&#39;</span><span class="p">:</span> <span class="n">total_return</span><span class="p">,</span>
            <span class="s1">&#39;max_drawdown&#39;</span><span class="p">:</span> <span class="n">max_dd</span><span class="p">,</span>
            <span class="s1">&#39;sharpe_ratio&#39;</span><span class="p">:</span> <span class="n">sharpe</span><span class="p">,</span>
            <span class="s1">&#39;num_trades&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trades</span><span class="p">),</span>
            <span class="s1">&#39;win_rate&#39;</span><span class="p">:</span> <span class="n">win_rate</span>
        <span class="p">}</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>Section 3: Performance Metrics</h1></div>
<div class="code-cell" id="cell-6-4" data-source="ZGVmIGNhbGN1bGF0ZV9wZXJmb3JtYW5jZV9tZXRyaWNzKGVxdWl0eV9jdXJ2ZSwgcmlza19mcmVlX3JhdGU9MC4wMik6CiAgICAiIiJDYWxjdWxhdGUgY29tcHJlaGVuc2l2ZSBwZXJmb3JtYW5jZSBtZXRyaWNzLiIiIgogICAgZXF1aXR5ID0gcGQuU2VyaWVzKGVxdWl0eV9jdXJ2ZSkKICAgIHJldHVybnMgPSBlcXVpdHkucGN0X2NoYW5nZSgpLmRyb3BuYSgpCiAgICAKICAgICMgVG90YWwgUmV0dXJuCiAgICB0b3RhbF9yZXR1cm4gPSAoZXF1aXR5Lmlsb2NbLTFdIC8gZXF1aXR5Lmlsb2NbMF0gLSAxKSAqIDEwMAogICAgCiAgICAjIFNoYXJwZSBSYXRpbyAoYW5udWFsaXplZCkKICAgIGV4Y2Vzc19yZXR1cm5zID0gcmV0dXJucyAtIHJpc2tfZnJlZV9yYXRlLzM2NQogICAgc2hhcnBlID0gZXhjZXNzX3JldHVybnMubWVhbigpIC8gcmV0dXJucy5zdGQoKSAqIG5wLnNxcnQoMzY1KSBpZiByZXR1cm5zLnN0ZCgpID4gMCBlbHNlIDAKICAgIAogICAgIyBTb3J0aW5vIFJhdGlvIChkb3duc2lkZSByaXNrIG9ubHkpCiAgICBkb3duc2lkZSA9IHJldHVybnNbcmV0dXJucyA8IDBdCiAgICBzb3J0aW5vID0gcmV0dXJucy5tZWFuKCkgLyBkb3duc2lkZS5zdGQoKSAqIG5wLnNxcnQoMzY1KSBpZiBsZW4oZG93bnNpZGUpID4gMCBlbHNlIDAKICAgIAogICAgIyBNYXhpbXVtIERyYXdkb3duCiAgICByb2xsaW5nX21heCA9IGVxdWl0eS5jdW1tYXgoKQogICAgZHJhd2Rvd24gPSAoZXF1aXR5IC0gcm9sbGluZ19tYXgpIC8gcm9sbGluZ19tYXgKICAgIG1heF9kZCA9IGRyYXdkb3duLm1pbigpICogMTAwCiAgICAKICAgICMgQ2FsbWFyIFJhdGlvCiAgICBjYWxtYXIgPSB0b3RhbF9yZXR1cm4gLyBhYnMobWF4X2RkKSBpZiBtYXhfZGQgIT0gMCBlbHNlIDAKICAgIAogICAgcmV0dXJuIHsKICAgICAgICAndG90YWxfcmV0dXJuJzogdG90YWxfcmV0dXJuLAogICAgICAgICdzaGFycGVfcmF0aW8nOiBzaGFycGUsCiAgICAgICAgJ3NvcnRpbm9fcmF0aW8nOiBzb3J0aW5vLAogICAgICAgICdtYXhfZHJhd2Rvd24nOiBtYXhfZGQsCiAgICAgICAgJ2NhbG1hcl9yYXRpbyc6IGNhbG1hcgogICAgfQ=="><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-6-4')" type="button">Run</button></div><pre><code><span class="k">def</span> <span class="nf">calculate_performance_metrics</span><span class="p">(</span><span class="n">equity_curve</span><span class="p">,</span> <span class="n">risk_free_rate</span><span class="o">=</span><span class="mf">0.02</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Calculate comprehensive performance metrics.&quot;&quot;&quot;</span>
    <span class="n">equity</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">equity_curve</span><span class="p">)</span>
    <span class="n">returns</span> <span class="o">=</span> <span class="n">equity</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
    
    <span class="c1"># Total Return</span>
    <span class="n">total_return</span> <span class="o">=</span> <span class="p">(</span><span class="n">equity</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">equity</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
    
    <span class="c1"># Sharpe Ratio (annualized)</span>
    <span class="n">excess_returns</span> <span class="o">=</span> <span class="n">returns</span> <span class="o">-</span> <span class="n">risk_free_rate</span><span class="o">/</span><span class="mi">365</span>
    <span class="n">sharpe</span> <span class="o">=</span> <span class="n">excess_returns</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">/</span> <span class="n">returns</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">365</span><span class="p">)</span> <span class="k">if</span> <span class="n">returns</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
    
    <span class="c1"># Sortino Ratio (downside risk only)</span>
    <span class="n">downside</span> <span class="o">=</span> <span class="n">returns</span><span class="p">[</span><span class="n">returns</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">sortino</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">/</span> <span class="n">downside</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">365</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">downside</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
    
    <span class="c1"># Maximum Drawdown</span>
    <span class="n">rolling_max</span> <span class="o">=</span> <span class="n">equity</span><span class="o">.</span><span class="n">cummax</span><span class="p">()</span>
    <span class="n">drawdown</span> <span class="o">=</span> <span class="p">(</span><span class="n">equity</span> <span class="o">-</span> <span class="n">rolling_max</span><span class="p">)</span> <span class="o">/</span> <span class="n">rolling_max</span>
    <span class="n">max_dd</span> <span class="o">=</span> <span class="n">drawdown</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">*</span> <span class="mi">100</span>
    
    <span class="c1"># Calmar Ratio</span>
    <span class="n">calmar</span> <span class="o">=</span> <span class="n">total_return</span> <span class="o">/</span> <span class="nb">abs</span><span class="p">(</span><span class="n">max_dd</span><span class="p">)</span> <span class="k">if</span> <span class="n">max_dd</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
    
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;total_return&#39;</span><span class="p">:</span> <span class="n">total_return</span><span class="p">,</span>
        <span class="s1">&#39;sharpe_ratio&#39;</span><span class="p">:</span> <span class="n">sharpe</span><span class="p">,</span>
        <span class="s1">&#39;sortino_ratio&#39;</span><span class="p">:</span> <span class="n">sortino</span><span class="p">,</span>
        <span class="s1">&#39;max_drawdown&#39;</span><span class="p">:</span> <span class="n">max_dd</span><span class="p">,</span>
        <span class="s1">&#39;calmar_ratio&#39;</span><span class="p">:</span> <span class="n">calmar</span>
    <span class="p">}</span>
</code></pre><div class="code-output" id="output-cell-6-4"></div></div>
<div class="md-cell"><h3>âœï¸ Exercise 6.3: Performance Report</h3>
<p>Create a formatted performance report generator.</p></div>
<div class="code-cell" id="cell-6-5" data-source="IyBFeGVyY2lzZSA2LjMKZGVmIGdlbmVyYXRlX3BlcmZvcm1hbmNlX3JlcG9ydChtZXRyaWNzLCB0cmFkZXMpOgogICAgIiIiR2VuZXJhdGUgZm9ybWF0dGVkIHBlcmZvcm1hbmNlIHJlcG9ydC4iIiIKICAgICMgVE9ETwogICAgcGFzcw=="><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-6-5')" type="button">Run</button></div><pre><code><span class="c1"># Exercise 6.3</span>
<span class="k">def</span> <span class="nf">generate_performance_report</span><span class="p">(</span><span class="n">metrics</span><span class="p">,</span> <span class="n">trades</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Generate formatted performance report.&quot;&quot;&quot;</span>
    <span class="c1"># TODO</span>
    <span class="k">pass</span>
</code></pre><div class="code-output" id="output-cell-6-5"></div></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">generate_performance_report</span><span class="p">(</span><span class="n">metrics</span><span class="p">,</span> <span class="n">trades</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=&#39;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;           BACKTEST PERFORMANCE REPORT&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=&#39;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">RETURNS&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Total Return: </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;total_return&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Max Drawdown: </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;max_drawdown&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">RISK-ADJUSTED&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Sharpe Ratio: </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;sharpe_ratio&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Sortino Ratio: </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;sortino_ratio&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Calmar Ratio: </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;calmar_ratio&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">TRADING&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Total Trades: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">trades</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">trades</span><span class="p">:</span>
        <span class="n">pnls</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pnl&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">trades</span> <span class="k">if</span> <span class="s1">&#39;pnl&#39;</span> <span class="ow">in</span> <span class="n">t</span><span class="p">]</span>
        <span class="n">wins</span> <span class="o">=</span> <span class="nb">len</span><span class="p">([</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pnls</span> <span class="k">if</span> <span class="n">p</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">])</span>
        <span class="n">win_rate</span> <span class="o">=</span> <span class="n">wins</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">pnls</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span> <span class="k">if</span> <span class="n">pnls</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="n">avg_win</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pnls</span> <span class="k">if</span> <span class="n">p</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">p</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pnls</span><span class="p">)</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="n">avg_loss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pnls</span> <span class="k">if</span> <span class="n">p</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">p</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pnls</span><span class="p">)</span> <span class="k">else</span> <span class="mi">0</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Win Rate: </span><span class="si">{</span><span class="n">win_rate</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Avg Win: $</span><span class="si">{</span><span class="n">avg_win</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Avg Loss: $</span><span class="si">{</span><span class="n">avg_loss</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=&#39;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>Section 4: Walk-Forward Optimization</h1></div>
<div class="code-cell" id="cell-6-6" data-source="ZGVmIHdhbGtfZm9yd2FyZF90ZXN0KHByaWNlcywgc3RyYXRlZ3lfZnVuYywgdHJhaW5fc2l6ZT0xMDAsIHRlc3Rfc2l6ZT0zMCk6CiAgICAiIiIKICAgIFdhbGstZm9yd2FyZCBvcHRpbWl6YXRpb24uCiAgICAKICAgIFRyYWluIG9uICd0cmFpbl9zaXplJyBwZXJpb2RzLCB0ZXN0IG9uIG5leHQgJ3Rlc3Rfc2l6ZScgcGVyaW9kcy4KICAgICIiIgogICAgcmVzdWx0cyA9IFtdCiAgICAKICAgIGkgPSAwCiAgICB3aGlsZSBpICsgdHJhaW5fc2l6ZSArIHRlc3Rfc2l6ZSA8PSBsZW4ocHJpY2VzKToKICAgICAgICAjIFRyYWluaW5nIHBlcmlvZAogICAgICAgIHRyYWluX2RhdGEgPSBwcmljZXNbaTppK3RyYWluX3NpemVdCiAgICAgICAgIyBUZXN0aW5nIHBlcmlvZAogICAgICAgIHRlc3RfZGF0YSA9IHByaWNlc1tpK3RyYWluX3NpemU6aSt0cmFpbl9zaXplK3Rlc3Rfc2l6ZV0KICAgICAgICAKICAgICAgICAjIE9wdGltaXplIG9uIHRyYWluaW5nIGRhdGEgKHNpbXBsaWZpZWQpCiAgICAgICAgYmVzdF9wYXJhbXMgPSBzdHJhdGVneV9mdW5jLm9wdGltaXplKHRyYWluX2RhdGEpCiAgICAgICAgCiAgICAgICAgIyBUZXN0IHdpdGggb3B0aW1pemVkIHBhcmFtcwogICAgICAgIHRlc3RfcmV0dXJuID0gc3RyYXRlZ3lfZnVuYy5iYWNrdGVzdCh0ZXN0X2RhdGEsIGJlc3RfcGFyYW1zKQogICAgICAgIAogICAgICAgIHJlc3VsdHMuYXBwZW5kKHsKICAgICAgICAgICAgJ3BlcmlvZCc6IGksCiAgICAgICAgICAgICd0cmFpbl9lbmQnOiBpICsgdHJhaW5fc2l6ZSwKICAgICAgICAgICAgJ3Rlc3RfcmV0dXJuJzogdGVzdF9yZXR1cm4sCiAgICAgICAgICAgICdwYXJhbXMnOiBiZXN0X3BhcmFtcwogICAgICAgIH0pCiAgICAgICAgCiAgICAgICAgaSArPSB0ZXN0X3NpemUgICMgTW92ZSBmb3J3YXJkCiAgICAKICAgIHJldHVybiByZXN1bHRz"><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-6-6')" type="button">Run</button></div><pre><code><span class="k">def</span> <span class="nf">walk_forward_test</span><span class="p">(</span><span class="n">prices</span><span class="p">,</span> <span class="n">strategy_func</span><span class="p">,</span> <span class="n">train_size</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mi">30</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Walk-forward optimization.</span>
<span class="sd">    </span>
<span class="sd">    Train on &#39;train_size&#39; periods, test on next &#39;test_size&#39; periods.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">+</span> <span class="n">train_size</span> <span class="o">+</span> <span class="n">test_size</span> <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">prices</span><span class="p">):</span>
        <span class="c1"># Training period</span>
        <span class="n">train_data</span> <span class="o">=</span> <span class="n">prices</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">train_size</span><span class="p">]</span>
        <span class="c1"># Testing period</span>
        <span class="n">test_data</span> <span class="o">=</span> <span class="n">prices</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="n">train_size</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">train_size</span><span class="o">+</span><span class="n">test_size</span><span class="p">]</span>
        
        <span class="c1"># Optimize on training data (simplified)</span>
        <span class="n">best_params</span> <span class="o">=</span> <span class="n">strategy_func</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span><span class="n">train_data</span><span class="p">)</span>
        
        <span class="c1"># Test with optimized params</span>
        <span class="n">test_return</span> <span class="o">=</span> <span class="n">strategy_func</span><span class="o">.</span><span class="n">backtest</span><span class="p">(</span><span class="n">test_data</span><span class="p">,</span> <span class="n">best_params</span><span class="p">)</span>
        
        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;period&#39;</span><span class="p">:</span> <span class="n">i</span><span class="p">,</span>
            <span class="s1">&#39;train_end&#39;</span><span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="n">train_size</span><span class="p">,</span>
            <span class="s1">&#39;test_return&#39;</span><span class="p">:</span> <span class="n">test_return</span><span class="p">,</span>
            <span class="s1">&#39;params&#39;</span><span class="p">:</span> <span class="n">best_params</span>
        <span class="p">})</span>
        
        <span class="n">i</span> <span class="o">+=</span> <span class="n">test_size</span>  <span class="c1"># Move forward</span>
    
    <span class="k">return</span> <span class="n">results</span>
</code></pre><div class="code-output" id="output-cell-6-6"></div></div>
<div class="md-cell"><h3>âœï¸ Exercise 6.4: Walk-Forward Backtester</h3>
<p>Implement a complete walk-forward testing system.</p></div>
<div class="code-cell" id="cell-6-7" data-source="IyBFeGVyY2lzZSA2LjQKY2xhc3MgV2Fsa0ZvcndhcmRCYWNrdGVzdGVyOgogICAgZGVmIF9faW5pdF9fKHNlbGYsIHRyYWluX3BjdD0wLjcpOgogICAgICAgIHNlbGYudHJhaW5fcGN0ID0gdHJhaW5fcGN0CiAgICAKICAgIGRlZiBzcGxpdF9kYXRhKHNlbGYsIHByaWNlcyk6CiAgICAgICAgIyBUT0RPCiAgICAgICAgcGFzcwogICAgCiAgICBkZWYgcnVuX3dhbGtfZm9yd2FyZChzZWxmLCBwcmljZXMsIHBhcmFtX3Jhbmdlcyk6CiAgICAgICAgIyBUT0RPCiAgICAgICAgcGFzcw=="><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-6-7')" type="button">Run</button></div><pre><code><span class="c1"># Exercise 6.4</span>
<span class="k">class</span> <span class="nc">WalkForwardBacktester</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">train_pct</span><span class="o">=</span><span class="mf">0.7</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_pct</span> <span class="o">=</span> <span class="n">train_pct</span>
    
    <span class="k">def</span> <span class="nf">split_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prices</span><span class="p">):</span>
        <span class="c1"># TODO</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">run_walk_forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prices</span><span class="p">,</span> <span class="n">param_ranges</span><span class="p">):</span>
        <span class="c1"># TODO</span>
        <span class="k">pass</span>
</code></pre><div class="code-output" id="output-cell-6-7"></div></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">WalkForwardBacktester</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">train_pct</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">n_splits</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_pct</span> <span class="o">=</span> <span class="n">train_pct</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_splits</span> <span class="o">=</span> <span class="n">n_splits</span>

    <span class="k">def</span> <span class="nf">split_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prices</span><span class="p">):</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span>
        <span class="n">split_size</span> <span class="o">=</span> <span class="n">n</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_splits</span>

        <span class="n">splits</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_splits</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">train_end</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">split_size</span>
            <span class="n">test_end</span> <span class="o">=</span> <span class="nb">min</span><span class="p">((</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">split_size</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>

            <span class="n">train</span> <span class="o">=</span> <span class="n">prices</span><span class="p">[:</span><span class="n">train_end</span><span class="p">]</span>
            <span class="n">test</span> <span class="o">=</span> <span class="n">prices</span><span class="p">[</span><span class="n">train_end</span><span class="p">:</span><span class="n">test_end</span><span class="p">]</span>
            <span class="n">splits</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">train</span><span class="p">,</span> <span class="n">test</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">splits</span>

    <span class="k">def</span> <span class="nf">run_walk_forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prices</span><span class="p">,</span> <span class="n">strategy</span><span class="p">,</span> <span class="n">param_grid</span><span class="p">):</span>
        <span class="n">splits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_data</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">train</span><span class="p">,</span> <span class="n">test</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">splits</span><span class="p">):</span>
            <span class="c1"># Find best params on training data</span>
            <span class="n">best_return</span> <span class="o">=</span> <span class="o">-</span><span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
            <span class="n">best_params</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">for</span> <span class="n">params</span> <span class="ow">in</span> <span class="n">param_grid</span><span class="p">:</span>
                <span class="n">ret</span> <span class="o">=</span> <span class="n">strategy</span><span class="o">.</span><span class="n">backtest</span><span class="p">(</span><span class="n">train</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">ret</span> <span class="o">&gt;</span> <span class="n">best_return</span><span class="p">:</span>
                    <span class="n">best_return</span> <span class="o">=</span> <span class="n">ret</span>
                    <span class="n">best_params</span> <span class="o">=</span> <span class="n">params</span>

            <span class="c1"># Test with best params</span>
            <span class="n">test_return</span> <span class="o">=</span> <span class="n">strategy</span><span class="o">.</span><span class="n">backtest</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">best_params</span><span class="p">)</span>

            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;split&#39;</span><span class="p">:</span> <span class="n">i</span><span class="p">,</span>
                <span class="s1">&#39;train_return&#39;</span><span class="p">:</span> <span class="n">best_return</span><span class="p">,</span>
                <span class="s1">&#39;test_return&#39;</span><span class="p">:</span> <span class="n">test_return</span><span class="p">,</span>
                <span class="s1">&#39;params&#39;</span><span class="p">:</span> <span class="n">best_params</span>
            <span class="p">})</span>

        <span class="k">return</span> <span class="n">results</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>ğŸ—ï¸ Module Project: Complete Backtesting Framework</h1>
<p>Build a full backtesting system with all components.</p></div>
<div class="code-cell" id="cell-6-8" data-source="IyBNb2R1bGUgUHJvamVjdApjbGFzcyBCYWNrdGVzdGluZ0ZyYW1ld29yazoKICAgIGRlZiBfX2luaXRfXyhzZWxmKToKICAgICAgICBzZWxmLmJhY2t0ZXN0ZXIgPSBOb25lCiAgICAgICAgc2VsZi5yZXN1bHRzID0gTm9uZQogICAgCiAgICBkZWYgYmFja3Rlc3Rfc3RyYXRlZ3koc2VsZiwgcHJpY2VzLCBzdHJhdGVneSk6CiAgICAgICAgIyBUT0RPCiAgICAgICAgcGFzcwogICAgCiAgICBkZWYgb3B0aW1pemUoc2VsZiwgcHJpY2VzLCBzdHJhdGVneSwgcGFyYW1fZ3JpZCk6CiAgICAgICAgIyBUT0RPCiAgICAgICAgcGFzcwogICAgCiAgICBkZWYgZnVsbF9yZXBvcnQoc2VsZik6CiAgICAgICAgIyBUT0RPCiAgICAgICAgcGFzcw=="><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-6-8')" type="button">Run</button></div><pre><code><span class="c1"># Module Project</span>
<span class="k">class</span> <span class="nc">BacktestingFramework</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">backtester</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="kc">None</span>
    
    <span class="k">def</span> <span class="nf">backtest_strategy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prices</span><span class="p">,</span> <span class="n">strategy</span><span class="p">):</span>
        <span class="c1"># TODO</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">optimize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prices</span><span class="p">,</span> <span class="n">strategy</span><span class="p">,</span> <span class="n">param_grid</span><span class="p">):</span>
        <span class="c1"># TODO</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">full_report</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># TODO</span>
        <span class="k">pass</span>
</code></pre><div class="code-output" id="output-cell-6-8"></div></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">BacktestingFramework</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">initial_capital</span><span class="o">=</span><span class="mi">10000</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">backtester</span> <span class="o">=</span> <span class="n">CryptoBacktester</span><span class="p">(</span><span class="n">initial_capital</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">equity_curve</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">backtest_strategy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prices</span><span class="p">,</span> <span class="n">strategy</span><span class="p">):</span>
        <span class="n">signals</span> <span class="o">=</span> <span class="p">[</span><span class="n">strategy</span><span class="o">.</span><span class="n">generate_signal</span><span class="p">(</span><span class="n">prices</span><span class="p">[:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;signal&#39;</span><span class="p">,</span> <span class="s1">&#39;HOLD&#39;</span><span class="p">)</span> 
                   <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">prices</span><span class="p">))]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">backtester</span><span class="o">.</span><span class="n">run_backtest</span><span class="p">(</span><span class="n">prices</span><span class="p">,</span> <span class="n">signals</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">equity_curve</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">backtester</span><span class="o">.</span><span class="n">equity_curve</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span>

    <span class="k">def</span> <span class="nf">optimize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prices</span><span class="p">,</span> <span class="n">strategy_class</span><span class="p">,</span> <span class="n">param_grid</span><span class="p">):</span>
        <span class="n">best_result</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">best_params</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">for</span> <span class="n">params</span> <span class="ow">in</span> <span class="n">param_grid</span><span class="p">:</span>
            <span class="n">strategy</span> <span class="o">=</span> <span class="n">strategy_class</span><span class="p">(</span><span class="o">**</span><span class="n">params</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">backtest_strategy</span><span class="p">(</span><span class="n">prices</span><span class="p">,</span> <span class="n">strategy</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">best_result</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;sharpe_ratio&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">best_result</span><span class="p">[</span><span class="s1">&#39;sharpe_ratio&#39;</span><span class="p">]:</span>
                <span class="n">best_result</span> <span class="o">=</span> <span class="n">result</span>
                <span class="n">best_params</span> <span class="o">=</span> <span class="n">params</span>

        <span class="k">return</span> <span class="n">best_params</span><span class="p">,</span> <span class="n">best_result</span>

    <span class="k">def</span> <span class="nf">full_report</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No backtest results available&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">metrics</span> <span class="o">=</span> <span class="n">calculate_performance_metrics</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">equity_curve</span><span class="p">)</span>
        <span class="n">generate_performance_report</span><span class="p">(</span><span class="n">metrics</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">backtester</span><span class="o">.</span><span class="n">trades</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>ğŸ“ Key Takeaways</h1>
<ol>
<li><strong>Avoid Biases</strong>: Lookahead, survivorship, overfitting</li>
<li><strong>Include Costs</strong>: Fees + slippage significantly impact results</li>
<li><strong>Key Metrics</strong>: Sharpe, Sortino, Max Drawdown, Win Rate</li>
<li><strong>Walk-Forward</strong>: Prevents overfitting to historical data</li>
</ol>
<hr />
<p><em>Next: Module 7 - Risk Management</em></p></div>
        <div class="nav-buttons">
            <button class="nav-btn prev-btn disabled" type="button">
                <span class="nav-btn-label">â† Previous</span>
                <span class="nav-btn-name"></span>
            </button>
            <button class="nav-btn next-btn disabled" type="button">
                <span class="nav-btn-label">Next â†’</span>
                <span class="nav-btn-name"></span>
            </button>
        </div>
        </div>
<div class="module-section" data-idx="7"><div class="md-cell module-header"><h1>Module 7: Risk Management</h1>
<h2>Part 2: Strategy Development</h2>
<hr />
<div class="table-wrapper"><table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>â±ï¸ <strong>Duration</strong></td>
<td>~2.5 hours</td>
</tr>
<tr>
<td>ğŸ“‹ <strong>Prerequisites</strong></td>
<td>Module 6</td>
</tr>
<tr>
<td>ğŸ’ª <strong>Exercises</strong></td>
<td>5 total</td>
</tr>
</tbody>
</table></div></div>
<div class="md-cell"><h2>ğŸ¯ Learning Objectives</h2>
<ul>
<li>Implement position sizing methods</li>
<li>Build stop loss systems</li>
<li>Manage portfolio-level risk</li>
<li>Handle exchange-specific risks</li>
</ul></div>
<div class="md-cell"><hr />
<h1>Section 1: Position Sizing</h1>
<h2>1.1 Fixed Amount</h2></div>
<div class="code-cell" id="cell-7-0" data-source="ZGVmIGZpeGVkX2Ftb3VudF9zaXplKGNhcGl0YWwsIGZpeGVkX3VzZD0xMDAwKToKICAgICIiIlRyYWRlIGEgZml4ZWQgVVNEIGFtb3VudC4iIiIKICAgIHJldHVybiBtaW4oZml4ZWRfdXNkLCBjYXBpdGFsICogMC45NSkKCnByaW50KGYnUG9zaXRpb246ICR7Zml4ZWRfYW1vdW50X3NpemUoMTAwMDApOi4yZn0nKQ=="><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-7-0')" type="button">Run</button></div><pre><code><span class="k">def</span> <span class="nf">fixed_amount_size</span><span class="p">(</span><span class="n">capital</span><span class="p">,</span> <span class="n">fixed_usd</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Trade a fixed USD amount.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">fixed_usd</span><span class="p">,</span> <span class="n">capital</span> <span class="o">*</span> <span class="mf">0.95</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Position: $</span><span class="si">{</span><span class="n">fixed_amount_size</span><span class="p">(</span><span class="mi">10000</span><span class="p">)</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</code></pre><div class="code-output" id="output-cell-7-0"></div></div>
<div class="md-cell"><h2>1.2 Percent of Portfolio</h2></div>
<div class="code-cell" id="cell-7-1" data-source="ZGVmIHBlcmNlbnRfc2l6ZShjYXBpdGFsLCBwZXJjZW50PTAuMSk6CiAgICAiIiJUcmFkZSBhIHBlcmNlbnRhZ2Ugb2YgcG9ydGZvbGlvLiIiIgogICAgcmV0dXJuIGNhcGl0YWwgKiBwZXJjZW50CgpwcmludChmJzEwJSBvZiAkMTAsMDAwOiAke3BlcmNlbnRfc2l6ZSgxMDAwMCwgMC4xKTouMmZ9Jyk="><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-7-1')" type="button">Run</button></div><pre><code><span class="k">def</span> <span class="nf">percent_size</span><span class="p">(</span><span class="n">capital</span><span class="p">,</span> <span class="n">percent</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Trade a percentage of portfolio.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">capital</span> <span class="o">*</span> <span class="n">percent</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;10% of $10,000: $</span><span class="si">{</span><span class="n">percent_size</span><span class="p">(</span><span class="mi">10000</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</code></pre><div class="code-output" id="output-cell-7-1"></div></div>
<div class="md-cell"><h2>1.3 Volatility-Adjusted (ATR-based)</h2></div>
<div class="code-cell" id="cell-7-2" data-source="aW1wb3J0IHBhbmRhcyBhcyBwZAppbXBvcnQgbnVtcHkgYXMgbnAKCmRlZiBhdHIoaGlnaCwgbG93LCBjbG9zZSwgcGVyaW9kPTE0KToKICAgICIiIkNhbGN1bGF0ZSBBdmVyYWdlIFRydWUgUmFuZ2UuIiIiCiAgICBoaWdoLCBsb3csIGNsb3NlID0gcGQuU2VyaWVzKGhpZ2gpLCBwZC5TZXJpZXMobG93KSwgcGQuU2VyaWVzKGNsb3NlKQogICAgdHIxID0gaGlnaCAtIGxvdwogICAgdHIyID0gYWJzKGhpZ2ggLSBjbG9zZS5zaGlmdCgpKQogICAgdHIzID0gYWJzKGxvdyAtIGNsb3NlLnNoaWZ0KCkpCiAgICB0ciA9IHBkLmNvbmNhdChbdHIxLCB0cjIsIHRyM10sIGF4aXM9MSkubWF4KGF4aXM9MSkKICAgIHJldHVybiB0ci5yb2xsaW5nKHBlcmlvZCkubWVhbigpCgpkZWYgdm9sYXRpbGl0eV9hZGp1c3RlZF9zaXplKGNhcGl0YWwsIHByaWNlLCBhdHJfdmFsdWUsIHJpc2tfcGN0PTAuMDIpOgogICAgIiIiU2l6ZSBwb3NpdGlvbiBiYXNlZCBvbiB2b2xhdGlsaXR5LiIiIgogICAgcmlza19hbW91bnQgPSBjYXBpdGFsICogcmlza19wY3QKICAgIHBvc2l0aW9uX3NpemUgPSByaXNrX2Ftb3VudCAvIGF0cl92YWx1ZQogICAgcG9zaXRpb25fdmFsdWUgPSBwb3NpdGlvbl9zaXplICogcHJpY2UKICAgIHJldHVybiBtaW4ocG9zaXRpb25fdmFsdWUsIGNhcGl0YWwgKiAwLjI1KSAgIyBNYXggMjUlIGluIG9uZSBwb3NpdGlvbgoKIyBFeGFtcGxlCmNhcGl0YWwgPSAxMDAwMApwcmljZSA9IDQzMDAwCmF0cl92YWwgPSAxNTAwICAjICQxNTAwIEFUUgpzaXplID0gdm9sYXRpbGl0eV9hZGp1c3RlZF9zaXplKGNhcGl0YWwsIHByaWNlLCBhdHJfdmFsKQpwcmludChmJ1Bvc2l0aW9uIHNpemU6ICR7c2l6ZTouMmZ9Jyk="><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-7-2')" type="button">Run</button></div><pre><code><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="k">def</span> <span class="nf">atr</span><span class="p">(</span><span class="n">high</span><span class="p">,</span> <span class="n">low</span><span class="p">,</span> <span class="n">close</span><span class="p">,</span> <span class="n">period</span><span class="o">=</span><span class="mi">14</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Calculate Average True Range.&quot;&quot;&quot;</span>
    <span class="n">high</span><span class="p">,</span> <span class="n">low</span><span class="p">,</span> <span class="n">close</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">high</span><span class="p">),</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">low</span><span class="p">),</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">close</span><span class="p">)</span>
    <span class="n">tr1</span> <span class="o">=</span> <span class="n">high</span> <span class="o">-</span> <span class="n">low</span>
    <span class="n">tr2</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">high</span> <span class="o">-</span> <span class="n">close</span><span class="o">.</span><span class="n">shift</span><span class="p">())</span>
    <span class="n">tr3</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">low</span> <span class="o">-</span> <span class="n">close</span><span class="o">.</span><span class="n">shift</span><span class="p">())</span>
    <span class="n">tr</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">tr1</span><span class="p">,</span> <span class="n">tr2</span><span class="p">,</span> <span class="n">tr3</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">tr</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">period</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">volatility_adjusted_size</span><span class="p">(</span><span class="n">capital</span><span class="p">,</span> <span class="n">price</span><span class="p">,</span> <span class="n">atr_value</span><span class="p">,</span> <span class="n">risk_pct</span><span class="o">=</span><span class="mf">0.02</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Size position based on volatility.&quot;&quot;&quot;</span>
    <span class="n">risk_amount</span> <span class="o">=</span> <span class="n">capital</span> <span class="o">*</span> <span class="n">risk_pct</span>
    <span class="n">position_size</span> <span class="o">=</span> <span class="n">risk_amount</span> <span class="o">/</span> <span class="n">atr_value</span>
    <span class="n">position_value</span> <span class="o">=</span> <span class="n">position_size</span> <span class="o">*</span> <span class="n">price</span>
    <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">position_value</span><span class="p">,</span> <span class="n">capital</span> <span class="o">*</span> <span class="mf">0.25</span><span class="p">)</span>  <span class="c1"># Max 25% in one position</span>

<span class="c1"># Example</span>
<span class="n">capital</span> <span class="o">=</span> <span class="mi">10000</span>
<span class="n">price</span> <span class="o">=</span> <span class="mi">43000</span>
<span class="n">atr_val</span> <span class="o">=</span> <span class="mi">1500</span>  <span class="c1"># $1500 ATR</span>
<span class="n">size</span> <span class="o">=</span> <span class="n">volatility_adjusted_size</span><span class="p">(</span><span class="n">capital</span><span class="p">,</span> <span class="n">price</span><span class="p">,</span> <span class="n">atr_val</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Position size: $</span><span class="si">{</span><span class="n">size</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</code></pre><div class="code-output" id="output-cell-7-2"></div></div>
<div class="md-cell"><h2>1.4 Kelly Criterion</h2></div>
<div class="code-cell" id="cell-7-3" data-source="ZGVmIGtlbGx5X2NyaXRlcmlvbih3aW5fcmF0ZSwgYXZnX3dpbiwgYXZnX2xvc3MsIGtlbGx5X2ZyYWN0aW9uPTAuNSk6CiAgICAiIiJDYWxjdWxhdGUgS2VsbHkgb3B0aW1hbCBwb3NpdGlvbiBzaXplLiIiIgogICAgaWYgYXZnX2xvc3MgPT0gMDoKICAgICAgICByZXR1cm4gMAogICAgCiAgICBiID0gYXZnX3dpbiAvIGFicyhhdmdfbG9zcykgICMgV2luL2xvc3MgcmF0aW8KICAgIHAgPSB3aW5fcmF0ZQogICAgcSA9IDEgLSB3aW5fcmF0ZQogICAgCiAgICBrZWxseSA9IChiICogcCAtIHEpIC8gYgogICAgCiAgICAjIFVzZSBmcmFjdGlvbmFsIEtlbGx5IChzYWZlcikKICAgIHJldHVybiBtYXgoMCwga2VsbHkgKiBrZWxseV9mcmFjdGlvbikKCiMgRXhhbXBsZTogNTUlIHdpbiByYXRlLCBhdmcgd2luICQyMDAsIGF2ZyBsb3NzICQxNTAKa2VsbHkgPSBrZWxseV9jcml0ZXJpb24oMC41NSwgMjAwLCAxNTApCnByaW50KGYnS2VsbHkgc3VnZ2VzdHM6IHtrZWxseSoxMDA6LjFmfSUgb2YgY2FwaXRhbCcp"><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-7-3')" type="button">Run</button></div><pre><code><span class="k">def</span> <span class="nf">kelly_criterion</span><span class="p">(</span><span class="n">win_rate</span><span class="p">,</span> <span class="n">avg_win</span><span class="p">,</span> <span class="n">avg_loss</span><span class="p">,</span> <span class="n">kelly_fraction</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Calculate Kelly optimal position size.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">avg_loss</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>
    
    <span class="n">b</span> <span class="o">=</span> <span class="n">avg_win</span> <span class="o">/</span> <span class="nb">abs</span><span class="p">(</span><span class="n">avg_loss</span><span class="p">)</span>  <span class="c1"># Win/loss ratio</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">win_rate</span>
    <span class="n">q</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">win_rate</span>
    
    <span class="n">kelly</span> <span class="o">=</span> <span class="p">(</span><span class="n">b</span> <span class="o">*</span> <span class="n">p</span> <span class="o">-</span> <span class="n">q</span><span class="p">)</span> <span class="o">/</span> <span class="n">b</span>
    
    <span class="c1"># Use fractional Kelly (safer)</span>
    <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">kelly</span> <span class="o">*</span> <span class="n">kelly_fraction</span><span class="p">)</span>

<span class="c1"># Example: 55% win rate, avg win $200, avg loss $150</span>
<span class="n">kelly</span> <span class="o">=</span> <span class="n">kelly_criterion</span><span class="p">(</span><span class="mf">0.55</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">150</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Kelly suggests: </span><span class="si">{</span><span class="n">kelly</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">% of capital&#39;</span><span class="p">)</span>
</code></pre><div class="code-output" id="output-cell-7-3"></div></div>
<div class="md-cell"><h3>âœï¸ Exercise 7.1: Position Sizer</h3>
<p>Create a comprehensive position sizing class.</p></div>
<div class="code-cell" id="cell-7-4" data-source="IyBFeGVyY2lzZSA3LjEKY2xhc3MgUG9zaXRpb25TaXplcjoKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBjYXBpdGFsLCBtYXhfcmlza19wY3Q9MC4wMik6CiAgICAgICAgc2VsZi5jYXBpdGFsID0gY2FwaXRhbAogICAgICAgIHNlbGYubWF4X3Jpc2tfcGN0ID0gbWF4X3Jpc2tfcGN0CiAgICAKICAgIGRlZiBmaXhlZChzZWxmLCBhbW91bnQpOgogICAgICAgICMgVE9ETwogICAgICAgIHBhc3MKICAgIAogICAgZGVmIHBlcmNlbnQoc2VsZiwgcGN0KToKICAgICAgICAjIFRPRE8KICAgICAgICBwYXNzCiAgICAKICAgIGRlZiB2b2xhdGlsaXR5X2FkanVzdGVkKHNlbGYsIHByaWNlLCBhdHIpOgogICAgICAgICMgVE9ETwogICAgICAgIHBhc3MKICAgIAogICAgZGVmIHJlY29tbWVuZChzZWxmLCBwcmljZSwgYXRyLCB3aW5fcmF0ZT1Ob25lLCBhdmdfd2luPU5vbmUsIGF2Z19sb3NzPU5vbmUpOgogICAgICAgICMgVE9ETzogUmV0dXJuIHJlY29tbWVuZGVkIHNpemUgd2l0aCByZWFzb25pbmcKICAgICAgICBwYXNz"><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-7-4')" type="button">Run</button></div><pre><code><span class="c1"># Exercise 7.1</span>
<span class="k">class</span> <span class="nc">PositionSizer</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">capital</span><span class="p">,</span> <span class="n">max_risk_pct</span><span class="o">=</span><span class="mf">0.02</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">capital</span> <span class="o">=</span> <span class="n">capital</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_risk_pct</span> <span class="o">=</span> <span class="n">max_risk_pct</span>
    
    <span class="k">def</span> <span class="nf">fixed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
        <span class="c1"># TODO</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">percent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pct</span><span class="p">):</span>
        <span class="c1"># TODO</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">volatility_adjusted</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">price</span><span class="p">,</span> <span class="n">atr</span><span class="p">):</span>
        <span class="c1"># TODO</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">recommend</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">price</span><span class="p">,</span> <span class="n">atr</span><span class="p">,</span> <span class="n">win_rate</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">avg_win</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">avg_loss</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># TODO: Return recommended size with reasoning</span>
        <span class="k">pass</span>
</code></pre><div class="code-output" id="output-cell-7-4"></div></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">PositionSizer</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">capital</span><span class="p">,</span> <span class="n">max_risk_pct</span><span class="o">=</span><span class="mf">0.02</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">capital</span> <span class="o">=</span> <span class="n">capital</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_risk_pct</span> <span class="o">=</span> <span class="n">max_risk_pct</span>

    <span class="k">def</span> <span class="nf">fixed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">amount</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">capital</span> <span class="o">*</span> <span class="mf">0.95</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">percent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pct</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">capital</span> <span class="o">*</span> <span class="n">pct</span>

    <span class="k">def</span> <span class="nf">volatility_adjusted</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">price</span><span class="p">,</span> <span class="n">atr_val</span><span class="p">):</span>
        <span class="n">risk_amount</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">capital</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_risk_pct</span>
        <span class="n">size</span> <span class="o">=</span> <span class="n">risk_amount</span> <span class="o">/</span> <span class="n">atr_val</span>
        <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">size</span> <span class="o">*</span> <span class="n">price</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">capital</span> <span class="o">*</span> <span class="mf">0.25</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">recommend</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">price</span><span class="p">,</span> <span class="n">atr_val</span><span class="p">,</span> <span class="n">win_rate</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">avg_win</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">avg_loss</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">sizes</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;fixed_1k&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">fixed</span><span class="p">(</span><span class="mi">1000</span><span class="p">),</span>
            <span class="s1">&#39;percent_10&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">percent</span><span class="p">(</span><span class="mf">0.10</span><span class="p">),</span>
            <span class="s1">&#39;volatility&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">volatility_adjusted</span><span class="p">(</span><span class="n">price</span><span class="p">,</span> <span class="n">atr_val</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="nb">all</span><span class="p">([</span><span class="n">win_rate</span><span class="p">,</span> <span class="n">avg_win</span><span class="p">,</span> <span class="n">avg_loss</span><span class="p">]):</span>
            <span class="n">kelly</span> <span class="o">=</span> <span class="n">kelly_criterion</span><span class="p">(</span><span class="n">win_rate</span><span class="p">,</span> <span class="n">avg_win</span><span class="p">,</span> <span class="n">avg_loss</span><span class="p">)</span>
            <span class="n">sizes</span><span class="p">[</span><span class="s1">&#39;kelly&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">capital</span> <span class="o">*</span> <span class="n">kelly</span>

        <span class="c1"># Recommend most conservative</span>
        <span class="n">recommended</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">sizes</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;recommended&#39;</span><span class="p">:</span> <span class="n">recommended</span><span class="p">,</span>
            <span class="s1">&#39;all_methods&#39;</span><span class="p">:</span> <span class="n">sizes</span><span class="p">,</span>
            <span class="s1">&#39;max_position&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">capital</span> <span class="o">*</span> <span class="mf">0.25</span>
        <span class="p">}</span>

<span class="n">sizer</span> <span class="o">=</span> <span class="n">PositionSizer</span><span class="p">(</span><span class="mi">10000</span><span class="p">)</span>
<span class="n">rec</span> <span class="o">=</span> <span class="n">sizer</span><span class="o">.</span><span class="n">recommend</span><span class="p">(</span><span class="mi">43000</span><span class="p">,</span> <span class="mi">1500</span><span class="p">,</span> <span class="mf">0.55</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">150</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Recommended: $</span><span class="si">{</span><span class="n">rec</span><span class="p">[</span><span class="s1">&#39;recommended&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>Section 2: Stop Losses</h1></div>
<div class="code-cell" id="cell-7-5" data-source="Y2xhc3MgU3RvcExvc3NNYW5hZ2VyOgogICAgZGVmIF9faW5pdF9fKHNlbGYpOgogICAgICAgIHNlbGYuc3RvcHMgPSB7fQogICAgCiAgICBkZWYgZml4ZWRfcGVyY2VudChzZWxmLCBlbnRyeV9wcmljZSwgcGVyY2VudD0wLjA1KToKICAgICAgICAiIiJGaXhlZCBwZXJjZW50YWdlIHN0b3AuIiIiCiAgICAgICAgcmV0dXJuIGVudHJ5X3ByaWNlICogKDEgLSBwZXJjZW50KQogICAgCiAgICBkZWYgYXRyX2Jhc2VkKHNlbGYsIGVudHJ5X3ByaWNlLCBhdHJfdmFsdWUsIG11bHRpcGxpZXI9Mik6CiAgICAgICAgIiIiQVRSLWJhc2VkIHN0b3AuIiIiCiAgICAgICAgcmV0dXJuIGVudHJ5X3ByaWNlIC0gKGF0cl92YWx1ZSAqIG11bHRpcGxpZXIpCiAgICAKICAgIGRlZiB0cmFpbGluZ19zdG9wKHNlbGYsIGN1cnJlbnRfcHJpY2UsIGhpZ2hlc3RfcHJpY2UsIHRyYWlsX3BjdD0wLjA1KToKICAgICAgICAiIiJUcmFpbGluZyBzdG9wIHRoYXQgZm9sbG93cyBwcmljZSB1cC4iIiIKICAgICAgICByZXR1cm4gaGlnaGVzdF9wcmljZSAqICgxIC0gdHJhaWxfcGN0KQogICAgCiAgICBkZWYgY2hlY2tfc3RvcChzZWxmLCBjdXJyZW50X3ByaWNlLCBzdG9wX3ByaWNlKToKICAgICAgICAiIiJDaGVjayBpZiBzdG9wIGlzIHRyaWdnZXJlZC4iIiIKICAgICAgICByZXR1cm4gY3VycmVudF9wcmljZSA8PSBzdG9wX3ByaWNlCgpzdG9wX21nciA9IFN0b3BMb3NzTWFuYWdlcigpCmVudHJ5ID0gNDMwMDAKcHJpbnQoZic1JSBTdG9wOiAke3N0b3BfbWdyLmZpeGVkX3BlcmNlbnQoZW50cnksIDAuMDUpOiwuMGZ9JykKcHJpbnQoZidBVFIgU3RvcDogJHtzdG9wX21nci5hdHJfYmFzZWQoZW50cnksIDE1MDAsIDIpOiwuMGZ9Jyk="><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-7-5')" type="button">Run</button></div><pre><code><span class="k">class</span> <span class="nc">StopLossManager</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stops</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="k">def</span> <span class="nf">fixed_percent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entry_price</span><span class="p">,</span> <span class="n">percent</span><span class="o">=</span><span class="mf">0.05</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Fixed percentage stop.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">entry_price</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">percent</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">atr_based</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entry_price</span><span class="p">,</span> <span class="n">atr_value</span><span class="p">,</span> <span class="n">multiplier</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;ATR-based stop.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">entry_price</span> <span class="o">-</span> <span class="p">(</span><span class="n">atr_value</span> <span class="o">*</span> <span class="n">multiplier</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">trailing_stop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current_price</span><span class="p">,</span> <span class="n">highest_price</span><span class="p">,</span> <span class="n">trail_pct</span><span class="o">=</span><span class="mf">0.05</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Trailing stop that follows price up.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">highest_price</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">trail_pct</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">check_stop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current_price</span><span class="p">,</span> <span class="n">stop_price</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check if stop is triggered.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">current_price</span> <span class="o">&lt;=</span> <span class="n">stop_price</span>

<span class="n">stop_mgr</span> <span class="o">=</span> <span class="n">StopLossManager</span><span class="p">()</span>
<span class="n">entry</span> <span class="o">=</span> <span class="mi">43000</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;5% Stop: $</span><span class="si">{</span><span class="n">stop_mgr</span><span class="o">.</span><span class="n">fixed_percent</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">)</span><span class="si">:</span><span class="s1">,.0f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;ATR Stop: $</span><span class="si">{</span><span class="n">stop_mgr</span><span class="o">.</span><span class="n">atr_based</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="mi">1500</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="si">:</span><span class="s1">,.0f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</code></pre><div class="code-output" id="output-cell-7-5"></div></div>
<div class="md-cell"><h3>âœï¸ Exercise 7.2: Stop Loss System</h3>
<p>Build a comprehensive stop loss system with multiple stop types.</p></div>
<div class="code-cell" id="cell-7-6" data-source="IyBFeGVyY2lzZSA3LjIKY2xhc3MgU3RvcExvc3NTeXN0ZW06CiAgICBkZWYgX19pbml0X18oc2VsZik6CiAgICAgICAgc2VsZi5wb3NpdGlvbnMgPSB7fQogICAgCiAgICBkZWYgYWRkX3Bvc2l0aW9uKHNlbGYsIHN5bWJvbCwgZW50cnlfcHJpY2UsIHN0b3BfdHlwZSwgKiprd2FyZ3MpOgogICAgICAgICMgVE9ETwogICAgICAgIHBhc3MKICAgIAogICAgZGVmIHVwZGF0ZV90cmFpbGluZ19zdG9wcyhzZWxmLCBzeW1ib2wsIGN1cnJlbnRfcHJpY2UpOgogICAgICAgICMgVE9ETwogICAgICAgIHBhc3MKICAgIAogICAgZGVmIGNoZWNrX2FsbF9zdG9wcyhzZWxmLCBwcmljZXMpOgogICAgICAgICMgVE9ETzogUmV0dXJuIGxpc3Qgb2YgdHJpZ2dlcmVkIHN0b3BzCiAgICAgICAgcGFzcw=="><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-7-6')" type="button">Run</button></div><pre><code><span class="c1"># Exercise 7.2</span>
<span class="k">class</span> <span class="nc">StopLossSystem</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">positions</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="k">def</span> <span class="nf">add_position</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">entry_price</span><span class="p">,</span> <span class="n">stop_type</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># TODO</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">update_trailing_stops</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">current_price</span><span class="p">):</span>
        <span class="c1"># TODO</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">check_all_stops</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prices</span><span class="p">):</span>
        <span class="c1"># TODO: Return list of triggered stops</span>
        <span class="k">pass</span>
</code></pre><div class="code-output" id="output-cell-7-6"></div></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">StopLossSystem</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">positions</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">add_position</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">entry_price</span><span class="p">,</span> <span class="n">stop_type</span><span class="o">=</span><span class="s1">&#39;percent&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">stop_type</span> <span class="o">==</span> <span class="s1">&#39;percent&#39;</span><span class="p">:</span>
            <span class="n">stop</span> <span class="o">=</span> <span class="n">entry_price</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pct&#39;</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">stop_type</span> <span class="o">==</span> <span class="s1">&#39;atr&#39;</span><span class="p">:</span>
            <span class="n">stop</span> <span class="o">=</span> <span class="n">entry_price</span> <span class="o">-</span> <span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;atr&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;mult&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">stop_type</span> <span class="o">==</span> <span class="s1">&#39;trailing&#39;</span><span class="p">:</span>
            <span class="n">stop</span> <span class="o">=</span> <span class="n">entry_price</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;trail_pct&#39;</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">stop</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;price&#39;</span><span class="p">,</span> <span class="n">entry_price</span> <span class="o">*</span> <span class="mf">0.95</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;entry&#39;</span><span class="p">:</span> <span class="n">entry_price</span><span class="p">,</span>
            <span class="s1">&#39;stop&#39;</span><span class="p">:</span> <span class="n">stop</span><span class="p">,</span>
            <span class="s1">&#39;highest&#39;</span><span class="p">:</span> <span class="n">entry_price</span><span class="p">,</span>
            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="n">stop_type</span><span class="p">,</span>
            <span class="s1">&#39;params&#39;</span><span class="p">:</span> <span class="n">kwargs</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">update_trailing_stops</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">current_price</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">symbol</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">pos</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;trailing&#39;</span> <span class="ow">and</span> <span class="n">current_price</span> <span class="o">&gt;</span> <span class="n">pos</span><span class="p">[</span><span class="s1">&#39;highest&#39;</span><span class="p">]:</span>
            <span class="n">pos</span><span class="p">[</span><span class="s1">&#39;highest&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_price</span>
            <span class="n">trail_pct</span> <span class="o">=</span> <span class="n">pos</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;trail_pct&#39;</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">)</span>
            <span class="n">pos</span><span class="p">[</span><span class="s1">&#39;stop&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_price</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">trail_pct</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">check_all_stops</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prices</span><span class="p">):</span>
        <span class="n">triggered</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">pos</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="n">prices</span><span class="p">:</span>
                <span class="n">current</span> <span class="o">=</span> <span class="n">prices</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">update_trailing_stops</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">current</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">current</span> <span class="o">&lt;=</span> <span class="n">pos</span><span class="p">[</span><span class="s1">&#39;stop&#39;</span><span class="p">]:</span>
                    <span class="n">triggered</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                        <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span>
                        <span class="s1">&#39;entry&#39;</span><span class="p">:</span> <span class="n">pos</span><span class="p">[</span><span class="s1">&#39;entry&#39;</span><span class="p">],</span>
                        <span class="s1">&#39;stop&#39;</span><span class="p">:</span> <span class="n">pos</span><span class="p">[</span><span class="s1">&#39;stop&#39;</span><span class="p">],</span>
                        <span class="s1">&#39;current&#39;</span><span class="p">:</span> <span class="n">current</span>
                    <span class="p">})</span>
        <span class="k">return</span> <span class="n">triggered</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>Section 3: Portfolio Risk</h1></div>
<div class="code-cell" id="cell-7-7" data-source="ZGVmIGNoZWNrX3BvcnRmb2xpb19yaXNrKHBvc2l0aW9ucywgY29ycmVsYXRpb25zLCBtYXhfY29ycmVsYXRlZF9leHBvc3VyZT0wLjQpOgogICAgIiIiCiAgICBDaGVjayBwb3J0Zm9saW8gcmlzayBmcm9tIGNvcnJlbGF0ZWQgcG9zaXRpb25zLgogICAgCiAgICBwb3NpdGlvbnM6IGRpY3Qgb2Yge3N5bWJvbDogcG9zaXRpb25fdmFsdWV9CiAgICBjb3JyZWxhdGlvbnM6IGRpY3Qgb2YgeyhzeW0xLCBzeW0yKTogY29ycmVsYXRpb259CiAgICAiIiIKICAgIHRvdGFsX3ZhbHVlID0gc3VtKHBvc2l0aW9ucy52YWx1ZXMoKSkKICAgIHdhcm5pbmdzID0gW10KICAgIAogICAgZm9yIChzMSwgczIpLCBjb3JyIGluIGNvcnJlbGF0aW9ucy5pdGVtcygpOgogICAgICAgIGlmIGNvcnIgPiAwLjc6ICAjIEhpZ2hseSBjb3JyZWxhdGVkCiAgICAgICAgICAgIGlmIHMxIGluIHBvc2l0aW9ucyBhbmQgczIgaW4gcG9zaXRpb25zOgogICAgICAgICAgICAgICAgY29tYmluZWQgPSAocG9zaXRpb25zW3MxXSArIHBvc2l0aW9uc1tzMl0pIC8gdG90YWxfdmFsdWUKICAgICAgICAgICAgICAgIGlmIGNvbWJpbmVkID4gbWF4X2NvcnJlbGF0ZWRfZXhwb3N1cmU6CiAgICAgICAgICAgICAgICAgICAgd2FybmluZ3MuYXBwZW5kKGYne3MxfS97czJ9IGNvbWJpbmVkIGV4cG9zdXJlIHtjb21iaW5lZDouMSV9IGV4Y2VlZHMgbGltaXQnKQogICAgCiAgICByZXR1cm4gd2FybmluZ3MKCiMgRXhhbXBsZQpwb3NpdGlvbnMgPSB7J0JUQyc6IDMwMDAsICdFVEgnOiAyMDAwLCAnU09MJzogMTUwMH0KY29ycmVsYXRpb25zID0geygnQlRDJywgJ0VUSCcpOiAwLjg1LCAoJ0JUQycsICdTT0wnKTogMC43NX0KcHJpbnQoY2hlY2tfcG9ydGZvbGlvX3Jpc2socG9zaXRpb25zLCBjb3JyZWxhdGlvbnMpKQ=="><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-7-7')" type="button">Run</button></div><pre><code><span class="k">def</span> <span class="nf">check_portfolio_risk</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="n">correlations</span><span class="p">,</span> <span class="n">max_correlated_exposure</span><span class="o">=</span><span class="mf">0.4</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check portfolio risk from correlated positions.</span>
<span class="sd">    </span>
<span class="sd">    positions: dict of {symbol: position_value}</span>
<span class="sd">    correlations: dict of {(sym1, sym2): correlation}</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">total_value</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">positions</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
    <span class="n">warnings</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">for</span> <span class="p">(</span><span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">),</span> <span class="n">corr</span> <span class="ow">in</span> <span class="n">correlations</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">corr</span> <span class="o">&gt;</span> <span class="mf">0.7</span><span class="p">:</span>  <span class="c1"># Highly correlated</span>
            <span class="k">if</span> <span class="n">s1</span> <span class="ow">in</span> <span class="n">positions</span> <span class="ow">and</span> <span class="n">s2</span> <span class="ow">in</span> <span class="n">positions</span><span class="p">:</span>
                <span class="n">combined</span> <span class="o">=</span> <span class="p">(</span><span class="n">positions</span><span class="p">[</span><span class="n">s1</span><span class="p">]</span> <span class="o">+</span> <span class="n">positions</span><span class="p">[</span><span class="n">s2</span><span class="p">])</span> <span class="o">/</span> <span class="n">total_value</span>
                <span class="k">if</span> <span class="n">combined</span> <span class="o">&gt;</span> <span class="n">max_correlated_exposure</span><span class="p">:</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">s1</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">s2</span><span class="si">}</span><span class="s1"> combined exposure </span><span class="si">{</span><span class="n">combined</span><span class="si">:</span><span class="s1">.1%</span><span class="si">}</span><span class="s1"> exceeds limit&#39;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">warnings</span>

<span class="c1"># Example</span>
<span class="n">positions</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;BTC&#39;</span><span class="p">:</span> <span class="mi">3000</span><span class="p">,</span> <span class="s1">&#39;ETH&#39;</span><span class="p">:</span> <span class="mi">2000</span><span class="p">,</span> <span class="s1">&#39;SOL&#39;</span><span class="p">:</span> <span class="mi">1500</span><span class="p">}</span>
<span class="n">correlations</span> <span class="o">=</span> <span class="p">{(</span><span class="s1">&#39;BTC&#39;</span><span class="p">,</span> <span class="s1">&#39;ETH&#39;</span><span class="p">):</span> <span class="mf">0.85</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;BTC&#39;</span><span class="p">,</span> <span class="s1">&#39;SOL&#39;</span><span class="p">):</span> <span class="mf">0.75</span><span class="p">}</span>
<span class="nb">print</span><span class="p">(</span><span class="n">check_portfolio_risk</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="n">correlations</span><span class="p">))</span>
</code></pre><div class="code-output" id="output-cell-7-7"></div></div>
<div class="md-cell"><h3>âœï¸ Exercise 7.3: Portfolio Risk Checker</h3>
<p>Build a comprehensive portfolio risk monitoring system.</p></div>
<div class="code-cell" id="cell-7-8" data-source="IyBFeGVyY2lzZSA3LjMKY2xhc3MgUG9ydGZvbGlvUmlza0NoZWNrZXI6CiAgICBkZWYgX19pbml0X18oc2VsZiwgbWF4X3NpbmdsZV9wb3NpdGlvbj0wLjI1LCBtYXhfZHJhd2Rvd249MC4yMCk6CiAgICAgICAgc2VsZi5tYXhfc2luZ2xlID0gbWF4X3NpbmdsZV9wb3NpdGlvbgogICAgICAgIHNlbGYubWF4X2RkID0gbWF4X2RyYXdkb3duCiAgICAKICAgIGRlZiBjaGVja19jb25jZW50cmF0aW9uKHNlbGYsIHBvc2l0aW9ucyk6CiAgICAgICAgIyBUT0RPCiAgICAgICAgcGFzcwogICAgCiAgICBkZWYgY2hlY2tfZHJhd2Rvd24oc2VsZiwgZXF1aXR5X2N1cnZlKToKICAgICAgICAjIFRPRE8KICAgICAgICBwYXNzCiAgICAKICAgIGRlZiBmdWxsX2NoZWNrKHNlbGYsIHBvc2l0aW9ucywgZXF1aXR5X2N1cnZlKToKICAgICAgICAjIFRPRE86IFJldHVybiBhbGwgcmlzayB3YXJuaW5ncwogICAgICAgIHBhc3M="><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-7-8')" type="button">Run</button></div><pre><code><span class="c1"># Exercise 7.3</span>
<span class="k">class</span> <span class="nc">PortfolioRiskChecker</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_single_position</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">max_drawdown</span><span class="o">=</span><span class="mf">0.20</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_single</span> <span class="o">=</span> <span class="n">max_single_position</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_dd</span> <span class="o">=</span> <span class="n">max_drawdown</span>
    
    <span class="k">def</span> <span class="nf">check_concentration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">positions</span><span class="p">):</span>
        <span class="c1"># TODO</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">check_drawdown</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">equity_curve</span><span class="p">):</span>
        <span class="c1"># TODO</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">full_check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">positions</span><span class="p">,</span> <span class="n">equity_curve</span><span class="p">):</span>
        <span class="c1"># TODO: Return all risk warnings</span>
        <span class="k">pass</span>
</code></pre><div class="code-output" id="output-cell-7-8"></div></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">PortfolioRiskChecker</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_single_position</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">max_drawdown</span><span class="o">=</span><span class="mf">0.20</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_single</span> <span class="o">=</span> <span class="n">max_single_position</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_dd</span> <span class="o">=</span> <span class="n">max_drawdown</span>

    <span class="k">def</span> <span class="nf">check_concentration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">positions</span><span class="p">):</span>
        <span class="n">total</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">positions</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="n">warnings</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">positions</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">pct</span> <span class="o">=</span> <span class="n">value</span> <span class="o">/</span> <span class="n">total</span>
            <span class="k">if</span> <span class="n">pct</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_single</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">symbol</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">pct</span><span class="si">:</span><span class="s1">.1%</span><span class="si">}</span><span class="s1"> exceeds </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">max_single</span><span class="si">:</span><span class="s1">.1%</span><span class="si">}</span><span class="s1"> limit&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">warnings</span>

    <span class="k">def</span> <span class="nf">check_drawdown</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">equity_curve</span><span class="p">):</span>
        <span class="n">equity</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">equity_curve</span><span class="p">)</span>
        <span class="n">peak</span> <span class="o">=</span> <span class="n">equity</span><span class="o">.</span><span class="n">cummax</span><span class="p">()</span>
        <span class="n">dd</span> <span class="o">=</span> <span class="p">(</span><span class="n">equity</span> <span class="o">-</span> <span class="n">peak</span><span class="p">)</span> <span class="o">/</span> <span class="n">peak</span>
        <span class="n">current_dd</span> <span class="o">=</span> <span class="n">dd</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">max_dd</span> <span class="o">=</span> <span class="n">dd</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>

        <span class="n">warnings</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">current_dd</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_dd</span> <span class="o">*</span> <span class="mf">0.8</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Current DD </span><span class="si">{</span><span class="n">current_dd</span><span class="si">:</span><span class="s1">.1%</span><span class="si">}</span><span class="s1"> approaching limit&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">max_dd</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_dd</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Max DD </span><span class="si">{</span><span class="n">max_dd</span><span class="si">:</span><span class="s1">.1%</span><span class="si">}</span><span class="s1"> exceeded limit&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">warnings</span><span class="p">,</span> <span class="n">current_dd</span><span class="p">,</span> <span class="n">max_dd</span>

    <span class="k">def</span> <span class="nf">full_check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">positions</span><span class="p">,</span> <span class="n">equity_curve</span><span class="p">):</span>
        <span class="n">concentration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_concentration</span><span class="p">(</span><span class="n">positions</span><span class="p">)</span>
        <span class="n">dd_warnings</span><span class="p">,</span> <span class="n">current_dd</span><span class="p">,</span> <span class="n">max_dd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_drawdown</span><span class="p">(</span><span class="n">equity_curve</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;concentration_warnings&#39;</span><span class="p">:</span> <span class="n">concentration</span><span class="p">,</span>
            <span class="s1">&#39;drawdown_warnings&#39;</span><span class="p">:</span> <span class="n">dd_warnings</span><span class="p">,</span>
            <span class="s1">&#39;current_drawdown&#39;</span><span class="p">:</span> <span class="n">current_dd</span><span class="p">,</span>
            <span class="s1">&#39;max_drawdown&#39;</span><span class="p">:</span> <span class="n">max_dd</span><span class="p">,</span>
            <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;OK&#39;</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">concentration</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">dd_warnings</span> <span class="k">else</span> <span class="s1">&#39;WARNING&#39;</span>
        <span class="p">}</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>Section 4: Exchange Risk Management</h1></div>
<div class="code-cell" id="cell-7-9" data-source="Y2xhc3MgRXhjaGFuZ2VSaXNrTWFuYWdlcjoKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBtYXhfcGVyX2V4Y2hhbmdlPTAuMyk6CiAgICAgICAgc2VsZi5tYXhfcGVyX2V4Y2hhbmdlID0gbWF4X3Blcl9leGNoYW5nZQogICAgICAgIHNlbGYuYmFsYW5jZXMgPSB7fQogICAgCiAgICBkZWYgdXBkYXRlX2JhbGFuY2Uoc2VsZiwgZXhjaGFuZ2UsIGJhbGFuY2UpOgogICAgICAgIHNlbGYuYmFsYW5jZXNbZXhjaGFuZ2VdID0gYmFsYW5jZQogICAgCiAgICBkZWYgY2hlY2tfbGltaXRzKHNlbGYsIHRvdGFsX2NhcGl0YWwpOgogICAgICAgIHdhcm5pbmdzID0gW10KICAgICAgICBmb3IgZXhjaGFuZ2UsIGJhbGFuY2UgaW4gc2VsZi5iYWxhbmNlcy5pdGVtcygpOgogICAgICAgICAgICBwY3QgPSBiYWxhbmNlIC8gdG90YWxfY2FwaXRhbAogICAgICAgICAgICBpZiBwY3QgPiBzZWxmLm1heF9wZXJfZXhjaGFuZ2U6CiAgICAgICAgICAgICAgICB3YXJuaW5ncy5hcHBlbmQoZid7ZXhjaGFuZ2V9OiB7cGN0Oi4xJX0gZXhjZWVkcyB7c2VsZi5tYXhfcGVyX2V4Y2hhbmdlOi4xJX0nKQogICAgICAgIHJldHVybiB3YXJuaW5ncwogICAgCiAgICBkZWYgc3VnZ2VzdF9yZWJhbGFuY2Uoc2VsZiwgdG90YWxfY2FwaXRhbCk6CiAgICAgICAgdGFyZ2V0X3Blcl9leGNoYW5nZSA9IHRvdGFsX2NhcGl0YWwgKiBzZWxmLm1heF9wZXJfZXhjaGFuZ2UKICAgICAgICBzdWdnZXN0aW9ucyA9IFtdCiAgICAgICAgCiAgICAgICAgZm9yIGV4Y2hhbmdlLCBiYWxhbmNlIGluIHNlbGYuYmFsYW5jZXMuaXRlbXMoKToKICAgICAgICAgICAgaWYgYmFsYW5jZSA+IHRhcmdldF9wZXJfZXhjaGFuZ2U6CiAgICAgICAgICAgICAgICB3aXRoZHJhdyA9IGJhbGFuY2UgLSB0YXJnZXRfcGVyX2V4Y2hhbmdlCiAgICAgICAgICAgICAgICBzdWdnZXN0aW9ucy5hcHBlbmQoZidXaXRoZHJhdyAke3dpdGhkcmF3OiwuMGZ9IGZyb20ge2V4Y2hhbmdlfScpCiAgICAgICAgCiAgICAgICAgcmV0dXJuIHN1Z2dlc3Rpb25z"><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-7-9')" type="button">Run</button></div><pre><code><span class="k">class</span> <span class="nc">ExchangeRiskManager</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_per_exchange</span><span class="o">=</span><span class="mf">0.3</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_per_exchange</span> <span class="o">=</span> <span class="n">max_per_exchange</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">balances</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="k">def</span> <span class="nf">update_balance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exchange</span><span class="p">,</span> <span class="n">balance</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">balances</span><span class="p">[</span><span class="n">exchange</span><span class="p">]</span> <span class="o">=</span> <span class="n">balance</span>
    
    <span class="k">def</span> <span class="nf">check_limits</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">total_capital</span><span class="p">):</span>
        <span class="n">warnings</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">exchange</span><span class="p">,</span> <span class="n">balance</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">balances</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">pct</span> <span class="o">=</span> <span class="n">balance</span> <span class="o">/</span> <span class="n">total_capital</span>
            <span class="k">if</span> <span class="n">pct</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_per_exchange</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">exchange</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">pct</span><span class="si">:</span><span class="s1">.1%</span><span class="si">}</span><span class="s1"> exceeds </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">max_per_exchange</span><span class="si">:</span><span class="s1">.1%</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">warnings</span>
    
    <span class="k">def</span> <span class="nf">suggest_rebalance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">total_capital</span><span class="p">):</span>
        <span class="n">target_per_exchange</span> <span class="o">=</span> <span class="n">total_capital</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_per_exchange</span>
        <span class="n">suggestions</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">for</span> <span class="n">exchange</span><span class="p">,</span> <span class="n">balance</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">balances</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">balance</span> <span class="o">&gt;</span> <span class="n">target_per_exchange</span><span class="p">:</span>
                <span class="n">withdraw</span> <span class="o">=</span> <span class="n">balance</span> <span class="o">-</span> <span class="n">target_per_exchange</span>
                <span class="n">suggestions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Withdraw $</span><span class="si">{</span><span class="n">withdraw</span><span class="si">:</span><span class="s1">,.0f</span><span class="si">}</span><span class="s1"> from </span><span class="si">{</span><span class="n">exchange</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">suggestions</span>
</code></pre><div class="code-output" id="output-cell-7-9"></div></div>
<div class="md-cell"><h3>âœï¸ Exercise 7.4: Risk Protocol</h3>
<p>Create a complete risk management protocol.</p></div>
<div class="code-cell" id="cell-7-10" data-source="IyBFeGVyY2lzZSA3LjQKY2xhc3MgUmlza1Byb3RvY29sOgogICAgZGVmIF9faW5pdF9fKHNlbGYsIGNvbmZpZyk6CiAgICAgICAgc2VsZi5jb25maWcgPSBjb25maWcKICAgICAgICAjIFRPRE86IEluaXRpYWxpemUgYWxsIHJpc2sgbWFuYWdlcnMKICAgIAogICAgZGVmIHByZV90cmFkZV9jaGVjayhzZWxmLCBzeW1ib2wsIHNpemUsIHByaWNlKToKICAgICAgICAjIFRPRE86IENoZWNrIGlmIHRyYWRlIGlzIGFsbG93ZWQKICAgICAgICBwYXNzCiAgICAKICAgIGRlZiBkYWlseV9yaXNrX3JlcG9ydChzZWxmKToKICAgICAgICAjIFRPRE86IEdlbmVyYXRlIGRhaWx5IHJpc2sgcmVwb3J0CiAgICAgICAgcGFzcw=="><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-7-10')" type="button">Run</button></div><pre><code><span class="c1"># Exercise 7.4</span>
<span class="k">class</span> <span class="nc">RiskProtocol</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
        <span class="c1"># TODO: Initialize all risk managers</span>
    
    <span class="k">def</span> <span class="nf">pre_trade_check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">price</span><span class="p">):</span>
        <span class="c1"># TODO: Check if trade is allowed</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">daily_risk_report</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># TODO: Generate daily risk report</span>
        <span class="k">pass</span>
</code></pre><div class="code-output" id="output-cell-7-10"></div></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">RiskProtocol</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">position_sizer</span> <span class="o">=</span> <span class="n">PositionSizer</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;capital&#39;</span><span class="p">],</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;max_risk&#39;</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stop_system</span> <span class="o">=</span> <span class="n">StopLossSystem</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">portfolio_checker</span> <span class="o">=</span> <span class="n">PortfolioRiskChecker</span><span class="p">(</span>
            <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;max_single&#39;</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">),</span>
            <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;max_dd&#39;</span><span class="p">,</span> <span class="mf">0.20</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exchange_mgr</span> <span class="o">=</span> <span class="n">ExchangeRiskManager</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;max_per_exchange&#39;</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">positions</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">equity_curve</span> <span class="o">=</span> <span class="p">[</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;capital&#39;</span><span class="p">]]</span>

    <span class="k">def</span> <span class="nf">pre_trade_check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">price</span><span class="p">):</span>
        <span class="n">checks</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Size check</span>
        <span class="n">max_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">position_sizer</span><span class="o">.</span><span class="n">percent</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;max_single&#39;</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="n">max_size</span><span class="p">:</span>
            <span class="n">checks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;FAIL: Size $</span><span class="si">{</span><span class="n">size</span><span class="si">}</span><span class="s1"> exceeds max $</span><span class="si">{</span><span class="n">max_size</span><span class="si">:</span><span class="s1">.0f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">checks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;PASS: Size within limits&#39;</span><span class="p">)</span>

        <span class="c1"># Portfolio concentration</span>
        <span class="n">test_positions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">test_positions</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span> <span class="o">=</span> <span class="n">test_positions</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">size</span>
        <span class="n">conc_warnings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">portfolio_checker</span><span class="o">.</span><span class="n">check_concentration</span><span class="p">(</span><span class="n">test_positions</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">conc_warnings</span><span class="p">:</span>
            <span class="n">checks</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="sa">f</span><span class="s1">&#39;FAIL: </span><span class="si">{</span><span class="n">w</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">conc_warnings</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">checks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;PASS: Portfolio concentration OK&#39;</span><span class="p">)</span>

        <span class="n">allowed</span> <span class="o">=</span> <span class="nb">all</span><span class="p">(</span><span class="s1">&#39;FAIL&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">checks</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;allowed&#39;</span><span class="p">:</span> <span class="n">allowed</span><span class="p">,</span> <span class="s1">&#39;checks&#39;</span><span class="p">:</span> <span class="n">checks</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">daily_risk_report</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=&#39;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;           DAILY RISK REPORT&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=&#39;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>

        <span class="c1"># Portfolio status</span>
        <span class="n">report</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">portfolio_checker</span><span class="o">.</span><span class="n">full_check</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">equity_curve</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Status: </span><span class="si">{</span><span class="n">report</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Current DD: </span><span class="si">{</span><span class="n">report</span><span class="p">[</span><span class="s1">&#39;current_drawdown&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.1%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Max DD: </span><span class="si">{</span><span class="n">report</span><span class="p">[</span><span class="s1">&#39;max_drawdown&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.1%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Warnings</span>
        <span class="n">all_warnings</span> <span class="o">=</span> <span class="n">report</span><span class="p">[</span><span class="s1">&#39;concentration_warnings&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">report</span><span class="p">[</span><span class="s1">&#39;drawdown_warnings&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">all_warnings</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">WARNINGS:&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">all_warnings</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;  âš ï¸ </span><span class="si">{</span><span class="n">w</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=&#39;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>ğŸ—ï¸ Module Project: Risk Management Module</h1>
<p>Build a complete integrated risk management system.</p></div>
<div class="code-cell" id="cell-7-11" data-source="IyBNb2R1bGUgUHJvamVjdDogQ29tYmluZSBhbGwgY29tcG9uZW50cyBpbnRvIFJpc2tNYW5hZ2VtZW50TW9kdWxlCiMgWW91ciBzb2x1dGlvbiBzaG91bGQgaW50ZWdyYXRlIHBvc2l0aW9uIHNpemluZywgc3RvcCBsb3NzZXMsCiMgcG9ydGZvbGlvIHJpc2ssIGFuZCBleGNoYW5nZSByaXNrIGludG8gb25lIGNvaGVzaXZlIHN5c3RlbS4="><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-7-11')" type="button">Run</button></div><pre><code><span class="c1"># Module Project: Combine all components into RiskManagementModule</span>
<span class="c1"># Your solution should integrate position sizing, stop losses,</span>
<span class="c1"># portfolio risk, and exchange risk into one cohesive system.</span>
</code></pre><div class="code-output" id="output-cell-7-11"></div></div>
<div class="md-cell"><hr />
<h1>ğŸ“ Key Takeaways</h1>
<ol>
<li><strong>Position Sizing</strong>: Never risk more than 1-2% per trade</li>
<li><strong>Stop Losses</strong>: ATR-based stops adapt to volatility</li>
<li><strong>Portfolio Risk</strong>: Watch correlations and concentration</li>
<li><strong>Exchange Risk</strong>: Don't keep all funds on one exchange</li>
</ol>
<hr />
<p><em>Next: Module 8 - Automation Fundamentals</em></p></div>
        <div class="nav-buttons">
            <button class="nav-btn prev-btn disabled" type="button">
                <span class="nav-btn-label">â† Previous</span>
                <span class="nav-btn-name"></span>
            </button>
            <button class="nav-btn next-btn disabled" type="button">
                <span class="nav-btn-label">Next â†’</span>
                <span class="nav-btn-name"></span>
            </button>
        </div>
        </div>
<div class="module-section" data-idx="8"><div class="md-cell module-header"><h1>Module 8: Automation Fundamentals</h1>
<h2>Part 2: Strategy Development</h2>
<hr />
<div class="table-wrapper"><table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>â±ï¸ <strong>Duration</strong></td>
<td>~2.5 hours</td>
</tr>
<tr>
<td>ğŸ“‹ <strong>Prerequisites</strong></td>
<td>Module 7</td>
</tr>
<tr>
<td>ğŸ’ª <strong>Exercises</strong></td>
<td>5 total</td>
</tr>
</tbody>
</table></div></div>
<div class="md-cell"><h2>ğŸ¯ Learning Objectives</h2>
<ul>
<li>Schedule tasks for 24/7 operation</li>
<li>Build alert notification systems</li>
<li>Implement logging and monitoring</li>
<li>Create paper trading systems</li>
</ul></div>
<div class="md-cell"><hr />
<h1>Section 1: Scheduling for 24/7 Markets</h1>
<p>Crypto never sleeps - your bot needs to run continuously.</p></div>
<div class="code-cell" id="cell-8-0" data-source="aW1wb3J0IHRpbWUKZnJvbSBkYXRldGltZSBpbXBvcnQgZGF0ZXRpbWUKCiMgVXNpbmcgc2NoZWR1bGUgbGlicmFyeQojIHBpcCBpbnN0YWxsIHNjaGVkdWxlCgpjbGFzcyBUcmFkaW5nU2NoZWR1bGVyOgogICAgZGVmIF9faW5pdF9fKHNlbGYpOgogICAgICAgIHNlbGYudGFza3MgPSBbXQogICAgICAgIHNlbGYubGFzdF9oZWFydGJlYXQgPSBOb25lCiAgICAKICAgIGRlZiBoZWFydGJlYXQoc2VsZik6CiAgICAgICAgIiIiSGVhbHRoIGNoZWNrIC0gcnVucyBldmVyeSBtaW51dGUuIiIiCiAgICAgICAgc2VsZi5sYXN0X2hlYXJ0YmVhdCA9IGRhdGV0aW1lLm5vdygpCiAgICAgICAgcmV0dXJuIFRydWUKICAgIAogICAgZGVmIGNoZWNrX3NpZ25hbHMoc2VsZik6CiAgICAgICAgIiIiQ2hlY2sgdHJhZGluZyBzaWduYWxzLiIiIgogICAgICAgIHByaW50KGYnW3tkYXRldGltZS5ub3coKX1dIENoZWNraW5nIHNpZ25hbHMuLi4nKQogICAgICAgICMgWW91ciBzaWduYWwgbG9naWMgaGVyZQogICAgCiAgICBkZWYgaXNfaGVhbHRoeShzZWxmLCBtYXhfZ2FwX3NlY29uZHM9MTIwKToKICAgICAgICAiIiJDaGVjayBpZiBzY2hlZHVsZXIgaXMgcnVubmluZyBwcm9wZXJseS4iIiIKICAgICAgICBpZiBzZWxmLmxhc3RfaGVhcnRiZWF0IGlzIE5vbmU6CiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgIGdhcCA9IChkYXRldGltZS5ub3coKSAtIHNlbGYubGFzdF9oZWFydGJlYXQpLnRvdGFsX3NlY29uZHMoKQogICAgICAgIHJldHVybiBnYXAgPCBtYXhfZ2FwX3NlY29uZHMKCnNjaGVkdWxlciA9IFRyYWRpbmdTY2hlZHVsZXIoKQpzY2hlZHVsZXIuaGVhcnRiZWF0KCkKcHJpbnQoZidIZWFsdGh5OiB7c2NoZWR1bGVyLmlzX2hlYWx0aHkoKX0nKQ=="><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-8-0')" type="button">Run</button></div><pre><code><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>

<span class="c1"># Using schedule library</span>
<span class="c1"># pip install schedule</span>

<span class="k">class</span> <span class="nc">TradingScheduler</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_heartbeat</span> <span class="o">=</span> <span class="kc">None</span>
    
    <span class="k">def</span> <span class="nf">heartbeat</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Health check - runs every minute.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_heartbeat</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">True</span>
    
    <span class="k">def</span> <span class="nf">check_signals</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check trading signals.&quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;[</span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="si">}</span><span class="s1">] Checking signals...&#39;</span><span class="p">)</span>
        <span class="c1"># Your signal logic here</span>
    
    <span class="k">def</span> <span class="nf">is_healthy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_gap_seconds</span><span class="o">=</span><span class="mi">120</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check if scheduler is running properly.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_heartbeat</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="n">gap</span> <span class="o">=</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_heartbeat</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">gap</span> <span class="o">&lt;</span> <span class="n">max_gap_seconds</span>

<span class="n">scheduler</span> <span class="o">=</span> <span class="n">TradingScheduler</span><span class="p">()</span>
<span class="n">scheduler</span><span class="o">.</span><span class="n">heartbeat</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Healthy: </span><span class="si">{</span><span class="n">scheduler</span><span class="o">.</span><span class="n">is_healthy</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</code></pre><div class="code-output" id="output-cell-8-0"></div></div>
<div class="md-cell"><h3>âœï¸ Exercise 8.1: Robust Scheduler</h3>
<p>Build a scheduler with error recovery and restarts.</p></div>
<div class="code-cell" id="cell-8-1" data-source="IyBFeGVyY2lzZSA4LjEKY2xhc3MgUm9idXN0U2NoZWR1bGVyOgogICAgZGVmIF9faW5pdF9fKHNlbGYsIG1heF9yZXRyaWVzPTMpOgogICAgICAgIHNlbGYubWF4X3JldHJpZXMgPSBtYXhfcmV0cmllcwogICAgICAgIHNlbGYuZXJyb3JfY291bnQgPSAwCiAgICAKICAgIGRlZiBydW5fd2l0aF9yZXRyeShzZWxmLCBmdW5jKToKICAgICAgICAjIFRPRE86IFJ1biBmdW5jdGlvbiB3aXRoIHJldHJ5IGxvZ2ljCiAgICAgICAgcGFzcwogICAgCiAgICBkZWYgc2hvdWxkX3Jlc3RhcnQoc2VsZik6CiAgICAgICAgIyBUT0RPOiBEZXRlcm1pbmUgaWYgc2NoZWR1bGVyIG5lZWRzIHJlc3RhcnQKICAgICAgICBwYXNz"><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-8-1')" type="button">Run</button></div><pre><code><span class="c1"># Exercise 8.1</span>
<span class="k">class</span> <span class="nc">RobustScheduler</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_retries</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_retries</span> <span class="o">=</span> <span class="n">max_retries</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">error_count</span> <span class="o">=</span> <span class="mi">0</span>
    
    <span class="k">def</span> <span class="nf">run_with_retry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
        <span class="c1"># TODO: Run function with retry logic</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">should_restart</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># TODO: Determine if scheduler needs restart</span>
        <span class="k">pass</span>
</code></pre><div class="code-output" id="output-cell-8-1"></div></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">RobustScheduler</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_retries</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">cooldown</span><span class="o">=</span><span class="mi">60</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_retries</span> <span class="o">=</span> <span class="n">max_retries</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cooldown</span> <span class="o">=</span> <span class="n">cooldown</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">error_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_error</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">consecutive_failures</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">run_with_retry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">attempt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_retries</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">consecutive_failures</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="n">result</span><span class="p">}</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">error_count</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">consecutive_failures</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">last_error</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Attempt </span><span class="si">{</span><span class="n">attempt</span> <span class="o">+</span> <span class="mi">1</span><span class="si">}</span><span class="s1"> failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">attempt</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_retries</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="n">attempt</span><span class="p">)</span>  <span class="c1"># Exponential backoff</span>

        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_error</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">should_restart</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">consecutive_failures</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_retries</span>

    <span class="k">def</span> <span class="nf">get_status</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;total_errors&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_count</span><span class="p">,</span>
            <span class="s1">&#39;consecutive_failures&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">consecutive_failures</span><span class="p">,</span>
            <span class="s1">&#39;last_error&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_error</span><span class="p">,</span>
            <span class="s1">&#39;needs_restart&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">should_restart</span><span class="p">()</span>
        <span class="p">}</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>Section 2: Alert Systems</h1></div>
<div class="code-cell" id="cell-8-2" data-source="Y2xhc3MgQWxlcnRNYW5hZ2VyOgogICAgZGVmIF9faW5pdF9fKHNlbGYpOgogICAgICAgIHNlbGYuYWxlcnRzID0gW10KICAgICAgICBzZWxmLmNoYW5uZWxzID0gW10gICMgZW1haWwsIHRlbGVncmFtLCBldGMuCiAgICAKICAgIGRlZiBhZGRfYWxlcnQoc2VsZiwgYWxlcnRfdHlwZSwgbWVzc2FnZSwgcHJpb3JpdHk9J25vcm1hbCcpOgogICAgICAgIGFsZXJ0ID0gewogICAgICAgICAgICAndHlwZSc6IGFsZXJ0X3R5cGUsCiAgICAgICAgICAgICdtZXNzYWdlJzogbWVzc2FnZSwKICAgICAgICAgICAgJ3ByaW9yaXR5JzogcHJpb3JpdHksCiAgICAgICAgICAgICd0aW1lc3RhbXAnOiBkYXRldGltZS5ub3coKSwKICAgICAgICAgICAgJ3NlbnQnOiBGYWxzZQogICAgICAgIH0KICAgICAgICBzZWxmLmFsZXJ0cy5hcHBlbmQoYWxlcnQpCiAgICAgICAgCiAgICAgICAgaWYgcHJpb3JpdHkgPT0gJ2hpZ2gnOgogICAgICAgICAgICBzZWxmLnNlbmRfaW1tZWRpYXRlbHkoYWxlcnQpCiAgICAgICAgCiAgICAgICAgcmV0dXJuIGFsZXJ0CiAgICAKICAgIGRlZiBzZW5kX2ltbWVkaWF0ZWx5KHNlbGYsIGFsZXJ0KToKICAgICAgICBwcmludChmJ/CfmqggSElHSCBQUklPUklUWToge2FsZXJ0WyJtZXNzYWdlIl19JykKICAgICAgICBhbGVydFsnc2VudCddID0gVHJ1ZQogICAgCiAgICBkZWYgcHJpY2VfYWxlcnQoc2VsZiwgc3ltYm9sLCBjdXJyZW50LCB0YXJnZXQsIGRpcmVjdGlvbik6CiAgICAgICAgaWYgZGlyZWN0aW9uID09ICdhYm92ZScgYW5kIGN1cnJlbnQgPj0gdGFyZ2V0OgogICAgICAgICAgICBzZWxmLmFkZF9hbGVydCgncHJpY2UnLCBmJ3tzeW1ib2x9IHJlYWNoZWQgJHtjdXJyZW50OiwuMGZ9ICh0YXJnZXQ6ICR7dGFyZ2V0OiwuMGZ9KScsICdoaWdoJykKICAgICAgICBlbGlmIGRpcmVjdGlvbiA9PSAnYmVsb3cnIGFuZCBjdXJyZW50IDw9IHRhcmdldDoKICAgICAgICAgICAgc2VsZi5hZGRfYWxlcnQoJ3ByaWNlJywgZid7c3ltYm9sfSBkcm9wcGVkIHRvICR7Y3VycmVudDosLjBmfSAodGFyZ2V0OiAke3RhcmdldDosLjBmfSknLCAnaGlnaCcpCgphbGVydHMgPSBBbGVydE1hbmFnZXIoKQphbGVydHMucHJpY2VfYWxlcnQoJ0JUQycsIDQ1MDAwLCA0NDAwMCwgJ2Fib3ZlJyk="><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-8-2')" type="button">Run</button></div><pre><code><span class="k">class</span> <span class="nc">AlertManager</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alerts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">channels</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># email, telegram, etc.</span>
    
    <span class="k">def</span> <span class="nf">add_alert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alert_type</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="s1">&#39;normal&#39;</span><span class="p">):</span>
        <span class="n">alert</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="n">alert_type</span><span class="p">,</span>
            <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="n">message</span><span class="p">,</span>
            <span class="s1">&#39;priority&#39;</span><span class="p">:</span> <span class="n">priority</span><span class="p">,</span>
            <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
            <span class="s1">&#39;sent&#39;</span><span class="p">:</span> <span class="kc">False</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alerts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">alert</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">priority</span> <span class="o">==</span> <span class="s1">&#39;high&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">send_immediately</span><span class="p">(</span><span class="n">alert</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">alert</span>
    
    <span class="k">def</span> <span class="nf">send_immediately</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alert</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;ğŸš¨ HIGH PRIORITY: </span><span class="si">{</span><span class="n">alert</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">alert</span><span class="p">[</span><span class="s1">&#39;sent&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    
    <span class="k">def</span> <span class="nf">price_alert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">current</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">direction</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">direction</span> <span class="o">==</span> <span class="s1">&#39;above&#39;</span> <span class="ow">and</span> <span class="n">current</span> <span class="o">&gt;=</span> <span class="n">target</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_alert</span><span class="p">(</span><span class="s1">&#39;price&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">symbol</span><span class="si">}</span><span class="s1"> reached $</span><span class="si">{</span><span class="n">current</span><span class="si">:</span><span class="s1">,.0f</span><span class="si">}</span><span class="s1"> (target: $</span><span class="si">{</span><span class="n">target</span><span class="si">:</span><span class="s1">,.0f</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">,</span> <span class="s1">&#39;high&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">direction</span> <span class="o">==</span> <span class="s1">&#39;below&#39;</span> <span class="ow">and</span> <span class="n">current</span> <span class="o">&lt;=</span> <span class="n">target</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_alert</span><span class="p">(</span><span class="s1">&#39;price&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">symbol</span><span class="si">}</span><span class="s1"> dropped to $</span><span class="si">{</span><span class="n">current</span><span class="si">:</span><span class="s1">,.0f</span><span class="si">}</span><span class="s1"> (target: $</span><span class="si">{</span><span class="n">target</span><span class="si">:</span><span class="s1">,.0f</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">,</span> <span class="s1">&#39;high&#39;</span><span class="p">)</span>

<span class="n">alerts</span> <span class="o">=</span> <span class="n">AlertManager</span><span class="p">()</span>
<span class="n">alerts</span><span class="o">.</span><span class="n">price_alert</span><span class="p">(</span><span class="s1">&#39;BTC&#39;</span><span class="p">,</span> <span class="mi">45000</span><span class="p">,</span> <span class="mi">44000</span><span class="p">,</span> <span class="s1">&#39;above&#39;</span><span class="p">)</span>
</code></pre><div class="code-output" id="output-cell-8-2"></div></div>
<div class="md-cell"><h3>âœï¸ Exercise 8.2: Multi-Channel Alerts</h3>
<p>Build an alert system supporting multiple notification channels.</p></div>
<div class="code-cell" id="cell-8-3" data-source="IyBFeGVyY2lzZSA4LjIKY2xhc3MgTXVsdGlDaGFubmVsQWxlcnRzOgogICAgZGVmIF9faW5pdF9fKHNlbGYpOgogICAgICAgIHNlbGYuY2hhbm5lbHMgPSB7fQogICAgCiAgICBkZWYgYWRkX2NoYW5uZWwoc2VsZiwgbmFtZSwgc2VuZGVyX2Z1bmMpOgogICAgICAgICMgVE9ETwogICAgICAgIHBhc3MKICAgIAogICAgZGVmIHNlbmRfYWxlcnQoc2VsZiwgbWVzc2FnZSwgY2hhbm5lbHM9Tm9uZSwgcHJpb3JpdHk9J25vcm1hbCcpOgogICAgICAgICMgVE9ETzogU2VuZCB0byBzcGVjaWZpZWQgY2hhbm5lbHMKICAgICAgICBwYXNz"><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-8-3')" type="button">Run</button></div><pre><code><span class="c1"># Exercise 8.2</span>
<span class="k">class</span> <span class="nc">MultiChannelAlerts</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">channels</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="k">def</span> <span class="nf">add_channel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">sender_func</span><span class="p">):</span>
        <span class="c1"># TODO</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">send_alert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">channels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="s1">&#39;normal&#39;</span><span class="p">):</span>
        <span class="c1"># TODO: Send to specified channels</span>
        <span class="k">pass</span>
</code></pre><div class="code-output" id="output-cell-8-3"></div></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">MultiChannelAlerts</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">channels</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alert_history</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">add_channel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">sender_func</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">sender_func</span>

    <span class="k">def</span> <span class="nf">send_alert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">channels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="s1">&#39;normal&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">channels</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">channels</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

        <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="n">channels</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">channel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="p">[</span><span class="n">channel</span><span class="p">](</span><span class="n">message</span><span class="p">,</span> <span class="n">priority</span><span class="p">)</span>
                    <span class="n">results</span><span class="p">[</span><span class="n">channel</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;sent&#39;</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">results</span><span class="p">[</span><span class="n">channel</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">alert_history</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="n">message</span><span class="p">,</span>
            <span class="s1">&#39;priority&#39;</span><span class="p">:</span> <span class="n">priority</span><span class="p">,</span>
            <span class="s1">&#39;channels&#39;</span><span class="p">:</span> <span class="n">results</span><span class="p">,</span>
            <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="p">})</span>

        <span class="k">return</span> <span class="n">results</span>

<span class="c1"># Example usage</span>
<span class="k">def</span> <span class="nf">console_sender</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">priority</span><span class="p">):</span>
    <span class="n">prefix</span> <span class="o">=</span> <span class="s1">&#39;ğŸš¨&#39;</span> <span class="k">if</span> <span class="n">priority</span> <span class="o">==</span> <span class="s1">&#39;high&#39;</span> <span class="k">else</span> <span class="s1">&#39;ğŸ“¢&#39;</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">msg</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">log_sender</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">priority</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;[LOG] </span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">msg</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="n">alerts</span> <span class="o">=</span> <span class="n">MultiChannelAlerts</span><span class="p">()</span>
<span class="n">alerts</span><span class="o">.</span><span class="n">add_channel</span><span class="p">(</span><span class="s1">&#39;console&#39;</span><span class="p">,</span> <span class="n">console_sender</span><span class="p">)</span>
<span class="n">alerts</span><span class="o">.</span><span class="n">add_channel</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">,</span> <span class="n">log_sender</span><span class="p">)</span>
<span class="n">alerts</span><span class="o">.</span><span class="n">send_alert</span><span class="p">(</span><span class="s1">&#39;BTC signal detected!&#39;</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="s1">&#39;high&#39;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>Section 3: Logging &amp; Monitoring</h1></div>
<div class="code-cell" id="cell-8-4" data-source="aW1wb3J0IGxvZ2dpbmcKCmRlZiBzZXR1cF9sb2dnaW5nKG5hbWU9J3RyYWRpbmdfYm90Jyk6CiAgICBsb2dnZXIgPSBsb2dnaW5nLmdldExvZ2dlcihuYW1lKQogICAgbG9nZ2VyLnNldExldmVsKGxvZ2dpbmcuREVCVUcpCiAgICAKICAgICMgQ29uc29sZSBoYW5kbGVyCiAgICBjb25zb2xlID0gbG9nZ2luZy5TdHJlYW1IYW5kbGVyKCkKICAgIGNvbnNvbGUuc2V0TGV2ZWwobG9nZ2luZy5JTkZPKQogICAgY29uc29sZS5zZXRGb3JtYXR0ZXIobG9nZ2luZy5Gb3JtYXR0ZXIoJyUoYXNjdGltZSlzIC0gJShsZXZlbG5hbWUpcyAtICUobWVzc2FnZSlzJykpCiAgICAKICAgIGxvZ2dlci5hZGRIYW5kbGVyKGNvbnNvbGUpCiAgICByZXR1cm4gbG9nZ2VyCgpsb2dnZXIgPSBzZXR1cF9sb2dnaW5nKCkKbG9nZ2VyLmluZm8oJ0JvdCBzdGFydGVkJykKbG9nZ2VyLndhcm5pbmcoJ0xvdyBiYWxhbmNlIGRldGVjdGVkJyk="><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-8-4')" type="button">Run</button></div><pre><code><span class="kn">import</span> <span class="nn">logging</span>

<span class="k">def</span> <span class="nf">setup_logging</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;trading_bot&#39;</span><span class="p">):</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
    
    <span class="c1"># Console handler</span>
    <span class="n">console</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">()</span>
    <span class="n">console</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
    <span class="n">console</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1"> - </span><span class="si">%(levelname)s</span><span class="s1"> - </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">))</span>
    
    <span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">console</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">logger</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">setup_logging</span><span class="p">()</span>
<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Bot started&#39;</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Low balance detected&#39;</span><span class="p">)</span>
</code></pre><div class="code-output" id="output-cell-8-4"></div></div>
<div class="code-cell" id="cell-8-5" data-source="Y2xhc3MgVHJhZGVMb2dnZXI6CiAgICBkZWYgX19pbml0X18oc2VsZik6CiAgICAgICAgc2VsZi50cmFkZXMgPSBbXQogICAgICAgIHNlbGYuZGFpbHlfcG5sID0ge30KICAgIAogICAgZGVmIGxvZ190cmFkZShzZWxmLCBzeW1ib2wsIHNpZGUsIHByaWNlLCBzaXplLCBwbmw9Tm9uZSk6CiAgICAgICAgdHJhZGUgPSB7CiAgICAgICAgICAgICd0aW1lc3RhbXAnOiBkYXRldGltZS5ub3coKSwKICAgICAgICAgICAgJ3N5bWJvbCc6IHN5bWJvbCwKICAgICAgICAgICAgJ3NpZGUnOiBzaWRlLAogICAgICAgICAgICAncHJpY2UnOiBwcmljZSwKICAgICAgICAgICAgJ3NpemUnOiBzaXplLAogICAgICAgICAgICAncG5sJzogcG5sCiAgICAgICAgfQogICAgICAgIHNlbGYudHJhZGVzLmFwcGVuZCh0cmFkZSkKICAgICAgICAKICAgICAgICAjIFVwZGF0ZSBkYWlseSBQbkwKICAgICAgICBkYXRlID0gZGF0ZXRpbWUubm93KCkuZGF0ZSgpCiAgICAgICAgaWYgZGF0ZSBub3QgaW4gc2VsZi5kYWlseV9wbmw6CiAgICAgICAgICAgIHNlbGYuZGFpbHlfcG5sW2RhdGVdID0gMAogICAgICAgIGlmIHBubDoKICAgICAgICAgICAgc2VsZi5kYWlseV9wbmxbZGF0ZV0gKz0gcG5sCiAgICAgICAgCiAgICAgICAgcmV0dXJuIHRyYWRlCiAgICAKICAgIGRlZiBnZXRfc3VtbWFyeShzZWxmKToKICAgICAgICB0b3RhbF9wbmwgPSBzdW0odC5nZXQoJ3BubCcsIDApIG9yIDAgZm9yIHQgaW4gc2VsZi50cmFkZXMpCiAgICAgICAgd2lucyA9IGxlbihbdCBmb3IgdCBpbiBzZWxmLnRyYWRlcyBpZiAodC5nZXQoJ3BubCcpIG9yIDApID4gMF0pCiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgJ3RvdGFsX3RyYWRlcyc6IGxlbihzZWxmLnRyYWRlcyksCiAgICAgICAgICAgICd0b3RhbF9wbmwnOiB0b3RhbF9wbmwsCiAgICAgICAgICAgICd3aW5zJzogd2lucwogICAgICAgIH0="><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-8-5')" type="button">Run</button></div><pre><code><span class="k">class</span> <span class="nc">TradeLogger</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trades</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">daily_pnl</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="k">def</span> <span class="nf">log_trade</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">side</span><span class="p">,</span> <span class="n">price</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">pnl</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">trade</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
            <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span>
            <span class="s1">&#39;side&#39;</span><span class="p">:</span> <span class="n">side</span><span class="p">,</span>
            <span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="n">price</span><span class="p">,</span>
            <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="n">size</span><span class="p">,</span>
            <span class="s1">&#39;pnl&#39;</span><span class="p">:</span> <span class="n">pnl</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trades</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">trade</span><span class="p">)</span>
        
        <span class="c1"># Update daily PnL</span>
        <span class="n">date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">date</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">daily_pnl</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">daily_pnl</span><span class="p">[</span><span class="n">date</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">pnl</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">daily_pnl</span><span class="p">[</span><span class="n">date</span><span class="p">]</span> <span class="o">+=</span> <span class="n">pnl</span>
        
        <span class="k">return</span> <span class="n">trade</span>
    
    <span class="k">def</span> <span class="nf">get_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">total_pnl</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pnl&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trades</span><span class="p">)</span>
        <span class="n">wins</span> <span class="o">=</span> <span class="nb">len</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trades</span> <span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pnl&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">])</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;total_trades&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trades</span><span class="p">),</span>
            <span class="s1">&#39;total_pnl&#39;</span><span class="p">:</span> <span class="n">total_pnl</span><span class="p">,</span>
            <span class="s1">&#39;wins&#39;</span><span class="p">:</span> <span class="n">wins</span>
        <span class="p">}</span>
</code></pre><div class="code-output" id="output-cell-8-5"></div></div>
<div class="md-cell"><h3>âœï¸ Exercise 8.3: Monitoring Dashboard</h3>
<p>Create a real-time monitoring dashboard class.</p></div>
<div class="code-cell" id="cell-8-6" data-source="IyBFeGVyY2lzZSA4LjMKY2xhc3MgTW9uaXRvcmluZ0Rhc2hib2FyZDoKICAgIGRlZiBfX2luaXRfXyhzZWxmKToKICAgICAgICBzZWxmLm1ldHJpY3MgPSB7fQogICAgCiAgICBkZWYgdXBkYXRlX21ldHJpYyhzZWxmLCBuYW1lLCB2YWx1ZSk6CiAgICAgICAgIyBUT0RPCiAgICAgICAgcGFzcwogICAgCiAgICBkZWYgZ2V0X3N0YXR1cyhzZWxmKToKICAgICAgICAjIFRPRE86IFJldHVybiBzeXN0ZW0gc3RhdHVzCiAgICAgICAgcGFzcwogICAgCiAgICBkZWYgZGlzcGxheShzZWxmKToKICAgICAgICAjIFRPRE86IFByaW50IGRhc2hib2FyZAogICAgICAgIHBhc3M="><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-8-6')" type="button">Run</button></div><pre><code><span class="c1"># Exercise 8.3</span>
<span class="k">class</span> <span class="nc">MonitoringDashboard</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="k">def</span> <span class="nf">update_metric</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="c1"># TODO</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">get_status</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># TODO: Return system status</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">display</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># TODO: Print dashboard</span>
        <span class="k">pass</span>
</code></pre><div class="code-output" id="output-cell-8-6"></div></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">MonitoringDashboard</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">update_metric</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;values&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;current&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;current&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;values&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">value</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()})</span>
        <span class="c1"># Keep last 1000 values</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;values&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1000</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;values&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">log_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">error</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">error</span><span class="p">),</span> <span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()})</span>

    <span class="k">def</span> <span class="nf">get_status</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">uptime</span> <span class="o">=</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">/</span> <span class="mi">3600</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;uptime_hours&#39;</span><span class="p">:</span> <span class="n">uptime</span><span class="p">,</span>
            <span class="s1">&#39;metrics_count&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">),</span>
            <span class="s1">&#39;error_count&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">errors</span><span class="p">),</span>
            <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;HEALTHY&#39;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">errors</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">5</span> <span class="k">else</span> <span class="s1">&#39;DEGRADED&#39;</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">display</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_status</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=&#39;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;       TRADING BOT DASHBOARD&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=&#39;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Status: </span><span class="si">{</span><span class="n">status</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Uptime: </span><span class="si">{</span><span class="n">status</span><span class="p">[</span><span class="s1">&#39;uptime_hours&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> hours&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Errors: </span><span class="si">{</span><span class="n">status</span><span class="p">[</span><span class="s1">&#39;error_count&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-&#39;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;METRICS:&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;current&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=&#39;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>Section 4: Paper Trading</h1></div>
<div class="code-cell" id="cell-8-7" data-source="Y2xhc3MgUGFwZXJUcmFkaW5nU3lzdGVtOgogICAgZGVmIF9faW5pdF9fKHNlbGYsIGluaXRpYWxfYmFsYW5jZT0xMDAwMCk6CiAgICAgICAgc2VsZi5iYWxhbmNlID0gaW5pdGlhbF9iYWxhbmNlCiAgICAgICAgc2VsZi5wb3NpdGlvbnMgPSB7fQogICAgICAgIHNlbGYudHJhZGVzID0gW10KICAgICAgICBzZWxmLm9yZGVyX2lkID0gMAogICAgCiAgICBkZWYgZ2V0X2JhbGFuY2Uoc2VsZik6CiAgICAgICAgcmV0dXJuIHNlbGYuYmFsYW5jZQogICAgCiAgICBkZWYgbWFya2V0X2J1eShzZWxmLCBzeW1ib2wsIHNpemUsIHByaWNlKToKICAgICAgICBjb3N0ID0gc2l6ZSAqIHByaWNlICogMS4wMDEgICMgMC4xJSBmZWUKICAgICAgICBpZiBjb3N0ID4gc2VsZi5iYWxhbmNlOgogICAgICAgICAgICByZXR1cm4geydzdWNjZXNzJzogRmFsc2UsICdlcnJvcic6ICdJbnN1ZmZpY2llbnQgYmFsYW5jZSd9CiAgICAgICAgCiAgICAgICAgc2VsZi5iYWxhbmNlIC09IGNvc3QKICAgICAgICBzZWxmLnBvc2l0aW9uc1tzeW1ib2xdID0gc2VsZi5wb3NpdGlvbnMuZ2V0KHN5bWJvbCwgMCkgKyBzaXplCiAgICAgICAgCiAgICAgICAgc2VsZi5vcmRlcl9pZCArPSAxCiAgICAgICAgdHJhZGUgPSB7CiAgICAgICAgICAgICdpZCc6IHNlbGYub3JkZXJfaWQsCiAgICAgICAgICAgICdzeW1ib2wnOiBzeW1ib2wsCiAgICAgICAgICAgICdzaWRlJzogJ0JVWScsCiAgICAgICAgICAgICdzaXplJzogc2l6ZSwKICAgICAgICAgICAgJ3ByaWNlJzogcHJpY2UsCiAgICAgICAgICAgICdjb3N0JzogY29zdCwKICAgICAgICAgICAgJ3RpbWVzdGFtcCc6IGRhdGV0aW1lLm5vdygpCiAgICAgICAgfQogICAgICAgIHNlbGYudHJhZGVzLmFwcGVuZCh0cmFkZSkKICAgICAgICByZXR1cm4geydzdWNjZXNzJzogVHJ1ZSwgJ3RyYWRlJzogdHJhZGV9CiAgICAKICAgIGRlZiBtYXJrZXRfc2VsbChzZWxmLCBzeW1ib2wsIHNpemUsIHByaWNlKToKICAgICAgICBpZiBzeW1ib2wgbm90IGluIHNlbGYucG9zaXRpb25zIG9yIHNlbGYucG9zaXRpb25zW3N5bWJvbF0gPCBzaXplOgogICAgICAgICAgICByZXR1cm4geydzdWNjZXNzJzogRmFsc2UsICdlcnJvcic6ICdJbnN1ZmZpY2llbnQgcG9zaXRpb24nfQogICAgICAgIAogICAgICAgIHJldmVudWUgPSBzaXplICogcHJpY2UgKiAwLjk5OSAgIyAwLjElIGZlZQogICAgICAgIHNlbGYuYmFsYW5jZSArPSByZXZlbnVlCiAgICAgICAgc2VsZi5wb3NpdGlvbnNbc3ltYm9sXSAtPSBzaXplCiAgICAgICAgCiAgICAgICAgaWYgc2VsZi5wb3NpdGlvbnNbc3ltYm9sXSA9PSAwOgogICAgICAgICAgICBkZWwgc2VsZi5wb3NpdGlvbnNbc3ltYm9sXQogICAgICAgIAogICAgICAgIHNlbGYub3JkZXJfaWQgKz0gMQogICAgICAgIHRyYWRlID0gewogICAgICAgICAgICAnaWQnOiBzZWxmLm9yZGVyX2lkLAogICAgICAgICAgICAnc3ltYm9sJzogc3ltYm9sLAogICAgICAgICAgICAnc2lkZSc6ICdTRUxMJywKICAgICAgICAgICAgJ3NpemUnOiBzaXplLAogICAgICAgICAgICAncHJpY2UnOiBwcmljZSwKICAgICAgICAgICAgJ3JldmVudWUnOiByZXZlbnVlLAogICAgICAgICAgICAndGltZXN0YW1wJzogZGF0ZXRpbWUubm93KCkKICAgICAgICB9CiAgICAgICAgc2VsZi50cmFkZXMuYXBwZW5kKHRyYWRlKQogICAgICAgIHJldHVybiB7J3N1Y2Nlc3MnOiBUcnVlLCAndHJhZGUnOiB0cmFkZX0KICAgIAogICAgZGVmIGdldF9wb3J0Zm9saW9fdmFsdWUoc2VsZiwgcHJpY2VzKToKICAgICAgICB2YWx1ZSA9IHNlbGYuYmFsYW5jZQogICAgICAgIGZvciBzeW1ib2wsIHNpemUgaW4gc2VsZi5wb3NpdGlvbnMuaXRlbXMoKToKICAgICAgICAgICAgaWYgc3ltYm9sIGluIHByaWNlczoKICAgICAgICAgICAgICAgIHZhbHVlICs9IHNpemUgKiBwcmljZXNbc3ltYm9sXQogICAgICAgIHJldHVybiB2YWx1ZQ=="><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-8-7')" type="button">Run</button></div><pre><code><span class="k">class</span> <span class="nc">PaperTradingSystem</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">initial_balance</span><span class="o">=</span><span class="mi">10000</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">balance</span> <span class="o">=</span> <span class="n">initial_balance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">positions</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trades</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">order_id</span> <span class="o">=</span> <span class="mi">0</span>
    
    <span class="k">def</span> <span class="nf">get_balance</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">balance</span>
    
    <span class="k">def</span> <span class="nf">market_buy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">price</span><span class="p">):</span>
        <span class="n">cost</span> <span class="o">=</span> <span class="n">size</span> <span class="o">*</span> <span class="n">price</span> <span class="o">*</span> <span class="mf">1.001</span>  <span class="c1"># 0.1% fee</span>
        <span class="k">if</span> <span class="n">cost</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">balance</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Insufficient balance&#39;</span><span class="p">}</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">balance</span> <span class="o">-=</span> <span class="n">cost</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">size</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">order_id</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">trade</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">order_id</span><span class="p">,</span>
            <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span>
            <span class="s1">&#39;side&#39;</span><span class="p">:</span> <span class="s1">&#39;BUY&#39;</span><span class="p">,</span>
            <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="n">size</span><span class="p">,</span>
            <span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="n">price</span><span class="p">,</span>
            <span class="s1">&#39;cost&#39;</span><span class="p">:</span> <span class="n">cost</span><span class="p">,</span>
            <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trades</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">trade</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;trade&#39;</span><span class="p">:</span> <span class="n">trade</span><span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">market_sell</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">price</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">symbol</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Insufficient position&#39;</span><span class="p">}</span>
        
        <span class="n">revenue</span> <span class="o">=</span> <span class="n">size</span> <span class="o">*</span> <span class="n">price</span> <span class="o">*</span> <span class="mf">0.999</span>  <span class="c1"># 0.1% fee</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">balance</span> <span class="o">+=</span> <span class="n">revenue</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span> <span class="o">-=</span> <span class="n">size</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">order_id</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">trade</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">order_id</span><span class="p">,</span>
            <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span>
            <span class="s1">&#39;side&#39;</span><span class="p">:</span> <span class="s1">&#39;SELL&#39;</span><span class="p">,</span>
            <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="n">size</span><span class="p">,</span>
            <span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="n">price</span><span class="p">,</span>
            <span class="s1">&#39;revenue&#39;</span><span class="p">:</span> <span class="n">revenue</span><span class="p">,</span>
            <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trades</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">trade</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;trade&#39;</span><span class="p">:</span> <span class="n">trade</span><span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">get_portfolio_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prices</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">balance</span>
        <span class="k">for</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">size</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="n">prices</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">+=</span> <span class="n">size</span> <span class="o">*</span> <span class="n">prices</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">value</span>
</code></pre><div class="code-output" id="output-cell-8-7"></div></div>
<div class="md-cell"><h3>âœï¸ Exercise 8.4: Paper Trading System</h3>
<p>Extend the paper trading system with limit orders and stop losses.</p></div>
<div class="code-cell" id="cell-8-8" data-source="IyBFeGVyY2lzZSA4LjQKY2xhc3MgQWR2YW5jZWRQYXBlclRyYWRpbmc6CiAgICBkZWYgX19pbml0X18oc2VsZiwgaW5pdGlhbF9iYWxhbmNlPTEwMDAwKToKICAgICAgICBzZWxmLmJhbGFuY2UgPSBpbml0aWFsX2JhbGFuY2UKICAgICAgICBzZWxmLnBvc2l0aW9ucyA9IHt9CiAgICAgICAgc2VsZi5vcGVuX29yZGVycyA9IFtdCiAgICAKICAgIGRlZiBsaW1pdF9idXkoc2VsZiwgc3ltYm9sLCBzaXplLCBsaW1pdF9wcmljZSk6CiAgICAgICAgIyBUT0RPOiBQbGFjZSBsaW1pdCBvcmRlcgogICAgICAgIHBhc3MKICAgIAogICAgZGVmIHNldF9zdG9wX2xvc3Moc2VsZiwgc3ltYm9sLCBzdG9wX3ByaWNlKToKICAgICAgICAjIFRPRE86IFNldCBzdG9wIGxvc3MgZm9yIHBvc2l0aW9uCiAgICAgICAgcGFzcwogICAgCiAgICBkZWYgdXBkYXRlX3dpdGhfcHJpY2Uoc2VsZiwgc3ltYm9sLCBjdXJyZW50X3ByaWNlKToKICAgICAgICAjIFRPRE86IENoZWNrIGFuZCBleGVjdXRlIHBlbmRpbmcgb3JkZXJzCiAgICAgICAgcGFzcw=="><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-8-8')" type="button">Run</button></div><pre><code><span class="c1"># Exercise 8.4</span>
<span class="k">class</span> <span class="nc">AdvancedPaperTrading</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">initial_balance</span><span class="o">=</span><span class="mi">10000</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">balance</span> <span class="o">=</span> <span class="n">initial_balance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">positions</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">open_orders</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">def</span> <span class="nf">limit_buy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">limit_price</span><span class="p">):</span>
        <span class="c1"># TODO: Place limit order</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">set_stop_loss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">stop_price</span><span class="p">):</span>
        <span class="c1"># TODO: Set stop loss for position</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">update_with_price</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">current_price</span><span class="p">):</span>
        <span class="c1"># TODO: Check and execute pending orders</span>
        <span class="k">pass</span>
</code></pre><div class="code-output" id="output-cell-8-8"></div></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">AdvancedPaperTrading</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">initial_balance</span><span class="o">=</span><span class="mi">10000</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">balance</span> <span class="o">=</span> <span class="n">initial_balance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">positions</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">open_orders</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stop_losses</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">order_id</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">limit_buy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">limit_price</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">order_id</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">order</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">order_id</span><span class="p">,</span>
            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;LIMIT_BUY&#39;</span><span class="p">,</span>
            <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span>
            <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="n">size</span><span class="p">,</span>
            <span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="n">limit_price</span><span class="p">,</span>
            <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;OPEN&#39;</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">open_orders</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">order</span>

    <span class="k">def</span> <span class="nf">set_stop_loss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">stop_price</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stop_losses</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span> <span class="o">=</span> <span class="n">stop_price</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;stop&#39;</span><span class="p">:</span> <span class="n">stop_price</span><span class="p">}</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;No position&#39;</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">update_with_price</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">current_price</span><span class="p">):</span>
        <span class="n">executed</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Check limit orders</span>
        <span class="k">for</span> <span class="n">order</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_orders</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">order</span><span class="p">[</span><span class="s1">&#39;symbol&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">symbol</span> <span class="ow">and</span> <span class="n">order</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;OPEN&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">order</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;LIMIT_BUY&#39;</span> <span class="ow">and</span> <span class="n">current_price</span> <span class="o">&lt;=</span> <span class="n">order</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]:</span>
                    <span class="n">cost</span> <span class="o">=</span> <span class="n">order</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">order</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1.001</span>
                    <span class="k">if</span> <span class="n">cost</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">balance</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">balance</span> <span class="o">-=</span> <span class="n">cost</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">order</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">]</span>
                        <span class="n">order</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;FILLED&#39;</span>
                        <span class="n">executed</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>

        <span class="c1"># Check stop losses</span>
        <span class="k">if</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop_losses</span> <span class="ow">and</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">current_price</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop_losses</span><span class="p">[</span><span class="n">symbol</span><span class="p">]:</span>
                <span class="n">size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span>
                <span class="n">revenue</span> <span class="o">=</span> <span class="n">size</span> <span class="o">*</span> <span class="n">current_price</span> <span class="o">*</span> <span class="mf">0.999</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">balance</span> <span class="o">+=</span> <span class="n">revenue</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop_losses</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span>
                <span class="n">executed</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;STOP_LOSS&#39;</span><span class="p">,</span> <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span> <span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="n">current_price</span><span class="p">})</span>

        <span class="k">return</span> <span class="n">executed</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>ğŸ—ï¸ Module Project: Automated Trading Framework</h1>
<p>Combine all automation components into a complete framework.</p></div>
<div class="code-cell" id="cell-8-9" data-source="IyBNb2R1bGUgUHJvamVjdApjbGFzcyBBdXRvbWF0ZWRUcmFkaW5nRnJhbWV3b3JrOgogICAgZGVmIF9faW5pdF9fKHNlbGYsIGNvbmZpZyk6CiAgICAgICAgc2VsZi5jb25maWcgPSBjb25maWcKICAgICAgICBzZWxmLnNjaGVkdWxlciA9IFJvYnVzdFNjaGVkdWxlcigpCiAgICAgICAgc2VsZi5hbGVydHMgPSBNdWx0aUNoYW5uZWxBbGVydHMoKQogICAgICAgIHNlbGYuZGFzaGJvYXJkID0gTW9uaXRvcmluZ0Rhc2hib2FyZCgpCiAgICAgICAgc2VsZi5wYXBlcl90cmFkaW5nID0gUGFwZXJUcmFkaW5nU3lzdGVtKGNvbmZpZy5nZXQoJ2NhcGl0YWwnLCAxMDAwMCkpCiAgICAgICAgc2VsZi5sb2dnZXIgPSBzZXR1cF9sb2dnaW5nKCkKICAgICAgICBzZWxmLnJ1bm5pbmcgPSBGYWxzZQogICAgCiAgICBkZWYgc3RhcnQoc2VsZik6CiAgICAgICAgc2VsZi5ydW5uaW5nID0gVHJ1ZQogICAgICAgIHNlbGYubG9nZ2VyLmluZm8oJ0ZyYW1ld29yayBzdGFydGVkJykKICAgIAogICAgZGVmIHN0b3Aoc2VsZik6CiAgICAgICAgc2VsZi5ydW5uaW5nID0gRmFsc2UKICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKCdGcmFtZXdvcmsgc3RvcHBlZCcpCiAgICAKICAgIGRlZiBydW5fY3ljbGUoc2VsZiwgcHJpY2VzKToKICAgICAgICAiIiJPbmUgdHJhZGluZyBjeWNsZS4iIiIKICAgICAgICAjIFVwZGF0ZSBkYXNoYm9hcmQKICAgICAgICBmb3Igc3ltYm9sLCBwcmljZSBpbiBwcmljZXMuaXRlbXMoKToKICAgICAgICAgICAgc2VsZi5kYXNoYm9hcmQudXBkYXRlX21ldHJpYyhmJ3tzeW1ib2x9X3ByaWNlJywgcHJpY2UpCiAgICAgICAgCiAgICAgICAgIyBDYWxjdWxhdGUgcG9ydGZvbGlvIHZhbHVlCiAgICAgICAgcHYgPSBzZWxmLnBhcGVyX3RyYWRpbmcuZ2V0X3BvcnRmb2xpb192YWx1ZShwcmljZXMpCiAgICAgICAgc2VsZi5kYXNoYm9hcmQudXBkYXRlX21ldHJpYygncG9ydGZvbGlvX3ZhbHVlJywgcHYpCiAgICAgICAgCiAgICAgICAgcmV0dXJuIHsncG9ydGZvbGlvX3ZhbHVlJzogcHZ9CiAgICAKICAgIGRlZiBzdGF0dXMoc2VsZik6CiAgICAgICAgcmV0dXJuIHNlbGYuZGFzaGJvYXJkLmdldF9zdGF0dXMoKQ=="><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-8-9')" type="button">Run</button></div><pre><code><span class="c1"># Module Project</span>
<span class="k">class</span> <span class="nc">AutomatedTradingFramework</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span> <span class="o">=</span> <span class="n">RobustScheduler</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alerts</span> <span class="o">=</span> <span class="n">MultiChannelAlerts</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dashboard</span> <span class="o">=</span> <span class="n">MonitoringDashboard</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">paper_trading</span> <span class="o">=</span> <span class="n">PaperTradingSystem</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;capital&#39;</span><span class="p">,</span> <span class="mi">10000</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">setup_logging</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="kc">False</span>
    
    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Framework started&#39;</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Framework stopped&#39;</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">run_cycle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prices</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;One trading cycle.&quot;&quot;&quot;</span>
        <span class="c1"># Update dashboard</span>
        <span class="k">for</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">price</span> <span class="ow">in</span> <span class="n">prices</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dashboard</span><span class="o">.</span><span class="n">update_metric</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">symbol</span><span class="si">}</span><span class="s1">_price&#39;</span><span class="p">,</span> <span class="n">price</span><span class="p">)</span>
        
        <span class="c1"># Calculate portfolio value</span>
        <span class="n">pv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">paper_trading</span><span class="o">.</span><span class="n">get_portfolio_value</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dashboard</span><span class="o">.</span><span class="n">update_metric</span><span class="p">(</span><span class="s1">&#39;portfolio_value&#39;</span><span class="p">,</span> <span class="n">pv</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;portfolio_value&#39;</span><span class="p">:</span> <span class="n">pv</span><span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">status</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dashboard</span><span class="o">.</span><span class="n">get_status</span><span class="p">()</span>
</code></pre><div class="code-output" id="output-cell-8-9"></div></div>
<div class="md-cell"><hr />
<h1>ğŸ“ Key Takeaways</h1>
<ol>
<li><strong>Scheduling</strong>: Use robust scheduling with error recovery</li>
<li><strong>Alerts</strong>: Multi-channel alerts for critical events</li>
<li><strong>Logging</strong>: Log everything for debugging and analysis</li>
<li><strong>Paper Trading</strong>: Always test before going live</li>
</ol>
<hr />
<p><em>Part 2 Complete! Next: Part 3 - Exchange Integration</em></p></div>
        <div class="nav-buttons">
            <button class="nav-btn prev-btn disabled" type="button">
                <span class="nav-btn-label">â† Previous</span>
                <span class="nav-btn-name"></span>
            </button>
            <button class="nav-btn next-btn disabled" type="button">
                <span class="nav-btn-label">Next â†’</span>
                <span class="nav-btn-name"></span>
            </button>
        </div>
        </div>
<div class="module-section" data-idx="9"><div class="md-cell module-header"><h1>Module 9: Exchange APIs Deep Dive</h1>
<h2>Part 3: Exchange Integration</h2>
<hr />
<div class="table-wrapper"><table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>â±ï¸ <strong>Duration</strong></td>
<td>~2.5 hours</td>
</tr>
<tr>
<td>ğŸ“‹ <strong>Prerequisites</strong></td>
<td>Part 2 (Modules 5-8)</td>
</tr>
<tr>
<td>ğŸ’ª <strong>Exercises</strong></td>
<td>5 total</td>
</tr>
</tbody>
</table></div></div>
<div class="md-cell"><h2>ğŸ¯ Learning Objectives</h2>
<ul>
<li>Set up secure API authentication</li>
<li>Fetch market data from exchanges</li>
<li>Access account information</li>
<li>Handle rate limits properly</li>
</ul></div>
<div class="md-cell"><hr />
<h1>Section 1: Authentication &amp; Security</h1>
<h2>1.1 API Key Management</h2>
<p><strong>NEVER</strong> hardcode API keys in your code. Use environment variables.</p></div>
<div class="code-cell" id="cell-9-0" data-source="aW1wb3J0IG9zCmZyb20gZG90ZW52IGltcG9ydCBsb2FkX2RvdGVudgoKIyBMb2FkIGZyb20gLmVudiBmaWxlCmxvYWRfZG90ZW52KCkKCiMgQWNjZXNzIGtleXMgc2VjdXJlbHkKQVBJX0tFWSA9IG9zLmdldGVudignRVhDSEFOR0VfQVBJX0tFWScpCkFQSV9TRUNSRVQgPSBvcy5nZXRlbnYoJ0VYQ0hBTkdFX0FQSV9TRUNSRVQnKQoKIyBWZXJpZnkga2V5cyBhcmUgbG9hZGVkIChuZXZlciBwcmludCBhY3R1YWwgdmFsdWVzISkKcHJpbnQoZidBUEkgS2V5IGxvYWRlZDoge0FQSV9LRVkgaXMgbm90IE5vbmV9JykKcHJpbnQoZidBUEkgU2VjcmV0IGxvYWRlZDoge0FQSV9TRUNSRVQgaXMgbm90IE5vbmV9Jyk="><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-9-0')" type="button">Run</button></div><pre><code><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">dotenv</span> <span class="kn">import</span> <span class="n">load_dotenv</span>

<span class="c1"># Load from .env file</span>
<span class="n">load_dotenv</span><span class="p">()</span>

<span class="c1"># Access keys securely</span>
<span class="n">API_KEY</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;EXCHANGE_API_KEY&#39;</span><span class="p">)</span>
<span class="n">API_SECRET</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;EXCHANGE_API_SECRET&#39;</span><span class="p">)</span>

<span class="c1"># Verify keys are loaded (never print actual values!)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;API Key loaded: </span><span class="si">{</span><span class="n">API_KEY</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;API Secret loaded: </span><span class="si">{</span><span class="n">API_SECRET</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</code></pre><div class="code-output" id="output-cell-9-0"></div></div>
<div class="md-cell"><h2>1.2 Setting Up CCXT</h2>
<p>CCXT provides unified access to 100+ exchanges.</p></div>
<div class="code-cell" id="cell-9-1" data-source="IyBwaXAgaW5zdGFsbCBjY3h0IHB5dGhvbi1kb3RlbnYKaW1wb3J0IGNjeHQKCmNsYXNzIFNlY3VyZUV4Y2hhbmdlQ29ubmVjdGlvbjoKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBleGNoYW5nZV9pZD0nYmluYW5jZScpOgogICAgICAgIHNlbGYuZXhjaGFuZ2VfaWQgPSBleGNoYW5nZV9pZAogICAgICAgIHNlbGYuZXhjaGFuZ2UgPSBOb25lCiAgICAKICAgIGRlZiBjb25uZWN0KHNlbGYsIHNhbmRib3g9VHJ1ZSk6CiAgICAgICAgIiIiQ29ubmVjdCB0byBleGNoYW5nZSB3aXRoIGNyZWRlbnRpYWxzIGZyb20gZW52aXJvbm1lbnQuIiIiCiAgICAgICAgYXBpX2tleSA9IG9zLmdldGVudihmJ3tzZWxmLmV4Y2hhbmdlX2lkLnVwcGVyKCl9X0FQSV9LRVknKQogICAgICAgIGFwaV9zZWNyZXQgPSBvcy5nZXRlbnYoZid7c2VsZi5leGNoYW5nZV9pZC51cHBlcigpfV9BUElfU0VDUkVUJykKICAgICAgICAKICAgICAgICBpZiBub3QgYXBpX2tleSBvciBub3QgYXBpX3NlY3JldDoKICAgICAgICAgICAgcHJpbnQoZidXYXJuaW5nOiBObyBjcmVkZW50aWFscyBmb3Ige3NlbGYuZXhjaGFuZ2VfaWR9LCB1c2luZyBwdWJsaWMgQVBJIG9ubHknKQogICAgICAgIAogICAgICAgIGV4Y2hhbmdlX2NsYXNzID0gZ2V0YXR0cihjY3h0LCBzZWxmLmV4Y2hhbmdlX2lkKQogICAgICAgIHNlbGYuZXhjaGFuZ2UgPSBleGNoYW5nZV9jbGFzcyh7CiAgICAgICAgICAgICdhcGlLZXknOiBhcGlfa2V5LAogICAgICAgICAgICAnc2VjcmV0JzogYXBpX3NlY3JldCwKICAgICAgICAgICAgJ3NhbmRib3gnOiBzYW5kYm94LCAgIyBVc2UgdGVzdG5ldAogICAgICAgICAgICAnZW5hYmxlUmF0ZUxpbWl0JzogVHJ1ZSwgICMgQnVpbHQtaW4gcmF0ZSBsaW1pdGluZwogICAgICAgIH0pCiAgICAgICAgCiAgICAgICAgcmV0dXJuIHNlbGYuZXhjaGFuZ2UKICAgIAogICAgZGVmIHRlc3RfY29ubmVjdGlvbihzZWxmKToKICAgICAgICAiIiJUZXN0IGlmIGNvbm5lY3Rpb24gd29ya3MuIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICBzZWxmLmV4Y2hhbmdlLmxvYWRfbWFya2V0cygpCiAgICAgICAgICAgIHJldHVybiB7J3N1Y2Nlc3MnOiBUcnVlLCAnbWFya2V0cyc6IGxlbihzZWxmLmV4Y2hhbmdlLm1hcmtldHMpfQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgcmV0dXJuIHsnc3VjY2Vzcyc6IEZhbHNlLCAnZXJyb3InOiBzdHIoZSl9CgojIEV4YW1wbGUgKHB1YmxpYyBBUEkgb25seSB3aXRob3V0IGNyZWRlbnRpYWxzKQpjb25uID0gU2VjdXJlRXhjaGFuZ2VDb25uZWN0aW9uKCdiaW5hbmNlJykKZXhjaGFuZ2UgPSBjb25uLmNvbm5lY3Qoc2FuZGJveD1GYWxzZSkKcHJpbnQoZidDb25uZWN0ZWQgdG8ge2V4Y2hhbmdlLmlkfScp"><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-9-1')" type="button">Run</button></div><pre><code><span class="c1"># pip install ccxt python-dotenv</span>
<span class="kn">import</span> <span class="nn">ccxt</span>

<span class="k">class</span> <span class="nc">SecureExchangeConnection</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exchange_id</span><span class="o">=</span><span class="s1">&#39;binance&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exchange_id</span> <span class="o">=</span> <span class="n">exchange_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span> <span class="o">=</span> <span class="kc">None</span>
    
    <span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sandbox</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Connect to exchange with credentials from environment.&quot;&quot;&quot;</span>
        <span class="n">api_key</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">exchange_id</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s1">_API_KEY&#39;</span><span class="p">)</span>
        <span class="n">api_secret</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">exchange_id</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s1">_API_SECRET&#39;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">api_key</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">api_secret</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Warning: No credentials for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">exchange_id</span><span class="si">}</span><span class="s1">, using public API only&#39;</span><span class="p">)</span>
        
        <span class="n">exchange_class</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">ccxt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">exchange_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span> <span class="o">=</span> <span class="n">exchange_class</span><span class="p">({</span>
            <span class="s1">&#39;apiKey&#39;</span><span class="p">:</span> <span class="n">api_key</span><span class="p">,</span>
            <span class="s1">&#39;secret&#39;</span><span class="p">:</span> <span class="n">api_secret</span><span class="p">,</span>
            <span class="s1">&#39;sandbox&#39;</span><span class="p">:</span> <span class="n">sandbox</span><span class="p">,</span>  <span class="c1"># Use testnet</span>
            <span class="s1">&#39;enableRateLimit&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>  <span class="c1"># Built-in rate limiting</span>
        <span class="p">})</span>
        
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span>
    
    <span class="k">def</span> <span class="nf">test_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Test if connection works.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="o">.</span><span class="n">load_markets</span><span class="p">()</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;markets&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="o">.</span><span class="n">markets</span><span class="p">)}</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>

<span class="c1"># Example (public API only without credentials)</span>
<span class="n">conn</span> <span class="o">=</span> <span class="n">SecureExchangeConnection</span><span class="p">(</span><span class="s1">&#39;binance&#39;</span><span class="p">)</span>
<span class="n">exchange</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">sandbox</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Connected to </span><span class="si">{</span><span class="n">exchange</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</code></pre><div class="code-output" id="output-cell-9-1"></div></div>
<div class="md-cell"><h2>1.3 Security Best Practices</h2>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Practice</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>IP Whitelisting</strong></td>
<td>Only allow API access from specific IPs</td>
</tr>
<tr>
<td><strong>Withdrawal Disabled</strong></td>
<td>Never enable withdrawal permission for trading bots</td>
</tr>
<tr>
<td><strong>Read-Only Keys</strong></td>
<td>Use separate keys for monitoring vs trading</td>
</tr>
<tr>
<td><strong>Key Rotation</strong></td>
<td>Rotate keys periodically</td>
</tr>
</tbody>
</table></div></div>
<div class="md-cell"><h3>âœï¸ Exercise 9.1: Secure API Setup</h3>
<p>Create a secure configuration manager for multiple exchanges.</p></div>
<div class="code-cell" id="cell-9-2" data-source="IyBFeGVyY2lzZSA5LjEKY2xhc3MgRXhjaGFuZ2VDb25maWdNYW5hZ2VyOgogICAgZGVmIF9faW5pdF9fKHNlbGYpOgogICAgICAgIHNlbGYuZXhjaGFuZ2VzID0ge30KICAgIAogICAgZGVmIGFkZF9leGNoYW5nZShzZWxmLCBleGNoYW5nZV9pZCk6CiAgICAgICAgIyBUT0RPOiBMb2FkIGNyZWRlbnRpYWxzIGZyb20gZW52IGFuZCBjcmVhdGUgY29ubmVjdGlvbgogICAgICAgIHBhc3MKICAgIAogICAgZGVmIGdldF9leGNoYW5nZShzZWxmLCBleGNoYW5nZV9pZCk6CiAgICAgICAgIyBUT0RPOiBSZXR1cm4gY29uZmlndXJlZCBleGNoYW5nZQogICAgICAgIHBhc3MKICAgIAogICAgZGVmIHZhbGlkYXRlX3Blcm1pc3Npb25zKHNlbGYsIGV4Y2hhbmdlX2lkKToKICAgICAgICAjIFRPRE86IENoZWNrIHdoYXQgcGVybWlzc2lvbnMgdGhlIEFQSSBrZXkgaGFzCiAgICAgICAgcGFzcw=="><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-9-2')" type="button">Run</button></div><pre><code><span class="c1"># Exercise 9.1</span>
<span class="k">class</span> <span class="nc">ExchangeConfigManager</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exchanges</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="k">def</span> <span class="nf">add_exchange</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exchange_id</span><span class="p">):</span>
        <span class="c1"># TODO: Load credentials from env and create connection</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">get_exchange</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exchange_id</span><span class="p">):</span>
        <span class="c1"># TODO: Return configured exchange</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">validate_permissions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exchange_id</span><span class="p">):</span>
        <span class="c1"># TODO: Check what permissions the API key has</span>
        <span class="k">pass</span>
</code></pre><div class="code-output" id="output-cell-9-2"></div></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">ExchangeConfigManager</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exchanges</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connections</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">add_exchange</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exchange_id</span><span class="p">,</span> <span class="n">sandbox</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">api_key</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">exchange_id</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s1">_API_KEY&#39;</span><span class="p">)</span>
        <span class="n">api_secret</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">exchange_id</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s1">_API_SECRET&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">exchanges</span><span class="p">[</span><span class="n">exchange_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;has_credentials&#39;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="n">api_key</span> <span class="ow">and</span> <span class="n">api_secret</span><span class="p">),</span>
            <span class="s1">&#39;sandbox&#39;</span><span class="p">:</span> <span class="n">sandbox</span>
        <span class="p">}</span>

        <span class="n">exchange_class</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">ccxt</span><span class="p">,</span> <span class="n">exchange_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connections</span><span class="p">[</span><span class="n">exchange_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">exchange_class</span><span class="p">({</span>
            <span class="s1">&#39;apiKey&#39;</span><span class="p">:</span> <span class="n">api_key</span><span class="p">,</span>
            <span class="s1">&#39;secret&#39;</span><span class="p">:</span> <span class="n">api_secret</span><span class="p">,</span>
            <span class="s1">&#39;sandbox&#39;</span><span class="p">:</span> <span class="n">sandbox</span><span class="p">,</span>
            <span class="s1">&#39;enableRateLimit&#39;</span><span class="p">:</span> <span class="kc">True</span>
        <span class="p">})</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">exchanges</span><span class="p">[</span><span class="n">exchange_id</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">get_exchange</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exchange_id</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">exchange_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">connections</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_exchange</span><span class="p">(</span><span class="n">exchange_id</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">connections</span><span class="p">[</span><span class="n">exchange_id</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">validate_permissions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exchange_id</span><span class="p">):</span>
        <span class="n">exchange</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_exchange</span><span class="p">(</span><span class="n">exchange_id</span><span class="p">)</span>
        <span class="n">permissions</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;spot_trading&#39;</span><span class="p">:</span> <span class="n">exchange</span><span class="o">.</span><span class="n">has</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;createOrder&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
            <span class="s1">&#39;futures_trading&#39;</span><span class="p">:</span> <span class="n">exchange</span><span class="o">.</span><span class="n">has</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;createOrder&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
            <span class="s1">&#39;fetch_balance&#39;</span><span class="p">:</span> <span class="n">exchange</span><span class="o">.</span><span class="n">has</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fetchBalance&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
            <span class="s1">&#39;fetch_orders&#39;</span><span class="p">:</span> <span class="n">exchange</span><span class="o">.</span><span class="n">has</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fetchOrders&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">permissions</span>

<span class="n">config</span> <span class="o">=</span> <span class="n">ExchangeConfigManager</span><span class="p">()</span>
<span class="n">config</span><span class="o">.</span><span class="n">add_exchange</span><span class="p">(</span><span class="s1">&#39;binance&#39;</span><span class="p">,</span> <span class="n">sandbox</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">validate_permissions</span><span class="p">(</span><span class="s1">&#39;binance&#39;</span><span class="p">))</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>Section 2: Market Data Endpoints</h1>
<h2>2.1 Fetching Prices</h2></div>
<div class="code-cell" id="cell-9-3" data-source="ZGVmIGZldGNoX3RpY2tlcihleGNoYW5nZSwgc3ltYm9sPSdCVEMvVVNEVCcpOgogICAgIiIiRmV0Y2ggY3VycmVudCB0aWNrZXIgZGF0YS4iIiIKICAgIHRyeToKICAgICAgICB0aWNrZXIgPSBleGNoYW5nZS5mZXRjaF90aWNrZXIoc3ltYm9sKQogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICdzeW1ib2wnOiBzeW1ib2wsCiAgICAgICAgICAgICdsYXN0JzogdGlja2VyWydsYXN0J10sCiAgICAgICAgICAgICdiaWQnOiB0aWNrZXJbJ2JpZCddLAogICAgICAgICAgICAnYXNrJzogdGlja2VyWydhc2snXSwKICAgICAgICAgICAgJ3ZvbHVtZSc6IHRpY2tlclsnYmFzZVZvbHVtZSddLAogICAgICAgICAgICAnY2hhbmdlXzI0aCc6IHRpY2tlclsncGVyY2VudGFnZSddCiAgICAgICAgfQogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIHJldHVybiB7J2Vycm9yJzogc3RyKGUpfQoKIyBFeGFtcGxlCnRpY2tlciA9IGZldGNoX3RpY2tlcihleGNoYW5nZSwgJ0JUQy9VU0RUJykKcHJpbnQoZiJCVEMgUHJpY2U6ICR7dGlja2VyLmdldCgnbGFzdCcsICdOL0EnKTosLjJmfSIp"><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-9-3')" type="button">Run</button></div><pre><code><span class="k">def</span> <span class="nf">fetch_ticker</span><span class="p">(</span><span class="n">exchange</span><span class="p">,</span> <span class="n">symbol</span><span class="o">=</span><span class="s1">&#39;BTC/USDT&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Fetch current ticker data.&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">ticker</span> <span class="o">=</span> <span class="n">exchange</span><span class="o">.</span><span class="n">fetch_ticker</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span>
            <span class="s1">&#39;last&#39;</span><span class="p">:</span> <span class="n">ticker</span><span class="p">[</span><span class="s1">&#39;last&#39;</span><span class="p">],</span>
            <span class="s1">&#39;bid&#39;</span><span class="p">:</span> <span class="n">ticker</span><span class="p">[</span><span class="s1">&#39;bid&#39;</span><span class="p">],</span>
            <span class="s1">&#39;ask&#39;</span><span class="p">:</span> <span class="n">ticker</span><span class="p">[</span><span class="s1">&#39;ask&#39;</span><span class="p">],</span>
            <span class="s1">&#39;volume&#39;</span><span class="p">:</span> <span class="n">ticker</span><span class="p">[</span><span class="s1">&#39;baseVolume&#39;</span><span class="p">],</span>
            <span class="s1">&#39;change_24h&#39;</span><span class="p">:</span> <span class="n">ticker</span><span class="p">[</span><span class="s1">&#39;percentage&#39;</span><span class="p">]</span>
        <span class="p">}</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>

<span class="c1"># Example</span>
<span class="n">ticker</span> <span class="o">=</span> <span class="n">fetch_ticker</span><span class="p">(</span><span class="n">exchange</span><span class="p">,</span> <span class="s1">&#39;BTC/USDT&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;BTC Price: $</span><span class="si">{</span><span class="n">ticker</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;last&#39;</span><span class="p">,</span> <span class="s1">&#39;N/A&#39;</span><span class="p">)</span><span class="si">:</span><span class="s2">,.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre><div class="code-output" id="output-cell-9-3"></div></div>
<div class="md-cell"><h2>2.2 Order Book Data</h2></div>
<div class="code-cell" id="cell-9-4" data-source="ZGVmIGZldGNoX29yZGVyX2Jvb2soZXhjaGFuZ2UsIHN5bWJvbD0nQlRDL1VTRFQnLCBsaW1pdD0xMCk6CiAgICAiIiJGZXRjaCBvcmRlciBib29rIHdpdGggYmlkcyBhbmQgYXNrcy4iIiIKICAgIHRyeToKICAgICAgICBib29rID0gZXhjaGFuZ2UuZmV0Y2hfb3JkZXJfYm9vayhzeW1ib2wsIGxpbWl0KQogICAgICAgIAogICAgICAgICMgQ2FsY3VsYXRlIHNwcmVhZAogICAgICAgIGJlc3RfYmlkID0gYm9va1snYmlkcyddWzBdWzBdIGlmIGJvb2tbJ2JpZHMnXSBlbHNlIDAKICAgICAgICBiZXN0X2FzayA9IGJvb2tbJ2Fza3MnXVswXVswXSBpZiBib29rWydhc2tzJ10gZWxzZSAwCiAgICAgICAgc3ByZWFkID0gKGJlc3RfYXNrIC0gYmVzdF9iaWQpIC8gYmVzdF9iaWQgKiAxMDAgaWYgYmVzdF9iaWQgPiAwIGVsc2UgMAogICAgICAgIAogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICdzeW1ib2wnOiBzeW1ib2wsCiAgICAgICAgICAgICdiZXN0X2JpZCc6IGJlc3RfYmlkLAogICAgICAgICAgICAnYmVzdF9hc2snOiBiZXN0X2FzaywKICAgICAgICAgICAgJ3NwcmVhZF9wY3QnOiBzcHJlYWQsCiAgICAgICAgICAgICdiaWRzJzogYm9va1snYmlkcyddWzo1XSwKICAgICAgICAgICAgJ2Fza3MnOiBib29rWydhc2tzJ11bOjVdCiAgICAgICAgfQogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIHJldHVybiB7J2Vycm9yJzogc3RyKGUpfQoKYm9vayA9IGZldGNoX29yZGVyX2Jvb2soZXhjaGFuZ2UsICdCVEMvVVNEVCcpCnByaW50KGYiU3ByZWFkOiB7Ym9vay5nZXQoJ3NwcmVhZF9wY3QnLCAwKTouNGZ9JSIp"><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-9-4')" type="button">Run</button></div><pre><code><span class="k">def</span> <span class="nf">fetch_order_book</span><span class="p">(</span><span class="n">exchange</span><span class="p">,</span> <span class="n">symbol</span><span class="o">=</span><span class="s1">&#39;BTC/USDT&#39;</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Fetch order book with bids and asks.&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">book</span> <span class="o">=</span> <span class="n">exchange</span><span class="o">.</span><span class="n">fetch_order_book</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">limit</span><span class="p">)</span>
        
        <span class="c1"># Calculate spread</span>
        <span class="n">best_bid</span> <span class="o">=</span> <span class="n">book</span><span class="p">[</span><span class="s1">&#39;bids&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">book</span><span class="p">[</span><span class="s1">&#39;bids&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="n">best_ask</span> <span class="o">=</span> <span class="n">book</span><span class="p">[</span><span class="s1">&#39;asks&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">book</span><span class="p">[</span><span class="s1">&#39;asks&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="n">spread</span> <span class="o">=</span> <span class="p">(</span><span class="n">best_ask</span> <span class="o">-</span> <span class="n">best_bid</span><span class="p">)</span> <span class="o">/</span> <span class="n">best_bid</span> <span class="o">*</span> <span class="mi">100</span> <span class="k">if</span> <span class="n">best_bid</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span>
            <span class="s1">&#39;best_bid&#39;</span><span class="p">:</span> <span class="n">best_bid</span><span class="p">,</span>
            <span class="s1">&#39;best_ask&#39;</span><span class="p">:</span> <span class="n">best_ask</span><span class="p">,</span>
            <span class="s1">&#39;spread_pct&#39;</span><span class="p">:</span> <span class="n">spread</span><span class="p">,</span>
            <span class="s1">&#39;bids&#39;</span><span class="p">:</span> <span class="n">book</span><span class="p">[</span><span class="s1">&#39;bids&#39;</span><span class="p">][:</span><span class="mi">5</span><span class="p">],</span>
            <span class="s1">&#39;asks&#39;</span><span class="p">:</span> <span class="n">book</span><span class="p">[</span><span class="s1">&#39;asks&#39;</span><span class="p">][:</span><span class="mi">5</span><span class="p">]</span>
        <span class="p">}</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>

<span class="n">book</span> <span class="o">=</span> <span class="n">fetch_order_book</span><span class="p">(</span><span class="n">exchange</span><span class="p">,</span> <span class="s1">&#39;BTC/USDT&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Spread: </span><span class="si">{</span><span class="n">book</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;spread_pct&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
</code></pre><div class="code-output" id="output-cell-9-4"></div></div>
<div class="md-cell"><h2>2.3 Historical OHLCV Data</h2></div>
<div class="code-cell" id="cell-9-5" data-source="aW1wb3J0IHBhbmRhcyBhcyBwZApmcm9tIGRhdGV0aW1lIGltcG9ydCBkYXRldGltZSwgdGltZWRlbHRhCgpkZWYgZmV0Y2hfb2hsY3YoZXhjaGFuZ2UsIHN5bWJvbD0nQlRDL1VTRFQnLCB0aW1lZnJhbWU9JzFoJywgbGltaXQ9MTAwKToKICAgICIiIkZldGNoIGhpc3RvcmljYWwgT0hMQ1YgZGF0YS4iIiIKICAgIHRyeToKICAgICAgICBvaGxjdiA9IGV4Y2hhbmdlLmZldGNoX29obGN2KHN5bWJvbCwgdGltZWZyYW1lLCBsaW1pdD1saW1pdCkKICAgICAgICAKICAgICAgICBkZiA9IHBkLkRhdGFGcmFtZShvaGxjdiwgY29sdW1ucz1bJ3RpbWVzdGFtcCcsICdvcGVuJywgJ2hpZ2gnLCAnbG93JywgJ2Nsb3NlJywgJ3ZvbHVtZSddKQogICAgICAgIGRmWyd0aW1lc3RhbXAnXSA9IHBkLnRvX2RhdGV0aW1lKGRmWyd0aW1lc3RhbXAnXSwgdW5pdD0nbXMnKQogICAgICAgIGRmLnNldF9pbmRleCgndGltZXN0YW1wJywgaW5wbGFjZT1UcnVlKQogICAgICAgIAogICAgICAgIHJldHVybiBkZgogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIHByaW50KGYnRXJyb3I6IHtlfScpCiAgICAgICAgcmV0dXJuIHBkLkRhdGFGcmFtZSgpCgpkZiA9IGZldGNoX29obGN2KGV4Y2hhbmdlLCAnQlRDL1VTRFQnLCAnMWgnLCAyNCkKcHJpbnQoZGYudGFpbCgpKQ=="><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-9-5')" type="button">Run</button></div><pre><code><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>

<span class="k">def</span> <span class="nf">fetch_ohlcv</span><span class="p">(</span><span class="n">exchange</span><span class="p">,</span> <span class="n">symbol</span><span class="o">=</span><span class="s1">&#39;BTC/USDT&#39;</span><span class="p">,</span> <span class="n">timeframe</span><span class="o">=</span><span class="s1">&#39;1h&#39;</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Fetch historical OHLCV data.&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">ohlcv</span> <span class="o">=</span> <span class="n">exchange</span><span class="o">.</span><span class="n">fetch_ohlcv</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">timeframe</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">)</span>
        
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">ohlcv</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">,</span> <span class="s1">&#39;open&#39;</span><span class="p">,</span> <span class="s1">&#39;high&#39;</span><span class="p">,</span> <span class="s1">&#39;low&#39;</span><span class="p">,</span> <span class="s1">&#39;close&#39;</span><span class="p">,</span> <span class="s1">&#39;volume&#39;</span><span class="p">])</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">],</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;ms&#39;</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;timestamp&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">df</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">fetch_ohlcv</span><span class="p">(</span><span class="n">exchange</span><span class="p">,</span> <span class="s1">&#39;BTC/USDT&#39;</span><span class="p">,</span> <span class="s1">&#39;1h&#39;</span><span class="p">,</span> <span class="mi">24</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">tail</span><span class="p">())</span>
</code></pre><div class="code-output" id="output-cell-9-5"></div></div>
<div class="md-cell"><h3>âœï¸ Exercise 9.2: Market Data Fetcher</h3>
<p>Build a comprehensive market data fetcher class.</p></div>
<div class="code-cell" id="cell-9-6" data-source="IyBFeGVyY2lzZSA5LjIKY2xhc3MgTWFya2V0RGF0YUZldGNoZXI6CiAgICBkZWYgX19pbml0X18oc2VsZiwgZXhjaGFuZ2UpOgogICAgICAgIHNlbGYuZXhjaGFuZ2UgPSBleGNoYW5nZQogICAgICAgIHNlbGYuY2FjaGUgPSB7fQogICAgCiAgICBkZWYgZ2V0X3ByaWNlKHNlbGYsIHN5bWJvbCk6CiAgICAgICAgIyBUT0RPCiAgICAgICAgcGFzcwogICAgCiAgICBkZWYgZ2V0X211bHRpcGxlX3ByaWNlcyhzZWxmLCBzeW1ib2xzKToKICAgICAgICAjIFRPRE86IEZldGNoIHByaWNlcyBmb3IgbXVsdGlwbGUgc3ltYm9scyBlZmZpY2llbnRseQogICAgICAgIHBhc3MKICAgIAogICAgZGVmIGdldF9vaGxjdl9kYXRhZnJhbWUoc2VsZiwgc3ltYm9sLCB0aW1lZnJhbWUsIGxpbWl0KToKICAgICAgICAjIFRPRE8KICAgICAgICBwYXNz"><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-9-6')" type="button">Run</button></div><pre><code><span class="c1"># Exercise 9.2</span>
<span class="k">class</span> <span class="nc">MarketDataFetcher</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exchange</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span> <span class="o">=</span> <span class="n">exchange</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="k">def</span> <span class="nf">get_price</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">):</span>
        <span class="c1"># TODO</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">get_multiple_prices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbols</span><span class="p">):</span>
        <span class="c1"># TODO: Fetch prices for multiple symbols efficiently</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">get_ohlcv_dataframe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">timeframe</span><span class="p">,</span> <span class="n">limit</span><span class="p">):</span>
        <span class="c1"># TODO</span>
        <span class="k">pass</span>
</code></pre><div class="code-output" id="output-cell-9-6"></div></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">MarketDataFetcher</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exchange</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span> <span class="o">=</span> <span class="n">exchange</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache_ttl</span> <span class="o">=</span> <span class="mi">5</span>  <span class="c1"># seconds</span>

    <span class="k">def</span> <span class="nf">_is_cache_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="n">cached_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">timestamp</span><span class="p">()</span> <span class="o">-</span> <span class="n">cached_time</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_ttl</span>

    <span class="k">def</span> <span class="nf">get_price</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">):</span>
        <span class="n">cache_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;price_</span><span class="si">{</span><span class="n">symbol</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_cache_valid</span><span class="p">(</span><span class="n">cache_key</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">cache_key</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">]</span>

        <span class="n">ticker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="o">.</span><span class="n">fetch_ticker</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
        <span class="n">price_data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span>
            <span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="n">ticker</span><span class="p">[</span><span class="s1">&#39;last&#39;</span><span class="p">],</span>
            <span class="s1">&#39;bid&#39;</span><span class="p">:</span> <span class="n">ticker</span><span class="p">[</span><span class="s1">&#39;bid&#39;</span><span class="p">],</span>
            <span class="s1">&#39;ask&#39;</span><span class="p">:</span> <span class="n">ticker</span><span class="p">[</span><span class="s1">&#39;ask&#39;</span><span class="p">]</span>
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">cache_key</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="n">price_data</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">timestamp</span><span class="p">()}</span>
        <span class="k">return</span> <span class="n">price_data</span>

    <span class="k">def</span> <span class="nf">get_multiple_prices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbols</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Use fetch_tickers for efficiency</span>
            <span class="n">tickers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="o">.</span><span class="n">fetch_tickers</span><span class="p">(</span><span class="n">symbols</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span><span class="n">sym</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="n">t</span><span class="p">[</span><span class="s1">&#39;last&#39;</span><span class="p">],</span> <span class="s1">&#39;change&#39;</span><span class="p">:</span> <span class="n">t</span><span class="p">[</span><span class="s1">&#39;percentage&#39;</span><span class="p">]}</span> 
                    <span class="k">for</span> <span class="n">sym</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tickers</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="c1"># Fallback to individual fetches</span>
            <span class="k">return</span> <span class="p">{</span><span class="n">sym</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_price</span><span class="p">(</span><span class="n">sym</span><span class="p">)</span> <span class="k">for</span> <span class="n">sym</span> <span class="ow">in</span> <span class="n">symbols</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">get_ohlcv_dataframe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">timeframe</span><span class="o">=</span><span class="s1">&#39;1h&#39;</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
        <span class="n">ohlcv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="o">.</span><span class="n">fetch_ohlcv</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">timeframe</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">ohlcv</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">,</span> <span class="s1">&#39;open&#39;</span><span class="p">,</span> <span class="s1">&#39;high&#39;</span><span class="p">,</span> <span class="s1">&#39;low&#39;</span><span class="p">,</span> <span class="s1">&#39;close&#39;</span><span class="p">,</span> <span class="s1">&#39;volume&#39;</span><span class="p">])</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">],</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;ms&#39;</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;timestamp&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span>

<span class="n">fetcher</span> <span class="o">=</span> <span class="n">MarketDataFetcher</span><span class="p">(</span><span class="n">exchange</span><span class="p">)</span>
<span class="n">prices</span> <span class="o">=</span> <span class="n">fetcher</span><span class="o">.</span><span class="n">get_multiple_prices</span><span class="p">([</span><span class="s1">&#39;BTC/USDT&#39;</span><span class="p">,</span> <span class="s1">&#39;ETH/USDT&#39;</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>Section 3: Account Endpoints</h1>
<h2>3.1 Balance Information</h2>
<p><strong>Note:</strong> Requires authenticated API connection.</p></div>
<div class="code-cell" id="cell-9-7" data-source="ZGVmIGZldGNoX2JhbGFuY2UoZXhjaGFuZ2UpOgogICAgIiIiRmV0Y2ggYWNjb3VudCBiYWxhbmNlLiIiIgogICAgdHJ5OgogICAgICAgIGJhbGFuY2UgPSBleGNoYW5nZS5mZXRjaF9iYWxhbmNlKCkKICAgICAgICAKICAgICAgICAjIEZpbHRlciBub24temVybyBiYWxhbmNlcwogICAgICAgIGhvbGRpbmdzID0ge30KICAgICAgICBmb3IgY3VycmVuY3ksIGFtb3VudHMgaW4gYmFsYW5jZVsndG90YWwnXS5pdGVtcygpOgogICAgICAgICAgICBpZiBhbW91bnRzID4gMDoKICAgICAgICAgICAgICAgIGhvbGRpbmdzW2N1cnJlbmN5XSA9IHsKICAgICAgICAgICAgICAgICAgICAndG90YWwnOiBhbW91bnRzLAogICAgICAgICAgICAgICAgICAgICdmcmVlJzogYmFsYW5jZVsnZnJlZSddLmdldChjdXJyZW5jeSwgMCksCiAgICAgICAgICAgICAgICAgICAgJ3VzZWQnOiBiYWxhbmNlWyd1c2VkJ10uZ2V0KGN1cnJlbmN5LCAwKQogICAgICAgICAgICAgICAgfQogICAgICAgIAogICAgICAgIHJldHVybiBob2xkaW5ncwogICAgZXhjZXB0IGNjeHQuQXV0aGVudGljYXRpb25FcnJvcjoKICAgICAgICByZXR1cm4geydlcnJvcic6ICdBdXRoZW50aWNhdGlvbiByZXF1aXJlZCd9CiAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgcmV0dXJuIHsnZXJyb3InOiBzdHIoZSl9CgojIFRoaXMgd291bGQgd29yayB3aXRoIHZhbGlkIEFQSSBjcmVkZW50aWFscwojIGJhbGFuY2UgPSBmZXRjaF9iYWxhbmNlKGV4Y2hhbmdlKQojIHByaW50KGJhbGFuY2Up"><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-9-7')" type="button">Run</button></div><pre><code><span class="k">def</span> <span class="nf">fetch_balance</span><span class="p">(</span><span class="n">exchange</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Fetch account balance.&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">balance</span> <span class="o">=</span> <span class="n">exchange</span><span class="o">.</span><span class="n">fetch_balance</span><span class="p">()</span>
        
        <span class="c1"># Filter non-zero balances</span>
        <span class="n">holdings</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">currency</span><span class="p">,</span> <span class="n">amounts</span> <span class="ow">in</span> <span class="n">balance</span><span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">amounts</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">holdings</span><span class="p">[</span><span class="n">currency</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;total&#39;</span><span class="p">:</span> <span class="n">amounts</span><span class="p">,</span>
                    <span class="s1">&#39;free&#39;</span><span class="p">:</span> <span class="n">balance</span><span class="p">[</span><span class="s1">&#39;free&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">currency</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                    <span class="s1">&#39;used&#39;</span><span class="p">:</span> <span class="n">balance</span><span class="p">[</span><span class="s1">&#39;used&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">currency</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="p">}</span>
        
        <span class="k">return</span> <span class="n">holdings</span>
    <span class="k">except</span> <span class="n">ccxt</span><span class="o">.</span><span class="n">AuthenticationError</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Authentication required&#39;</span><span class="p">}</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>

<span class="c1"># This would work with valid API credentials</span>
<span class="c1"># balance = fetch_balance(exchange)</span>
<span class="c1"># print(balance)</span>
</code></pre><div class="code-output" id="output-cell-9-7"></div></div>
<div class="md-cell"><h2>3.2 Order History</h2></div>
<div class="code-cell" id="cell-9-8" data-source="ZGVmIGZldGNoX29yZGVyX2hpc3RvcnkoZXhjaGFuZ2UsIHN5bWJvbD1Ob25lLCBsaW1pdD01MCk6CiAgICAiIiJGZXRjaCByZWNlbnQgb3JkZXIgaGlzdG9yeS4iIiIKICAgIHRyeToKICAgICAgICBpZiBzeW1ib2w6CiAgICAgICAgICAgIG9yZGVycyA9IGV4Y2hhbmdlLmZldGNoX29yZGVycyhzeW1ib2wsIGxpbWl0PWxpbWl0KQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIG9yZGVycyA9IGV4Y2hhbmdlLmZldGNoX29yZGVycyhsaW1pdD1saW1pdCkKICAgICAgICAKICAgICAgICByZXR1cm4gW3sKICAgICAgICAgICAgJ2lkJzogb1snaWQnXSwKICAgICAgICAgICAgJ3N5bWJvbCc6IG9bJ3N5bWJvbCddLAogICAgICAgICAgICAnc2lkZSc6IG9bJ3NpZGUnXSwKICAgICAgICAgICAgJ3R5cGUnOiBvWyd0eXBlJ10sCiAgICAgICAgICAgICdwcmljZSc6IG9bJ3ByaWNlJ10sCiAgICAgICAgICAgICdhbW91bnQnOiBvWydhbW91bnQnXSwKICAgICAgICAgICAgJ2ZpbGxlZCc6IG9bJ2ZpbGxlZCddLAogICAgICAgICAgICAnc3RhdHVzJzogb1snc3RhdHVzJ10sCiAgICAgICAgICAgICd0aW1lc3RhbXAnOiBvWydkYXRldGltZSddCiAgICAgICAgfSBmb3IgbyBpbiBvcmRlcnNdCiAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgcmV0dXJuIHsnZXJyb3InOiBzdHIoZSl9"><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-9-8')" type="button">Run</button></div><pre><code><span class="k">def</span> <span class="nf">fetch_order_history</span><span class="p">(</span><span class="n">exchange</span><span class="p">,</span> <span class="n">symbol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">50</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Fetch recent order history.&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">symbol</span><span class="p">:</span>
            <span class="n">orders</span> <span class="o">=</span> <span class="n">exchange</span><span class="o">.</span><span class="n">fetch_orders</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">orders</span> <span class="o">=</span> <span class="n">exchange</span><span class="o">.</span><span class="n">fetch_orders</span><span class="p">(</span><span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="p">[{</span>
            <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">o</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span>
            <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">o</span><span class="p">[</span><span class="s1">&#39;symbol&#39;</span><span class="p">],</span>
            <span class="s1">&#39;side&#39;</span><span class="p">:</span> <span class="n">o</span><span class="p">[</span><span class="s1">&#39;side&#39;</span><span class="p">],</span>
            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="n">o</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">],</span>
            <span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="n">o</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">],</span>
            <span class="s1">&#39;amount&#39;</span><span class="p">:</span> <span class="n">o</span><span class="p">[</span><span class="s1">&#39;amount&#39;</span><span class="p">],</span>
            <span class="s1">&#39;filled&#39;</span><span class="p">:</span> <span class="n">o</span><span class="p">[</span><span class="s1">&#39;filled&#39;</span><span class="p">],</span>
            <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="n">o</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">],</span>
            <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">o</span><span class="p">[</span><span class="s1">&#39;datetime&#39;</span><span class="p">]</span>
        <span class="p">}</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">orders</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>
</code></pre><div class="code-output" id="output-cell-9-8"></div></div>
<div class="md-cell"><h3>âœï¸ Exercise 9.3: Account Dashboard</h3>
<p>Create an account information dashboard.</p></div>
<div class="code-cell" id="cell-9-9" data-source="IyBFeGVyY2lzZSA5LjMKY2xhc3MgQWNjb3VudERhc2hib2FyZDoKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBleGNoYW5nZSk6CiAgICAgICAgc2VsZi5leGNoYW5nZSA9IGV4Y2hhbmdlCiAgICAKICAgIGRlZiBnZXRfcG9ydGZvbGlvX3ZhbHVlKHNlbGYsIHF1b3RlX2N1cnJlbmN5PSdVU0RUJyk6CiAgICAgICAgIyBUT0RPOiBDYWxjdWxhdGUgdG90YWwgcG9ydGZvbGlvIHZhbHVlCiAgICAgICAgcGFzcwogICAgCiAgICBkZWYgZ2V0X29wZW5fb3JkZXJzKHNlbGYpOgogICAgICAgICMgVE9ETwogICAgICAgIHBhc3MKICAgIAogICAgZGVmIGRpc3BsYXlfc3VtbWFyeShzZWxmKToKICAgICAgICAjIFRPRE86IFByaW50IGZvcm1hdHRlZCBzdW1tYXJ5CiAgICAgICAgcGFzcw=="><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-9-9')" type="button">Run</button></div><pre><code><span class="c1"># Exercise 9.3</span>
<span class="k">class</span> <span class="nc">AccountDashboard</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exchange</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span> <span class="o">=</span> <span class="n">exchange</span>
    
    <span class="k">def</span> <span class="nf">get_portfolio_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">quote_currency</span><span class="o">=</span><span class="s1">&#39;USDT&#39;</span><span class="p">):</span>
        <span class="c1"># TODO: Calculate total portfolio value</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">get_open_orders</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># TODO</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">display_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># TODO: Print formatted summary</span>
        <span class="k">pass</span>
</code></pre><div class="code-output" id="output-cell-9-9"></div></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">AccountDashboard</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exchange</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span> <span class="o">=</span> <span class="n">exchange</span>

    <span class="k">def</span> <span class="nf">get_portfolio_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">quote_currency</span><span class="o">=</span><span class="s1">&#39;USDT&#39;</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">balance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="o">.</span><span class="n">fetch_balance</span><span class="p">()</span>
            <span class="n">total_value</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">holdings</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">currency</span><span class="p">,</span> <span class="n">amount</span> <span class="ow">in</span> <span class="n">balance</span><span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">amount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">currency</span> <span class="o">==</span> <span class="n">quote_currency</span><span class="p">:</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="n">amount</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">ticker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="o">.</span><span class="n">fetch_ticker</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">currency</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">quote_currency</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                            <span class="n">value</span> <span class="o">=</span> <span class="n">amount</span> <span class="o">*</span> <span class="n">ticker</span><span class="p">[</span><span class="s1">&#39;last&#39;</span><span class="p">]</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">value</span> <span class="o">=</span> <span class="mi">0</span>

                    <span class="k">if</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="mf">0.01</span><span class="p">:</span>  <span class="c1"># Filter dust</span>
                        <span class="n">holdings</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                            <span class="s1">&#39;currency&#39;</span><span class="p">:</span> <span class="n">currency</span><span class="p">,</span>
                            <span class="s1">&#39;amount&#39;</span><span class="p">:</span> <span class="n">amount</span><span class="p">,</span>
                            <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">value</span>
                        <span class="p">})</span>
                        <span class="n">total_value</span> <span class="o">+=</span> <span class="n">value</span>

            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;total_value&#39;</span><span class="p">:</span> <span class="n">total_value</span><span class="p">,</span> <span class="s1">&#39;holdings&#39;</span><span class="p">:</span> <span class="n">holdings</span><span class="p">}</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>

    <span class="k">def</span> <span class="nf">get_open_orders</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="o">.</span><span class="n">fetch_open_orders</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>

    <span class="k">def</span> <span class="nf">display_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=&#39;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;       ACCOUNT SUMMARY&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=&#39;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>

        <span class="n">portfolio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_portfolio_value</span><span class="p">()</span>
        <span class="k">if</span> <span class="s1">&#39;error&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">portfolio</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total Value: $</span><span class="si">{</span><span class="n">portfolio</span><span class="p">[</span><span class="s1">&#39;total_value&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">,.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Holdings:&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">portfolio</span><span class="p">[</span><span class="s1">&#39;holdings&#39;</span><span class="p">],</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">h</span><span class="p">[</span><span class="s1">&#39;currency&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">h</span><span class="p">[</span><span class="s1">&#39;amount&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> ($</span><span class="si">{</span><span class="n">h</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">,.2f</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

        <span class="n">open_orders</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_open_orders</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">open_orders</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Open Orders: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">open_orders</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=&#39;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>Section 4: Rate Limits &amp; Best Practices</h1>
<h2>4.1 Understanding Rate Limits</h2></div>
<div class="code-cell" id="cell-9-10" data-source="aW1wb3J0IHRpbWUKCmNsYXNzIFJhdGVMaW1pdEhhbmRsZXI6CiAgICBkZWYgX19pbml0X18oc2VsZiwgcmVxdWVzdHNfcGVyX21pbnV0ZT02MCk6CiAgICAgICAgc2VsZi5yZXF1ZXN0c19wZXJfbWludXRlID0gcmVxdWVzdHNfcGVyX21pbnV0ZQogICAgICAgIHNlbGYucmVxdWVzdF90aW1lcyA9IFtdCiAgICAKICAgIGRlZiB3YWl0X2lmX25lZWRlZChzZWxmKToKICAgICAgICAiIiJXYWl0IGlmIHdlJ3JlIGFwcHJvYWNoaW5nIHJhdGUgbGltaXQuIiIiCiAgICAgICAgbm93ID0gdGltZS50aW1lKCkKICAgICAgICBtaW51dGVfYWdvID0gbm93IC0gNjAKICAgICAgICAKICAgICAgICAjIFJlbW92ZSBvbGQgcmVxdWVzdHMKICAgICAgICBzZWxmLnJlcXVlc3RfdGltZXMgPSBbdCBmb3IgdCBpbiBzZWxmLnJlcXVlc3RfdGltZXMgaWYgdCA+IG1pbnV0ZV9hZ29dCiAgICAgICAgCiAgICAgICAgaWYgbGVuKHNlbGYucmVxdWVzdF90aW1lcykgPj0gc2VsZi5yZXF1ZXN0c19wZXJfbWludXRlOgogICAgICAgICAgICBzbGVlcF90aW1lID0gc2VsZi5yZXF1ZXN0X3RpbWVzWzBdIC0gbWludXRlX2FnbyArIDAuMQogICAgICAgICAgICBwcmludChmJ1JhdGUgbGltaXQ6IHNsZWVwaW5nIHtzbGVlcF90aW1lOi4yZn1zJykKICAgICAgICAgICAgdGltZS5zbGVlcChzbGVlcF90aW1lKQogICAgICAgIAogICAgICAgIHNlbGYucmVxdWVzdF90aW1lcy5hcHBlbmQobm93KQogICAgCiAgICBkZWYgZ2V0X3VzYWdlKHNlbGYpOgogICAgICAgICIiIlJldHVybiBjdXJyZW50IHJhdGUgbGltaXQgdXNhZ2UuIiIiCiAgICAgICAgbm93ID0gdGltZS50aW1lKCkKICAgICAgICBtaW51dGVfYWdvID0gbm93IC0gNjAKICAgICAgICByZWNlbnQgPSBsZW4oW3QgZm9yIHQgaW4gc2VsZi5yZXF1ZXN0X3RpbWVzIGlmIHQgPiBtaW51dGVfYWdvXSkKICAgICAgICByZXR1cm4gewogICAgICAgICAgICAndXNlZCc6IHJlY2VudCwKICAgICAgICAgICAgJ2xpbWl0Jzogc2VsZi5yZXF1ZXN0c19wZXJfbWludXRlLAogICAgICAgICAgICAncmVtYWluaW5nJzogc2VsZi5yZXF1ZXN0c19wZXJfbWludXRlIC0gcmVjZW50CiAgICAgICAgfQ=="><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-9-10')" type="button">Run</button></div><pre><code><span class="kn">import</span> <span class="nn">time</span>

<span class="k">class</span> <span class="nc">RateLimitHandler</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">requests_per_minute</span><span class="o">=</span><span class="mi">60</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">requests_per_minute</span> <span class="o">=</span> <span class="n">requests_per_minute</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request_times</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">def</span> <span class="nf">wait_if_needed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Wait if we&#39;re approaching rate limit.&quot;&quot;&quot;</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">minute_ago</span> <span class="o">=</span> <span class="n">now</span> <span class="o">-</span> <span class="mi">60</span>
        
        <span class="c1"># Remove old requests</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request_times</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">request_times</span> <span class="k">if</span> <span class="n">t</span> <span class="o">&gt;</span> <span class="n">minute_ago</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request_times</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">requests_per_minute</span><span class="p">:</span>
            <span class="n">sleep_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request_times</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">minute_ago</span> <span class="o">+</span> <span class="mf">0.1</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Rate limit: sleeping </span><span class="si">{</span><span class="n">sleep_time</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">s&#39;</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">sleep_time</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">request_times</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">now</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">get_usage</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return current rate limit usage.&quot;&quot;&quot;</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">minute_ago</span> <span class="o">=</span> <span class="n">now</span> <span class="o">-</span> <span class="mi">60</span>
        <span class="n">recent</span> <span class="o">=</span> <span class="nb">len</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">request_times</span> <span class="k">if</span> <span class="n">t</span> <span class="o">&gt;</span> <span class="n">minute_ago</span><span class="p">])</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;used&#39;</span><span class="p">:</span> <span class="n">recent</span><span class="p">,</span>
            <span class="s1">&#39;limit&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">requests_per_minute</span><span class="p">,</span>
            <span class="s1">&#39;remaining&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">requests_per_minute</span> <span class="o">-</span> <span class="n">recent</span>
        <span class="p">}</span>
</code></pre><div class="code-output" id="output-cell-9-10"></div></div>
<div class="md-cell"><h2>4.2 Exponential Backoff</h2></div>
<div class="code-cell" id="cell-9-11" data-source="ZGVmIGZldGNoX3dpdGhfcmV0cnkoZnVuYywgbWF4X3JldHJpZXM9NSwgYmFzZV9kZWxheT0xKToKICAgICIiIkV4ZWN1dGUgZnVuY3Rpb24gd2l0aCBleHBvbmVudGlhbCBiYWNrb2ZmIG9uIGZhaWx1cmUuIiIiCiAgICBmb3IgYXR0ZW1wdCBpbiByYW5nZShtYXhfcmV0cmllcyk6CiAgICAgICAgdHJ5OgogICAgICAgICAgICByZXR1cm4gZnVuYygpCiAgICAgICAgZXhjZXB0IGNjeHQuUmF0ZUxpbWl0RXhjZWVkZWQ6CiAgICAgICAgICAgIGRlbGF5ID0gYmFzZV9kZWxheSAqICgyICoqIGF0dGVtcHQpCiAgICAgICAgICAgIHByaW50KGYnUmF0ZSBsaW1pdGVkLiBXYWl0aW5nIHtkZWxheX1zLi4uJykKICAgICAgICAgICAgdGltZS5zbGVlcChkZWxheSkKICAgICAgICBleGNlcHQgY2N4dC5OZXR3b3JrRXJyb3IgYXMgZToKICAgICAgICAgICAgZGVsYXkgPSBiYXNlX2RlbGF5ICogKDIgKiogYXR0ZW1wdCkKICAgICAgICAgICAgcHJpbnQoZidOZXR3b3JrIGVycm9yLiBSZXRyeWluZyBpbiB7ZGVsYXl9cy4uLicpCiAgICAgICAgICAgIHRpbWUuc2xlZXAoZGVsYXkpCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBwcmludChmJ0Vycm9yOiB7ZX0nKQogICAgICAgICAgICByYWlzZQogICAgCiAgICByYWlzZSBFeGNlcHRpb24oZidGYWlsZWQgYWZ0ZXIge21heF9yZXRyaWVzfSBhdHRlbXB0cycp"><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-9-11')" type="button">Run</button></div><pre><code><span class="k">def</span> <span class="nf">fetch_with_retry</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">max_retries</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">base_delay</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Execute function with exponential backoff on failure.&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">attempt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_retries</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">func</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">ccxt</span><span class="o">.</span><span class="n">RateLimitExceeded</span><span class="p">:</span>
            <span class="n">delay</span> <span class="o">=</span> <span class="n">base_delay</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="n">attempt</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Rate limited. Waiting </span><span class="si">{</span><span class="n">delay</span><span class="si">}</span><span class="s1">s...&#39;</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">delay</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">ccxt</span><span class="o">.</span><span class="n">NetworkError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">delay</span> <span class="o">=</span> <span class="n">base_delay</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="n">attempt</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Network error. Retrying in </span><span class="si">{</span><span class="n">delay</span><span class="si">}</span><span class="s1">s...&#39;</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">delay</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">raise</span>
    
    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Failed after </span><span class="si">{</span><span class="n">max_retries</span><span class="si">}</span><span class="s1"> attempts&#39;</span><span class="p">)</span>
</code></pre><div class="code-output" id="output-cell-9-11"></div></div>
<div class="md-cell"><h3>âœï¸ Exercise 9.4: Rate Limit Handler</h3>
<p>Build a comprehensive rate limit handler with multiple strategies.</p></div>
<div class="code-cell" id="cell-9-12" data-source="IyBFeGVyY2lzZSA5LjQKY2xhc3MgQWR2YW5jZWRSYXRlTGltaXRlcjoKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBleGNoYW5nZSk6CiAgICAgICAgc2VsZi5leGNoYW5nZSA9IGV4Y2hhbmdlCiAgICAgICAgc2VsZi5yZXF1ZXN0X2hpc3RvcnkgPSBbXQogICAgCiAgICBkZWYgc2FmZV9yZXF1ZXN0KHNlbGYsIGZ1bmMsICphcmdzLCAqKmt3YXJncyk6CiAgICAgICAgIyBUT0RPOiBFeGVjdXRlIHdpdGggcmF0ZSBsaW1pdGluZyBhbmQgcmV0cnkKICAgICAgICBwYXNzCiAgICAKICAgIGRlZiBiYXRjaF9yZXF1ZXN0cyhzZWxmLCBmdW5jcyk6CiAgICAgICAgIyBUT0RPOiBFeGVjdXRlIG11bHRpcGxlIHJlcXVlc3RzIHdpdGggcmF0ZSBsaW1pdGluZwogICAgICAgIHBhc3M="><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-9-12')" type="button">Run</button></div><pre><code><span class="c1"># Exercise 9.4</span>
<span class="k">class</span> <span class="nc">AdvancedRateLimiter</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exchange</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span> <span class="o">=</span> <span class="n">exchange</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request_history</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">def</span> <span class="nf">safe_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># TODO: Execute with rate limiting and retry</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">batch_requests</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">funcs</span><span class="p">):</span>
        <span class="c1"># TODO: Execute multiple requests with rate limiting</span>
        <span class="k">pass</span>
</code></pre><div class="code-output" id="output-cell-9-12"></div></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">AdvancedRateLimiter</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exchange</span><span class="p">,</span> <span class="n">requests_per_second</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span> <span class="o">=</span> <span class="n">exchange</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">requests_per_second</span> <span class="o">=</span> <span class="n">requests_per_second</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request_history</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">consecutive_errors</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">_wait_for_slot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">second_ago</span> <span class="o">=</span> <span class="n">now</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request_history</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">request_history</span> <span class="k">if</span> <span class="n">t</span> <span class="o">&gt;</span> <span class="n">second_ago</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request_history</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">requests_per_second</span><span class="p">:</span>
            <span class="n">sleep_time</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">request_history</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="mf">0.05</span>
            <span class="k">if</span> <span class="n">sleep_time</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">sleep_time</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">request_history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">safe_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">max_retries</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">attempt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_retries</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_wait_for_slot</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">consecutive_errors</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">return</span> <span class="n">result</span>
            <span class="k">except</span> <span class="n">ccxt</span><span class="o">.</span><span class="n">RateLimitExceeded</span><span class="p">:</span>
                <span class="n">delay</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">**</span> <span class="p">(</span><span class="n">attempt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Rate limited, waiting </span><span class="si">{</span><span class="n">delay</span><span class="si">}</span><span class="s1">s&#39;</span><span class="p">)</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">delay</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">consecutive_errors</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">except</span> <span class="n">ccxt</span><span class="o">.</span><span class="n">NetworkError</span><span class="p">:</span>
                <span class="n">delay</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">**</span> <span class="n">attempt</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">delay</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">consecutive_errors</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Max retries exceeded&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">batch_requests</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">funcs</span><span class="p">,</span> <span class="n">delay_between</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">func</span> <span class="ow">in</span> <span class="n">funcs</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">safe_request</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">delay_between</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">results</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>ğŸ—ï¸ Module Project: Exchange API Wrapper</h1>
<p>Build a complete exchange API wrapper combining all concepts.</p></div>
<div class="code-cell" id="cell-9-13" data-source="IyBNb2R1bGUgUHJvamVjdApjbGFzcyBFeGNoYW5nZUFQSVdyYXBwZXI6CiAgICBkZWYgX19pbml0X18oc2VsZiwgZXhjaGFuZ2VfaWQ9J2JpbmFuY2UnKToKICAgICAgICBzZWxmLmV4Y2hhbmdlX2lkID0gZXhjaGFuZ2VfaWQKICAgICAgICBzZWxmLmV4Y2hhbmdlID0gTm9uZQogICAgICAgIHNlbGYucmF0ZV9saW1pdGVyID0gTm9uZQogICAgICAgIHNlbGYuY29ubmVjdGVkID0gRmFsc2UKICAgIAogICAgZGVmIGNvbm5lY3Qoc2VsZiwgc2FuZGJveD1UcnVlKToKICAgICAgICAjIFRPRE86IFNlY3VyZSBjb25uZWN0aW9uIHNldHVwCiAgICAgICAgcGFzcwogICAgCiAgICBkZWYgZ2V0X3ByaWNlKHNlbGYsIHN5bWJvbCk6CiAgICAgICAgIyBUT0RPOiBSYXRlLWxpbWl0ZWQgcHJpY2UgZmV0Y2gKICAgICAgICBwYXNzCiAgICAKICAgIGRlZiBnZXRfYmFsYW5jZShzZWxmKToKICAgICAgICAjIFRPRE86IEFjY291bnQgYmFsYW5jZQogICAgICAgIHBhc3MKICAgIAogICAgZGVmIGdldF9vaGxjdihzZWxmLCBzeW1ib2wsIHRpbWVmcmFtZSwgbGltaXQpOgogICAgICAgICMgVE9ETzogSGlzdG9yaWNhbCBkYXRhCiAgICAgICAgcGFzcwogICAgCiAgICBkZWYgaGVhbHRoX2NoZWNrKHNlbGYpOgogICAgICAgICMgVE9ETzogVmVyaWZ5IGNvbm5lY3Rpb24gaGVhbHRoCiAgICAgICAgcGFzcw=="><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-9-13')" type="button">Run</button></div><pre><code><span class="c1"># Module Project</span>
<span class="k">class</span> <span class="nc">ExchangeAPIWrapper</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exchange_id</span><span class="o">=</span><span class="s1">&#39;binance&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exchange_id</span> <span class="o">=</span> <span class="n">exchange_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rate_limiter</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connected</span> <span class="o">=</span> <span class="kc">False</span>
    
    <span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sandbox</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="c1"># TODO: Secure connection setup</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">get_price</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">):</span>
        <span class="c1"># TODO: Rate-limited price fetch</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">get_balance</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># TODO: Account balance</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">get_ohlcv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">timeframe</span><span class="p">,</span> <span class="n">limit</span><span class="p">):</span>
        <span class="c1"># TODO: Historical data</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">health_check</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># TODO: Verify connection health</span>
        <span class="k">pass</span>
</code></pre><div class="code-output" id="output-cell-9-13"></div></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">ExchangeAPIWrapper</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exchange_id</span><span class="o">=</span><span class="s1">&#39;binance&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exchange_id</span> <span class="o">=</span> <span class="n">exchange_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rate_limiter</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connected</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sandbox</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">api_key</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">exchange_id</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s1">_API_KEY&#39;</span><span class="p">)</span>
        <span class="n">api_secret</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">exchange_id</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s1">_API_SECRET&#39;</span><span class="p">)</span>

        <span class="n">exchange_class</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">ccxt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">exchange_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span> <span class="o">=</span> <span class="n">exchange_class</span><span class="p">({</span>
            <span class="s1">&#39;apiKey&#39;</span><span class="p">:</span> <span class="n">api_key</span><span class="p">,</span>
            <span class="s1">&#39;secret&#39;</span><span class="p">:</span> <span class="n">api_secret</span><span class="p">,</span>
            <span class="s1">&#39;sandbox&#39;</span><span class="p">:</span> <span class="n">sandbox</span><span class="p">,</span>
            <span class="s1">&#39;enableRateLimit&#39;</span><span class="p">:</span> <span class="kc">True</span>
        <span class="p">})</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">rate_limiter</span> <span class="o">=</span> <span class="n">AdvancedRateLimiter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="o">.</span><span class="n">load_markets</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connected</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">get_price</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">rate_limiter</span><span class="o">.</span><span class="n">safe_request</span><span class="p">(</span>
            <span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="o">.</span><span class="n">fetch_ticker</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_balance</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">rate_limiter</span><span class="o">.</span><span class="n">safe_request</span><span class="p">(</span>
            <span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="o">.</span><span class="n">fetch_balance</span><span class="p">()</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_ohlcv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">timeframe</span><span class="o">=</span><span class="s1">&#39;1h&#39;</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
        <span class="n">ohlcv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rate_limiter</span><span class="o">.</span><span class="n">safe_request</span><span class="p">(</span>
            <span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="o">.</span><span class="n">fetch_ohlcv</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">timeframe</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">ohlcv</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">,</span> <span class="s1">&#39;open&#39;</span><span class="p">,</span> <span class="s1">&#39;high&#39;</span><span class="p">,</span> <span class="s1">&#39;low&#39;</span><span class="p">,</span> <span class="s1">&#39;close&#39;</span><span class="p">,</span> <span class="s1">&#39;volume&#39;</span><span class="p">])</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">],</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;ms&#39;</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;timestamp&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span>

    <span class="k">def</span> <span class="nf">health_check</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="o">.</span><span class="n">fetch_status</span><span class="p">()</span>
            <span class="n">ticker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_price</span><span class="p">(</span><span class="s1">&#39;BTC/USDT&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s1">&#39;connected&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">connected</span><span class="p">,</span>
                <span class="s1">&#39;exchange_status&#39;</span><span class="p">:</span> <span class="n">status</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;status&#39;</span><span class="p">,</span> <span class="s1">&#39;unknown&#39;</span><span class="p">),</span>
                <span class="s1">&#39;btc_price&#39;</span><span class="p">:</span> <span class="n">ticker</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;last&#39;</span><span class="p">),</span>
                <span class="s1">&#39;healthy&#39;</span><span class="p">:</span> <span class="kc">True</span>
            <span class="p">}</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;healthy&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>

<span class="c1"># Usage</span>
<span class="n">api</span> <span class="o">=</span> <span class="n">ExchangeAPIWrapper</span><span class="p">(</span><span class="s1">&#39;binance&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">sandbox</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">api</span><span class="o">.</span><span class="n">health_check</span><span class="p">())</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>ğŸ“ Key Takeaways</h1>
<ol>
<li><strong>Security First</strong>: Never hardcode API keys; use environment variables</li>
<li><strong>CCXT Unified API</strong>: Access 100+ exchanges with same interface</li>
<li><strong>Rate Limits</strong>: Always implement proper rate limiting and backoff</li>
<li><strong>Caching</strong>: Cache frequently accessed data to reduce API calls</li>
</ol>
<hr />
<p><em>Next: Module 10 - Order Execution</em></p></div>
        <div class="nav-buttons">
            <button class="nav-btn prev-btn disabled" type="button">
                <span class="nav-btn-label">â† Previous</span>
                <span class="nav-btn-name"></span>
            </button>
            <button class="nav-btn next-btn disabled" type="button">
                <span class="nav-btn-label">Next â†’</span>
                <span class="nav-btn-name"></span>
            </button>
        </div>
        </div>
<div class="module-section" data-idx="10"><div class="md-cell module-header"><h1>Module 10: Order Execution</h1>
<h2>Part 3: Exchange Integration</h2>
<hr />
<div class="table-wrapper"><table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>â±ï¸ <strong>Duration</strong></td>
<td>~2.5 hours</td>
</tr>
<tr>
<td>ğŸ“‹ <strong>Prerequisites</strong></td>
<td>Module 9</td>
</tr>
<tr>
<td>ğŸ’ª <strong>Exercises</strong></td>
<td>5 total</td>
</tr>
</tbody>
</table></div></div>
<div class="md-cell"><h2>ğŸ¯ Learning Objectives</h2>
<ul>
<li>Understand different order types</li>
<li>Place orders programmatically</li>
<li>Manage open orders</li>
<li>Analyze execution quality</li>
</ul></div>
<div class="md-cell"><hr />
<h1>Section 1: Order Types</h1>
<h2>1.1 Market Orders</h2>
<p>Execute immediately at best available price.</p></div>
<div class="code-cell" id="cell-10-0" data-source="aW1wb3J0IGNjeHQKaW1wb3J0IG9zCmZyb20gZGF0ZXRpbWUgaW1wb3J0IGRhdGV0aW1lCgojIE9yZGVyIHR5cGUgY29tcGFyaXNvbgpvcmRlcl90eXBlcyA9IHsKICAgICdtYXJrZXQnOiB7CiAgICAgICAgJ2V4ZWN1dGlvbic6ICdJbW1lZGlhdGUnLAogICAgICAgICdwcmljZV9ndWFyYW50ZWUnOiAnTm8nLAogICAgICAgICdiZXN0X2Zvcic6ICdGYXN0IGV4ZWN1dGlvbiBuZWVkZWQnLAogICAgICAgICdyaXNrJzogJ1NsaXBwYWdlIGluIHZvbGF0aWxlIG1hcmtldHMnCiAgICB9LAogICAgJ2xpbWl0JzogewogICAgICAgICdleGVjdXRpb24nOiAnV2hlbiBwcmljZSByZWFjaGVkJywKICAgICAgICAncHJpY2VfZ3VhcmFudGVlJzogJ1llcycsCiAgICAgICAgJ2Jlc3RfZm9yJzogJ1ByaWNlIGNvbnRyb2wnLAogICAgICAgICdyaXNrJzogJ01heSBub3QgZmlsbCcKICAgIH0sCiAgICAnc3RvcCc6IHsKICAgICAgICAnZXhlY3V0aW9uJzogJ1doZW4gc3RvcCBwcmljZSBoaXQnLAogICAgICAgICdwcmljZV9ndWFyYW50ZWUnOiAnTm8nLAogICAgICAgICdiZXN0X2Zvcic6ICdTdG9wIGxvc3NlcycsCiAgICAgICAgJ3Jpc2snOiAnR2FwIHRocm91Z2ggc3RvcCcKICAgIH0sCiAgICAnc3RvcF9saW1pdCc6IHsKICAgICAgICAnZXhlY3V0aW9uJzogJ0xpbWl0IG9yZGVyIGFmdGVyIHN0b3AgaGl0JywKICAgICAgICAncHJpY2VfZ3VhcmFudGVlJzogJ1llcyAoaWYgZmlsbGVkKScsCiAgICAgICAgJ2Jlc3RfZm9yJzogJ0NvbnRyb2xsZWQgc3RvcCBsb3NzZXMnLAogICAgICAgICdyaXNrJzogJ01heSBub3QgZmlsbCBpbiBmYXN0IG1hcmtldHMnCiAgICB9Cn0KCmZvciBvdHlwZSwgZGV0YWlscyBpbiBvcmRlcl90eXBlcy5pdGVtcygpOgogICAgcHJpbnQoZiJcbntvdHlwZS51cHBlcigpfToiKQogICAgZm9yIGssIHYgaW4gZGV0YWlscy5pdGVtcygpOgogICAgICAgIHByaW50KGYiICB7a306IHt2fSIp"><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-10-0')" type="button">Run</button></div><pre><code><span class="kn">import</span> <span class="nn">ccxt</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>

<span class="c1"># Order type comparison</span>
<span class="n">order_types</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;market&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;execution&#39;</span><span class="p">:</span> <span class="s1">&#39;Immediate&#39;</span><span class="p">,</span>
        <span class="s1">&#39;price_guarantee&#39;</span><span class="p">:</span> <span class="s1">&#39;No&#39;</span><span class="p">,</span>
        <span class="s1">&#39;best_for&#39;</span><span class="p">:</span> <span class="s1">&#39;Fast execution needed&#39;</span><span class="p">,</span>
        <span class="s1">&#39;risk&#39;</span><span class="p">:</span> <span class="s1">&#39;Slippage in volatile markets&#39;</span>
    <span class="p">},</span>
    <span class="s1">&#39;limit&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;execution&#39;</span><span class="p">:</span> <span class="s1">&#39;When price reached&#39;</span><span class="p">,</span>
        <span class="s1">&#39;price_guarantee&#39;</span><span class="p">:</span> <span class="s1">&#39;Yes&#39;</span><span class="p">,</span>
        <span class="s1">&#39;best_for&#39;</span><span class="p">:</span> <span class="s1">&#39;Price control&#39;</span><span class="p">,</span>
        <span class="s1">&#39;risk&#39;</span><span class="p">:</span> <span class="s1">&#39;May not fill&#39;</span>
    <span class="p">},</span>
    <span class="s1">&#39;stop&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;execution&#39;</span><span class="p">:</span> <span class="s1">&#39;When stop price hit&#39;</span><span class="p">,</span>
        <span class="s1">&#39;price_guarantee&#39;</span><span class="p">:</span> <span class="s1">&#39;No&#39;</span><span class="p">,</span>
        <span class="s1">&#39;best_for&#39;</span><span class="p">:</span> <span class="s1">&#39;Stop losses&#39;</span><span class="p">,</span>
        <span class="s1">&#39;risk&#39;</span><span class="p">:</span> <span class="s1">&#39;Gap through stop&#39;</span>
    <span class="p">},</span>
    <span class="s1">&#39;stop_limit&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;execution&#39;</span><span class="p">:</span> <span class="s1">&#39;Limit order after stop hit&#39;</span><span class="p">,</span>
        <span class="s1">&#39;price_guarantee&#39;</span><span class="p">:</span> <span class="s1">&#39;Yes (if filled)&#39;</span><span class="p">,</span>
        <span class="s1">&#39;best_for&#39;</span><span class="p">:</span> <span class="s1">&#39;Controlled stop losses&#39;</span><span class="p">,</span>
        <span class="s1">&#39;risk&#39;</span><span class="p">:</span> <span class="s1">&#39;May not fill in fast markets&#39;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">for</span> <span class="n">otype</span><span class="p">,</span> <span class="n">details</span> <span class="ow">in</span> <span class="n">order_types</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">otype</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">details</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre><div class="code-output" id="output-cell-10-0"></div></div>
<div class="md-cell"><h2>1.2 Order Parameters</h2></div>
<div class="code-cell" id="cell-10-1" data-source="Y2xhc3MgT3JkZXJCdWlsZGVyOgogICAgIiIiSGVscGVyIGNsYXNzIHRvIGJ1aWxkIHZhbGlkIG9yZGVycy4iIiIKICAgIAogICAgZGVmIF9faW5pdF9fKHNlbGYsIGV4Y2hhbmdlKToKICAgICAgICBzZWxmLmV4Y2hhbmdlID0gZXhjaGFuZ2UKICAgIAogICAgZGVmIG1hcmtldF9idXkoc2VsZiwgc3ltYm9sLCBhbW91bnQpOgogICAgICAgICIiIkNyZWF0ZSBtYXJrZXQgYnV5IG9yZGVyIHBhcmFtZXRlcnMuIiIiCiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgJ3N5bWJvbCc6IHN5bWJvbCwKICAgICAgICAgICAgJ3R5cGUnOiAnbWFya2V0JywKICAgICAgICAgICAgJ3NpZGUnOiAnYnV5JywKICAgICAgICAgICAgJ2Ftb3VudCc6IGFtb3VudAogICAgICAgIH0KICAgIAogICAgZGVmIG1hcmtldF9zZWxsKHNlbGYsIHN5bWJvbCwgYW1vdW50KToKICAgICAgICAiIiJDcmVhdGUgbWFya2V0IHNlbGwgb3JkZXIgcGFyYW1ldGVycy4iIiIKICAgICAgICByZXR1cm4gewogICAgICAgICAgICAnc3ltYm9sJzogc3ltYm9sLAogICAgICAgICAgICAndHlwZSc6ICdtYXJrZXQnLAogICAgICAgICAgICAnc2lkZSc6ICdzZWxsJywKICAgICAgICAgICAgJ2Ftb3VudCc6IGFtb3VudAogICAgICAgIH0KICAgIAogICAgZGVmIGxpbWl0X2J1eShzZWxmLCBzeW1ib2wsIGFtb3VudCwgcHJpY2UpOgogICAgICAgICIiIkNyZWF0ZSBsaW1pdCBidXkgb3JkZXIgcGFyYW1ldGVycy4iIiIKICAgICAgICByZXR1cm4gewogICAgICAgICAgICAnc3ltYm9sJzogc3ltYm9sLAogICAgICAgICAgICAndHlwZSc6ICdsaW1pdCcsCiAgICAgICAgICAgICdzaWRlJzogJ2J1eScsCiAgICAgICAgICAgICdhbW91bnQnOiBhbW91bnQsCiAgICAgICAgICAgICdwcmljZSc6IHByaWNlCiAgICAgICAgfQogICAgCiAgICBkZWYgbGltaXRfc2VsbChzZWxmLCBzeW1ib2wsIGFtb3VudCwgcHJpY2UpOgogICAgICAgICIiIkNyZWF0ZSBsaW1pdCBzZWxsIG9yZGVyIHBhcmFtZXRlcnMuIiIiCiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgJ3N5bWJvbCc6IHN5bWJvbCwKICAgICAgICAgICAgJ3R5cGUnOiAnbGltaXQnLAogICAgICAgICAgICAnc2lkZSc6ICdzZWxsJywKICAgICAgICAgICAgJ2Ftb3VudCc6IGFtb3VudCwKICAgICAgICAgICAgJ3ByaWNlJzogcHJpY2UKICAgICAgICB9CiAgICAKICAgIGRlZiBzdG9wX2xvc3Moc2VsZiwgc3ltYm9sLCBhbW91bnQsIHN0b3BfcHJpY2UpOgogICAgICAgICIiIkNyZWF0ZSBzdG9wIGxvc3Mgb3JkZXIgcGFyYW1ldGVycy4iIiIKICAgICAgICByZXR1cm4gewogICAgICAgICAgICAnc3ltYm9sJzogc3ltYm9sLAogICAgICAgICAgICAndHlwZSc6ICdzdG9wJywKICAgICAgICAgICAgJ3NpZGUnOiAnc2VsbCcsCiAgICAgICAgICAgICdhbW91bnQnOiBhbW91bnQsCiAgICAgICAgICAgICdzdG9wUHJpY2UnOiBzdG9wX3ByaWNlCiAgICAgICAgfQogICAgCiAgICBkZWYgdmFsaWRhdGVfb3JkZXIoc2VsZiwgb3JkZXJfcGFyYW1zKToKICAgICAgICAiIiJWYWxpZGF0ZSBvcmRlciBhZ2FpbnN0IGV4Y2hhbmdlIGxpbWl0cy4iIiIKICAgICAgICBzeW1ib2wgPSBvcmRlcl9wYXJhbXNbJ3N5bWJvbCddCiAgICAgICAgbWFya2V0ID0gc2VsZi5leGNoYW5nZS5tYXJrZXQoc3ltYm9sKQogICAgICAgIAogICAgICAgIGNoZWNrcyA9IFtdCiAgICAgICAgYW1vdW50ID0gb3JkZXJfcGFyYW1zLmdldCgnYW1vdW50JywgMCkKICAgICAgICBwcmljZSA9IG9yZGVyX3BhcmFtcy5nZXQoJ3ByaWNlJywgMCkKICAgICAgICAKICAgICAgICAjIENoZWNrIG1pbmltdW0gYW1vdW50CiAgICAgICAgbWluX2Ftb3VudCA9IG1hcmtldC5nZXQoJ2xpbWl0cycsIHt9KS5nZXQoJ2Ftb3VudCcsIHt9KS5nZXQoJ21pbicsIDApCiAgICAgICAgaWYgYW1vdW50IDwgbWluX2Ftb3VudDoKICAgICAgICAgICAgY2hlY2tzLmFwcGVuZChmJ0Ftb3VudCB7YW1vdW50fSBiZWxvdyBtaW5pbXVtIHttaW5fYW1vdW50fScpCiAgICAgICAgCiAgICAgICAgIyBDaGVjayBwcmljZSBwcmVjaXNpb24KICAgICAgICBpZiBwcmljZToKICAgICAgICAgICAgcHJlY2lzaW9uID0gbWFya2V0LmdldCgncHJlY2lzaW9uJywge30pLmdldCgncHJpY2UnLCA4KQogICAgICAgICAgICAjIFJvdW5kIHRvIHByZWNpc2lvbgogICAgICAgICAgICBvcmRlcl9wYXJhbXNbJ3ByaWNlJ10gPSByb3VuZChwcmljZSwgcHJlY2lzaW9uKQogICAgICAgIAogICAgICAgIHJldHVybiB7J3ZhbGlkJzogbGVuKGNoZWNrcykgPT0gMCwgJ2lzc3Vlcyc6IGNoZWNrcywgJ29yZGVyJzogb3JkZXJfcGFyYW1zfQ=="><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-10-1')" type="button">Run</button></div><pre><code><span class="k">class</span> <span class="nc">OrderBuilder</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Helper class to build valid orders.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exchange</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span> <span class="o">=</span> <span class="n">exchange</span>
    
    <span class="k">def</span> <span class="nf">market_buy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create market buy order parameters.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span>
            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;market&#39;</span><span class="p">,</span>
            <span class="s1">&#39;side&#39;</span><span class="p">:</span> <span class="s1">&#39;buy&#39;</span><span class="p">,</span>
            <span class="s1">&#39;amount&#39;</span><span class="p">:</span> <span class="n">amount</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">market_sell</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create market sell order parameters.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span>
            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;market&#39;</span><span class="p">,</span>
            <span class="s1">&#39;side&#39;</span><span class="p">:</span> <span class="s1">&#39;sell&#39;</span><span class="p">,</span>
            <span class="s1">&#39;amount&#39;</span><span class="p">:</span> <span class="n">amount</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">limit_buy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">price</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create limit buy order parameters.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span>
            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;limit&#39;</span><span class="p">,</span>
            <span class="s1">&#39;side&#39;</span><span class="p">:</span> <span class="s1">&#39;buy&#39;</span><span class="p">,</span>
            <span class="s1">&#39;amount&#39;</span><span class="p">:</span> <span class="n">amount</span><span class="p">,</span>
            <span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="n">price</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">limit_sell</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">price</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create limit sell order parameters.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span>
            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;limit&#39;</span><span class="p">,</span>
            <span class="s1">&#39;side&#39;</span><span class="p">:</span> <span class="s1">&#39;sell&#39;</span><span class="p">,</span>
            <span class="s1">&#39;amount&#39;</span><span class="p">:</span> <span class="n">amount</span><span class="p">,</span>
            <span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="n">price</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">stop_loss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">stop_price</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create stop loss order parameters.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span>
            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;stop&#39;</span><span class="p">,</span>
            <span class="s1">&#39;side&#39;</span><span class="p">:</span> <span class="s1">&#39;sell&#39;</span><span class="p">,</span>
            <span class="s1">&#39;amount&#39;</span><span class="p">:</span> <span class="n">amount</span><span class="p">,</span>
            <span class="s1">&#39;stopPrice&#39;</span><span class="p">:</span> <span class="n">stop_price</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">validate_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order_params</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Validate order against exchange limits.&quot;&quot;&quot;</span>
        <span class="n">symbol</span> <span class="o">=</span> <span class="n">order_params</span><span class="p">[</span><span class="s1">&#39;symbol&#39;</span><span class="p">]</span>
        <span class="n">market</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="o">.</span><span class="n">market</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
        
        <span class="n">checks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">amount</span> <span class="o">=</span> <span class="n">order_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;amount&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">price</span> <span class="o">=</span> <span class="n">order_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;price&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        
        <span class="c1"># Check minimum amount</span>
        <span class="n">min_amount</span> <span class="o">=</span> <span class="n">market</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;limits&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;amount&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;min&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">amount</span> <span class="o">&lt;</span> <span class="n">min_amount</span><span class="p">:</span>
            <span class="n">checks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Amount </span><span class="si">{</span><span class="n">amount</span><span class="si">}</span><span class="s1"> below minimum </span><span class="si">{</span><span class="n">min_amount</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        
        <span class="c1"># Check price precision</span>
        <span class="k">if</span> <span class="n">price</span><span class="p">:</span>
            <span class="n">precision</span> <span class="o">=</span> <span class="n">market</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;precision&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;price&#39;</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
            <span class="c1"># Round to precision</span>
            <span class="n">order_params</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">price</span><span class="p">,</span> <span class="n">precision</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;valid&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">checks</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;issues&#39;</span><span class="p">:</span> <span class="n">checks</span><span class="p">,</span> <span class="s1">&#39;order&#39;</span><span class="p">:</span> <span class="n">order_params</span><span class="p">}</span>
</code></pre><div class="code-output" id="output-cell-10-1"></div></div>
<div class="md-cell"><h3>âœï¸ Exercise 10.1: Order Type Comparison</h3>
<p>Create a function that recommends the best order type based on market conditions.</p></div>
<div class="code-cell" id="cell-10-2" data-source="IyBFeGVyY2lzZSAxMC4xCmRlZiByZWNvbW1lbmRfb3JkZXJfdHlwZSh1cmdlbmN5LCBwcmljZV9zZW5zaXRpdml0eSwgdm9sYXRpbGl0eSwgb3JkZXJfYm9va19kZXB0aCk6CiAgICAiIiIKICAgIFJlY29tbWVuZCBvcmRlciB0eXBlIGJhc2VkIG9uIGNvbmRpdGlvbnMuCiAgICAKICAgIHVyZ2VuY3k6ICdoaWdoJywgJ21lZGl1bScsICdsb3cnCiAgICBwcmljZV9zZW5zaXRpdml0eTogJ2hpZ2gnLCAnbWVkaXVtJywgJ2xvdycKICAgIHZvbGF0aWxpdHk6IGZsb2F0IChlLmcuLCAwLjA1IGZvciA1JSkKICAgIG9yZGVyX2Jvb2tfZGVwdGg6ICdkZWVwJywgJ3NoYWxsb3cnCiAgICAiIiIKICAgICMgVE9ETzogSW1wbGVtZW50IHJlY29tbWVuZGF0aW9uIGxvZ2ljCiAgICBwYXNz"><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-10-2')" type="button">Run</button></div><pre><code><span class="c1"># Exercise 10.1</span>
<span class="k">def</span> <span class="nf">recommend_order_type</span><span class="p">(</span><span class="n">urgency</span><span class="p">,</span> <span class="n">price_sensitivity</span><span class="p">,</span> <span class="n">volatility</span><span class="p">,</span> <span class="n">order_book_depth</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Recommend order type based on conditions.</span>
<span class="sd">    </span>
<span class="sd">    urgency: &#39;high&#39;, &#39;medium&#39;, &#39;low&#39;</span>
<span class="sd">    price_sensitivity: &#39;high&#39;, &#39;medium&#39;, &#39;low&#39;</span>
<span class="sd">    volatility: float (e.g., 0.05 for 5%)</span>
<span class="sd">    order_book_depth: &#39;deep&#39;, &#39;shallow&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO: Implement recommendation logic</span>
    <span class="k">pass</span>
</code></pre><div class="code-output" id="output-cell-10-2"></div></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">recommend_order_type</span><span class="p">(</span><span class="n">urgency</span><span class="p">,</span> <span class="n">price_sensitivity</span><span class="p">,</span> <span class="n">volatility</span><span class="p">,</span> <span class="n">order_book_depth</span><span class="p">):</span>
    <span class="n">recommendations</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># High urgency scenarios</span>
    <span class="k">if</span> <span class="n">urgency</span> <span class="o">==</span> <span class="s1">&#39;high&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">order_book_depth</span> <span class="o">==</span> <span class="s1">&#39;deep&#39;</span> <span class="ow">and</span> <span class="n">volatility</span> <span class="o">&lt;</span> <span class="mf">0.02</span><span class="p">:</span>
            <span class="n">recommendations</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;market&#39;</span><span class="p">,</span>
                <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="s1">&#39;Deep book with low volatility - market order safe&#39;</span>
            <span class="p">})</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">recommendations</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;limit&#39;</span><span class="p">,</span>
                <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="s1">&#39;Use aggressive limit (near best ask/bid) for protection&#39;</span><span class="p">,</span>
                <span class="s1">&#39;tip&#39;</span><span class="p">:</span> <span class="s1">&#39;Set limit slightly worse than current price&#39;</span>
            <span class="p">})</span>

    <span class="c1"># Price sensitive scenarios</span>
    <span class="k">elif</span> <span class="n">price_sensitivity</span> <span class="o">==</span> <span class="s1">&#39;high&#39;</span><span class="p">:</span>
        <span class="n">recommendations</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;limit&#39;</span><span class="p">,</span>
            <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="s1">&#39;Price guarantee important&#39;</span><span class="p">,</span>
            <span class="s1">&#39;tip&#39;</span><span class="p">:</span> <span class="s1">&#39;May need to wait for fill&#39;</span>
        <span class="p">})</span>

    <span class="c1"># Low urgency, low sensitivity</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">volatility</span> <span class="o">&gt;</span> <span class="mf">0.03</span><span class="p">:</span>
            <span class="n">recommendations</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;limit&#39;</span><span class="p">,</span>
                <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="s1">&#39;High volatility - wait for better price&#39;</span>
            <span class="p">})</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">recommendations</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;market&#39;</span><span class="p">,</span>
                <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="s1">&#39;Stable conditions - market order acceptable&#39;</span>
            <span class="p">})</span>

    <span class="k">return</span> <span class="n">recommendations</span>

<span class="c1"># Test</span>
<span class="n">rec</span> <span class="o">=</span> <span class="n">recommend_order_type</span><span class="p">(</span><span class="s1">&#39;high&#39;</span><span class="p">,</span> <span class="s1">&#39;low&#39;</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="s1">&#39;deep&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">rec</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>Section 2: Order Placement</h1></div>
<div class="code-cell" id="cell-10-3" data-source="Y2xhc3MgT3JkZXJFeGVjdXRvcjoKICAgICIiIkV4ZWN1dGUgb3JkZXJzIHdpdGggcHJvcGVyIGVycm9yIGhhbmRsaW5nLiIiIgogICAgCiAgICBkZWYgX19pbml0X18oc2VsZiwgZXhjaGFuZ2UpOgogICAgICAgIHNlbGYuZXhjaGFuZ2UgPSBleGNoYW5nZQogICAgICAgIHNlbGYub3JkZXJfaGlzdG9yeSA9IFtdCiAgICAKICAgIGRlZiBwbGFjZV9vcmRlcihzZWxmLCBzeW1ib2wsIHNpZGUsIG9yZGVyX3R5cGUsIGFtb3VudCwgcHJpY2U9Tm9uZSwgcGFyYW1zPU5vbmUpOgogICAgICAgICIiIlBsYWNlIGFuIG9yZGVyIHdpdGggY29tcHJlaGVuc2l2ZSBlcnJvciBoYW5kbGluZy4iIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgIGlmIG9yZGVyX3R5cGUgPT0gJ21hcmtldCc6CiAgICAgICAgICAgICAgICBvcmRlciA9IHNlbGYuZXhjaGFuZ2UuY3JlYXRlX21hcmtldF9vcmRlcihzeW1ib2wsIHNpZGUsIGFtb3VudCwgcGFyYW1zIG9yIHt9KQogICAgICAgICAgICBlbGlmIG9yZGVyX3R5cGUgPT0gJ2xpbWl0JzoKICAgICAgICAgICAgICAgIGlmIHByaWNlIGlzIE5vbmU6CiAgICAgICAgICAgICAgICAgICAgcmFpc2UgVmFsdWVFcnJvcignTGltaXQgb3JkZXJzIHJlcXVpcmUgYSBwcmljZScpCiAgICAgICAgICAgICAgICBvcmRlciA9IHNlbGYuZXhjaGFuZ2UuY3JlYXRlX2xpbWl0X29yZGVyKHN5bWJvbCwgc2lkZSwgYW1vdW50LCBwcmljZSwgcGFyYW1zIG9yIHt9KQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgb3JkZXIgPSBzZWxmLmV4Y2hhbmdlLmNyZWF0ZV9vcmRlcihzeW1ib2wsIG9yZGVyX3R5cGUsIHNpZGUsIGFtb3VudCwgcHJpY2UsIHBhcmFtcyBvciB7fSkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgTG9nIHRoZSBvcmRlcgogICAgICAgICAgICBzZWxmLm9yZGVyX2hpc3RvcnkuYXBwZW5kKHsKICAgICAgICAgICAgICAgICd0aW1lc3RhbXAnOiBkYXRldGltZS5ub3coKSwKICAgICAgICAgICAgICAgICdvcmRlcic6IG9yZGVyLAogICAgICAgICAgICAgICAgJ3N0YXR1cyc6ICdwbGFjZWQnCiAgICAgICAgICAgIH0pCiAgICAgICAgICAgIAogICAgICAgICAgICByZXR1cm4geydzdWNjZXNzJzogVHJ1ZSwgJ29yZGVyJzogb3JkZXJ9CiAgICAgICAgCiAgICAgICAgZXhjZXB0IGNjeHQuSW5zdWZmaWNpZW50RnVuZHMgYXMgZToKICAgICAgICAgICAgcmV0dXJuIHsnc3VjY2Vzcyc6IEZhbHNlLCAnZXJyb3InOiAnSW5zdWZmaWNpZW50IGZ1bmRzJywgJ2RldGFpbHMnOiBzdHIoZSl9CiAgICAgICAgZXhjZXB0IGNjeHQuSW52YWxpZE9yZGVyIGFzIGU6CiAgICAgICAgICAgIHJldHVybiB7J3N1Y2Nlc3MnOiBGYWxzZSwgJ2Vycm9yJzogJ0ludmFsaWQgb3JkZXInLCAnZGV0YWlscyc6IHN0cihlKX0KICAgICAgICBleGNlcHQgY2N4dC5OZXR3b3JrRXJyb3IgYXMgZToKICAgICAgICAgICAgcmV0dXJuIHsnc3VjY2Vzcyc6IEZhbHNlLCAnZXJyb3InOiAnTmV0d29yayBlcnJvcicsICdkZXRhaWxzJzogc3RyKGUpfQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgcmV0dXJuIHsnc3VjY2Vzcyc6IEZhbHNlLCAnZXJyb3InOiAnVW5rbm93biBlcnJvcicsICdkZXRhaWxzJzogc3RyKGUpfQogICAgCiAgICBkZWYgcGxhY2Vfd2l0aF9jb25maXJtYXRpb24oc2VsZiwgc3ltYm9sLCBzaWRlLCBvcmRlcl90eXBlLCBhbW91bnQsIHByaWNlPU5vbmUpOgogICAgICAgICIiIlBsYWNlIG9yZGVyIGFuZCB3YWl0IGZvciBjb25maXJtYXRpb24uIiIiCiAgICAgICAgcmVzdWx0ID0gc2VsZi5wbGFjZV9vcmRlcihzeW1ib2wsIHNpZGUsIG9yZGVyX3R5cGUsIGFtb3VudCwgcHJpY2UpCiAgICAgICAgCiAgICAgICAgaWYgbm90IHJlc3VsdFsnc3VjY2VzcyddOgogICAgICAgICAgICByZXR1cm4gcmVzdWx0CiAgICAgICAgCiAgICAgICAgb3JkZXJfaWQgPSByZXN1bHRbJ29yZGVyJ11bJ2lkJ10KICAgICAgICAKICAgICAgICAjIFBvbGwgZm9yIGNvbmZpcm1hdGlvbiAoZm9yIGxpbWl0IG9yZGVycykKICAgICAgICBpZiBvcmRlcl90eXBlID09ICdsaW1pdCc6CiAgICAgICAgICAgIGltcG9ydCB0aW1lCiAgICAgICAgICAgIGZvciBfIGluIHJhbmdlKDEwKTogICMgQ2hlY2sgdXAgdG8gMTAgdGltZXMKICAgICAgICAgICAgICAgIHRpbWUuc2xlZXAoMSkKICAgICAgICAgICAgICAgIHN0YXR1cyA9IHNlbGYuZXhjaGFuZ2UuZmV0Y2hfb3JkZXIob3JkZXJfaWQsIHN5bWJvbCkKICAgICAgICAgICAgICAgIGlmIHN0YXR1c1snc3RhdHVzJ10gPT0gJ2Nsb3NlZCc6CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHsnc3VjY2Vzcyc6IFRydWUsICdvcmRlcic6IHN0YXR1cywgJ2ZpbGxlZCc6IFRydWV9CiAgICAgICAgICAgICAgICBlbGlmIHN0YXR1c1snc3RhdHVzJ10gPT0gJ2NhbmNlbGVkJzoKICAgICAgICAgICAgICAgICAgICByZXR1cm4geydzdWNjZXNzJzogRmFsc2UsICdlcnJvcic6ICdPcmRlciBjYW5jZWxlZCd9CiAgICAgICAgICAgIAogICAgICAgICAgICByZXR1cm4geydzdWNjZXNzJzogVHJ1ZSwgJ29yZGVyJzogcmVzdWx0WydvcmRlciddLCAnZmlsbGVkJzogRmFsc2UsICdub3RlJzogJ1N0aWxsIG9wZW4nfQogICAgICAgIAogICAgICAgIHJldHVybiByZXN1bHQ="><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-10-3')" type="button">Run</button></div><pre><code><span class="k">class</span> <span class="nc">OrderExecutor</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Execute orders with proper error handling.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exchange</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span> <span class="o">=</span> <span class="n">exchange</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">order_history</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">def</span> <span class="nf">place_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">side</span><span class="p">,</span> <span class="n">order_type</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">price</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Place an order with comprehensive error handling.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">order_type</span> <span class="o">==</span> <span class="s1">&#39;market&#39;</span><span class="p">:</span>
                <span class="n">order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="o">.</span><span class="n">create_market_order</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">side</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">params</span> <span class="ow">or</span> <span class="p">{})</span>
            <span class="k">elif</span> <span class="n">order_type</span> <span class="o">==</span> <span class="s1">&#39;limit&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">price</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Limit orders require a price&#39;</span><span class="p">)</span>
                <span class="n">order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="o">.</span><span class="n">create_limit_order</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">side</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">price</span><span class="p">,</span> <span class="n">params</span> <span class="ow">or</span> <span class="p">{})</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="o">.</span><span class="n">create_order</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">order_type</span><span class="p">,</span> <span class="n">side</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">price</span><span class="p">,</span> <span class="n">params</span> <span class="ow">or</span> <span class="p">{})</span>
            
            <span class="c1"># Log the order</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">order_history</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
                <span class="s1">&#39;order&#39;</span><span class="p">:</span> <span class="n">order</span><span class="p">,</span>
                <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;placed&#39;</span>
            <span class="p">})</span>
            
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;order&#39;</span><span class="p">:</span> <span class="n">order</span><span class="p">}</span>
        
        <span class="k">except</span> <span class="n">ccxt</span><span class="o">.</span><span class="n">InsufficientFunds</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Insufficient funds&#39;</span><span class="p">,</span> <span class="s1">&#39;details&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>
        <span class="k">except</span> <span class="n">ccxt</span><span class="o">.</span><span class="n">InvalidOrder</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Invalid order&#39;</span><span class="p">,</span> <span class="s1">&#39;details&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>
        <span class="k">except</span> <span class="n">ccxt</span><span class="o">.</span><span class="n">NetworkError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Network error&#39;</span><span class="p">,</span> <span class="s1">&#39;details&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Unknown error&#39;</span><span class="p">,</span> <span class="s1">&#39;details&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>
    
    <span class="k">def</span> <span class="nf">place_with_confirmation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">side</span><span class="p">,</span> <span class="n">order_type</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">price</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Place order and wait for confirmation.&quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">place_order</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">side</span><span class="p">,</span> <span class="n">order_type</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">price</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;success&#39;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="n">result</span>
        
        <span class="n">order_id</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;order&#39;</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
        
        <span class="c1"># Poll for confirmation (for limit orders)</span>
        <span class="k">if</span> <span class="n">order_type</span> <span class="o">==</span> <span class="s1">&#39;limit&#39;</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">time</span>
            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>  <span class="c1"># Check up to 10 times</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="o">.</span><span class="n">fetch_order</span><span class="p">(</span><span class="n">order_id</span><span class="p">,</span> <span class="n">symbol</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">status</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;closed&#39;</span><span class="p">:</span>
                    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;order&#39;</span><span class="p">:</span> <span class="n">status</span><span class="p">,</span> <span class="s1">&#39;filled&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
                <span class="k">elif</span> <span class="n">status</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;canceled&#39;</span><span class="p">:</span>
                    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Order canceled&#39;</span><span class="p">}</span>
            
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;order&#39;</span><span class="p">:</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;order&#39;</span><span class="p">],</span> <span class="s1">&#39;filled&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;note&#39;</span><span class="p">:</span> <span class="s1">&#39;Still open&#39;</span><span class="p">}</span>
        
        <span class="k">return</span> <span class="n">result</span>
</code></pre><div class="code-output" id="output-cell-10-3"></div></div>
<div class="md-cell"><h3>âœï¸ Exercise 10.2: Order Execution System</h3>
<p>Build a complete order execution system with pre-trade checks.</p></div>
<div class="code-cell" id="cell-10-4" data-source="IyBFeGVyY2lzZSAxMC4yCmNsYXNzIE9yZGVyRXhlY3V0aW9uU3lzdGVtOgogICAgZGVmIF9faW5pdF9fKHNlbGYsIGV4Y2hhbmdlLCBtYXhfc2xpcHBhZ2U9MC4wMSk6CiAgICAgICAgc2VsZi5leGNoYW5nZSA9IGV4Y2hhbmdlCiAgICAgICAgc2VsZi5tYXhfc2xpcHBhZ2UgPSBtYXhfc2xpcHBhZ2UKICAgIAogICAgZGVmIHByZV90cmFkZV9jaGVja3Moc2VsZiwgc3ltYm9sLCBzaWRlLCBhbW91bnQsIHByaWNlPU5vbmUpOgogICAgICAgICMgVE9ETzogQ2hlY2sgYmFsYW5jZSwgbWFya2V0IGNvbmRpdGlvbnMsIGV0Yy4KICAgICAgICBwYXNzCiAgICAKICAgIGRlZiBleGVjdXRlKHNlbGYsIHN5bWJvbCwgc2lkZSwgb3JkZXJfdHlwZSwgYW1vdW50LCBwcmljZT1Ob25lKToKICAgICAgICAjIFRPRE86IEV4ZWN1dGUgd2l0aCBwcmUtY2hlY2tzCiAgICAgICAgcGFzcwogICAgCiAgICBkZWYgY2FsY3VsYXRlX2V4cGVjdGVkX2ZpbGwoc2VsZiwgc3ltYm9sLCBzaWRlLCBhbW91bnQpOgogICAgICAgICMgVE9ETzogRXN0aW1hdGUgZmlsbCBwcmljZSBmcm9tIG9yZGVyIGJvb2sKICAgICAgICBwYXNz"><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-10-4')" type="button">Run</button></div><pre><code><span class="c1"># Exercise 10.2</span>
<span class="k">class</span> <span class="nc">OrderExecutionSystem</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exchange</span><span class="p">,</span> <span class="n">max_slippage</span><span class="o">=</span><span class="mf">0.01</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span> <span class="o">=</span> <span class="n">exchange</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_slippage</span> <span class="o">=</span> <span class="n">max_slippage</span>
    
    <span class="k">def</span> <span class="nf">pre_trade_checks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">side</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">price</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># TODO: Check balance, market conditions, etc.</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">side</span><span class="p">,</span> <span class="n">order_type</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">price</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># TODO: Execute with pre-checks</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">calculate_expected_fill</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">side</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
        <span class="c1"># TODO: Estimate fill price from order book</span>
        <span class="k">pass</span>
</code></pre><div class="code-output" id="output-cell-10-4"></div></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">OrderExecutionSystem</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exchange</span><span class="p">,</span> <span class="n">max_slippage</span><span class="o">=</span><span class="mf">0.01</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span> <span class="o">=</span> <span class="n">exchange</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_slippage</span> <span class="o">=</span> <span class="n">max_slippage</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">executor</span> <span class="o">=</span> <span class="n">OrderExecutor</span><span class="p">(</span><span class="n">exchange</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">pre_trade_checks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">side</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">price</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">checks</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;passed&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;issues&#39;</span><span class="p">:</span> <span class="p">[]}</span>

        <span class="c1"># Check balance</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">balance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="o">.</span><span class="n">fetch_balance</span><span class="p">()</span>
            <span class="n">base</span><span class="p">,</span> <span class="n">quote</span> <span class="o">=</span> <span class="n">symbol</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">side</span> <span class="o">==</span> <span class="s1">&#39;buy&#39;</span><span class="p">:</span>
                <span class="n">required</span> <span class="o">=</span> <span class="n">amount</span> <span class="o">*</span> <span class="p">(</span><span class="n">price</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="o">.</span><span class="n">fetch_ticker</span><span class="p">(</span><span class="n">symbol</span><span class="p">)[</span><span class="s1">&#39;ask&#39;</span><span class="p">])</span>
                <span class="n">available</span> <span class="o">=</span> <span class="n">balance</span><span class="p">[</span><span class="s1">&#39;free&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">quote</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">required</span> <span class="o">&gt;</span> <span class="n">available</span><span class="p">:</span>
                    <span class="n">checks</span><span class="p">[</span><span class="s1">&#39;passed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">checks</span><span class="p">[</span><span class="s1">&#39;issues&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Insufficient </span><span class="si">{</span><span class="n">quote</span><span class="si">}</span><span class="s1">: need </span><span class="si">{</span><span class="n">required</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">, have </span><span class="si">{</span><span class="n">available</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">available</span> <span class="o">=</span> <span class="n">balance</span><span class="p">[</span><span class="s1">&#39;free&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">amount</span> <span class="o">&gt;</span> <span class="n">available</span><span class="p">:</span>
                    <span class="n">checks</span><span class="p">[</span><span class="s1">&#39;passed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">checks</span><span class="p">[</span><span class="s1">&#39;issues&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Insufficient </span><span class="si">{</span><span class="n">base</span><span class="si">}</span><span class="s1">: need </span><span class="si">{</span><span class="n">amount</span><span class="si">}</span><span class="s1">, have </span><span class="si">{</span><span class="n">available</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">checks</span><span class="p">[</span><span class="s1">&#39;issues&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Could not verify balance&#39;</span><span class="p">)</span>

        <span class="c1"># Check slippage</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_expected_fill</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">side</span><span class="p">,</span> <span class="n">amount</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">expected</span> <span class="ow">and</span> <span class="n">price</span><span class="p">:</span>
            <span class="n">slippage</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">expected</span> <span class="o">-</span> <span class="n">price</span><span class="p">)</span> <span class="o">/</span> <span class="n">price</span>
            <span class="k">if</span> <span class="n">slippage</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_slippage</span><span class="p">:</span>
                <span class="n">checks</span><span class="p">[</span><span class="s1">&#39;passed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">checks</span><span class="p">[</span><span class="s1">&#39;issues&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Expected slippage </span><span class="si">{</span><span class="n">slippage</span><span class="si">:</span><span class="s1">.2%</span><span class="si">}</span><span class="s1"> exceeds max </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">max_slippage</span><span class="si">:</span><span class="s1">.2%</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">checks</span>

    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">side</span><span class="p">,</span> <span class="n">order_type</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">price</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># Pre-checks</span>
        <span class="n">checks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre_trade_checks</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">side</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">price</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">checks</span><span class="p">[</span><span class="s1">&#39;passed&#39;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Pre-trade checks failed&#39;</span><span class="p">,</span> <span class="s1">&#39;issues&#39;</span><span class="p">:</span> <span class="n">checks</span><span class="p">[</span><span class="s1">&#39;issues&#39;</span><span class="p">]}</span>

        <span class="c1"># Execute</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">executor</span><span class="o">.</span><span class="n">place_order</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">side</span><span class="p">,</span> <span class="n">order_type</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">price</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">calculate_expected_fill</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">side</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">book</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="o">.</span><span class="n">fetch_order_book</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
            <span class="n">levels</span> <span class="o">=</span> <span class="n">book</span><span class="p">[</span><span class="s1">&#39;asks&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">side</span> <span class="o">==</span> <span class="s1">&#39;buy&#39;</span> <span class="k">else</span> <span class="n">book</span><span class="p">[</span><span class="s1">&#39;bids&#39;</span><span class="p">]</span>

            <span class="n">remaining</span> <span class="o">=</span> <span class="n">amount</span>
            <span class="n">total_cost</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="k">for</span> <span class="n">price</span><span class="p">,</span> <span class="n">size</span> <span class="ow">in</span> <span class="n">levels</span><span class="p">:</span>
                <span class="n">fill_size</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">remaining</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>
                <span class="n">total_cost</span> <span class="o">+=</span> <span class="n">fill_size</span> <span class="o">*</span> <span class="n">price</span>
                <span class="n">remaining</span> <span class="o">-=</span> <span class="n">fill_size</span>
                <span class="k">if</span> <span class="n">remaining</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">break</span>

            <span class="k">if</span> <span class="n">remaining</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>  <span class="c1"># Not enough liquidity</span>

            <span class="k">return</span> <span class="n">total_cost</span> <span class="o">/</span> <span class="n">amount</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>Section 3: Order Management</h1></div>
<div class="code-cell" id="cell-10-5" data-source="Y2xhc3MgT3JkZXJNYW5hZ2VyOgogICAgIiIiTWFuYWdlIG9wZW4gb3JkZXJzLiIiIgogICAgCiAgICBkZWYgX19pbml0X18oc2VsZiwgZXhjaGFuZ2UpOgogICAgICAgIHNlbGYuZXhjaGFuZ2UgPSBleGNoYW5nZQogICAgCiAgICBkZWYgZ2V0X29wZW5fb3JkZXJzKHNlbGYsIHN5bWJvbD1Ob25lKToKICAgICAgICAiIiJGZXRjaCBhbGwgb3BlbiBvcmRlcnMuIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICBpZiBzeW1ib2w6CiAgICAgICAgICAgICAgICByZXR1cm4gc2VsZi5leGNoYW5nZS5mZXRjaF9vcGVuX29yZGVycyhzeW1ib2wpCiAgICAgICAgICAgIHJldHVybiBzZWxmLmV4Y2hhbmdlLmZldGNoX29wZW5fb3JkZXJzKCkKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHJldHVybiB7J2Vycm9yJzogc3RyKGUpfQogICAgCiAgICBkZWYgZ2V0X29yZGVyX3N0YXR1cyhzZWxmLCBvcmRlcl9pZCwgc3ltYm9sKToKICAgICAgICAiIiJHZXQgc3RhdHVzIG9mIHNwZWNpZmljIG9yZGVyLiIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgb3JkZXIgPSBzZWxmLmV4Y2hhbmdlLmZldGNoX29yZGVyKG9yZGVyX2lkLCBzeW1ib2wpCiAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICAnaWQnOiBvcmRlclsnaWQnXSwKICAgICAgICAgICAgICAgICdzdGF0dXMnOiBvcmRlclsnc3RhdHVzJ10sCiAgICAgICAgICAgICAgICAnZmlsbGVkJzogb3JkZXJbJ2ZpbGxlZCddLAogICAgICAgICAgICAgICAgJ3JlbWFpbmluZyc6IG9yZGVyWydyZW1haW5pbmcnXSwKICAgICAgICAgICAgICAgICdhdmVyYWdlJzogb3JkZXJbJ2F2ZXJhZ2UnXSwKICAgICAgICAgICAgICAgICdjb3N0Jzogb3JkZXJbJ2Nvc3QnXQogICAgICAgICAgICB9CiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICByZXR1cm4geydlcnJvcic6IHN0cihlKX0KICAgIAogICAgZGVmIGNhbmNlbF9vcmRlcihzZWxmLCBvcmRlcl9pZCwgc3ltYm9sKToKICAgICAgICAiIiJDYW5jZWwgYW4gb3BlbiBvcmRlci4iIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgIHJlc3VsdCA9IHNlbGYuZXhjaGFuZ2UuY2FuY2VsX29yZGVyKG9yZGVyX2lkLCBzeW1ib2wpCiAgICAgICAgICAgIHJldHVybiB7J3N1Y2Nlc3MnOiBUcnVlLCAncmVzdWx0JzogcmVzdWx0fQogICAgICAgIGV4Y2VwdCBjY3h0Lk9yZGVyTm90Rm91bmQ6CiAgICAgICAgICAgIHJldHVybiB7J3N1Y2Nlc3MnOiBGYWxzZSwgJ2Vycm9yJzogJ09yZGVyIG5vdCBmb3VuZCd9CiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICByZXR1cm4geydzdWNjZXNzJzogRmFsc2UsICdlcnJvcic6IHN0cihlKX0KICAgIAogICAgZGVmIGNhbmNlbF9hbGxfb3JkZXJzKHNlbGYsIHN5bWJvbD1Ob25lKToKICAgICAgICAiIiJDYW5jZWwgYWxsIG9wZW4gb3JkZXJzLiIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgaWYgc3ltYm9sOgogICAgICAgICAgICAgICAgcmV0dXJuIHNlbGYuZXhjaGFuZ2UuY2FuY2VsX2FsbF9vcmRlcnMoc3ltYm9sKQogICAgICAgICAgICByZXR1cm4gc2VsZi5leGNoYW5nZS5jYW5jZWxfYWxsX29yZGVycygpCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICByZXR1cm4geydlcnJvcic6IHN0cihlKX0KICAgIAogICAgZGVmIG1vZGlmeV9vcmRlcihzZWxmLCBvcmRlcl9pZCwgc3ltYm9sLCBuZXdfcHJpY2U9Tm9uZSwgbmV3X2Ftb3VudD1Ob25lKToKICAgICAgICAiIiJNb2RpZnkgYW4gZXhpc3Rpbmcgb3JkZXIgKGNhbmNlbCBhbmQgcmVwbGFjZSkuIiIiCiAgICAgICAgIyBNb3N0IGV4Y2hhbmdlcyBkb24ndCBzdXBwb3J0IHRydWUgbW9kaWZpY2F0aW9uCiAgICAgICAgIyBTbyB3ZSBjYW5jZWwgYW5kIGNyZWF0ZSBuZXcgb3JkZXIKICAgICAgICAKICAgICAgICAjIEdldCBvcmlnaW5hbCBvcmRlcgogICAgICAgIG9yaWdpbmFsID0gc2VsZi5leGNoYW5nZS5mZXRjaF9vcmRlcihvcmRlcl9pZCwgc3ltYm9sKQogICAgICAgIAogICAgICAgICMgQ2FuY2VsIGl0CiAgICAgICAgY2FuY2VsX3Jlc3VsdCA9IHNlbGYuY2FuY2VsX29yZGVyKG9yZGVyX2lkLCBzeW1ib2wpCiAgICAgICAgaWYgbm90IGNhbmNlbF9yZXN1bHQuZ2V0KCdzdWNjZXNzJyk6CiAgICAgICAgICAgIHJldHVybiBjYW5jZWxfcmVzdWx0CiAgICAgICAgCiAgICAgICAgIyBDcmVhdGUgbmV3IG9yZGVyCiAgICAgICAgbmV3X29yZGVyID0gc2VsZi5leGNoYW5nZS5jcmVhdGVfb3JkZXIoCiAgICAgICAgICAgIHN5bWJvbCwKICAgICAgICAgICAgb3JpZ2luYWxbJ3R5cGUnXSwKICAgICAgICAgICAgb3JpZ2luYWxbJ3NpZGUnXSwKICAgICAgICAgICAgbmV3X2Ftb3VudCBvciBvcmlnaW5hbFsncmVtYWluaW5nJ10sCiAgICAgICAgICAgIG5ld19wcmljZSBvciBvcmlnaW5hbFsncHJpY2UnXQogICAgICAgICkKICAgICAgICAKICAgICAgICByZXR1cm4geydzdWNjZXNzJzogVHJ1ZSwgJ29sZF9vcmRlcic6IG9yZGVyX2lkLCAnbmV3X29yZGVyJzogbmV3X29yZGVyWydpZCddfQ=="><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-10-5')" type="button">Run</button></div><pre><code><span class="k">class</span> <span class="nc">OrderManager</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Manage open orders.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exchange</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span> <span class="o">=</span> <span class="n">exchange</span>
    
    <span class="k">def</span> <span class="nf">get_open_orders</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Fetch all open orders.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">symbol</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="o">.</span><span class="n">fetch_open_orders</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="o">.</span><span class="n">fetch_open_orders</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>
    
    <span class="k">def</span> <span class="nf">get_order_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order_id</span><span class="p">,</span> <span class="n">symbol</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get status of specific order.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="o">.</span><span class="n">fetch_order</span><span class="p">(</span><span class="n">order_id</span><span class="p">,</span> <span class="n">symbol</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">order</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span>
                <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="n">order</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">],</span>
                <span class="s1">&#39;filled&#39;</span><span class="p">:</span> <span class="n">order</span><span class="p">[</span><span class="s1">&#39;filled&#39;</span><span class="p">],</span>
                <span class="s1">&#39;remaining&#39;</span><span class="p">:</span> <span class="n">order</span><span class="p">[</span><span class="s1">&#39;remaining&#39;</span><span class="p">],</span>
                <span class="s1">&#39;average&#39;</span><span class="p">:</span> <span class="n">order</span><span class="p">[</span><span class="s1">&#39;average&#39;</span><span class="p">],</span>
                <span class="s1">&#39;cost&#39;</span><span class="p">:</span> <span class="n">order</span><span class="p">[</span><span class="s1">&#39;cost&#39;</span><span class="p">]</span>
            <span class="p">}</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>
    
    <span class="k">def</span> <span class="nf">cancel_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order_id</span><span class="p">,</span> <span class="n">symbol</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Cancel an open order.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="o">.</span><span class="n">cancel_order</span><span class="p">(</span><span class="n">order_id</span><span class="p">,</span> <span class="n">symbol</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="n">result</span><span class="p">}</span>
        <span class="k">except</span> <span class="n">ccxt</span><span class="o">.</span><span class="n">OrderNotFound</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Order not found&#39;</span><span class="p">}</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>
    
    <span class="k">def</span> <span class="nf">cancel_all_orders</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Cancel all open orders.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">symbol</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="o">.</span><span class="n">cancel_all_orders</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="o">.</span><span class="n">cancel_all_orders</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>
    
    <span class="k">def</span> <span class="nf">modify_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order_id</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">new_price</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">new_amount</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Modify an existing order (cancel and replace).&quot;&quot;&quot;</span>
        <span class="c1"># Most exchanges don&#39;t support true modification</span>
        <span class="c1"># So we cancel and create new order</span>
        
        <span class="c1"># Get original order</span>
        <span class="n">original</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="o">.</span><span class="n">fetch_order</span><span class="p">(</span><span class="n">order_id</span><span class="p">,</span> <span class="n">symbol</span><span class="p">)</span>
        
        <span class="c1"># Cancel it</span>
        <span class="n">cancel_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cancel_order</span><span class="p">(</span><span class="n">order_id</span><span class="p">,</span> <span class="n">symbol</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">cancel_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;success&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">cancel_result</span>
        
        <span class="c1"># Create new order</span>
        <span class="n">new_order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="o">.</span><span class="n">create_order</span><span class="p">(</span>
            <span class="n">symbol</span><span class="p">,</span>
            <span class="n">original</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">],</span>
            <span class="n">original</span><span class="p">[</span><span class="s1">&#39;side&#39;</span><span class="p">],</span>
            <span class="n">new_amount</span> <span class="ow">or</span> <span class="n">original</span><span class="p">[</span><span class="s1">&#39;remaining&#39;</span><span class="p">],</span>
            <span class="n">new_price</span> <span class="ow">or</span> <span class="n">original</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]</span>
        <span class="p">)</span>
        
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;old_order&#39;</span><span class="p">:</span> <span class="n">order_id</span><span class="p">,</span> <span class="s1">&#39;new_order&#39;</span><span class="p">:</span> <span class="n">new_order</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]}</span>
</code></pre><div class="code-output" id="output-cell-10-5"></div></div>
<div class="md-cell"><h3>âœï¸ Exercise 10.3: Order Manager</h3>
<p>Build an advanced order manager with order tracking.</p></div>
<div class="code-cell" id="cell-10-6" data-source="IyBFeGVyY2lzZSAxMC4zCmNsYXNzIEFkdmFuY2VkT3JkZXJNYW5hZ2VyOgogICAgZGVmIF9faW5pdF9fKHNlbGYsIGV4Y2hhbmdlKToKICAgICAgICBzZWxmLmV4Y2hhbmdlID0gZXhjaGFuZ2UKICAgICAgICBzZWxmLnRyYWNrZWRfb3JkZXJzID0ge30KICAgIAogICAgZGVmIHRyYWNrX29yZGVyKHNlbGYsIG9yZGVyX2lkLCBzeW1ib2wsIG1ldGFkYXRhPU5vbmUpOgogICAgICAgICMgVE9ETzogQWRkIG9yZGVyIHRvIHRyYWNraW5nCiAgICAgICAgcGFzcwogICAgCiAgICBkZWYgdXBkYXRlX2FsbF9zdGF0dXNlcyhzZWxmKToKICAgICAgICAjIFRPRE86IFVwZGF0ZSBzdGF0dXMgb2YgYWxsIHRyYWNrZWQgb3JkZXJzCiAgICAgICAgcGFzcwogICAgCiAgICBkZWYgZ2V0X2ZpbGxlZF9vcmRlcnMoc2VsZik6CiAgICAgICAgIyBUT0RPOiBSZXR1cm4gYWxsIGZpbGxlZCBvcmRlcnMKICAgICAgICBwYXNzCiAgICAKICAgIGRlZiBjbGVhbnVwX2NvbXBsZXRlZChzZWxmKToKICAgICAgICAjIFRPRE86IFJlbW92ZSBjb21wbGV0ZWQgb3JkZXJzIGZyb20gdHJhY2tpbmcKICAgICAgICBwYXNz"><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-10-6')" type="button">Run</button></div><pre><code><span class="c1"># Exercise 10.3</span>
<span class="k">class</span> <span class="nc">AdvancedOrderManager</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exchange</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span> <span class="o">=</span> <span class="n">exchange</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tracked_orders</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="k">def</span> <span class="nf">track_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order_id</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># TODO: Add order to tracking</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">update_all_statuses</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># TODO: Update status of all tracked orders</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">get_filled_orders</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># TODO: Return all filled orders</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">cleanup_completed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># TODO: Remove completed orders from tracking</span>
        <span class="k">pass</span>
</code></pre><div class="code-output" id="output-cell-10-6"></div></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">AdvancedOrderManager</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exchange</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span> <span class="o">=</span> <span class="n">exchange</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tracked_orders</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">track_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order_id</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tracked_orders</span><span class="p">[</span><span class="n">order_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span>
            <span class="s1">&#39;metadata&#39;</span><span class="p">:</span> <span class="n">metadata</span> <span class="ow">or</span> <span class="p">{},</span>
            <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;open&#39;</span><span class="p">,</span>
            <span class="s1">&#39;last_update&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
            <span class="s1">&#39;history&#39;</span><span class="p">:</span> <span class="p">[]</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">update_all_statuses</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">updated</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">order_id</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tracked_orders</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;open&#39;</span><span class="p">,</span> <span class="s1">&#39;partially_filled&#39;</span><span class="p">]:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="o">.</span><span class="n">fetch_order</span><span class="p">(</span><span class="n">order_id</span><span class="p">,</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;symbol&#39;</span><span class="p">])</span>
                    <span class="n">old_status</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span>
                    <span class="n">info</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">order</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span>
                    <span class="n">info</span><span class="p">[</span><span class="s1">&#39;filled&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">order</span><span class="p">[</span><span class="s1">&#39;filled&#39;</span><span class="p">]</span>
                    <span class="n">info</span><span class="p">[</span><span class="s1">&#39;average&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">order</span><span class="p">[</span><span class="s1">&#39;average&#39;</span><span class="p">]</span>
                    <span class="n">info</span><span class="p">[</span><span class="s1">&#39;last_update&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>

                    <span class="k">if</span> <span class="n">old_status</span> <span class="o">!=</span> <span class="n">order</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]:</span>
                        <span class="n">info</span><span class="p">[</span><span class="s1">&#39;history&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                            <span class="s1">&#39;from&#39;</span><span class="p">:</span> <span class="n">old_status</span><span class="p">,</span>
                            <span class="s1">&#39;to&#39;</span><span class="p">:</span> <span class="n">order</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">],</span>
                            <span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
                        <span class="p">})</span>
                        <span class="n">updated</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">order_id</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">info</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">updated</span>

    <span class="k">def</span> <span class="nf">get_filled_orders</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="n">oid</span><span class="p">:</span> <span class="n">info</span> <span class="k">for</span> <span class="n">oid</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tracked_orders</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;closed&#39;</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">get_open_orders</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="n">oid</span><span class="p">:</span> <span class="n">info</span> <span class="k">for</span> <span class="n">oid</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tracked_orders</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;open&#39;</span><span class="p">,</span> <span class="s1">&#39;partially_filled&#39;</span><span class="p">]</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">cleanup_completed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">completed</span> <span class="o">=</span> <span class="p">[</span><span class="n">oid</span> <span class="k">for</span> <span class="n">oid</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tracked_orders</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                     <span class="k">if</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;closed&#39;</span><span class="p">,</span> <span class="s1">&#39;canceled&#39;</span><span class="p">]]</span>
        <span class="k">for</span> <span class="n">oid</span> <span class="ow">in</span> <span class="n">completed</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">tracked_orders</span><span class="p">[</span><span class="n">oid</span><span class="p">]</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">completed</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>Section 4: Execution Quality</h1></div>
<div class="code-cell" id="cell-10-7" data-source="Y2xhc3MgRXhlY3V0aW9uQW5hbHl6ZXI6CiAgICAiIiJBbmFseXplIGV4ZWN1dGlvbiBxdWFsaXR5LiIiIgogICAgCiAgICBkZWYgX19pbml0X18oc2VsZik6CiAgICAgICAgc2VsZi5leGVjdXRpb25zID0gW10KICAgIAogICAgZGVmIHJlY29yZF9leGVjdXRpb24oc2VsZiwgaW50ZW5kZWRfcHJpY2UsIGFjdHVhbF9wcmljZSwgc2lkZSwgYW1vdW50KToKICAgICAgICAiIiJSZWNvcmQgYW4gZXhlY3V0aW9uIGZvciBhbmFseXNpcy4iIiIKICAgICAgICBzbGlwcGFnZSA9IChhY3R1YWxfcHJpY2UgLSBpbnRlbmRlZF9wcmljZSkgLyBpbnRlbmRlZF9wcmljZQogICAgICAgIGlmIHNpZGUgPT0gJ3NlbGwnOgogICAgICAgICAgICBzbGlwcGFnZSA9IC1zbGlwcGFnZSAgIyBGb3Igc2VsbHMsIGdldHRpbmcgbGVzcyBpcyBiYWQKICAgICAgICAKICAgICAgICBzZWxmLmV4ZWN1dGlvbnMuYXBwZW5kKHsKICAgICAgICAgICAgJ3RpbWVzdGFtcCc6IGRhdGV0aW1lLm5vdygpLAogICAgICAgICAgICAnaW50ZW5kZWQnOiBpbnRlbmRlZF9wcmljZSwKICAgICAgICAgICAgJ2FjdHVhbCc6IGFjdHVhbF9wcmljZSwKICAgICAgICAgICAgJ3NpZGUnOiBzaWRlLAogICAgICAgICAgICAnYW1vdW50JzogYW1vdW50LAogICAgICAgICAgICAnc2xpcHBhZ2UnOiBzbGlwcGFnZSwKICAgICAgICAgICAgJ3NsaXBwYWdlX2Nvc3QnOiBhYnMoYWN0dWFsX3ByaWNlIC0gaW50ZW5kZWRfcHJpY2UpICogYW1vdW50CiAgICAgICAgfSkKICAgIAogICAgZGVmIGdldF9zdGF0aXN0aWNzKHNlbGYpOgogICAgICAgICIiIkNhbGN1bGF0ZSBleGVjdXRpb24gc3RhdGlzdGljcy4iIiIKICAgICAgICBpZiBub3Qgc2VsZi5leGVjdXRpb25zOgogICAgICAgICAgICByZXR1cm4geydlcnJvcic6ICdObyBleGVjdXRpb25zIHJlY29yZGVkJ30KICAgICAgICAKICAgICAgICBpbXBvcnQgbnVtcHkgYXMgbnAKICAgICAgICBzbGlwcGFnZXMgPSBbZVsnc2xpcHBhZ2UnXSBmb3IgZSBpbiBzZWxmLmV4ZWN1dGlvbnNdCiAgICAgICAgY29zdHMgPSBbZVsnc2xpcHBhZ2VfY29zdCddIGZvciBlIGluIHNlbGYuZXhlY3V0aW9uc10KICAgICAgICAKICAgICAgICByZXR1cm4gewogICAgICAgICAgICAndG90YWxfZXhlY3V0aW9ucyc6IGxlbihzZWxmLmV4ZWN1dGlvbnMpLAogICAgICAgICAgICAnYXZnX3NsaXBwYWdlJzogbnAubWVhbihzbGlwcGFnZXMpICogMTAwLAogICAgICAgICAgICAnbWF4X3NsaXBwYWdlJzogbnAubWF4KHNsaXBwYWdlcykgKiAxMDAsCiAgICAgICAgICAgICd0b3RhbF9zbGlwcGFnZV9jb3N0Jzogc3VtKGNvc3RzKSwKICAgICAgICAgICAgJ3Bvc2l0aXZlX3NsaXBwYWdlX2NvdW50Jzogc3VtKDEgZm9yIHMgaW4gc2xpcHBhZ2VzIGlmIHMgPiAwKSwKICAgICAgICAgICAgJ25lZ2F0aXZlX3NsaXBwYWdlX2NvdW50Jzogc3VtKDEgZm9yIHMgaW4gc2xpcHBhZ2VzIGlmIHMgPCAwKQogICAgICAgIH0KICAgIAogICAgZGVmIGFuYWx5emVfYnlfdGltZShzZWxmKToKICAgICAgICAiIiJBbmFseXplIGV4ZWN1dGlvbiBxdWFsaXR5IGJ5IHRpbWUgb2YgZGF5LiIiIgogICAgICAgIGJ5X2hvdXIgPSB7fQogICAgICAgIGZvciBlIGluIHNlbGYuZXhlY3V0aW9uczoKICAgICAgICAgICAgaG91ciA9IGVbJ3RpbWVzdGFtcCddLmhvdXIKICAgICAgICAgICAgaWYgaG91ciBub3QgaW4gYnlfaG91cjoKICAgICAgICAgICAgICAgIGJ5X2hvdXJbaG91cl0gPSBbXQogICAgICAgICAgICBieV9ob3VyW2hvdXJdLmFwcGVuZChlWydzbGlwcGFnZSddKQogICAgICAgIAogICAgICAgIGltcG9ydCBudW1weSBhcyBucAogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIGhvdXI6IHsnYXZnX3NsaXBwYWdlJzogbnAubWVhbihzbGlwcykgKiAxMDAsICdjb3VudCc6IGxlbihzbGlwcyl9CiAgICAgICAgICAgIGZvciBob3VyLCBzbGlwcyBpbiBieV9ob3VyLml0ZW1zKCkKICAgICAgICB9"><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-10-7')" type="button">Run</button></div><pre><code><span class="k">class</span> <span class="nc">ExecutionAnalyzer</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Analyze execution quality.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">executions</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">def</span> <span class="nf">record_execution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">intended_price</span><span class="p">,</span> <span class="n">actual_price</span><span class="p">,</span> <span class="n">side</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Record an execution for analysis.&quot;&quot;&quot;</span>
        <span class="n">slippage</span> <span class="o">=</span> <span class="p">(</span><span class="n">actual_price</span> <span class="o">-</span> <span class="n">intended_price</span><span class="p">)</span> <span class="o">/</span> <span class="n">intended_price</span>
        <span class="k">if</span> <span class="n">side</span> <span class="o">==</span> <span class="s1">&#39;sell&#39;</span><span class="p">:</span>
            <span class="n">slippage</span> <span class="o">=</span> <span class="o">-</span><span class="n">slippage</span>  <span class="c1"># For sells, getting less is bad</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">executions</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
            <span class="s1">&#39;intended&#39;</span><span class="p">:</span> <span class="n">intended_price</span><span class="p">,</span>
            <span class="s1">&#39;actual&#39;</span><span class="p">:</span> <span class="n">actual_price</span><span class="p">,</span>
            <span class="s1">&#39;side&#39;</span><span class="p">:</span> <span class="n">side</span><span class="p">,</span>
            <span class="s1">&#39;amount&#39;</span><span class="p">:</span> <span class="n">amount</span><span class="p">,</span>
            <span class="s1">&#39;slippage&#39;</span><span class="p">:</span> <span class="n">slippage</span><span class="p">,</span>
            <span class="s1">&#39;slippage_cost&#39;</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">actual_price</span> <span class="o">-</span> <span class="n">intended_price</span><span class="p">)</span> <span class="o">*</span> <span class="n">amount</span>
        <span class="p">})</span>
    
    <span class="k">def</span> <span class="nf">get_statistics</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculate execution statistics.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">executions</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;No executions recorded&#39;</span><span class="p">}</span>
        
        <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
        <span class="n">slippages</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span><span class="p">[</span><span class="s1">&#39;slippage&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">executions</span><span class="p">]</span>
        <span class="n">costs</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span><span class="p">[</span><span class="s1">&#39;slippage_cost&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">executions</span><span class="p">]</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;total_executions&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">executions</span><span class="p">),</span>
            <span class="s1">&#39;avg_slippage&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">slippages</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
            <span class="s1">&#39;max_slippage&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">slippages</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
            <span class="s1">&#39;total_slippage_cost&#39;</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="n">costs</span><span class="p">),</span>
            <span class="s1">&#39;positive_slippage_count&#39;</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">slippages</span> <span class="k">if</span> <span class="n">s</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">),</span>
            <span class="s1">&#39;negative_slippage_count&#39;</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">slippages</span> <span class="k">if</span> <span class="n">s</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">analyze_by_time</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Analyze execution quality by time of day.&quot;&quot;&quot;</span>
        <span class="n">by_hour</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">executions</span><span class="p">:</span>
            <span class="n">hour</span> <span class="o">=</span> <span class="n">e</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">hour</span>
            <span class="k">if</span> <span class="n">hour</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">by_hour</span><span class="p">:</span>
                <span class="n">by_hour</span><span class="p">[</span><span class="n">hour</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">by_hour</span><span class="p">[</span><span class="n">hour</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="s1">&#39;slippage&#39;</span><span class="p">])</span>
        
        <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="n">hour</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;avg_slippage&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">slips</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="s1">&#39;count&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">slips</span><span class="p">)}</span>
            <span class="k">for</span> <span class="n">hour</span><span class="p">,</span> <span class="n">slips</span> <span class="ow">in</span> <span class="n">by_hour</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">}</span>
</code></pre><div class="code-output" id="output-cell-10-7"></div></div>
<div class="md-cell"><h3>âœï¸ Exercise 10.4: Execution Analyzer</h3>
<p>Build a comprehensive execution analysis system.</p></div>
<div class="code-cell" id="cell-10-8" data-source="IyBFeGVyY2lzZSAxMC40CmNsYXNzIENvbXByZWhlbnNpdmVFeGVjdXRpb25BbmFseXplcjoKICAgIGRlZiBfX2luaXRfXyhzZWxmKToKICAgICAgICBzZWxmLnRyYWRlcyA9IFtdCiAgICAKICAgIGRlZiBhZGRfdHJhZGUoc2VsZiwgb3JkZXIsIGZpbGxfaW5mbyk6CiAgICAgICAgIyBUT0RPOiBSZWNvcmQgdHJhZGUgd2l0aCBmaWxsIGluZm9ybWF0aW9uCiAgICAgICAgcGFzcwogICAgCiAgICBkZWYgY2FsY3VsYXRlX3Z3YXBfc2xpcHBhZ2Uoc2VsZiwgdHJhZGVzKToKICAgICAgICAjIFRPRE86IENvbXBhcmUgZXhlY3V0aW9uIHRvIFZXQVAKICAgICAgICBwYXNzCiAgICAKICAgIGRlZiBnZW5lcmF0ZV9yZXBvcnQoc2VsZik6CiAgICAgICAgIyBUT0RPOiBHZW5lcmF0ZSBleGVjdXRpb24gcXVhbGl0eSByZXBvcnQKICAgICAgICBwYXNz"><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-10-8')" type="button">Run</button></div><pre><code><span class="c1"># Exercise 10.4</span>
<span class="k">class</span> <span class="nc">ComprehensiveExecutionAnalyzer</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trades</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">def</span> <span class="nf">add_trade</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">fill_info</span><span class="p">):</span>
        <span class="c1"># TODO: Record trade with fill information</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">calculate_vwap_slippage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trades</span><span class="p">):</span>
        <span class="c1"># TODO: Compare execution to VWAP</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">generate_report</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># TODO: Generate execution quality report</span>
        <span class="k">pass</span>
</code></pre><div class="code-output" id="output-cell-10-8"></div></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">ComprehensiveExecutionAnalyzer</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trades</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">add_trade</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">fill_info</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trades</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
            <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;symbol&#39;</span><span class="p">),</span>
            <span class="s1">&#39;side&#39;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;side&#39;</span><span class="p">),</span>
            <span class="s1">&#39;intended_price&#39;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;price&#39;</span><span class="p">),</span>
            <span class="s1">&#39;filled_price&#39;</span><span class="p">:</span> <span class="n">fill_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;average&#39;</span><span class="p">),</span>
            <span class="s1">&#39;amount&#39;</span><span class="p">:</span> <span class="n">fill_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;filled&#39;</span><span class="p">),</span>
            <span class="s1">&#39;fees&#39;</span><span class="p">:</span> <span class="n">fill_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fees&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
            <span class="s1">&#39;fill_time_ms&#39;</span><span class="p">:</span> <span class="n">fill_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fill_time_ms&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">})</span>

    <span class="k">def</span> <span class="nf">calculate_vwap_slippage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">execution_price</span><span class="p">,</span> <span class="n">market_vwap</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">execution_price</span> <span class="o">-</span> <span class="n">market_vwap</span><span class="p">)</span> <span class="o">/</span> <span class="n">market_vwap</span> <span class="o">*</span> <span class="mi">100</span>

    <span class="k">def</span> <span class="nf">generate_report</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">trades</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;No trades to analyze&#39;</span>

        <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

        <span class="n">slippages</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trades</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">t</span><span class="p">[</span><span class="s1">&#39;intended_price&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">t</span><span class="p">[</span><span class="s1">&#39;filled_price&#39;</span><span class="p">]:</span>
                <span class="n">slip</span> <span class="o">=</span> <span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="s1">&#39;filled_price&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">t</span><span class="p">[</span><span class="s1">&#39;intended_price&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="n">t</span><span class="p">[</span><span class="s1">&#39;intended_price&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">t</span><span class="p">[</span><span class="s1">&#39;side&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;sell&#39;</span><span class="p">:</span>
                    <span class="n">slip</span> <span class="o">=</span> <span class="o">-</span><span class="n">slip</span>
                <span class="n">slippages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">slip</span><span class="p">)</span>

        <span class="n">total_fees</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fees&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trades</span><span class="p">)</span>
        <span class="n">total_volume</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="s1">&#39;amount&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="s1">&#39;filled_price&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trades</span><span class="p">)</span>

        <span class="n">report</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;=&#39;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;     EXECUTION QUALITY REPORT&#39;</span><span class="p">)</span>
        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;=&#39;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Total Trades: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trades</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Total Volume: $</span><span class="si">{</span><span class="n">total_volume</span><span class="si">:</span><span class="s1">,.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Total Fees: $</span><span class="si">{</span><span class="n">total_fees</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;SLIPPAGE ANALYSIS:&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">slippages</span><span class="p">:</span>
            <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;  Average: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">slippages</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">%&#39;</span><span class="p">)</span>
            <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;  Std Dev: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">slippages</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">%&#39;</span><span class="p">)</span>
            <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;  Best: </span><span class="si">{</span><span class="nb">min</span><span class="p">(</span><span class="n">slippages</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">%&#39;</span><span class="p">)</span>
            <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;  Worst: </span><span class="si">{</span><span class="nb">max</span><span class="p">(</span><span class="n">slippages</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">%&#39;</span><span class="p">)</span>
        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;=&#39;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>

        <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">report</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>ğŸ—ï¸ Module Project: Order Execution System</h1>
<p>Build a complete order execution system.</p></div>
<div class="code-cell" id="cell-10-9" data-source="IyBNb2R1bGUgUHJvamVjdApjbGFzcyBDb21wbGV0ZU9yZGVyU3lzdGVtOgogICAgZGVmIF9faW5pdF9fKHNlbGYsIGV4Y2hhbmdlKToKICAgICAgICBzZWxmLmV4Y2hhbmdlID0gZXhjaGFuZ2UKICAgICAgICBzZWxmLmJ1aWxkZXIgPSBPcmRlckJ1aWxkZXIoZXhjaGFuZ2UpCiAgICAgICAgc2VsZi5leGVjdXRvciA9IE9yZGVyRXhlY3V0b3IoZXhjaGFuZ2UpCiAgICAgICAgc2VsZi5tYW5hZ2VyID0gT3JkZXJNYW5hZ2VyKGV4Y2hhbmdlKQogICAgICAgIHNlbGYuYW5hbHl6ZXIgPSBFeGVjdXRpb25BbmFseXplcigpCiAgICAKICAgIGRlZiBidXkoc2VsZiwgc3ltYm9sLCBhbW91bnQsIG9yZGVyX3R5cGU9J21hcmtldCcsIHByaWNlPU5vbmUpOgogICAgICAgICMgVE9ETzogQ29tcGxldGUgYnV5IGZsb3cKICAgICAgICBwYXNzCiAgICAKICAgIGRlZiBzZWxsKHNlbGYsIHN5bWJvbCwgYW1vdW50LCBvcmRlcl90eXBlPSdtYXJrZXQnLCBwcmljZT1Ob25lKToKICAgICAgICAjIFRPRE86IENvbXBsZXRlIHNlbGwgZmxvdwogICAgICAgIHBhc3MKICAgIAogICAgZGVmIGdldF9leGVjdXRpb25fcmVwb3J0KHNlbGYpOgogICAgICAgICMgVE9ETzogUmV0dXJuIGV4ZWN1dGlvbiBhbmFseXRpY3MKICAgICAgICBwYXNz"><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-10-9')" type="button">Run</button></div><pre><code><span class="c1"># Module Project</span>
<span class="k">class</span> <span class="nc">CompleteOrderSystem</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exchange</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span> <span class="o">=</span> <span class="n">exchange</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">builder</span> <span class="o">=</span> <span class="n">OrderBuilder</span><span class="p">(</span><span class="n">exchange</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">executor</span> <span class="o">=</span> <span class="n">OrderExecutor</span><span class="p">(</span><span class="n">exchange</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">manager</span> <span class="o">=</span> <span class="n">OrderManager</span><span class="p">(</span><span class="n">exchange</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">analyzer</span> <span class="o">=</span> <span class="n">ExecutionAnalyzer</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">buy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">order_type</span><span class="o">=</span><span class="s1">&#39;market&#39;</span><span class="p">,</span> <span class="n">price</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># TODO: Complete buy flow</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">sell</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">order_type</span><span class="o">=</span><span class="s1">&#39;market&#39;</span><span class="p">,</span> <span class="n">price</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># TODO: Complete sell flow</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">get_execution_report</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># TODO: Return execution analytics</span>
        <span class="k">pass</span>
</code></pre><div class="code-output" id="output-cell-10-9"></div></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">CompleteOrderSystem</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exchange</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span> <span class="o">=</span> <span class="n">exchange</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">builder</span> <span class="o">=</span> <span class="n">OrderBuilder</span><span class="p">(</span><span class="n">exchange</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">executor</span> <span class="o">=</span> <span class="n">OrderExecutor</span><span class="p">(</span><span class="n">exchange</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">manager</span> <span class="o">=</span> <span class="n">OrderManager</span><span class="p">(</span><span class="n">exchange</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">analyzer</span> <span class="o">=</span> <span class="n">ExecutionAnalyzer</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">buy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">order_type</span><span class="o">=</span><span class="s1">&#39;market&#39;</span><span class="p">,</span> <span class="n">price</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># Build order</span>
        <span class="k">if</span> <span class="n">order_type</span> <span class="o">==</span> <span class="s1">&#39;market&#39;</span><span class="p">:</span>
            <span class="n">order_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">market_buy</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">amount</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">order_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">limit_buy</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">price</span><span class="p">)</span>

        <span class="c1"># Validate</span>
        <span class="n">validation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">validate_order</span><span class="p">(</span><span class="n">order_params</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">validation</span><span class="p">[</span><span class="s1">&#39;valid&#39;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;issues&#39;</span><span class="p">:</span> <span class="n">validation</span><span class="p">[</span><span class="s1">&#39;issues&#39;</span><span class="p">]}</span>

        <span class="c1"># Get pre-trade price</span>
        <span class="n">pre_price</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="o">.</span><span class="n">fetch_ticker</span><span class="p">(</span><span class="n">symbol</span><span class="p">)[</span><span class="s1">&#39;ask&#39;</span><span class="p">]</span>

        <span class="c1"># Execute</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">executor</span><span class="o">.</span><span class="n">place_order</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="s1">&#39;buy&#39;</span><span class="p">,</span> <span class="n">order_type</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">price</span><span class="p">)</span>

        <span class="c1"># Record for analysis</span>
        <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;success&#39;</span><span class="p">]:</span>
            <span class="n">actual_price</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;order&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;average&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;order&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;price&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">actual_price</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">analyzer</span><span class="o">.</span><span class="n">record_execution</span><span class="p">(</span><span class="n">pre_price</span><span class="p">,</span> <span class="n">actual_price</span><span class="p">,</span> <span class="s1">&#39;buy&#39;</span><span class="p">,</span> <span class="n">amount</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">sell</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">order_type</span><span class="o">=</span><span class="s1">&#39;market&#39;</span><span class="p">,</span> <span class="n">price</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">order_type</span> <span class="o">==</span> <span class="s1">&#39;market&#39;</span><span class="p">:</span>
            <span class="n">order_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">market_sell</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">amount</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">order_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">limit_sell</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">price</span><span class="p">)</span>

        <span class="n">validation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">validate_order</span><span class="p">(</span><span class="n">order_params</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">validation</span><span class="p">[</span><span class="s1">&#39;valid&#39;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;issues&#39;</span><span class="p">:</span> <span class="n">validation</span><span class="p">[</span><span class="s1">&#39;issues&#39;</span><span class="p">]}</span>

        <span class="n">pre_price</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="o">.</span><span class="n">fetch_ticker</span><span class="p">(</span><span class="n">symbol</span><span class="p">)[</span><span class="s1">&#39;bid&#39;</span><span class="p">]</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">executor</span><span class="o">.</span><span class="n">place_order</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="s1">&#39;sell&#39;</span><span class="p">,</span> <span class="n">order_type</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">price</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;success&#39;</span><span class="p">]:</span>
            <span class="n">actual_price</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;order&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;average&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;order&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;price&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">actual_price</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">analyzer</span><span class="o">.</span><span class="n">record_execution</span><span class="p">(</span><span class="n">pre_price</span><span class="p">,</span> <span class="n">actual_price</span><span class="p">,</span> <span class="s1">&#39;sell&#39;</span><span class="p">,</span> <span class="n">amount</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">get_execution_report</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyzer</span><span class="o">.</span><span class="n">get_statistics</span><span class="p">()</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>ğŸ“ Key Takeaways</h1>
<ol>
<li><strong>Order Types</strong>: Choose based on urgency vs price sensitivity</li>
<li><strong>Pre-Trade Checks</strong>: Always validate before placing orders</li>
<li><strong>Order Management</strong>: Track all orders and handle failures gracefully</li>
<li><strong>Execution Analysis</strong>: Monitor slippage to improve strategy</li>
</ol>
<hr />
<p><em>Next: Module 11 - Live Trading</em></p></div>
        <div class="nav-buttons">
            <button class="nav-btn prev-btn disabled" type="button">
                <span class="nav-btn-label">â† Previous</span>
                <span class="nav-btn-name"></span>
            </button>
            <button class="nav-btn next-btn disabled" type="button">
                <span class="nav-btn-label">Next â†’</span>
                <span class="nav-btn-name"></span>
            </button>
        </div>
        </div>
<div class="module-section" data-idx="11"><div class="md-cell module-header"><h1>Module 11: Live Trading</h1>
<h2>Part 3: Exchange Integration</h2>
<hr />
<div class="table-wrapper"><table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>â±ï¸ <strong>Duration</strong></td>
<td>~2.5 hours</td>
</tr>
<tr>
<td>ğŸ“‹ <strong>Prerequisites</strong></td>
<td>Module 10</td>
</tr>
<tr>
<td>ğŸ’ª <strong>Exercises</strong></td>
<td>5 total</td>
</tr>
</tbody>
</table></div></div>
<div class="md-cell"><h2>ğŸ¯ Learning Objectives</h2>
<ul>
<li>Complete pre-launch validation</li>
<li>Monitor live trades in real-time</li>
<li>Handle edge cases and errors</li>
<li>Track and report performance</li>
</ul></div>
<div class="md-cell"><hr />
<h1>Section 1: Pre-Launch Checklist</h1>
<h2>1.1 System Validation</h2></div>
<div class="code-cell" id="cell-11-0" data-source="ZnJvbSBkYXRldGltZSBpbXBvcnQgZGF0ZXRpbWUKaW1wb3J0IHRpbWUKCmNsYXNzIFByZUxhdW5jaFZhbGlkYXRvcjoKICAgICIiIlZhbGlkYXRlIGFsbCBzeXN0ZW1zIGJlZm9yZSBnb2luZyBsaXZlLiIiIgogICAgCiAgICBkZWYgX19pbml0X18oc2VsZiwgZXhjaGFuZ2UsIHN0cmF0ZWd5LCByaXNrX21hbmFnZXIpOgogICAgICAgIHNlbGYuZXhjaGFuZ2UgPSBleGNoYW5nZQogICAgICAgIHNlbGYuc3RyYXRlZ3kgPSBzdHJhdGVneQogICAgICAgIHNlbGYucmlza19tYW5hZ2VyID0gcmlza19tYW5hZ2VyCiAgICAgICAgc2VsZi5jaGVja3MgPSBbXQogICAgCiAgICBkZWYgY2hlY2tfYXBpX2Nvbm5lY3Rpb24oc2VsZik6CiAgICAgICAgIiIiVmVyaWZ5IEFQSSBjb25uZWN0aXZpdHkuIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICBzZWxmLmV4Y2hhbmdlLmZldGNoX3RpY2tlcignQlRDL1VTRFQnKQogICAgICAgICAgICByZXR1cm4geyduYW1lJzogJ0FQSSBDb25uZWN0aW9uJywgJ3Bhc3NlZCc6IFRydWV9CiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICByZXR1cm4geyduYW1lJzogJ0FQSSBDb25uZWN0aW9uJywgJ3Bhc3NlZCc6IEZhbHNlLCAnZXJyb3InOiBzdHIoZSl9CiAgICAKICAgIGRlZiBjaGVja19iYWxhbmNlKHNlbGYsIG1pbl9iYWxhbmNlPTEwMCk6CiAgICAgICAgIiIiVmVyaWZ5IHN1ZmZpY2llbnQgYmFsYW5jZS4iIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgIGJhbGFuY2UgPSBzZWxmLmV4Y2hhbmdlLmZldGNoX2JhbGFuY2UoKQogICAgICAgICAgICB1c2R0ID0gYmFsYW5jZVsnZnJlZSddLmdldCgnVVNEVCcsIDApCiAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICAnbmFtZSc6ICdCYWxhbmNlIENoZWNrJywKICAgICAgICAgICAgICAgICdwYXNzZWQnOiB1c2R0ID49IG1pbl9iYWxhbmNlLAogICAgICAgICAgICAgICAgJ2JhbGFuY2UnOiB1c2R0LAogICAgICAgICAgICAgICAgJ3JlcXVpcmVkJzogbWluX2JhbGFuY2UKICAgICAgICAgICAgfQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgcmV0dXJuIHsnbmFtZSc6ICdCYWxhbmNlIENoZWNrJywgJ3Bhc3NlZCc6IEZhbHNlLCAnZXJyb3InOiBzdHIoZSl9CiAgICAKICAgIGRlZiBjaGVja190cmFkaW5nX3Blcm1pc3Npb25zKHNlbGYpOgogICAgICAgICIiIlZlcmlmeSB0cmFkaW5nIGlzIGVuYWJsZWQuIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIE1vc3QgZXhjaGFuZ2VzIHJlcXVpcmUgYSBzbWFsbCB0ZXN0IG9yZGVyIHRvIHZlcmlmeQogICAgICAgICAgICBoYXNfdHJhZGluZyA9IHNlbGYuZXhjaGFuZ2UuaGFzLmdldCgnY3JlYXRlT3JkZXInLCBGYWxzZSkKICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgICduYW1lJzogJ1RyYWRpbmcgUGVybWlzc2lvbnMnLAogICAgICAgICAgICAgICAgJ3Bhc3NlZCc6IGhhc190cmFkaW5nCiAgICAgICAgICAgIH0KICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHJldHVybiB7J25hbWUnOiAnVHJhZGluZyBQZXJtaXNzaW9ucycsICdwYXNzZWQnOiBGYWxzZSwgJ2Vycm9yJzogc3RyKGUpfQogICAgCiAgICBkZWYgY2hlY2tfcmlza19wYXJhbWV0ZXJzKHNlbGYpOgogICAgICAgICIiIlZlcmlmeSByaXNrIHBhcmFtZXRlcnMgYXJlIHNldC4iIiIKICAgICAgICBjaGVja3MgPSB7CiAgICAgICAgICAgICdtYXhfcG9zaXRpb25fc2l6ZSc6IGhhc2F0dHIoc2VsZi5yaXNrX21hbmFnZXIsICdtYXhfcG9zaXRpb24nKSwKICAgICAgICAgICAgJ3N0b3BfbG9zc19lbmFibGVkJzogaGFzYXR0cihzZWxmLnJpc2tfbWFuYWdlciwgJ3N0b3BfbG9zcycpLAogICAgICAgICAgICAnbWF4X2RhaWx5X2xvc3MnOiBoYXNhdHRyKHNlbGYucmlza19tYW5hZ2VyLCAnbWF4X2RhaWx5X2xvc3MnKQogICAgICAgIH0KICAgICAgICByZXR1cm4gewogICAgICAgICAgICAnbmFtZSc6ICdSaXNrIFBhcmFtZXRlcnMnLAogICAgICAgICAgICAncGFzc2VkJzogYWxsKGNoZWNrcy52YWx1ZXMoKSksCiAgICAgICAgICAgICdkZXRhaWxzJzogY2hlY2tzCiAgICAgICAgfQogICAgCiAgICBkZWYgcnVuX2FsbF9jaGVja3Moc2VsZik6CiAgICAgICAgIiIiUnVuIGNvbXBsZXRlIHByZS1sYXVuY2ggdmFsaWRhdGlvbi4iIiIKICAgICAgICBzZWxmLmNoZWNrcyA9IFsKICAgICAgICAgICAgc2VsZi5jaGVja19hcGlfY29ubmVjdGlvbigpLAogICAgICAgICAgICBzZWxmLmNoZWNrX2JhbGFuY2UoKSwKICAgICAgICAgICAgc2VsZi5jaGVja190cmFkaW5nX3Blcm1pc3Npb25zKCksCiAgICAgICAgICAgIHNlbGYuY2hlY2tfcmlza19wYXJhbWV0ZXJzKCkKICAgICAgICBdCiAgICAgICAgCiAgICAgICAgYWxsX3Bhc3NlZCA9IGFsbChjWydwYXNzZWQnXSBmb3IgYyBpbiBzZWxmLmNoZWNrcykKICAgICAgICAKICAgICAgICByZXR1cm4gewogICAgICAgICAgICAncmVhZHlfdG9fbGF1bmNoJzogYWxsX3Bhc3NlZCwKICAgICAgICAgICAgJ2NoZWNrcyc6IHNlbGYuY2hlY2tzLAogICAgICAgICAgICAndGltZXN0YW1wJzogZGF0ZXRpbWUubm93KCkKICAgICAgICB9CiAgICAKICAgIGRlZiBwcmludF9yZXBvcnQoc2VsZik6CiAgICAgICAgIiIiUHJpbnQgZm9ybWF0dGVkIHZhbGlkYXRpb24gcmVwb3J0LiIiIgogICAgICAgIHByaW50KCc9JyAqIDYwKQogICAgICAgIHByaW50KCcgICAgICAgUFJFLUxBVU5DSCBWQUxJREFUSU9OIFJFUE9SVCcpCiAgICAgICAgcHJpbnQoJz0nICogNjApCiAgICAgICAgCiAgICAgICAgZm9yIGNoZWNrIGluIHNlbGYuY2hlY2tzOgogICAgICAgICAgICBzdGF0dXMgPSAn4pyFJyBpZiBjaGVja1sncGFzc2VkJ10gZWxzZSAn4p2MJwogICAgICAgICAgICBwcmludChmIntzdGF0dXN9IHtjaGVja1snbmFtZSddfSIpCiAgICAgICAgICAgIGlmICdlcnJvcicgaW4gY2hlY2s6CiAgICAgICAgICAgICAgICBwcmludChmIiAgIEVycm9yOiB7Y2hlY2tbJ2Vycm9yJ119IikKICAgICAgICAgICAgaWYgJ2RldGFpbHMnIGluIGNoZWNrOgogICAgICAgICAgICAgICAgZm9yIGssIHYgaW4gY2hlY2tbJ2RldGFpbHMnXS5pdGVtcygpOgogICAgICAgICAgICAgICAgICAgIHByaW50KGYiICAge2t9OiB7J+KckycgaWYgdiBlbHNlICfinJcnfSIpCiAgICAgICAgCiAgICAgICAgcHJpbnQoJz0nICogNjAp"><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-11-0')" type="button">Run</button></div><pre><code><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="k">class</span> <span class="nc">PreLaunchValidator</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Validate all systems before going live.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exchange</span><span class="p">,</span> <span class="n">strategy</span><span class="p">,</span> <span class="n">risk_manager</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span> <span class="o">=</span> <span class="n">exchange</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">strategy</span> <span class="o">=</span> <span class="n">strategy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">risk_manager</span> <span class="o">=</span> <span class="n">risk_manager</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checks</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">def</span> <span class="nf">check_api_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Verify API connectivity.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="o">.</span><span class="n">fetch_ticker</span><span class="p">(</span><span class="s1">&#39;BTC/USDT&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;API Connection&#39;</span><span class="p">,</span> <span class="s1">&#39;passed&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;API Connection&#39;</span><span class="p">,</span> <span class="s1">&#39;passed&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>
    
    <span class="k">def</span> <span class="nf">check_balance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">min_balance</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Verify sufficient balance.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">balance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="o">.</span><span class="n">fetch_balance</span><span class="p">()</span>
            <span class="n">usdt</span> <span class="o">=</span> <span class="n">balance</span><span class="p">[</span><span class="s1">&#39;free&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;USDT&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Balance Check&#39;</span><span class="p">,</span>
                <span class="s1">&#39;passed&#39;</span><span class="p">:</span> <span class="n">usdt</span> <span class="o">&gt;=</span> <span class="n">min_balance</span><span class="p">,</span>
                <span class="s1">&#39;balance&#39;</span><span class="p">:</span> <span class="n">usdt</span><span class="p">,</span>
                <span class="s1">&#39;required&#39;</span><span class="p">:</span> <span class="n">min_balance</span>
            <span class="p">}</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Balance Check&#39;</span><span class="p">,</span> <span class="s1">&#39;passed&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>
    
    <span class="k">def</span> <span class="nf">check_trading_permissions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Verify trading is enabled.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Most exchanges require a small test order to verify</span>
            <span class="n">has_trading</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="o">.</span><span class="n">has</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;createOrder&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Trading Permissions&#39;</span><span class="p">,</span>
                <span class="s1">&#39;passed&#39;</span><span class="p">:</span> <span class="n">has_trading</span>
            <span class="p">}</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Trading Permissions&#39;</span><span class="p">,</span> <span class="s1">&#39;passed&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>
    
    <span class="k">def</span> <span class="nf">check_risk_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Verify risk parameters are set.&quot;&quot;&quot;</span>
        <span class="n">checks</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;max_position_size&#39;</span><span class="p">:</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">risk_manager</span><span class="p">,</span> <span class="s1">&#39;max_position&#39;</span><span class="p">),</span>
            <span class="s1">&#39;stop_loss_enabled&#39;</span><span class="p">:</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">risk_manager</span><span class="p">,</span> <span class="s1">&#39;stop_loss&#39;</span><span class="p">),</span>
            <span class="s1">&#39;max_daily_loss&#39;</span><span class="p">:</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">risk_manager</span><span class="p">,</span> <span class="s1">&#39;max_daily_loss&#39;</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Risk Parameters&#39;</span><span class="p">,</span>
            <span class="s1">&#39;passed&#39;</span><span class="p">:</span> <span class="nb">all</span><span class="p">(</span><span class="n">checks</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span>
            <span class="s1">&#39;details&#39;</span><span class="p">:</span> <span class="n">checks</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">run_all_checks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Run complete pre-launch validation.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checks</span> <span class="o">=</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_api_connection</span><span class="p">(),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_balance</span><span class="p">(),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_trading_permissions</span><span class="p">(),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_risk_parameters</span><span class="p">()</span>
        <span class="p">]</span>
        
        <span class="n">all_passed</span> <span class="o">=</span> <span class="nb">all</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;passed&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">checks</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;ready_to_launch&#39;</span><span class="p">:</span> <span class="n">all_passed</span><span class="p">,</span>
            <span class="s1">&#39;checks&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">checks</span><span class="p">,</span>
            <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">print_report</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Print formatted validation report.&quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=&#39;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;       PRE-LAUNCH VALIDATION REPORT&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=&#39;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">check</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">checks</span><span class="p">:</span>
            <span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;âœ…&#39;</span> <span class="k">if</span> <span class="n">check</span><span class="p">[</span><span class="s1">&#39;passed&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;âŒ&#39;</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">status</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">check</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;error&#39;</span> <span class="ow">in</span> <span class="n">check</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Error: </span><span class="si">{</span><span class="n">check</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;details&#39;</span> <span class="ow">in</span> <span class="n">check</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">check</span><span class="p">[</span><span class="s1">&#39;details&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="s1">&#39;âœ“&#39;</span> <span class="k">if</span> <span class="n">v</span> <span class="k">else</span> <span class="s1">&#39;âœ—&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=&#39;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
</code></pre><div class="code-output" id="output-cell-11-0"></div></div>
<div class="md-cell"><h3>âœï¸ Exercise 11.1: Launch Checklist</h3>
<p>Create a comprehensive launch checklist with custom checks.</p></div>
<div class="code-cell" id="cell-11-1" data-source="IyBFeGVyY2lzZSAxMS4xCmNsYXNzIExhdW5jaENoZWNrbGlzdDoKICAgIGRlZiBfX2luaXRfXyhzZWxmKToKICAgICAgICBzZWxmLmNoZWNrcyA9IHt9CiAgICAgICAgc2VsZi5yZXN1bHRzID0ge30KICAgIAogICAgZGVmIGFkZF9jaGVjayhzZWxmLCBuYW1lLCBjaGVja19mdW5jLCBjcml0aWNhbD1UcnVlKToKICAgICAgICAjIFRPRE86IEFkZCBjdXN0b20gY2hlY2sKICAgICAgICBwYXNzCiAgICAKICAgIGRlZiBydW5fYWxsKHNlbGYpOgogICAgICAgICMgVE9ETzogUnVuIGFsbCBjaGVja3MgYW5kIHJldHVybiByZXN1bHRzCiAgICAgICAgcGFzcwogICAgCiAgICBkZWYgY2FuX2xhdW5jaChzZWxmKToKICAgICAgICAjIFRPRE86IFJldHVybiBUcnVlIG9ubHkgaWYgYWxsIGNyaXRpY2FsIGNoZWNrcyBwYXNzCiAgICAgICAgcGFzcw=="><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-11-1')" type="button">Run</button></div><pre><code><span class="c1"># Exercise 11.1</span>
<span class="k">class</span> <span class="nc">LaunchChecklist</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checks</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="k">def</span> <span class="nf">add_check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">check_func</span><span class="p">,</span> <span class="n">critical</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="c1"># TODO: Add custom check</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">run_all</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># TODO: Run all checks and return results</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">can_launch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># TODO: Return True only if all critical checks pass</span>
        <span class="k">pass</span>
</code></pre><div class="code-output" id="output-cell-11-1"></div></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">LaunchChecklist</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checks</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">add_check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">check_func</span><span class="p">,</span> <span class="n">critical</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checks</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;func&#39;</span><span class="p">:</span> <span class="n">check_func</span><span class="p">,</span>
            <span class="s1">&#39;critical&#39;</span><span class="p">:</span> <span class="n">critical</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">run_all</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">check</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">checks</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">check</span><span class="p">[</span><span class="s1">&#39;func&#39;</span><span class="p">]()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;passed&#39;</span><span class="p">:</span> <span class="n">result</span><span class="p">,</span>
                    <span class="s1">&#39;critical&#39;</span><span class="p">:</span> <span class="n">check</span><span class="p">[</span><span class="s1">&#39;critical&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="kc">None</span>
                <span class="p">}</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;passed&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="s1">&#39;critical&#39;</span><span class="p">:</span> <span class="n">check</span><span class="p">[</span><span class="s1">&#39;critical&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="p">}</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span>

    <span class="k">def</span> <span class="nf">can_launch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run_all</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;critical&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;passed&#39;</span><span class="p">]:</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">get_failures</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="n">name</span><span class="p">:</span> <span class="n">result</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;passed&#39;</span><span class="p">]</span>
        <span class="p">}</span>

<span class="c1"># Usage</span>
<span class="n">checklist</span> <span class="o">=</span> <span class="n">LaunchChecklist</span><span class="p">()</span>
<span class="n">checklist</span><span class="o">.</span><span class="n">add_check</span><span class="p">(</span><span class="s1">&#39;API&#39;</span><span class="p">,</span> <span class="k">lambda</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="n">critical</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">checklist</span><span class="o">.</span><span class="n">add_check</span><span class="p">(</span><span class="s1">&#39;Balance&#39;</span><span class="p">,</span> <span class="k">lambda</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="n">critical</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">checklist</span><span class="o">.</span><span class="n">add_check</span><span class="p">(</span><span class="s1">&#39;Backup&#39;</span><span class="p">,</span> <span class="k">lambda</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="n">critical</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">checklist</span><span class="o">.</span><span class="n">run_all</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Can launch: </span><span class="si">{</span><span class="n">checklist</span><span class="o">.</span><span class="n">can_launch</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>Section 2: Monitoring Live Trades</h1></div>
<div class="code-cell" id="cell-11-2" data-source="Y2xhc3MgTGl2ZVRyYWRlTW9uaXRvcjoKICAgICIiIk1vbml0b3IgbGl2ZSB0cmFkaW5nIGFjdGl2aXR5LiIiIgogICAgCiAgICBkZWYgX19pbml0X18oc2VsZiwgZXhjaGFuZ2UpOgogICAgICAgIHNlbGYuZXhjaGFuZ2UgPSBleGNoYW5nZQogICAgICAgIHNlbGYucG9zaXRpb25zID0ge30KICAgICAgICBzZWxmLmRhaWx5X3BubCA9IDAKICAgICAgICBzZWxmLnRyYWRlc190b2RheSA9IDAKICAgICAgICBzZWxmLnN0YXJ0X2JhbGFuY2UgPSAwCiAgICAKICAgIGRlZiBpbml0aWFsaXplKHNlbGYpOgogICAgICAgICIiIlNldCBzdGFydGluZyBzdGF0ZS4iIiIKICAgICAgICBiYWxhbmNlID0gc2VsZi5leGNoYW5nZS5mZXRjaF9iYWxhbmNlKCkKICAgICAgICBzZWxmLnN0YXJ0X2JhbGFuY2UgPSBiYWxhbmNlWyd0b3RhbCddLmdldCgnVVNEVCcsIDApCiAgICAgICAgc2VsZi5kYWlseV9wbmwgPSAwCiAgICAgICAgc2VsZi50cmFkZXNfdG9kYXkgPSAwCiAgICAgICAgcmV0dXJuIHNlbGYuc3RhcnRfYmFsYW5jZQogICAgCiAgICBkZWYgdXBkYXRlX3Bvc2l0aW9uKHNlbGYsIHN5bWJvbCwgc2lkZSwgYW1vdW50LCBwcmljZSk6CiAgICAgICAgIiIiVXBkYXRlIHBvc2l0aW9uIHRyYWNraW5nLiIiIgogICAgICAgIGlmIHN5bWJvbCBub3QgaW4gc2VsZi5wb3NpdGlvbnM6CiAgICAgICAgICAgIHNlbGYucG9zaXRpb25zW3N5bWJvbF0gPSB7J2Ftb3VudCc6IDAsICdhdmdfcHJpY2UnOiAwLCAncmVhbGl6ZWRfcG5sJzogMH0KICAgICAgICAKICAgICAgICBwb3MgPSBzZWxmLnBvc2l0aW9uc1tzeW1ib2xdCiAgICAgICAgCiAgICAgICAgaWYgc2lkZSA9PSAnYnV5JzoKICAgICAgICAgICAgIyBVcGRhdGUgYXZlcmFnZSBwcmljZQogICAgICAgICAgICB0b3RhbF9jb3N0ID0gKHBvc1snYW1vdW50J10gKiBwb3NbJ2F2Z19wcmljZSddKSArIChhbW91bnQgKiBwcmljZSkKICAgICAgICAgICAgcG9zWydhbW91bnQnXSArPSBhbW91bnQKICAgICAgICAgICAgcG9zWydhdmdfcHJpY2UnXSA9IHRvdGFsX2Nvc3QgLyBwb3NbJ2Ftb3VudCddIGlmIHBvc1snYW1vdW50J10gPiAwIGVsc2UgMAogICAgICAgIGVsc2U6ICAjIHNlbGwKICAgICAgICAgICAgIyBDYWxjdWxhdGUgcmVhbGl6ZWQgUG5MCiAgICAgICAgICAgIHBubCA9IChwcmljZSAtIHBvc1snYXZnX3ByaWNlJ10pICogYW1vdW50CiAgICAgICAgICAgIHBvc1sncmVhbGl6ZWRfcG5sJ10gKz0gcG5sCiAgICAgICAgICAgIHNlbGYuZGFpbHlfcG5sICs9IHBubAogICAgICAgICAgICBwb3NbJ2Ftb3VudCddIC09IGFtb3VudAogICAgICAgIAogICAgICAgIHNlbGYudHJhZGVzX3RvZGF5ICs9IDEKICAgICAgICByZXR1cm4gcG9zCiAgICAKICAgIGRlZiBnZXRfdW5yZWFsaXplZF9wbmwoc2VsZiwgY3VycmVudF9wcmljZXMpOgogICAgICAgICIiIkNhbGN1bGF0ZSB1bnJlYWxpemVkIFBuTCBmb3Igb3BlbiBwb3NpdGlvbnMuIiIiCiAgICAgICAgdW5yZWFsaXplZCA9IDAKICAgICAgICBmb3Igc3ltYm9sLCBwb3MgaW4gc2VsZi5wb3NpdGlvbnMuaXRlbXMoKToKICAgICAgICAgICAgaWYgcG9zWydhbW91bnQnXSA+IDAgYW5kIHN5bWJvbCBpbiBjdXJyZW50X3ByaWNlczoKICAgICAgICAgICAgICAgIHVucmVhbGl6ZWQgKz0gKGN1cnJlbnRfcHJpY2VzW3N5bWJvbF0gLSBwb3NbJ2F2Z19wcmljZSddKSAqIHBvc1snYW1vdW50J10KICAgICAgICByZXR1cm4gdW5yZWFsaXplZAogICAgCiAgICBkZWYgZ2V0X3N0YXR1cyhzZWxmLCBjdXJyZW50X3ByaWNlcz1Ob25lKToKICAgICAgICAiIiJHZXQgY3VycmVudCB0cmFkaW5nIHN0YXR1cy4iIiIKICAgICAgICBjdXJyZW50X3ByaWNlcyA9IGN1cnJlbnRfcHJpY2VzIG9yIHt9CiAgICAgICAgdW5yZWFsaXplZCA9IHNlbGYuZ2V0X3VucmVhbGl6ZWRfcG5sKGN1cnJlbnRfcHJpY2VzKQogICAgICAgIAogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICdwb3NpdGlvbnMnOiBzZWxmLnBvc2l0aW9ucywKICAgICAgICAgICAgJ3JlYWxpemVkX3BubCc6IHNlbGYuZGFpbHlfcG5sLAogICAgICAgICAgICAndW5yZWFsaXplZF9wbmwnOiB1bnJlYWxpemVkLAogICAgICAgICAgICAndG90YWxfcG5sJzogc2VsZi5kYWlseV9wbmwgKyB1bnJlYWxpemVkLAogICAgICAgICAgICAndHJhZGVzX3RvZGF5Jzogc2VsZi50cmFkZXNfdG9kYXksCiAgICAgICAgICAgICdyZXR1cm5fcGN0JzogKHNlbGYuZGFpbHlfcG5sIC8gc2VsZi5zdGFydF9iYWxhbmNlICogMTAwKSBpZiBzZWxmLnN0YXJ0X2JhbGFuY2UgZWxzZSAwCiAgICAgICAgfQ=="><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-11-2')" type="button">Run</button></div><pre><code><span class="k">class</span> <span class="nc">LiveTradeMonitor</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Monitor live trading activity.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exchange</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span> <span class="o">=</span> <span class="n">exchange</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">positions</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">daily_pnl</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trades_today</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_balance</span> <span class="o">=</span> <span class="mi">0</span>
    
    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set starting state.&quot;&quot;&quot;</span>
        <span class="n">balance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="o">.</span><span class="n">fetch_balance</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_balance</span> <span class="o">=</span> <span class="n">balance</span><span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;USDT&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">daily_pnl</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trades_today</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_balance</span>
    
    <span class="k">def</span> <span class="nf">update_position</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">side</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">price</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update position tracking.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">symbol</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;amount&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;avg_price&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;realized_pnl&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
        
        <span class="n">pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="n">side</span> <span class="o">==</span> <span class="s1">&#39;buy&#39;</span><span class="p">:</span>
            <span class="c1"># Update average price</span>
            <span class="n">total_cost</span> <span class="o">=</span> <span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="s1">&#39;amount&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">pos</span><span class="p">[</span><span class="s1">&#39;avg_price&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="p">(</span><span class="n">amount</span> <span class="o">*</span> <span class="n">price</span><span class="p">)</span>
            <span class="n">pos</span><span class="p">[</span><span class="s1">&#39;amount&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">amount</span>
            <span class="n">pos</span><span class="p">[</span><span class="s1">&#39;avg_price&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">total_cost</span> <span class="o">/</span> <span class="n">pos</span><span class="p">[</span><span class="s1">&#39;amount&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">pos</span><span class="p">[</span><span class="s1">&#39;amount&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># sell</span>
            <span class="c1"># Calculate realized PnL</span>
            <span class="n">pnl</span> <span class="o">=</span> <span class="p">(</span><span class="n">price</span> <span class="o">-</span> <span class="n">pos</span><span class="p">[</span><span class="s1">&#39;avg_price&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="n">amount</span>
            <span class="n">pos</span><span class="p">[</span><span class="s1">&#39;realized_pnl&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">pnl</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">daily_pnl</span> <span class="o">+=</span> <span class="n">pnl</span>
            <span class="n">pos</span><span class="p">[</span><span class="s1">&#39;amount&#39;</span><span class="p">]</span> <span class="o">-=</span> <span class="n">amount</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">trades_today</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">pos</span>
    
    <span class="k">def</span> <span class="nf">get_unrealized_pnl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current_prices</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculate unrealized PnL for open positions.&quot;&quot;&quot;</span>
        <span class="n">unrealized</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">pos</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">pos</span><span class="p">[</span><span class="s1">&#39;amount&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="n">current_prices</span><span class="p">:</span>
                <span class="n">unrealized</span> <span class="o">+=</span> <span class="p">(</span><span class="n">current_prices</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span> <span class="o">-</span> <span class="n">pos</span><span class="p">[</span><span class="s1">&#39;avg_price&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="n">pos</span><span class="p">[</span><span class="s1">&#39;amount&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">unrealized</span>
    
    <span class="k">def</span> <span class="nf">get_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current_prices</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get current trading status.&quot;&quot;&quot;</span>
        <span class="n">current_prices</span> <span class="o">=</span> <span class="n">current_prices</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="n">unrealized</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_unrealized_pnl</span><span class="p">(</span><span class="n">current_prices</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;positions&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">,</span>
            <span class="s1">&#39;realized_pnl&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">daily_pnl</span><span class="p">,</span>
            <span class="s1">&#39;unrealized_pnl&#39;</span><span class="p">:</span> <span class="n">unrealized</span><span class="p">,</span>
            <span class="s1">&#39;total_pnl&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">daily_pnl</span> <span class="o">+</span> <span class="n">unrealized</span><span class="p">,</span>
            <span class="s1">&#39;trades_today&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">trades_today</span><span class="p">,</span>
            <span class="s1">&#39;return_pct&#39;</span><span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">daily_pnl</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_balance</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_balance</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="p">}</span>
</code></pre><div class="code-output" id="output-cell-11-2"></div></div>
<div class="md-cell"><h3>âœï¸ Exercise 11.2: Live Monitor</h3>
<p>Create a real-time monitoring system with alerts.</p></div>
<div class="code-cell" id="cell-11-3" data-source="IyBFeGVyY2lzZSAxMS4yCmNsYXNzIFJlYWxUaW1lTW9uaXRvcjoKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBleGNoYW5nZSwgYWxlcnRfY2FsbGJhY2s9Tm9uZSk6CiAgICAgICAgc2VsZi5leGNoYW5nZSA9IGV4Y2hhbmdlCiAgICAgICAgc2VsZi5hbGVydF9jYWxsYmFjayA9IGFsZXJ0X2NhbGxiYWNrCiAgICAgICAgc2VsZi50aHJlc2hvbGRzID0ge30KICAgIAogICAgZGVmIHNldF9hbGVydF90aHJlc2hvbGQoc2VsZiwgbWV0cmljLCB0aHJlc2hvbGQsIGRpcmVjdGlvbj0nYWJvdmUnKToKICAgICAgICAjIFRPRE86IFNldCBhbGVydCB0aHJlc2hvbGQKICAgICAgICBwYXNzCiAgICAKICAgIGRlZiBjaGVja19hbGVydHMoc2VsZiwgY3VycmVudF9zdGF0dXMpOgogICAgICAgICMgVE9ETzogQ2hlY2sgaWYgYW55IHRocmVzaG9sZHMgYnJlYWNoZWQKICAgICAgICBwYXNzCiAgICAKICAgIGRlZiBkaXNwbGF5X2Rhc2hib2FyZChzZWxmLCBzdGF0dXMpOgogICAgICAgICMgVE9ETzogUHJpbnQgbGl2ZSBkYXNoYm9hcmQKICAgICAgICBwYXNz"><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-11-3')" type="button">Run</button></div><pre><code><span class="c1"># Exercise 11.2</span>
<span class="k">class</span> <span class="nc">RealTimeMonitor</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exchange</span><span class="p">,</span> <span class="n">alert_callback</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span> <span class="o">=</span> <span class="n">exchange</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alert_callback</span> <span class="o">=</span> <span class="n">alert_callback</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thresholds</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="k">def</span> <span class="nf">set_alert_threshold</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="s1">&#39;above&#39;</span><span class="p">):</span>
        <span class="c1"># TODO: Set alert threshold</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">check_alerts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current_status</span><span class="p">):</span>
        <span class="c1"># TODO: Check if any thresholds breached</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">display_dashboard</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status</span><span class="p">):</span>
        <span class="c1"># TODO: Print live dashboard</span>
        <span class="k">pass</span>
</code></pre><div class="code-output" id="output-cell-11-3"></div></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">RealTimeMonitor</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exchange</span><span class="p">,</span> <span class="n">alert_callback</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span> <span class="o">=</span> <span class="n">exchange</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alert_callback</span> <span class="o">=</span> <span class="n">alert_callback</span> <span class="ow">or</span> <span class="nb">print</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thresholds</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alert_history</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">set_alert_threshold</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="s1">&#39;above&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thresholds</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;threshold&#39;</span><span class="p">:</span> <span class="n">threshold</span><span class="p">,</span>
            <span class="s1">&#39;direction&#39;</span><span class="p">:</span> <span class="n">direction</span><span class="p">,</span>
            <span class="s1">&#39;triggered&#39;</span><span class="p">:</span> <span class="kc">False</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">check_alerts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current_status</span><span class="p">):</span>
        <span class="n">triggered</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">metric</span><span class="p">,</span> <span class="n">config</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">thresholds</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">current_status</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">should_trigger</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;direction&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;above&#39;</span> <span class="ow">and</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;threshold&#39;</span><span class="p">]:</span>
                <span class="n">should_trigger</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">elif</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;direction&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;below&#39;</span> <span class="ow">and</span> <span class="n">value</span> <span class="o">&lt;</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;threshold&#39;</span><span class="p">]:</span>
                <span class="n">should_trigger</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">if</span> <span class="n">should_trigger</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;triggered&#39;</span><span class="p">]:</span>
                <span class="n">alert</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;metric&#39;</span><span class="p">:</span> <span class="n">metric</span><span class="p">,</span>
                    <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">value</span><span class="p">,</span>
                    <span class="s1">&#39;threshold&#39;</span><span class="p">:</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;threshold&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
                <span class="p">}</span>
                <span class="n">triggered</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">alert</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">alert_callback</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ğŸš¨ ALERT: </span><span class="si">{</span><span class="n">metric</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;direction&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;threshold&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
                <span class="n">config</span><span class="p">[</span><span class="s1">&#39;triggered&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">should_trigger</span><span class="p">:</span>
                <span class="n">config</span><span class="p">[</span><span class="s1">&#39;triggered&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">alert_history</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">triggered</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">triggered</span>

    <span class="k">def</span> <span class="nf">display_dashboard</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[2J</span><span class="se">\033</span><span class="s1">[H&#39;</span><span class="p">)</span>  <span class="c1"># Clear screen</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=&#39;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;         LIVE TRADING DASHBOARD&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;         &#39;</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=&#39;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Realized P&amp;L:   $</span><span class="si">{</span><span class="n">status</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;realized_pnl&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="si">:</span><span class="s2">&gt;10,.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unrealized P&amp;L: $</span><span class="si">{</span><span class="n">status</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;unrealized_pnl&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="si">:</span><span class="s2">&gt;10,.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total P&amp;L:      $</span><span class="si">{</span><span class="n">status</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;total_pnl&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="si">:</span><span class="s2">&gt;10,.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Return:         </span><span class="si">{</span><span class="n">status</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;return_pct&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="si">:</span><span class="s2">&gt;10.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-&#39;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Trades Today: </span><span class="si">{</span><span class="n">status</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;trades_today&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=&#39;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>Section 3: Handling Edge Cases</h1></div>
<div class="code-cell" id="cell-11-4" data-source="Y2xhc3MgRWRnZUNhc2VIYW5kbGVyOgogICAgIiIiSGFuZGxlIGVkZ2UgY2FzZXMgaW4gbGl2ZSB0cmFkaW5nLiIiIgogICAgCiAgICBkZWYgX19pbml0X18oc2VsZiwgZXhjaGFuZ2UsIGxvZ2dlcj1Ob25lKToKICAgICAgICBzZWxmLmV4Y2hhbmdlID0gZXhjaGFuZ2UKICAgICAgICBzZWxmLmxvZ2dlciA9IGxvZ2dlciBvciBwcmludAogICAgICAgIHNlbGYuZXJyb3JfY291bnRzID0ge30KICAgICAgICBzZWxmLm1heF9yZXRyaWVzID0gMwogICAgCiAgICBkZWYgaGFuZGxlX25ldHdvcmtfZXJyb3Ioc2VsZiwgZnVuYywgKmFyZ3MsICoqa3dhcmdzKToKICAgICAgICAiIiJSZXRyeSBvbiBuZXR3b3JrIGVycm9ycy4iIiIKICAgICAgICBmb3IgYXR0ZW1wdCBpbiByYW5nZShzZWxmLm1heF9yZXRyaWVzKToKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgcmV0dXJuIGZ1bmMoKmFyZ3MsICoqa3dhcmdzKQogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgICAgICBlcnJvcl90eXBlID0gdHlwZShlKS5fX25hbWVfXwogICAgICAgICAgICAgICAgc2VsZi5lcnJvcl9jb3VudHNbZXJyb3JfdHlwZV0gPSBzZWxmLmVycm9yX2NvdW50cy5nZXQoZXJyb3JfdHlwZSwgMCkgKyAxCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmICduZXR3b3JrJyBpbiBzdHIoZSkubG93ZXIoKSBvciAndGltZW91dCcgaW4gc3RyKGUpLmxvd2VyKCk6CiAgICAgICAgICAgICAgICAgICAgd2FpdCA9IDIgKiogYXR0ZW1wdAogICAgICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyKGYnTmV0d29yayBlcnJvciwgcmV0cnlpbmcgaW4ge3dhaXR9cy4uLicpCiAgICAgICAgICAgICAgICAgICAgdGltZS5zbGVlcCh3YWl0KQogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICByYWlzZQogICAgICAgIAogICAgICAgIHJhaXNlIEV4Y2VwdGlvbihmJ0ZhaWxlZCBhZnRlciB7c2VsZi5tYXhfcmV0cmllc30gcmV0cmllcycpCiAgICAKICAgIGRlZiBoYW5kbGVfZXhjaGFuZ2VfZG93bnRpbWUoc2VsZik6CiAgICAgICAgIiIiSGFuZGxlIGV4Y2hhbmdlIG1haW50ZW5hbmNlL2Rvd250aW1lLiIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgc3RhdHVzID0gc2VsZi5leGNoYW5nZS5mZXRjaF9zdGF0dXMoKQogICAgICAgICAgICBpZiBzdGF0dXMuZ2V0KCdzdGF0dXMnKSA9PSAnbWFpbnRlbmFuY2UnOgogICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIoJ+KaoO+4jyBFeGNoYW5nZSBpbiBtYWludGVuYW5jZSBtb2RlJykKICAgICAgICAgICAgICAgIHJldHVybiB7J2F2YWlsYWJsZSc6IEZhbHNlLCAncmVhc29uJzogJ21haW50ZW5hbmNlJ30KICAgICAgICAgICAgcmV0dXJuIHsnYXZhaWxhYmxlJzogVHJ1ZX0KICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgIHJldHVybiB7J2F2YWlsYWJsZSc6IEZhbHNlLCAncmVhc29uJzogJ3VucmVhY2hhYmxlJ30KICAgIAogICAgZGVmIHJlY29uY2lsZV9wb3NpdGlvbnMoc2VsZik6CiAgICAgICAgIiIiUmVjb25jaWxlIGxvY2FsIHBvc2l0aW9ucyB3aXRoIGV4Y2hhbmdlLiIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgZXhjaGFuZ2VfcG9zaXRpb25zID0gc2VsZi5leGNoYW5nZS5mZXRjaF9iYWxhbmNlKCkKICAgICAgICAgICAgcmV0dXJuIGV4Y2hhbmdlX3Bvc2l0aW9ucwogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgc2VsZi5sb2dnZXIoZidSZWNvbmNpbGlhdGlvbiBmYWlsZWQ6IHtlfScpCiAgICAgICAgICAgIHJldHVybiBOb25lCiAgICAKICAgIGRlZiBlbWVyZ2VuY3lfY2xvc2VfYWxsKHNlbGYpOgogICAgICAgICIiIkVtZXJnZW5jeSBjbG9zZSBhbGwgcG9zaXRpb25zLiIiIgogICAgICAgIHNlbGYubG9nZ2VyKCfwn5qoIEVNRVJHRU5DWTogQ2xvc2luZyBhbGwgcG9zaXRpb25zJykKICAgICAgICByZXN1bHRzID0gW10KICAgICAgICAKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgQ2FuY2VsIGFsbCBvcGVuIG9yZGVycyBmaXJzdAogICAgICAgICAgICBzZWxmLmV4Y2hhbmdlLmNhbmNlbF9hbGxfb3JkZXJzKCkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgR2V0IGN1cnJlbnQgcG9zaXRpb25zCiAgICAgICAgICAgIGJhbGFuY2UgPSBzZWxmLmV4Y2hhbmdlLmZldGNoX2JhbGFuY2UoKQogICAgICAgICAgICAKICAgICAgICAgICAgZm9yIGN1cnJlbmN5LCBhbW91bnQgaW4gYmFsYW5jZVsnZnJlZSddLml0ZW1zKCk6CiAgICAgICAgICAgICAgICBpZiBjdXJyZW5jeSAhPSAnVVNEVCcgYW5kIGFtb3VudCA+IDA6CiAgICAgICAgICAgICAgICAgICAgc3ltYm9sID0gZid7Y3VycmVuY3l9L1VTRFQnCiAgICAgICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgICAgICBvcmRlciA9IHNlbGYuZXhjaGFuZ2UuY3JlYXRlX21hcmtldF9vcmRlcihzeW1ib2wsICdzZWxsJywgYW1vdW50KQogICAgICAgICAgICAgICAgICAgICAgICByZXN1bHRzLmFwcGVuZCh7J3N5bWJvbCc6IHN5bWJvbCwgJ3N1Y2Nlc3MnOiBUcnVlLCAnb3JkZXInOiBvcmRlcn0pCiAgICAgICAgICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICAgICAgICAgICAgICByZXN1bHRzLmFwcGVuZCh7J3N5bWJvbCc6IHN5bWJvbCwgJ3N1Y2Nlc3MnOiBGYWxzZSwgJ2Vycm9yJzogc3RyKGUpfSkKICAgICAgICAgICAgCiAgICAgICAgICAgIHJldHVybiByZXN1bHRzCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBzZWxmLmxvZ2dlcihmJ0VtZXJnZW5jeSBjbG9zZSBmYWlsZWQ6IHtlfScpCiAgICAgICAgICAgIHJldHVybiBbeydlcnJvcic6IHN0cihlKX1d"><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-11-4')" type="button">Run</button></div><pre><code><span class="k">class</span> <span class="nc">EdgeCaseHandler</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Handle edge cases in live trading.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exchange</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span> <span class="o">=</span> <span class="n">exchange</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logger</span> <span class="ow">or</span> <span class="nb">print</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">error_counts</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_retries</span> <span class="o">=</span> <span class="mi">3</span>
    
    <span class="k">def</span> <span class="nf">handle_network_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Retry on network errors.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">attempt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_retries</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">error_type</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">error_counts</span><span class="p">[</span><span class="n">error_type</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_counts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">error_type</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
                
                <span class="k">if</span> <span class="s1">&#39;network&#39;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">or</span> <span class="s1">&#39;timeout&#39;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                    <span class="n">wait</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">**</span> <span class="n">attempt</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Network error, retrying in </span><span class="si">{</span><span class="n">wait</span><span class="si">}</span><span class="s1">s...&#39;</span><span class="p">)</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">wait</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span>
        
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Failed after </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">max_retries</span><span class="si">}</span><span class="s1"> retries&#39;</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">handle_exchange_downtime</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Handle exchange maintenance/downtime.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="o">.</span><span class="n">fetch_status</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">status</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;status&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;maintenance&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">(</span><span class="s1">&#39;âš ï¸ Exchange in maintenance mode&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;available&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="s1">&#39;maintenance&#39;</span><span class="p">}</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;available&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;available&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="s1">&#39;unreachable&#39;</span><span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">reconcile_positions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Reconcile local positions with exchange.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">exchange_positions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="o">.</span><span class="n">fetch_balance</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">exchange_positions</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Reconciliation failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
    
    <span class="k">def</span> <span class="nf">emergency_close_all</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Emergency close all positions.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">(</span><span class="s1">&#39;ğŸš¨ EMERGENCY: Closing all positions&#39;</span><span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Cancel all open orders first</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="o">.</span><span class="n">cancel_all_orders</span><span class="p">()</span>
            
            <span class="c1"># Get current positions</span>
            <span class="n">balance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="o">.</span><span class="n">fetch_balance</span><span class="p">()</span>
            
            <span class="k">for</span> <span class="n">currency</span><span class="p">,</span> <span class="n">amount</span> <span class="ow">in</span> <span class="n">balance</span><span class="p">[</span><span class="s1">&#39;free&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">currency</span> <span class="o">!=</span> <span class="s1">&#39;USDT&#39;</span> <span class="ow">and</span> <span class="n">amount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">symbol</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">currency</span><span class="si">}</span><span class="s1">/USDT&#39;</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="o">.</span><span class="n">create_market_order</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="s1">&#39;sell&#39;</span><span class="p">,</span> <span class="n">amount</span><span class="p">)</span>
                        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span> <span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;order&#39;</span><span class="p">:</span> <span class="n">order</span><span class="p">})</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span> <span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)})</span>
            
            <span class="k">return</span> <span class="n">results</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Emergency close failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}]</span>
</code></pre><div class="code-output" id="output-cell-11-4"></div></div>
<div class="md-cell"><h3>âœï¸ Exercise 11.3: Error Handler</h3>
<p>Build a comprehensive error handling system.</p></div>
<div class="code-cell" id="cell-11-5" data-source="IyBFeGVyY2lzZSAxMS4zCmNsYXNzIFRyYWRpbmdFcnJvckhhbmRsZXI6CiAgICBkZWYgX19pbml0X18oc2VsZik6CiAgICAgICAgc2VsZi5lcnJvcl9sb2cgPSBbXQogICAgICAgIHNlbGYucmVjb3ZlcnlfYWN0aW9ucyA9IHt9CiAgICAKICAgIGRlZiByZWdpc3Rlcl9yZWNvdmVyeShzZWxmLCBlcnJvcl90eXBlLCByZWNvdmVyeV9mdW5jKToKICAgICAgICAjIFRPRE86IFJlZ2lzdGVyIHJlY292ZXJ5IGFjdGlvbiBmb3IgZXJyb3IgdHlwZQogICAgICAgIHBhc3MKICAgIAogICAgZGVmIGhhbmRsZV9lcnJvcihzZWxmLCBlcnJvciwgY29udGV4dD1Ob25lKToKICAgICAgICAjIFRPRE86IExvZyBlcnJvciBhbmQgYXR0ZW1wdCByZWNvdmVyeQogICAgICAgIHBhc3MKICAgIAogICAgZGVmIHNob3VsZF9oYWx0KHNlbGYpOgogICAgICAgICMgVE9ETzogRGV0ZXJtaW5lIGlmIHN5c3RlbSBzaG91bGQgaGFsdCBiYXNlZCBvbiBlcnJvcnMKICAgICAgICBwYXNz"><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-11-5')" type="button">Run</button></div><pre><code><span class="c1"># Exercise 11.3</span>
<span class="k">class</span> <span class="nc">TradingErrorHandler</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">error_log</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">recovery_actions</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="k">def</span> <span class="nf">register_recovery</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">error_type</span><span class="p">,</span> <span class="n">recovery_func</span><span class="p">):</span>
        <span class="c1"># TODO: Register recovery action for error type</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">handle_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># TODO: Log error and attempt recovery</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">should_halt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># TODO: Determine if system should halt based on errors</span>
        <span class="k">pass</span>
</code></pre><div class="code-output" id="output-cell-11-5"></div></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">TradingErrorHandler</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_errors_per_hour</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">error_log</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">recovery_actions</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_errors_per_hour</span> <span class="o">=</span> <span class="n">max_errors_per_hour</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">critical_errors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;InsufficientFunds&#39;</span><span class="p">,</span> <span class="s1">&#39;AuthenticationError&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">register_recovery</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">error_type</span><span class="p">,</span> <span class="n">recovery_func</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">recovery_actions</span><span class="p">[</span><span class="n">error_type</span><span class="p">]</span> <span class="o">=</span> <span class="n">recovery_func</span>

    <span class="k">def</span> <span class="nf">handle_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">error_type</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">error</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span>

        <span class="n">log_entry</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="n">error_type</span><span class="p">,</span>
            <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">error</span><span class="p">),</span>
            <span class="s1">&#39;context&#39;</span><span class="p">:</span> <span class="n">context</span><span class="p">,</span>
            <span class="s1">&#39;recovered&#39;</span><span class="p">:</span> <span class="kc">False</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">error_log</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">log_entry</span><span class="p">)</span>

        <span class="c1"># Attempt recovery</span>
        <span class="k">if</span> <span class="n">error_type</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">recovery_actions</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">recovery_actions</span><span class="p">[</span><span class="n">error_type</span><span class="p">](</span><span class="n">error</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
                <span class="n">log_entry</span><span class="p">[</span><span class="s1">&#39;recovered&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;handled&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;recovered&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;handled&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;recovered&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;critical&#39;</span><span class="p">:</span> <span class="n">error_type</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">critical_errors</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">should_halt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Check recent error count</span>
        <span class="n">hour_ago</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">timestamp</span><span class="p">()</span> <span class="o">-</span> <span class="mi">3600</span>
        <span class="n">recent_errors</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_log</span>
            <span class="k">if</span> <span class="n">e</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">timestamp</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">hour_ago</span>
        <span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">recent_errors</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_errors_per_hour</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;Too many errors in past hour&#39;</span>

        <span class="c1"># Check for critical errors</span>
        <span class="n">critical</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">recent_errors</span> <span class="k">if</span> <span class="n">e</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">critical_errors</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">e</span><span class="p">[</span><span class="s1">&#39;recovered&#39;</span><span class="p">]]</span>
        <span class="k">if</span> <span class="n">critical</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;Critical error: </span><span class="si">{</span><span class="n">critical</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;type&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span>

        <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">get_error_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">by_type</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_log</span><span class="p">:</span>
            <span class="n">by_type</span><span class="p">[</span><span class="n">e</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">by_type</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">by_type</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>Section 4: Performance Tracking</h1></div>
<div class="code-cell" id="cell-11-6" data-source="aW1wb3J0IG51bXB5IGFzIG5wCmltcG9ydCBwYW5kYXMgYXMgcGQKCmNsYXNzIFBlcmZvcm1hbmNlVHJhY2tlcjoKICAgICIiIlRyYWNrIHRyYWRpbmcgcGVyZm9ybWFuY2Ugb3ZlciB0aW1lLiIiIgogICAgCiAgICBkZWYgX19pbml0X18oc2VsZiwgaW5pdGlhbF9jYXBpdGFsKToKICAgICAgICBzZWxmLmluaXRpYWxfY2FwaXRhbCA9IGluaXRpYWxfY2FwaXRhbAogICAgICAgIHNlbGYuZGFpbHlfcmV0dXJucyA9IFtdCiAgICAgICAgc2VsZi5lcXVpdHlfY3VydmUgPSBbaW5pdGlhbF9jYXBpdGFsXQogICAgICAgIHNlbGYudHJhZGVzID0gW10KICAgIAogICAgZGVmIHJlY29yZF9kYXkoc2VsZiwgZW5kaW5nX2VxdWl0eSwgdHJhZGVzX3RvZGF5KToKICAgICAgICAiIiJSZWNvcmQgZW5kIG9mIGRheSBzdGF0cy4iIiIKICAgICAgICBkYWlseV9yZXR1cm4gPSAoZW5kaW5nX2VxdWl0eSAtIHNlbGYuZXF1aXR5X2N1cnZlWy0xXSkgLyBzZWxmLmVxdWl0eV9jdXJ2ZVstMV0KICAgICAgICBzZWxmLmRhaWx5X3JldHVybnMuYXBwZW5kKGRhaWx5X3JldHVybikKICAgICAgICBzZWxmLmVxdWl0eV9jdXJ2ZS5hcHBlbmQoZW5kaW5nX2VxdWl0eSkKICAgIAogICAgZGVmIHJlY29yZF90cmFkZShzZWxmLCB0cmFkZV9pbmZvKToKICAgICAgICAiIiJSZWNvcmQgaW5kaXZpZHVhbCB0cmFkZS4iIiIKICAgICAgICBzZWxmLnRyYWRlcy5hcHBlbmQoewogICAgICAgICAgICAqKnRyYWRlX2luZm8sCiAgICAgICAgICAgICd0aW1lc3RhbXAnOiBkYXRldGltZS5ub3coKQogICAgICAgIH0pCiAgICAKICAgIGRlZiBjYWxjdWxhdGVfbWV0cmljcyhzZWxmKToKICAgICAgICAiIiJDYWxjdWxhdGUgcGVyZm9ybWFuY2UgbWV0cmljcy4iIiIKICAgICAgICBpZiBub3Qgc2VsZi5kYWlseV9yZXR1cm5zOgogICAgICAgICAgICByZXR1cm4geydlcnJvcic6ICdObyBkYXRhJ30KICAgICAgICAKICAgICAgICByZXR1cm5zID0gbnAuYXJyYXkoc2VsZi5kYWlseV9yZXR1cm5zKQogICAgICAgIAogICAgICAgICMgVG90YWwgcmV0dXJuCiAgICAgICAgdG90YWxfcmV0dXJuID0gKHNlbGYuZXF1aXR5X2N1cnZlWy0xXSAtIHNlbGYuaW5pdGlhbF9jYXBpdGFsKSAvIHNlbGYuaW5pdGlhbF9jYXBpdGFsCiAgICAgICAgCiAgICAgICAgIyBTaGFycGUgcmF0aW8gKGFubnVhbGl6ZWQpCiAgICAgICAgc2hhcnBlID0gbnAubWVhbihyZXR1cm5zKSAvIG5wLnN0ZChyZXR1cm5zKSAqIG5wLnNxcnQoMzY1KSBpZiBucC5zdGQocmV0dXJucykgPiAwIGVsc2UgMAogICAgICAgIAogICAgICAgICMgTWF4IGRyYXdkb3duCiAgICAgICAgZXF1aXR5ID0gbnAuYXJyYXkoc2VsZi5lcXVpdHlfY3VydmUpCiAgICAgICAgcGVhayA9IG5wLm1heGltdW0uYWNjdW11bGF0ZShlcXVpdHkpCiAgICAgICAgZHJhd2Rvd24gPSAoZXF1aXR5IC0gcGVhaykgLyBwZWFrCiAgICAgICAgbWF4X2RkID0gbnAubWluKGRyYXdkb3duKQogICAgICAgIAogICAgICAgICMgV2luIHJhdGUKICAgICAgICB3aW5uaW5nX3RyYWRlcyA9IFt0IGZvciB0IGluIHNlbGYudHJhZGVzIGlmIHQuZ2V0KCdwbmwnLCAwKSA+IDBdCiAgICAgICAgdG90YWxfdHJhZGVzID0gbGVuKFt0IGZvciB0IGluIHNlbGYudHJhZGVzIGlmICdwbmwnIGluIHRdKQogICAgICAgIHdpbl9yYXRlID0gbGVuKHdpbm5pbmdfdHJhZGVzKSAvIHRvdGFsX3RyYWRlcyBpZiB0b3RhbF90cmFkZXMgPiAwIGVsc2UgMAogICAgICAgIAogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICd0b3RhbF9yZXR1cm4nOiB0b3RhbF9yZXR1cm4gKiAxMDAsCiAgICAgICAgICAgICdzaGFycGVfcmF0aW8nOiBzaGFycGUsCiAgICAgICAgICAgICdtYXhfZHJhd2Rvd24nOiBtYXhfZGQgKiAxMDAsCiAgICAgICAgICAgICd3aW5fcmF0ZSc6IHdpbl9yYXRlICogMTAwLAogICAgICAgICAgICAndG90YWxfdHJhZGVzJzogbGVuKHNlbGYudHJhZGVzKSwKICAgICAgICAgICAgJ3RyYWRpbmdfZGF5cyc6IGxlbihzZWxmLmRhaWx5X3JldHVybnMpCiAgICAgICAgfQogICAgCiAgICBkZWYgZ2VuZXJhdGVfcmVwb3J0KHNlbGYpOgogICAgICAgICIiIkdlbmVyYXRlIHBlcmZvcm1hbmNlIHJlcG9ydC4iIiIKICAgICAgICBtZXRyaWNzID0gc2VsZi5jYWxjdWxhdGVfbWV0cmljcygpCiAgICAgICAgCiAgICAgICAgcHJpbnQoJz0nICogNjApCiAgICAgICAgcHJpbnQoJyAgICAgICAgIFBFUkZPUk1BTkNFIFJFUE9SVCcpCiAgICAgICAgcHJpbnQoJz0nICogNjApCiAgICAgICAgcHJpbnQoZiJJbml0aWFsIENhcGl0YWw6ICR7c2VsZi5pbml0aWFsX2NhcGl0YWw6LC4yZn0iKQogICAgICAgIHByaW50KGYiQ3VycmVudCBFcXVpdHk6ICAke3NlbGYuZXF1aXR5X2N1cnZlWy0xXTosLjJmfSIpCiAgICAgICAgcHJpbnQoJy0nICogNjApCiAgICAgICAgcHJpbnQoZiJUb3RhbCBSZXR1cm46ICAgIHttZXRyaWNzLmdldCgndG90YWxfcmV0dXJuJywgMCk6LjJmfSUiKQogICAgICAgIHByaW50KGYiU2hhcnBlIFJhdGlvOiAgICB7bWV0cmljcy5nZXQoJ3NoYXJwZV9yYXRpbycsIDApOi4yZn0iKQogICAgICAgIHByaW50KGYiTWF4IERyYXdkb3duOiAgICB7bWV0cmljcy5nZXQoJ21heF9kcmF3ZG93bicsIDApOi4yZn0lIikKICAgICAgICBwcmludChmIldpbiBSYXRlOiAgICAgICAge21ldHJpY3MuZ2V0KCd3aW5fcmF0ZScsIDApOi4xZn0lIikKICAgICAgICBwcmludChmIlRvdGFsIFRyYWRlczogICAge21ldHJpY3MuZ2V0KCd0b3RhbF90cmFkZXMnLCAwKX0iKQogICAgICAgIHByaW50KCc9JyAqIDYwKQ=="><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-11-6')" type="button">Run</button></div><pre><code><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="k">class</span> <span class="nc">PerformanceTracker</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Track trading performance over time.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">initial_capital</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initial_capital</span> <span class="o">=</span> <span class="n">initial_capital</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">daily_returns</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">equity_curve</span> <span class="o">=</span> <span class="p">[</span><span class="n">initial_capital</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trades</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">def</span> <span class="nf">record_day</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ending_equity</span><span class="p">,</span> <span class="n">trades_today</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Record end of day stats.&quot;&quot;&quot;</span>
        <span class="n">daily_return</span> <span class="o">=</span> <span class="p">(</span><span class="n">ending_equity</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">equity_curve</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">equity_curve</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">daily_returns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">daily_return</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">equity_curve</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ending_equity</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">record_trade</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trade_info</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Record individual trade.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trades</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="o">**</span><span class="n">trade_info</span><span class="p">,</span>
            <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="p">})</span>
    
    <span class="k">def</span> <span class="nf">calculate_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculate performance metrics.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">daily_returns</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;No data&#39;</span><span class="p">}</span>
        
        <span class="n">returns</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">daily_returns</span><span class="p">)</span>
        
        <span class="c1"># Total return</span>
        <span class="n">total_return</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">equity_curve</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_capital</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_capital</span>
        
        <span class="c1"># Sharpe ratio (annualized)</span>
        <span class="n">sharpe</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">returns</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">returns</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">365</span><span class="p">)</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">returns</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
        
        <span class="c1"># Max drawdown</span>
        <span class="n">equity</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">equity_curve</span><span class="p">)</span>
        <span class="n">peak</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="o">.</span><span class="n">accumulate</span><span class="p">(</span><span class="n">equity</span><span class="p">)</span>
        <span class="n">drawdown</span> <span class="o">=</span> <span class="p">(</span><span class="n">equity</span> <span class="o">-</span> <span class="n">peak</span><span class="p">)</span> <span class="o">/</span> <span class="n">peak</span>
        <span class="n">max_dd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">drawdown</span><span class="p">)</span>
        
        <span class="c1"># Win rate</span>
        <span class="n">winning_trades</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trades</span> <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pnl&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">total_trades</span> <span class="o">=</span> <span class="nb">len</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trades</span> <span class="k">if</span> <span class="s1">&#39;pnl&#39;</span> <span class="ow">in</span> <span class="n">t</span><span class="p">])</span>
        <span class="n">win_rate</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">winning_trades</span><span class="p">)</span> <span class="o">/</span> <span class="n">total_trades</span> <span class="k">if</span> <span class="n">total_trades</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;total_return&#39;</span><span class="p">:</span> <span class="n">total_return</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
            <span class="s1">&#39;sharpe_ratio&#39;</span><span class="p">:</span> <span class="n">sharpe</span><span class="p">,</span>
            <span class="s1">&#39;max_drawdown&#39;</span><span class="p">:</span> <span class="n">max_dd</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
            <span class="s1">&#39;win_rate&#39;</span><span class="p">:</span> <span class="n">win_rate</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
            <span class="s1">&#39;total_trades&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trades</span><span class="p">),</span>
            <span class="s1">&#39;trading_days&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">daily_returns</span><span class="p">)</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">generate_report</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generate performance report.&quot;&quot;&quot;</span>
        <span class="n">metrics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_metrics</span><span class="p">()</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=&#39;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;         PERFORMANCE REPORT&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=&#39;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Initial Capital: $</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">initial_capital</span><span class="si">:</span><span class="s2">,.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Current Equity:  $</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">equity_curve</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">,.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-&#39;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total Return:    </span><span class="si">{</span><span class="n">metrics</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;total_return&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sharpe Ratio:    </span><span class="si">{</span><span class="n">metrics</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sharpe_ratio&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Max Drawdown:    </span><span class="si">{</span><span class="n">metrics</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;max_drawdown&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Win Rate:        </span><span class="si">{</span><span class="n">metrics</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;win_rate&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total Trades:    </span><span class="si">{</span><span class="n">metrics</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;total_trades&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=&#39;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
</code></pre><div class="code-output" id="output-cell-11-6"></div></div>
<div class="md-cell"><h3>âœï¸ Exercise 11.4: Performance Tracker</h3>
<p>Build an advanced performance tracking system.</p></div>
<div class="code-cell" id="cell-11-7" data-source="IyBFeGVyY2lzZSAxMS40CmNsYXNzIEFkdmFuY2VkUGVyZm9ybWFuY2VUcmFja2VyOgogICAgZGVmIF9faW5pdF9fKHNlbGYsIGluaXRpYWxfY2FwaXRhbCwgYmVuY2htYXJrPSdCVEMnKToKICAgICAgICBzZWxmLmluaXRpYWxfY2FwaXRhbCA9IGluaXRpYWxfY2FwaXRhbAogICAgICAgIHNlbGYuYmVuY2htYXJrID0gYmVuY2htYXJrCiAgICAgICAgc2VsZi5kYXRhID0gW10KICAgIAogICAgZGVmIHJlY29yZF9zbmFwc2hvdChzZWxmLCBlcXVpdHksIGJlbmNobWFya19wcmljZSk6CiAgICAgICAgIyBUT0RPOiBSZWNvcmQgcG9ydGZvbGlvIGFuZCBiZW5jaG1hcmsgdmFsdWVzCiAgICAgICAgcGFzcwogICAgCiAgICBkZWYgY2FsY3VsYXRlX2FscGhhX2JldGEoc2VsZik6CiAgICAgICAgIyBUT0RPOiBDYWxjdWxhdGUgYWxwaGEgYW5kIGJldGEgdnMgYmVuY2htYXJrCiAgICAgICAgcGFzcwogICAgCiAgICBkZWYgZ2V0X3Jpc2tfbWV0cmljcyhzZWxmKToKICAgICAgICAjIFRPRE86IFZhUiwgU29ydGlubywgZXRjLgogICAgICAgIHBhc3M="><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-11-7')" type="button">Run</button></div><pre><code><span class="c1"># Exercise 11.4</span>
<span class="k">class</span> <span class="nc">AdvancedPerformanceTracker</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">initial_capital</span><span class="p">,</span> <span class="n">benchmark</span><span class="o">=</span><span class="s1">&#39;BTC&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initial_capital</span> <span class="o">=</span> <span class="n">initial_capital</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">benchmark</span> <span class="o">=</span> <span class="n">benchmark</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">def</span> <span class="nf">record_snapshot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">equity</span><span class="p">,</span> <span class="n">benchmark_price</span><span class="p">):</span>
        <span class="c1"># TODO: Record portfolio and benchmark values</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">calculate_alpha_beta</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># TODO: Calculate alpha and beta vs benchmark</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">get_risk_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># TODO: VaR, Sortino, etc.</span>
        <span class="k">pass</span>
</code></pre><div class="code-output" id="output-cell-11-7"></div></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">AdvancedPerformanceTracker</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">initial_capital</span><span class="p">,</span> <span class="n">benchmark</span><span class="o">=</span><span class="s1">&#39;BTC&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initial_capital</span> <span class="o">=</span> <span class="n">initial_capital</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">benchmark</span> <span class="o">=</span> <span class="n">benchmark</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initial_benchmark</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">record_snapshot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">equity</span><span class="p">,</span> <span class="n">benchmark_price</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_benchmark</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">initial_benchmark</span> <span class="o">=</span> <span class="n">benchmark_price</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
            <span class="s1">&#39;equity&#39;</span><span class="p">:</span> <span class="n">equity</span><span class="p">,</span>
            <span class="s1">&#39;benchmark_price&#39;</span><span class="p">:</span> <span class="n">benchmark_price</span>
        <span class="p">})</span>

    <span class="k">def</span> <span class="nf">calculate_alpha_beta</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Insufficient data&#39;</span><span class="p">}</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;portfolio_return&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;equity&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;benchmark_return&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;benchmark_price&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Insufficient data&#39;</span><span class="p">}</span>

        <span class="c1"># Calculate beta (covariance / variance)</span>
        <span class="n">cov</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;portfolio_return&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;benchmark_return&#39;</span><span class="p">])</span>
        <span class="n">var</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;benchmark_return&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">var</span><span class="p">()</span>
        <span class="n">beta</span> <span class="o">=</span> <span class="n">cov</span> <span class="o">/</span> <span class="n">var</span> <span class="k">if</span> <span class="n">var</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>

        <span class="c1"># Calculate alpha</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;portfolio_return&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">-</span> <span class="n">beta</span> <span class="o">*</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;benchmark_return&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">alpha_annualized</span> <span class="o">=</span> <span class="n">alpha</span> <span class="o">*</span> <span class="mi">365</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;alpha&#39;</span><span class="p">:</span> <span class="n">alpha_annualized</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
            <span class="s1">&#39;beta&#39;</span><span class="p">:</span> <span class="n">beta</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">get_risk_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Insufficient data&#39;</span><span class="p">}</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="n">returns</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;equity&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

        <span class="c1"># VaR (95%)</span>
        <span class="n">var_95</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">returns</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>

        <span class="c1"># Sortino ratio</span>
        <span class="n">downside</span> <span class="o">=</span> <span class="n">returns</span><span class="p">[</span><span class="n">returns</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">sortino</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">/</span> <span class="n">downside</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">365</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">downside</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>

        <span class="c1"># Calmar ratio</span>
        <span class="n">equity</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;equity&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">peak</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="o">.</span><span class="n">accumulate</span><span class="p">(</span><span class="n">equity</span><span class="p">)</span>
        <span class="n">max_dd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">((</span><span class="n">equity</span> <span class="o">-</span> <span class="n">peak</span><span class="p">)</span> <span class="o">/</span> <span class="n">peak</span><span class="p">)</span>
        <span class="n">total_return</span> <span class="o">=</span> <span class="p">(</span><span class="n">equity</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">equity</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="n">equity</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">calmar</span> <span class="o">=</span> <span class="n">total_return</span> <span class="o">/</span> <span class="nb">abs</span><span class="p">(</span><span class="n">max_dd</span><span class="p">)</span> <span class="k">if</span> <span class="n">max_dd</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;var_95&#39;</span><span class="p">:</span> <span class="n">var_95</span><span class="p">,</span>
            <span class="s1">&#39;sortino_ratio&#39;</span><span class="p">:</span> <span class="n">sortino</span><span class="p">,</span>
            <span class="s1">&#39;calmar_ratio&#39;</span><span class="p">:</span> <span class="n">calmar</span>
        <span class="p">}</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>ğŸ—ï¸ Module Project: Production Trading Bot</h1>
<p>Build a complete production-ready trading bot.</p></div>
<div class="code-cell" id="cell-11-8" data-source="IyBNb2R1bGUgUHJvamVjdApjbGFzcyBQcm9kdWN0aW9uVHJhZGluZ0JvdDoKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBjb25maWcpOgogICAgICAgIHNlbGYuY29uZmlnID0gY29uZmlnCiAgICAgICAgc2VsZi5leGNoYW5nZSA9IE5vbmUKICAgICAgICBzZWxmLnZhbGlkYXRvciA9IE5vbmUKICAgICAgICBzZWxmLm1vbml0b3IgPSBOb25lCiAgICAgICAgc2VsZi5lcnJvcl9oYW5kbGVyID0gTm9uZQogICAgICAgIHNlbGYucGVyZm9ybWFuY2UgPSBOb25lCiAgICAgICAgc2VsZi5ydW5uaW5nID0gRmFsc2UKICAgIAogICAgZGVmIGluaXRpYWxpemUoc2VsZik6CiAgICAgICAgIyBUT0RPOiBTZXQgdXAgYWxsIGNvbXBvbmVudHMKICAgICAgICBwYXNzCiAgICAKICAgIGRlZiB2YWxpZGF0ZV9hbmRfbGF1bmNoKHNlbGYpOgogICAgICAgICMgVE9ETzogUnVuIHByZS1sYXVuY2ggY2hlY2tzIGFuZCBzdGFydAogICAgICAgIHBhc3MKICAgIAogICAgZGVmIHJ1bl9jeWNsZShzZWxmKToKICAgICAgICAjIFRPRE86IE9uZSB0cmFkaW5nIGN5Y2xlCiAgICAgICAgcGFzcwogICAgCiAgICBkZWYgZW1lcmdlbmN5X3NodXRkb3duKHNlbGYpOgogICAgICAgICMgVE9ETzogRW1lcmdlbmN5IHN0b3AKICAgICAgICBwYXNzCiAgICAKICAgIGRlZiBnZXRfc3RhdHVzKHNlbGYpOgogICAgICAgICMgVE9ETzogUmV0dXJuIGN1cnJlbnQgc3RhdHVzCiAgICAgICAgcGFzcw=="><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-11-8')" type="button">Run</button></div><pre><code><span class="c1"># Module Project</span>
<span class="k">class</span> <span class="nc">ProductionTradingBot</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validator</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">monitor</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">error_handler</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">performance</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="kc">False</span>
    
    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># TODO: Set up all components</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">validate_and_launch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># TODO: Run pre-launch checks and start</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">run_cycle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># TODO: One trading cycle</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">emergency_shutdown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># TODO: Emergency stop</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">get_status</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># TODO: Return current status</span>
        <span class="k">pass</span>
</code></pre><div class="code-output" id="output-cell-11-8"></div></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">ProductionTradingBot</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">monitor</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">error_handler</span> <span class="o">=</span> <span class="n">TradingErrorHandler</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">performance</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_cycle</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Set up exchange connection</span>
        <span class="kn">import</span> <span class="nn">ccxt</span>
        <span class="n">exchange_class</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">ccxt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;exchange&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span> <span class="o">=</span> <span class="n">exchange_class</span><span class="p">({</span>
            <span class="s1">&#39;apiKey&#39;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;exchange&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2">_API_KEY&quot;</span><span class="p">),</span>
            <span class="s1">&#39;secret&#39;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;exchange&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2">_API_SECRET&quot;</span><span class="p">),</span>
            <span class="s1">&#39;sandbox&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sandbox&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
            <span class="s1">&#39;enableRateLimit&#39;</span><span class="p">:</span> <span class="kc">True</span>
        <span class="p">})</span>

        <span class="c1"># Initialize components</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">monitor</span> <span class="o">=</span> <span class="n">LiveTradeMonitor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">performance</span> <span class="o">=</span> <span class="n">PerformanceTracker</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;capital&#39;</span><span class="p">,</span> <span class="mi">10000</span><span class="p">))</span>

        <span class="c1"># Set up error recovery</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">error_handler</span><span class="o">.</span><span class="n">register_recovery</span><span class="p">(</span>
            <span class="s1">&#39;NetworkError&#39;</span><span class="p">,</span>
            <span class="k">lambda</span> <span class="n">e</span><span class="p">,</span> <span class="n">ctx</span><span class="p">:</span> <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">validate_and_launch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">checklist</span> <span class="o">=</span> <span class="n">LaunchChecklist</span><span class="p">()</span>

        <span class="n">checklist</span><span class="o">.</span><span class="n">add_check</span><span class="p">(</span><span class="s1">&#39;exchange&#39;</span><span class="p">,</span> <span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">checklist</span><span class="o">.</span><span class="n">add_check</span><span class="p">(</span><span class="s1">&#39;balance&#39;</span><span class="p">,</span> <span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">monitor</span><span class="o">.</span><span class="n">initialize</span><span class="p">()</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;min_balance&#39;</span><span class="p">,</span> <span class="mi">100</span><span class="p">))</span>

        <span class="n">checklist</span><span class="o">.</span><span class="n">run_all</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">checklist</span><span class="o">.</span><span class="n">can_launch</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;Bot launched&#39;</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;failures&#39;</span><span class="p">:</span> <span class="n">checklist</span><span class="o">.</span><span class="n">get_failures</span><span class="p">()}</span>

    <span class="k">def</span> <span class="nf">run_cycle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">running</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Bot not running&#39;</span><span class="p">}</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Get current prices</span>
            <span class="n">ticker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="o">.</span><span class="n">fetch_ticker</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;symbol&#39;</span><span class="p">,</span> <span class="s1">&#39;BTC/USDT&#39;</span><span class="p">))</span>

            <span class="c1"># Get status</span>
            <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">monitor</span><span class="o">.</span><span class="n">get_status</span><span class="p">({</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;symbol&#39;</span><span class="p">):</span> <span class="n">ticker</span><span class="p">[</span><span class="s1">&#39;last&#39;</span><span class="p">]})</span>

            <span class="c1"># Check for halt conditions</span>
            <span class="n">should_halt</span><span class="p">,</span> <span class="n">reason</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_handler</span><span class="o">.</span><span class="n">should_halt</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">should_halt</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">emergency_shutdown</span><span class="p">()</span>
                <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;halted&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="n">reason</span><span class="p">}</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">last_cycle</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="n">status</span><span class="p">}</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">error_handler</span><span class="o">.</span><span class="n">handle_error</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;cycle&#39;</span><span class="p">:</span> <span class="s1">&#39;run&#39;</span><span class="p">})</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>

    <span class="k">def</span> <span class="nf">emergency_shutdown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ğŸš¨ EMERGENCY SHUTDOWN&#39;</span><span class="p">)</span>
        <span class="c1"># Cancel all orders, close positions if configured</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="o">.</span><span class="n">cancel_all_orders</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">get_status</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;running&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">running</span><span class="p">,</span>
            <span class="s1">&#39;last_cycle&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_cycle</span><span class="p">,</span>
            <span class="s1">&#39;errors&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_handler</span><span class="o">.</span><span class="n">get_error_summary</span><span class="p">(),</span>
            <span class="s1">&#39;performance&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">performance</span><span class="o">.</span><span class="n">calculate_metrics</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">performance</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="p">}</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>ğŸ“ Key Takeaways</h1>
<ol>
<li><strong>Pre-Launch Validation</strong>: Always validate before going live</li>
<li><strong>Real-Time Monitoring</strong>: Track positions, P&amp;L, and alerts continuously</li>
<li><strong>Error Handling</strong>: Prepare for network issues, exchange downtime, and edge cases</li>
<li><strong>Performance Tracking</strong>: Measure and analyze results continuously</li>
</ol>
<hr />
<p><em>Part 3 Complete! Next: Part 4 - DeFi &amp; Advanced Topics</em></p></div>
        <div class="nav-buttons">
            <button class="nav-btn prev-btn disabled" type="button">
                <span class="nav-btn-label">â† Previous</span>
                <span class="nav-btn-name"></span>
            </button>
            <button class="nav-btn next-btn disabled" type="button">
                <span class="nav-btn-label">Next â†’</span>
                <span class="nav-btn-name"></span>
            </button>
        </div>
        </div>
<div class="module-section" data-idx="12"><div class="md-cell module-header"><h1>Module 12: DeFi Fundamentals</h1>
<h2>Part 4: DeFi &amp; Advanced Topics</h2>
<hr />
<div class="table-wrapper"><table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>â±ï¸ <strong>Duration</strong></td>
<td>~2.5 hours</td>
</tr>
<tr>
<td>ğŸ“‹ <strong>Prerequisites</strong></td>
<td>Part 3 (Modules 9-11)</td>
</tr>
<tr>
<td>ğŸ’ª <strong>Exercises</strong></td>
<td>5 total</td>
</tr>
</tbody>
</table></div></div>
<div class="md-cell"><h2>ğŸ¯ Learning Objectives</h2>
<ul>
<li>Understand DeFi ecosystem and protocols</li>
<li>Connect to Ethereum with Web3.py</li>
<li>Learn AMM and DEX mechanics</li>
<li>Access DeFi data sources</li>
</ul></div>
<div class="md-cell"><hr />
<h1>Section 1: Introduction to DeFi</h1>
<h2>1.1 What is DeFi?</h2>
<p><strong>Decentralized Finance (DeFi)</strong> = Financial services built on blockchain without intermediaries.</p></div>
<div class="code-cell" id="cell-12-0" data-source="IyBLZXkgRGVGaSBjb25jZXB0cwpkZWZpX2Vjb3N5c3RlbSA9IHsKICAgICdERVhzJzogewogICAgICAgICdkZXNjcmlwdGlvbic6ICdEZWNlbnRyYWxpemVkIGV4Y2hhbmdlcyBmb3IgdG9rZW4gc3dhcHMnLAogICAgICAgICdleGFtcGxlcyc6IFsnVW5pc3dhcCcsICdTdXNoaVN3YXAnLCAnQ3VydmUnXSwKICAgICAgICAndHZsX2JpbGxpb25zJzogMTUKICAgIH0sCiAgICAnTGVuZGluZyc6IHsKICAgICAgICAnZGVzY3JpcHRpb24nOiAnQm9ycm93L2xlbmQgY3J5cHRvIHdpdGhvdXQgaW50ZXJtZWRpYXJpZXMnLAogICAgICAgICdleGFtcGxlcyc6IFsnQWF2ZScsICdDb21wb3VuZCcsICdNYWtlckRBTyddLAogICAgICAgICd0dmxfYmlsbGlvbnMnOiAyMAogICAgfSwKICAgICdEZXJpdmF0aXZlcyc6IHsKICAgICAgICAnZGVzY3JpcHRpb24nOiAnT24tY2hhaW4gZnV0dXJlcywgb3B0aW9ucywgcGVycGV0dWFscycsCiAgICAgICAgJ2V4YW1wbGVzJzogWydkWWRYJywgJ0dNWCcsICdTeW50aGV0aXgnXSwKICAgICAgICAndHZsX2JpbGxpb25zJzogNQogICAgfSwKICAgICdZaWVsZCc6IHsKICAgICAgICAnZGVzY3JpcHRpb24nOiAnWWllbGQgb3B0aW1pemF0aW9uIGFuZCBhZ2dyZWdhdGlvbicsCiAgICAgICAgJ2V4YW1wbGVzJzogWydZZWFybicsICdDb252ZXgnLCAnQmVlZnknXSwKICAgICAgICAndHZsX2JpbGxpb25zJzogOAogICAgfQp9Cgpmb3IgY2F0ZWdvcnksIGluZm8gaW4gZGVmaV9lY29zeXN0ZW0uaXRlbXMoKToKICAgIHByaW50KGYiXG57Y2F0ZWdvcnl9OiIpCiAgICBwcmludChmIiAge2luZm9bJ2Rlc2NyaXB0aW9uJ119IikKICAgIHByaW50KGYiICBFeGFtcGxlczogeycsICcuam9pbihpbmZvWydleGFtcGxlcyddKX0iKQogICAgcHJpbnQoZiIgIFRWTDogfiR7aW5mb1sndHZsX2JpbGxpb25zJ119QiIp"><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-12-0')" type="button">Run</button></div><pre><code><span class="c1"># Key DeFi concepts</span>
<span class="n">defi_ecosystem</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;DEXs&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">&#39;Decentralized exchanges for token swaps&#39;</span><span class="p">,</span>
        <span class="s1">&#39;examples&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Uniswap&#39;</span><span class="p">,</span> <span class="s1">&#39;SushiSwap&#39;</span><span class="p">,</span> <span class="s1">&#39;Curve&#39;</span><span class="p">],</span>
        <span class="s1">&#39;tvl_billions&#39;</span><span class="p">:</span> <span class="mi">15</span>
    <span class="p">},</span>
    <span class="s1">&#39;Lending&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">&#39;Borrow/lend crypto without intermediaries&#39;</span><span class="p">,</span>
        <span class="s1">&#39;examples&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Aave&#39;</span><span class="p">,</span> <span class="s1">&#39;Compound&#39;</span><span class="p">,</span> <span class="s1">&#39;MakerDAO&#39;</span><span class="p">],</span>
        <span class="s1">&#39;tvl_billions&#39;</span><span class="p">:</span> <span class="mi">20</span>
    <span class="p">},</span>
    <span class="s1">&#39;Derivatives&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">&#39;On-chain futures, options, perpetuals&#39;</span><span class="p">,</span>
        <span class="s1">&#39;examples&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;dYdX&#39;</span><span class="p">,</span> <span class="s1">&#39;GMX&#39;</span><span class="p">,</span> <span class="s1">&#39;Synthetix&#39;</span><span class="p">],</span>
        <span class="s1">&#39;tvl_billions&#39;</span><span class="p">:</span> <span class="mi">5</span>
    <span class="p">},</span>
    <span class="s1">&#39;Yield&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">&#39;Yield optimization and aggregation&#39;</span><span class="p">,</span>
        <span class="s1">&#39;examples&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Yearn&#39;</span><span class="p">,</span> <span class="s1">&#39;Convex&#39;</span><span class="p">,</span> <span class="s1">&#39;Beefy&#39;</span><span class="p">],</span>
        <span class="s1">&#39;tvl_billions&#39;</span><span class="p">:</span> <span class="mi">8</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">for</span> <span class="n">category</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">defi_ecosystem</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">category</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Examples: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;examples&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  TVL: ~$</span><span class="si">{</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;tvl_billions&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">B&quot;</span><span class="p">)</span>
</code></pre><div class="code-output" id="output-cell-12-0"></div></div>
<div class="md-cell"><h2>1.2 Smart Contracts Basics</h2>
<p>Smart contracts are self-executing code on blockchain.</p></div>
<div class="code-cell" id="cell-12-1" data-source="IyBLZXkgc21hcnQgY29udHJhY3QgY29uY2VwdHMgZm9yIHRyYWRlcnMKc21hcnRfY29udHJhY3RfYmFzaWNzID0gewogICAgJ2FkZHJlc3MnOiAnVW5pcXVlIGlkZW50aWZpZXIgKDB4Li4uKSBmb3IgdGhlIGNvbnRyYWN0JywKICAgICdhYmknOiAnQXBwbGljYXRpb24gQmluYXJ5IEludGVyZmFjZSAtIGRlZmluZXMgaG93IHRvIGludGVyYWN0JywKICAgICdmdW5jdGlvbnMnOiAnTWV0aG9kcyB5b3UgY2FuIGNhbGwgKHN3YXAsIGRlcG9zaXQsIGV0Yy4pJywKICAgICdldmVudHMnOiAnTG9ncyBlbWl0dGVkIGJ5IGNvbnRyYWN0IChUcmFuc2ZlciwgU3dhcCwgZXRjLiknLAogICAgJ2dhcyc6ICdGZWUgcGFpZCBmb3IgY29tcHV0YXRpb24nCn0KCiMgRXhhbXBsZTogVW5pc3dhcCBWMiBSb3V0ZXIgYWRkcmVzcwpVTklTV0FQX1YyX1JPVVRFUiA9ICcweDdhMjUwZDU2MzBCNGNGNTM5NzM5ZEYyQzVkQWNiNGM2NTlGMjQ4OEQnCgpwcmludCgnU21hcnQgQ29udHJhY3QgS2V5IENvbmNlcHRzOicpCmZvciBjb25jZXB0LCBkZXNjIGluIHNtYXJ0X2NvbnRyYWN0X2Jhc2ljcy5pdGVtcygpOgogICAgcHJpbnQoZicgIHtjb25jZXB0fToge2Rlc2N9Jyk="><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-12-1')" type="button">Run</button></div><pre><code><span class="c1"># Key smart contract concepts for traders</span>
<span class="n">smart_contract_basics</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;address&#39;</span><span class="p">:</span> <span class="s1">&#39;Unique identifier (0x...) for the contract&#39;</span><span class="p">,</span>
    <span class="s1">&#39;abi&#39;</span><span class="p">:</span> <span class="s1">&#39;Application Binary Interface - defines how to interact&#39;</span><span class="p">,</span>
    <span class="s1">&#39;functions&#39;</span><span class="p">:</span> <span class="s1">&#39;Methods you can call (swap, deposit, etc.)&#39;</span><span class="p">,</span>
    <span class="s1">&#39;events&#39;</span><span class="p">:</span> <span class="s1">&#39;Logs emitted by contract (Transfer, Swap, etc.)&#39;</span><span class="p">,</span>
    <span class="s1">&#39;gas&#39;</span><span class="p">:</span> <span class="s1">&#39;Fee paid for computation&#39;</span>
<span class="p">}</span>

<span class="c1"># Example: Uniswap V2 Router address</span>
<span class="n">UNISWAP_V2_ROUTER</span> <span class="o">=</span> <span class="s1">&#39;0x7a250d5630B4cF539739dF2C5dAcb4c659F2488D&#39;</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Smart Contract Key Concepts:&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">concept</span><span class="p">,</span> <span class="n">desc</span> <span class="ow">in</span> <span class="n">smart_contract_basics</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;  </span><span class="si">{</span><span class="n">concept</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">desc</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</code></pre><div class="code-output" id="output-cell-12-1"></div></div>
<div class="md-cell"><h3>âœï¸ Exercise 12.1: DeFi Protocol Research</h3>
<p>Create a class to store and compare DeFi protocols.</p></div>
<div class="code-cell" id="cell-12-2" data-source="IyBFeGVyY2lzZSAxMi4xCmNsYXNzIERlRmlQcm90b2NvbDoKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBuYW1lLCBjYXRlZ29yeSwgY2hhaW4sIHR2bD0wKToKICAgICAgICBzZWxmLm5hbWUgPSBuYW1lCiAgICAgICAgc2VsZi5jYXRlZ29yeSA9IGNhdGVnb3J5CiAgICAgICAgc2VsZi5jaGFpbiA9IGNoYWluCiAgICAgICAgc2VsZi50dmwgPSB0dmwKICAgIAogICAgZGVmIHJpc2tfc2NvcmUoc2VsZik6CiAgICAgICAgIyBUT0RPOiBDYWxjdWxhdGUgcmlzayBzY29yZSBiYXNlZCBvbiBUVkwsIGFnZSwgYXVkaXRzCiAgICAgICAgcGFzcwoKY2xhc3MgRGVGaVRyYWNrZXI6CiAgICBkZWYgX19pbml0X18oc2VsZik6CiAgICAgICAgc2VsZi5wcm90b2NvbHMgPSBbXQogICAgCiAgICBkZWYgYWRkX3Byb3RvY29sKHNlbGYsIHByb3RvY29sKToKICAgICAgICAjIFRPRE8KICAgICAgICBwYXNzCiAgICAKICAgIGRlZiBnZXRfYnlfY2F0ZWdvcnkoc2VsZiwgY2F0ZWdvcnkpOgogICAgICAgICMgVE9ETwogICAgICAgIHBhc3MKICAgIAogICAgZGVmIHRvcF9ieV90dmwoc2VsZiwgbj01KToKICAgICAgICAjIFRPRE8KICAgICAgICBwYXNz"><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-12-2')" type="button">Run</button></div><pre><code><span class="c1"># Exercise 12.1</span>
<span class="k">class</span> <span class="nc">DeFiProtocol</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">category</span><span class="p">,</span> <span class="n">chain</span><span class="p">,</span> <span class="n">tvl</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">category</span> <span class="o">=</span> <span class="n">category</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chain</span> <span class="o">=</span> <span class="n">chain</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tvl</span> <span class="o">=</span> <span class="n">tvl</span>
    
    <span class="k">def</span> <span class="nf">risk_score</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># TODO: Calculate risk score based on TVL, age, audits</span>
        <span class="k">pass</span>

<span class="k">class</span> <span class="nc">DeFiTracker</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">protocols</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">def</span> <span class="nf">add_protocol</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">protocol</span><span class="p">):</span>
        <span class="c1"># TODO</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">get_by_category</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">category</span><span class="p">):</span>
        <span class="c1"># TODO</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">top_by_tvl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
        <span class="c1"># TODO</span>
        <span class="k">pass</span>
</code></pre><div class="code-output" id="output-cell-12-2"></div></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">DeFiProtocol</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">category</span><span class="p">,</span> <span class="n">chain</span><span class="p">,</span> <span class="n">tvl</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">audited</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">age_months</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">category</span> <span class="o">=</span> <span class="n">category</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chain</span> <span class="o">=</span> <span class="n">chain</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tvl</span> <span class="o">=</span> <span class="n">tvl</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">audited</span> <span class="o">=</span> <span class="n">audited</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">age_months</span> <span class="o">=</span> <span class="n">age_months</span>

    <span class="k">def</span> <span class="nf">risk_score</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Lower is better. Scale 1-10.&quot;&quot;&quot;</span>
        <span class="n">score</span> <span class="o">=</span> <span class="mi">5</span>  <span class="c1"># Base score</span>

        <span class="c1"># TVL factor (higher TVL = lower risk)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tvl</span> <span class="o">&gt;</span> <span class="mi">1_000_000_000</span><span class="p">:</span>
            <span class="n">score</span> <span class="o">-=</span> <span class="mi">2</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">tvl</span> <span class="o">&gt;</span> <span class="mi">100_000_000</span><span class="p">:</span>
            <span class="n">score</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">tvl</span> <span class="o">&lt;</span> <span class="mi">10_000_000</span><span class="p">:</span>
            <span class="n">score</span> <span class="o">+=</span> <span class="mi">2</span>

        <span class="c1"># Audit factor</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">audited</span><span class="p">:</span>
            <span class="n">score</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">score</span> <span class="o">+=</span> <span class="mi">2</span>

        <span class="c1"># Age factor</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">age_months</span> <span class="o">&gt;</span> <span class="mi">24</span><span class="p">:</span>
            <span class="n">score</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">age_months</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">:</span>
            <span class="n">score</span> <span class="o">+=</span> <span class="mi">2</span>

        <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">score</span><span class="p">))</span>

<span class="k">class</span> <span class="nc">DeFiTracker</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">protocols</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">add_protocol</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">protocol</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">protocols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">protocol</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_by_category</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">category</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">protocols</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">category</span> <span class="o">==</span> <span class="n">category</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">top_by_tvl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">protocols</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">tvl</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)[:</span><span class="n">n</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">get_by_chain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chain</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">protocols</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">chain</span> <span class="o">==</span> <span class="n">chain</span><span class="p">]</span>

<span class="c1"># Usage</span>
<span class="n">tracker</span> <span class="o">=</span> <span class="n">DeFiTracker</span><span class="p">()</span>
<span class="n">tracker</span><span class="o">.</span><span class="n">add_protocol</span><span class="p">(</span><span class="n">DeFiProtocol</span><span class="p">(</span><span class="s1">&#39;Uniswap&#39;</span><span class="p">,</span> <span class="s1">&#39;DEX&#39;</span><span class="p">,</span> <span class="s1">&#39;Ethereum&#39;</span><span class="p">,</span> <span class="mi">5_000_000_000</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="mi">48</span><span class="p">))</span>
<span class="n">tracker</span><span class="o">.</span><span class="n">add_protocol</span><span class="p">(</span><span class="n">DeFiProtocol</span><span class="p">(</span><span class="s1">&#39;Aave&#39;</span><span class="p">,</span> <span class="s1">&#39;Lending&#39;</span><span class="p">,</span> <span class="s1">&#39;Ethereum&#39;</span><span class="p">,</span> <span class="mi">10_000_000_000</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="mi">36</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Top by TVL: </span><span class="si">{</span><span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">tracker</span><span class="o">.</span><span class="n">top_by_tvl</span><span class="p">(</span><span class="mi">2</span><span class="p">)]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>Section 2: Web3.py Basics</h1>
<h2>2.1 Connecting to Ethereum</h2></div>
<div class="code-cell" id="cell-12-3" data-source="IyBwaXAgaW5zdGFsbCB3ZWIzCmZyb20gd2ViMyBpbXBvcnQgV2ViMwppbXBvcnQgb3MKCmNsYXNzIEV0aGVyZXVtQ29ubmVjdGlvbjoKICAgICIiIkNvbm5lY3QgdG8gRXRoZXJldW0gbmV0d29yay4iIiIKICAgIAogICAgZGVmIF9faW5pdF9fKHNlbGYsIHJwY191cmw9Tm9uZSk6CiAgICAgICAgIyBVc2UgcHJvdmlkZWQgVVJMIG9yIGVudmlyb25tZW50IHZhcmlhYmxlCiAgICAgICAgc2VsZi5ycGNfdXJsID0gcnBjX3VybCBvciBvcy5nZXRlbnYoJ0VUSF9SUENfVVJMJywgJ2h0dHBzOi8vZXRoLmxsYW1hcnBjLmNvbScpCiAgICAgICAgc2VsZi53MyA9IE5vbmUKICAgIAogICAgZGVmIGNvbm5lY3Qoc2VsZik6CiAgICAgICAgIiIiRXN0YWJsaXNoIGNvbm5lY3Rpb24uIiIiCiAgICAgICAgc2VsZi53MyA9IFdlYjMoV2ViMy5IVFRQUHJvdmlkZXIoc2VsZi5ycGNfdXJsKSkKICAgICAgICByZXR1cm4gc2VsZi53My5pc19jb25uZWN0ZWQoKQogICAgCiAgICBkZWYgZ2V0X2Jsb2NrX251bWJlcihzZWxmKToKICAgICAgICAiIiJHZXQgbGF0ZXN0IGJsb2NrIG51bWJlci4iIiIKICAgICAgICByZXR1cm4gc2VsZi53My5ldGguYmxvY2tfbnVtYmVyCiAgICAKICAgIGRlZiBnZXRfZ2FzX3ByaWNlKHNlbGYpOgogICAgICAgICIiIkdldCBjdXJyZW50IGdhcyBwcmljZSBpbiBHd2VpLiIiIgogICAgICAgIGdhc193ZWkgPSBzZWxmLnczLmV0aC5nYXNfcHJpY2UKICAgICAgICByZXR1cm4gc2VsZi53My5mcm9tX3dlaShnYXNfd2VpLCAnZ3dlaScpCiAgICAKICAgIGRlZiBnZXRfZXRoX2JhbGFuY2Uoc2VsZiwgYWRkcmVzcyk6CiAgICAgICAgIiIiR2V0IEVUSCBiYWxhbmNlIGZvciBhZGRyZXNzLiIiIgogICAgICAgIGJhbGFuY2Vfd2VpID0gc2VsZi53My5ldGguZ2V0X2JhbGFuY2UoYWRkcmVzcykKICAgICAgICByZXR1cm4gc2VsZi53My5mcm9tX3dlaShiYWxhbmNlX3dlaSwgJ2V0aGVyJykKCiMgRXhhbXBsZSAod2lsbCB3b3JrIHdpdGggcHVibGljIFJQQykKZXRoID0gRXRoZXJldW1Db25uZWN0aW9uKCkKaWYgZXRoLmNvbm5lY3QoKToKICAgIHByaW50KGYnQ29ubmVjdGVkISBCbG9jazoge2V0aC5nZXRfYmxvY2tfbnVtYmVyKCl9JykKICAgIHByaW50KGYnR2FzIFByaWNlOiB7ZXRoLmdldF9nYXNfcHJpY2UoKTouMmZ9IEd3ZWknKQplbHNlOgogICAgcHJpbnQoJ0Nvbm5lY3Rpb24gZmFpbGVkJyk="><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-12-3')" type="button">Run</button></div><pre><code><span class="c1"># pip install web3</span>
<span class="kn">from</span> <span class="nn">web3</span> <span class="kn">import</span> <span class="n">Web3</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="k">class</span> <span class="nc">EthereumConnection</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Connect to Ethereum network.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rpc_url</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># Use provided URL or environment variable</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rpc_url</span> <span class="o">=</span> <span class="n">rpc_url</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;ETH_RPC_URL&#39;</span><span class="p">,</span> <span class="s1">&#39;https://eth.llamarpc.com&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w3</span> <span class="o">=</span> <span class="kc">None</span>
    
    <span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Establish connection.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w3</span> <span class="o">=</span> <span class="n">Web3</span><span class="p">(</span><span class="n">Web3</span><span class="o">.</span><span class="n">HTTPProvider</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rpc_url</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">w3</span><span class="o">.</span><span class="n">is_connected</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">get_block_number</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get latest block number.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">block_number</span>
    
    <span class="k">def</span> <span class="nf">get_gas_price</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get current gas price in Gwei.&quot;&quot;&quot;</span>
        <span class="n">gas_wei</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">gas_price</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">w3</span><span class="o">.</span><span class="n">from_wei</span><span class="p">(</span><span class="n">gas_wei</span><span class="p">,</span> <span class="s1">&#39;gwei&#39;</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">get_eth_balance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">address</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get ETH balance for address.&quot;&quot;&quot;</span>
        <span class="n">balance_wei</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">get_balance</span><span class="p">(</span><span class="n">address</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">w3</span><span class="o">.</span><span class="n">from_wei</span><span class="p">(</span><span class="n">balance_wei</span><span class="p">,</span> <span class="s1">&#39;ether&#39;</span><span class="p">)</span>

<span class="c1"># Example (will work with public RPC)</span>
<span class="n">eth</span> <span class="o">=</span> <span class="n">EthereumConnection</span><span class="p">()</span>
<span class="k">if</span> <span class="n">eth</span><span class="o">.</span><span class="n">connect</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Connected! Block: </span><span class="si">{</span><span class="n">eth</span><span class="o">.</span><span class="n">get_block_number</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Gas Price: </span><span class="si">{</span><span class="n">eth</span><span class="o">.</span><span class="n">get_gas_price</span><span class="p">()</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1"> Gwei&#39;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Connection failed&#39;</span><span class="p">)</span>
</code></pre><div class="code-output" id="output-cell-12-3"></div></div>
<div class="md-cell"><h2>2.2 Reading Contract Data</h2></div>
<div class="code-cell" id="cell-12-4" data-source="IyBFUkMyMCBBQkkgKG1pbmltYWwgZm9yIHJlYWRpbmcpCkVSQzIwX0FCSSA9IFsKICAgIHsKICAgICAgICAiY29uc3RhbnQiOiBUcnVlLAogICAgICAgICJpbnB1dHMiOiBbXSwKICAgICAgICAibmFtZSI6ICJuYW1lIiwKICAgICAgICAib3V0cHV0cyI6IFt7Im5hbWUiOiAiIiwgInR5cGUiOiAic3RyaW5nIn1dLAogICAgICAgICJ0eXBlIjogImZ1bmN0aW9uIgogICAgfSwKICAgIHsKICAgICAgICAiY29uc3RhbnQiOiBUcnVlLAogICAgICAgICJpbnB1dHMiOiBbXSwKICAgICAgICAibmFtZSI6ICJzeW1ib2wiLAogICAgICAgICJvdXRwdXRzIjogW3sibmFtZSI6ICIiLCAidHlwZSI6ICJzdHJpbmcifV0sCiAgICAgICAgInR5cGUiOiAiZnVuY3Rpb24iCiAgICB9LAogICAgewogICAgICAgICJjb25zdGFudCI6IFRydWUsCiAgICAgICAgImlucHV0cyI6IFtdLAogICAgICAgICJuYW1lIjogImRlY2ltYWxzIiwKICAgICAgICAib3V0cHV0cyI6IFt7Im5hbWUiOiAiIiwgInR5cGUiOiAidWludDgifV0sCiAgICAgICAgInR5cGUiOiAiZnVuY3Rpb24iCiAgICB9LAogICAgewogICAgICAgICJjb25zdGFudCI6IFRydWUsCiAgICAgICAgImlucHV0cyI6IFtdLAogICAgICAgICJuYW1lIjogInRvdGFsU3VwcGx5IiwKICAgICAgICAib3V0cHV0cyI6IFt7Im5hbWUiOiAiIiwgInR5cGUiOiAidWludDI1NiJ9XSwKICAgICAgICAidHlwZSI6ICJmdW5jdGlvbiIKICAgIH0sCiAgICB7CiAgICAgICAgImNvbnN0YW50IjogVHJ1ZSwKICAgICAgICAiaW5wdXRzIjogW3sibmFtZSI6ICJfb3duZXIiLCAidHlwZSI6ICJhZGRyZXNzIn1dLAogICAgICAgICJuYW1lIjogImJhbGFuY2VPZiIsCiAgICAgICAgIm91dHB1dHMiOiBbeyJuYW1lIjogImJhbGFuY2UiLCAidHlwZSI6ICJ1aW50MjU2In1dLAogICAgICAgICJ0eXBlIjogImZ1bmN0aW9uIgogICAgfQpdCgpjbGFzcyBUb2tlblJlYWRlcjoKICAgICIiIlJlYWQgRVJDMjAgdG9rZW4gZGF0YS4iIiIKICAgIAogICAgZGVmIF9faW5pdF9fKHNlbGYsIHczKToKICAgICAgICBzZWxmLnczID0gdzMKICAgIAogICAgZGVmIGdldF90b2tlbl9pbmZvKHNlbGYsIHRva2VuX2FkZHJlc3MpOgogICAgICAgICIiIkdldCBiYXNpYyB0b2tlbiBpbmZvcm1hdGlvbi4iIiIKICAgICAgICBjb250cmFjdCA9IHNlbGYudzMuZXRoLmNvbnRyYWN0KAogICAgICAgICAgICBhZGRyZXNzPVdlYjMudG9fY2hlY2tzdW1fYWRkcmVzcyh0b2tlbl9hZGRyZXNzKSwKICAgICAgICAgICAgYWJpPUVSQzIwX0FCSQogICAgICAgICkKICAgICAgICAKICAgICAgICB0cnk6CiAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICAnYWRkcmVzcyc6IHRva2VuX2FkZHJlc3MsCiAgICAgICAgICAgICAgICAnbmFtZSc6IGNvbnRyYWN0LmZ1bmN0aW9ucy5uYW1lKCkuY2FsbCgpLAogICAgICAgICAgICAgICAgJ3N5bWJvbCc6IGNvbnRyYWN0LmZ1bmN0aW9ucy5zeW1ib2woKS5jYWxsKCksCiAgICAgICAgICAgICAgICAnZGVjaW1hbHMnOiBjb250cmFjdC5mdW5jdGlvbnMuZGVjaW1hbHMoKS5jYWxsKCksCiAgICAgICAgICAgICAgICAndG90YWxfc3VwcGx5JzogY29udHJhY3QuZnVuY3Rpb25zLnRvdGFsU3VwcGx5KCkuY2FsbCgpCiAgICAgICAgICAgIH0KICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHJldHVybiB7J2Vycm9yJzogc3RyKGUpfQogICAgCiAgICBkZWYgZ2V0X2JhbGFuY2Uoc2VsZiwgdG9rZW5fYWRkcmVzcywgd2FsbGV0X2FkZHJlc3MpOgogICAgICAgICIiIkdldCB0b2tlbiBiYWxhbmNlIGZvciB3YWxsZXQuIiIiCiAgICAgICAgY29udHJhY3QgPSBzZWxmLnczLmV0aC5jb250cmFjdCgKICAgICAgICAgICAgYWRkcmVzcz1XZWIzLnRvX2NoZWNrc3VtX2FkZHJlc3ModG9rZW5fYWRkcmVzcyksCiAgICAgICAgICAgIGFiaT1FUkMyMF9BQkkKICAgICAgICApCiAgICAgICAgCiAgICAgICAgYmFsYW5jZSA9IGNvbnRyYWN0LmZ1bmN0aW9ucy5iYWxhbmNlT2YoCiAgICAgICAgICAgIFdlYjMudG9fY2hlY2tzdW1fYWRkcmVzcyh3YWxsZXRfYWRkcmVzcykKICAgICAgICApLmNhbGwoKQogICAgICAgIAogICAgICAgIGRlY2ltYWxzID0gY29udHJhY3QuZnVuY3Rpb25zLmRlY2ltYWxzKCkuY2FsbCgpCiAgICAgICAgcmV0dXJuIGJhbGFuY2UgLyAoMTAgKiogZGVjaW1hbHMp"><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-12-4')" type="button">Run</button></div><pre><code><span class="c1"># ERC20 ABI (minimal for reading)</span>
<span class="n">ERC20_ABI</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="s2">&quot;constant&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="s2">&quot;inputs&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span>
        <span class="s2">&quot;outputs&quot;</span><span class="p">:</span> <span class="p">[{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">}],</span>
        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;function&quot;</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="s2">&quot;constant&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="s2">&quot;inputs&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;symbol&quot;</span><span class="p">,</span>
        <span class="s2">&quot;outputs&quot;</span><span class="p">:</span> <span class="p">[{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">}],</span>
        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;function&quot;</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="s2">&quot;constant&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="s2">&quot;inputs&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;decimals&quot;</span><span class="p">,</span>
        <span class="s2">&quot;outputs&quot;</span><span class="p">:</span> <span class="p">[{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;uint8&quot;</span><span class="p">}],</span>
        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;function&quot;</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="s2">&quot;constant&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="s2">&quot;inputs&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;totalSupply&quot;</span><span class="p">,</span>
        <span class="s2">&quot;outputs&quot;</span><span class="p">:</span> <span class="p">[{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;uint256&quot;</span><span class="p">}],</span>
        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;function&quot;</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="s2">&quot;constant&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="s2">&quot;inputs&quot;</span><span class="p">:</span> <span class="p">[{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;_owner&quot;</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;address&quot;</span><span class="p">}],</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;balanceOf&quot;</span><span class="p">,</span>
        <span class="s2">&quot;outputs&quot;</span><span class="p">:</span> <span class="p">[{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;balance&quot;</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;uint256&quot;</span><span class="p">}],</span>
        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;function&quot;</span>
    <span class="p">}</span>
<span class="p">]</span>

<span class="k">class</span> <span class="nc">TokenReader</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Read ERC20 token data.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">w3</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w3</span> <span class="o">=</span> <span class="n">w3</span>
    
    <span class="k">def</span> <span class="nf">get_token_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token_address</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get basic token information.&quot;&quot;&quot;</span>
        <span class="n">contract</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">contract</span><span class="p">(</span>
            <span class="n">address</span><span class="o">=</span><span class="n">Web3</span><span class="o">.</span><span class="n">to_checksum_address</span><span class="p">(</span><span class="n">token_address</span><span class="p">),</span>
            <span class="n">abi</span><span class="o">=</span><span class="n">ERC20_ABI</span>
        <span class="p">)</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s1">&#39;address&#39;</span><span class="p">:</span> <span class="n">token_address</span><span class="p">,</span>
                <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">contract</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">name</span><span class="p">()</span><span class="o">.</span><span class="n">call</span><span class="p">(),</span>
                <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">contract</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">symbol</span><span class="p">()</span><span class="o">.</span><span class="n">call</span><span class="p">(),</span>
                <span class="s1">&#39;decimals&#39;</span><span class="p">:</span> <span class="n">contract</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">decimals</span><span class="p">()</span><span class="o">.</span><span class="n">call</span><span class="p">(),</span>
                <span class="s1">&#39;total_supply&#39;</span><span class="p">:</span> <span class="n">contract</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">totalSupply</span><span class="p">()</span><span class="o">.</span><span class="n">call</span><span class="p">()</span>
            <span class="p">}</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>
    
    <span class="k">def</span> <span class="nf">get_balance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token_address</span><span class="p">,</span> <span class="n">wallet_address</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get token balance for wallet.&quot;&quot;&quot;</span>
        <span class="n">contract</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">contract</span><span class="p">(</span>
            <span class="n">address</span><span class="o">=</span><span class="n">Web3</span><span class="o">.</span><span class="n">to_checksum_address</span><span class="p">(</span><span class="n">token_address</span><span class="p">),</span>
            <span class="n">abi</span><span class="o">=</span><span class="n">ERC20_ABI</span>
        <span class="p">)</span>
        
        <span class="n">balance</span> <span class="o">=</span> <span class="n">contract</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">balanceOf</span><span class="p">(</span>
            <span class="n">Web3</span><span class="o">.</span><span class="n">to_checksum_address</span><span class="p">(</span><span class="n">wallet_address</span><span class="p">)</span>
        <span class="p">)</span><span class="o">.</span><span class="n">call</span><span class="p">()</span>
        
        <span class="n">decimals</span> <span class="o">=</span> <span class="n">contract</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">decimals</span><span class="p">()</span><span class="o">.</span><span class="n">call</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">balance</span> <span class="o">/</span> <span class="p">(</span><span class="mi">10</span> <span class="o">**</span> <span class="n">decimals</span><span class="p">)</span>
</code></pre><div class="code-output" id="output-cell-12-4"></div></div>
<div class="md-cell"><h3>âœï¸ Exercise 12.2: Web3 Connection Manager</h3>
<p>Create a multi-chain Web3 connection manager.</p></div>
<div class="code-cell" id="cell-12-5" data-source="IyBFeGVyY2lzZSAxMi4yCmNsYXNzIE11bHRpQ2hhaW5XZWIzOgogICAgZGVmIF9faW5pdF9fKHNlbGYpOgogICAgICAgIHNlbGYuY29ubmVjdGlvbnMgPSB7fQogICAgICAgIHNlbGYucnBjcyA9IHsKICAgICAgICAgICAgJ2V0aGVyZXVtJzogJ2h0dHBzOi8vZXRoLmxsYW1hcnBjLmNvbScsCiAgICAgICAgICAgICdwb2x5Z29uJzogJ2h0dHBzOi8vcG9seWdvbi1ycGMuY29tJywKICAgICAgICAgICAgJ2FyYml0cnVtJzogJ2h0dHBzOi8vYXJiMS5hcmJpdHJ1bS5pby9ycGMnCiAgICAgICAgfQogICAgCiAgICBkZWYgY29ubmVjdF9jaGFpbihzZWxmLCBjaGFpbik6CiAgICAgICAgIyBUT0RPOiBDb25uZWN0IHRvIHNwZWNpZmllZCBjaGFpbgogICAgICAgIHBhc3MKICAgIAogICAgZGVmIGdldF9jb25uZWN0aW9uKHNlbGYsIGNoYWluKToKICAgICAgICAjIFRPRE86IFJldHVybiBXZWIzIGluc3RhbmNlIGZvciBjaGFpbgogICAgICAgIHBhc3MKICAgIAogICAgZGVmIGNoZWNrX2FsbF9jb25uZWN0aW9ucyhzZWxmKToKICAgICAgICAjIFRPRE86IFJldHVybiBzdGF0dXMgb2YgYWxsIGNvbm5lY3Rpb25zCiAgICAgICAgcGFzcw=="><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-12-5')" type="button">Run</button></div><pre><code><span class="c1"># Exercise 12.2</span>
<span class="k">class</span> <span class="nc">MultiChainWeb3</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connections</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rpcs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;ethereum&#39;</span><span class="p">:</span> <span class="s1">&#39;https://eth.llamarpc.com&#39;</span><span class="p">,</span>
            <span class="s1">&#39;polygon&#39;</span><span class="p">:</span> <span class="s1">&#39;https://polygon-rpc.com&#39;</span><span class="p">,</span>
            <span class="s1">&#39;arbitrum&#39;</span><span class="p">:</span> <span class="s1">&#39;https://arb1.arbitrum.io/rpc&#39;</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">connect_chain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chain</span><span class="p">):</span>
        <span class="c1"># TODO: Connect to specified chain</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">get_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chain</span><span class="p">):</span>
        <span class="c1"># TODO: Return Web3 instance for chain</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">check_all_connections</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># TODO: Return status of all connections</span>
        <span class="k">pass</span>
</code></pre><div class="code-output" id="output-cell-12-5"></div></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">MultiChainWeb3</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connections</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rpcs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;ethereum&#39;</span><span class="p">:</span> <span class="s1">&#39;https://eth.llamarpc.com&#39;</span><span class="p">,</span>
            <span class="s1">&#39;polygon&#39;</span><span class="p">:</span> <span class="s1">&#39;https://polygon-rpc.com&#39;</span><span class="p">,</span>
            <span class="s1">&#39;arbitrum&#39;</span><span class="p">:</span> <span class="s1">&#39;https://arb1.arbitrum.io/rpc&#39;</span><span class="p">,</span>
            <span class="s1">&#39;optimism&#39;</span><span class="p">:</span> <span class="s1">&#39;https://mainnet.optimism.io&#39;</span><span class="p">,</span>
            <span class="s1">&#39;base&#39;</span><span class="p">:</span> <span class="s1">&#39;https://mainnet.base.org&#39;</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">connect_chain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chain</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">chain</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rpcs</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Unknown chain: </span><span class="si">{</span><span class="n">chain</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">}</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">w3</span> <span class="o">=</span> <span class="n">Web3</span><span class="p">(</span><span class="n">Web3</span><span class="o">.</span><span class="n">HTTPProvider</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rpcs</span><span class="p">[</span><span class="n">chain</span><span class="p">]))</span>
            <span class="k">if</span> <span class="n">w3</span><span class="o">.</span><span class="n">is_connected</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">connections</span><span class="p">[</span><span class="n">chain</span><span class="p">]</span> <span class="o">=</span> <span class="n">w3</span>
                <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;block&#39;</span><span class="p">:</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">block_number</span><span class="p">}</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Connection failed&#39;</span><span class="p">}</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>

    <span class="k">def</span> <span class="nf">get_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chain</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">chain</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">connections</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">connect_chain</span><span class="p">(</span><span class="n">chain</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">connections</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">chain</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">connect_all</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">chain</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rpcs</span><span class="p">:</span>
            <span class="n">results</span><span class="p">[</span><span class="n">chain</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connect_chain</span><span class="p">(</span><span class="n">chain</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">results</span>

    <span class="k">def</span> <span class="nf">check_all_connections</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">status</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">chain</span><span class="p">,</span> <span class="n">w3</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">connections</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">status</span><span class="p">[</span><span class="n">chain</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;connected&#39;</span><span class="p">:</span> <span class="n">w3</span><span class="o">.</span><span class="n">is_connected</span><span class="p">(),</span>
                    <span class="s1">&#39;block&#39;</span><span class="p">:</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">block_number</span><span class="p">,</span>
                    <span class="s1">&#39;gas_gwei&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">w3</span><span class="o">.</span><span class="n">from_wei</span><span class="p">(</span><span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">gas_price</span><span class="p">,</span> <span class="s1">&#39;gwei&#39;</span><span class="p">))</span>
                <span class="p">}</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">status</span><span class="p">[</span><span class="n">chain</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;connected&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">status</span>

<span class="n">multi</span> <span class="o">=</span> <span class="n">MultiChainWeb3</span><span class="p">()</span>
<span class="n">multi</span><span class="o">.</span><span class="n">connect_chain</span><span class="p">(</span><span class="s1">&#39;ethereum&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">multi</span><span class="o">.</span><span class="n">check_all_connections</span><span class="p">())</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>Section 3: DEX Overview</h1>
<h2>3.1 Automated Market Makers (AMMs)</h2></div>
<div class="code-cell" id="cell-12-6" data-source="Y2xhc3MgQU1NU2ltdWxhdG9yOgogICAgIiIiCiAgICBTaW11bGF0ZSBjb25zdGFudCBwcm9kdWN0IEFNTSAoeCAqIHkgPSBrKS4KICAgIFVzZWQgYnkgVW5pc3dhcCBWMiwgU3VzaGlTd2FwLCBldGMuCiAgICAiIiIKICAgIAogICAgZGVmIF9faW5pdF9fKHNlbGYsIHJlc2VydmVfYSwgcmVzZXJ2ZV9iLCBmZWU9MC4wMDMpOgogICAgICAgIHNlbGYucmVzZXJ2ZV9hID0gcmVzZXJ2ZV9hICAjIGUuZy4sIEVUSAogICAgICAgIHNlbGYucmVzZXJ2ZV9iID0gcmVzZXJ2ZV9iICAjIGUuZy4sIFVTREMKICAgICAgICBzZWxmLmZlZSA9IGZlZSAgIyAwLjMlIHR5cGljYWwKICAgICAgICBzZWxmLmsgPSByZXNlcnZlX2EgKiByZXNlcnZlX2IgICMgQ29uc3RhbnQgcHJvZHVjdAogICAgCiAgICBkZWYgZ2V0X3ByaWNlKHNlbGYpOgogICAgICAgICIiIkdldCBjdXJyZW50IHByaWNlIG9mIEEgaW4gdGVybXMgb2YgQi4iIiIKICAgICAgICByZXR1cm4gc2VsZi5yZXNlcnZlX2IgLyBzZWxmLnJlc2VydmVfYQogICAgCiAgICBkZWYgZ2V0X2Ftb3VudF9vdXQoc2VsZiwgYW1vdW50X2luLCB0b2tlbl9pbj0nQScpOgogICAgICAgICIiIgogICAgICAgIENhbGN1bGF0ZSBvdXRwdXQgYW1vdW50IGZvciBhIHN3YXAuCiAgICAgICAgCiAgICAgICAgRm9ybXVsYTogYW1vdW50X291dCA9IChyZXNlcnZlX291dCAqIGFtb3VudF9pbiAqICgxIC0gZmVlKSkgLyAocmVzZXJ2ZV9pbiArIGFtb3VudF9pbiAqICgxIC0gZmVlKSkKICAgICAgICAiIiIKICAgICAgICBhbW91bnRfaW5fd2l0aF9mZWUgPSBhbW91bnRfaW4gKiAoMSAtIHNlbGYuZmVlKQogICAgICAgIAogICAgICAgIGlmIHRva2VuX2luID09ICdBJzoKICAgICAgICAgICAgYW1vdW50X291dCA9IChzZWxmLnJlc2VydmVfYiAqIGFtb3VudF9pbl93aXRoX2ZlZSkgLyAoc2VsZi5yZXNlcnZlX2EgKyBhbW91bnRfaW5fd2l0aF9mZWUpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgYW1vdW50X291dCA9IChzZWxmLnJlc2VydmVfYSAqIGFtb3VudF9pbl93aXRoX2ZlZSkgLyAoc2VsZi5yZXNlcnZlX2IgKyBhbW91bnRfaW5fd2l0aF9mZWUpCiAgICAgICAgCiAgICAgICAgcmV0dXJuIGFtb3VudF9vdXQKICAgIAogICAgZGVmIGdldF9wcmljZV9pbXBhY3Qoc2VsZiwgYW1vdW50X2luLCB0b2tlbl9pbj0nQScpOgogICAgICAgICIiIkNhbGN1bGF0ZSBwcmljZSBpbXBhY3Qgb2YgYSB0cmFkZS4iIiIKICAgICAgICBpbml0aWFsX3ByaWNlID0gc2VsZi5nZXRfcHJpY2UoKQogICAgICAgIGFtb3VudF9vdXQgPSBzZWxmLmdldF9hbW91bnRfb3V0KGFtb3VudF9pbiwgdG9rZW5faW4pCiAgICAgICAgCiAgICAgICAgaWYgdG9rZW5faW4gPT0gJ0EnOgogICAgICAgICAgICBlZmZlY3RpdmVfcHJpY2UgPSBhbW91bnRfb3V0IC8gYW1vdW50X2luCiAgICAgICAgICAgIGltcGFjdCA9IChpbml0aWFsX3ByaWNlIC0gZWZmZWN0aXZlX3ByaWNlKSAvIGluaXRpYWxfcHJpY2UKICAgICAgICBlbHNlOgogICAgICAgICAgICBlZmZlY3RpdmVfcHJpY2UgPSBhbW91bnRfaW4gLyBhbW91bnRfb3V0CiAgICAgICAgICAgIGltcGFjdCA9IChlZmZlY3RpdmVfcHJpY2UgLSBpbml0aWFsX3ByaWNlKSAvIGluaXRpYWxfcHJpY2UKICAgICAgICAKICAgICAgICByZXR1cm4gaW1wYWN0ICogMTAwICAjIFJldHVybiBhcyBwZXJjZW50YWdlCiAgICAKICAgIGRlZiBzaW11bGF0ZV9zd2FwKHNlbGYsIGFtb3VudF9pbiwgdG9rZW5faW49J0EnKToKICAgICAgICAiIiJTaW11bGF0ZSBhIHN3YXAgYW5kIHVwZGF0ZSByZXNlcnZlcy4iIiIKICAgICAgICBhbW91bnRfb3V0ID0gc2VsZi5nZXRfYW1vdW50X291dChhbW91bnRfaW4sIHRva2VuX2luKQogICAgICAgIAogICAgICAgIGlmIHRva2VuX2luID09ICdBJzoKICAgICAgICAgICAgc2VsZi5yZXNlcnZlX2EgKz0gYW1vdW50X2luCiAgICAgICAgICAgIHNlbGYucmVzZXJ2ZV9iIC09IGFtb3VudF9vdXQKICAgICAgICBlbHNlOgogICAgICAgICAgICBzZWxmLnJlc2VydmVfYiArPSBhbW91bnRfaW4KICAgICAgICAgICAgc2VsZi5yZXNlcnZlX2EgLT0gYW1vdW50X291dAogICAgICAgIAogICAgICAgIHJldHVybiBhbW91bnRfb3V0CgojIEV4YW1wbGU6IEVUSC9VU0RDIHBvb2wKcG9vbCA9IEFNTVNpbXVsYXRvcigxMDAwLCAyXzAwMF8wMDApICAjIDEwMDAgRVRILCAyTSBVU0RDCnByaW50KGYnRVRIIFByaWNlOiAke3Bvb2wuZ2V0X3ByaWNlKCk6LC4yZn0nKQpwcmludChmJ1N3YXAgMTAgRVRIIC0+IHtwb29sLmdldF9hbW91bnRfb3V0KDEwLCAiQSIpOiwuMmZ9IFVTREMnKQpwcmludChmJ1ByaWNlIEltcGFjdDoge3Bvb2wuZ2V0X3ByaWNlX2ltcGFjdCgxMCwgIkEiKTouMmZ9JScp"><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-12-6')" type="button">Run</button></div><pre><code><span class="k">class</span> <span class="nc">AMMSimulator</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Simulate constant product AMM (x * y = k).</span>
<span class="sd">    Used by Uniswap V2, SushiSwap, etc.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reserve_a</span><span class="p">,</span> <span class="n">reserve_b</span><span class="p">,</span> <span class="n">fee</span><span class="o">=</span><span class="mf">0.003</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reserve_a</span> <span class="o">=</span> <span class="n">reserve_a</span>  <span class="c1"># e.g., ETH</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reserve_b</span> <span class="o">=</span> <span class="n">reserve_b</span>  <span class="c1"># e.g., USDC</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fee</span> <span class="o">=</span> <span class="n">fee</span>  <span class="c1"># 0.3% typical</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k</span> <span class="o">=</span> <span class="n">reserve_a</span> <span class="o">*</span> <span class="n">reserve_b</span>  <span class="c1"># Constant product</span>
    
    <span class="k">def</span> <span class="nf">get_price</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get current price of A in terms of B.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">reserve_b</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">reserve_a</span>
    
    <span class="k">def</span> <span class="nf">get_amount_out</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amount_in</span><span class="p">,</span> <span class="n">token_in</span><span class="o">=</span><span class="s1">&#39;A&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate output amount for a swap.</span>
<span class="sd">        </span>
<span class="sd">        Formula: amount_out = (reserve_out * amount_in * (1 - fee)) / (reserve_in + amount_in * (1 - fee))</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">amount_in_with_fee</span> <span class="o">=</span> <span class="n">amount_in</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">fee</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">token_in</span> <span class="o">==</span> <span class="s1">&#39;A&#39;</span><span class="p">:</span>
            <span class="n">amount_out</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reserve_b</span> <span class="o">*</span> <span class="n">amount_in_with_fee</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reserve_a</span> <span class="o">+</span> <span class="n">amount_in_with_fee</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">amount_out</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reserve_a</span> <span class="o">*</span> <span class="n">amount_in_with_fee</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reserve_b</span> <span class="o">+</span> <span class="n">amount_in_with_fee</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">amount_out</span>
    
    <span class="k">def</span> <span class="nf">get_price_impact</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amount_in</span><span class="p">,</span> <span class="n">token_in</span><span class="o">=</span><span class="s1">&#39;A&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculate price impact of a trade.&quot;&quot;&quot;</span>
        <span class="n">initial_price</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_price</span><span class="p">()</span>
        <span class="n">amount_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_amount_out</span><span class="p">(</span><span class="n">amount_in</span><span class="p">,</span> <span class="n">token_in</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">token_in</span> <span class="o">==</span> <span class="s1">&#39;A&#39;</span><span class="p">:</span>
            <span class="n">effective_price</span> <span class="o">=</span> <span class="n">amount_out</span> <span class="o">/</span> <span class="n">amount_in</span>
            <span class="n">impact</span> <span class="o">=</span> <span class="p">(</span><span class="n">initial_price</span> <span class="o">-</span> <span class="n">effective_price</span><span class="p">)</span> <span class="o">/</span> <span class="n">initial_price</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">effective_price</span> <span class="o">=</span> <span class="n">amount_in</span> <span class="o">/</span> <span class="n">amount_out</span>
            <span class="n">impact</span> <span class="o">=</span> <span class="p">(</span><span class="n">effective_price</span> <span class="o">-</span> <span class="n">initial_price</span><span class="p">)</span> <span class="o">/</span> <span class="n">initial_price</span>
        
        <span class="k">return</span> <span class="n">impact</span> <span class="o">*</span> <span class="mi">100</span>  <span class="c1"># Return as percentage</span>
    
    <span class="k">def</span> <span class="nf">simulate_swap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amount_in</span><span class="p">,</span> <span class="n">token_in</span><span class="o">=</span><span class="s1">&#39;A&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Simulate a swap and update reserves.&quot;&quot;&quot;</span>
        <span class="n">amount_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_amount_out</span><span class="p">(</span><span class="n">amount_in</span><span class="p">,</span> <span class="n">token_in</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">token_in</span> <span class="o">==</span> <span class="s1">&#39;A&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reserve_a</span> <span class="o">+=</span> <span class="n">amount_in</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reserve_b</span> <span class="o">-=</span> <span class="n">amount_out</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reserve_b</span> <span class="o">+=</span> <span class="n">amount_in</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reserve_a</span> <span class="o">-=</span> <span class="n">amount_out</span>
        
        <span class="k">return</span> <span class="n">amount_out</span>

<span class="c1"># Example: ETH/USDC pool</span>
<span class="n">pool</span> <span class="o">=</span> <span class="n">AMMSimulator</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">2_000_000</span><span class="p">)</span>  <span class="c1"># 1000 ETH, 2M USDC</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;ETH Price: $</span><span class="si">{</span><span class="n">pool</span><span class="o">.</span><span class="n">get_price</span><span class="p">()</span><span class="si">:</span><span class="s1">,.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Swap 10 ETH -&gt; </span><span class="si">{</span><span class="n">pool</span><span class="o">.</span><span class="n">get_amount_out</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="s2">&quot;A&quot;</span><span class="p">)</span><span class="si">:</span><span class="s1">,.2f</span><span class="si">}</span><span class="s1"> USDC&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Price Impact: </span><span class="si">{</span><span class="n">pool</span><span class="o">.</span><span class="n">get_price_impact</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="s2">&quot;A&quot;</span><span class="p">)</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">%&#39;</span><span class="p">)</span>
</code></pre><div class="code-output" id="output-cell-12-6"></div></div>
<div class="md-cell"><h2>3.2 Liquidity Pools</h2></div>
<div class="code-cell" id="cell-12-7" data-source="Y2xhc3MgTGlxdWlkaXR5UG9vbDoKICAgICIiIlJlcHJlc2VudCBhIGxpcXVpZGl0eSBwb29sIHdpdGggTFAgdG9rZW5zLiIiIgogICAgCiAgICBkZWYgX19pbml0X18oc2VsZiwgdG9rZW5fYSwgdG9rZW5fYiwgcmVzZXJ2ZV9hLCByZXNlcnZlX2IpOgogICAgICAgIHNlbGYudG9rZW5fYSA9IHRva2VuX2EKICAgICAgICBzZWxmLnRva2VuX2IgPSB0b2tlbl9iCiAgICAgICAgc2VsZi5yZXNlcnZlX2EgPSByZXNlcnZlX2EKICAgICAgICBzZWxmLnJlc2VydmVfYiA9IHJlc2VydmVfYgogICAgICAgIHNlbGYudG90YWxfbHBfdG9rZW5zID0gKHJlc2VydmVfYSAqIHJlc2VydmVfYikgKiogMC41CiAgICAgICAgc2VsZi5scF9ob2xkZXJzID0ge30KICAgIAogICAgZGVmIGFkZF9saXF1aWRpdHkoc2VsZiwgcHJvdmlkZXIsIGFtb3VudF9hLCBhbW91bnRfYik6CiAgICAgICAgIiIiQWRkIGxpcXVpZGl0eSBhbmQgcmVjZWl2ZSBMUCB0b2tlbnMuIiIiCiAgICAgICAgIyBDYWxjdWxhdGUgTFAgdG9rZW5zIHRvIG1pbnQKICAgICAgICBpZiBzZWxmLnRvdGFsX2xwX3Rva2VucyA9PSAwOgogICAgICAgICAgICBscF90b2tlbnMgPSAoYW1vdW50X2EgKiBhbW91bnRfYikgKiogMC41CiAgICAgICAgZWxzZToKICAgICAgICAgICAgbHBfdG9rZW5zID0gbWluKAogICAgICAgICAgICAgICAgYW1vdW50X2EgKiBzZWxmLnRvdGFsX2xwX3Rva2VucyAvIHNlbGYucmVzZXJ2ZV9hLAogICAgICAgICAgICAgICAgYW1vdW50X2IgKiBzZWxmLnRvdGFsX2xwX3Rva2VucyAvIHNlbGYucmVzZXJ2ZV9iCiAgICAgICAgICAgICkKICAgICAgICAKICAgICAgICBzZWxmLnJlc2VydmVfYSArPSBhbW91bnRfYQogICAgICAgIHNlbGYucmVzZXJ2ZV9iICs9IGFtb3VudF9iCiAgICAgICAgc2VsZi50b3RhbF9scF90b2tlbnMgKz0gbHBfdG9rZW5zCiAgICAgICAgc2VsZi5scF9ob2xkZXJzW3Byb3ZpZGVyXSA9IHNlbGYubHBfaG9sZGVycy5nZXQocHJvdmlkZXIsIDApICsgbHBfdG9rZW5zCiAgICAgICAgCiAgICAgICAgcmV0dXJuIGxwX3Rva2VucwogICAgCiAgICBkZWYgcmVtb3ZlX2xpcXVpZGl0eShzZWxmLCBwcm92aWRlciwgbHBfdG9rZW5zKToKICAgICAgICAiIiJSZW1vdmUgbGlxdWlkaXR5IGJ5IGJ1cm5pbmcgTFAgdG9rZW5zLiIiIgogICAgICAgIGlmIHNlbGYubHBfaG9sZGVycy5nZXQocHJvdmlkZXIsIDApIDwgbHBfdG9rZW5zOgogICAgICAgICAgICByZXR1cm4geydlcnJvcic6ICdJbnN1ZmZpY2llbnQgTFAgdG9rZW5zJ30KICAgICAgICAKICAgICAgICBzaGFyZSA9IGxwX3Rva2VucyAvIHNlbGYudG90YWxfbHBfdG9rZW5zCiAgICAgICAgYW1vdW50X2EgPSBzZWxmLnJlc2VydmVfYSAqIHNoYXJlCiAgICAgICAgYW1vdW50X2IgPSBzZWxmLnJlc2VydmVfYiAqIHNoYXJlCiAgICAgICAgCiAgICAgICAgc2VsZi5yZXNlcnZlX2EgLT0gYW1vdW50X2EKICAgICAgICBzZWxmLnJlc2VydmVfYiAtPSBhbW91bnRfYgogICAgICAgIHNlbGYudG90YWxfbHBfdG9rZW5zIC09IGxwX3Rva2VucwogICAgICAgIHNlbGYubHBfaG9sZGVyc1twcm92aWRlcl0gLT0gbHBfdG9rZW5zCiAgICAgICAgCiAgICAgICAgcmV0dXJuIHsnYW1vdW50X2EnOiBhbW91bnRfYSwgJ2Ftb3VudF9iJzogYW1vdW50X2J9CiAgICAKICAgIGRlZiBnZXRfcG9vbF9zaGFyZShzZWxmLCBwcm92aWRlcik6CiAgICAgICAgIiIiR2V0IHByb3ZpZGVyJ3Mgc2hhcmUgb2YgdGhlIHBvb2wuIiIiCiAgICAgICAgbHAgPSBzZWxmLmxwX2hvbGRlcnMuZ2V0KHByb3ZpZGVyLCAwKQogICAgICAgIGlmIHNlbGYudG90YWxfbHBfdG9rZW5zID09IDA6CiAgICAgICAgICAgIHJldHVybiAwCiAgICAgICAgcmV0dXJuIGxwIC8gc2VsZi50b3RhbF9scF90b2tlbnMgKiAxMDA="><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-12-7')" type="button">Run</button></div><pre><code><span class="k">class</span> <span class="nc">LiquidityPool</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Represent a liquidity pool with LP tokens.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token_a</span><span class="p">,</span> <span class="n">token_b</span><span class="p">,</span> <span class="n">reserve_a</span><span class="p">,</span> <span class="n">reserve_b</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">token_a</span> <span class="o">=</span> <span class="n">token_a</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">token_b</span> <span class="o">=</span> <span class="n">token_b</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reserve_a</span> <span class="o">=</span> <span class="n">reserve_a</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reserve_b</span> <span class="o">=</span> <span class="n">reserve_b</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">total_lp_tokens</span> <span class="o">=</span> <span class="p">(</span><span class="n">reserve_a</span> <span class="o">*</span> <span class="n">reserve_b</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lp_holders</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="k">def</span> <span class="nf">add_liquidity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">provider</span><span class="p">,</span> <span class="n">amount_a</span><span class="p">,</span> <span class="n">amount_b</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add liquidity and receive LP tokens.&quot;&quot;&quot;</span>
        <span class="c1"># Calculate LP tokens to mint</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_lp_tokens</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">lp_tokens</span> <span class="o">=</span> <span class="p">(</span><span class="n">amount_a</span> <span class="o">*</span> <span class="n">amount_b</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lp_tokens</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span>
                <span class="n">amount_a</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_lp_tokens</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">reserve_a</span><span class="p">,</span>
                <span class="n">amount_b</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_lp_tokens</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">reserve_b</span>
            <span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">reserve_a</span> <span class="o">+=</span> <span class="n">amount_a</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reserve_b</span> <span class="o">+=</span> <span class="n">amount_b</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">total_lp_tokens</span> <span class="o">+=</span> <span class="n">lp_tokens</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lp_holders</span><span class="p">[</span><span class="n">provider</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lp_holders</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">provider</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">lp_tokens</span>
        
        <span class="k">return</span> <span class="n">lp_tokens</span>
    
    <span class="k">def</span> <span class="nf">remove_liquidity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">provider</span><span class="p">,</span> <span class="n">lp_tokens</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove liquidity by burning LP tokens.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lp_holders</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">provider</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">lp_tokens</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Insufficient LP tokens&#39;</span><span class="p">}</span>
        
        <span class="n">share</span> <span class="o">=</span> <span class="n">lp_tokens</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_lp_tokens</span>
        <span class="n">amount_a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reserve_a</span> <span class="o">*</span> <span class="n">share</span>
        <span class="n">amount_b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reserve_b</span> <span class="o">*</span> <span class="n">share</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">reserve_a</span> <span class="o">-=</span> <span class="n">amount_a</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reserve_b</span> <span class="o">-=</span> <span class="n">amount_b</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">total_lp_tokens</span> <span class="o">-=</span> <span class="n">lp_tokens</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lp_holders</span><span class="p">[</span><span class="n">provider</span><span class="p">]</span> <span class="o">-=</span> <span class="n">lp_tokens</span>
        
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;amount_a&#39;</span><span class="p">:</span> <span class="n">amount_a</span><span class="p">,</span> <span class="s1">&#39;amount_b&#39;</span><span class="p">:</span> <span class="n">amount_b</span><span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">get_pool_share</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">provider</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get provider&#39;s share of the pool.&quot;&quot;&quot;</span>
        <span class="n">lp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lp_holders</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">provider</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_lp_tokens</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="n">lp</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_lp_tokens</span> <span class="o">*</span> <span class="mi">100</span>
</code></pre><div class="code-output" id="output-cell-12-7"></div></div>
<div class="md-cell"><h3>âœï¸ Exercise 12.3: Impermanent Loss Calculator</h3>
<p>Build a calculator for impermanent loss.</p></div>
<div class="code-cell" id="cell-12-8" data-source="IyBFeGVyY2lzZSAxMi4zCmRlZiBjYWxjdWxhdGVfaW1wZXJtYW5lbnRfbG9zcyhwcmljZV9yYXRpb19jaGFuZ2UpOgogICAgIiIiCiAgICBDYWxjdWxhdGUgaW1wZXJtYW5lbnQgbG9zcyBiYXNlZCBvbiBwcmljZSBjaGFuZ2UuCiAgICAKICAgIHByaWNlX3JhdGlvX2NoYW5nZTogZS5nLiwgMi4wIG1lYW5zIHByaWNlIGRvdWJsZWQKICAgIFJldHVybnM6IElMIGFzIHBlcmNlbnRhZ2UgKG5lZ2F0aXZlID0gbG9zcykKICAgICIiIgogICAgIyBUT0RPOiBJbXBsZW1lbnQgSUwgZm9ybXVsYQogICAgIyBJTCA9IDIgKiBzcXJ0KHByaWNlX3JhdGlvKSAvICgxICsgcHJpY2VfcmF0aW8pIC0gMQogICAgcGFzcwoKY2xhc3MgSW1wZXJtYW5lbnRMb3NzVHJhY2tlcjoKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBpbml0aWFsX3ByaWNlX2EsIGluaXRpYWxfcHJpY2VfYik6CiAgICAgICAgc2VsZi5pbml0aWFsX3ByaWNlX2EgPSBpbml0aWFsX3ByaWNlX2EKICAgICAgICBzZWxmLmluaXRpYWxfcHJpY2VfYiA9IGluaXRpYWxfcHJpY2VfYgogICAgCiAgICBkZWYgY2FsY3VsYXRlX2lsKHNlbGYsIGN1cnJlbnRfcHJpY2VfYSwgY3VycmVudF9wcmljZV9iKToKICAgICAgICAjIFRPRE8KICAgICAgICBwYXNzCiAgICAKICAgIGRlZiBicmVha2V2ZW5fZmVlcyhzZWxmLCBpbF9wZXJjZW50KToKICAgICAgICAjIFRPRE86IENhbGN1bGF0ZSBmZWVzIG5lZWRlZCB0byBvZmZzZXQgSUwKICAgICAgICBwYXNz"><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-12-8')" type="button">Run</button></div><pre><code><span class="c1"># Exercise 12.3</span>
<span class="k">def</span> <span class="nf">calculate_impermanent_loss</span><span class="p">(</span><span class="n">price_ratio_change</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate impermanent loss based on price change.</span>
<span class="sd">    </span>
<span class="sd">    price_ratio_change: e.g., 2.0 means price doubled</span>
<span class="sd">    Returns: IL as percentage (negative = loss)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO: Implement IL formula</span>
    <span class="c1"># IL = 2 * sqrt(price_ratio) / (1 + price_ratio) - 1</span>
    <span class="k">pass</span>

<span class="k">class</span> <span class="nc">ImpermanentLossTracker</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">initial_price_a</span><span class="p">,</span> <span class="n">initial_price_b</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initial_price_a</span> <span class="o">=</span> <span class="n">initial_price_a</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initial_price_b</span> <span class="o">=</span> <span class="n">initial_price_b</span>
    
    <span class="k">def</span> <span class="nf">calculate_il</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current_price_a</span><span class="p">,</span> <span class="n">current_price_b</span><span class="p">):</span>
        <span class="c1"># TODO</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">breakeven_fees</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">il_percent</span><span class="p">):</span>
        <span class="c1"># TODO: Calculate fees needed to offset IL</span>
        <span class="k">pass</span>
</code></pre><div class="code-output" id="output-cell-12-8"></div></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">math</span>

<span class="k">def</span> <span class="nf">calculate_impermanent_loss</span><span class="p">(</span><span class="n">price_ratio_change</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate impermanent loss based on price change.</span>

<span class="sd">    IL = 2 * sqrt(price_ratio) / (1 + price_ratio) - 1</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sqrt_ratio</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">price_ratio_change</span><span class="p">)</span>
    <span class="n">il</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">sqrt_ratio</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">price_ratio_change</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">il</span> <span class="o">*</span> <span class="mi">100</span>  <span class="c1"># Return as percentage</span>

<span class="k">class</span> <span class="nc">ImpermanentLossTracker</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">initial_price_a</span><span class="p">,</span> <span class="n">initial_price_b</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initial_price_a</span> <span class="o">=</span> <span class="n">initial_price_a</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initial_price_b</span> <span class="o">=</span> <span class="n">initial_price_b</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initial_ratio</span> <span class="o">=</span> <span class="n">initial_price_a</span> <span class="o">/</span> <span class="n">initial_price_b</span>

    <span class="k">def</span> <span class="nf">calculate_il</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current_price_a</span><span class="p">,</span> <span class="n">current_price_b</span><span class="p">):</span>
        <span class="n">current_ratio</span> <span class="o">=</span> <span class="n">current_price_a</span> <span class="o">/</span> <span class="n">current_price_b</span>
        <span class="n">price_ratio_change</span> <span class="o">=</span> <span class="n">current_ratio</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_ratio</span>
        <span class="k">return</span> <span class="n">calculate_impermanent_loss</span><span class="p">(</span><span class="n">price_ratio_change</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">breakeven_fees</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">il_percent</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculate APR needed to offset IL.&quot;&quot;&quot;</span>
        <span class="c1"># If IL is -5%, need at least 5% in fees to break even</span>
        <span class="k">return</span> <span class="nb">abs</span><span class="p">(</span><span class="n">il_percent</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">analyze_scenarios</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Show IL for various price changes.&quot;&quot;&quot;</span>
        <span class="n">scenarios</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.25</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Price Change -&gt; Impermanent Loss&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-&#39;</span> <span class="o">*</span> <span class="mi">35</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ratio</span> <span class="ow">in</span> <span class="n">scenarios</span><span class="p">:</span>
            <span class="n">il</span> <span class="o">=</span> <span class="n">calculate_impermanent_loss</span><span class="p">(</span><span class="n">ratio</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ratio</span><span class="si">:</span><span class="s1">&gt;6.2f</span><span class="si">}</span><span class="s1">x      -&gt; </span><span class="si">{</span><span class="n">il</span><span class="si">:</span><span class="s1">&gt;6.2f</span><span class="si">}</span><span class="s1">%&#39;</span><span class="p">)</span>

<span class="n">tracker</span> <span class="o">=</span> <span class="n">ImpermanentLossTracker</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># ETH at $2000, USDC at $1</span>
<span class="n">tracker</span><span class="o">.</span><span class="n">analyze_scenarios</span><span class="p">()</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>Section 4: DeFi Data Sources</h1></div>
<div class="code-cell" id="cell-12-9" data-source="aW1wb3J0IHJlcXVlc3RzCgpjbGFzcyBEZUZpTGxhbWFBUEk6CiAgICAiIiJBY2Nlc3MgRGVGaSBMbGFtYSBBUEkgZm9yIHByb3RvY29sIGRhdGEuIiIiCiAgICAKICAgIEJBU0VfVVJMID0gJ2h0dHBzOi8vYXBpLmxsYW1hLmZpJwogICAgCiAgICBkZWYgZ2V0X3Byb3RvY29scyhzZWxmKToKICAgICAgICAiIiJHZXQgYWxsIERlRmkgcHJvdG9jb2xzLiIiIgogICAgICAgIHJlc3BvbnNlID0gcmVxdWVzdHMuZ2V0KGYne3NlbGYuQkFTRV9VUkx9L3Byb3RvY29scycpCiAgICAgICAgaWYgcmVzcG9uc2Uuc3RhdHVzX2NvZGUgPT0gMjAwOgogICAgICAgICAgICByZXR1cm4gcmVzcG9uc2UuanNvbigpCiAgICAgICAgcmV0dXJuIHsnZXJyb3InOiByZXNwb25zZS5zdGF0dXNfY29kZX0KICAgIAogICAgZGVmIGdldF9wcm90b2NvbChzZWxmLCBzbHVnKToKICAgICAgICAiIiJHZXQgc3BlY2lmaWMgcHJvdG9jb2wgZGF0YS4iIiIKICAgICAgICByZXNwb25zZSA9IHJlcXVlc3RzLmdldChmJ3tzZWxmLkJBU0VfVVJMfS9wcm90b2NvbC97c2x1Z30nKQogICAgICAgIGlmIHJlc3BvbnNlLnN0YXR1c19jb2RlID09IDIwMDoKICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlLmpzb24oKQogICAgICAgIHJldHVybiB7J2Vycm9yJzogcmVzcG9uc2Uuc3RhdHVzX2NvZGV9CiAgICAKICAgIGRlZiBnZXRfdHZsX2J5X2NoYWluKHNlbGYpOgogICAgICAgICIiIkdldCBUVkwgYnJlYWtkb3duIGJ5IGNoYWluLiIiIgogICAgICAgIHJlc3BvbnNlID0gcmVxdWVzdHMuZ2V0KGYne3NlbGYuQkFTRV9VUkx9L3YyL2NoYWlucycpCiAgICAgICAgaWYgcmVzcG9uc2Uuc3RhdHVzX2NvZGUgPT0gMjAwOgogICAgICAgICAgICByZXR1cm4gcmVzcG9uc2UuanNvbigpCiAgICAgICAgcmV0dXJuIHsnZXJyb3InOiByZXNwb25zZS5zdGF0dXNfY29kZX0KICAgIAogICAgZGVmIGdldF95aWVsZHMoc2VsZik6CiAgICAgICAgIiIiR2V0IHlpZWxkIGZhcm1pbmcgb3Bwb3J0dW5pdGllcy4iIiIKICAgICAgICByZXNwb25zZSA9IHJlcXVlc3RzLmdldCgnaHR0cHM6Ly95aWVsZHMubGxhbWEuZmkvcG9vbHMnKQogICAgICAgIGlmIHJlc3BvbnNlLnN0YXR1c19jb2RlID09IDIwMDoKICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlLmpzb24oKQogICAgICAgIHJldHVybiB7J2Vycm9yJzogcmVzcG9uc2Uuc3RhdHVzX2NvZGV9CiAgICAKICAgIGRlZiB0b3BfcHJvdG9jb2xzKHNlbGYsIG49MTApOgogICAgICAgICIiIkdldCB0b3AgcHJvdG9jb2xzIGJ5IFRWTC4iIiIKICAgICAgICBwcm90b2NvbHMgPSBzZWxmLmdldF9wcm90b2NvbHMoKQogICAgICAgIGlmICdlcnJvcicgaW4gcHJvdG9jb2xzOgogICAgICAgICAgICByZXR1cm4gcHJvdG9jb2xzCiAgICAgICAgCiAgICAgICAgc29ydGVkX3Byb3RvY29scyA9IHNvcnRlZChwcm90b2NvbHMsIGtleT1sYW1iZGEgeDogeC5nZXQoJ3R2bCcsIDApLCByZXZlcnNlPVRydWUpCiAgICAgICAgcmV0dXJuIFt7CiAgICAgICAgICAgICduYW1lJzogcFsnbmFtZSddLAogICAgICAgICAgICAndHZsJzogcC5nZXQoJ3R2bCcsIDApLAogICAgICAgICAgICAnY2hhaW4nOiBwLmdldCgnY2hhaW4nLCAnTXVsdGknKSwKICAgICAgICAgICAgJ2NhdGVnb3J5JzogcC5nZXQoJ2NhdGVnb3J5JywgJ1Vua25vd24nKQogICAgICAgIH0gZm9yIHAgaW4gc29ydGVkX3Byb3RvY29sc1s6bl1d"><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-12-9')" type="button">Run</button></div><pre><code><span class="kn">import</span> <span class="nn">requests</span>

<span class="k">class</span> <span class="nc">DeFiLlamaAPI</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Access DeFi Llama API for protocol data.&quot;&quot;&quot;</span>
    
    <span class="n">BASE_URL</span> <span class="o">=</span> <span class="s1">&#39;https://api.llama.fi&#39;</span>
    
    <span class="k">def</span> <span class="nf">get_protocols</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get all DeFi protocols.&quot;&quot;&quot;</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">BASE_URL</span><span class="si">}</span><span class="s1">/protocols&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">get_protocol</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">slug</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get specific protocol data.&quot;&quot;&quot;</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">BASE_URL</span><span class="si">}</span><span class="s1">/protocol/</span><span class="si">{</span><span class="n">slug</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">get_tvl_by_chain</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get TVL breakdown by chain.&quot;&quot;&quot;</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">BASE_URL</span><span class="si">}</span><span class="s1">/v2/chains&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">get_yields</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get yield farming opportunities.&quot;&quot;&quot;</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;https://yields.llama.fi/pools&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">top_protocols</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get top protocols by TVL.&quot;&quot;&quot;</span>
        <span class="n">protocols</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_protocols</span><span class="p">()</span>
        <span class="k">if</span> <span class="s1">&#39;error&#39;</span> <span class="ow">in</span> <span class="n">protocols</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">protocols</span>
        
        <span class="n">sorted_protocols</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">protocols</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tvl&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[{</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span>
            <span class="s1">&#39;tvl&#39;</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tvl&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
            <span class="s1">&#39;chain&#39;</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;chain&#39;</span><span class="p">,</span> <span class="s1">&#39;Multi&#39;</span><span class="p">),</span>
            <span class="s1">&#39;category&#39;</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;category&#39;</span><span class="p">,</span> <span class="s1">&#39;Unknown&#39;</span><span class="p">)</span>
        <span class="p">}</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">sorted_protocols</span><span class="p">[:</span><span class="n">n</span><span class="p">]]</span>
</code></pre><div class="code-output" id="output-cell-12-9"></div></div>
<div class="md-cell"><h3>âœï¸ Exercise 12.4: DeFi Data Aggregator</h3>
<p>Build a comprehensive DeFi data aggregator.</p></div>
<div class="code-cell" id="cell-12-10" data-source="IyBFeGVyY2lzZSAxMi40CmNsYXNzIERlRmlEYXRhQWdncmVnYXRvcjoKICAgIGRlZiBfX2luaXRfXyhzZWxmKToKICAgICAgICBzZWxmLmxsYW1hID0gRGVGaUxsYW1hQVBJKCkKICAgICAgICBzZWxmLmNhY2hlID0ge30KICAgIAogICAgZGVmIGdldF9tYXJrZXRfb3ZlcnZpZXcoc2VsZik6CiAgICAgICAgIyBUT0RPOiBSZXR1cm4gdG90YWwgVFZMLCB0b3AgY2hhaW5zLCB0b3AgcHJvdG9jb2xzCiAgICAgICAgcGFzcwogICAgCiAgICBkZWYgZmluZF95aWVsZF9vcHBvcnR1bml0aWVzKHNlbGYsIG1pbl90dmw9MV8wMDBfMDAwLCBtaW5fYXB5PTUpOgogICAgICAgICMgVE9ETzogRmlsdGVyIHlpZWxkIG9wcG9ydHVuaXRpZXMKICAgICAgICBwYXNzCiAgICAKICAgIGRlZiBjb21wYXJlX3Byb3RvY29scyhzZWxmLCBwcm90b2NvbHMpOgogICAgICAgICMgVE9ETzogQ29tcGFyZSBtdWx0aXBsZSBwcm90b2NvbHMKICAgICAgICBwYXNz"><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-12-10')" type="button">Run</button></div><pre><code><span class="c1"># Exercise 12.4</span>
<span class="k">class</span> <span class="nc">DeFiDataAggregator</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">llama</span> <span class="o">=</span> <span class="n">DeFiLlamaAPI</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="k">def</span> <span class="nf">get_market_overview</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># TODO: Return total TVL, top chains, top protocols</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">find_yield_opportunities</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">min_tvl</span><span class="o">=</span><span class="mi">1_000_000</span><span class="p">,</span> <span class="n">min_apy</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
        <span class="c1"># TODO: Filter yield opportunities</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">compare_protocols</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">protocols</span><span class="p">):</span>
        <span class="c1"># TODO: Compare multiple protocols</span>
        <span class="k">pass</span>
</code></pre><div class="code-output" id="output-cell-12-10"></div></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">DeFiDataAggregator</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">llama</span> <span class="o">=</span> <span class="n">DeFiLlamaAPI</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache_ttl</span> <span class="o">=</span> <span class="mi">300</span>  <span class="c1"># 5 minutes</span>

    <span class="k">def</span> <span class="nf">get_market_overview</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">protocols</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">llama</span><span class="o">.</span><span class="n">get_protocols</span><span class="p">()</span>
        <span class="n">chains</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">llama</span><span class="o">.</span><span class="n">get_tvl_by_chain</span><span class="p">()</span>

        <span class="k">if</span> <span class="s1">&#39;error&#39;</span> <span class="ow">in</span> <span class="n">protocols</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">protocols</span>

        <span class="n">total_tvl</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tvl&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">protocols</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;total_tvl&#39;</span><span class="p">:</span> <span class="n">total_tvl</span><span class="p">,</span>
            <span class="s1">&#39;total_protocols&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">protocols</span><span class="p">),</span>
            <span class="s1">&#39;top_chains&#39;</span><span class="p">:</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">chains</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tvl&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)[:</span><span class="mi">5</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">chains</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="p">[],</span>
            <span class="s1">&#39;top_protocols&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">llama</span><span class="o">.</span><span class="n">top_protocols</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">find_yield_opportunities</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">min_tvl</span><span class="o">=</span><span class="mi">1_000_000</span><span class="p">,</span> <span class="n">min_apy</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">max_apy</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
        <span class="n">yields</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">llama</span><span class="o">.</span><span class="n">get_yields</span><span class="p">()</span>
        <span class="k">if</span> <span class="s1">&#39;error&#39;</span> <span class="ow">in</span> <span class="n">yields</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">yields</span>

        <span class="n">pools</span> <span class="o">=</span> <span class="n">yields</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="p">[])</span>

        <span class="n">filtered</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s1">&#39;pool&#39;</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pool&#39;</span><span class="p">),</span>
                <span class="s1">&#39;project&#39;</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;project&#39;</span><span class="p">),</span>
                <span class="s1">&#39;chain&#39;</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;chain&#39;</span><span class="p">),</span>
                <span class="s1">&#39;tvl&#39;</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tvlUsd&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                <span class="s1">&#39;apy&#39;</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;apy&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;symbol&#39;</span><span class="p">)</span>
            <span class="p">}</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pools</span>
            <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tvlUsd&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">min_tvl</span>
            <span class="ow">and</span> <span class="n">min_apy</span> <span class="o">&lt;=</span> <span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;apy&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">max_apy</span>
        <span class="p">]</span>

        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">filtered</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;apy&#39;</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)[:</span><span class="mi">20</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">compare_protocols</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">protocol_slugs</span><span class="p">):</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">slug</span> <span class="ow">in</span> <span class="n">protocol_slugs</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">llama</span><span class="o">.</span><span class="n">get_protocol</span><span class="p">(</span><span class="n">slug</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;error&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">),</span>
                    <span class="s1">&#39;tvl&#39;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tvl&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                    <span class="s1">&#39;chains&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;chainTvls&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
                    <span class="s1">&#39;category&#39;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;category&#39;</span><span class="p">)</span>
                <span class="p">})</span>
        <span class="k">return</span> <span class="n">results</span>

<span class="n">agg</span> <span class="o">=</span> <span class="n">DeFiDataAggregator</span><span class="p">()</span>
<span class="c1"># overview = agg.get_market_overview()</span>
<span class="c1"># print(f&quot;Total DeFi TVL: ${overview[&#39;total_tvl&#39;]:,.0f}&quot;)</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>ğŸ—ï¸ Module Project: DeFi Data Aggregator</h1>
<p>Build a complete DeFi monitoring dashboard.</p></div>
<div class="code-cell" id="cell-12-11" data-source="IyBNb2R1bGUgUHJvamVjdApjbGFzcyBEZUZpRGFzaGJvYXJkOgogICAgZGVmIF9faW5pdF9fKHNlbGYpOgogICAgICAgIHNlbGYud2ViMyA9IE11bHRpQ2hhaW5XZWIzKCkKICAgICAgICBzZWxmLmRhdGEgPSBEZUZpRGF0YUFnZ3JlZ2F0b3IoKQogICAgICAgIHNlbGYudHJhY2tlZF9wcm90b2NvbHMgPSBbXQogICAgCiAgICBkZWYgaW5pdGlhbGl6ZShzZWxmLCBjaGFpbnM9WydldGhlcmV1bSddKToKICAgICAgICAjIFRPRE86IENvbm5lY3QgdG8gY2hhaW5zCiAgICAgICAgcGFzcwogICAgCiAgICBkZWYgdHJhY2tfcHJvdG9jb2woc2VsZiwgc2x1Zyk6CiAgICAgICAgIyBUT0RPOiBBZGQgcHJvdG9jb2wgdG8gd2F0Y2hsaXN0CiAgICAgICAgcGFzcwogICAgCiAgICBkZWYgZ2V0X2Rhc2hib2FyZF9kYXRhKHNlbGYpOgogICAgICAgICMgVE9ETzogUmV0dXJuIGNvbXBsZXRlIGRhc2hib2FyZCBkYXRhCiAgICAgICAgcGFzcwogICAgCiAgICBkZWYgZGlzcGxheShzZWxmKToKICAgICAgICAjIFRPRE86IFByaW50IGZvcm1hdHRlZCBkYXNoYm9hcmQKICAgICAgICBwYXNz"><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-12-11')" type="button">Run</button></div><pre><code><span class="c1"># Module Project</span>
<span class="k">class</span> <span class="nc">DeFiDashboard</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">web3</span> <span class="o">=</span> <span class="n">MultiChainWeb3</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">DeFiDataAggregator</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tracked_protocols</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chains</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;ethereum&#39;</span><span class="p">]):</span>
        <span class="c1"># TODO: Connect to chains</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">track_protocol</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">slug</span><span class="p">):</span>
        <span class="c1"># TODO: Add protocol to watchlist</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">get_dashboard_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># TODO: Return complete dashboard data</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">display</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># TODO: Print formatted dashboard</span>
        <span class="k">pass</span>
</code></pre><div class="code-output" id="output-cell-12-11"></div></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">DeFiDashboard</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">web3</span> <span class="o">=</span> <span class="n">MultiChainWeb3</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">DeFiDataAggregator</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tracked_protocols</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chains</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;ethereum&#39;</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">chain</span> <span class="ow">in</span> <span class="n">chains</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">web3</span><span class="o">.</span><span class="n">connect_chain</span><span class="p">(</span><span class="n">chain</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">web3</span><span class="o">.</span><span class="n">check_all_connections</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">track_protocol</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">slug</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tracked_protocols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">slug</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_dashboard_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;market_overview&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get_market_overview</span><span class="p">(),</span>
            <span class="s1">&#39;connections&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">web3</span><span class="o">.</span><span class="n">check_all_connections</span><span class="p">(),</span>
            <span class="s1">&#39;tracked&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">compare_protocols</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tracked_protocols</span><span class="p">),</span>
            <span class="s1">&#39;top_yields&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">find_yield_opportunities</span><span class="p">(</span><span class="n">min_tvl</span><span class="o">=</span><span class="mi">10_000_000</span><span class="p">,</span> <span class="n">min_apy</span><span class="o">=</span><span class="mi">10</span><span class="p">)[:</span><span class="mi">5</span><span class="p">]</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">display</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_dashboard_data</span><span class="p">()</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=&#39;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;           DEFI DASHBOARD&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=&#39;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>

        <span class="c1"># Market overview</span>
        <span class="n">overview</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;market_overview&#39;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Total DeFi TVL: $</span><span class="si">{</span><span class="n">overview</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;total_tvl&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="si">:</span><span class="s2">,.0f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Protocols: </span><span class="si">{</span><span class="n">overview</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;total_protocols&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Connections</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Chain Connections:&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">chain</span><span class="p">,</span> <span class="n">status</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;connections&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">icon</span> <span class="o">=</span> <span class="s1">&#39;âœ…&#39;</span> <span class="k">if</span> <span class="n">status</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;connected&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;âŒ&#39;</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">icon</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">chain</span><span class="si">}</span><span class="s2">: Block </span><span class="si">{</span><span class="n">status</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;block&#39;</span><span class="p">,</span> <span class="s1">&#39;N/A&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Top yields</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Top Yield Opportunities:&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;top_yields&#39;</span><span class="p">,</span> <span class="p">[])[:</span><span class="mi">5</span><span class="p">]:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">y</span><span class="p">[</span><span class="s1">&#39;project&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">y</span><span class="p">[</span><span class="s1">&#39;symbol&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">y</span><span class="p">[</span><span class="s1">&#39;apy&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">% APY ($</span><span class="si">{</span><span class="n">y</span><span class="p">[</span><span class="s1">&#39;tvl&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">,.0f</span><span class="si">}</span><span class="s2"> TVL)&quot;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=&#39;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>

<span class="c1"># Usage</span>
<span class="n">dashboard</span> <span class="o">=</span> <span class="n">DeFiDashboard</span><span class="p">()</span>
<span class="n">dashboard</span><span class="o">.</span><span class="n">initialize</span><span class="p">([</span><span class="s1">&#39;ethereum&#39;</span><span class="p">])</span>
<span class="n">dashboard</span><span class="o">.</span><span class="n">track_protocol</span><span class="p">(</span><span class="s1">&#39;uniswap&#39;</span><span class="p">)</span>
<span class="n">dashboard</span><span class="o">.</span><span class="n">track_protocol</span><span class="p">(</span><span class="s1">&#39;aave&#39;</span><span class="p">)</span>
<span class="c1"># dashboard.display()</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>ğŸ“ Key Takeaways</h1>
<ol>
<li><strong>DeFi Basics</strong>: DEXs, lending, yields - all without intermediaries</li>
<li><strong>Web3.py</strong>: Connect to Ethereum and read blockchain data</li>
<li><strong>AMMs</strong>: Constant product formula (x * y = k) determines prices</li>
<li><strong>Data Sources</strong>: DeFi Llama for TVL, yields, protocol data</li>
</ol>
<hr />
<p><em>Next: Module 13 - DEX Trading</em></p></div>
        <div class="nav-buttons">
            <button class="nav-btn prev-btn disabled" type="button">
                <span class="nav-btn-label">â† Previous</span>
                <span class="nav-btn-name"></span>
            </button>
            <button class="nav-btn next-btn disabled" type="button">
                <span class="nav-btn-label">Next â†’</span>
                <span class="nav-btn-name"></span>
            </button>
        </div>
        </div>
<div class="module-section" data-idx="13"><div class="md-cell module-header"><h1>Module 13: DEX Trading</h1>
<h2>Part 4: DeFi &amp; Advanced Topics</h2>
<hr />
<div class="table-wrapper"><table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>â±ï¸ <strong>Duration</strong></td>
<td>~2.5 hours</td>
</tr>
<tr>
<td>ğŸ“‹ <strong>Prerequisites</strong></td>
<td>Module 12</td>
</tr>
<tr>
<td>ğŸ’ª <strong>Exercises</strong></td>
<td>5 total</td>
</tr>
</tbody>
</table></div></div>
<div class="md-cell"><h2>ğŸ¯ Learning Objectives</h2>
<ul>
<li>Integrate with Uniswap for quotes and swaps</li>
<li>Execute DEX trades safely</li>
<li>Understand and protect against MEV</li>
<li>Use DEX aggregators for best execution</li>
</ul></div>
<div class="md-cell"><hr />
<h1>Section 1: Uniswap Integration</h1>
<h2>1.1 Getting Quotes</h2></div>
<div class="code-cell" id="cell-13-0" data-source="ZnJvbSB3ZWIzIGltcG9ydCBXZWIzCmltcG9ydCBqc29uCgojIFVuaXN3YXAgVjIgUm91dGVyIEFCSSAobWluaW1hbCBmb3IgcXVvdGVzKQpVTklTV0FQX1YyX1JPVVRFUl9BQkkgPSBbCiAgICB7CiAgICAgICAgImlucHV0cyI6IFt7Im5hbWUiOiAiYW1vdW50SW4iLCAidHlwZSI6ICJ1aW50MjU2In0sIHsibmFtZSI6ICJwYXRoIiwgInR5cGUiOiAiYWRkcmVzc1tdIn1dLAogICAgICAgICJuYW1lIjogImdldEFtb3VudHNPdXQiLAogICAgICAgICJvdXRwdXRzIjogW3sibmFtZSI6ICJhbW91bnRzIiwgInR5cGUiOiAidWludDI1NltdIn1dLAogICAgICAgICJzdGF0ZU11dGFiaWxpdHkiOiAidmlldyIsCiAgICAgICAgInR5cGUiOiAiZnVuY3Rpb24iCiAgICB9LAogICAgewogICAgICAgICJpbnB1dHMiOiBbeyJuYW1lIjogImFtb3VudE91dCIsICJ0eXBlIjogInVpbnQyNTYifSwgeyJuYW1lIjogInBhdGgiLCAidHlwZSI6ICJhZGRyZXNzW10ifV0sCiAgICAgICAgIm5hbWUiOiAiZ2V0QW1vdW50c0luIiwKICAgICAgICAib3V0cHV0cyI6IFt7Im5hbWUiOiAiYW1vdW50cyIsICJ0eXBlIjogInVpbnQyNTZbXSJ9XSwKICAgICAgICAic3RhdGVNdXRhYmlsaXR5IjogInZpZXciLAogICAgICAgICJ0eXBlIjogImZ1bmN0aW9uIgogICAgfQpdCgpjbGFzcyBVbmlzd2FwUXVvdGVyOgogICAgIiIiR2V0IHF1b3RlcyBmcm9tIFVuaXN3YXAgVjIuIiIiCiAgICAKICAgIFJPVVRFUl9BRERSRVNTID0gJzB4N2EyNTBkNTYzMEI0Y0Y1Mzk3MzlkRjJDNWRBY2I0YzY1OUYyNDg4RCcKICAgIAogICAgIyBDb21tb24gdG9rZW4gYWRkcmVzc2VzIChFdGhlcmV1bSBtYWlubmV0KQogICAgVE9LRU5TID0gewogICAgICAgICdXRVRIJzogJzB4QzAyYWFBMzliMjIzRkU4RDBBMGU1QzRGMjdlQUQ5MDgzQzc1NkNjMicsCiAgICAgICAgJ1VTREMnOiAnMHhBMGI4Njk5MWM2MjE4YjM2YzFkMTlENGEyZTlFYjBjRTM2MDZlQjQ4JywKICAgICAgICAnVVNEVCc6ICcweGRBQzE3Rjk1OEQyZWU1MjNhMjIwNjIwNjk5NDU5N0MxM0Q4MzFlYzcnLAogICAgICAgICdEQUknOiAnMHg2QjE3NTQ3NEU4OTA5NEM0NERhOThiOTU0RWVzY2RlQ0I1QkUzMzg2JywKICAgICAgICAnV0JUQyc6ICcweDIyNjBGQUM1RTU1NDJhNzczQWE0NGZCQ2ZlRGY3QzE5M2JjMkM1OTknCiAgICB9CiAgICAKICAgIGRlZiBfX2luaXRfXyhzZWxmLCB3Myk6CiAgICAgICAgc2VsZi53MyA9IHczCiAgICAgICAgc2VsZi5yb3V0ZXIgPSB3My5ldGguY29udHJhY3QoCiAgICAgICAgICAgIGFkZHJlc3M9V2ViMy50b19jaGVja3N1bV9hZGRyZXNzKHNlbGYuUk9VVEVSX0FERFJFU1MpLAogICAgICAgICAgICBhYmk9VU5JU1dBUF9WMl9ST1VURVJfQUJJCiAgICAgICAgKQogICAgCiAgICBkZWYgZ2V0X3F1b3RlKHNlbGYsIHRva2VuX2luLCB0b2tlbl9vdXQsIGFtb3VudF9pbiwgZGVjaW1hbHNfaW49MTgpOgogICAgICAgICIiIgogICAgICAgIEdldCBxdW90ZSBmb3Igc3dhcC4KICAgICAgICAKICAgICAgICBSZXR1cm5zIGFtb3VudCBvdXQgZm9yIGdpdmVuIGFtb3VudCBpbi4KICAgICAgICAiIiIKICAgICAgICAjIENvbnZlcnQgdG8gV2VpCiAgICAgICAgYW1vdW50X2luX3dlaSA9IGludChhbW91bnRfaW4gKiAoMTAgKiogZGVjaW1hbHNfaW4pKQogICAgICAgIAogICAgICAgICMgQnVpbGQgcGF0aCAodGhyb3VnaCBXRVRIIGlmIG5lZWRlZCkKICAgICAgICBpZiB0b2tlbl9pbiA9PSBzZWxmLlRPS0VOU1snV0VUSCddIG9yIHRva2VuX291dCA9PSBzZWxmLlRPS0VOU1snV0VUSCddOgogICAgICAgICAgICBwYXRoID0gW3Rva2VuX2luLCB0b2tlbl9vdXRdCiAgICAgICAgZWxzZToKICAgICAgICAgICAgcGF0aCA9IFt0b2tlbl9pbiwgc2VsZi5UT0tFTlNbJ1dFVEgnXSwgdG9rZW5fb3V0XQogICAgICAgIAogICAgICAgIHBhdGggPSBbV2ViMy50b19jaGVja3N1bV9hZGRyZXNzKHApIGZvciBwIGluIHBhdGhdCiAgICAgICAgCiAgICAgICAgdHJ5OgogICAgICAgICAgICBhbW91bnRzID0gc2VsZi5yb3V0ZXIuZnVuY3Rpb25zLmdldEFtb3VudHNPdXQoYW1vdW50X2luX3dlaSwgcGF0aCkuY2FsbCgpCiAgICAgICAgICAgIHJldHVybiBhbW91bnRzWy0xXQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgcmV0dXJuIHsnZXJyb3InOiBzdHIoZSl9CiAgICAKICAgIGRlZiBnZXRfcHJpY2VfaW1wYWN0KHNlbGYsIHRva2VuX2luLCB0b2tlbl9vdXQsIGFtb3VudF9pbiwgZGVjaW1hbHNfaW49MTgsIGRlY2ltYWxzX291dD0xOCk6CiAgICAgICAgIiIiQ2FsY3VsYXRlIHByaWNlIGltcGFjdCBmb3IgYSB0cmFkZS4iIiIKICAgICAgICAjIEdldCBxdW90ZSBmb3Igc21hbGwgYW1vdW50IChiYXNlbGluZSBwcmljZSkKICAgICAgICBzbWFsbF9xdW90ZSA9IHNlbGYuZ2V0X3F1b3RlKHRva2VuX2luLCB0b2tlbl9vdXQsIDAuMDAxLCBkZWNpbWFsc19pbikKICAgICAgICAKICAgICAgICAjIEdldCBxdW90ZSBmb3IgYWN0dWFsIGFtb3VudAogICAgICAgIGFjdHVhbF9xdW90ZSA9IHNlbGYuZ2V0X3F1b3RlKHRva2VuX2luLCB0b2tlbl9vdXQsIGFtb3VudF9pbiwgZGVjaW1hbHNfaW4pCiAgICAgICAgCiAgICAgICAgaWYgaXNpbnN0YW5jZShzbWFsbF9xdW90ZSwgZGljdCkgb3IgaXNpbnN0YW5jZShhY3R1YWxfcXVvdGUsIGRpY3QpOgogICAgICAgICAgICByZXR1cm4geydlcnJvcic6ICdDb3VsZCBub3QgZ2V0IHF1b3Rlcyd9CiAgICAgICAgCiAgICAgICAgIyBDYWxjdWxhdGUgZWZmZWN0aXZlIHByaWNlcwogICAgICAgIHNtYWxsX3ByaWNlID0gc21hbGxfcXVvdGUgLyAoMC4wMDEgKiAxMCAqKiBkZWNpbWFsc19pbikKICAgICAgICBhY3R1YWxfcHJpY2UgPSBhY3R1YWxfcXVvdGUgLyAoYW1vdW50X2luICogMTAgKiogZGVjaW1hbHNfaW4pCiAgICAgICAgCiAgICAgICAgaW1wYWN0ID0gKHNtYWxsX3ByaWNlIC0gYWN0dWFsX3ByaWNlKSAvIHNtYWxsX3ByaWNlICogMTAwCiAgICAgICAgcmV0dXJuIGltcGFjdA=="><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-13-0')" type="button">Run</button></div><pre><code><span class="kn">from</span> <span class="nn">web3</span> <span class="kn">import</span> <span class="n">Web3</span>
<span class="kn">import</span> <span class="nn">json</span>

<span class="c1"># Uniswap V2 Router ABI (minimal for quotes)</span>
<span class="n">UNISWAP_V2_ROUTER_ABI</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="s2">&quot;inputs&quot;</span><span class="p">:</span> <span class="p">[{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;amountIn&quot;</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;uint256&quot;</span><span class="p">},</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;path&quot;</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;address[]&quot;</span><span class="p">}],</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;getAmountsOut&quot;</span><span class="p">,</span>
        <span class="s2">&quot;outputs&quot;</span><span class="p">:</span> <span class="p">[{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;amounts&quot;</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;uint256[]&quot;</span><span class="p">}],</span>
        <span class="s2">&quot;stateMutability&quot;</span><span class="p">:</span> <span class="s2">&quot;view&quot;</span><span class="p">,</span>
        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;function&quot;</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="s2">&quot;inputs&quot;</span><span class="p">:</span> <span class="p">[{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;amountOut&quot;</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;uint256&quot;</span><span class="p">},</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;path&quot;</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;address[]&quot;</span><span class="p">}],</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;getAmountsIn&quot;</span><span class="p">,</span>
        <span class="s2">&quot;outputs&quot;</span><span class="p">:</span> <span class="p">[{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;amounts&quot;</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;uint256[]&quot;</span><span class="p">}],</span>
        <span class="s2">&quot;stateMutability&quot;</span><span class="p">:</span> <span class="s2">&quot;view&quot;</span><span class="p">,</span>
        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;function&quot;</span>
    <span class="p">}</span>
<span class="p">]</span>

<span class="k">class</span> <span class="nc">UniswapQuoter</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Get quotes from Uniswap V2.&quot;&quot;&quot;</span>
    
    <span class="n">ROUTER_ADDRESS</span> <span class="o">=</span> <span class="s1">&#39;0x7a250d5630B4cF539739dF2C5dAcb4c659F2488D&#39;</span>
    
    <span class="c1"># Common token addresses (Ethereum mainnet)</span>
    <span class="n">TOKENS</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;WETH&#39;</span><span class="p">:</span> <span class="s1">&#39;0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2&#39;</span><span class="p">,</span>
        <span class="s1">&#39;USDC&#39;</span><span class="p">:</span> <span class="s1">&#39;0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48&#39;</span><span class="p">,</span>
        <span class="s1">&#39;USDT&#39;</span><span class="p">:</span> <span class="s1">&#39;0xdAC17F958D2ee523a2206206994597C13D831ec7&#39;</span><span class="p">,</span>
        <span class="s1">&#39;DAI&#39;</span><span class="p">:</span> <span class="s1">&#39;0x6B175474E89094C44Da98b954EescdeCB5BE3386&#39;</span><span class="p">,</span>
        <span class="s1">&#39;WBTC&#39;</span><span class="p">:</span> <span class="s1">&#39;0x2260FAC5E5542a773Aa44fBCfeDf7C193bc2C599&#39;</span>
    <span class="p">}</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">w3</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w3</span> <span class="o">=</span> <span class="n">w3</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">router</span> <span class="o">=</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">contract</span><span class="p">(</span>
            <span class="n">address</span><span class="o">=</span><span class="n">Web3</span><span class="o">.</span><span class="n">to_checksum_address</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ROUTER_ADDRESS</span><span class="p">),</span>
            <span class="n">abi</span><span class="o">=</span><span class="n">UNISWAP_V2_ROUTER_ABI</span>
        <span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">get_quote</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token_in</span><span class="p">,</span> <span class="n">token_out</span><span class="p">,</span> <span class="n">amount_in</span><span class="p">,</span> <span class="n">decimals_in</span><span class="o">=</span><span class="mi">18</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get quote for swap.</span>
<span class="sd">        </span>
<span class="sd">        Returns amount out for given amount in.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Convert to Wei</span>
        <span class="n">amount_in_wei</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">amount_in</span> <span class="o">*</span> <span class="p">(</span><span class="mi">10</span> <span class="o">**</span> <span class="n">decimals_in</span><span class="p">))</span>
        
        <span class="c1"># Build path (through WETH if needed)</span>
        <span class="k">if</span> <span class="n">token_in</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">TOKENS</span><span class="p">[</span><span class="s1">&#39;WETH&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">token_out</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">TOKENS</span><span class="p">[</span><span class="s1">&#39;WETH&#39;</span><span class="p">]:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="p">[</span><span class="n">token_in</span><span class="p">,</span> <span class="n">token_out</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="p">[</span><span class="n">token_in</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">TOKENS</span><span class="p">[</span><span class="s1">&#39;WETH&#39;</span><span class="p">],</span> <span class="n">token_out</span><span class="p">]</span>
        
        <span class="n">path</span> <span class="o">=</span> <span class="p">[</span><span class="n">Web3</span><span class="o">.</span><span class="n">to_checksum_address</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">path</span><span class="p">]</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="n">amounts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">router</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">getAmountsOut</span><span class="p">(</span><span class="n">amount_in_wei</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">call</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">amounts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>
    
    <span class="k">def</span> <span class="nf">get_price_impact</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token_in</span><span class="p">,</span> <span class="n">token_out</span><span class="p">,</span> <span class="n">amount_in</span><span class="p">,</span> <span class="n">decimals_in</span><span class="o">=</span><span class="mi">18</span><span class="p">,</span> <span class="n">decimals_out</span><span class="o">=</span><span class="mi">18</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculate price impact for a trade.&quot;&quot;&quot;</span>
        <span class="c1"># Get quote for small amount (baseline price)</span>
        <span class="n">small_quote</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_quote</span><span class="p">(</span><span class="n">token_in</span><span class="p">,</span> <span class="n">token_out</span><span class="p">,</span> <span class="mf">0.001</span><span class="p">,</span> <span class="n">decimals_in</span><span class="p">)</span>
        
        <span class="c1"># Get quote for actual amount</span>
        <span class="n">actual_quote</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_quote</span><span class="p">(</span><span class="n">token_in</span><span class="p">,</span> <span class="n">token_out</span><span class="p">,</span> <span class="n">amount_in</span><span class="p">,</span> <span class="n">decimals_in</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">small_quote</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">actual_quote</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Could not get quotes&#39;</span><span class="p">}</span>
        
        <span class="c1"># Calculate effective prices</span>
        <span class="n">small_price</span> <span class="o">=</span> <span class="n">small_quote</span> <span class="o">/</span> <span class="p">(</span><span class="mf">0.001</span> <span class="o">*</span> <span class="mi">10</span> <span class="o">**</span> <span class="n">decimals_in</span><span class="p">)</span>
        <span class="n">actual_price</span> <span class="o">=</span> <span class="n">actual_quote</span> <span class="o">/</span> <span class="p">(</span><span class="n">amount_in</span> <span class="o">*</span> <span class="mi">10</span> <span class="o">**</span> <span class="n">decimals_in</span><span class="p">)</span>
        
        <span class="n">impact</span> <span class="o">=</span> <span class="p">(</span><span class="n">small_price</span> <span class="o">-</span> <span class="n">actual_price</span><span class="p">)</span> <span class="o">/</span> <span class="n">small_price</span> <span class="o">*</span> <span class="mi">100</span>
        <span class="k">return</span> <span class="n">impact</span>
</code></pre><div class="code-output" id="output-cell-13-0"></div></div>
<div class="md-cell"><h3>âœï¸ Exercise 13.1: Multi-DEX Quoter</h3>
<p>Build a quoter that checks multiple DEXs.</p></div>
<div class="code-cell" id="cell-13-1" data-source="IyBFeGVyY2lzZSAxMy4xCmNsYXNzIE11bHRpREVYUXVvdGVyOgogICAgZGVmIF9faW5pdF9fKHNlbGYsIHczKToKICAgICAgICBzZWxmLnczID0gdzMKICAgICAgICBzZWxmLmRleGVzID0ge30KICAgIAogICAgZGVmIGFkZF9kZXgoc2VsZiwgbmFtZSwgcm91dGVyX2FkZHJlc3MsIGFiaSk6CiAgICAgICAgIyBUT0RPOiBBZGQgREVYIHRvIHF1b3RlcgogICAgICAgIHBhc3MKICAgIAogICAgZGVmIGdldF9iZXN0X3F1b3RlKHNlbGYsIHRva2VuX2luLCB0b2tlbl9vdXQsIGFtb3VudF9pbik6CiAgICAgICAgIyBUT0RPOiBHZXQgcXVvdGVzIGZyb20gYWxsIERFWHMgYW5kIHJldHVybiBiZXN0CiAgICAgICAgcGFzcwogICAgCiAgICBkZWYgY29tcGFyZV9xdW90ZXMoc2VsZiwgdG9rZW5faW4sIHRva2VuX291dCwgYW1vdW50X2luKToKICAgICAgICAjIFRPRE86IFJldHVybiBjb21wYXJpc29uIG9mIGFsbCBERVggcXVvdGVzCiAgICAgICAgcGFzcw=="><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-13-1')" type="button">Run</button></div><pre><code><span class="c1"># Exercise 13.1</span>
<span class="k">class</span> <span class="nc">MultiDEXQuoter</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">w3</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w3</span> <span class="o">=</span> <span class="n">w3</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dexes</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="k">def</span> <span class="nf">add_dex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">router_address</span><span class="p">,</span> <span class="n">abi</span><span class="p">):</span>
        <span class="c1"># TODO: Add DEX to quoter</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">get_best_quote</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token_in</span><span class="p">,</span> <span class="n">token_out</span><span class="p">,</span> <span class="n">amount_in</span><span class="p">):</span>
        <span class="c1"># TODO: Get quotes from all DEXs and return best</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">compare_quotes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token_in</span><span class="p">,</span> <span class="n">token_out</span><span class="p">,</span> <span class="n">amount_in</span><span class="p">):</span>
        <span class="c1"># TODO: Return comparison of all DEX quotes</span>
        <span class="k">pass</span>
</code></pre><div class="code-output" id="output-cell-13-1"></div></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">MultiDEXQuoter</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">w3</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w3</span> <span class="o">=</span> <span class="n">w3</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dexes</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">add_dex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">router_address</span><span class="p">,</span> <span class="n">abi</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dexes</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;router&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">contract</span><span class="p">(</span>
                <span class="n">address</span><span class="o">=</span><span class="n">Web3</span><span class="o">.</span><span class="n">to_checksum_address</span><span class="p">(</span><span class="n">router_address</span><span class="p">),</span>
                <span class="n">abi</span><span class="o">=</span><span class="n">abi</span>
            <span class="p">),</span>
            <span class="s1">&#39;address&#39;</span><span class="p">:</span> <span class="n">router_address</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">get_quote_from_dex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dex_name</span><span class="p">,</span> <span class="n">token_in</span><span class="p">,</span> <span class="n">token_out</span><span class="p">,</span> <span class="n">amount_in_wei</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">router</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dexes</span><span class="p">[</span><span class="n">dex_name</span><span class="p">][</span><span class="s1">&#39;router&#39;</span><span class="p">]</span>
            <span class="n">amounts</span> <span class="o">=</span> <span class="n">router</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">getAmountsOut</span><span class="p">(</span><span class="n">amount_in_wei</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">call</span><span class="p">()</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;dex&#39;</span><span class="p">:</span> <span class="n">dex_name</span><span class="p">,</span> <span class="s1">&#39;amount_out&#39;</span><span class="p">:</span> <span class="n">amounts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;dex&#39;</span><span class="p">:</span> <span class="n">dex_name</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">get_best_quote</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token_in</span><span class="p">,</span> <span class="n">token_out</span><span class="p">,</span> <span class="n">amount_in</span><span class="p">,</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">18</span><span class="p">):</span>
        <span class="n">amount_in_wei</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">amount_in</span> <span class="o">*</span> <span class="p">(</span><span class="mi">10</span> <span class="o">**</span> <span class="n">decimals</span><span class="p">))</span>
        <span class="n">path</span> <span class="o">=</span> <span class="p">[</span><span class="n">Web3</span><span class="o">.</span><span class="n">to_checksum_address</span><span class="p">(</span><span class="n">token_in</span><span class="p">),</span> <span class="n">Web3</span><span class="o">.</span><span class="n">to_checksum_address</span><span class="p">(</span><span class="n">token_out</span><span class="p">)]</span>

        <span class="n">quotes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">dex_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dexes</span><span class="p">:</span>
            <span class="n">quote</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_quote_from_dex</span><span class="p">(</span><span class="n">dex_name</span><span class="p">,</span> <span class="n">token_in</span><span class="p">,</span> <span class="n">token_out</span><span class="p">,</span> <span class="n">amount_in_wei</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">quote</span><span class="p">[</span><span class="s1">&#39;success&#39;</span><span class="p">]:</span>
                <span class="n">quotes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">quote</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">quotes</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;No valid quotes&#39;</span><span class="p">}</span>

        <span class="n">best</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">quotes</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;amount_out&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">best</span>

    <span class="k">def</span> <span class="nf">compare_quotes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token_in</span><span class="p">,</span> <span class="n">token_out</span><span class="p">,</span> <span class="n">amount_in</span><span class="p">,</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">18</span><span class="p">):</span>
        <span class="n">amount_in_wei</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">amount_in</span> <span class="o">*</span> <span class="p">(</span><span class="mi">10</span> <span class="o">**</span> <span class="n">decimals</span><span class="p">))</span>
        <span class="n">path</span> <span class="o">=</span> <span class="p">[</span><span class="n">Web3</span><span class="o">.</span><span class="n">to_checksum_address</span><span class="p">(</span><span class="n">token_in</span><span class="p">),</span> <span class="n">Web3</span><span class="o">.</span><span class="n">to_checksum_address</span><span class="p">(</span><span class="n">token_out</span><span class="p">)]</span>

        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">dex_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dexes</span><span class="p">:</span>
            <span class="n">quote</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_quote_from_dex</span><span class="p">(</span><span class="n">dex_name</span><span class="p">,</span> <span class="n">token_in</span><span class="p">,</span> <span class="n">token_out</span><span class="p">,</span> <span class="n">amount_in_wei</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">quote</span><span class="p">)</span>

        <span class="c1"># Sort by amount out</span>
        <span class="n">valid</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span> <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;success&#39;</span><span class="p">]]</span>
        <span class="n">valid</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;amount_out&#39;</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;quotes&#39;</span><span class="p">:</span> <span class="n">valid</span><span class="p">,</span> <span class="s1">&#39;best&#39;</span><span class="p">:</span> <span class="n">valid</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">valid</span> <span class="k">else</span> <span class="kc">None</span><span class="p">}</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>Section 2: Executing DEX Trades</h1>
<h2>2.1 Transaction Building</h2></div>
<div class="code-cell" id="cell-13-2" data-source="Y2xhc3MgREVYVHJhZGVyOgogICAgIiIiRXhlY3V0ZSB0cmFkZXMgb24gVW5pc3dhcCBWMi4iIiIKICAgIAogICAgU1dBUF9BQkkgPSBbCiAgICAgICAgewogICAgICAgICAgICAiaW5wdXRzIjogWwogICAgICAgICAgICAgICAgeyJuYW1lIjogImFtb3VudEluIiwgInR5cGUiOiAidWludDI1NiJ9LAogICAgICAgICAgICAgICAgeyJuYW1lIjogImFtb3VudE91dE1pbiIsICJ0eXBlIjogInVpbnQyNTYifSwKICAgICAgICAgICAgICAgIHsibmFtZSI6ICJwYXRoIiwgInR5cGUiOiAiYWRkcmVzc1tdIn0sCiAgICAgICAgICAgICAgICB7Im5hbWUiOiAidG8iLCAidHlwZSI6ICJhZGRyZXNzIn0sCiAgICAgICAgICAgICAgICB7Im5hbWUiOiAiZGVhZGxpbmUiLCAidHlwZSI6ICJ1aW50MjU2In0KICAgICAgICAgICAgXSwKICAgICAgICAgICAgIm5hbWUiOiAic3dhcEV4YWN0VG9rZW5zRm9yVG9rZW5zIiwKICAgICAgICAgICAgIm91dHB1dHMiOiBbeyJuYW1lIjogImFtb3VudHMiLCAidHlwZSI6ICJ1aW50MjU2W10ifV0sCiAgICAgICAgICAgICJzdGF0ZU11dGFiaWxpdHkiOiAibm9ucGF5YWJsZSIsCiAgICAgICAgICAgICJ0eXBlIjogImZ1bmN0aW9uIgogICAgICAgIH0KICAgIF0KICAgIAogICAgZGVmIF9faW5pdF9fKHNlbGYsIHczLCByb3V0ZXJfYWRkcmVzcywgcHJpdmF0ZV9rZXk9Tm9uZSk6CiAgICAgICAgc2VsZi53MyA9IHczCiAgICAgICAgc2VsZi5yb3V0ZXIgPSB3My5ldGguY29udHJhY3QoCiAgICAgICAgICAgIGFkZHJlc3M9V2ViMy50b19jaGVja3N1bV9hZGRyZXNzKHJvdXRlcl9hZGRyZXNzKSwKICAgICAgICAgICAgYWJpPVVOSVNXQVBfVjJfUk9VVEVSX0FCSSArIHNlbGYuU1dBUF9BQkkKICAgICAgICApCiAgICAgICAgc2VsZi5wcml2YXRlX2tleSA9IHByaXZhdGVfa2V5CiAgICAgICAgc2VsZi53YWxsZXQgPSBOb25lCiAgICAgICAgaWYgcHJpdmF0ZV9rZXk6CiAgICAgICAgICAgIHNlbGYud2FsbGV0ID0gdzMuZXRoLmFjY291bnQuZnJvbV9rZXkocHJpdmF0ZV9rZXkpLmFkZHJlc3MKICAgIAogICAgZGVmIGJ1aWxkX3N3YXBfdHgoc2VsZiwgdG9rZW5faW4sIHRva2VuX291dCwgYW1vdW50X2luLCBzbGlwcGFnZT0wLjUsIGRlYWRsaW5lX21pbnV0ZXM9MjApOgogICAgICAgICIiIgogICAgICAgIEJ1aWxkIHN3YXAgdHJhbnNhY3Rpb24gKGRvZXMgbm90IGV4ZWN1dGUpLgogICAgICAgIAogICAgICAgIHNsaXBwYWdlOiBNYXhpbXVtIGFjY2VwdGFibGUgc2xpcHBhZ2UgaW4gcGVyY2VudAogICAgICAgICIiIgogICAgICAgIGltcG9ydCB0aW1lCiAgICAgICAgCiAgICAgICAgIyBHZXQgcXVvdGUKICAgICAgICBwYXRoID0gW1dlYjMudG9fY2hlY2tzdW1fYWRkcmVzcyh0b2tlbl9pbiksIFdlYjMudG9fY2hlY2tzdW1fYWRkcmVzcyh0b2tlbl9vdXQpXQogICAgICAgIGFtb3VudHMgPSBzZWxmLnJvdXRlci5mdW5jdGlvbnMuZ2V0QW1vdW50c091dChhbW91bnRfaW4sIHBhdGgpLmNhbGwoKQogICAgICAgIGFtb3VudF9vdXQgPSBhbW91bnRzWy0xXQogICAgICAgIAogICAgICAgICMgQ2FsY3VsYXRlIG1pbmltdW0gb3V0IHdpdGggc2xpcHBhZ2UKICAgICAgICBhbW91bnRfb3V0X21pbiA9IGludChhbW91bnRfb3V0ICogKDEgLSBzbGlwcGFnZSAvIDEwMCkpCiAgICAgICAgCiAgICAgICAgIyBEZWFkbGluZQogICAgICAgIGRlYWRsaW5lID0gaW50KHRpbWUudGltZSgpKSArIChkZWFkbGluZV9taW51dGVzICogNjApCiAgICAgICAgCiAgICAgICAgIyBCdWlsZCB0cmFuc2FjdGlvbgogICAgICAgIHR4ID0gc2VsZi5yb3V0ZXIuZnVuY3Rpb25zLnN3YXBFeGFjdFRva2Vuc0ZvclRva2VucygKICAgICAgICAgICAgYW1vdW50X2luLAogICAgICAgICAgICBhbW91bnRfb3V0X21pbiwKICAgICAgICAgICAgcGF0aCwKICAgICAgICAgICAgc2VsZi53YWxsZXQsCiAgICAgICAgICAgIGRlYWRsaW5lCiAgICAgICAgKQogICAgICAgIAogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICd0eCc6IHR4LAogICAgICAgICAgICAnYW1vdW50X2luJzogYW1vdW50X2luLAogICAgICAgICAgICAnZXhwZWN0ZWRfb3V0JzogYW1vdW50X291dCwKICAgICAgICAgICAgJ21pbl9vdXQnOiBhbW91bnRfb3V0X21pbiwKICAgICAgICAgICAgJ3NsaXBwYWdlJzogc2xpcHBhZ2UsCiAgICAgICAgICAgICdkZWFkbGluZSc6IGRlYWRsaW5lCiAgICAgICAgfQogICAgCiAgICBkZWYgZXN0aW1hdGVfZ2FzKHNlbGYsIHR4X2RhdGEpOgogICAgICAgICIiIkVzdGltYXRlIGdhcyBmb3IgdHJhbnNhY3Rpb24uIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICBnYXMgPSB0eF9kYXRhWyd0eCddLmVzdGltYXRlX2dhcyh7J2Zyb20nOiBzZWxmLndhbGxldH0pCiAgICAgICAgICAgIGdhc19wcmljZSA9IHNlbGYudzMuZXRoLmdhc19wcmljZQogICAgICAgICAgICBjb3N0X3dlaSA9IGdhcyAqIGdhc19wcmljZQogICAgICAgICAgICBjb3N0X2V0aCA9IHNlbGYudzMuZnJvbV93ZWkoY29zdF93ZWksICdldGhlcicpCiAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICAnZ2FzX3VuaXRzJzogZ2FzLAogICAgICAgICAgICAgICAgJ2dhc19wcmljZV9nd2VpJzogc2VsZi53My5mcm9tX3dlaShnYXNfcHJpY2UsICdnd2VpJyksCiAgICAgICAgICAgICAgICAnY29zdF9ldGgnOiBmbG9hdChjb3N0X2V0aCkKICAgICAgICAgICAgfQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgcmV0dXJuIHsnZXJyb3InOiBzdHIoZSl9"><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-13-2')" type="button">Run</button></div><pre><code><span class="k">class</span> <span class="nc">DEXTrader</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Execute trades on Uniswap V2.&quot;&quot;&quot;</span>
    
    <span class="n">SWAP_ABI</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="s2">&quot;inputs&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;amountIn&quot;</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;uint256&quot;</span><span class="p">},</span>
                <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;amountOutMin&quot;</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;uint256&quot;</span><span class="p">},</span>
                <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;path&quot;</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;address[]&quot;</span><span class="p">},</span>
                <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;to&quot;</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;address&quot;</span><span class="p">},</span>
                <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;deadline&quot;</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;uint256&quot;</span><span class="p">}</span>
            <span class="p">],</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;swapExactTokensForTokens&quot;</span><span class="p">,</span>
            <span class="s2">&quot;outputs&quot;</span><span class="p">:</span> <span class="p">[{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;amounts&quot;</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;uint256[]&quot;</span><span class="p">}],</span>
            <span class="s2">&quot;stateMutability&quot;</span><span class="p">:</span> <span class="s2">&quot;nonpayable&quot;</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;function&quot;</span>
        <span class="p">}</span>
    <span class="p">]</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">w3</span><span class="p">,</span> <span class="n">router_address</span><span class="p">,</span> <span class="n">private_key</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w3</span> <span class="o">=</span> <span class="n">w3</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">router</span> <span class="o">=</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">contract</span><span class="p">(</span>
            <span class="n">address</span><span class="o">=</span><span class="n">Web3</span><span class="o">.</span><span class="n">to_checksum_address</span><span class="p">(</span><span class="n">router_address</span><span class="p">),</span>
            <span class="n">abi</span><span class="o">=</span><span class="n">UNISWAP_V2_ROUTER_ABI</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">SWAP_ABI</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">private_key</span> <span class="o">=</span> <span class="n">private_key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wallet</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">private_key</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wallet</span> <span class="o">=</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">account</span><span class="o">.</span><span class="n">from_key</span><span class="p">(</span><span class="n">private_key</span><span class="p">)</span><span class="o">.</span><span class="n">address</span>
    
    <span class="k">def</span> <span class="nf">build_swap_tx</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token_in</span><span class="p">,</span> <span class="n">token_out</span><span class="p">,</span> <span class="n">amount_in</span><span class="p">,</span> <span class="n">slippage</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">deadline_minutes</span><span class="o">=</span><span class="mi">20</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Build swap transaction (does not execute).</span>
<span class="sd">        </span>
<span class="sd">        slippage: Maximum acceptable slippage in percent</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">time</span>
        
        <span class="c1"># Get quote</span>
        <span class="n">path</span> <span class="o">=</span> <span class="p">[</span><span class="n">Web3</span><span class="o">.</span><span class="n">to_checksum_address</span><span class="p">(</span><span class="n">token_in</span><span class="p">),</span> <span class="n">Web3</span><span class="o">.</span><span class="n">to_checksum_address</span><span class="p">(</span><span class="n">token_out</span><span class="p">)]</span>
        <span class="n">amounts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">router</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">getAmountsOut</span><span class="p">(</span><span class="n">amount_in</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">call</span><span class="p">()</span>
        <span class="n">amount_out</span> <span class="o">=</span> <span class="n">amounts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        
        <span class="c1"># Calculate minimum out with slippage</span>
        <span class="n">amount_out_min</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">amount_out</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">slippage</span> <span class="o">/</span> <span class="mi">100</span><span class="p">))</span>
        
        <span class="c1"># Deadline</span>
        <span class="n">deadline</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span> <span class="o">+</span> <span class="p">(</span><span class="n">deadline_minutes</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
        
        <span class="c1"># Build transaction</span>
        <span class="n">tx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">router</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">swapExactTokensForTokens</span><span class="p">(</span>
            <span class="n">amount_in</span><span class="p">,</span>
            <span class="n">amount_out_min</span><span class="p">,</span>
            <span class="n">path</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wallet</span><span class="p">,</span>
            <span class="n">deadline</span>
        <span class="p">)</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;tx&#39;</span><span class="p">:</span> <span class="n">tx</span><span class="p">,</span>
            <span class="s1">&#39;amount_in&#39;</span><span class="p">:</span> <span class="n">amount_in</span><span class="p">,</span>
            <span class="s1">&#39;expected_out&#39;</span><span class="p">:</span> <span class="n">amount_out</span><span class="p">,</span>
            <span class="s1">&#39;min_out&#39;</span><span class="p">:</span> <span class="n">amount_out_min</span><span class="p">,</span>
            <span class="s1">&#39;slippage&#39;</span><span class="p">:</span> <span class="n">slippage</span><span class="p">,</span>
            <span class="s1">&#39;deadline&#39;</span><span class="p">:</span> <span class="n">deadline</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">estimate_gas</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tx_data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Estimate gas for transaction.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">gas</span> <span class="o">=</span> <span class="n">tx_data</span><span class="p">[</span><span class="s1">&#39;tx&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">estimate_gas</span><span class="p">({</span><span class="s1">&#39;from&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">wallet</span><span class="p">})</span>
            <span class="n">gas_price</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">gas_price</span>
            <span class="n">cost_wei</span> <span class="o">=</span> <span class="n">gas</span> <span class="o">*</span> <span class="n">gas_price</span>
            <span class="n">cost_eth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">w3</span><span class="o">.</span><span class="n">from_wei</span><span class="p">(</span><span class="n">cost_wei</span><span class="p">,</span> <span class="s1">&#39;ether&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s1">&#39;gas_units&#39;</span><span class="p">:</span> <span class="n">gas</span><span class="p">,</span>
                <span class="s1">&#39;gas_price_gwei&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">w3</span><span class="o">.</span><span class="n">from_wei</span><span class="p">(</span><span class="n">gas_price</span><span class="p">,</span> <span class="s1">&#39;gwei&#39;</span><span class="p">),</span>
                <span class="s1">&#39;cost_eth&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">cost_eth</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>
</code></pre><div class="code-output" id="output-cell-13-2"></div></div>
<div class="md-cell"><h2>2.2 Slippage Protection</h2></div>
<div class="code-cell" id="cell-13-3" data-source="Y2xhc3MgU2xpcHBhZ2VQcm90ZWN0aW9uOgogICAgIiIiQ2FsY3VsYXRlIGFuZCBtYW5hZ2Ugc2xpcHBhZ2Ugc2V0dGluZ3MuIiIiCiAgICAKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBkZWZhdWx0X3NsaXBwYWdlPTAuNSk6CiAgICAgICAgc2VsZi5kZWZhdWx0X3NsaXBwYWdlID0gZGVmYXVsdF9zbGlwcGFnZQogICAgCiAgICBkZWYgY2FsY3VsYXRlX21pbl9vdXRwdXQoc2VsZiwgZXhwZWN0ZWRfb3V0cHV0LCBzbGlwcGFnZV9wY3QpOgogICAgICAgICIiIkNhbGN1bGF0ZSBtaW5pbXVtIGFjY2VwdGFibGUgb3V0cHV0LiIiIgogICAgICAgIHJldHVybiBpbnQoZXhwZWN0ZWRfb3V0cHV0ICogKDEgLSBzbGlwcGFnZV9wY3QgLyAxMDApKQogICAgCiAgICBkZWYgcmVjb21tZW5kX3NsaXBwYWdlKHNlbGYsIHRva2VuX3BhaXIsIHRyYWRlX3NpemVfdXNkLCBsaXF1aWRpdHlfdXNkKToKICAgICAgICAiIiIKICAgICAgICBSZWNvbW1lbmQgc2xpcHBhZ2UgYmFzZWQgb24gdHJhZGUgc2l6ZSB2cyBsaXF1aWRpdHkuCiAgICAgICAgIiIiCiAgICAgICAgdHJhZGVfcmF0aW8gPSB0cmFkZV9zaXplX3VzZCAvIGxpcXVpZGl0eV91c2QKICAgICAgICAKICAgICAgICBpZiB0cmFkZV9yYXRpbyA8IDAuMDAxOiAgIyA8IDAuMSUgb2YgbGlxdWlkaXR5CiAgICAgICAgICAgIHJldHVybiAwLjEKICAgICAgICBlbGlmIHRyYWRlX3JhdGlvIDwgMC4wMTogICMgPCAxJSBvZiBsaXF1aWRpdHkKICAgICAgICAgICAgcmV0dXJuIDAuNQogICAgICAgIGVsaWYgdHJhZGVfcmF0aW8gPCAwLjA1OiAgIyA8IDUlIG9mIGxpcXVpZGl0eQogICAgICAgICAgICByZXR1cm4gMS4wCiAgICAgICAgZWxpZiB0cmFkZV9yYXRpbyA8IDAuMTogICAjIDwgMTAlIG9mIGxpcXVpZGl0eQogICAgICAgICAgICByZXR1cm4gMi4wCiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmV0dXJuIDUuMCAgIyBMYXJnZSB0cmFkZSwgaGlnaCBzbGlwcGFnZSBuZWVkZWQKICAgIAogICAgZGVmIGlzX3NsaXBwYWdlX2FjY2VwdGFibGUoc2VsZiwgZXhwZWN0ZWQsIGFjdHVhbCwgbWF4X3NsaXBwYWdlX3BjdCk6CiAgICAgICAgIiIiQ2hlY2sgaWYgYWN0dWFsIHNsaXBwYWdlIGlzIHdpdGhpbiBhY2NlcHRhYmxlIHJhbmdlLiIiIgogICAgICAgIGFjdHVhbF9zbGlwcGFnZSA9IChleHBlY3RlZCAtIGFjdHVhbCkgLyBleHBlY3RlZCAqIDEwMAogICAgICAgIHJldHVybiBhY3R1YWxfc2xpcHBhZ2UgPD0gbWF4X3NsaXBwYWdlX3BjdAoKc2xpcCA9IFNsaXBwYWdlUHJvdGVjdGlvbigpCnByaW50KGYnTWluIG91dHB1dCBmb3IgMTAwMCB3aXRoIDAuNSUgc2xpcHBhZ2U6IHtzbGlwLmNhbGN1bGF0ZV9taW5fb3V0cHV0KDEwMDAsIDAuNSl9JykKcHJpbnQoZidSZWNvbW1lbmRlZCBzbGlwcGFnZSBmb3IgJDEwayB0cmFkZSBpbiAkMU0gcG9vbDoge3NsaXAucmVjb21tZW5kX3NsaXBwYWdlKCJFVEgvVVNEQyIsIDEwMDAwLCAxMDAwMDAwKX0lJyk="><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-13-3')" type="button">Run</button></div><pre><code><span class="k">class</span> <span class="nc">SlippageProtection</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Calculate and manage slippage settings.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">default_slippage</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default_slippage</span> <span class="o">=</span> <span class="n">default_slippage</span>
    
    <span class="k">def</span> <span class="nf">calculate_min_output</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expected_output</span><span class="p">,</span> <span class="n">slippage_pct</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculate minimum acceptable output.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">expected_output</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">slippage_pct</span> <span class="o">/</span> <span class="mi">100</span><span class="p">))</span>
    
    <span class="k">def</span> <span class="nf">recommend_slippage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token_pair</span><span class="p">,</span> <span class="n">trade_size_usd</span><span class="p">,</span> <span class="n">liquidity_usd</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Recommend slippage based on trade size vs liquidity.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">trade_ratio</span> <span class="o">=</span> <span class="n">trade_size_usd</span> <span class="o">/</span> <span class="n">liquidity_usd</span>
        
        <span class="k">if</span> <span class="n">trade_ratio</span> <span class="o">&lt;</span> <span class="mf">0.001</span><span class="p">:</span>  <span class="c1"># &lt; 0.1% of liquidity</span>
            <span class="k">return</span> <span class="mf">0.1</span>
        <span class="k">elif</span> <span class="n">trade_ratio</span> <span class="o">&lt;</span> <span class="mf">0.01</span><span class="p">:</span>  <span class="c1"># &lt; 1% of liquidity</span>
            <span class="k">return</span> <span class="mf">0.5</span>
        <span class="k">elif</span> <span class="n">trade_ratio</span> <span class="o">&lt;</span> <span class="mf">0.05</span><span class="p">:</span>  <span class="c1"># &lt; 5% of liquidity</span>
            <span class="k">return</span> <span class="mf">1.0</span>
        <span class="k">elif</span> <span class="n">trade_ratio</span> <span class="o">&lt;</span> <span class="mf">0.1</span><span class="p">:</span>   <span class="c1"># &lt; 10% of liquidity</span>
            <span class="k">return</span> <span class="mf">2.0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">5.0</span>  <span class="c1"># Large trade, high slippage needed</span>
    
    <span class="k">def</span> <span class="nf">is_slippage_acceptable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expected</span><span class="p">,</span> <span class="n">actual</span><span class="p">,</span> <span class="n">max_slippage_pct</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check if actual slippage is within acceptable range.&quot;&quot;&quot;</span>
        <span class="n">actual_slippage</span> <span class="o">=</span> <span class="p">(</span><span class="n">expected</span> <span class="o">-</span> <span class="n">actual</span><span class="p">)</span> <span class="o">/</span> <span class="n">expected</span> <span class="o">*</span> <span class="mi">100</span>
        <span class="k">return</span> <span class="n">actual_slippage</span> <span class="o">&lt;=</span> <span class="n">max_slippage_pct</span>

<span class="n">slip</span> <span class="o">=</span> <span class="n">SlippageProtection</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Min output for 1000 with 0.5% slippage: </span><span class="si">{</span><span class="n">slip</span><span class="o">.</span><span class="n">calculate_min_output</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Recommended slippage for $10k trade in $1M pool: </span><span class="si">{</span><span class="n">slip</span><span class="o">.</span><span class="n">recommend_slippage</span><span class="p">(</span><span class="s2">&quot;ETH/USDC&quot;</span><span class="p">,</span> <span class="mi">10000</span><span class="p">,</span> <span class="mi">1000000</span><span class="p">)</span><span class="si">}</span><span class="s1">%&#39;</span><span class="p">)</span>
</code></pre><div class="code-output" id="output-cell-13-3"></div></div>
<div class="md-cell"><h3>âœï¸ Exercise 13.2: Safe DEX Executor</h3>
<p>Build a DEX executor with safety checks.</p></div>
<div class="code-cell" id="cell-13-4" data-source="IyBFeGVyY2lzZSAxMy4yCmNsYXNzIFNhZmVERVhFeGVjdXRvcjoKICAgIGRlZiBfX2luaXRfXyhzZWxmLCB3Mywgcm91dGVyX2FkZHJlc3MpOgogICAgICAgIHNlbGYudzMgPSB3MwogICAgICAgIHNlbGYucm91dGVyX2FkZHJlc3MgPSByb3V0ZXJfYWRkcmVzcwogICAgICAgIHNlbGYubWF4X3NsaXBwYWdlID0gMi4wCiAgICAgICAgc2VsZi5tYXhfZ2FzX2d3ZWkgPSAxMDAKICAgIAogICAgZGVmIHByZV90cmFkZV9jaGVja3Moc2VsZiwgdHJhZGVfcGFyYW1zKToKICAgICAgICAjIFRPRE86IFZhbGlkYXRlIHRyYWRlIHBhcmFtZXRlcnMKICAgICAgICBwYXNzCiAgICAKICAgIGRlZiBleGVjdXRlX3dpdGhfY2hlY2tzKHNlbGYsIHRva2VuX2luLCB0b2tlbl9vdXQsIGFtb3VudF9pbiwgc2xpcHBhZ2UpOgogICAgICAgICMgVE9ETzogRXhlY3V0ZSB0cmFkZSB3aXRoIGFsbCBzYWZldHkgY2hlY2tzCiAgICAgICAgcGFzcwogICAgCiAgICBkZWYgc2ltdWxhdGVfdHJhZGUoc2VsZiwgdG9rZW5faW4sIHRva2VuX291dCwgYW1vdW50X2luKToKICAgICAgICAjIFRPRE86IFNpbXVsYXRlIHdpdGhvdXQgZXhlY3V0aW5nCiAgICAgICAgcGFzcw=="><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-13-4')" type="button">Run</button></div><pre><code><span class="c1"># Exercise 13.2</span>
<span class="k">class</span> <span class="nc">SafeDEXExecutor</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">w3</span><span class="p">,</span> <span class="n">router_address</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w3</span> <span class="o">=</span> <span class="n">w3</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">router_address</span> <span class="o">=</span> <span class="n">router_address</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_slippage</span> <span class="o">=</span> <span class="mf">2.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_gas_gwei</span> <span class="o">=</span> <span class="mi">100</span>
    
    <span class="k">def</span> <span class="nf">pre_trade_checks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trade_params</span><span class="p">):</span>
        <span class="c1"># TODO: Validate trade parameters</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">execute_with_checks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token_in</span><span class="p">,</span> <span class="n">token_out</span><span class="p">,</span> <span class="n">amount_in</span><span class="p">,</span> <span class="n">slippage</span><span class="p">):</span>
        <span class="c1"># TODO: Execute trade with all safety checks</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">simulate_trade</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token_in</span><span class="p">,</span> <span class="n">token_out</span><span class="p">,</span> <span class="n">amount_in</span><span class="p">):</span>
        <span class="c1"># TODO: Simulate without executing</span>
        <span class="k">pass</span>
</code></pre><div class="code-output" id="output-cell-13-4"></div></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">SafeDEXExecutor</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">w3</span><span class="p">,</span> <span class="n">router_address</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w3</span> <span class="o">=</span> <span class="n">w3</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">router_address</span> <span class="o">=</span> <span class="n">router_address</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_slippage</span> <span class="o">=</span> <span class="mf">2.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_gas_gwei</span> <span class="o">=</span> <span class="mi">100</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slippage_calc</span> <span class="o">=</span> <span class="n">SlippageProtection</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">pre_trade_checks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trade_params</span><span class="p">):</span>
        <span class="n">checks</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;passed&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;issues&#39;</span><span class="p">:</span> <span class="p">[]}</span>

        <span class="c1"># Check slippage</span>
        <span class="k">if</span> <span class="n">trade_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;slippage&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_slippage</span><span class="p">:</span>
            <span class="n">checks</span><span class="p">[</span><span class="s1">&#39;issues&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Slippage </span><span class="si">{</span><span class="n">trade_params</span><span class="p">[</span><span class="s1">&#39;slippage&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">% exceeds max </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">max_slippage</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
            <span class="n">checks</span><span class="p">[</span><span class="s1">&#39;passed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Check gas price</span>
        <span class="n">current_gas</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">w3</span><span class="o">.</span><span class="n">from_wei</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">gas_price</span><span class="p">,</span> <span class="s1">&#39;gwei&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">current_gas</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_gas_gwei</span><span class="p">:</span>
            <span class="n">checks</span><span class="p">[</span><span class="s1">&#39;issues&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Gas </span><span class="si">{</span><span class="n">current_gas</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2"> gwei exceeds max </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">max_gas_gwei</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">checks</span><span class="p">[</span><span class="s1">&#39;passed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Check token addresses are valid</span>
        <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;token_in&#39;</span><span class="p">,</span> <span class="s1">&#39;token_out&#39;</span><span class="p">]:</span>
            <span class="n">addr</span> <span class="o">=</span> <span class="n">trade_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">addr</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">Web3</span><span class="o">.</span><span class="n">is_address</span><span class="p">(</span><span class="n">addr</span><span class="p">):</span>
                <span class="n">checks</span><span class="p">[</span><span class="s1">&#39;issues&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid </span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s2"> address&quot;</span><span class="p">)</span>
                <span class="n">checks</span><span class="p">[</span><span class="s1">&#39;passed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="n">checks</span>

    <span class="k">def</span> <span class="nf">simulate_trade</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token_in</span><span class="p">,</span> <span class="n">token_out</span><span class="p">,</span> <span class="n">amount_in</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Simulate trade without executing.&quot;&quot;&quot;</span>
        <span class="n">quoter</span> <span class="o">=</span> <span class="n">UniswapQuoter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">w3</span><span class="p">)</span>

        <span class="n">quote</span> <span class="o">=</span> <span class="n">quoter</span><span class="o">.</span><span class="n">get_quote</span><span class="p">(</span><span class="n">token_in</span><span class="p">,</span> <span class="n">token_out</span><span class="p">,</span> <span class="n">amount_in</span><span class="p">)</span>
        <span class="n">impact</span> <span class="o">=</span> <span class="n">quoter</span><span class="o">.</span><span class="n">get_price_impact</span><span class="p">(</span><span class="n">token_in</span><span class="p">,</span> <span class="n">token_out</span><span class="p">,</span> <span class="n">amount_in</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;amount_in&#39;</span><span class="p">:</span> <span class="n">amount_in</span><span class="p">,</span>
            <span class="s1">&#39;expected_out&#39;</span><span class="p">:</span> <span class="n">quote</span><span class="p">,</span>
            <span class="s1">&#39;price_impact&#39;</span><span class="p">:</span> <span class="n">impact</span><span class="p">,</span>
            <span class="s1">&#39;recommended_slippage&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">slippage_calc</span><span class="o">.</span><span class="n">recommend_slippage</span><span class="p">(</span><span class="s1">&#39;pair&#39;</span><span class="p">,</span> <span class="n">amount_in</span> <span class="o">*</span> <span class="mi">2000</span><span class="p">,</span> <span class="mi">10_000_000</span><span class="p">)</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">execute_with_checks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token_in</span><span class="p">,</span> <span class="n">token_out</span><span class="p">,</span> <span class="n">amount_in</span><span class="p">,</span> <span class="n">slippage</span><span class="p">):</span>
        <span class="c1"># Pre-checks</span>
        <span class="n">checks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre_trade_checks</span><span class="p">({</span>
            <span class="s1">&#39;token_in&#39;</span><span class="p">:</span> <span class="n">token_in</span><span class="p">,</span>
            <span class="s1">&#39;token_out&#39;</span><span class="p">:</span> <span class="n">token_out</span><span class="p">,</span>
            <span class="s1">&#39;slippage&#39;</span><span class="p">:</span> <span class="n">slippage</span>
        <span class="p">})</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">checks</span><span class="p">[</span><span class="s1">&#39;passed&#39;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Pre-checks failed&#39;</span><span class="p">,</span> <span class="s1">&#39;issues&#39;</span><span class="p">:</span> <span class="n">checks</span><span class="p">[</span><span class="s1">&#39;issues&#39;</span><span class="p">]}</span>

        <span class="c1"># Simulate first</span>
        <span class="n">sim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulate_trade</span><span class="p">(</span><span class="n">token_in</span><span class="p">,</span> <span class="n">token_out</span><span class="p">,</span> <span class="n">amount_in</span><span class="p">)</span>

        <span class="c1"># Check price impact</span>
        <span class="k">if</span> <span class="n">sim</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;price_impact&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">slippage</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Price impact </span><span class="si">{</span><span class="n">sim</span><span class="p">[</span><span class="s1">&#39;price_impact&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">% exceeds slippage </span><span class="si">{</span><span class="n">slippage</span><span class="si">}</span><span class="s2">%&quot;</span>
            <span class="p">}</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s1">&#39;simulation&#39;</span><span class="p">:</span> <span class="n">sim</span><span class="p">,</span>
            <span class="s1">&#39;note&#39;</span><span class="p">:</span> <span class="s1">&#39;Ready to execute (actual execution requires signed transaction)&#39;</span>
        <span class="p">}</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>Section 3: MEV Awareness</h1>
<h2>3.1 What is MEV?</h2></div>
<div class="code-cell" id="cell-13-5" data-source="IyBNRVYgKE1heGltYWwgRXh0cmFjdGFibGUgVmFsdWUpIHR5cGVzCm1ldl90eXBlcyA9IHsKICAgICdmcm9udHJ1bm5pbmcnOiB7CiAgICAgICAgJ2Rlc2NyaXB0aW9uJzogJ0JvdHMgc2VlIHlvdXIgcGVuZGluZyB0eCBhbmQgdHJhZGUgYmVmb3JlIHlvdScsCiAgICAgICAgJ2ltcGFjdCc6ICdZb3UgZ2V0IHdvcnNlIHByaWNlJywKICAgICAgICAnZXhhbXBsZSc6ICdZb3UgYnV5IEVUSCwgYm90IGJ1eXMgZmlyc3QsIHlvdSBwYXkgbW9yZScKICAgIH0sCiAgICAnc2FuZHdpY2gnOiB7CiAgICAgICAgJ2Rlc2NyaXB0aW9uJzogJ0JvdCBidXlzIGJlZm9yZSB5b3UgQU5EIHNlbGxzIGFmdGVyIHlvdScsCiAgICAgICAgJ2ltcGFjdCc6ICdCb3QgcHJvZml0cyBmcm9tIHByaWNlIG1vdmVtZW50IHlvdSBjYXVzZWQnLAogICAgICAgICdleGFtcGxlJzogJ0JvdCBidXlzIC0+IFlvdXIgdHJhZGUgLT4gQm90IHNlbGxzID0gcHJvZml0IGZvciBib3QnCiAgICB9LAogICAgJ2JhY2tydW5uaW5nJzogewogICAgICAgICdkZXNjcmlwdGlvbic6ICdCb3QgdHJhZGVzIGltbWVkaWF0ZWx5IGFmdGVyIHlvdXIgdHgnLAogICAgICAgICdpbXBhY3QnOiAnQm90IGNhcHR1cmVzIGFyYml0cmFnZSB5b3UgY3JlYXRlZCcsCiAgICAgICAgJ2V4YW1wbGUnOiAnWW91ciBsYXJnZSB0cmFkZSAtPiBCb3QgYXJiaXRyYWdlcyB0aGUgcHJpY2UgZGlmZmVyZW5jZScKICAgIH0KfQoKcHJpbnQoJ01FViBBdHRhY2sgVHlwZXM6JykKZm9yIGF0dGFjaywgaW5mbyBpbiBtZXZfdHlwZXMuaXRlbXMoKToKICAgIHByaW50KGYiXG57YXR0YWNrLnVwcGVyKCl9OiIpCiAgICBwcmludChmIiAgV2hhdDoge2luZm9bJ2Rlc2NyaXB0aW9uJ119IikKICAgIHByaW50KGYiICBJbXBhY3Q6IHtpbmZvWydpbXBhY3QnXX0iKQogICAgcHJpbnQoZiIgIEV4YW1wbGU6IHtpbmZvWydleGFtcGxlJ119Iik="><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-13-5')" type="button">Run</button></div><pre><code><span class="c1"># MEV (Maximal Extractable Value) types</span>
<span class="n">mev_types</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;frontrunning&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">&#39;Bots see your pending tx and trade before you&#39;</span><span class="p">,</span>
        <span class="s1">&#39;impact&#39;</span><span class="p">:</span> <span class="s1">&#39;You get worse price&#39;</span><span class="p">,</span>
        <span class="s1">&#39;example&#39;</span><span class="p">:</span> <span class="s1">&#39;You buy ETH, bot buys first, you pay more&#39;</span>
    <span class="p">},</span>
    <span class="s1">&#39;sandwich&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">&#39;Bot buys before you AND sells after you&#39;</span><span class="p">,</span>
        <span class="s1">&#39;impact&#39;</span><span class="p">:</span> <span class="s1">&#39;Bot profits from price movement you caused&#39;</span><span class="p">,</span>
        <span class="s1">&#39;example&#39;</span><span class="p">:</span> <span class="s1">&#39;Bot buys -&gt; Your trade -&gt; Bot sells = profit for bot&#39;</span>
    <span class="p">},</span>
    <span class="s1">&#39;backrunning&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">&#39;Bot trades immediately after your tx&#39;</span><span class="p">,</span>
        <span class="s1">&#39;impact&#39;</span><span class="p">:</span> <span class="s1">&#39;Bot captures arbitrage you created&#39;</span><span class="p">,</span>
        <span class="s1">&#39;example&#39;</span><span class="p">:</span> <span class="s1">&#39;Your large trade -&gt; Bot arbitrages the price difference&#39;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;MEV Attack Types:&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">attack</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">mev_types</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">attack</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  What: </span><span class="si">{</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Impact: </span><span class="si">{</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;impact&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Example: </span><span class="si">{</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;example&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre><div class="code-output" id="output-cell-13-5"></div></div>
<div class="md-cell"><h2>3.2 MEV Protection</h2></div>
<div class="code-cell" id="cell-13-6" data-source="Y2xhc3MgTUVWUHJvdGVjdGlvbjoKICAgICIiIlN0cmF0ZWdpZXMgdG8gcHJvdGVjdCBhZ2FpbnN0IE1FVi4iIiIKICAgIAogICAgZGVmIF9faW5pdF9fKHNlbGYpOgogICAgICAgIHNlbGYucHJvdGVjdGlvbl9tZXRob2RzID0gewogICAgICAgICAgICAncHJpdmF0ZV9tZW1wb29sJzogJ1N1Ym1pdCB0eCB0byBwcml2YXRlIG1lbXBvb2wgKEZsYXNoYm90cyknLAogICAgICAgICAgICAnbG93X3NsaXBwYWdlJzogJ1VzZSB0aWdodCBzbGlwcGFnZSB0byBtYWtlIHNhbmR3aWNoIHVucHJvZml0YWJsZScsCiAgICAgICAgICAgICdzcGxpdF9vcmRlcnMnOiAnU3BsaXQgbGFyZ2Ugb3JkZXJzIGludG8gc21hbGxlciBjaHVua3MnLAogICAgICAgICAgICAnbGltaXRfb3JkZXJzJzogJ1VzZSBERVggbGltaXQgb3JkZXJzIGluc3RlYWQgb2YgbWFya2V0JywKICAgICAgICAgICAgJ3RpbWluZyc6ICdUcmFkZSBkdXJpbmcgbG93IGFjdGl2aXR5IHBlcmlvZHMnCiAgICAgICAgfQogICAgCiAgICBkZWYgY2FsY3VsYXRlX3NhbmR3aWNoX3Byb2ZpdChzZWxmLCB0cmFkZV9zaXplLCBwb29sX2xpcXVpZGl0eSwgZmVlPTAuMDAzKToKICAgICAgICAiIiIKICAgICAgICBFc3RpbWF0ZSBwb3RlbnRpYWwgc2FuZHdpY2ggYXR0YWNrIHByb2ZpdC4KICAgICAgICAKICAgICAgICBJZiBwcm9maXQgPCBnYXMgY29zdCwgc2FuZHdpY2ggaXMgdW5wcm9maXRhYmxlLgogICAgICAgICIiIgogICAgICAgICMgU2ltcGxpZmllZCBtb2RlbAogICAgICAgIHByaWNlX2ltcGFjdCA9IHRyYWRlX3NpemUgLyBwb29sX2xpcXVpZGl0eQogICAgICAgIHBvdGVudGlhbF9wcm9maXQgPSB0cmFkZV9zaXplICogcHJpY2VfaW1wYWN0ICogMC41ICAjIFJvdWdoIGVzdGltYXRlCiAgICAgICAgCiAgICAgICAgIyBTdWJ0cmFjdCBmZWVzIChhdHRhY2tlciBwYXlzIDJ4OiBmcm9udCArIGJhY2spCiAgICAgICAgcHJvZml0X2FmdGVyX2ZlZXMgPSBwb3RlbnRpYWxfcHJvZml0IC0gKHRyYWRlX3NpemUgKiBmZWUgKiAyKQogICAgICAgIAogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICdwb3RlbnRpYWxfcHJvZml0JzogcG90ZW50aWFsX3Byb2ZpdCwKICAgICAgICAgICAgJ3Byb2ZpdF9hZnRlcl9mZWVzJzogcHJvZml0X2FmdGVyX2ZlZXMsCiAgICAgICAgICAgICdsaWtlbHlfdGFyZ2V0JzogcHJvZml0X2FmdGVyX2ZlZXMgPiA1MCAgIyAkNTAgdGhyZXNob2xkCiAgICAgICAgfQogICAgCiAgICBkZWYgcmVjb21tZW5kX3Byb3RlY3Rpb24oc2VsZiwgdHJhZGVfc2l6ZV91c2QsIHBvb2xfbGlxdWlkaXR5X3VzZCk6CiAgICAgICAgIiIiUmVjb21tZW5kIHByb3RlY3Rpb24gc3RyYXRlZ3kgYmFzZWQgb24gdHJhZGUgc2l6ZS4iIiIKICAgICAgICBzYW5kd2ljaCA9IHNlbGYuY2FsY3VsYXRlX3NhbmR3aWNoX3Byb2ZpdCh0cmFkZV9zaXplX3VzZCwgcG9vbF9saXF1aWRpdHlfdXNkKQogICAgICAgIAogICAgICAgIHJlY29tbWVuZGF0aW9ucyA9IFtdCiAgICAgICAgCiAgICAgICAgaWYgc2FuZHdpY2hbJ2xpa2VseV90YXJnZXQnXToKICAgICAgICAgICAgcmVjb21tZW5kYXRpb25zLmFwcGVuZCgnVXNlIEZsYXNoYm90cyBvciBwcml2YXRlIG1lbXBvb2wnKQogICAgICAgICAgICByZWNvbW1lbmRhdGlvbnMuYXBwZW5kKCdDb25zaWRlciBzcGxpdHRpbmcgaW50byBzbWFsbGVyIG9yZGVycycpCiAgICAgICAgCiAgICAgICAgaWYgdHJhZGVfc2l6ZV91c2QgLyBwb29sX2xpcXVpZGl0eV91c2QgPiAwLjAxOgogICAgICAgICAgICByZWNvbW1lbmRhdGlvbnMuYXBwZW5kKCdVc2UgdGlnaHQgc2xpcHBhZ2UgKDAuMy0wLjUlKScpCiAgICAgICAgCiAgICAgICAgaWYgdHJhZGVfc2l6ZV91c2QgPiAxMDAwMDA6CiAgICAgICAgICAgIHJlY29tbWVuZGF0aW9ucy5hcHBlbmQoJ0NvbnNpZGVyIE9UQyBvciBERVggYWdncmVnYXRvcicpCiAgICAgICAgCiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgJ3RyYWRlX3NpemUnOiB0cmFkZV9zaXplX3VzZCwKICAgICAgICAgICAgJ21ldl9yaXNrJzogJ0hJR0gnIGlmIHNhbmR3aWNoWydsaWtlbHlfdGFyZ2V0J10gZWxzZSAnTE9XJywKICAgICAgICAgICAgJ3JlY29tbWVuZGF0aW9ucyc6IHJlY29tbWVuZGF0aW9ucwogICAgICAgIH0KCm1ldiA9IE1FVlByb3RlY3Rpb24oKQpwcmludChtZXYucmVjb21tZW5kX3Byb3RlY3Rpb24oNTAwMDAsIDEwXzAwMF8wMDApKQ=="><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-13-6')" type="button">Run</button></div><pre><code><span class="k">class</span> <span class="nc">MEVProtection</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Strategies to protect against MEV.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">protection_methods</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;private_mempool&#39;</span><span class="p">:</span> <span class="s1">&#39;Submit tx to private mempool (Flashbots)&#39;</span><span class="p">,</span>
            <span class="s1">&#39;low_slippage&#39;</span><span class="p">:</span> <span class="s1">&#39;Use tight slippage to make sandwich unprofitable&#39;</span><span class="p">,</span>
            <span class="s1">&#39;split_orders&#39;</span><span class="p">:</span> <span class="s1">&#39;Split large orders into smaller chunks&#39;</span><span class="p">,</span>
            <span class="s1">&#39;limit_orders&#39;</span><span class="p">:</span> <span class="s1">&#39;Use DEX limit orders instead of market&#39;</span><span class="p">,</span>
            <span class="s1">&#39;timing&#39;</span><span class="p">:</span> <span class="s1">&#39;Trade during low activity periods&#39;</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">calculate_sandwich_profit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trade_size</span><span class="p">,</span> <span class="n">pool_liquidity</span><span class="p">,</span> <span class="n">fee</span><span class="o">=</span><span class="mf">0.003</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Estimate potential sandwich attack profit.</span>
<span class="sd">        </span>
<span class="sd">        If profit &lt; gas cost, sandwich is unprofitable.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Simplified model</span>
        <span class="n">price_impact</span> <span class="o">=</span> <span class="n">trade_size</span> <span class="o">/</span> <span class="n">pool_liquidity</span>
        <span class="n">potential_profit</span> <span class="o">=</span> <span class="n">trade_size</span> <span class="o">*</span> <span class="n">price_impact</span> <span class="o">*</span> <span class="mf">0.5</span>  <span class="c1"># Rough estimate</span>
        
        <span class="c1"># Subtract fees (attacker pays 2x: front + back)</span>
        <span class="n">profit_after_fees</span> <span class="o">=</span> <span class="n">potential_profit</span> <span class="o">-</span> <span class="p">(</span><span class="n">trade_size</span> <span class="o">*</span> <span class="n">fee</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;potential_profit&#39;</span><span class="p">:</span> <span class="n">potential_profit</span><span class="p">,</span>
            <span class="s1">&#39;profit_after_fees&#39;</span><span class="p">:</span> <span class="n">profit_after_fees</span><span class="p">,</span>
            <span class="s1">&#39;likely_target&#39;</span><span class="p">:</span> <span class="n">profit_after_fees</span> <span class="o">&gt;</span> <span class="mi">50</span>  <span class="c1"># $50 threshold</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">recommend_protection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trade_size_usd</span><span class="p">,</span> <span class="n">pool_liquidity_usd</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Recommend protection strategy based on trade size.&quot;&quot;&quot;</span>
        <span class="n">sandwich</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_sandwich_profit</span><span class="p">(</span><span class="n">trade_size_usd</span><span class="p">,</span> <span class="n">pool_liquidity_usd</span><span class="p">)</span>
        
        <span class="n">recommendations</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">if</span> <span class="n">sandwich</span><span class="p">[</span><span class="s1">&#39;likely_target&#39;</span><span class="p">]:</span>
            <span class="n">recommendations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Use Flashbots or private mempool&#39;</span><span class="p">)</span>
            <span class="n">recommendations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Consider splitting into smaller orders&#39;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">trade_size_usd</span> <span class="o">/</span> <span class="n">pool_liquidity_usd</span> <span class="o">&gt;</span> <span class="mf">0.01</span><span class="p">:</span>
            <span class="n">recommendations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Use tight slippage (0.3-0.5%)&#39;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">trade_size_usd</span> <span class="o">&gt;</span> <span class="mi">100000</span><span class="p">:</span>
            <span class="n">recommendations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Consider OTC or DEX aggregator&#39;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;trade_size&#39;</span><span class="p">:</span> <span class="n">trade_size_usd</span><span class="p">,</span>
            <span class="s1">&#39;mev_risk&#39;</span><span class="p">:</span> <span class="s1">&#39;HIGH&#39;</span> <span class="k">if</span> <span class="n">sandwich</span><span class="p">[</span><span class="s1">&#39;likely_target&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;LOW&#39;</span><span class="p">,</span>
            <span class="s1">&#39;recommendations&#39;</span><span class="p">:</span> <span class="n">recommendations</span>
        <span class="p">}</span>

<span class="n">mev</span> <span class="o">=</span> <span class="n">MEVProtection</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">mev</span><span class="o">.</span><span class="n">recommend_protection</span><span class="p">(</span><span class="mi">50000</span><span class="p">,</span> <span class="mi">10_000_000</span><span class="p">))</span>
</code></pre><div class="code-output" id="output-cell-13-6"></div></div>
<div class="md-cell"><h3>âœï¸ Exercise 13.3: MEV Analysis Tool</h3>
<p>Build a tool to analyze MEV risk for trades.</p></div>
<div class="code-cell" id="cell-13-7" data-source="IyBFeGVyY2lzZSAxMy4zCmNsYXNzIE1FVkFuYWx5emVyOgogICAgZGVmIF9faW5pdF9fKHNlbGYpOgogICAgICAgIHNlbGYuaGlzdG9yaWNhbF9hdHRhY2tzID0gW10KICAgIAogICAgZGVmIGFuYWx5emVfdHJhZGUoc2VsZiwgdHJhZGVfc2l6ZSwgcG9vbF9saXF1aWRpdHksIGN1cnJlbnRfZ2FzX2d3ZWkpOgogICAgICAgICMgVE9ETzogQ29tcHJlaGVuc2l2ZSBNRVYgcmlzayBhbmFseXNpcwogICAgICAgIHBhc3MKICAgIAogICAgZGVmIG9wdGltYWxfZXhlY3V0aW9uX3N0cmF0ZWd5KHNlbGYsIHRyYWRlX3NpemUsIHVyZ2VuY3k9J21lZGl1bScpOgogICAgICAgICMgVE9ETzogUmVjb21tZW5kIGJlc3QgZXhlY3V0aW9uIGFwcHJvYWNoCiAgICAgICAgcGFzcwogICAgCiAgICBkZWYgZXN0aW1hdGVfbWV2X2Nvc3Qoc2VsZiwgdHJhZGVfc2l6ZSwgcG9vbF9saXF1aWRpdHkpOgogICAgICAgICMgVE9ETzogRXN0aW1hdGUgaG93IG11Y2ggTUVWIGNvdWxkIGNvc3QgeW91CiAgICAgICAgcGFzcw=="><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-13-7')" type="button">Run</button></div><pre><code><span class="c1"># Exercise 13.3</span>
<span class="k">class</span> <span class="nc">MEVAnalyzer</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">historical_attacks</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">def</span> <span class="nf">analyze_trade</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trade_size</span><span class="p">,</span> <span class="n">pool_liquidity</span><span class="p">,</span> <span class="n">current_gas_gwei</span><span class="p">):</span>
        <span class="c1"># TODO: Comprehensive MEV risk analysis</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">optimal_execution_strategy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trade_size</span><span class="p">,</span> <span class="n">urgency</span><span class="o">=</span><span class="s1">&#39;medium&#39;</span><span class="p">):</span>
        <span class="c1"># TODO: Recommend best execution approach</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">estimate_mev_cost</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trade_size</span><span class="p">,</span> <span class="n">pool_liquidity</span><span class="p">):</span>
        <span class="c1"># TODO: Estimate how much MEV could cost you</span>
        <span class="k">pass</span>
</code></pre><div class="code-output" id="output-cell-13-7"></div></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">MEVAnalyzer</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">historical_attacks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">avg_gas_for_sandwich</span> <span class="o">=</span> <span class="mi">300000</span>  <span class="c1"># Gas units</span>

    <span class="k">def</span> <span class="nf">analyze_trade</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trade_size</span><span class="p">,</span> <span class="n">pool_liquidity</span><span class="p">,</span> <span class="n">current_gas_gwei</span><span class="p">):</span>
        <span class="c1"># Calculate sandwich profitability for attacker</span>
        <span class="n">price_impact</span> <span class="o">=</span> <span class="n">trade_size</span> <span class="o">/</span> <span class="n">pool_liquidity</span>
        <span class="n">potential_profit</span> <span class="o">=</span> <span class="n">trade_size</span> <span class="o">*</span> <span class="n">price_impact</span> <span class="o">*</span> <span class="mf">0.4</span>

        <span class="c1"># Gas cost for sandwich (2 transactions)</span>
        <span class="n">gas_cost_eth</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">avg_gas_for_sandwich</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">current_gas_gwei</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1e9</span>
        <span class="n">gas_cost_usd</span> <span class="o">=</span> <span class="n">gas_cost_eth</span> <span class="o">*</span> <span class="mi">2000</span>  <span class="c1"># Assume ETH = $2000</span>

        <span class="n">net_profit</span> <span class="o">=</span> <span class="n">potential_profit</span> <span class="o">-</span> <span class="n">gas_cost_usd</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;trade_size&#39;</span><span class="p">:</span> <span class="n">trade_size</span><span class="p">,</span>
            <span class="s1">&#39;price_impact_pct&#39;</span><span class="p">:</span> <span class="n">price_impact</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
            <span class="s1">&#39;potential_mev_profit&#39;</span><span class="p">:</span> <span class="n">potential_profit</span><span class="p">,</span>
            <span class="s1">&#39;attacker_gas_cost&#39;</span><span class="p">:</span> <span class="n">gas_cost_usd</span><span class="p">,</span>
            <span class="s1">&#39;net_attacker_profit&#39;</span><span class="p">:</span> <span class="n">net_profit</span><span class="p">,</span>
            <span class="s1">&#39;risk_level&#39;</span><span class="p">:</span> <span class="s1">&#39;HIGH&#39;</span> <span class="k">if</span> <span class="n">net_profit</span> <span class="o">&gt;</span> <span class="mi">100</span> <span class="k">else</span> <span class="s1">&#39;MEDIUM&#39;</span> <span class="k">if</span> <span class="n">net_profit</span> <span class="o">&gt;</span> <span class="mi">20</span> <span class="k">else</span> <span class="s1">&#39;LOW&#39;</span><span class="p">,</span>
            <span class="s1">&#39;recommendation&#39;</span><span class="p">:</span> <span class="s1">&#39;Use private mempool&#39;</span> <span class="k">if</span> <span class="n">net_profit</span> <span class="o">&gt;</span> <span class="mi">100</span> <span class="k">else</span> <span class="s1">&#39;Standard slippage OK&#39;</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">optimal_execution_strategy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trade_size</span><span class="p">,</span> <span class="n">urgency</span><span class="o">=</span><span class="s1">&#39;medium&#39;</span><span class="p">):</span>
        <span class="n">strategies</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">trade_size</span> <span class="o">&gt;</span> <span class="mi">100000</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">urgency</span> <span class="o">==</span> <span class="s1">&#39;low&#39;</span><span class="p">:</span>
                <span class="n">strategies</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;TWAP&#39;</span><span class="p">,</span> <span class="s1">&#39;Split into 10 orders over 1 hour&#39;</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">strategies</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;Flashbots&#39;</span><span class="p">,</span> <span class="s1">&#39;Private mempool submission&#39;</span><span class="p">))</span>
                <span class="n">strategies</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;Aggregator&#39;</span><span class="p">,</span> <span class="s1">&#39;Use 1inch/Paraswap for best routing&#39;</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">trade_size</span> <span class="o">&gt;</span> <span class="mi">10000</span><span class="p">:</span>
            <span class="n">strategies</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;Low slippage&#39;</span><span class="p">,</span> <span class="s1">&#39;Use 0.3</span><span class="si">% s</span><span class="s1">lippage&#39;</span><span class="p">))</span>
            <span class="n">strategies</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;Aggregator&#39;</span><span class="p">,</span> <span class="s1">&#39;Compare prices across DEXs&#39;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">strategies</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;Standard&#39;</span><span class="p">,</span> <span class="s1">&#39;Direct swap with 0.5</span><span class="si">% s</span><span class="s1">lippage&#39;</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">strategies</span>

    <span class="k">def</span> <span class="nf">estimate_mev_cost</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trade_size</span><span class="p">,</span> <span class="n">pool_liquidity</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Estimate expected MEV cost (worst case).&quot;&quot;&quot;</span>
        <span class="n">price_impact</span> <span class="o">=</span> <span class="n">trade_size</span> <span class="o">/</span> <span class="n">pool_liquidity</span>

        <span class="c1"># Attacker can capture ~30-50% of price impact</span>
        <span class="n">expected_loss</span> <span class="o">=</span> <span class="n">trade_size</span> <span class="o">*</span> <span class="n">price_impact</span> <span class="o">*</span> <span class="mf">0.4</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;expected_mev_loss&#39;</span><span class="p">:</span> <span class="n">expected_loss</span><span class="p">,</span>
            <span class="s1">&#39;as_percentage&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">expected_loss</span> <span class="o">/</span> <span class="n">trade_size</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
            <span class="s1">&#39;tip&#39;</span><span class="p">:</span> <span class="s1">&#39;Use private mempool to avoid this&#39;</span>
        <span class="p">}</span>

<span class="n">analyzer</span> <span class="o">=</span> <span class="n">MEVAnalyzer</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">analyzer</span><span class="o">.</span><span class="n">analyze_trade</span><span class="p">(</span><span class="mi">50000</span><span class="p">,</span> <span class="mi">5_000_000</span><span class="p">,</span> <span class="mi">30</span><span class="p">))</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>Section 4: DEX Aggregators</h1></div>
<div class="code-cell" id="cell-13-8" data-source="aW1wb3J0IHJlcXVlc3RzCgpjbGFzcyBPbmVJbmNoQVBJOgogICAgIiIiSW50ZXJmYWNlIHdpdGggMWluY2ggREVYIGFnZ3JlZ2F0b3IuIiIiCiAgICAKICAgIEJBU0VfVVJMID0gJ2h0dHBzOi8vYXBpLjFpbmNoLmRldi9zd2FwL3Y1LjIvMScgICMgRXRoZXJldW0gbWFpbm5ldAogICAgCiAgICBkZWYgX19pbml0X18oc2VsZiwgYXBpX2tleT1Ob25lKToKICAgICAgICBzZWxmLmFwaV9rZXkgPSBhcGlfa2V5CiAgICAgICAgc2VsZi5oZWFkZXJzID0geydBdXRob3JpemF0aW9uJzogZidCZWFyZXIge2FwaV9rZXl9J30gaWYgYXBpX2tleSBlbHNlIHt9CiAgICAKICAgIGRlZiBnZXRfcXVvdGUoc2VsZiwgZnJvbV90b2tlbiwgdG9fdG9rZW4sIGFtb3VudCk6CiAgICAgICAgIiIiCiAgICAgICAgR2V0IHF1b3RlIGZyb20gMWluY2guCiAgICAgICAgCiAgICAgICAgYW1vdW50OiBpbiBzbWFsbGVzdCB1bml0ICh3ZWkgZm9yIEVUSCkKICAgICAgICAiIiIKICAgICAgICBwYXJhbXMgPSB7CiAgICAgICAgICAgICdmcm9tVG9rZW5BZGRyZXNzJzogZnJvbV90b2tlbiwKICAgICAgICAgICAgJ3RvVG9rZW5BZGRyZXNzJzogdG9fdG9rZW4sCiAgICAgICAgICAgICdhbW91bnQnOiBzdHIoYW1vdW50KQogICAgICAgIH0KICAgICAgICAKICAgICAgICB0cnk6CiAgICAgICAgICAgIHJlc3BvbnNlID0gcmVxdWVzdHMuZ2V0KAogICAgICAgICAgICAgICAgZid7c2VsZi5CQVNFX1VSTH0vcXVvdGUnLAogICAgICAgICAgICAgICAgcGFyYW1zPXBhcmFtcywKICAgICAgICAgICAgICAgIGhlYWRlcnM9c2VsZi5oZWFkZXJzCiAgICAgICAgICAgICkKICAgICAgICAgICAgaWYgcmVzcG9uc2Uuc3RhdHVzX2NvZGUgPT0gMjAwOgogICAgICAgICAgICAgICAgZGF0YSA9IHJlc3BvbnNlLmpzb24oKQogICAgICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgICAgICAnZnJvbV90b2tlbic6IGRhdGEuZ2V0KCdmcm9tVG9rZW4nLCB7fSkuZ2V0KCdzeW1ib2wnKSwKICAgICAgICAgICAgICAgICAgICAndG9fdG9rZW4nOiBkYXRhLmdldCgndG9Ub2tlbicsIHt9KS5nZXQoJ3N5bWJvbCcpLAogICAgICAgICAgICAgICAgICAgICdmcm9tX2Ftb3VudCc6IGRhdGEuZ2V0KCdmcm9tVG9rZW5BbW91bnQnKSwKICAgICAgICAgICAgICAgICAgICAndG9fYW1vdW50JzogZGF0YS5nZXQoJ3RvVG9rZW5BbW91bnQnKSwKICAgICAgICAgICAgICAgICAgICAncHJvdG9jb2xzJzogZGF0YS5nZXQoJ3Byb3RvY29scycsIFtdKQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4geydlcnJvcic6IGYnU3RhdHVzIHtyZXNwb25zZS5zdGF0dXNfY29kZX0nfQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgcmV0dXJuIHsnZXJyb3InOiBzdHIoZSl9CiAgICAKICAgIGRlZiBnZXRfc3dhcF9kYXRhKHNlbGYsIGZyb21fdG9rZW4sIHRvX3Rva2VuLCBhbW91bnQsIGZyb21fYWRkcmVzcywgc2xpcHBhZ2U9MSk6CiAgICAgICAgIiIiR2V0IHN3YXAgdHJhbnNhY3Rpb24gZGF0YS4iIiIKICAgICAgICBwYXJhbXMgPSB7CiAgICAgICAgICAgICdmcm9tVG9rZW5BZGRyZXNzJzogZnJvbV90b2tlbiwKICAgICAgICAgICAgJ3RvVG9rZW5BZGRyZXNzJzogdG9fdG9rZW4sCiAgICAgICAgICAgICdhbW91bnQnOiBzdHIoYW1vdW50KSwKICAgICAgICAgICAgJ2Zyb21BZGRyZXNzJzogZnJvbV9hZGRyZXNzLAogICAgICAgICAgICAnc2xpcHBhZ2UnOiBzbGlwcGFnZQogICAgICAgIH0KICAgICAgICAKICAgICAgICB0cnk6CiAgICAgICAgICAgIHJlc3BvbnNlID0gcmVxdWVzdHMuZ2V0KAogICAgICAgICAgICAgICAgZid7c2VsZi5CQVNFX1VSTH0vc3dhcCcsCiAgICAgICAgICAgICAgICBwYXJhbXM9cGFyYW1zLAogICAgICAgICAgICAgICAgaGVhZGVycz1zZWxmLmhlYWRlcnMKICAgICAgICAgICAgKQogICAgICAgICAgICBpZiByZXNwb25zZS5zdGF0dXNfY29kZSA9PSAyMDA6CiAgICAgICAgICAgICAgICByZXR1cm4gcmVzcG9uc2UuanNvbigpCiAgICAgICAgICAgIHJldHVybiB7J2Vycm9yJzogZidTdGF0dXMge3Jlc3BvbnNlLnN0YXR1c19jb2RlfSd9CiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICByZXR1cm4geydlcnJvcic6IHN0cihlKX0="><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-13-8')" type="button">Run</button></div><pre><code><span class="kn">import</span> <span class="nn">requests</span>

<span class="k">class</span> <span class="nc">OneInchAPI</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Interface with 1inch DEX aggregator.&quot;&quot;&quot;</span>
    
    <span class="n">BASE_URL</span> <span class="o">=</span> <span class="s1">&#39;https://api.1inch.dev/swap/v5.2/1&#39;</span>  <span class="c1"># Ethereum mainnet</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">api_key</span> <span class="o">=</span> <span class="n">api_key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Authorization&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Bearer </span><span class="si">{</span><span class="n">api_key</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">}</span> <span class="k">if</span> <span class="n">api_key</span> <span class="k">else</span> <span class="p">{}</span>
    
    <span class="k">def</span> <span class="nf">get_quote</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">from_token</span><span class="p">,</span> <span class="n">to_token</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get quote from 1inch.</span>
<span class="sd">        </span>
<span class="sd">        amount: in smallest unit (wei for ETH)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;fromTokenAddress&#39;</span><span class="p">:</span> <span class="n">from_token</span><span class="p">,</span>
            <span class="s1">&#39;toTokenAddress&#39;</span><span class="p">:</span> <span class="n">to_token</span><span class="p">,</span>
            <span class="s1">&#39;amount&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">amount</span><span class="p">)</span>
        <span class="p">}</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">BASE_URL</span><span class="si">}</span><span class="s1">/quote&#39;</span><span class="p">,</span>
                <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span>
                <span class="n">headers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">headers</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
                <span class="k">return</span> <span class="p">{</span>
                    <span class="s1">&#39;from_token&#39;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fromToken&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;symbol&#39;</span><span class="p">),</span>
                    <span class="s1">&#39;to_token&#39;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;toToken&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;symbol&#39;</span><span class="p">),</span>
                    <span class="s1">&#39;from_amount&#39;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fromTokenAmount&#39;</span><span class="p">),</span>
                    <span class="s1">&#39;to_amount&#39;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;toTokenAmount&#39;</span><span class="p">),</span>
                    <span class="s1">&#39;protocols&#39;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;protocols&#39;</span><span class="p">,</span> <span class="p">[])</span>
                <span class="p">}</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Status </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">}</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>
    
    <span class="k">def</span> <span class="nf">get_swap_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">from_token</span><span class="p">,</span> <span class="n">to_token</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">from_address</span><span class="p">,</span> <span class="n">slippage</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get swap transaction data.&quot;&quot;&quot;</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;fromTokenAddress&#39;</span><span class="p">:</span> <span class="n">from_token</span><span class="p">,</span>
            <span class="s1">&#39;toTokenAddress&#39;</span><span class="p">:</span> <span class="n">to_token</span><span class="p">,</span>
            <span class="s1">&#39;amount&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">amount</span><span class="p">),</span>
            <span class="s1">&#39;fromAddress&#39;</span><span class="p">:</span> <span class="n">from_address</span><span class="p">,</span>
            <span class="s1">&#39;slippage&#39;</span><span class="p">:</span> <span class="n">slippage</span>
        <span class="p">}</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">BASE_URL</span><span class="si">}</span><span class="s1">/swap&#39;</span><span class="p">,</span>
                <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span>
                <span class="n">headers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">headers</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Status </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">}</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>
</code></pre><div class="code-output" id="output-cell-13-8"></div></div>
<div class="md-cell"><h3>âœï¸ Exercise 13.4: Aggregator Comparison</h3>
<p>Build a tool to compare multiple aggregators.</p></div>
<div class="code-cell" id="cell-13-9" data-source="IyBFeGVyY2lzZSAxMy40CmNsYXNzIEFnZ3JlZ2F0b3JDb21wYXJpc29uOgogICAgZGVmIF9faW5pdF9fKHNlbGYpOgogICAgICAgIHNlbGYuYWdncmVnYXRvcnMgPSB7fQogICAgCiAgICBkZWYgYWRkX2FnZ3JlZ2F0b3Ioc2VsZiwgbmFtZSwgYXBpX2NsYXNzKToKICAgICAgICAjIFRPRE8KICAgICAgICBwYXNzCiAgICAKICAgIGRlZiBjb21wYXJlX3F1b3RlcyhzZWxmLCBmcm9tX3Rva2VuLCB0b190b2tlbiwgYW1vdW50KToKICAgICAgICAjIFRPRE86IEdldCBxdW90ZXMgZnJvbSBhbGwgYWdncmVnYXRvcnMKICAgICAgICBwYXNzCiAgICAKICAgIGRlZiBmaW5kX2Jlc3Rfcm91dGUoc2VsZiwgZnJvbV90b2tlbiwgdG9fdG9rZW4sIGFtb3VudCk6CiAgICAgICAgIyBUT0RPOiBSZXR1cm4gYmVzdCBhZ2dyZWdhdG9yIGFuZCByb3V0ZQogICAgICAgIHBhc3M="><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-13-9')" type="button">Run</button></div><pre><code><span class="c1"># Exercise 13.4</span>
<span class="k">class</span> <span class="nc">AggregatorComparison</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aggregators</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="k">def</span> <span class="nf">add_aggregator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">api_class</span><span class="p">):</span>
        <span class="c1"># TODO</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">compare_quotes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">from_token</span><span class="p">,</span> <span class="n">to_token</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
        <span class="c1"># TODO: Get quotes from all aggregators</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">find_best_route</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">from_token</span><span class="p">,</span> <span class="n">to_token</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
        <span class="c1"># TODO: Return best aggregator and route</span>
        <span class="k">pass</span>
</code></pre><div class="code-output" id="output-cell-13-9"></div></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">AggregatorComparison</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aggregators</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">add_aggregator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">api_instance</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aggregators</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">api_instance</span>

    <span class="k">def</span> <span class="nf">compare_quotes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">from_token</span><span class="p">,</span> <span class="n">to_token</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">api</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">aggregators</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">quote</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_quote</span><span class="p">(</span><span class="n">from_token</span><span class="p">,</span> <span class="n">to_token</span><span class="p">,</span> <span class="n">amount</span><span class="p">)</span>
                <span class="k">if</span> <span class="s1">&#39;error&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">quote</span><span class="p">:</span>
                    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                        <span class="s1">&#39;aggregator&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                        <span class="s1">&#39;to_amount&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">quote</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;to_amount&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)),</span>
                        <span class="s1">&#39;protocols&#39;</span><span class="p">:</span> <span class="n">quote</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;protocols&#39;</span><span class="p">,</span> <span class="p">[])</span>
                    <span class="p">})</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                        <span class="s1">&#39;aggregator&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                        <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="n">quote</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">]</span>
                    <span class="p">})</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;aggregator&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)})</span>

        <span class="c1"># Sort by output amount</span>
        <span class="n">valid</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span> <span class="k">if</span> <span class="s1">&#39;to_amount&#39;</span> <span class="ow">in</span> <span class="n">r</span><span class="p">]</span>
        <span class="n">valid</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;to_amount&#39;</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;all_quotes&#39;</span><span class="p">:</span> <span class="n">results</span><span class="p">,</span>
            <span class="s1">&#39;ranked&#39;</span><span class="p">:</span> <span class="n">valid</span><span class="p">,</span>
            <span class="s1">&#39;best&#39;</span><span class="p">:</span> <span class="n">valid</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">valid</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">find_best_route</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">from_token</span><span class="p">,</span> <span class="n">to_token</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
        <span class="n">comparison</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compare_quotes</span><span class="p">(</span><span class="n">from_token</span><span class="p">,</span> <span class="n">to_token</span><span class="p">,</span> <span class="n">amount</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">comparison</span><span class="p">[</span><span class="s1">&#39;best&#39;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;No valid quotes&#39;</span><span class="p">}</span>

        <span class="n">best</span> <span class="o">=</span> <span class="n">comparison</span><span class="p">[</span><span class="s1">&#39;best&#39;</span><span class="p">]</span>

        <span class="c1"># Calculate savings vs worst</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">comparison</span><span class="p">[</span><span class="s1">&#39;ranked&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">worst</span> <span class="o">=</span> <span class="n">comparison</span><span class="p">[</span><span class="s1">&#39;ranked&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">savings</span> <span class="o">=</span> <span class="n">best</span><span class="p">[</span><span class="s1">&#39;to_amount&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">worst</span><span class="p">[</span><span class="s1">&#39;to_amount&#39;</span><span class="p">]</span>
            <span class="n">savings_pct</span> <span class="o">=</span> <span class="n">savings</span> <span class="o">/</span> <span class="n">worst</span><span class="p">[</span><span class="s1">&#39;to_amount&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">savings</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">savings_pct</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;best_aggregator&#39;</span><span class="p">:</span> <span class="n">best</span><span class="p">[</span><span class="s1">&#39;aggregator&#39;</span><span class="p">],</span>
            <span class="s1">&#39;output_amount&#39;</span><span class="p">:</span> <span class="n">best</span><span class="p">[</span><span class="s1">&#39;to_amount&#39;</span><span class="p">],</span>
            <span class="s1">&#39;savings_vs_worst&#39;</span><span class="p">:</span> <span class="n">savings</span><span class="p">,</span>
            <span class="s1">&#39;savings_pct&#39;</span><span class="p">:</span> <span class="n">savings_pct</span><span class="p">,</span>
            <span class="s1">&#39;routing&#39;</span><span class="p">:</span> <span class="n">best</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;protocols&#39;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="p">}</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>ğŸ—ï¸ Module Project: DEX Trading Bot</h1>
<p>Build a complete DEX trading bot with all safety features.</p></div>
<div class="code-cell" id="cell-13-10" data-source="IyBNb2R1bGUgUHJvamVjdApjbGFzcyBERVhUcmFkaW5nQm90OgogICAgZGVmIF9faW5pdF9fKHNlbGYsIHczLCBjb25maWcpOgogICAgICAgIHNlbGYudzMgPSB3MwogICAgICAgIHNlbGYuY29uZmlnID0gY29uZmlnCiAgICAgICAgc2VsZi5xdW90ZXIgPSBOb25lCiAgICAgICAgc2VsZi5leGVjdXRvciA9IE5vbmUKICAgICAgICBzZWxmLm1ldl9hbmFseXplciA9IE5vbmUKICAgIAogICAgZGVmIGluaXRpYWxpemUoc2VsZik6CiAgICAgICAgIyBUT0RPOiBTZXQgdXAgYWxsIGNvbXBvbmVudHMKICAgICAgICBwYXNzCiAgICAKICAgIGRlZiBhbmFseXplX3RyYWRlKHNlbGYsIHRva2VuX2luLCB0b2tlbl9vdXQsIGFtb3VudCk6CiAgICAgICAgIyBUT0RPOiBGdWxsIHRyYWRlIGFuYWx5c2lzCiAgICAgICAgcGFzcwogICAgCiAgICBkZWYgZXhlY3V0ZV9zYWZlX3N3YXAoc2VsZiwgdG9rZW5faW4sIHRva2VuX291dCwgYW1vdW50LCBtYXhfc2xpcHBhZ2UpOgogICAgICAgICMgVE9ETzogRXhlY3V0ZSB3aXRoIGFsbCBwcm90ZWN0aW9ucwogICAgICAgIHBhc3MKICAgIAogICAgZGVmIGdldF9iZXN0X2V4ZWN1dGlvbihzZWxmLCB0b2tlbl9pbiwgdG9rZW5fb3V0LCBhbW91bnQpOgogICAgICAgICMgVE9ETzogRmluZCBiZXN0IGV4ZWN1dGlvbiBwYXRoCiAgICAgICAgcGFzcw=="><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-13-10')" type="button">Run</button></div><pre><code><span class="c1"># Module Project</span>
<span class="k">class</span> <span class="nc">DEXTradingBot</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">w3</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w3</span> <span class="o">=</span> <span class="n">w3</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">quoter</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">executor</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mev_analyzer</span> <span class="o">=</span> <span class="kc">None</span>
    
    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># TODO: Set up all components</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">analyze_trade</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token_in</span><span class="p">,</span> <span class="n">token_out</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
        <span class="c1"># TODO: Full trade analysis</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">execute_safe_swap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token_in</span><span class="p">,</span> <span class="n">token_out</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">max_slippage</span><span class="p">):</span>
        <span class="c1"># TODO: Execute with all protections</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">get_best_execution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token_in</span><span class="p">,</span> <span class="n">token_out</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
        <span class="c1"># TODO: Find best execution path</span>
        <span class="k">pass</span>
</code></pre><div class="code-output" id="output-cell-13-10"></div></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">DEXTradingBot</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">w3</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w3</span> <span class="o">=</span> <span class="n">w3</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">quoter</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">executor</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mev_analyzer</span> <span class="o">=</span> <span class="n">MEVAnalyzer</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slippage</span> <span class="o">=</span> <span class="n">SlippageProtection</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;default_slippage&#39;</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">quoter</span> <span class="o">=</span> <span class="n">UniswapQuoter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">w3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">executor</span> <span class="o">=</span> <span class="n">SafeDEXExecutor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">w3</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;router_address&#39;</span><span class="p">))</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">analyze_trade</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token_in</span><span class="p">,</span> <span class="n">token_out</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
        <span class="c1"># Get quote</span>
        <span class="n">quote</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">quoter</span><span class="o">.</span><span class="n">get_quote</span><span class="p">(</span><span class="n">token_in</span><span class="p">,</span> <span class="n">token_out</span><span class="p">,</span> <span class="n">amount</span><span class="p">)</span>

        <span class="c1"># Get price impact</span>
        <span class="n">impact</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">quoter</span><span class="o">.</span><span class="n">get_price_impact</span><span class="p">(</span><span class="n">token_in</span><span class="p">,</span> <span class="n">token_out</span><span class="p">,</span> <span class="n">amount</span><span class="p">)</span>

        <span class="c1"># MEV analysis</span>
        <span class="n">gas_price</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">w3</span><span class="o">.</span><span class="n">from_wei</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">gas_price</span><span class="p">,</span> <span class="s1">&#39;gwei&#39;</span><span class="p">))</span>
        <span class="n">mev</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mev_analyzer</span><span class="o">.</span><span class="n">analyze_trade</span><span class="p">(</span><span class="n">amount</span> <span class="o">*</span> <span class="mi">2000</span><span class="p">,</span> <span class="mi">10_000_000</span><span class="p">,</span> <span class="n">gas_price</span><span class="p">)</span>  <span class="c1"># Assume $2k price</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;quote&#39;</span><span class="p">:</span> <span class="n">quote</span><span class="p">,</span>
            <span class="s1">&#39;price_impact&#39;</span><span class="p">:</span> <span class="n">impact</span><span class="p">,</span>
            <span class="s1">&#39;mev_risk&#39;</span><span class="p">:</span> <span class="n">mev</span><span class="p">[</span><span class="s1">&#39;risk_level&#39;</span><span class="p">],</span>
            <span class="s1">&#39;mev_recommendation&#39;</span><span class="p">:</span> <span class="n">mev</span><span class="p">[</span><span class="s1">&#39;recommendation&#39;</span><span class="p">],</span>
            <span class="s1">&#39;recommended_slippage&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">slippage</span><span class="o">.</span><span class="n">recommend_slippage</span><span class="p">(</span><span class="s1">&#39;pair&#39;</span><span class="p">,</span> <span class="n">amount</span> <span class="o">*</span> <span class="mi">2000</span><span class="p">,</span> <span class="mi">10_000_000</span><span class="p">)</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">execute_safe_swap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token_in</span><span class="p">,</span> <span class="n">token_out</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">max_slippage</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># Analyze first</span>
        <span class="n">analysis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_trade</span><span class="p">(</span><span class="n">token_in</span><span class="p">,</span> <span class="n">token_out</span><span class="p">,</span> <span class="n">amount</span><span class="p">)</span>

        <span class="c1"># Use recommended slippage if not specified</span>
        <span class="n">slippage</span> <span class="o">=</span> <span class="n">max_slippage</span> <span class="ow">or</span> <span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;recommended_slippage&#39;</span><span class="p">]</span>

        <span class="c1"># Check MEV risk</span>
        <span class="k">if</span> <span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;mev_risk&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;HIGH&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;High MEV risk - use private mempool&#39;</span><span class="p">,</span>
                <span class="s1">&#39;analysis&#39;</span><span class="p">:</span> <span class="n">analysis</span>
            <span class="p">}</span>

        <span class="c1"># Execute</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">executor</span><span class="o">.</span><span class="n">execute_with_checks</span><span class="p">(</span><span class="n">token_in</span><span class="p">,</span> <span class="n">token_out</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">slippage</span><span class="p">)</span>
        <span class="n">result</span><span class="p">[</span><span class="s1">&#39;analysis&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">analysis</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">get_best_execution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token_in</span><span class="p">,</span> <span class="n">token_out</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
        <span class="n">analysis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_trade</span><span class="p">(</span><span class="n">token_in</span><span class="p">,</span> <span class="n">token_out</span><span class="p">,</span> <span class="n">amount</span><span class="p">)</span>
        <span class="n">strategy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mev_analyzer</span><span class="o">.</span><span class="n">optimal_execution_strategy</span><span class="p">(</span><span class="n">amount</span> <span class="o">*</span> <span class="mi">2000</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;analysis&#39;</span><span class="p">:</span> <span class="n">analysis</span><span class="p">,</span>
            <span class="s1">&#39;recommended_strategy&#39;</span><span class="p">:</span> <span class="n">strategy</span><span class="p">,</span>
            <span class="s1">&#39;total_cost_estimate&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;slippage_cost&#39;</span><span class="p">:</span> <span class="n">amount</span> <span class="o">*</span> <span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;price_impact&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">100</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;price_impact&#39;</span><span class="p">],</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">))</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s1">&#39;potential_mev_cost&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">mev_analyzer</span><span class="o">.</span><span class="n">estimate_mev_cost</span><span class="p">(</span><span class="n">amount</span> <span class="o">*</span> <span class="mi">2000</span><span class="p">,</span> <span class="mi">10_000_000</span><span class="p">)[</span><span class="s1">&#39;expected_mev_loss&#39;</span><span class="p">]</span>
            <span class="p">}</span>
        <span class="p">}</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>ğŸ“ Key Takeaways</h1>
<ol>
<li><strong>Uniswap Integration</strong>: Get quotes, calculate price impact, build swaps</li>
<li><strong>Slippage Protection</strong>: Always set appropriate slippage based on trade size</li>
<li><strong>MEV Awareness</strong>: Large trades are targets - use private mempools</li>
<li><strong>Aggregators</strong>: Compare across DEXs for best execution</li>
</ol>
<hr />
<p><em>Next: Module 14 - Advanced DeFi Strategies</em></p></div>
        <div class="nav-buttons">
            <button class="nav-btn prev-btn disabled" type="button">
                <span class="nav-btn-label">â† Previous</span>
                <span class="nav-btn-name"></span>
            </button>
            <button class="nav-btn next-btn disabled" type="button">
                <span class="nav-btn-label">Next â†’</span>
                <span class="nav-btn-name"></span>
            </button>
        </div>
        </div>
<div class="module-section" data-idx="14"><div class="md-cell module-header"><h1>Module 14: Advanced DeFi Strategies</h1>
<h2>Part 4: DeFi &amp; Advanced Topics</h2>
<hr />
<div class="table-wrapper"><table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>â±ï¸ <strong>Duration</strong></td>
<td>~2.5 hours</td>
</tr>
<tr>
<td>ğŸ“‹ <strong>Prerequisites</strong></td>
<td>Module 13</td>
</tr>
<tr>
<td>ğŸ’ª <strong>Exercises</strong></td>
<td>5 total</td>
</tr>
</tbody>
</table></div></div>
<div class="md-cell"><h2>ğŸ¯ Learning Objectives</h2>
<ul>
<li>Identify and execute arbitrage opportunities</li>
<li>Analyze liquidity provision strategies</li>
<li>Evaluate yield farming opportunities</li>
<li>Understand flash loan mechanics</li>
</ul></div>
<div class="md-cell"><hr />
<h1>Section 1: Arbitrage Opportunities</h1>
<h2>1.1 CEX-DEX Arbitrage</h2></div>
<div class="code-cell" id="cell-14-0" data-source="Y2xhc3MgQ0VYREVYQXJiaXRyYWdlOgogICAgIiIiRmluZCBhcmJpdHJhZ2UgYmV0d2VlbiBjZW50cmFsaXplZCBhbmQgZGVjZW50cmFsaXplZCBleGNoYW5nZXMuIiIiCiAgICAKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBjZXhfYXBpLCBkZXhfcXVvdGVyKToKICAgICAgICBzZWxmLmNleCA9IGNleF9hcGkKICAgICAgICBzZWxmLmRleCA9IGRleF9xdW90ZXIKICAgIAogICAgZGVmIGdldF9wcmljZXMoc2VsZiwgc3ltYm9sLCBkZXhfdG9rZW5zKToKICAgICAgICAiIiJHZXQgcHJpY2VzIGZyb20gYm90aCBDRVggYW5kIERFWC4iIiIKICAgICAgICAjIENFWCBwcmljZQogICAgICAgIGNleF90aWNrZXIgPSBzZWxmLmNleC5mZXRjaF90aWNrZXIoc3ltYm9sKQogICAgICAgIGNleF9wcmljZSA9IGNleF90aWNrZXJbJ2xhc3QnXQogICAgICAgIGNleF9iaWQgPSBjZXhfdGlja2VyWydiaWQnXQogICAgICAgIGNleF9hc2sgPSBjZXhfdGlja2VyWydhc2snXQogICAgICAgIAogICAgICAgICMgREVYIHByaWNlICgxIHVuaXQpCiAgICAgICAgZGV4X3F1b3RlID0gc2VsZi5kZXguZ2V0X3F1b3RlKAogICAgICAgICAgICBkZXhfdG9rZW5zWydiYXNlJ10sCiAgICAgICAgICAgIGRleF90b2tlbnNbJ3F1b3RlJ10sCiAgICAgICAgICAgIDEKICAgICAgICApCiAgICAgICAgCiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgJ2NleCc6IHsncHJpY2UnOiBjZXhfcHJpY2UsICdiaWQnOiBjZXhfYmlkLCAnYXNrJzogY2V4X2Fza30sCiAgICAgICAgICAgICdkZXgnOiB7J3ByaWNlJzogZGV4X3F1b3RlfQogICAgICAgIH0KICAgIAogICAgZGVmIGNhbGN1bGF0ZV9hcmJpdHJhZ2Uoc2VsZiwgcHJpY2VzLCBhbW91bnQsIGZlZXMpOgogICAgICAgICIiIgogICAgICAgIENhbGN1bGF0ZSBhcmJpdHJhZ2Ugb3Bwb3J0dW5pdHkuCiAgICAgICAgCiAgICAgICAgZmVlczogZGljdCB3aXRoICdjZXhfZmVlJywgJ2RleF9mZWUnLCAnZ2FzX2Nvc3RfdXNkJwogICAgICAgICIiIgogICAgICAgIGNleF9wcmljZSA9IHByaWNlc1snY2V4J11bJ3ByaWNlJ10KICAgICAgICBkZXhfcHJpY2UgPSBwcmljZXNbJ2RleCddWydwcmljZSddCiAgICAgICAgCiAgICAgICAgc3ByZWFkX3BjdCA9IGFicyhjZXhfcHJpY2UgLSBkZXhfcHJpY2UpIC8gbWluKGNleF9wcmljZSwgZGV4X3ByaWNlKSAqIDEwMAogICAgICAgIAogICAgICAgICMgQ2FsY3VsYXRlIHByb2ZpdCBmb3IgZWFjaCBkaXJlY3Rpb24KICAgICAgICBpZiBjZXhfcHJpY2UgPiBkZXhfcHJpY2U6CiAgICAgICAgICAgICMgQnV5IG9uIERFWCwgc2VsbCBvbiBDRVgKICAgICAgICAgICAgZGlyZWN0aW9uID0gJ0RFWCAtPiBDRVgnCiAgICAgICAgICAgIGJ1eV9jb3N0ID0gYW1vdW50ICogZGV4X3ByaWNlICogKDEgKyBmZWVzWydkZXhfZmVlJ10pCiAgICAgICAgICAgIHNlbGxfcmV2ZW51ZSA9IGFtb3VudCAqIHByaWNlc1snY2V4J11bJ2JpZCddICogKDEgLSBmZWVzWydjZXhfZmVlJ10pCiAgICAgICAgZWxzZToKICAgICAgICAgICAgIyBCdXkgb24gQ0VYLCBzZWxsIG9uIERFWAogICAgICAgICAgICBkaXJlY3Rpb24gPSAnQ0VYIC0+IERFWCcKICAgICAgICAgICAgYnV5X2Nvc3QgPSBhbW91bnQgKiBwcmljZXNbJ2NleCddWydhc2snXSAqICgxICsgZmVlc1snY2V4X2ZlZSddKQogICAgICAgICAgICBzZWxsX3JldmVudWUgPSBhbW91bnQgKiBkZXhfcHJpY2UgKiAoMSAtIGZlZXNbJ2RleF9mZWUnXSkKICAgICAgICAKICAgICAgICBncm9zc19wcm9maXQgPSBzZWxsX3JldmVudWUgLSBidXlfY29zdAogICAgICAgIG5ldF9wcm9maXQgPSBncm9zc19wcm9maXQgLSBmZWVzWydnYXNfY29zdF91c2QnXQogICAgICAgIAogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICdkaXJlY3Rpb24nOiBkaXJlY3Rpb24sCiAgICAgICAgICAgICdzcHJlYWRfcGN0Jzogc3ByZWFkX3BjdCwKICAgICAgICAgICAgJ2dyb3NzX3Byb2ZpdCc6IGdyb3NzX3Byb2ZpdCwKICAgICAgICAgICAgJ25ldF9wcm9maXQnOiBuZXRfcHJvZml0LAogICAgICAgICAgICAncHJvZml0YWJsZSc6IG5ldF9wcm9maXQgPiAwCiAgICAgICAgfQ=="><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-14-0')" type="button">Run</button></div><pre><code><span class="k">class</span> <span class="nc">CEXDEXArbitrage</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Find arbitrage between centralized and decentralized exchanges.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cex_api</span><span class="p">,</span> <span class="n">dex_quoter</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cex</span> <span class="o">=</span> <span class="n">cex_api</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dex</span> <span class="o">=</span> <span class="n">dex_quoter</span>
    
    <span class="k">def</span> <span class="nf">get_prices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">dex_tokens</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get prices from both CEX and DEX.&quot;&quot;&quot;</span>
        <span class="c1"># CEX price</span>
        <span class="n">cex_ticker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cex</span><span class="o">.</span><span class="n">fetch_ticker</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
        <span class="n">cex_price</span> <span class="o">=</span> <span class="n">cex_ticker</span><span class="p">[</span><span class="s1">&#39;last&#39;</span><span class="p">]</span>
        <span class="n">cex_bid</span> <span class="o">=</span> <span class="n">cex_ticker</span><span class="p">[</span><span class="s1">&#39;bid&#39;</span><span class="p">]</span>
        <span class="n">cex_ask</span> <span class="o">=</span> <span class="n">cex_ticker</span><span class="p">[</span><span class="s1">&#39;ask&#39;</span><span class="p">]</span>
        
        <span class="c1"># DEX price (1 unit)</span>
        <span class="n">dex_quote</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dex</span><span class="o">.</span><span class="n">get_quote</span><span class="p">(</span>
            <span class="n">dex_tokens</span><span class="p">[</span><span class="s1">&#39;base&#39;</span><span class="p">],</span>
            <span class="n">dex_tokens</span><span class="p">[</span><span class="s1">&#39;quote&#39;</span><span class="p">],</span>
            <span class="mi">1</span>
        <span class="p">)</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;cex&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="n">cex_price</span><span class="p">,</span> <span class="s1">&#39;bid&#39;</span><span class="p">:</span> <span class="n">cex_bid</span><span class="p">,</span> <span class="s1">&#39;ask&#39;</span><span class="p">:</span> <span class="n">cex_ask</span><span class="p">},</span>
            <span class="s1">&#39;dex&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="n">dex_quote</span><span class="p">}</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">calculate_arbitrage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prices</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">fees</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate arbitrage opportunity.</span>
<span class="sd">        </span>
<span class="sd">        fees: dict with &#39;cex_fee&#39;, &#39;dex_fee&#39;, &#39;gas_cost_usd&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cex_price</span> <span class="o">=</span> <span class="n">prices</span><span class="p">[</span><span class="s1">&#39;cex&#39;</span><span class="p">][</span><span class="s1">&#39;price&#39;</span><span class="p">]</span>
        <span class="n">dex_price</span> <span class="o">=</span> <span class="n">prices</span><span class="p">[</span><span class="s1">&#39;dex&#39;</span><span class="p">][</span><span class="s1">&#39;price&#39;</span><span class="p">]</span>
        
        <span class="n">spread_pct</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">cex_price</span> <span class="o">-</span> <span class="n">dex_price</span><span class="p">)</span> <span class="o">/</span> <span class="nb">min</span><span class="p">(</span><span class="n">cex_price</span><span class="p">,</span> <span class="n">dex_price</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
        
        <span class="c1"># Calculate profit for each direction</span>
        <span class="k">if</span> <span class="n">cex_price</span> <span class="o">&gt;</span> <span class="n">dex_price</span><span class="p">:</span>
            <span class="c1"># Buy on DEX, sell on CEX</span>
            <span class="n">direction</span> <span class="o">=</span> <span class="s1">&#39;DEX -&gt; CEX&#39;</span>
            <span class="n">buy_cost</span> <span class="o">=</span> <span class="n">amount</span> <span class="o">*</span> <span class="n">dex_price</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">fees</span><span class="p">[</span><span class="s1">&#39;dex_fee&#39;</span><span class="p">])</span>
            <span class="n">sell_revenue</span> <span class="o">=</span> <span class="n">amount</span> <span class="o">*</span> <span class="n">prices</span><span class="p">[</span><span class="s1">&#39;cex&#39;</span><span class="p">][</span><span class="s1">&#39;bid&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">fees</span><span class="p">[</span><span class="s1">&#39;cex_fee&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Buy on CEX, sell on DEX</span>
            <span class="n">direction</span> <span class="o">=</span> <span class="s1">&#39;CEX -&gt; DEX&#39;</span>
            <span class="n">buy_cost</span> <span class="o">=</span> <span class="n">amount</span> <span class="o">*</span> <span class="n">prices</span><span class="p">[</span><span class="s1">&#39;cex&#39;</span><span class="p">][</span><span class="s1">&#39;ask&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">fees</span><span class="p">[</span><span class="s1">&#39;cex_fee&#39;</span><span class="p">])</span>
            <span class="n">sell_revenue</span> <span class="o">=</span> <span class="n">amount</span> <span class="o">*</span> <span class="n">dex_price</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">fees</span><span class="p">[</span><span class="s1">&#39;dex_fee&#39;</span><span class="p">])</span>
        
        <span class="n">gross_profit</span> <span class="o">=</span> <span class="n">sell_revenue</span> <span class="o">-</span> <span class="n">buy_cost</span>
        <span class="n">net_profit</span> <span class="o">=</span> <span class="n">gross_profit</span> <span class="o">-</span> <span class="n">fees</span><span class="p">[</span><span class="s1">&#39;gas_cost_usd&#39;</span><span class="p">]</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;direction&#39;</span><span class="p">:</span> <span class="n">direction</span><span class="p">,</span>
            <span class="s1">&#39;spread_pct&#39;</span><span class="p">:</span> <span class="n">spread_pct</span><span class="p">,</span>
            <span class="s1">&#39;gross_profit&#39;</span><span class="p">:</span> <span class="n">gross_profit</span><span class="p">,</span>
            <span class="s1">&#39;net_profit&#39;</span><span class="p">:</span> <span class="n">net_profit</span><span class="p">,</span>
            <span class="s1">&#39;profitable&#39;</span><span class="p">:</span> <span class="n">net_profit</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="p">}</span>
</code></pre><div class="code-output" id="output-cell-14-0"></div></div>
<div class="md-cell"><h2>1.2 DEX-DEX Arbitrage</h2></div>
<div class="code-cell" id="cell-14-1" data-source="Y2xhc3MgREVYQXJiaXRyYWdlRmluZGVyOgogICAgIiIiRmluZCBhcmJpdHJhZ2UgYmV0d2VlbiBkaWZmZXJlbnQgREVYcy4iIiIKICAgIAogICAgZGVmIF9faW5pdF9fKHNlbGYpOgogICAgICAgIHNlbGYuZGV4ZXMgPSB7fQogICAgCiAgICBkZWYgYWRkX2RleChzZWxmLCBuYW1lLCBxdW90ZXIpOgogICAgICAgIHNlbGYuZGV4ZXNbbmFtZV0gPSBxdW90ZXIKICAgIAogICAgZGVmIGZpbmRfYXJiaXRyYWdlKHNlbGYsIHRva2VuX2EsIHRva2VuX2IsIGFtb3VudCk6CiAgICAgICAgIiIiRmluZCBiZXN0IGFyYml0cmFnZSBhY3Jvc3MgREVYcy4iIiIKICAgICAgICBxdW90ZXMgPSB7fQogICAgICAgIAogICAgICAgIGZvciBuYW1lLCBxdW90ZXIgaW4gc2VsZi5kZXhlcy5pdGVtcygpOgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBxdW90ZSA9IHF1b3Rlci5nZXRfcXVvdGUodG9rZW5fYSwgdG9rZW5fYiwgYW1vdW50KQogICAgICAgICAgICAgICAgcXVvdGVzW25hbWVdID0gcXVvdGUKICAgICAgICAgICAgZXhjZXB0OgogICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAKICAgICAgICBpZiBsZW4ocXVvdGVzKSA8IDI6CiAgICAgICAgICAgIHJldHVybiB7J2Vycm9yJzogJ05lZWQgYXQgbGVhc3QgMiBERVhzJ30KICAgICAgICAKICAgICAgICAjIEZpbmQgYmVzdCBidXkgYW5kIHNlbGwKICAgICAgICBiZXN0X2J1eSA9IG1pbihxdW90ZXMuaXRlbXMoKSwga2V5PWxhbWJkYSB4OiB4WzFdKSAgIyBMb3dlc3QgcHJpY2UgdG8gYnV5CiAgICAgICAgYmVzdF9zZWxsID0gbWF4KHF1b3Rlcy5pdGVtcygpLCBrZXk9bGFtYmRhIHg6IHhbMV0pICAjIEhpZ2hlc3QgcHJpY2UgdG8gc2VsbAogICAgICAgIAogICAgICAgIHNwcmVhZCA9IChiZXN0X3NlbGxbMV0gLSBiZXN0X2J1eVsxXSkgLyBiZXN0X2J1eVsxXSAqIDEwMAogICAgICAgIAogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICdidXlfb24nOiBiZXN0X2J1eVswXSwKICAgICAgICAgICAgJ2J1eV9wcmljZSc6IGJlc3RfYnV5WzFdLAogICAgICAgICAgICAnc2VsbF9vbic6IGJlc3Rfc2VsbFswXSwKICAgICAgICAgICAgJ3NlbGxfcHJpY2UnOiBiZXN0X3NlbGxbMV0sCiAgICAgICAgICAgICdzcHJlYWRfcGN0Jzogc3ByZWFkLAogICAgICAgICAgICAncHJvZml0YWJsZSc6IHNwcmVhZCA+IDAuNiAgIyBOZWVkID4wLjYlIHRvIGNvdmVyIGZlZXMKICAgICAgICB9"><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-14-1')" type="button">Run</button></div><pre><code><span class="k">class</span> <span class="nc">DEXArbitrageFinder</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Find arbitrage between different DEXs.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dexes</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="k">def</span> <span class="nf">add_dex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">quoter</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dexes</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">quoter</span>
    
    <span class="k">def</span> <span class="nf">find_arbitrage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token_a</span><span class="p">,</span> <span class="n">token_b</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Find best arbitrage across DEXs.&quot;&quot;&quot;</span>
        <span class="n">quotes</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">quoter</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dexes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">quote</span> <span class="o">=</span> <span class="n">quoter</span><span class="o">.</span><span class="n">get_quote</span><span class="p">(</span><span class="n">token_a</span><span class="p">,</span> <span class="n">token_b</span><span class="p">,</span> <span class="n">amount</span><span class="p">)</span>
                <span class="n">quotes</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">quote</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">continue</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">quotes</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Need at least 2 DEXs&#39;</span><span class="p">}</span>
        
        <span class="c1"># Find best buy and sell</span>
        <span class="n">best_buy</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">quotes</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># Lowest price to buy</span>
        <span class="n">best_sell</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">quotes</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># Highest price to sell</span>
        
        <span class="n">spread</span> <span class="o">=</span> <span class="p">(</span><span class="n">best_sell</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">best_buy</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="n">best_buy</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;buy_on&#39;</span><span class="p">:</span> <span class="n">best_buy</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="s1">&#39;buy_price&#39;</span><span class="p">:</span> <span class="n">best_buy</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="s1">&#39;sell_on&#39;</span><span class="p">:</span> <span class="n">best_sell</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="s1">&#39;sell_price&#39;</span><span class="p">:</span> <span class="n">best_sell</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="s1">&#39;spread_pct&#39;</span><span class="p">:</span> <span class="n">spread</span><span class="p">,</span>
            <span class="s1">&#39;profitable&#39;</span><span class="p">:</span> <span class="n">spread</span> <span class="o">&gt;</span> <span class="mf">0.6</span>  <span class="c1"># Need &gt;0.6% to cover fees</span>
        <span class="p">}</span>
</code></pre><div class="code-output" id="output-cell-14-1"></div></div>
<div class="md-cell"><h2>1.3 Triangular Arbitrage</h2></div>
<div class="code-cell" id="cell-14-2" data-source="Y2xhc3MgVHJpYW5ndWxhckFyYml0cmFnZToKICAgICIiIgogICAgRmluZCB0cmlhbmd1bGFyIGFyYml0cmFnZSBvcHBvcnR1bml0aWVzLgogICAgCiAgICBFeGFtcGxlOiBVU0RDIC0+IEVUSCAtPiBCVEMgLT4gVVNEQwogICAgIiIiCiAgICAKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBxdW90ZXIpOgogICAgICAgIHNlbGYucXVvdGVyID0gcXVvdGVyCiAgICAKICAgIGRlZiBjYWxjdWxhdGVfdHJpYW5ndWxhcihzZWxmLCBwYXRoLCBpbml0aWFsX2Ftb3VudCk6CiAgICAgICAgIiIiCiAgICAgICAgQ2FsY3VsYXRlIHJldHVybiBmb3IgdHJpYW5ndWxhciBwYXRoLgogICAgICAgIAogICAgICAgIHBhdGg6IGxpc3Qgb2YgMyB0b2tlbnMsIGUuZy4sIFsnVVNEQycsICdFVEgnLCAnQlRDJ10KICAgICAgICAiIiIKICAgICAgICBpZiBsZW4ocGF0aCkgIT0gMzoKICAgICAgICAgICAgcmV0dXJuIHsnZXJyb3InOiAnUGF0aCBtdXN0IGhhdmUgZXhhY3RseSAzIHRva2Vucyd9CiAgICAgICAgCiAgICAgICAgIyBUcmFkZSAxOiBBIC0+IEIKICAgICAgICBhbW91bnRfYiA9IHNlbGYucXVvdGVyLmdldF9xdW90ZShwYXRoWzBdLCBwYXRoWzFdLCBpbml0aWFsX2Ftb3VudCkKICAgICAgICAKICAgICAgICAjIFRyYWRlIDI6IEIgLT4gQwogICAgICAgIGFtb3VudF9jID0gc2VsZi5xdW90ZXIuZ2V0X3F1b3RlKHBhdGhbMV0sIHBhdGhbMl0sIGFtb3VudF9iKQogICAgICAgIAogICAgICAgICMgVHJhZGUgMzogQyAtPiBBIChiYWNrIHRvIHN0YXJ0KQogICAgICAgIGZpbmFsX2Ftb3VudCA9IHNlbGYucXVvdGVyLmdldF9xdW90ZShwYXRoWzJdLCBwYXRoWzBdLCBhbW91bnRfYykKICAgICAgICAKICAgICAgICBwcm9maXQgPSBmaW5hbF9hbW91bnQgLSBpbml0aWFsX2Ftb3VudAogICAgICAgIHByb2ZpdF9wY3QgPSAocHJvZml0IC8gaW5pdGlhbF9hbW91bnQpICogMTAwCiAgICAgICAgCiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgJ3BhdGgnOiAnIC0+ICcuam9pbihwYXRoKSArIGYnIC0+IHtwYXRoWzBdfScsCiAgICAgICAgICAgICdpbml0aWFsJzogaW5pdGlhbF9hbW91bnQsCiAgICAgICAgICAgICdmaW5hbCc6IGZpbmFsX2Ftb3VudCwKICAgICAgICAgICAgJ3Byb2ZpdCc6IHByb2ZpdCwKICAgICAgICAgICAgJ3Byb2ZpdF9wY3QnOiBwcm9maXRfcGN0LAogICAgICAgICAgICAncHJvZml0YWJsZSc6IHByb2ZpdF9wY3QgPiAwLjMgICMgTmVlZCA+MC4zJSBhZnRlciAzIHRyYWRlcwogICAgICAgIH0KICAgIAogICAgZGVmIHNjYW5fYWxsX3BhdGhzKHNlbGYsIHRva2VucywgaW5pdGlhbF9hbW91bnQpOgogICAgICAgICIiIlNjYW4gYWxsIHBvc3NpYmxlIHRyaWFuZ3VsYXIgcGF0aHMuIiIiCiAgICAgICAgZnJvbSBpdGVydG9vbHMgaW1wb3J0IHBlcm11dGF0aW9ucwogICAgICAgIAogICAgICAgIG9wcG9ydHVuaXRpZXMgPSBbXQogICAgICAgIAogICAgICAgIGZvciBwYXRoIGluIHBlcm11dGF0aW9ucyh0b2tlbnMsIDMpOgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICByZXN1bHQgPSBzZWxmLmNhbGN1bGF0ZV90cmlhbmd1bGFyKGxpc3QocGF0aCksIGluaXRpYWxfYW1vdW50KQogICAgICAgICAgICAgICAgaWYgcmVzdWx0LmdldCgncHJvZml0YWJsZScpOgogICAgICAgICAgICAgICAgICAgIG9wcG9ydHVuaXRpZXMuYXBwZW5kKHJlc3VsdCkKICAgICAgICAgICAgZXhjZXB0OgogICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAKICAgICAgICByZXR1cm4gc29ydGVkKG9wcG9ydHVuaXRpZXMsIGtleT1sYW1iZGEgeDogeFsncHJvZml0X3BjdCddLCByZXZlcnNlPVRydWUp"><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-14-2')" type="button">Run</button></div><pre><code><span class="k">class</span> <span class="nc">TriangularArbitrage</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Find triangular arbitrage opportunities.</span>
<span class="sd">    </span>
<span class="sd">    Example: USDC -&gt; ETH -&gt; BTC -&gt; USDC</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">quoter</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">quoter</span> <span class="o">=</span> <span class="n">quoter</span>
    
    <span class="k">def</span> <span class="nf">calculate_triangular</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">initial_amount</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate return for triangular path.</span>
<span class="sd">        </span>
<span class="sd">        path: list of 3 tokens, e.g., [&#39;USDC&#39;, &#39;ETH&#39;, &#39;BTC&#39;]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Path must have exactly 3 tokens&#39;</span><span class="p">}</span>
        
        <span class="c1"># Trade 1: A -&gt; B</span>
        <span class="n">amount_b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">quoter</span><span class="o">.</span><span class="n">get_quote</span><span class="p">(</span><span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">path</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">initial_amount</span><span class="p">)</span>
        
        <span class="c1"># Trade 2: B -&gt; C</span>
        <span class="n">amount_c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">quoter</span><span class="o">.</span><span class="n">get_quote</span><span class="p">(</span><span class="n">path</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">path</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">amount_b</span><span class="p">)</span>
        
        <span class="c1"># Trade 3: C -&gt; A (back to start)</span>
        <span class="n">final_amount</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">quoter</span><span class="o">.</span><span class="n">get_quote</span><span class="p">(</span><span class="n">path</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">amount_c</span><span class="p">)</span>
        
        <span class="n">profit</span> <span class="o">=</span> <span class="n">final_amount</span> <span class="o">-</span> <span class="n">initial_amount</span>
        <span class="n">profit_pct</span> <span class="o">=</span> <span class="p">(</span><span class="n">profit</span> <span class="o">/</span> <span class="n">initial_amount</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="s1">&#39; -&gt; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39; -&gt; </span><span class="si">{</span><span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="s1">&#39;initial&#39;</span><span class="p">:</span> <span class="n">initial_amount</span><span class="p">,</span>
            <span class="s1">&#39;final&#39;</span><span class="p">:</span> <span class="n">final_amount</span><span class="p">,</span>
            <span class="s1">&#39;profit&#39;</span><span class="p">:</span> <span class="n">profit</span><span class="p">,</span>
            <span class="s1">&#39;profit_pct&#39;</span><span class="p">:</span> <span class="n">profit_pct</span><span class="p">,</span>
            <span class="s1">&#39;profitable&#39;</span><span class="p">:</span> <span class="n">profit_pct</span> <span class="o">&gt;</span> <span class="mf">0.3</span>  <span class="c1"># Need &gt;0.3% after 3 trades</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">scan_all_paths</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tokens</span><span class="p">,</span> <span class="n">initial_amount</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Scan all possible triangular paths.&quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">permutations</span>
        
        <span class="n">opportunities</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">permutations</span><span class="p">(</span><span class="n">tokens</span><span class="p">,</span> <span class="mi">3</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_triangular</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">path</span><span class="p">),</span> <span class="n">initial_amount</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;profitable&#39;</span><span class="p">):</span>
                    <span class="n">opportunities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">continue</span>
        
        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">opportunities</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;profit_pct&#39;</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre><div class="code-output" id="output-cell-14-2"></div></div>
<div class="md-cell"><h3>âœï¸ Exercise 14.1: Arbitrage Finder</h3>
<p>Build a comprehensive arbitrage detection system.</p></div>
<div class="code-cell" id="cell-14-3" data-source="IyBFeGVyY2lzZSAxNC4xCmNsYXNzIEFyYml0cmFnZVNjYW5uZXI6CiAgICBkZWYgX19pbml0X18oc2VsZik6CiAgICAgICAgc2VsZi5vcHBvcnR1bml0aWVzID0gW10KICAgIAogICAgZGVmIHNjYW5fY2V4X2RleChzZWxmLCBwYWlycywgY2V4LCBkZXgpOgogICAgICAgICMgVE9ETzogU2NhbiBmb3IgQ0VYLURFWCBhcmJpdHJhZ2UKICAgICAgICBwYXNzCiAgICAKICAgIGRlZiBzY2FuX2RleF9kZXgoc2VsZiwgcGFpcnMsIGRleGVzKToKICAgICAgICAjIFRPRE86IFNjYW4gZm9yIERFWC1ERVggYXJiaXRyYWdlCiAgICAgICAgcGFzcwogICAgCiAgICBkZWYgZXN0aW1hdGVfZXhlY3V0aW9uX2Nvc3Qoc2VsZiwgb3Bwb3J0dW5pdHkpOgogICAgICAgICMgVE9ETzogQ2FsY3VsYXRlIHRvdGFsIGNvc3QgaW5jbHVkaW5nIGdhcwogICAgICAgIHBhc3MKICAgIAogICAgZGVmIGdldF9hY3Rpb25hYmxlX29wcG9ydHVuaXRpZXMoc2VsZiwgbWluX3Byb2ZpdF91c2Q9MTApOgogICAgICAgICMgVE9ETzogRmlsdGVyIGZvciBwcm9maXRhYmxlIG9wcG9ydHVuaXRpZXMKICAgICAgICBwYXNz"><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-14-3')" type="button">Run</button></div><pre><code><span class="c1"># Exercise 14.1</span>
<span class="k">class</span> <span class="nc">ArbitrageScanner</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">opportunities</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">def</span> <span class="nf">scan_cex_dex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pairs</span><span class="p">,</span> <span class="n">cex</span><span class="p">,</span> <span class="n">dex</span><span class="p">):</span>
        <span class="c1"># TODO: Scan for CEX-DEX arbitrage</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">scan_dex_dex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pairs</span><span class="p">,</span> <span class="n">dexes</span><span class="p">):</span>
        <span class="c1"># TODO: Scan for DEX-DEX arbitrage</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">estimate_execution_cost</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">opportunity</span><span class="p">):</span>
        <span class="c1"># TODO: Calculate total cost including gas</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">get_actionable_opportunities</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">min_profit_usd</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
        <span class="c1"># TODO: Filter for profitable opportunities</span>
        <span class="k">pass</span>
</code></pre><div class="code-output" id="output-cell-14-3"></div></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">ArbitrageScanner</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gas_price_gwei</span><span class="o">=</span><span class="mi">30</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">opportunities</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gas_price_gwei</span> <span class="o">=</span> <span class="n">gas_price_gwei</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eth_price</span> <span class="o">=</span> <span class="mi">2000</span>  <span class="c1"># Update dynamically</span>

    <span class="k">def</span> <span class="nf">scan_cex_dex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pairs</span><span class="p">,</span> <span class="n">cex</span><span class="p">,</span> <span class="n">dex</span><span class="p">):</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">pairs</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">cex_ticker</span> <span class="o">=</span> <span class="n">cex</span><span class="o">.</span><span class="n">fetch_ticker</span><span class="p">(</span><span class="n">pair</span><span class="p">[</span><span class="s1">&#39;cex_symbol&#39;</span><span class="p">])</span>
                <span class="n">dex_quote</span> <span class="o">=</span> <span class="n">dex</span><span class="o">.</span><span class="n">get_quote</span><span class="p">(</span><span class="n">pair</span><span class="p">[</span><span class="s1">&#39;dex_base&#39;</span><span class="p">],</span> <span class="n">pair</span><span class="p">[</span><span class="s1">&#39;dex_quote&#39;</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>

                <span class="n">spread</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">cex_ticker</span><span class="p">[</span><span class="s1">&#39;last&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">dex_quote</span><span class="p">)</span> <span class="o">/</span> <span class="nb">min</span><span class="p">(</span><span class="n">cex_ticker</span><span class="p">[</span><span class="s1">&#39;last&#39;</span><span class="p">],</span> <span class="n">dex_quote</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>

                <span class="k">if</span> <span class="n">spread</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">:</span>  <span class="c1"># Minimum spread threshold</span>
                    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                        <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;CEX-DEX&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;pair&#39;</span><span class="p">:</span> <span class="n">pair</span><span class="p">[</span><span class="s1">&#39;cex_symbol&#39;</span><span class="p">],</span>
                        <span class="s1">&#39;cex_price&#39;</span><span class="p">:</span> <span class="n">cex_ticker</span><span class="p">[</span><span class="s1">&#39;last&#39;</span><span class="p">],</span>
                        <span class="s1">&#39;dex_price&#39;</span><span class="p">:</span> <span class="n">dex_quote</span><span class="p">,</span>
                        <span class="s1">&#39;spread_pct&#39;</span><span class="p">:</span> <span class="n">spread</span>
                    <span class="p">})</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">continue</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">opportunities</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">results</span>

    <span class="k">def</span> <span class="nf">scan_dex_dex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token_pairs</span><span class="p">,</span> <span class="n">dexes</span><span class="p">):</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">token_pairs</span><span class="p">:</span>
            <span class="n">quotes</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">dex_name</span><span class="p">,</span> <span class="n">dex</span> <span class="ow">in</span> <span class="n">dexes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">quotes</span><span class="p">[</span><span class="n">dex_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">dex</span><span class="o">.</span><span class="n">get_quote</span><span class="p">(</span><span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">continue</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">quotes</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">prices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">quotes</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
                <span class="n">spread</span> <span class="o">=</span> <span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="n">prices</span><span class="p">))</span> <span class="o">/</span> <span class="nb">min</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>

                <span class="k">if</span> <span class="n">spread</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">:</span>
                    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                        <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;DEX-DEX&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;pair&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;quotes&#39;</span><span class="p">:</span> <span class="n">quotes</span><span class="p">,</span>
                        <span class="s1">&#39;spread_pct&#39;</span><span class="p">:</span> <span class="n">spread</span>
                    <span class="p">})</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">opportunities</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">results</span>

    <span class="k">def</span> <span class="nf">estimate_execution_cost</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">opportunity</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">opportunity</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;CEX-DEX&#39;</span><span class="p">:</span>
            <span class="n">gas_units</span> <span class="o">=</span> <span class="mi">250000</span>  <span class="c1"># Swap + withdrawal/deposit</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">gas_units</span> <span class="o">=</span> <span class="mi">300000</span>  <span class="c1"># Two swaps</span>

        <span class="n">gas_cost_eth</span> <span class="o">=</span> <span class="p">(</span><span class="n">gas_units</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">gas_price_gwei</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1e9</span>
        <span class="n">gas_cost_usd</span> <span class="o">=</span> <span class="n">gas_cost_eth</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">eth_price</span>

        <span class="k">return</span> <span class="n">gas_cost_usd</span>

    <span class="k">def</span> <span class="nf">get_actionable_opportunities</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">min_profit_usd</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">trade_size_usd</span><span class="o">=</span><span class="mi">10000</span><span class="p">):</span>
        <span class="n">actionable</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">opp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">opportunities</span><span class="p">:</span>
            <span class="n">gas_cost</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">estimate_execution_cost</span><span class="p">(</span><span class="n">opp</span><span class="p">)</span>
            <span class="n">gross_profit</span> <span class="o">=</span> <span class="n">trade_size_usd</span> <span class="o">*</span> <span class="n">opp</span><span class="p">[</span><span class="s1">&#39;spread_pct&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">100</span>
            <span class="n">net_profit</span> <span class="o">=</span> <span class="n">gross_profit</span> <span class="o">-</span> <span class="n">gas_cost</span>

            <span class="k">if</span> <span class="n">net_profit</span> <span class="o">&gt;=</span> <span class="n">min_profit_usd</span><span class="p">:</span>
                <span class="n">opp</span><span class="p">[</span><span class="s1">&#39;gas_cost_usd&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gas_cost</span>
                <span class="n">opp</span><span class="p">[</span><span class="s1">&#39;estimated_profit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">net_profit</span>
                <span class="n">actionable</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">opp</span><span class="p">)</span>

        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">actionable</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;estimated_profit&#39;</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>Section 2: Liquidity Provision</h1></div>
<div class="code-cell" id="cell-14-4" data-source="aW1wb3J0IG1hdGgKCmNsYXNzIExpcXVpZGl0eUFuYWx5emVyOgogICAgIiIiQW5hbHl6ZSBsaXF1aWRpdHkgcHJvdmlzaW9uIG9wcG9ydHVuaXRpZXMuIiIiCiAgICAKICAgIGRlZiBjYWxjdWxhdGVfaW1wZXJtYW5lbnRfbG9zcyhzZWxmLCBwcmljZV9yYXRpbyk6CiAgICAgICAgIiIiCiAgICAgICAgQ2FsY3VsYXRlIElMIGZvciBhIGdpdmVuIHByaWNlIGNoYW5nZSByYXRpby4KICAgICAgICAKICAgICAgICBwcmljZV9yYXRpbzogbmV3X3ByaWNlIC8gb2xkX3ByaWNlIChlLmcuLCAyLjAgPSBwcmljZSBkb3VibGVkKQogICAgICAgICIiIgogICAgICAgIHNxcnRfcmF0aW8gPSBtYXRoLnNxcnQocHJpY2VfcmF0aW8pCiAgICAgICAgaWwgPSAoMiAqIHNxcnRfcmF0aW8gLyAoMSArIHByaWNlX3JhdGlvKSkgLSAxCiAgICAgICAgcmV0dXJuIGlsICogMTAwICAjIFJldHVybiBhcyBwZXJjZW50YWdlCiAgICAKICAgIGRlZiBjYWxjdWxhdGVfbHBfdmFsdWUoc2VsZiwgaW5pdGlhbF90b2tlbl9hLCBpbml0aWFsX3Rva2VuX2IsIAogICAgICAgICAgICAgICAgICAgICAgICAgICBpbml0aWFsX3ByaWNlLCBjdXJyZW50X3ByaWNlKToKICAgICAgICAiIiIKICAgICAgICBDYWxjdWxhdGUgY3VycmVudCB2YWx1ZSBvZiBMUCBwb3NpdGlvbiB2cyBob2xkaW5nLgogICAgICAgICIiIgogICAgICAgIHByaWNlX3JhdGlvID0gY3VycmVudF9wcmljZSAvIGluaXRpYWxfcHJpY2UKICAgICAgICAKICAgICAgICAjIFZhbHVlIGlmIGp1c3QgaGVsZAogICAgICAgIGhlbGRfdmFsdWUgPSBpbml0aWFsX3Rva2VuX2EgKiBjdXJyZW50X3ByaWNlICsgaW5pdGlhbF90b2tlbl9iCiAgICAgICAgCiAgICAgICAgIyBMUCBwb3NpdGlvbiB2YWx1ZSAocmViYWxhbmNlcyBhdXRvbWF0aWNhbGx5KQogICAgICAgIGsgPSBpbml0aWFsX3Rva2VuX2EgKiBpbml0aWFsX3Rva2VuX2IKICAgICAgICBuZXdfdG9rZW5fYSA9IG1hdGguc3FydChrIC8gcHJpY2VfcmF0aW8pCiAgICAgICAgbmV3X3Rva2VuX2IgPSBtYXRoLnNxcnQoayAqIHByaWNlX3JhdGlvKQogICAgICAgIGxwX3ZhbHVlID0gbmV3X3Rva2VuX2EgKiBjdXJyZW50X3ByaWNlICsgbmV3X3Rva2VuX2IKICAgICAgICAKICAgICAgICBpbF9wY3QgPSAobHBfdmFsdWUgLSBoZWxkX3ZhbHVlKSAvIGhlbGRfdmFsdWUgKiAxMDAKICAgICAgICAKICAgICAgICByZXR1cm4gewogICAgICAgICAgICAnaGVsZF92YWx1ZSc6IGhlbGRfdmFsdWUsCiAgICAgICAgICAgICdscF92YWx1ZSc6IGxwX3ZhbHVlLAogICAgICAgICAgICAnaW1wZXJtYW5lbnRfbG9zc19wY3QnOiBpbF9wY3QsCiAgICAgICAgICAgICduZXdfdG9rZW5fYSc6IG5ld190b2tlbl9hLAogICAgICAgICAgICAnbmV3X3Rva2VuX2InOiBuZXdfdG9rZW5fYgogICAgICAgIH0KICAgIAogICAgZGVmIGJyZWFrZXZlbl9hcHIoc2VsZiwgZXhwZWN0ZWRfcHJpY2VfY2hhbmdlX3BjdCk6CiAgICAgICAgIiIiCiAgICAgICAgQ2FsY3VsYXRlIEFQUiBuZWVkZWQgdG8gb2Zmc2V0IGV4cGVjdGVkIElMLgogICAgICAgICIiIgogICAgICAgIHByaWNlX3JhdGlvID0gMSArIGV4cGVjdGVkX3ByaWNlX2NoYW5nZV9wY3QgLyAxMDAKICAgICAgICBpbCA9IGFicyhzZWxmLmNhbGN1bGF0ZV9pbXBlcm1hbmVudF9sb3NzKHByaWNlX3JhdGlvKSkKICAgICAgICByZXR1cm4gaWwgICMgTmVlZCBhdCBsZWFzdCB0aGlzIEFQUiB0byBicmVhayBldmVuCgphbmFseXplciA9IExpcXVpZGl0eUFuYWx5emVyKCkKcHJpbnQoJ0lMIGZvciB2YXJpb3VzIHByaWNlIGNoYW5nZXM6JykKZm9yIGNoYW5nZSBpbiBbMC41LCAwLjc1LCAxLjAsIDEuNSwgMi4wLCAzLjBdOgogICAgaWwgPSBhbmFseXplci5jYWxjdWxhdGVfaW1wZXJtYW5lbnRfbG9zcyhjaGFuZ2UpCiAgICBwcmludChmJyAge2NoYW5nZX14IHByaWNlOiB7aWw6LjJmfSUgSUwnKQ=="><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-14-4')" type="button">Run</button></div><pre><code><span class="kn">import</span> <span class="nn">math</span>

<span class="k">class</span> <span class="nc">LiquidityAnalyzer</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Analyze liquidity provision opportunities.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="nf">calculate_impermanent_loss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">price_ratio</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate IL for a given price change ratio.</span>
<span class="sd">        </span>
<span class="sd">        price_ratio: new_price / old_price (e.g., 2.0 = price doubled)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sqrt_ratio</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">price_ratio</span><span class="p">)</span>
        <span class="n">il</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">sqrt_ratio</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">price_ratio</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">il</span> <span class="o">*</span> <span class="mi">100</span>  <span class="c1"># Return as percentage</span>
    
    <span class="k">def</span> <span class="nf">calculate_lp_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">initial_token_a</span><span class="p">,</span> <span class="n">initial_token_b</span><span class="p">,</span> 
                           <span class="n">initial_price</span><span class="p">,</span> <span class="n">current_price</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate current value of LP position vs holding.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">price_ratio</span> <span class="o">=</span> <span class="n">current_price</span> <span class="o">/</span> <span class="n">initial_price</span>
        
        <span class="c1"># Value if just held</span>
        <span class="n">held_value</span> <span class="o">=</span> <span class="n">initial_token_a</span> <span class="o">*</span> <span class="n">current_price</span> <span class="o">+</span> <span class="n">initial_token_b</span>
        
        <span class="c1"># LP position value (rebalances automatically)</span>
        <span class="n">k</span> <span class="o">=</span> <span class="n">initial_token_a</span> <span class="o">*</span> <span class="n">initial_token_b</span>
        <span class="n">new_token_a</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">k</span> <span class="o">/</span> <span class="n">price_ratio</span><span class="p">)</span>
        <span class="n">new_token_b</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">k</span> <span class="o">*</span> <span class="n">price_ratio</span><span class="p">)</span>
        <span class="n">lp_value</span> <span class="o">=</span> <span class="n">new_token_a</span> <span class="o">*</span> <span class="n">current_price</span> <span class="o">+</span> <span class="n">new_token_b</span>
        
        <span class="n">il_pct</span> <span class="o">=</span> <span class="p">(</span><span class="n">lp_value</span> <span class="o">-</span> <span class="n">held_value</span><span class="p">)</span> <span class="o">/</span> <span class="n">held_value</span> <span class="o">*</span> <span class="mi">100</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;held_value&#39;</span><span class="p">:</span> <span class="n">held_value</span><span class="p">,</span>
            <span class="s1">&#39;lp_value&#39;</span><span class="p">:</span> <span class="n">lp_value</span><span class="p">,</span>
            <span class="s1">&#39;impermanent_loss_pct&#39;</span><span class="p">:</span> <span class="n">il_pct</span><span class="p">,</span>
            <span class="s1">&#39;new_token_a&#39;</span><span class="p">:</span> <span class="n">new_token_a</span><span class="p">,</span>
            <span class="s1">&#39;new_token_b&#39;</span><span class="p">:</span> <span class="n">new_token_b</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">breakeven_apr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expected_price_change_pct</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate APR needed to offset expected IL.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">price_ratio</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">expected_price_change_pct</span> <span class="o">/</span> <span class="mi">100</span>
        <span class="n">il</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calculate_impermanent_loss</span><span class="p">(</span><span class="n">price_ratio</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">il</span>  <span class="c1"># Need at least this APR to break even</span>

<span class="n">analyzer</span> <span class="o">=</span> <span class="n">LiquidityAnalyzer</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;IL for various price changes:&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">change</span> <span class="ow">in</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">]:</span>
    <span class="n">il</span> <span class="o">=</span> <span class="n">analyzer</span><span class="o">.</span><span class="n">calculate_impermanent_loss</span><span class="p">(</span><span class="n">change</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;  </span><span class="si">{</span><span class="n">change</span><span class="si">}</span><span class="s1">x price: </span><span class="si">{</span><span class="n">il</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">% IL&#39;</span><span class="p">)</span>
</code></pre><div class="code-output" id="output-cell-14-4"></div></div>
<div class="md-cell"><h3>âœï¸ Exercise 14.2: LP Position Analyzer</h3>
<p>Build a comprehensive LP position analyzer.</p></div>
<div class="code-cell" id="cell-14-5" data-source="IyBFeGVyY2lzZSAxNC4yCmNsYXNzIExQUG9zaXRpb25BbmFseXplcjoKICAgIGRlZiBfX2luaXRfXyhzZWxmKToKICAgICAgICBzZWxmLnBvc2l0aW9ucyA9IFtdCiAgICAKICAgIGRlZiBhZGRfcG9zaXRpb24oc2VsZiwgcG9vbCwgdG9rZW5fYV9hbW91bnQsIHRva2VuX2JfYW1vdW50LCBlbnRyeV9wcmljZSk6CiAgICAgICAgIyBUT0RPCiAgICAgICAgcGFzcwogICAgCiAgICBkZWYgY2FsY3VsYXRlX3BubChzZWxmLCBwb3NpdGlvbiwgY3VycmVudF9wcmljZSwgZmVlc19lYXJuZWQpOgogICAgICAgICMgVE9ETzogQ2FsY3VsYXRlIHRvdGFsIFBuTCBpbmNsdWRpbmcgZmVlcyBhbmQgSUwKICAgICAgICBwYXNzCiAgICAKICAgIGRlZiBzaG91bGRfZXhpdChzZWxmLCBwb3NpdGlvbiwgY3VycmVudF9wcmljZSwgZmVlc19lYXJuZWQpOgogICAgICAgICMgVE9ETzogUmVjb21tZW5kIHdoZXRoZXIgdG8gZXhpdCBwb3NpdGlvbgogICAgICAgIHBhc3M="><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-14-5')" type="button">Run</button></div><pre><code><span class="c1"># Exercise 14.2</span>
<span class="k">class</span> <span class="nc">LPPositionAnalyzer</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">positions</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">def</span> <span class="nf">add_position</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pool</span><span class="p">,</span> <span class="n">token_a_amount</span><span class="p">,</span> <span class="n">token_b_amount</span><span class="p">,</span> <span class="n">entry_price</span><span class="p">):</span>
        <span class="c1"># TODO</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">calculate_pnl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">position</span><span class="p">,</span> <span class="n">current_price</span><span class="p">,</span> <span class="n">fees_earned</span><span class="p">):</span>
        <span class="c1"># TODO: Calculate total PnL including fees and IL</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">should_exit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">position</span><span class="p">,</span> <span class="n">current_price</span><span class="p">,</span> <span class="n">fees_earned</span><span class="p">):</span>
        <span class="c1"># TODO: Recommend whether to exit position</span>
        <span class="k">pass</span>
</code></pre><div class="code-output" id="output-cell-14-5"></div></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">LPPositionAnalyzer</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">positions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">analyzer</span> <span class="o">=</span> <span class="n">LiquidityAnalyzer</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">add_position</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pool</span><span class="p">,</span> <span class="n">token_a_amount</span><span class="p">,</span> <span class="n">token_b_amount</span><span class="p">,</span> <span class="n">entry_price</span><span class="p">):</span>
        <span class="n">position</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;pool&#39;</span><span class="p">:</span> <span class="n">pool</span><span class="p">,</span>
            <span class="s1">&#39;token_a_initial&#39;</span><span class="p">:</span> <span class="n">token_a_amount</span><span class="p">,</span>
            <span class="s1">&#39;token_b_initial&#39;</span><span class="p">:</span> <span class="n">token_b_amount</span><span class="p">,</span>
            <span class="s1">&#39;entry_price&#39;</span><span class="p">:</span> <span class="n">entry_price</span><span class="p">,</span>
            <span class="s1">&#39;entry_value&#39;</span><span class="p">:</span> <span class="n">token_a_amount</span> <span class="o">*</span> <span class="n">entry_price</span> <span class="o">+</span> <span class="n">token_b_amount</span><span class="p">,</span>
            <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">position</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">position</span>

    <span class="k">def</span> <span class="nf">calculate_pnl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">position</span><span class="p">,</span> <span class="n">current_price</span><span class="p">,</span> <span class="n">fees_earned</span><span class="p">):</span>
        <span class="c1"># Calculate LP value with IL</span>
        <span class="n">lp_calc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyzer</span><span class="o">.</span><span class="n">calculate_lp_value</span><span class="p">(</span>
            <span class="n">position</span><span class="p">[</span><span class="s1">&#39;token_a_initial&#39;</span><span class="p">],</span>
            <span class="n">position</span><span class="p">[</span><span class="s1">&#39;token_b_initial&#39;</span><span class="p">],</span>
            <span class="n">position</span><span class="p">[</span><span class="s1">&#39;entry_price&#39;</span><span class="p">],</span>
            <span class="n">current_price</span>
        <span class="p">)</span>

        <span class="c1"># Total PnL</span>
        <span class="n">current_value</span> <span class="o">=</span> <span class="n">lp_calc</span><span class="p">[</span><span class="s1">&#39;lp_value&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">fees_earned</span>
        <span class="n">total_pnl</span> <span class="o">=</span> <span class="n">current_value</span> <span class="o">-</span> <span class="n">position</span><span class="p">[</span><span class="s1">&#39;entry_value&#39;</span><span class="p">]</span>
        <span class="n">total_pnl_pct</span> <span class="o">=</span> <span class="n">total_pnl</span> <span class="o">/</span> <span class="n">position</span><span class="p">[</span><span class="s1">&#39;entry_value&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;entry_value&#39;</span><span class="p">:</span> <span class="n">position</span><span class="p">[</span><span class="s1">&#39;entry_value&#39;</span><span class="p">],</span>
            <span class="s1">&#39;lp_value&#39;</span><span class="p">:</span> <span class="n">lp_calc</span><span class="p">[</span><span class="s1">&#39;lp_value&#39;</span><span class="p">],</span>
            <span class="s1">&#39;fees_earned&#39;</span><span class="p">:</span> <span class="n">fees_earned</span><span class="p">,</span>
            <span class="s1">&#39;current_value&#39;</span><span class="p">:</span> <span class="n">current_value</span><span class="p">,</span>
            <span class="s1">&#39;impermanent_loss_pct&#39;</span><span class="p">:</span> <span class="n">lp_calc</span><span class="p">[</span><span class="s1">&#39;impermanent_loss_pct&#39;</span><span class="p">],</span>
            <span class="s1">&#39;total_pnl&#39;</span><span class="p">:</span> <span class="n">total_pnl</span><span class="p">,</span>
            <span class="s1">&#39;total_pnl_pct&#39;</span><span class="p">:</span> <span class="n">total_pnl_pct</span><span class="p">,</span>
            <span class="s1">&#39;fees_offset_il&#39;</span><span class="p">:</span> <span class="n">fees_earned</span> <span class="o">&gt;</span> <span class="nb">abs</span><span class="p">(</span><span class="n">lp_calc</span><span class="p">[</span><span class="s1">&#39;impermanent_loss_pct&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">position</span><span class="p">[</span><span class="s1">&#39;entry_value&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">should_exit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">position</span><span class="p">,</span> <span class="n">current_price</span><span class="p">,</span> <span class="n">fees_earned</span><span class="p">,</span> <span class="n">price_outlook</span><span class="o">=</span><span class="s1">&#39;neutral&#39;</span><span class="p">):</span>
        <span class="n">pnl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_pnl</span><span class="p">(</span><span class="n">position</span><span class="p">,</span> <span class="n">current_price</span><span class="p">,</span> <span class="n">fees_earned</span><span class="p">)</span>

        <span class="n">reasons_to_exit</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">reasons_to_stay</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Check IL</span>
        <span class="k">if</span> <span class="n">pnl</span><span class="p">[</span><span class="s1">&#39;impermanent_loss_pct&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">10</span><span class="p">:</span>
            <span class="n">reasons_to_exit</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;High IL: </span><span class="si">{</span><span class="n">pnl</span><span class="p">[</span><span class="s1">&#39;impermanent_loss_pct&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>

        <span class="c1"># Check if fees covering IL</span>
        <span class="k">if</span> <span class="n">pnl</span><span class="p">[</span><span class="s1">&#39;fees_offset_il&#39;</span><span class="p">]:</span>
            <span class="n">reasons_to_stay</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Fees are covering IL&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">reasons_to_exit</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Fees not covering IL&#39;</span><span class="p">)</span>

        <span class="c1"># Price outlook</span>
        <span class="k">if</span> <span class="n">price_outlook</span> <span class="o">==</span> <span class="s1">&#39;volatile&#39;</span><span class="p">:</span>
            <span class="n">reasons_to_exit</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Expected volatility will increase IL&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">price_outlook</span> <span class="o">==</span> <span class="s1">&#39;stable&#39;</span><span class="p">:</span>
            <span class="n">reasons_to_stay</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Stable prices minimize IL risk&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;recommendation&#39;</span><span class="p">:</span> <span class="s1">&#39;EXIT&#39;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">reasons_to_exit</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">reasons_to_stay</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;HOLD&#39;</span><span class="p">,</span>
            <span class="s1">&#39;reasons_to_exit&#39;</span><span class="p">:</span> <span class="n">reasons_to_exit</span><span class="p">,</span>
            <span class="s1">&#39;reasons_to_stay&#39;</span><span class="p">:</span> <span class="n">reasons_to_stay</span><span class="p">,</span>
            <span class="s1">&#39;current_pnl&#39;</span><span class="p">:</span> <span class="n">pnl</span>
        <span class="p">}</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>Section 3: Yield Farming Analysis</h1></div>
<div class="code-cell" id="cell-14-6" data-source="Y2xhc3MgWWllbGRGYXJtaW5nQW5hbHl6ZXI6CiAgICAiIiJBbmFseXplIGFuZCBjb21wYXJlIHlpZWxkIGZhcm1pbmcgb3Bwb3J0dW5pdGllcy4iIiIKICAgIAogICAgZGVmIGNhbGN1bGF0ZV9hcHlfZnJvbV9hcHIoc2VsZiwgYXByLCBjb21wb3VuZHNfcGVyX3llYXI9MzY1KToKICAgICAgICAiIiJDb252ZXJ0IEFQUiB0byBBUFkgd2l0aCBjb21wb3VuZGluZy4iIiIKICAgICAgICByZXR1cm4gKDEgKyBhcHIgLyBjb21wb3VuZHNfcGVyX3llYXIpICoqIGNvbXBvdW5kc19wZXJfeWVhciAtIDEKICAgIAogICAgZGVmIGNhbGN1bGF0ZV9yZWFsX3lpZWxkKHNlbGYsIGJhc2VfYXB5LCB0b2tlbl9pbmZsYXRpb24sIHRva2VuX3ByaWNlX2NoYW5nZV9leHBlY3RlZCk6CiAgICAgICAgIiIiCiAgICAgICAgQ2FsY3VsYXRlIHJlYWwgeWllbGQgYWNjb3VudGluZyBmb3IgdG9rZW4gZW1pc3Npb25zLgogICAgICAgIAogICAgICAgIE1hbnkgZmFybXMgcGF5IHJld2FyZHMgaW4gaW5mbGF0aW9uYXJ5IHRva2Vucy4KICAgICAgICAiIiIKICAgICAgICAjIElmIHJld2FyZCB0b2tlbiBpcyBleHBlY3RlZCB0byBkZWNyZWFzZSBpbiB2YWx1ZQogICAgICAgIGFkanVzdGVkX2FweSA9IGJhc2VfYXB5ICogKDEgKyB0b2tlbl9wcmljZV9jaGFuZ2VfZXhwZWN0ZWQpCiAgICAgICAgCiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgJ2FkdmVydGlzZWRfYXB5JzogYmFzZV9hcHkgKiAxMDAsCiAgICAgICAgICAgICdhZGp1c3RlZF9hcHknOiBhZGp1c3RlZF9hcHkgKiAxMDAsCiAgICAgICAgICAgICd3YXJuaW5nJzogJ1Jld2FyZCB0b2tlbiBtYXkgZGVjcmVhc2UgaW4gdmFsdWUnIGlmIHRva2VuX3ByaWNlX2NoYW5nZV9leHBlY3RlZCA8IDAgZWxzZSBOb25lCiAgICAgICAgfQogICAgCiAgICBkZWYgcmlza19zY29yZShzZWxmLCB0dmwsIGFnZV9kYXlzLCBhdWRpdGVkLCB0b2tlbl9lbWlzc2lvbnMpOgogICAgICAgICIiIgogICAgICAgIENhbGN1bGF0ZSByaXNrIHNjb3JlIGZvciBhIGZhcm0gKDEtMTAsIGxvd2VyIGlzIHNhZmVyKS4KICAgICAgICAiIiIKICAgICAgICBzY29yZSA9IDUKICAgICAgICAKICAgICAgICAjIFRWTCBmYWN0b3IKICAgICAgICBpZiB0dmwgPiAxMDBfMDAwXzAwMDoKICAgICAgICAgICAgc2NvcmUgLT0gMgogICAgICAgIGVsaWYgdHZsID4gMTBfMDAwXzAwMDoKICAgICAgICAgICAgc2NvcmUgLT0gMQogICAgICAgIGVsaWYgdHZsIDwgMV8wMDBfMDAwOgogICAgICAgICAgICBzY29yZSArPSAyCiAgICAgICAgCiAgICAgICAgIyBBZ2UgZmFjdG9yCiAgICAgICAgaWYgYWdlX2RheXMgPiAzNjU6CiAgICAgICAgICAgIHNjb3JlIC09IDEKICAgICAgICBlbGlmIGFnZV9kYXlzIDwgMzA6CiAgICAgICAgICAgIHNjb3JlICs9IDIKICAgICAgICAKICAgICAgICAjIEF1ZGl0IGZhY3RvcgogICAgICAgIGlmIGF1ZGl0ZWQ6CiAgICAgICAgICAgIHNjb3JlIC09IDEKICAgICAgICBlbHNlOgogICAgICAgICAgICBzY29yZSArPSAyCiAgICAgICAgCiAgICAgICAgIyBFbWlzc2lvbnMgZmFjdG9yIChoaWdoIGVtaXNzaW9ucyA9IGhpZ2ggcmlzaykKICAgICAgICBpZiB0b2tlbl9lbWlzc2lvbnMgPiA1MDogICMgPjUwJSBBUFkgZnJvbSBlbWlzc2lvbnMKICAgICAgICAgICAgc2NvcmUgKz0gMQogICAgICAgIAogICAgICAgIHJldHVybiBtYXgoMSwgbWluKDEwLCBzY29yZSkpCiAgICAKICAgIGRlZiBjb21wYXJlX29wcG9ydHVuaXRpZXMoc2VsZiwgZmFybXMpOgogICAgICAgICIiIkNvbXBhcmUgbXVsdGlwbGUgZmFybWluZyBvcHBvcnR1bml0aWVzLiIiIgogICAgICAgIGZvciBmYXJtIGluIGZhcm1zOgogICAgICAgICAgICBmYXJtWydyaXNrX3Njb3JlJ10gPSBzZWxmLnJpc2tfc2NvcmUoCiAgICAgICAgICAgICAgICBmYXJtWyd0dmwnXSwKICAgICAgICAgICAgICAgIGZhcm1bJ2FnZV9kYXlzJ10sCiAgICAgICAgICAgICAgICBmYXJtWydhdWRpdGVkJ10sCiAgICAgICAgICAgICAgICBmYXJtLmdldCgnZW1pc3Npb25fYXB5JywgMCkKICAgICAgICAgICAgKQogICAgICAgICAgICBmYXJtWydyaXNrX2FkanVzdGVkX2FweSddID0gZmFybVsnYXB5J10gLyBmYXJtWydyaXNrX3Njb3JlJ10KICAgICAgICAKICAgICAgICByZXR1cm4gc29ydGVkKGZhcm1zLCBrZXk9bGFtYmRhIHg6IHhbJ3Jpc2tfYWRqdXN0ZWRfYXB5J10sIHJldmVyc2U9VHJ1ZSk="><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-14-6')" type="button">Run</button></div><pre><code><span class="k">class</span> <span class="nc">YieldFarmingAnalyzer</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Analyze and compare yield farming opportunities.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="nf">calculate_apy_from_apr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">apr</span><span class="p">,</span> <span class="n">compounds_per_year</span><span class="o">=</span><span class="mi">365</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convert APR to APY with compounding.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">apr</span> <span class="o">/</span> <span class="n">compounds_per_year</span><span class="p">)</span> <span class="o">**</span> <span class="n">compounds_per_year</span> <span class="o">-</span> <span class="mi">1</span>
    
    <span class="k">def</span> <span class="nf">calculate_real_yield</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base_apy</span><span class="p">,</span> <span class="n">token_inflation</span><span class="p">,</span> <span class="n">token_price_change_expected</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate real yield accounting for token emissions.</span>
<span class="sd">        </span>
<span class="sd">        Many farms pay rewards in inflationary tokens.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># If reward token is expected to decrease in value</span>
        <span class="n">adjusted_apy</span> <span class="o">=</span> <span class="n">base_apy</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">token_price_change_expected</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;advertised_apy&#39;</span><span class="p">:</span> <span class="n">base_apy</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
            <span class="s1">&#39;adjusted_apy&#39;</span><span class="p">:</span> <span class="n">adjusted_apy</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
            <span class="s1">&#39;warning&#39;</span><span class="p">:</span> <span class="s1">&#39;Reward token may decrease in value&#39;</span> <span class="k">if</span> <span class="n">token_price_change_expected</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">risk_score</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tvl</span><span class="p">,</span> <span class="n">age_days</span><span class="p">,</span> <span class="n">audited</span><span class="p">,</span> <span class="n">token_emissions</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate risk score for a farm (1-10, lower is safer).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">score</span> <span class="o">=</span> <span class="mi">5</span>
        
        <span class="c1"># TVL factor</span>
        <span class="k">if</span> <span class="n">tvl</span> <span class="o">&gt;</span> <span class="mi">100_000_000</span><span class="p">:</span>
            <span class="n">score</span> <span class="o">-=</span> <span class="mi">2</span>
        <span class="k">elif</span> <span class="n">tvl</span> <span class="o">&gt;</span> <span class="mi">10_000_000</span><span class="p">:</span>
            <span class="n">score</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">tvl</span> <span class="o">&lt;</span> <span class="mi">1_000_000</span><span class="p">:</span>
            <span class="n">score</span> <span class="o">+=</span> <span class="mi">2</span>
        
        <span class="c1"># Age factor</span>
        <span class="k">if</span> <span class="n">age_days</span> <span class="o">&gt;</span> <span class="mi">365</span><span class="p">:</span>
            <span class="n">score</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">age_days</span> <span class="o">&lt;</span> <span class="mi">30</span><span class="p">:</span>
            <span class="n">score</span> <span class="o">+=</span> <span class="mi">2</span>
        
        <span class="c1"># Audit factor</span>
        <span class="k">if</span> <span class="n">audited</span><span class="p">:</span>
            <span class="n">score</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">score</span> <span class="o">+=</span> <span class="mi">2</span>
        
        <span class="c1"># Emissions factor (high emissions = high risk)</span>
        <span class="k">if</span> <span class="n">token_emissions</span> <span class="o">&gt;</span> <span class="mi">50</span><span class="p">:</span>  <span class="c1"># &gt;50% APY from emissions</span>
            <span class="n">score</span> <span class="o">+=</span> <span class="mi">1</span>
        
        <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">score</span><span class="p">))</span>
    
    <span class="k">def</span> <span class="nf">compare_opportunities</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">farms</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compare multiple farming opportunities.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">farm</span> <span class="ow">in</span> <span class="n">farms</span><span class="p">:</span>
            <span class="n">farm</span><span class="p">[</span><span class="s1">&#39;risk_score&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">risk_score</span><span class="p">(</span>
                <span class="n">farm</span><span class="p">[</span><span class="s1">&#39;tvl&#39;</span><span class="p">],</span>
                <span class="n">farm</span><span class="p">[</span><span class="s1">&#39;age_days&#39;</span><span class="p">],</span>
                <span class="n">farm</span><span class="p">[</span><span class="s1">&#39;audited&#39;</span><span class="p">],</span>
                <span class="n">farm</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;emission_apy&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">farm</span><span class="p">[</span><span class="s1">&#39;risk_adjusted_apy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">farm</span><span class="p">[</span><span class="s1">&#39;apy&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">farm</span><span class="p">[</span><span class="s1">&#39;risk_score&#39;</span><span class="p">]</span>
        
        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">farms</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;risk_adjusted_apy&#39;</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre><div class="code-output" id="output-cell-14-6"></div></div>
<div class="md-cell"><h3>âœï¸ Exercise 14.3: Yield Tracker</h3>
<p>Build a yield farming tracker and optimizer.</p></div>
<div class="code-cell" id="cell-14-7" data-source="IyBFeGVyY2lzZSAxNC4zCmNsYXNzIFlpZWxkVHJhY2tlcjoKICAgIGRlZiBfX2luaXRfXyhzZWxmKToKICAgICAgICBzZWxmLmFjdGl2ZV9wb3NpdGlvbnMgPSBbXQogICAgICAgIHNlbGYuaGlzdG9yaWNhbF95aWVsZHMgPSBbXQogICAgCiAgICBkZWYgYWRkX3Bvc2l0aW9uKHNlbGYsIHByb3RvY29sLCBwb29sLCBhbW91bnQsIGVudHJ5X2FweSk6CiAgICAgICAgIyBUT0RPCiAgICAgICAgcGFzcwogICAgCiAgICBkZWYgY2FsY3VsYXRlX2Vhcm5pbmdzKHNlbGYsIHBvc2l0aW9uLCBkYXlzKToKICAgICAgICAjIFRPRE8KICAgICAgICBwYXNzCiAgICAKICAgIGRlZiBvcHRpbWl6ZV9hbGxvY2F0aW9uKHNlbGYsIHRvdGFsX2NhcGl0YWwsIG9wcG9ydHVuaXRpZXMsIHJpc2tfdG9sZXJhbmNlPSdtZWRpdW0nKToKICAgICAgICAjIFRPRE86IFN1Z2dlc3Qgb3B0aW1hbCBhbGxvY2F0aW9uCiAgICAgICAgcGFzcw=="><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-14-7')" type="button">Run</button></div><pre><code><span class="c1"># Exercise 14.3</span>
<span class="k">class</span> <span class="nc">YieldTracker</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">active_positions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">historical_yields</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">def</span> <span class="nf">add_position</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">protocol</span><span class="p">,</span> <span class="n">pool</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">entry_apy</span><span class="p">):</span>
        <span class="c1"># TODO</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">calculate_earnings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">position</span><span class="p">,</span> <span class="n">days</span><span class="p">):</span>
        <span class="c1"># TODO</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">optimize_allocation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">total_capital</span><span class="p">,</span> <span class="n">opportunities</span><span class="p">,</span> <span class="n">risk_tolerance</span><span class="o">=</span><span class="s1">&#39;medium&#39;</span><span class="p">):</span>
        <span class="c1"># TODO: Suggest optimal allocation</span>
        <span class="k">pass</span>
</code></pre><div class="code-output" id="output-cell-14-7"></div></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">YieldTracker</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">active_positions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">historical_yields</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">analyzer</span> <span class="o">=</span> <span class="n">YieldFarmingAnalyzer</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">add_position</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">protocol</span><span class="p">,</span> <span class="n">pool</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">entry_apy</span><span class="p">):</span>
        <span class="n">position</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">active_positions</span><span class="p">),</span>
            <span class="s1">&#39;protocol&#39;</span><span class="p">:</span> <span class="n">protocol</span><span class="p">,</span>
            <span class="s1">&#39;pool&#39;</span><span class="p">:</span> <span class="n">pool</span><span class="p">,</span>
            <span class="s1">&#39;principal&#39;</span><span class="p">:</span> <span class="n">amount</span><span class="p">,</span>
            <span class="s1">&#39;entry_apy&#39;</span><span class="p">:</span> <span class="n">entry_apy</span><span class="p">,</span>
            <span class="s1">&#39;entry_date&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
            <span class="s1">&#39;accumulated_yield&#39;</span><span class="p">:</span> <span class="mi">0</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">active_positions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">position</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">position</span>

    <span class="k">def</span> <span class="nf">calculate_earnings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">position</span><span class="p">,</span> <span class="n">days</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">days</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">days</span> <span class="o">=</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">position</span><span class="p">[</span><span class="s1">&#39;entry_date&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">days</span>

        <span class="n">daily_rate</span> <span class="o">=</span> <span class="n">position</span><span class="p">[</span><span class="s1">&#39;entry_apy&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">365</span>
        <span class="n">earnings</span> <span class="o">=</span> <span class="n">position</span><span class="p">[</span><span class="s1">&#39;principal&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">daily_rate</span> <span class="o">*</span> <span class="n">days</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;principal&#39;</span><span class="p">:</span> <span class="n">position</span><span class="p">[</span><span class="s1">&#39;principal&#39;</span><span class="p">],</span>
            <span class="s1">&#39;days&#39;</span><span class="p">:</span> <span class="n">days</span><span class="p">,</span>
            <span class="s1">&#39;earnings&#39;</span><span class="p">:</span> <span class="n">earnings</span><span class="p">,</span>
            <span class="s1">&#39;total_value&#39;</span><span class="p">:</span> <span class="n">position</span><span class="p">[</span><span class="s1">&#39;principal&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">earnings</span><span class="p">,</span>
            <span class="s1">&#39;effective_apy&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">earnings</span> <span class="o">/</span> <span class="n">position</span><span class="p">[</span><span class="s1">&#39;principal&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="mi">365</span> <span class="o">/</span> <span class="n">days</span><span class="p">)</span> <span class="k">if</span> <span class="n">days</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">optimize_allocation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">total_capital</span><span class="p">,</span> <span class="n">opportunities</span><span class="p">,</span> <span class="n">risk_tolerance</span><span class="o">=</span><span class="s1">&#39;medium&#39;</span><span class="p">):</span>
        <span class="c1"># Risk tolerance -&gt; max risk score</span>
        <span class="n">risk_limits</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;low&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;medium&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;high&#39;</span><span class="p">:</span> <span class="mi">8</span><span class="p">}</span>
        <span class="n">max_risk</span> <span class="o">=</span> <span class="n">risk_limits</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">risk_tolerance</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>

        <span class="c1"># Filter by risk</span>
        <span class="n">eligible</span> <span class="o">=</span> <span class="p">[</span><span class="n">o</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">opportunities</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyzer</span><span class="o">.</span><span class="n">risk_score</span><span class="p">(</span>
            <span class="n">o</span><span class="p">[</span><span class="s1">&#39;tvl&#39;</span><span class="p">],</span> <span class="n">o</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;age_days&#39;</span><span class="p">,</span> <span class="mi">30</span><span class="p">),</span> <span class="n">o</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;audited&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span> <span class="n">o</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;emission_apy&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">)</span> <span class="o">&lt;=</span> <span class="n">max_risk</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">eligible</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;No eligible opportunities for risk tolerance&#39;</span><span class="p">}</span>

        <span class="c1"># Sort by risk-adjusted APY</span>
        <span class="n">ranked</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyzer</span><span class="o">.</span><span class="n">compare_opportunities</span><span class="p">(</span><span class="n">eligible</span><span class="p">)</span>

        <span class="c1"># Allocate (simple: split among top 3)</span>
        <span class="n">top_n</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ranked</span><span class="p">))</span>
        <span class="n">allocation_per</span> <span class="o">=</span> <span class="n">total_capital</span> <span class="o">/</span> <span class="n">top_n</span>

        <span class="n">allocations</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">total_expected_apy</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">opp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ranked</span><span class="p">[:</span><span class="n">top_n</span><span class="p">]):</span>
            <span class="n">allocations</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;protocol&#39;</span><span class="p">:</span> <span class="n">opp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;protocol&#39;</span><span class="p">,</span> <span class="s1">&#39;Unknown&#39;</span><span class="p">),</span>
                <span class="s1">&#39;pool&#39;</span><span class="p">:</span> <span class="n">opp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pool&#39;</span><span class="p">,</span> <span class="s1">&#39;Unknown&#39;</span><span class="p">),</span>
                <span class="s1">&#39;amount&#39;</span><span class="p">:</span> <span class="n">allocation_per</span><span class="p">,</span>
                <span class="s1">&#39;apy&#39;</span><span class="p">:</span> <span class="n">opp</span><span class="p">[</span><span class="s1">&#39;apy&#39;</span><span class="p">],</span>
                <span class="s1">&#39;risk_score&#39;</span><span class="p">:</span> <span class="n">opp</span><span class="p">[</span><span class="s1">&#39;risk_score&#39;</span><span class="p">]</span>
            <span class="p">})</span>
            <span class="n">total_expected_apy</span> <span class="o">+=</span> <span class="n">opp</span><span class="p">[</span><span class="s1">&#39;apy&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">top_n</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;allocations&#39;</span><span class="p">:</span> <span class="n">allocations</span><span class="p">,</span>
            <span class="s1">&#39;total_capital&#39;</span><span class="p">:</span> <span class="n">total_capital</span><span class="p">,</span>
            <span class="s1">&#39;weighted_apy&#39;</span><span class="p">:</span> <span class="n">total_expected_apy</span><span class="p">,</span>
            <span class="s1">&#39;expected_daily_yield&#39;</span><span class="p">:</span> <span class="n">total_capital</span> <span class="o">*</span> <span class="n">total_expected_apy</span> <span class="o">/</span> <span class="mi">365</span>
        <span class="p">}</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>Section 4: Flash Loans</h1></div>
<div class="code-cell" id="cell-14-8" data-source="Y2xhc3MgRmxhc2hMb2FuU2ltdWxhdG9yOgogICAgIiIiCiAgICBTaW11bGF0ZSBmbGFzaCBsb2FuIG1lY2hhbmljcy4KICAgIAogICAgRmxhc2ggbG9hbnMgYWxsb3cgYm9ycm93aW5nIHdpdGhvdXQgY29sbGF0ZXJhbCwKICAgIGJ1dCBtdXN0IGJlIHJlcGFpZCBpbiB0aGUgc2FtZSB0cmFuc2FjdGlvbi4KICAgICIiIgogICAgCiAgICAjIEZsYXNoIGxvYW4gcHJvdmlkZXJzIGFuZCB0aGVpciBmZWVzCiAgICBQUk9WSURFUlMgPSB7CiAgICAgICAgJ0FhdmUnOiB7J2ZlZSc6IDAuMDAwOSwgJ21heF9hbW91bnQnOiAncG9vbF9saXF1aWRpdHknfSwgICMgMC4wOSUKICAgICAgICAnZFlkWCc6IHsnZmVlJzogMCwgJ21heF9hbW91bnQnOiAncG9vbF9saXF1aWRpdHknfSwgICAgICAgIyBGcmVlIQogICAgICAgICdVbmlzd2FwJzogeydmZWUnOiAwLjAwMywgJ21heF9hbW91bnQnOiAncG9vbF9saXF1aWRpdHknfSAjIDAuMyUKICAgIH0KICAgIAogICAgZGVmIGNhbGN1bGF0ZV9sb2FuX2Nvc3Qoc2VsZiwgYW1vdW50LCBwcm92aWRlcj0nQWF2ZScpOgogICAgICAgICIiIkNhbGN1bGF0ZSBjb3N0IG9mIGZsYXNoIGxvYW4uIiIiCiAgICAgICAgZmVlX3JhdGUgPSBzZWxmLlBST1ZJREVSU1twcm92aWRlcl1bJ2ZlZSddCiAgICAgICAgZmVlID0gYW1vdW50ICogZmVlX3JhdGUKICAgICAgICByZXBheW1lbnQgPSBhbW91bnQgKyBmZWUKICAgICAgICAKICAgICAgICByZXR1cm4gewogICAgICAgICAgICAnYm9ycm93ZWQnOiBhbW91bnQsCiAgICAgICAgICAgICdmZWVfcmF0ZSc6IGZlZV9yYXRlICogMTAwLAogICAgICAgICAgICAnZmVlJzogZmVlLAogICAgICAgICAgICAndG90YWxfcmVwYXltZW50JzogcmVwYXltZW50CiAgICAgICAgfQogICAgCiAgICBkZWYgc2ltdWxhdGVfYXJiaXRyYWdlX3dpdGhfZmxhc2hfbG9hbihzZWxmLCBhbW91bnQsIHByb2ZpdF9wY3QsIHByb3ZpZGVyPSdBYXZlJyk6CiAgICAgICAgIiIiCiAgICAgICAgU2ltdWxhdGUgdXNpbmcgZmxhc2ggbG9hbiBmb3IgYXJiaXRyYWdlLgogICAgICAgICIiIgogICAgICAgIGxvYW5fY29zdCA9IHNlbGYuY2FsY3VsYXRlX2xvYW5fY29zdChhbW91bnQsIHByb3ZpZGVyKQogICAgICAgIAogICAgICAgICMgR3Jvc3MgcHJvZml0IGZyb20gYXJiaXRyYWdlCiAgICAgICAgZ3Jvc3NfcHJvZml0ID0gYW1vdW50ICogcHJvZml0X3BjdCAvIDEwMAogICAgICAgIAogICAgICAgICMgTmV0IHByb2ZpdCBhZnRlciBsb2FuIGZlZQogICAgICAgIG5ldF9wcm9maXQgPSBncm9zc19wcm9maXQgLSBsb2FuX2Nvc3RbJ2ZlZSddCiAgICAgICAgCiAgICAgICAgIyBHYXMgY29zdCAocm91Z2ggZXN0aW1hdGUpCiAgICAgICAgZ2FzX2Nvc3RfdXNkID0gNTAgICMgRGVwZW5kcyBvbiBjb21wbGV4aXR5CiAgICAgICAgCiAgICAgICAgZmluYWxfcHJvZml0ID0gbmV0X3Byb2ZpdCAtIGdhc19jb3N0X3VzZAogICAgICAgIAogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICdmbGFzaF9sb2FuX2Ftb3VudCc6IGFtb3VudCwKICAgICAgICAgICAgJ2xvYW5fZmVlJzogbG9hbl9jb3N0WydmZWUnXSwKICAgICAgICAgICAgJ2dyb3NzX2FyYml0cmFnZV9wcm9maXQnOiBncm9zc19wcm9maXQsCiAgICAgICAgICAgICduZXRfcHJvZml0X2FmdGVyX2ZlZSc6IG5ldF9wcm9maXQsCiAgICAgICAgICAgICdlc3RpbWF0ZWRfZ2FzJzogZ2FzX2Nvc3RfdXNkLAogICAgICAgICAgICAnZmluYWxfcHJvZml0JzogZmluYWxfcHJvZml0LAogICAgICAgICAgICAncHJvZml0YWJsZSc6IGZpbmFsX3Byb2ZpdCA+IDAsCiAgICAgICAgICAgICdjYXBpdGFsX3JlcXVpcmVkJzogZ2FzX2Nvc3RfdXNkICAjIE9ubHkgbmVlZCBnYXMhCiAgICAgICAgfQogICAgCiAgICBkZWYgbWluaW11bV9wcm9maXRfZm9yX2JyZWFrX2V2ZW4oc2VsZiwgYW1vdW50LCBwcm92aWRlcj0nQWF2ZScsIGdhc19jb3N0PTUwKToKICAgICAgICAiIiJDYWxjdWxhdGUgbWluaW11bSBhcmJpdHJhZ2UgcHJvZml0IG5lZWRlZCB0byBicmVhayBldmVuLiIiIgogICAgICAgIGxvYW5fY29zdCA9IHNlbGYuY2FsY3VsYXRlX2xvYW5fY29zdChhbW91bnQsIHByb3ZpZGVyKQogICAgICAgIHRvdGFsX2Nvc3QgPSBsb2FuX2Nvc3RbJ2ZlZSddICsgZ2FzX2Nvc3QKICAgICAgICBtaW5fcHJvZml0X3BjdCA9ICh0b3RhbF9jb3N0IC8gYW1vdW50KSAqIDEwMAogICAgICAgIAogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICdtaW5fcHJvZml0X3BjdCc6IG1pbl9wcm9maXRfcGN0LAogICAgICAgICAgICAnbWluX3Byb2ZpdF91c2QnOiB0b3RhbF9jb3N0LAogICAgICAgICAgICAnYnJlYWtkb3duJzogewogICAgICAgICAgICAgICAgJ2xvYW5fZmVlJzogbG9hbl9jb3N0WydmZWUnXSwKICAgICAgICAgICAgICAgICdnYXMnOiBnYXNfY29zdAogICAgICAgICAgICB9CiAgICAgICAgfQoKZmwgPSBGbGFzaExvYW5TaW11bGF0b3IoKQpwcmludChmbC5zaW11bGF0ZV9hcmJpdHJhZ2Vfd2l0aF9mbGFzaF9sb2FuKDFfMDAwXzAwMCwgMC41KSkgICMgJDFNIGxvYW4sIDAuNSUgYXJi"><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-14-8')" type="button">Run</button></div><pre><code><span class="k">class</span> <span class="nc">FlashLoanSimulator</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Simulate flash loan mechanics.</span>
<span class="sd">    </span>
<span class="sd">    Flash loans allow borrowing without collateral,</span>
<span class="sd">    but must be repaid in the same transaction.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c1"># Flash loan providers and their fees</span>
    <span class="n">PROVIDERS</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;Aave&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;fee&#39;</span><span class="p">:</span> <span class="mf">0.0009</span><span class="p">,</span> <span class="s1">&#39;max_amount&#39;</span><span class="p">:</span> <span class="s1">&#39;pool_liquidity&#39;</span><span class="p">},</span>  <span class="c1"># 0.09%</span>
        <span class="s1">&#39;dYdX&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;fee&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;max_amount&#39;</span><span class="p">:</span> <span class="s1">&#39;pool_liquidity&#39;</span><span class="p">},</span>       <span class="c1"># Free!</span>
        <span class="s1">&#39;Uniswap&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;fee&#39;</span><span class="p">:</span> <span class="mf">0.003</span><span class="p">,</span> <span class="s1">&#39;max_amount&#39;</span><span class="p">:</span> <span class="s1">&#39;pool_liquidity&#39;</span><span class="p">}</span> <span class="c1"># 0.3%</span>
    <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">calculate_loan_cost</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">provider</span><span class="o">=</span><span class="s1">&#39;Aave&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculate cost of flash loan.&quot;&quot;&quot;</span>
        <span class="n">fee_rate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">PROVIDERS</span><span class="p">[</span><span class="n">provider</span><span class="p">][</span><span class="s1">&#39;fee&#39;</span><span class="p">]</span>
        <span class="n">fee</span> <span class="o">=</span> <span class="n">amount</span> <span class="o">*</span> <span class="n">fee_rate</span>
        <span class="n">repayment</span> <span class="o">=</span> <span class="n">amount</span> <span class="o">+</span> <span class="n">fee</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;borrowed&#39;</span><span class="p">:</span> <span class="n">amount</span><span class="p">,</span>
            <span class="s1">&#39;fee_rate&#39;</span><span class="p">:</span> <span class="n">fee_rate</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
            <span class="s1">&#39;fee&#39;</span><span class="p">:</span> <span class="n">fee</span><span class="p">,</span>
            <span class="s1">&#39;total_repayment&#39;</span><span class="p">:</span> <span class="n">repayment</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">simulate_arbitrage_with_flash_loan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">profit_pct</span><span class="p">,</span> <span class="n">provider</span><span class="o">=</span><span class="s1">&#39;Aave&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Simulate using flash loan for arbitrage.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">loan_cost</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_loan_cost</span><span class="p">(</span><span class="n">amount</span><span class="p">,</span> <span class="n">provider</span><span class="p">)</span>
        
        <span class="c1"># Gross profit from arbitrage</span>
        <span class="n">gross_profit</span> <span class="o">=</span> <span class="n">amount</span> <span class="o">*</span> <span class="n">profit_pct</span> <span class="o">/</span> <span class="mi">100</span>
        
        <span class="c1"># Net profit after loan fee</span>
        <span class="n">net_profit</span> <span class="o">=</span> <span class="n">gross_profit</span> <span class="o">-</span> <span class="n">loan_cost</span><span class="p">[</span><span class="s1">&#39;fee&#39;</span><span class="p">]</span>
        
        <span class="c1"># Gas cost (rough estimate)</span>
        <span class="n">gas_cost_usd</span> <span class="o">=</span> <span class="mi">50</span>  <span class="c1"># Depends on complexity</span>
        
        <span class="n">final_profit</span> <span class="o">=</span> <span class="n">net_profit</span> <span class="o">-</span> <span class="n">gas_cost_usd</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;flash_loan_amount&#39;</span><span class="p">:</span> <span class="n">amount</span><span class="p">,</span>
            <span class="s1">&#39;loan_fee&#39;</span><span class="p">:</span> <span class="n">loan_cost</span><span class="p">[</span><span class="s1">&#39;fee&#39;</span><span class="p">],</span>
            <span class="s1">&#39;gross_arbitrage_profit&#39;</span><span class="p">:</span> <span class="n">gross_profit</span><span class="p">,</span>
            <span class="s1">&#39;net_profit_after_fee&#39;</span><span class="p">:</span> <span class="n">net_profit</span><span class="p">,</span>
            <span class="s1">&#39;estimated_gas&#39;</span><span class="p">:</span> <span class="n">gas_cost_usd</span><span class="p">,</span>
            <span class="s1">&#39;final_profit&#39;</span><span class="p">:</span> <span class="n">final_profit</span><span class="p">,</span>
            <span class="s1">&#39;profitable&#39;</span><span class="p">:</span> <span class="n">final_profit</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;capital_required&#39;</span><span class="p">:</span> <span class="n">gas_cost_usd</span>  <span class="c1"># Only need gas!</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">minimum_profit_for_break_even</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">provider</span><span class="o">=</span><span class="s1">&#39;Aave&#39;</span><span class="p">,</span> <span class="n">gas_cost</span><span class="o">=</span><span class="mi">50</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculate minimum arbitrage profit needed to break even.&quot;&quot;&quot;</span>
        <span class="n">loan_cost</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_loan_cost</span><span class="p">(</span><span class="n">amount</span><span class="p">,</span> <span class="n">provider</span><span class="p">)</span>
        <span class="n">total_cost</span> <span class="o">=</span> <span class="n">loan_cost</span><span class="p">[</span><span class="s1">&#39;fee&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">gas_cost</span>
        <span class="n">min_profit_pct</span> <span class="o">=</span> <span class="p">(</span><span class="n">total_cost</span> <span class="o">/</span> <span class="n">amount</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;min_profit_pct&#39;</span><span class="p">:</span> <span class="n">min_profit_pct</span><span class="p">,</span>
            <span class="s1">&#39;min_profit_usd&#39;</span><span class="p">:</span> <span class="n">total_cost</span><span class="p">,</span>
            <span class="s1">&#39;breakdown&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;loan_fee&#39;</span><span class="p">:</span> <span class="n">loan_cost</span><span class="p">[</span><span class="s1">&#39;fee&#39;</span><span class="p">],</span>
                <span class="s1">&#39;gas&#39;</span><span class="p">:</span> <span class="n">gas_cost</span>
            <span class="p">}</span>
        <span class="p">}</span>

<span class="n">fl</span> <span class="o">=</span> <span class="n">FlashLoanSimulator</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">fl</span><span class="o">.</span><span class="n">simulate_arbitrage_with_flash_loan</span><span class="p">(</span><span class="mi">1_000_000</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">))</span>  <span class="c1"># $1M loan, 0.5% arb</span>
</code></pre><div class="code-output" id="output-cell-14-8"></div></div>
<div class="md-cell"><h3>âœï¸ Exercise 14.4: Flash Loan Strategy Analyzer</h3>
<p>Build a flash loan opportunity analyzer.</p></div>
<div class="code-cell" id="cell-14-9" data-source="IyBFeGVyY2lzZSAxNC40CmNsYXNzIEZsYXNoTG9hbkFuYWx5emVyOgogICAgZGVmIF9faW5pdF9fKHNlbGYpOgogICAgICAgIHNlbGYuc2ltdWxhdG9yID0gRmxhc2hMb2FuU2ltdWxhdG9yKCkKICAgIAogICAgZGVmIGFuYWx5emVfYXJiaXRyYWdlX29wcG9ydHVuaXR5KHNlbGYsIGJ1eV9wcmljZSwgc2VsbF9wcmljZSwgYXZhaWxhYmxlX2xpcXVpZGl0eSk6CiAgICAgICAgIyBUT0RPOiBEZXRlcm1pbmUgaWYgZmxhc2ggbG9hbiBhcmJpdHJhZ2UgaXMgcHJvZml0YWJsZQogICAgICAgIHBhc3MKICAgIAogICAgZGVmIG9wdGltYWxfbG9hbl9hbW91bnQoc2VsZiwgc3ByZWFkX3BjdCwgbWF4X2xpcXVpZGl0eSk6CiAgICAgICAgIyBUT0RPOiBGaW5kIG9wdGltYWwgbG9hbiBzaXplCiAgICAgICAgcGFzcwogICAgCiAgICBkZWYgY29tcGFyZV9wcm92aWRlcnMoc2VsZiwgYW1vdW50KToKICAgICAgICAjIFRPRE86IENvbXBhcmUgZmxhc2ggbG9hbiBwcm92aWRlcnMKICAgICAgICBwYXNz"><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-14-9')" type="button">Run</button></div><pre><code><span class="c1"># Exercise 14.4</span>
<span class="k">class</span> <span class="nc">FlashLoanAnalyzer</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">simulator</span> <span class="o">=</span> <span class="n">FlashLoanSimulator</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">analyze_arbitrage_opportunity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">buy_price</span><span class="p">,</span> <span class="n">sell_price</span><span class="p">,</span> <span class="n">available_liquidity</span><span class="p">):</span>
        <span class="c1"># TODO: Determine if flash loan arbitrage is profitable</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">optimal_loan_amount</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spread_pct</span><span class="p">,</span> <span class="n">max_liquidity</span><span class="p">):</span>
        <span class="c1"># TODO: Find optimal loan size</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">compare_providers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
        <span class="c1"># TODO: Compare flash loan providers</span>
        <span class="k">pass</span>
</code></pre><div class="code-output" id="output-cell-14-9"></div></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">FlashLoanAnalyzer</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">simulator</span> <span class="o">=</span> <span class="n">FlashLoanSimulator</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">analyze_arbitrage_opportunity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">buy_price</span><span class="p">,</span> <span class="n">sell_price</span><span class="p">,</span> <span class="n">available_liquidity</span><span class="p">,</span> <span class="n">gas_cost</span><span class="o">=</span><span class="mi">50</span><span class="p">):</span>
        <span class="n">spread_pct</span> <span class="o">=</span> <span class="p">(</span><span class="n">sell_price</span> <span class="o">-</span> <span class="n">buy_price</span><span class="p">)</span> <span class="o">/</span> <span class="n">buy_price</span> <span class="o">*</span> <span class="mi">100</span>

        <span class="c1"># Try different loan amounts</span>
        <span class="n">best_result</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">for</span> <span class="n">pct</span> <span class="ow">in</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]:</span>  <span class="c1"># % of available liquidity</span>
            <span class="n">amount</span> <span class="o">=</span> <span class="n">available_liquidity</span> <span class="o">*</span> <span class="n">pct</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulator</span><span class="o">.</span><span class="n">simulate_arbitrage_with_flash_loan</span><span class="p">(</span>
                <span class="n">amount</span><span class="p">,</span> <span class="n">spread_pct</span><span class="p">,</span> <span class="s1">&#39;Aave&#39;</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;profitable&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">best_result</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;final_profit&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">best_result</span><span class="p">[</span><span class="s1">&#39;final_profit&#39;</span><span class="p">]:</span>
                    <span class="n">best_result</span> <span class="o">=</span> <span class="n">result</span>
                    <span class="n">best_result</span><span class="p">[</span><span class="s1">&#39;loan_pct_of_liquidity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pct</span> <span class="o">*</span> <span class="mi">100</span>

        <span class="k">return</span> <span class="n">best_result</span> <span class="ow">or</span> <span class="p">{</span><span class="s1">&#39;profitable&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="s1">&#39;Spread too small&#39;</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">optimal_loan_amount</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spread_pct</span><span class="p">,</span> <span class="n">max_liquidity</span><span class="p">,</span> <span class="n">gas_cost</span><span class="o">=</span><span class="mi">50</span><span class="p">):</span>
        <span class="c1"># Larger loans = more profit but more price impact</span>
        <span class="c1"># Simple model: price impact increases with size</span>

        <span class="n">best_profit</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">best_amount</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">pct</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">101</span><span class="p">,</span> <span class="mi">5</span><span class="p">):</span>  <span class="c1"># 1% to 100% in 5% steps</span>
            <span class="n">amount</span> <span class="o">=</span> <span class="n">max_liquidity</span> <span class="o">*</span> <span class="n">pct</span> <span class="o">/</span> <span class="mi">100</span>

            <span class="c1"># Simulate price impact (larger trades = worse execution)</span>
            <span class="n">effective_spread</span> <span class="o">=</span> <span class="n">spread_pct</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">pct</span><span class="o">/</span><span class="mi">200</span><span class="p">)</span>  <span class="c1"># Spread decreases with size</span>

            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulator</span><span class="o">.</span><span class="n">simulate_arbitrage_with_flash_loan</span><span class="p">(</span>
                <span class="n">amount</span><span class="p">,</span> <span class="n">effective_spread</span><span class="p">,</span> <span class="s1">&#39;Aave&#39;</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;final_profit&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">best_profit</span><span class="p">:</span>
                <span class="n">best_profit</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;final_profit&#39;</span><span class="p">]</span>
                <span class="n">best_amount</span> <span class="o">=</span> <span class="n">amount</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;optimal_amount&#39;</span><span class="p">:</span> <span class="n">best_amount</span><span class="p">,</span>
            <span class="s1">&#39;expected_profit&#39;</span><span class="p">:</span> <span class="n">best_profit</span><span class="p">,</span>
            <span class="s1">&#39;pct_of_liquidity&#39;</span><span class="p">:</span> <span class="n">best_amount</span> <span class="o">/</span> <span class="n">max_liquidity</span> <span class="o">*</span> <span class="mi">100</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">compare_providers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">provider</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulator</span><span class="o">.</span><span class="n">PROVIDERS</span><span class="p">:</span>
            <span class="n">cost</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulator</span><span class="o">.</span><span class="n">calculate_loan_cost</span><span class="p">(</span><span class="n">amount</span><span class="p">,</span> <span class="n">provider</span><span class="p">)</span>
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;provider&#39;</span><span class="p">:</span> <span class="n">provider</span><span class="p">,</span>
                <span class="s1">&#39;fee&#39;</span><span class="p">:</span> <span class="n">cost</span><span class="p">[</span><span class="s1">&#39;fee&#39;</span><span class="p">],</span>
                <span class="s1">&#39;fee_pct&#39;</span><span class="p">:</span> <span class="n">cost</span><span class="p">[</span><span class="s1">&#39;fee_rate&#39;</span><span class="p">]</span>
            <span class="p">})</span>

        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;fee&#39;</span><span class="p">])</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>ğŸ—ï¸ Module Project: DeFi Opportunity Scanner</h1>
<p>Build a comprehensive DeFi opportunity scanner.</p></div>
<div class="code-cell" id="cell-14-10" data-source="IyBNb2R1bGUgUHJvamVjdApjbGFzcyBEZUZpT3Bwb3J0dW5pdHlTY2FubmVyOgogICAgZGVmIF9faW5pdF9fKHNlbGYpOgogICAgICAgIHNlbGYuYXJiaXRyYWdlID0gQXJiaXRyYWdlU2Nhbm5lcigpCiAgICAgICAgc2VsZi5scF9hbmFseXplciA9IExQUG9zaXRpb25BbmFseXplcigpCiAgICAgICAgc2VsZi55aWVsZF90cmFja2VyID0gWWllbGRUcmFja2VyKCkKICAgICAgICBzZWxmLmZsYXNoX2xvYW4gPSBGbGFzaExvYW5BbmFseXplcigpCiAgICAKICAgIGRlZiBzY2FuX2FsbF9vcHBvcnR1bml0aWVzKHNlbGYsIGNhcGl0YWwpOgogICAgICAgICMgVE9ETzogU2NhbiBhcmJpdHJhZ2UsIHlpZWxkLCBMUCBvcHBvcnR1bml0aWVzCiAgICAgICAgcGFzcwogICAgCiAgICBkZWYgcmFua19vcHBvcnR1bml0aWVzKHNlbGYsIG9wcG9ydHVuaXRpZXMpOgogICAgICAgICMgVE9ETzogUmFuayBieSByaXNrLWFkanVzdGVkIHJldHVybgogICAgICAgIHBhc3MKICAgIAogICAgZGVmIGdlbmVyYXRlX3JlcG9ydChzZWxmKToKICAgICAgICAjIFRPRE86IEdlbmVyYXRlIG9wcG9ydHVuaXR5IHJlcG9ydAogICAgICAgIHBhc3M="><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-14-10')" type="button">Run</button></div><pre><code><span class="c1"># Module Project</span>
<span class="k">class</span> <span class="nc">DeFiOpportunityScanner</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">arbitrage</span> <span class="o">=</span> <span class="n">ArbitrageScanner</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lp_analyzer</span> <span class="o">=</span> <span class="n">LPPositionAnalyzer</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">yield_tracker</span> <span class="o">=</span> <span class="n">YieldTracker</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flash_loan</span> <span class="o">=</span> <span class="n">FlashLoanAnalyzer</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">scan_all_opportunities</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">capital</span><span class="p">):</span>
        <span class="c1"># TODO: Scan arbitrage, yield, LP opportunities</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">rank_opportunities</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">opportunities</span><span class="p">):</span>
        <span class="c1"># TODO: Rank by risk-adjusted return</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">generate_report</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># TODO: Generate opportunity report</span>
        <span class="k">pass</span>
</code></pre><div class="code-output" id="output-cell-14-10"></div></div>
<div class="md-cell"><hr />
<h1>ğŸ“ Key Takeaways</h1>
<ol>
<li><strong>Arbitrage</strong>: CEX-DEX and DEX-DEX spreads can be profitable with proper execution</li>
<li><strong>Liquidity Provision</strong>: Understand IL before providing - fees must exceed IL</li>
<li><strong>Yield Farming</strong>: High APY often means high risk - calculate real yield</li>
<li><strong>Flash Loans</strong>: Borrow millions with no collateral - repay in same tx</li>
</ol>
<hr />
<p><em>Next: Module 15 - Advanced Crypto Topics</em></p></div>
        <div class="nav-buttons">
            <button class="nav-btn prev-btn disabled" type="button">
                <span class="nav-btn-label">â† Previous</span>
                <span class="nav-btn-name"></span>
            </button>
            <button class="nav-btn next-btn disabled" type="button">
                <span class="nav-btn-label">Next â†’</span>
                <span class="nav-btn-name"></span>
            </button>
        </div>
        </div>
<div class="module-section" data-idx="15"><div class="md-cell module-header"><h1>Module 15: Advanced Crypto Topics</h1>
<h2>Part 4: DeFi &amp; Advanced Topics</h2>
<hr />
<div class="table-wrapper"><table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>â±ï¸ <strong>Duration</strong></td>
<td>~2.5 hours</td>
</tr>
<tr>
<td>ğŸ“‹ <strong>Prerequisites</strong></td>
<td>Module 14</td>
</tr>
<tr>
<td>ğŸ’ª <strong>Exercises</strong></td>
<td>5 total</td>
</tr>
</tbody>
</table></div></div>
<div class="md-cell"><h2>ğŸ¯ Learning Objectives</h2>
<ul>
<li>Trade funding rate strategies on perpetuals</li>
<li>Understand crypto options basics</li>
<li>Learn market making concepts</li>
<li>Implement cross-exchange strategies</li>
</ul></div>
<div class="md-cell"><hr />
<h1>Section 1: Funding Rate Strategies</h1>
<h2>1.1 Understanding Perpetual Funding</h2></div>
<div class="code-cell" id="cell-15-0" data-source="Y2xhc3MgRnVuZGluZ1JhdGVBbmFseXplcjoKICAgICIiIgogICAgQW5hbHl6ZSBwZXJwZXR1YWwgZnV0dXJlcyBmdW5kaW5nIHJhdGVzLgogICAgCiAgICBGdW5kaW5nIFJhdGUgPSAoUGVycCBQcmljZSAtIFNwb3QgUHJpY2UpIC8gU3BvdCBQcmljZQogICAgUGFpZCBldmVyeSA4IGhvdXJzIG9uIG1vc3QgZXhjaGFuZ2VzLgogICAgIiIiCiAgICAKICAgIGRlZiBfX2luaXRfXyhzZWxmKToKICAgICAgICBzZWxmLmZ1bmRpbmdfaGlzdG9yeSA9IFtdCiAgICAKICAgIGRlZiBjYWxjdWxhdGVfZnVuZGluZ19yYXRlKHNlbGYsIHBlcnBfcHJpY2UsIHNwb3RfcHJpY2UpOgogICAgICAgICIiIkNhbGN1bGF0ZSBjdXJyZW50IGZ1bmRpbmcgcmF0ZS4iIiIKICAgICAgICByZXR1cm4gKHBlcnBfcHJpY2UgLSBzcG90X3ByaWNlKSAvIHNwb3RfcHJpY2UKICAgIAogICAgZGVmIGFubnVhbGl6ZWRfZnVuZGluZyhzZWxmLCByYXRlLCBwYXltZW50c19wZXJfZGF5PTMpOgogICAgICAgICIiIkNvbnZlcnQgZnVuZGluZyByYXRlIHRvIGFubnVhbGl6ZWQgcGVyY2VudGFnZS4iIiIKICAgICAgICBkYWlseSA9IHJhdGUgKiBwYXltZW50c19wZXJfZGF5CiAgICAgICAgYW5udWFsID0gZGFpbHkgKiAzNjUKICAgICAgICByZXR1cm4gYW5udWFsICogMTAwCiAgICAKICAgIGRlZiBmdW5kaW5nX3BubChzZWxmLCBwb3NpdGlvbl9zaXplLCBmdW5kaW5nX3JhdGUsIGlzX2xvbmc9VHJ1ZSk6CiAgICAgICAgIiIiCiAgICAgICAgQ2FsY3VsYXRlIFBuTCBmcm9tIGZ1bmRpbmcuCiAgICAgICAgCiAgICAgICAgLSBQb3NpdGl2ZSBmdW5kaW5nOiBMb25ncyBwYXkgc2hvcnRzCiAgICAgICAgLSBOZWdhdGl2ZSBmdW5kaW5nOiBTaG9ydHMgcGF5IGxvbmdzCiAgICAgICAgIiIiCiAgICAgICAgaWYgaXNfbG9uZzoKICAgICAgICAgICAgIyBMb25ncyBwYXkgd2hlbiBwb3NpdGl2ZSwgcmVjZWl2ZSB3aGVuIG5lZ2F0aXZlCiAgICAgICAgICAgIHBubCA9IC1wb3NpdGlvbl9zaXplICogZnVuZGluZ19yYXRlCiAgICAgICAgZWxzZToKICAgICAgICAgICAgIyBTaG9ydHMgcmVjZWl2ZSB3aGVuIHBvc2l0aXZlLCBwYXkgd2hlbiBuZWdhdGl2ZQogICAgICAgICAgICBwbmwgPSBwb3NpdGlvbl9zaXplICogZnVuZGluZ19yYXRlCiAgICAgICAgCiAgICAgICAgcmV0dXJuIHBubAogICAgCiAgICBkZWYgY2FzaF9hbmRfY2FycnlfcmV0dXJuKHNlbGYsIHNwb3RfcHJpY2UsIHBlcnBfcHJpY2UsIGZ1bmRpbmdfcmF0ZSwgZGF5cyk6CiAgICAgICAgIiIiCiAgICAgICAgQ2FsY3VsYXRlIGNhc2ggYW5kIGNhcnJ5IGFyYml0cmFnZSByZXR1cm4uCiAgICAgICAgCiAgICAgICAgU3RyYXRlZ3k6IExvbmcgc3BvdCArIFNob3J0IHBlcnAgPSBFYXJuIGZ1bmRpbmcKICAgICAgICAiIiIKICAgICAgICAjIEZ1bmRpbmcgaW5jb21lICgzIHBheW1lbnRzIHBlciBkYXkpCiAgICAgICAgdG90YWxfZnVuZGluZyA9IGZ1bmRpbmdfcmF0ZSAqIDMgKiBkYXlzCiAgICAgICAgZnVuZGluZ19pbmNvbWUgPSBzcG90X3ByaWNlICogdG90YWxfZnVuZGluZwogICAgICAgIAogICAgICAgICMgQmFzaXMgYXQgZW50cnkgKGNvdWxkIGJlIHBvc2l0aXZlIG9yIG5lZ2F0aXZlKQogICAgICAgIGJhc2lzID0gcGVycF9wcmljZSAtIHNwb3RfcHJpY2UKICAgICAgICAKICAgICAgICAjIFRvdGFsIHJldHVybgogICAgICAgIHRvdGFsX3JldHVybiA9IGZ1bmRpbmdfaW5jb21lICsgYmFzaXMgICMgQmFzaXMgY29udmVyZ2VzIHRvIDAKICAgICAgICByZXR1cm5fcGN0ID0gdG90YWxfcmV0dXJuIC8gc3BvdF9wcmljZSAqIDEwMAogICAgICAgIAogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICdmdW5kaW5nX2luY29tZSc6IGZ1bmRpbmdfaW5jb21lLAogICAgICAgICAgICAnYmFzaXMnOiBiYXNpcywKICAgICAgICAgICAgJ3RvdGFsX3JldHVybic6IHRvdGFsX3JldHVybiwKICAgICAgICAgICAgJ3JldHVybl9wY3QnOiByZXR1cm5fcGN0LAogICAgICAgICAgICAnYW5udWFsaXplZF9yZXR1cm4nOiByZXR1cm5fcGN0ICogMzY1IC8gZGF5cwogICAgICAgIH0KCmZyID0gRnVuZGluZ1JhdGVBbmFseXplcigpCnByaW50KGYnMC4wMSUgZnVuZGluZyA9IHtmci5hbm51YWxpemVkX2Z1bmRpbmcoMC4wMDAxKTouMWZ9JSBhbm51YWxpemVkJykKcHJpbnQoZicwLjA1JSBmdW5kaW5nID0ge2ZyLmFubnVhbGl6ZWRfZnVuZGluZygwLjAwMDUpOi4xZn0lIGFubnVhbGl6ZWQnKQ=="><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-15-0')" type="button">Run</button></div><pre><code><span class="k">class</span> <span class="nc">FundingRateAnalyzer</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Analyze perpetual futures funding rates.</span>
<span class="sd">    </span>
<span class="sd">    Funding Rate = (Perp Price - Spot Price) / Spot Price</span>
<span class="sd">    Paid every 8 hours on most exchanges.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">funding_history</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">def</span> <span class="nf">calculate_funding_rate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">perp_price</span><span class="p">,</span> <span class="n">spot_price</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculate current funding rate.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">perp_price</span> <span class="o">-</span> <span class="n">spot_price</span><span class="p">)</span> <span class="o">/</span> <span class="n">spot_price</span>
    
    <span class="k">def</span> <span class="nf">annualized_funding</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rate</span><span class="p">,</span> <span class="n">payments_per_day</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convert funding rate to annualized percentage.&quot;&quot;&quot;</span>
        <span class="n">daily</span> <span class="o">=</span> <span class="n">rate</span> <span class="o">*</span> <span class="n">payments_per_day</span>
        <span class="n">annual</span> <span class="o">=</span> <span class="n">daily</span> <span class="o">*</span> <span class="mi">365</span>
        <span class="k">return</span> <span class="n">annual</span> <span class="o">*</span> <span class="mi">100</span>
    
    <span class="k">def</span> <span class="nf">funding_pnl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">position_size</span><span class="p">,</span> <span class="n">funding_rate</span><span class="p">,</span> <span class="n">is_long</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate PnL from funding.</span>
<span class="sd">        </span>
<span class="sd">        - Positive funding: Longs pay shorts</span>
<span class="sd">        - Negative funding: Shorts pay longs</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">is_long</span><span class="p">:</span>
            <span class="c1"># Longs pay when positive, receive when negative</span>
            <span class="n">pnl</span> <span class="o">=</span> <span class="o">-</span><span class="n">position_size</span> <span class="o">*</span> <span class="n">funding_rate</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Shorts receive when positive, pay when negative</span>
            <span class="n">pnl</span> <span class="o">=</span> <span class="n">position_size</span> <span class="o">*</span> <span class="n">funding_rate</span>
        
        <span class="k">return</span> <span class="n">pnl</span>
    
    <span class="k">def</span> <span class="nf">cash_and_carry_return</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spot_price</span><span class="p">,</span> <span class="n">perp_price</span><span class="p">,</span> <span class="n">funding_rate</span><span class="p">,</span> <span class="n">days</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate cash and carry arbitrage return.</span>
<span class="sd">        </span>
<span class="sd">        Strategy: Long spot + Short perp = Earn funding</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Funding income (3 payments per day)</span>
        <span class="n">total_funding</span> <span class="o">=</span> <span class="n">funding_rate</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">days</span>
        <span class="n">funding_income</span> <span class="o">=</span> <span class="n">spot_price</span> <span class="o">*</span> <span class="n">total_funding</span>
        
        <span class="c1"># Basis at entry (could be positive or negative)</span>
        <span class="n">basis</span> <span class="o">=</span> <span class="n">perp_price</span> <span class="o">-</span> <span class="n">spot_price</span>
        
        <span class="c1"># Total return</span>
        <span class="n">total_return</span> <span class="o">=</span> <span class="n">funding_income</span> <span class="o">+</span> <span class="n">basis</span>  <span class="c1"># Basis converges to 0</span>
        <span class="n">return_pct</span> <span class="o">=</span> <span class="n">total_return</span> <span class="o">/</span> <span class="n">spot_price</span> <span class="o">*</span> <span class="mi">100</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;funding_income&#39;</span><span class="p">:</span> <span class="n">funding_income</span><span class="p">,</span>
            <span class="s1">&#39;basis&#39;</span><span class="p">:</span> <span class="n">basis</span><span class="p">,</span>
            <span class="s1">&#39;total_return&#39;</span><span class="p">:</span> <span class="n">total_return</span><span class="p">,</span>
            <span class="s1">&#39;return_pct&#39;</span><span class="p">:</span> <span class="n">return_pct</span><span class="p">,</span>
            <span class="s1">&#39;annualized_return&#39;</span><span class="p">:</span> <span class="n">return_pct</span> <span class="o">*</span> <span class="mi">365</span> <span class="o">/</span> <span class="n">days</span>
        <span class="p">}</span>

<span class="n">fr</span> <span class="o">=</span> <span class="n">FundingRateAnalyzer</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;0.01% funding = </span><span class="si">{</span><span class="n">fr</span><span class="o">.</span><span class="n">annualized_funding</span><span class="p">(</span><span class="mf">0.0001</span><span class="p">)</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">% annualized&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;0.05% funding = </span><span class="si">{</span><span class="n">fr</span><span class="o">.</span><span class="n">annualized_funding</span><span class="p">(</span><span class="mf">0.0005</span><span class="p">)</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">% annualized&#39;</span><span class="p">)</span>
</code></pre><div class="code-output" id="output-cell-15-0"></div></div>
<div class="md-cell"><h2>1.2 Funding Rate Strategies</h2></div>
<div class="code-cell" id="cell-15-1" data-source="Y2xhc3MgRnVuZGluZ1N0cmF0ZWd5OgogICAgIiIiU3RyYXRlZ2llcyBiYXNlZCBvbiBmdW5kaW5nIHJhdGVzLiIiIgogICAgCiAgICBkZWYgX19pbml0X18oc2VsZiwgYW5hbHl6ZXIpOgogICAgICAgIHNlbGYuYW5hbHl6ZXIgPSBhbmFseXplcgogICAgCiAgICBkZWYgY2FzaF9hbmRfY2Fycnkoc2VsZiwgY2FwaXRhbCwgc3BvdF9wcmljZSwgcGVycF9wcmljZSwgZnVuZGluZ19yYXRlKToKICAgICAgICAiIiIKICAgICAgICBDYXNoIGFuZCBjYXJyeTogTG9uZyBzcG90LCBzaG9ydCBwZXJwLgogICAgICAgIERlbHRhIG5ldXRyYWwsIGVhcm4gZnVuZGluZy4KICAgICAgICAiIiIKICAgICAgICAjIFNwbGl0IGNhcGl0YWwgYmV0d2VlbiBzcG90IGFuZCBtYXJnaW4KICAgICAgICBzcG90X2FsbG9jYXRpb24gPSBjYXBpdGFsICogMC41CiAgICAgICAgbWFyZ2luX2FsbG9jYXRpb24gPSBjYXBpdGFsICogMC41CiAgICAgICAgCiAgICAgICAgIyBQb3NpdGlvbiBzaXplcwogICAgICAgIHNwb3Rfc2l6ZSA9IHNwb3RfYWxsb2NhdGlvbiAvIHNwb3RfcHJpY2UKICAgICAgICBwZXJwX3NpemUgPSBzcG90X3NpemUgICMgTWF0Y2ggc2l6ZXMgZm9yIGRlbHRhIG5ldXRyYWwKICAgICAgICAKICAgICAgICAjIFJlcXVpcmVkIG1hcmdpbiAoYXNzdW1lIDEweCBsZXZlcmFnZSkKICAgICAgICBtYXJnaW5fcmVxdWlyZWQgPSBwZXJwX3NpemUgKiBwZXJwX3ByaWNlIC8gMTAKICAgICAgICAKICAgICAgICBpZiBtYXJnaW5fcmVxdWlyZWQgPiBtYXJnaW5fYWxsb2NhdGlvbjoKICAgICAgICAgICAgcmV0dXJuIHsnZXJyb3InOiAnSW5zdWZmaWNpZW50IG1hcmdpbid9CiAgICAgICAgCiAgICAgICAgIyBFeHBlY3RlZCBmdW5kaW5nIHBlciBwYXltZW50CiAgICAgICAgZnVuZGluZ19wZXJfcGF5bWVudCA9IHNlbGYuYW5hbHl6ZXIuZnVuZGluZ19wbmwocGVycF9zaXplICogcGVycF9wcmljZSwgZnVuZGluZ19yYXRlLCBpc19sb25nPUZhbHNlKQogICAgICAgIAogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICdzdHJhdGVneSc6ICdDYXNoIGFuZCBDYXJyeScsCiAgICAgICAgICAgICdzcG90X3Bvc2l0aW9uJzogc3BvdF9zaXplLAogICAgICAgICAgICAncGVycF9wb3NpdGlvbic6IC1wZXJwX3NpemUsICAjIFNob3J0CiAgICAgICAgICAgICdjYXBpdGFsX3VzZWQnOiBjYXBpdGFsLAogICAgICAgICAgICAnZnVuZGluZ19wZXJfOGgnOiBmdW5kaW5nX3Blcl9wYXltZW50LAogICAgICAgICAgICAnZGFpbHlfZnVuZGluZyc6IGZ1bmRpbmdfcGVyX3BheW1lbnQgKiAzLAogICAgICAgICAgICAnYW5udWFsX3JldHVybl9wY3QnOiBzZWxmLmFuYWx5emVyLmFubnVhbGl6ZWRfZnVuZGluZyhmdW5kaW5nX3JhdGUpCiAgICAgICAgfQogICAgCiAgICBkZWYgZnVuZGluZ19hcmJpdHJhZ2Uoc2VsZiwgZXhjaGFuZ2VfYV9yYXRlLCBleGNoYW5nZV9iX3JhdGUsIGNhcGl0YWwpOgogICAgICAgICIiIgogICAgICAgIEFyYml0cmFnZSBmdW5kaW5nIGRpZmZlcmVuY2VzIGJldHdlZW4gZXhjaGFuZ2VzLgogICAgICAgIExvbmcgb24gbG93LWZ1bmRpbmcgZXhjaGFuZ2UsIHNob3J0IG9uIGhpZ2gtZnVuZGluZyBleGNoYW5nZS4KICAgICAgICAiIiIKICAgICAgICByYXRlX2RpZmYgPSBhYnMoZXhjaGFuZ2VfYV9yYXRlIC0gZXhjaGFuZ2VfYl9yYXRlKQogICAgICAgIAogICAgICAgIGlmIGV4Y2hhbmdlX2FfcmF0ZSA+IGV4Y2hhbmdlX2JfcmF0ZToKICAgICAgICAgICAgIyBTaG9ydCBvbiBBLCBMb25nIG9uIEIKICAgICAgICAgICAgc3RyYXRlZ3kgPSB7J3Nob3J0JzogJ0V4Y2hhbmdlIEEnLCAnbG9uZyc6ICdFeGNoYW5nZSBCJ30KICAgICAgICBlbHNlOgogICAgICAgICAgICBzdHJhdGVneSA9IHsnc2hvcnQnOiAnRXhjaGFuZ2UgQicsICdsb25nJzogJ0V4Y2hhbmdlIEEnfQogICAgICAgIAogICAgICAgICMgQXNzdW1lIDV4IGxldmVyYWdlIGVhY2ggc2lkZQogICAgICAgIHBvc2l0aW9uX3NpemUgPSBjYXBpdGFsICogNSAvIDIgICMgU3BsaXQgYmV0d2VlbiBleGNoYW5nZXMKICAgICAgICAKICAgICAgICBuZXRfZnVuZGluZyA9IHBvc2l0aW9uX3NpemUgKiByYXRlX2RpZmYKICAgICAgICAKICAgICAgICByZXR1cm4gewogICAgICAgICAgICAnc3RyYXRlZ3knOiAnRnVuZGluZyBBcmJpdHJhZ2UnLAogICAgICAgICAgICAncmF0ZV9kaWZmZXJlbnRpYWwnOiByYXRlX2RpZmYgKiAxMDAsCiAgICAgICAgICAgICoqc3RyYXRlZ3ksCiAgICAgICAgICAgICduZXRfZnVuZGluZ19wZXJfOGgnOiBuZXRfZnVuZGluZywKICAgICAgICAgICAgJ2FubnVhbGl6ZWRfcmV0dXJuJzogc2VsZi5hbmFseXplci5hbm51YWxpemVkX2Z1bmRpbmcocmF0ZV9kaWZmKQogICAgICAgIH0="><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-15-1')" type="button">Run</button></div><pre><code><span class="k">class</span> <span class="nc">FundingStrategy</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Strategies based on funding rates.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">analyzer</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">analyzer</span> <span class="o">=</span> <span class="n">analyzer</span>
    
    <span class="k">def</span> <span class="nf">cash_and_carry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">capital</span><span class="p">,</span> <span class="n">spot_price</span><span class="p">,</span> <span class="n">perp_price</span><span class="p">,</span> <span class="n">funding_rate</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Cash and carry: Long spot, short perp.</span>
<span class="sd">        Delta neutral, earn funding.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Split capital between spot and margin</span>
        <span class="n">spot_allocation</span> <span class="o">=</span> <span class="n">capital</span> <span class="o">*</span> <span class="mf">0.5</span>
        <span class="n">margin_allocation</span> <span class="o">=</span> <span class="n">capital</span> <span class="o">*</span> <span class="mf">0.5</span>
        
        <span class="c1"># Position sizes</span>
        <span class="n">spot_size</span> <span class="o">=</span> <span class="n">spot_allocation</span> <span class="o">/</span> <span class="n">spot_price</span>
        <span class="n">perp_size</span> <span class="o">=</span> <span class="n">spot_size</span>  <span class="c1"># Match sizes for delta neutral</span>
        
        <span class="c1"># Required margin (assume 10x leverage)</span>
        <span class="n">margin_required</span> <span class="o">=</span> <span class="n">perp_size</span> <span class="o">*</span> <span class="n">perp_price</span> <span class="o">/</span> <span class="mi">10</span>
        
        <span class="k">if</span> <span class="n">margin_required</span> <span class="o">&gt;</span> <span class="n">margin_allocation</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Insufficient margin&#39;</span><span class="p">}</span>
        
        <span class="c1"># Expected funding per payment</span>
        <span class="n">funding_per_payment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyzer</span><span class="o">.</span><span class="n">funding_pnl</span><span class="p">(</span><span class="n">perp_size</span> <span class="o">*</span> <span class="n">perp_price</span><span class="p">,</span> <span class="n">funding_rate</span><span class="p">,</span> <span class="n">is_long</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;strategy&#39;</span><span class="p">:</span> <span class="s1">&#39;Cash and Carry&#39;</span><span class="p">,</span>
            <span class="s1">&#39;spot_position&#39;</span><span class="p">:</span> <span class="n">spot_size</span><span class="p">,</span>
            <span class="s1">&#39;perp_position&#39;</span><span class="p">:</span> <span class="o">-</span><span class="n">perp_size</span><span class="p">,</span>  <span class="c1"># Short</span>
            <span class="s1">&#39;capital_used&#39;</span><span class="p">:</span> <span class="n">capital</span><span class="p">,</span>
            <span class="s1">&#39;funding_per_8h&#39;</span><span class="p">:</span> <span class="n">funding_per_payment</span><span class="p">,</span>
            <span class="s1">&#39;daily_funding&#39;</span><span class="p">:</span> <span class="n">funding_per_payment</span> <span class="o">*</span> <span class="mi">3</span><span class="p">,</span>
            <span class="s1">&#39;annual_return_pct&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyzer</span><span class="o">.</span><span class="n">annualized_funding</span><span class="p">(</span><span class="n">funding_rate</span><span class="p">)</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">funding_arbitrage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exchange_a_rate</span><span class="p">,</span> <span class="n">exchange_b_rate</span><span class="p">,</span> <span class="n">capital</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Arbitrage funding differences between exchanges.</span>
<span class="sd">        Long on low-funding exchange, short on high-funding exchange.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">rate_diff</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">exchange_a_rate</span> <span class="o">-</span> <span class="n">exchange_b_rate</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">exchange_a_rate</span> <span class="o">&gt;</span> <span class="n">exchange_b_rate</span><span class="p">:</span>
            <span class="c1"># Short on A, Long on B</span>
            <span class="n">strategy</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;short&#39;</span><span class="p">:</span> <span class="s1">&#39;Exchange A&#39;</span><span class="p">,</span> <span class="s1">&#39;long&#39;</span><span class="p">:</span> <span class="s1">&#39;Exchange B&#39;</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">strategy</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;short&#39;</span><span class="p">:</span> <span class="s1">&#39;Exchange B&#39;</span><span class="p">,</span> <span class="s1">&#39;long&#39;</span><span class="p">:</span> <span class="s1">&#39;Exchange A&#39;</span><span class="p">}</span>
        
        <span class="c1"># Assume 5x leverage each side</span>
        <span class="n">position_size</span> <span class="o">=</span> <span class="n">capital</span> <span class="o">*</span> <span class="mi">5</span> <span class="o">/</span> <span class="mi">2</span>  <span class="c1"># Split between exchanges</span>
        
        <span class="n">net_funding</span> <span class="o">=</span> <span class="n">position_size</span> <span class="o">*</span> <span class="n">rate_diff</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;strategy&#39;</span><span class="p">:</span> <span class="s1">&#39;Funding Arbitrage&#39;</span><span class="p">,</span>
            <span class="s1">&#39;rate_differential&#39;</span><span class="p">:</span> <span class="n">rate_diff</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
            <span class="o">**</span><span class="n">strategy</span><span class="p">,</span>
            <span class="s1">&#39;net_funding_per_8h&#39;</span><span class="p">:</span> <span class="n">net_funding</span><span class="p">,</span>
            <span class="s1">&#39;annualized_return&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyzer</span><span class="o">.</span><span class="n">annualized_funding</span><span class="p">(</span><span class="n">rate_diff</span><span class="p">)</span>
        <span class="p">}</span>
</code></pre><div class="code-output" id="output-cell-15-1"></div></div>
<div class="md-cell"><h3>âœï¸ Exercise 15.1: Funding Rate Tracker</h3>
<p>Build a funding rate monitoring and trading system.</p></div>
<div class="code-cell" id="cell-15-2" data-source="IyBFeGVyY2lzZSAxNS4xCmNsYXNzIEZ1bmRpbmdSYXRlVHJhY2tlcjoKICAgIGRlZiBfX2luaXRfXyhzZWxmKToKICAgICAgICBzZWxmLnJhdGVzID0ge30KICAgICAgICBzZWxmLmhpc3RvcnkgPSBbXQogICAgCiAgICBkZWYgdXBkYXRlX3JhdGUoc2VsZiwgZXhjaGFuZ2UsIHN5bWJvbCwgcmF0ZSk6CiAgICAgICAgIyBUT0RPCiAgICAgICAgcGFzcwogICAgCiAgICBkZWYgZmluZF9vcHBvcnR1bml0aWVzKHNlbGYsIG1pbl9yYXRlPTAuMDAwMyk6CiAgICAgICAgIyBUT0RPOiBGaW5kIGhpZ2ggZnVuZGluZyByYXRlIG9wcG9ydHVuaXRpZXMKICAgICAgICBwYXNzCiAgICAKICAgIGRlZiBiYWNrdGVzdF9zdHJhdGVneShzZWxmLCBzeW1ib2wsIGRheXMsIHN0cmF0ZWd5PSdjYXNoX2FuZF9jYXJyeScpOgogICAgICAgICMgVE9ETzogQmFja3Rlc3QgZnVuZGluZyBzdHJhdGVneQogICAgICAgIHBhc3M="><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-15-2')" type="button">Run</button></div><pre><code><span class="c1"># Exercise 15.1</span>
<span class="k">class</span> <span class="nc">FundingRateTracker</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rates</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">history</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">def</span> <span class="nf">update_rate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exchange</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">rate</span><span class="p">):</span>
        <span class="c1"># TODO</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">find_opportunities</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">min_rate</span><span class="o">=</span><span class="mf">0.0003</span><span class="p">):</span>
        <span class="c1"># TODO: Find high funding rate opportunities</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">backtest_strategy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">days</span><span class="p">,</span> <span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;cash_and_carry&#39;</span><span class="p">):</span>
        <span class="c1"># TODO: Backtest funding strategy</span>
        <span class="k">pass</span>
</code></pre><div class="code-output" id="output-cell-15-2"></div></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>

<span class="k">class</span> <span class="nc">FundingRateTracker</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rates</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># {exchange: {symbol: rate}}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">history</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># Historical rates for backtesting</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">analyzer</span> <span class="o">=</span> <span class="n">FundingRateAnalyzer</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">update_rate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exchange</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">rate</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">exchange</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rates</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rates</span><span class="p">[</span><span class="n">exchange</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">rates</span><span class="p">[</span><span class="n">exchange</span><span class="p">][</span><span class="n">symbol</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;rate&#39;</span><span class="p">:</span> <span class="n">rate</span><span class="p">,</span>
            <span class="s1">&#39;annualized&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyzer</span><span class="o">.</span><span class="n">annualized_funding</span><span class="p">(</span><span class="n">rate</span><span class="p">),</span>
            <span class="s1">&#39;updated&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;exchange&#39;</span><span class="p">:</span> <span class="n">exchange</span><span class="p">,</span>
            <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span>
            <span class="s1">&#39;rate&#39;</span><span class="p">:</span> <span class="n">rate</span><span class="p">,</span>
            <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="p">})</span>

    <span class="k">def</span> <span class="nf">find_opportunities</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">min_rate</span><span class="o">=</span><span class="mf">0.0003</span><span class="p">):</span>
        <span class="n">opportunities</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">exchange</span><span class="p">,</span> <span class="n">symbols</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rates</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">symbols</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;rate&#39;</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="n">min_rate</span><span class="p">:</span>
                    <span class="n">opportunities</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                        <span class="s1">&#39;exchange&#39;</span><span class="p">:</span> <span class="n">exchange</span><span class="p">,</span>
                        <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span>
                        <span class="s1">&#39;rate&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;rate&#39;</span><span class="p">],</span>
                        <span class="s1">&#39;annualized&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;annualized&#39;</span><span class="p">],</span>
                        <span class="s1">&#39;direction&#39;</span><span class="p">:</span> <span class="s1">&#39;Short&#39;</span> <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;rate&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;Long&#39;</span>
                    <span class="p">})</span>

        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">opportunities</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;rate&#39;</span><span class="p">]),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">find_arbitrage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">):</span>
        <span class="n">symbol_rates</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">exchange</span><span class="p">,</span> <span class="n">symbols</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rates</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="n">symbols</span><span class="p">:</span>
                <span class="n">symbol_rates</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">exchange</span><span class="p">,</span> <span class="n">symbols</span><span class="p">[</span><span class="n">symbol</span><span class="p">][</span><span class="s1">&#39;rate&#39;</span><span class="p">]))</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">symbol_rates</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">symbol_rates</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">lowest</span> <span class="o">=</span> <span class="n">symbol_rates</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">highest</span> <span class="o">=</span> <span class="n">symbol_rates</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">spread</span> <span class="o">=</span> <span class="n">highest</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">lowest</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span>
            <span class="s1">&#39;long_on&#39;</span><span class="p">:</span> <span class="n">lowest</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="s1">&#39;short_on&#39;</span><span class="p">:</span> <span class="n">highest</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="s1">&#39;spread&#39;</span><span class="p">:</span> <span class="n">spread</span><span class="p">,</span>
            <span class="s1">&#39;annualized_arb&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyzer</span><span class="o">.</span><span class="n">annualized_funding</span><span class="p">(</span><span class="n">spread</span><span class="p">)</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">backtest_strategy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">historical_rates</span><span class="p">,</span> <span class="n">capital</span><span class="p">,</span> <span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;cash_and_carry&#39;</span><span class="p">):</span>
        <span class="n">total_funding</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">rate_data</span> <span class="ow">in</span> <span class="n">historical_rates</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">strategy</span> <span class="o">==</span> <span class="s1">&#39;cash_and_carry&#39;</span> <span class="ow">and</span> <span class="n">rate_data</span><span class="p">[</span><span class="s1">&#39;rate&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># Earn positive funding by shorting perp</span>
                <span class="n">funding</span> <span class="o">=</span> <span class="n">capital</span> <span class="o">*</span> <span class="n">rate_data</span><span class="p">[</span><span class="s1">&#39;rate&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">funding</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">total_funding</span> <span class="o">+=</span> <span class="n">funding</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;total_funding_earned&#39;</span><span class="p">:</span> <span class="n">total_funding</span><span class="p">,</span>
            <span class="s1">&#39;periods&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">historical_rates</span><span class="p">),</span>
            <span class="s1">&#39;avg_per_period&#39;</span><span class="p">:</span> <span class="n">total_funding</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">historical_rates</span><span class="p">)</span> <span class="k">if</span> <span class="n">historical_rates</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="p">}</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>Section 2: Crypto Options Basics</h1></div>
<div class="code-cell" id="cell-15-3" data-source="aW1wb3J0IG1hdGgKZnJvbSBzY2lweS5zdGF0cyBpbXBvcnQgbm9ybQoKY2xhc3MgQ3J5cHRvT3B0aW9uc0FuYWx5emVyOgogICAgIiIiQmFzaWMgY3J5cHRvIG9wdGlvbnMgYW5hbHlzaXMuIiIiCiAgICAKICAgIGRlZiBibGFja19zY2hvbGVzX2NhbGwoc2VsZiwgUywgSywgVCwgciwgc2lnbWEpOgogICAgICAgICIiIgogICAgICAgIEJsYWNrLVNjaG9sZXMgY2FsbCBvcHRpb24gcHJpY2UuCiAgICAgICAgCiAgICAgICAgUzogQ3VycmVudCBwcmljZQogICAgICAgIEs6IFN0cmlrZSBwcmljZQogICAgICAgIFQ6IFRpbWUgdG8gZXhwaXJ5ICh5ZWFycykKICAgICAgICByOiBSaXNrLWZyZWUgcmF0ZQogICAgICAgIHNpZ21hOiBWb2xhdGlsaXR5CiAgICAgICAgIiIiCiAgICAgICAgaWYgVCA8PSAwOgogICAgICAgICAgICByZXR1cm4gbWF4KDAsIFMgLSBLKQogICAgICAgIAogICAgICAgIGQxID0gKG1hdGgubG9nKFMvSykgKyAociArIHNpZ21hKioyLzIpKlQpIC8gKHNpZ21hKm1hdGguc3FydChUKSkKICAgICAgICBkMiA9IGQxIC0gc2lnbWEqbWF0aC5zcXJ0KFQpCiAgICAgICAgCiAgICAgICAgY2FsbCA9IFMqbm9ybS5jZGYoZDEpIC0gSyptYXRoLmV4cCgtcipUKSpub3JtLmNkZihkMikKICAgICAgICByZXR1cm4gY2FsbAogICAgCiAgICBkZWYgYmxhY2tfc2Nob2xlc19wdXQoc2VsZiwgUywgSywgVCwgciwgc2lnbWEpOgogICAgICAgICIiIkJsYWNrLVNjaG9sZXMgcHV0IG9wdGlvbiBwcmljZS4iIiIKICAgICAgICBjYWxsID0gc2VsZi5ibGFja19zY2hvbGVzX2NhbGwoUywgSywgVCwgciwgc2lnbWEpCiAgICAgICAgcHV0ID0gY2FsbCAtIFMgKyBLKm1hdGguZXhwKC1yKlQpICAjIFB1dC1jYWxsIHBhcml0eQogICAgICAgIHJldHVybiBwdXQKICAgIAogICAgZGVmIGNhbGN1bGF0ZV9ncmVla3Moc2VsZiwgUywgSywgVCwgciwgc2lnbWEpOgogICAgICAgICIiIkNhbGN1bGF0ZSBvcHRpb24gR3JlZWtzLiIiIgogICAgICAgIGlmIFQgPD0gMDoKICAgICAgICAgICAgcmV0dXJuIHsnZGVsdGEnOiAxIGlmIFMgPiBLIGVsc2UgMCwgJ2dhbW1hJzogMCwgJ3RoZXRhJzogMCwgJ3ZlZ2EnOiAwfQogICAgICAgIAogICAgICAgIGQxID0gKG1hdGgubG9nKFMvSykgKyAociArIHNpZ21hKioyLzIpKlQpIC8gKHNpZ21hKm1hdGguc3FydChUKSkKICAgICAgICBkMiA9IGQxIC0gc2lnbWEqbWF0aC5zcXJ0KFQpCiAgICAgICAgCiAgICAgICAgZGVsdGEgPSBub3JtLmNkZihkMSkKICAgICAgICBnYW1tYSA9IG5vcm0ucGRmKGQxKSAvIChTICogc2lnbWEgKiBtYXRoLnNxcnQoVCkpCiAgICAgICAgdGhldGEgPSAoLVMgKiBub3JtLnBkZihkMSkgKiBzaWdtYSAvICgyKm1hdGguc3FydChUKSkgLSByKksqbWF0aC5leHAoLXIqVCkqbm9ybS5jZGYoZDIpKSAvIDM2NQogICAgICAgIHZlZ2EgPSBTICogbm9ybS5wZGYoZDEpICogbWF0aC5zcXJ0KFQpIC8gMTAwICAjIFBlciAxJSB2b2wgY2hhbmdlCiAgICAgICAgCiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgJ2RlbHRhJzogZGVsdGEsCiAgICAgICAgICAgICdnYW1tYSc6IGdhbW1hLAogICAgICAgICAgICAndGhldGEnOiB0aGV0YSwKICAgICAgICAgICAgJ3ZlZ2EnOiB2ZWdhCiAgICAgICAgfQogICAgCiAgICBkZWYgaW1wbGllZF92b2xhdGlsaXR5KHNlbGYsIG9wdGlvbl9wcmljZSwgUywgSywgVCwgciwgb3B0aW9uX3R5cGU9J2NhbGwnKToKICAgICAgICAiIiJDYWxjdWxhdGUgaW1wbGllZCB2b2xhdGlsaXR5IHVzaW5nIE5ld3Rvbi1SYXBoc29uLiIiIgogICAgICAgIHNpZ21hID0gMC41ICAjIEluaXRpYWwgZ3Vlc3MKICAgICAgICAKICAgICAgICBmb3IgXyBpbiByYW5nZSgxMDApOgogICAgICAgICAgICBpZiBvcHRpb25fdHlwZSA9PSAnY2FsbCc6CiAgICAgICAgICAgICAgICBwcmljZSA9IHNlbGYuYmxhY2tfc2Nob2xlc19jYWxsKFMsIEssIFQsIHIsIHNpZ21hKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgcHJpY2UgPSBzZWxmLmJsYWNrX3NjaG9sZXNfcHV0KFMsIEssIFQsIHIsIHNpZ21hKQogICAgICAgICAgICAKICAgICAgICAgICAgdmVnYSA9IHNlbGYuY2FsY3VsYXRlX2dyZWVrcyhTLCBLLCBULCByLCBzaWdtYSlbJ3ZlZ2EnXSAqIDEwMAogICAgICAgICAgICAKICAgICAgICAgICAgaWYgYWJzKHZlZ2EpIDwgMWUtMTA6CiAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAKICAgICAgICAgICAgc2lnbWEgPSBzaWdtYSAtIChwcmljZSAtIG9wdGlvbl9wcmljZSkgLyB2ZWdhCiAgICAgICAgICAgIHNpZ21hID0gbWF4KDAuMDEsIG1pbig1LCBzaWdtYSkpICAjIEJvdW5kcwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgYWJzKHByaWNlIC0gb3B0aW9uX3ByaWNlKSA8IDAuMDE6CiAgICAgICAgICAgICAgICBicmVhawogICAgICAgIAogICAgICAgIHJldHVybiBzaWdtYQoKb3B0ID0gQ3J5cHRvT3B0aW9uc0FuYWx5emVyKCkKIyBFVEggYXQgJDIwMDAsICQyMTAwIHN0cmlrZSwgMzAgZGF5cywgODAlIHZvbApjYWxsX3ByaWNlID0gb3B0LmJsYWNrX3NjaG9sZXNfY2FsbCgyMDAwLCAyMTAwLCAzMC8zNjUsIDAuMDUsIDAuOCkKcHJpbnQoZidDYWxsIHByaWNlOiAke2NhbGxfcHJpY2U6LjJmfScpCnByaW50KGYnR3JlZWtzOiB7b3B0LmNhbGN1bGF0ZV9ncmVla3MoMjAwMCwgMjEwMCwgMzAvMzY1LCAwLjA1LCAwLjgpfScp"><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-15-3')" type="button">Run</button></div><pre><code><span class="kn">import</span> <span class="nn">math</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">norm</span>

<span class="k">class</span> <span class="nc">CryptoOptionsAnalyzer</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Basic crypto options analysis.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="nf">black_scholes_call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">sigma</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Black-Scholes call option price.</span>
<span class="sd">        </span>
<span class="sd">        S: Current price</span>
<span class="sd">        K: Strike price</span>
<span class="sd">        T: Time to expiry (years)</span>
<span class="sd">        r: Risk-free rate</span>
<span class="sd">        sigma: Volatility</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">T</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">S</span> <span class="o">-</span> <span class="n">K</span><span class="p">)</span>
        
        <span class="n">d1</span> <span class="o">=</span> <span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">S</span><span class="o">/</span><span class="n">K</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">r</span> <span class="o">+</span> <span class="n">sigma</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">T</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">sigma</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">T</span><span class="p">))</span>
        <span class="n">d2</span> <span class="o">=</span> <span class="n">d1</span> <span class="o">-</span> <span class="n">sigma</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">T</span><span class="p">)</span>
        
        <span class="n">call</span> <span class="o">=</span> <span class="n">S</span><span class="o">*</span><span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">d1</span><span class="p">)</span> <span class="o">-</span> <span class="n">K</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">r</span><span class="o">*</span><span class="n">T</span><span class="p">)</span><span class="o">*</span><span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">d2</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">call</span>
    
    <span class="k">def</span> <span class="nf">black_scholes_put</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">sigma</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Black-Scholes put option price.&quot;&quot;&quot;</span>
        <span class="n">call</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">black_scholes_call</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
        <span class="n">put</span> <span class="o">=</span> <span class="n">call</span> <span class="o">-</span> <span class="n">S</span> <span class="o">+</span> <span class="n">K</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">r</span><span class="o">*</span><span class="n">T</span><span class="p">)</span>  <span class="c1"># Put-call parity</span>
        <span class="k">return</span> <span class="n">put</span>
    
    <span class="k">def</span> <span class="nf">calculate_greeks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">sigma</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculate option Greeks.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">T</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;delta&#39;</span><span class="p">:</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">S</span> <span class="o">&gt;</span> <span class="n">K</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;gamma&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;theta&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;vega&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
        
        <span class="n">d1</span> <span class="o">=</span> <span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">S</span><span class="o">/</span><span class="n">K</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">r</span> <span class="o">+</span> <span class="n">sigma</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">T</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">sigma</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">T</span><span class="p">))</span>
        <span class="n">d2</span> <span class="o">=</span> <span class="n">d1</span> <span class="o">-</span> <span class="n">sigma</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">T</span><span class="p">)</span>
        
        <span class="n">delta</span> <span class="o">=</span> <span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">d1</span><span class="p">)</span>
        <span class="n">gamma</span> <span class="o">=</span> <span class="n">norm</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">d1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">S</span> <span class="o">*</span> <span class="n">sigma</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">T</span><span class="p">))</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">S</span> <span class="o">*</span> <span class="n">norm</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">d1</span><span class="p">)</span> <span class="o">*</span> <span class="n">sigma</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">T</span><span class="p">))</span> <span class="o">-</span> <span class="n">r</span><span class="o">*</span><span class="n">K</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">r</span><span class="o">*</span><span class="n">T</span><span class="p">)</span><span class="o">*</span><span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">d2</span><span class="p">))</span> <span class="o">/</span> <span class="mi">365</span>
        <span class="n">vega</span> <span class="o">=</span> <span class="n">S</span> <span class="o">*</span> <span class="n">norm</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">d1</span><span class="p">)</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">T</span><span class="p">)</span> <span class="o">/</span> <span class="mi">100</span>  <span class="c1"># Per 1% vol change</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;delta&#39;</span><span class="p">:</span> <span class="n">delta</span><span class="p">,</span>
            <span class="s1">&#39;gamma&#39;</span><span class="p">:</span> <span class="n">gamma</span><span class="p">,</span>
            <span class="s1">&#39;theta&#39;</span><span class="p">:</span> <span class="n">theta</span><span class="p">,</span>
            <span class="s1">&#39;vega&#39;</span><span class="p">:</span> <span class="n">vega</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">implied_volatility</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">option_price</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">option_type</span><span class="o">=</span><span class="s1">&#39;call&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculate implied volatility using Newton-Raphson.&quot;&quot;&quot;</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="mf">0.5</span>  <span class="c1"># Initial guess</span>
        
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">option_type</span> <span class="o">==</span> <span class="s1">&#39;call&#39;</span><span class="p">:</span>
                <span class="n">price</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">black_scholes_call</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">price</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">black_scholes_put</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
            
            <span class="n">vega</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_greeks</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)[</span><span class="s1">&#39;vega&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span>
            
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">vega</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-10</span><span class="p">:</span>
                <span class="k">break</span>
            
            <span class="n">sigma</span> <span class="o">=</span> <span class="n">sigma</span> <span class="o">-</span> <span class="p">(</span><span class="n">price</span> <span class="o">-</span> <span class="n">option_price</span><span class="p">)</span> <span class="o">/</span> <span class="n">vega</span>
            <span class="n">sigma</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.01</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">sigma</span><span class="p">))</span>  <span class="c1"># Bounds</span>
            
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">price</span> <span class="o">-</span> <span class="n">option_price</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.01</span><span class="p">:</span>
                <span class="k">break</span>
        
        <span class="k">return</span> <span class="n">sigma</span>

<span class="n">opt</span> <span class="o">=</span> <span class="n">CryptoOptionsAnalyzer</span><span class="p">()</span>
<span class="c1"># ETH at $2000, $2100 strike, 30 days, 80% vol</span>
<span class="n">call_price</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">black_scholes_call</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span> <span class="mi">2100</span><span class="p">,</span> <span class="mi">30</span><span class="o">/</span><span class="mi">365</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Call price: $</span><span class="si">{</span><span class="n">call_price</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Greeks: </span><span class="si">{</span><span class="n">opt</span><span class="o">.</span><span class="n">calculate_greeks</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span> <span class="mi">2100</span><span class="p">,</span> <span class="mi">30</span><span class="o">/</span><span class="mi">365</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</code></pre><div class="code-output" id="output-cell-15-3"></div></div>
<div class="md-cell"><h3>âœï¸ Exercise 15.2: Options Strategy Analyzer</h3>
<p>Build an options strategy analysis tool.</p></div>
<div class="code-cell" id="cell-15-4" data-source="IyBFeGVyY2lzZSAxNS4yCmNsYXNzIE9wdGlvbnNTdHJhdGVneUFuYWx5emVyOgogICAgZGVmIF9faW5pdF9fKHNlbGYpOgogICAgICAgIHNlbGYuYW5hbHl6ZXIgPSBDcnlwdG9PcHRpb25zQW5hbHl6ZXIoKQogICAgCiAgICBkZWYgc3RyYWRkbGUoc2VsZiwgUywgSywgVCwgciwgc2lnbWEpOgogICAgICAgICMgVE9ETzogTG9uZyBjYWxsICsgTG9uZyBwdXQgYXQgc2FtZSBzdHJpa2UKICAgICAgICBwYXNzCiAgICAKICAgIGRlZiBzdHJhbmdsZShzZWxmLCBTLCBLX3B1dCwgS19jYWxsLCBULCByLCBzaWdtYSk6CiAgICAgICAgIyBUT0RPOiBMb25nIE9UTSBwdXQgKyBMb25nIE9UTSBjYWxsCiAgICAgICAgcGFzcwogICAgCiAgICBkZWYgY292ZXJlZF9jYWxsKHNlbGYsIFMsIEssIFQsIHIsIHNpZ21hLCBlbnRyeV9wcmljZSk6CiAgICAgICAgIyBUT0RPOiBMb25nIHNwb3QgKyBTaG9ydCBjYWxsCiAgICAgICAgcGFzcw=="><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-15-4')" type="button">Run</button></div><pre><code><span class="c1"># Exercise 15.2</span>
<span class="k">class</span> <span class="nc">OptionsStrategyAnalyzer</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">analyzer</span> <span class="o">=</span> <span class="n">CryptoOptionsAnalyzer</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">straddle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">sigma</span><span class="p">):</span>
        <span class="c1"># TODO: Long call + Long put at same strike</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">strangle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">K_put</span><span class="p">,</span> <span class="n">K_call</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">sigma</span><span class="p">):</span>
        <span class="c1"># TODO: Long OTM put + Long OTM call</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">covered_call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">entry_price</span><span class="p">):</span>
        <span class="c1"># TODO: Long spot + Short call</span>
        <span class="k">pass</span>
</code></pre><div class="code-output" id="output-cell-15-4"></div></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">OptionsStrategyAnalyzer</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">analyzer</span> <span class="o">=</span> <span class="n">CryptoOptionsAnalyzer</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">straddle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">sigma</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Long straddle: Buy call + put at same strike.&quot;&quot;&quot;</span>
        <span class="n">call</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyzer</span><span class="o">.</span><span class="n">black_scholes_call</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
        <span class="n">put</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyzer</span><span class="o">.</span><span class="n">black_scholes_put</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>

        <span class="n">total_cost</span> <span class="o">=</span> <span class="n">call</span> <span class="o">+</span> <span class="n">put</span>
        <span class="n">breakeven_up</span> <span class="o">=</span> <span class="n">K</span> <span class="o">+</span> <span class="n">total_cost</span>
        <span class="n">breakeven_down</span> <span class="o">=</span> <span class="n">K</span> <span class="o">-</span> <span class="n">total_cost</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;strategy&#39;</span><span class="p">:</span> <span class="s1">&#39;Long Straddle&#39;</span><span class="p">,</span>
            <span class="s1">&#39;call_cost&#39;</span><span class="p">:</span> <span class="n">call</span><span class="p">,</span>
            <span class="s1">&#39;put_cost&#39;</span><span class="p">:</span> <span class="n">put</span><span class="p">,</span>
            <span class="s1">&#39;total_cost&#39;</span><span class="p">:</span> <span class="n">total_cost</span><span class="p">,</span>
            <span class="s1">&#39;breakeven_up&#39;</span><span class="p">:</span> <span class="n">breakeven_up</span><span class="p">,</span>
            <span class="s1">&#39;breakeven_down&#39;</span><span class="p">:</span> <span class="n">breakeven_down</span><span class="p">,</span>
            <span class="s1">&#39;max_loss&#39;</span><span class="p">:</span> <span class="n">total_cost</span><span class="p">,</span>
            <span class="s1">&#39;max_profit&#39;</span><span class="p">:</span> <span class="s1">&#39;Unlimited&#39;</span><span class="p">,</span>
            <span class="s1">&#39;profit_if&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Price moves more than $</span><span class="si">{</span><span class="n">total_cost</span><span class="si">:</span><span class="s1">.0f</span><span class="si">}</span><span class="s1"> from $</span><span class="si">{</span><span class="n">K</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">strangle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">K_put</span><span class="p">,</span> <span class="n">K_call</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">sigma</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Long strangle: Buy OTM put + OTM call.&quot;&quot;&quot;</span>
        <span class="n">call</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyzer</span><span class="o">.</span><span class="n">black_scholes_call</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">K_call</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
        <span class="n">put</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyzer</span><span class="o">.</span><span class="n">black_scholes_put</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">K_put</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>

        <span class="n">total_cost</span> <span class="o">=</span> <span class="n">call</span> <span class="o">+</span> <span class="n">put</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;strategy&#39;</span><span class="p">:</span> <span class="s1">&#39;Long Strangle&#39;</span><span class="p">,</span>
            <span class="s1">&#39;call_strike&#39;</span><span class="p">:</span> <span class="n">K_call</span><span class="p">,</span>
            <span class="s1">&#39;put_strike&#39;</span><span class="p">:</span> <span class="n">K_put</span><span class="p">,</span>
            <span class="s1">&#39;total_cost&#39;</span><span class="p">:</span> <span class="n">total_cost</span><span class="p">,</span>
            <span class="s1">&#39;breakeven_up&#39;</span><span class="p">:</span> <span class="n">K_call</span> <span class="o">+</span> <span class="n">total_cost</span><span class="p">,</span>
            <span class="s1">&#39;breakeven_down&#39;</span><span class="p">:</span> <span class="n">K_put</span> <span class="o">-</span> <span class="n">total_cost</span><span class="p">,</span>
            <span class="s1">&#39;max_loss&#39;</span><span class="p">:</span> <span class="n">total_cost</span><span class="p">,</span>
            <span class="s1">&#39;cheaper_than_straddle&#39;</span><span class="p">:</span> <span class="kc">True</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">covered_call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">entry_price</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Covered call: Long spot + Short call.&quot;&quot;&quot;</span>
        <span class="n">call_premium</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyzer</span><span class="o">.</span><span class="n">black_scholes_call</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>

        <span class="c1"># Max profit if price &gt;= strike at expiry</span>
        <span class="n">max_profit</span> <span class="o">=</span> <span class="p">(</span><span class="n">K</span> <span class="o">-</span> <span class="n">entry_price</span><span class="p">)</span> <span class="o">+</span> <span class="n">call_premium</span>

        <span class="c1"># Breakeven</span>
        <span class="n">breakeven</span> <span class="o">=</span> <span class="n">entry_price</span> <span class="o">-</span> <span class="n">call_premium</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;strategy&#39;</span><span class="p">:</span> <span class="s1">&#39;Covered Call&#39;</span><span class="p">,</span>
            <span class="s1">&#39;spot_entry&#39;</span><span class="p">:</span> <span class="n">entry_price</span><span class="p">,</span>
            <span class="s1">&#39;call_strike&#39;</span><span class="p">:</span> <span class="n">K</span><span class="p">,</span>
            <span class="s1">&#39;premium_received&#39;</span><span class="p">:</span> <span class="n">call_premium</span><span class="p">,</span>
            <span class="s1">&#39;max_profit&#39;</span><span class="p">:</span> <span class="n">max_profit</span><span class="p">,</span>
            <span class="s1">&#39;breakeven&#39;</span><span class="p">:</span> <span class="n">breakeven</span><span class="p">,</span>
            <span class="s1">&#39;yield_if_called&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">max_profit</span> <span class="o">/</span> <span class="n">entry_price</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
            <span class="s1">&#39;yield_from_premium&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">call_premium</span> <span class="o">/</span> <span class="n">entry_price</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
        <span class="p">}</span>

<span class="n">strat</span> <span class="o">=</span> <span class="n">OptionsStrategyAnalyzer</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">strat</span><span class="o">.</span><span class="n">straddle</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span> <span class="mi">2000</span><span class="p">,</span> <span class="mi">30</span><span class="o">/</span><span class="mi">365</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">))</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>Section 3: Market Making Concepts</h1></div>
<div class="code-cell" id="cell-15-5" data-source="Y2xhc3MgU2ltcGxlTWFya2V0TWFrZXI6CiAgICAiIiIKICAgIFNpbXBsZSBtYXJrZXQgbWFraW5nIHNpbXVsYXRpb24uCiAgICAKICAgIE1hcmtldCBtYWtlcnMgcHJvdmlkZSBsaXF1aWRpdHkgYnkgcGxhY2luZyBib3RoCiAgICBidXkgYW5kIHNlbGwgb3JkZXJzLCBwcm9maXRpbmcgZnJvbSB0aGUgc3ByZWFkLgogICAgIiIiCiAgICAKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBiYXNlX3NwcmVhZD0wLjAwMSwgaW52ZW50b3J5X2xpbWl0PTEwKToKICAgICAgICBzZWxmLmJhc2Vfc3ByZWFkID0gYmFzZV9zcHJlYWQgICMgMC4xJQogICAgICAgIHNlbGYuaW52ZW50b3J5X2xpbWl0ID0gaW52ZW50b3J5X2xpbWl0CiAgICAgICAgc2VsZi5pbnZlbnRvcnkgPSAwCiAgICAgICAgc2VsZi5jYXNoID0gMTAwMDAKICAgICAgICBzZWxmLnRyYWRlcyA9IFtdCiAgICAKICAgIGRlZiBjYWxjdWxhdGVfcXVvdGVzKHNlbGYsIG1pZF9wcmljZSk6CiAgICAgICAgIiIiCiAgICAgICAgQ2FsY3VsYXRlIGJpZCBhbmQgYXNrIHByaWNlcy4KICAgICAgICAKICAgICAgICBBZGp1c3RzIHNwcmVhZCBiYXNlZCBvbiBpbnZlbnRvcnkgdG8gcmVkdWNlIHJpc2suCiAgICAgICAgIiIiCiAgICAgICAgIyBJbnZlbnRvcnkgc2tldzogaWYgd2UncmUgbG9uZywgbG93ZXIgYmlkIHRvIGJ1eSBsZXNzCiAgICAgICAgaW52ZW50b3J5X3NrZXcgPSBzZWxmLmludmVudG9yeSAvIHNlbGYuaW52ZW50b3J5X2xpbWl0ICogc2VsZi5iYXNlX3NwcmVhZAogICAgICAgIAogICAgICAgIGhhbGZfc3ByZWFkID0gc2VsZi5iYXNlX3NwcmVhZCAvIDIKICAgICAgICAKICAgICAgICBiaWQgPSBtaWRfcHJpY2UgKiAoMSAtIGhhbGZfc3ByZWFkIC0gaW52ZW50b3J5X3NrZXcpCiAgICAgICAgYXNrID0gbWlkX3ByaWNlICogKDEgKyBoYWxmX3NwcmVhZCAtIGludmVudG9yeV9za2V3KQogICAgICAgIAogICAgICAgIHJldHVybiB7J2JpZCc6IGJpZCwgJ2Fzayc6IGFzaywgJ3NwcmVhZCc6IGFzayAtIGJpZH0KICAgIAogICAgZGVmIG9uX2ZpbGwoc2VsZiwgc2lkZSwgcHJpY2UsIHNpemUpOgogICAgICAgICIiIlByb2Nlc3MgYSBmaWxsLiIiIgogICAgICAgIGlmIHNpZGUgPT0gJ2J1eSc6CiAgICAgICAgICAgIHNlbGYuaW52ZW50b3J5ICs9IHNpemUKICAgICAgICAgICAgc2VsZi5jYXNoIC09IHByaWNlICogc2l6ZQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHNlbGYuaW52ZW50b3J5IC09IHNpemUKICAgICAgICAgICAgc2VsZi5jYXNoICs9IHByaWNlICogc2l6ZQogICAgICAgIAogICAgICAgIHNlbGYudHJhZGVzLmFwcGVuZCh7CiAgICAgICAgICAgICdzaWRlJzogc2lkZSwKICAgICAgICAgICAgJ3ByaWNlJzogcHJpY2UsCiAgICAgICAgICAgICdzaXplJzogc2l6ZSwKICAgICAgICAgICAgJ2ludmVudG9yeV9hZnRlcic6IHNlbGYuaW52ZW50b3J5CiAgICAgICAgfSkKICAgIAogICAgZGVmIGdldF9wbmwoc2VsZiwgY3VycmVudF9wcmljZSk6CiAgICAgICAgIiIiQ2FsY3VsYXRlIGN1cnJlbnQgUG5MLiIiIgogICAgICAgIGludmVudG9yeV92YWx1ZSA9IHNlbGYuaW52ZW50b3J5ICogY3VycmVudF9wcmljZQogICAgICAgIHRvdGFsX3ZhbHVlID0gc2VsZi5jYXNoICsgaW52ZW50b3J5X3ZhbHVlCiAgICAgICAgcG5sID0gdG90YWxfdmFsdWUgLSAxMDAwMCAgIyBTdGFydGluZyBjYXNoCiAgICAgICAgCiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgJ2Nhc2gnOiBzZWxmLmNhc2gsCiAgICAgICAgICAgICdpbnZlbnRvcnknOiBzZWxmLmludmVudG9yeSwKICAgICAgICAgICAgJ2ludmVudG9yeV92YWx1ZSc6IGludmVudG9yeV92YWx1ZSwKICAgICAgICAgICAgJ3RvdGFsX3ZhbHVlJzogdG90YWxfdmFsdWUsCiAgICAgICAgICAgICdwbmwnOiBwbmwsCiAgICAgICAgICAgICdudW1fdHJhZGVzJzogbGVuKHNlbGYudHJhZGVzKQogICAgICAgIH0KICAgIAogICAgZGVmIHNpbXVsYXRlX3RyYWRpbmcoc2VsZiwgcHJpY2VzLCBmaWxsX3Byb2JhYmlsaXR5PTAuMyk6CiAgICAgICAgIiIiU2ltdWxhdGUgbWFya2V0IG1ha2luZyBvdmVyIHByaWNlIHNlcmllcy4iIiIKICAgICAgICBpbXBvcnQgcmFuZG9tCiAgICAgICAgCiAgICAgICAgZm9yIHByaWNlIGluIHByaWNlczoKICAgICAgICAgICAgcXVvdGVzID0gc2VsZi5jYWxjdWxhdGVfcXVvdGVzKHByaWNlKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBSYW5kb20gZmlsbHMgKHNpbXBsaWZpZWQpCiAgICAgICAgICAgIGlmIHJhbmRvbS5yYW5kb20oKSA8IGZpbGxfcHJvYmFiaWxpdHk6CiAgICAgICAgICAgICAgICBpZiByYW5kb20ucmFuZG9tKCkgPCAwLjU6CiAgICAgICAgICAgICAgICAgICAgIyBCdXkgZmlsbAogICAgICAgICAgICAgICAgICAgIGlmIGFicyhzZWxmLmludmVudG9yeSkgPCBzZWxmLmludmVudG9yeV9saW1pdDoKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5vbl9maWxsKCdidXknLCBxdW90ZXNbJ2JpZCddLCAwLjEpCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICMgU2VsbCBmaWxsCiAgICAgICAgICAgICAgICAgICAgaWYgYWJzKHNlbGYuaW52ZW50b3J5KSA8IHNlbGYuaW52ZW50b3J5X2xpbWl0OgogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLm9uX2ZpbGwoJ3NlbGwnLCBxdW90ZXNbJ2FzayddLCAwLjEpCiAgICAgICAgCiAgICAgICAgcmV0dXJuIHNlbGYuZ2V0X3BubChwcmljZXNbLTFdKQ=="><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-15-5')" type="button">Run</button></div><pre><code><span class="k">class</span> <span class="nc">SimpleMarketMaker</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Simple market making simulation.</span>
<span class="sd">    </span>
<span class="sd">    Market makers provide liquidity by placing both</span>
<span class="sd">    buy and sell orders, profiting from the spread.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base_spread</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">inventory_limit</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_spread</span> <span class="o">=</span> <span class="n">base_spread</span>  <span class="c1"># 0.1%</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inventory_limit</span> <span class="o">=</span> <span class="n">inventory_limit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inventory</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cash</span> <span class="o">=</span> <span class="mi">10000</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trades</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">def</span> <span class="nf">calculate_quotes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mid_price</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate bid and ask prices.</span>
<span class="sd">        </span>
<span class="sd">        Adjusts spread based on inventory to reduce risk.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Inventory skew: if we&#39;re long, lower bid to buy less</span>
        <span class="n">inventory_skew</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inventory</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">inventory_limit</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_spread</span>
        
        <span class="n">half_spread</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_spread</span> <span class="o">/</span> <span class="mi">2</span>
        
        <span class="n">bid</span> <span class="o">=</span> <span class="n">mid_price</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">half_spread</span> <span class="o">-</span> <span class="n">inventory_skew</span><span class="p">)</span>
        <span class="n">ask</span> <span class="o">=</span> <span class="n">mid_price</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">half_spread</span> <span class="o">-</span> <span class="n">inventory_skew</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;bid&#39;</span><span class="p">:</span> <span class="n">bid</span><span class="p">,</span> <span class="s1">&#39;ask&#39;</span><span class="p">:</span> <span class="n">ask</span><span class="p">,</span> <span class="s1">&#39;spread&#39;</span><span class="p">:</span> <span class="n">ask</span> <span class="o">-</span> <span class="n">bid</span><span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">on_fill</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">side</span><span class="p">,</span> <span class="n">price</span><span class="p">,</span> <span class="n">size</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Process a fill.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">side</span> <span class="o">==</span> <span class="s1">&#39;buy&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inventory</span> <span class="o">+=</span> <span class="n">size</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cash</span> <span class="o">-=</span> <span class="n">price</span> <span class="o">*</span> <span class="n">size</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inventory</span> <span class="o">-=</span> <span class="n">size</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cash</span> <span class="o">+=</span> <span class="n">price</span> <span class="o">*</span> <span class="n">size</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">trades</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;side&#39;</span><span class="p">:</span> <span class="n">side</span><span class="p">,</span>
            <span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="n">price</span><span class="p">,</span>
            <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="n">size</span><span class="p">,</span>
            <span class="s1">&#39;inventory_after&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">inventory</span>
        <span class="p">})</span>
    
    <span class="k">def</span> <span class="nf">get_pnl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current_price</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculate current PnL.&quot;&quot;&quot;</span>
        <span class="n">inventory_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inventory</span> <span class="o">*</span> <span class="n">current_price</span>
        <span class="n">total_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cash</span> <span class="o">+</span> <span class="n">inventory_value</span>
        <span class="n">pnl</span> <span class="o">=</span> <span class="n">total_value</span> <span class="o">-</span> <span class="mi">10000</span>  <span class="c1"># Starting cash</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;cash&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cash</span><span class="p">,</span>
            <span class="s1">&#39;inventory&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">inventory</span><span class="p">,</span>
            <span class="s1">&#39;inventory_value&#39;</span><span class="p">:</span> <span class="n">inventory_value</span><span class="p">,</span>
            <span class="s1">&#39;total_value&#39;</span><span class="p">:</span> <span class="n">total_value</span><span class="p">,</span>
            <span class="s1">&#39;pnl&#39;</span><span class="p">:</span> <span class="n">pnl</span><span class="p">,</span>
            <span class="s1">&#39;num_trades&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trades</span><span class="p">)</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">simulate_trading</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prices</span><span class="p">,</span> <span class="n">fill_probability</span><span class="o">=</span><span class="mf">0.3</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Simulate market making over price series.&quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">random</span>
        
        <span class="k">for</span> <span class="n">price</span> <span class="ow">in</span> <span class="n">prices</span><span class="p">:</span>
            <span class="n">quotes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_quotes</span><span class="p">(</span><span class="n">price</span><span class="p">)</span>
            
            <span class="c1"># Random fills (simplified)</span>
            <span class="k">if</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">fill_probability</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="p">:</span>
                    <span class="c1"># Buy fill</span>
                    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inventory</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">inventory_limit</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">on_fill</span><span class="p">(</span><span class="s1">&#39;buy&#39;</span><span class="p">,</span> <span class="n">quotes</span><span class="p">[</span><span class="s1">&#39;bid&#39;</span><span class="p">],</span> <span class="mf">0.1</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Sell fill</span>
                    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inventory</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">inventory_limit</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">on_fill</span><span class="p">(</span><span class="s1">&#39;sell&#39;</span><span class="p">,</span> <span class="n">quotes</span><span class="p">[</span><span class="s1">&#39;ask&#39;</span><span class="p">],</span> <span class="mf">0.1</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_pnl</span><span class="p">(</span><span class="n">prices</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</code></pre><div class="code-output" id="output-cell-15-5"></div></div>
<div class="md-cell"><h3>âœï¸ Exercise 15.3: Market Maker Simulator</h3>
<p>Build a more sophisticated market maker.</p></div>
<div class="code-cell" id="cell-15-6" data-source="IyBFeGVyY2lzZSAxNS4zCmNsYXNzIEFkdmFuY2VkTWFya2V0TWFrZXI6CiAgICBkZWYgX19pbml0X18oc2VsZiwgY29uZmlnKToKICAgICAgICBzZWxmLmNvbmZpZyA9IGNvbmZpZwogICAgICAgIHNlbGYuaW52ZW50b3J5ID0gMAogICAgICAgIHNlbGYub3JkZXJzID0geydiaWRzJzogW10sICdhc2tzJzogW119CiAgICAKICAgIGRlZiBjYWxjdWxhdGVfb3B0aW1hbF9zcHJlYWQoc2VsZiwgdm9sYXRpbGl0eSwgaW52ZW50b3J5KToKICAgICAgICAjIFRPRE86IEFkanVzdCBzcHJlYWQgYmFzZWQgb24gdm9sYXRpbGl0eSBhbmQgaW52ZW50b3J5CiAgICAgICAgcGFzcwogICAgCiAgICBkZWYgcGxhY2Vfb3JkZXJzKHNlbGYsIG1pZF9wcmljZSwgZGVwdGg9NSk6CiAgICAgICAgIyBUT0RPOiBQbGFjZSBtdWx0aXBsZSBvcmRlcnMgYXQgZGlmZmVyZW50IGxldmVscwogICAgICAgIHBhc3MKICAgIAogICAgZGVmIG1hbmFnZV9pbnZlbnRvcnlfcmlzayhzZWxmKToKICAgICAgICAjIFRPRE86IEhlZGdlIG9yIGFkanVzdCBpZiBpbnZlbnRvcnkgdG9vIGxhcmdlCiAgICAgICAgcGFzcw=="><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-15-6')" type="button">Run</button></div><pre><code><span class="c1"># Exercise 15.3</span>
<span class="k">class</span> <span class="nc">AdvancedMarketMaker</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inventory</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">orders</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;bids&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;asks&#39;</span><span class="p">:</span> <span class="p">[]}</span>
    
    <span class="k">def</span> <span class="nf">calculate_optimal_spread</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">volatility</span><span class="p">,</span> <span class="n">inventory</span><span class="p">):</span>
        <span class="c1"># TODO: Adjust spread based on volatility and inventory</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">place_orders</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mid_price</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
        <span class="c1"># TODO: Place multiple orders at different levels</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">manage_inventory_risk</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># TODO: Hedge or adjust if inventory too large</span>
        <span class="k">pass</span>
</code></pre><div class="code-output" id="output-cell-15-6"></div></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">AdvancedMarketMaker</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_spread</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;base_spread&#39;</span><span class="p">,</span> <span class="mf">0.001</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inventory_limit</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;inventory_limit&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inventory</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">orders</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;bids&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;asks&#39;</span><span class="p">:</span> <span class="p">[]}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pnl_history</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">calculate_optimal_spread</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">volatility</span><span class="p">,</span> <span class="n">inventory</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Widen spread in volatile markets or when inventory is high.&quot;&quot;&quot;</span>
        <span class="c1"># Volatility adjustment</span>
        <span class="n">vol_multiplier</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">volatility</span> <span class="o">*</span> <span class="mi">10</span>  <span class="c1"># Higher vol = wider spread</span>

        <span class="c1"># Inventory adjustment</span>
        <span class="n">inv_ratio</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">inventory</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">inventory_limit</span>
        <span class="n">inv_multiplier</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">inv_ratio</span> <span class="o">*</span> <span class="mf">0.5</span>

        <span class="n">optimal_spread</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_spread</span> <span class="o">*</span> <span class="n">vol_multiplier</span> <span class="o">*</span> <span class="n">inv_multiplier</span>

        <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">optimal_spread</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">)</span>  <span class="c1"># Cap at 1%</span>

    <span class="k">def</span> <span class="nf">place_orders</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mid_price</span><span class="p">,</span> <span class="n">volatility</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Place orders at multiple price levels.&quot;&quot;&quot;</span>
        <span class="n">spread</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_optimal_spread</span><span class="p">(</span><span class="n">volatility</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">inventory</span><span class="p">)</span>

        <span class="c1"># Inventory skew</span>
        <span class="n">skew</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inventory</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">inventory_limit</span><span class="p">)</span> <span class="o">*</span> <span class="n">spread</span> <span class="o">*</span> <span class="mf">0.5</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">orders</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;bids&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;asks&#39;</span><span class="p">:</span> <span class="p">[]}</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">depth</span><span class="p">):</span>
            <span class="n">level_spread</span> <span class="o">=</span> <span class="n">spread</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mf">0.2</span><span class="p">)</span>  <span class="c1"># Wider at further levels</span>

            <span class="n">bid_price</span> <span class="o">=</span> <span class="n">mid_price</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">level_spread</span><span class="o">/</span><span class="mi">2</span> <span class="o">-</span> <span class="n">skew</span><span class="p">)</span>
            <span class="n">ask_price</span> <span class="o">=</span> <span class="n">mid_price</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">level_spread</span><span class="o">/</span><span class="mi">2</span> <span class="o">-</span> <span class="n">skew</span><span class="p">)</span>

            <span class="c1"># Smaller sizes at further levels</span>
            <span class="n">size</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">orders</span><span class="p">[</span><span class="s1">&#39;bids&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="n">bid_price</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="n">size</span><span class="p">,</span> <span class="s1">&#39;level&#39;</span><span class="p">:</span> <span class="n">i</span><span class="p">})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">orders</span><span class="p">[</span><span class="s1">&#39;asks&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="n">ask_price</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="n">size</span><span class="p">,</span> <span class="s1">&#39;level&#39;</span><span class="p">:</span> <span class="n">i</span><span class="p">})</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">orders</span>

    <span class="k">def</span> <span class="nf">manage_inventory_risk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current_price</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Manage inventory risk.&quot;&quot;&quot;</span>
        <span class="n">inv_ratio</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inventory</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">inventory_limit</span>

        <span class="n">actions</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">inv_ratio</span> <span class="o">&gt;</span> <span class="mf">0.8</span><span class="p">:</span>
            <span class="c1"># High inventory - need to reduce</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inventory</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">actions</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="s1">&#39;REDUCE_LONG&#39;</span><span class="p">,</span> <span class="s1">&#39;urgency&#39;</span><span class="p">:</span> <span class="s1">&#39;HIGH&#39;</span><span class="p">})</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">actions</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="s1">&#39;REDUCE_SHORT&#39;</span><span class="p">,</span> <span class="s1">&#39;urgency&#39;</span><span class="p">:</span> <span class="s1">&#39;HIGH&#39;</span><span class="p">})</span>
        <span class="k">elif</span> <span class="n">inv_ratio</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">:</span>
            <span class="n">actions</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="s1">&#39;WIDEN_SPREAD&#39;</span><span class="p">,</span> <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="s1">&#39;Moderate inventory&#39;</span><span class="p">})</span>

        <span class="c1"># Calculate inventory PnL risk</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inventory</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">risk_1pct</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inventory</span> <span class="o">*</span> <span class="n">current_price</span> <span class="o">*</span> <span class="mf">0.01</span><span class="p">)</span>
            <span class="n">actions</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;inventory_risk_1pct_move&#39;</span><span class="p">:</span> <span class="n">risk_1pct</span><span class="p">})</span>

        <span class="k">return</span> <span class="n">actions</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>Section 4: Cross-Exchange Strategies</h1></div>
<div class="code-cell" id="cell-15-7" data-source="Y2xhc3MgQ3Jvc3NFeGNoYW5nZVRyYWRlcjoKICAgICIiIlRyYWRlIGFjcm9zcyBtdWx0aXBsZSBleGNoYW5nZXMuIiIiCiAgICAKICAgIGRlZiBfX2luaXRfXyhzZWxmKToKICAgICAgICBzZWxmLmV4Y2hhbmdlcyA9IHt9CiAgICAgICAgc2VsZi5iYWxhbmNlcyA9IHt9CiAgICAKICAgIGRlZiBhZGRfZXhjaGFuZ2Uoc2VsZiwgbmFtZSwgYXBpKToKICAgICAgICBzZWxmLmV4Y2hhbmdlc1tuYW1lXSA9IGFwaQogICAgCiAgICBkZWYgZ2V0X2FsbF9wcmljZXMoc2VsZiwgc3ltYm9sKToKICAgICAgICAiIiJHZXQgcHJpY2VzIGZyb20gYWxsIGV4Y2hhbmdlcy4iIiIKICAgICAgICBwcmljZXMgPSB7fQogICAgICAgIGZvciBuYW1lLCBhcGkgaW4gc2VsZi5leGNoYW5nZXMuaXRlbXMoKToKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgdGlja2VyID0gYXBpLmZldGNoX3RpY2tlcihzeW1ib2wpCiAgICAgICAgICAgICAgICBwcmljZXNbbmFtZV0gPSB7CiAgICAgICAgICAgICAgICAgICAgJ2JpZCc6IHRpY2tlclsnYmlkJ10sCiAgICAgICAgICAgICAgICAgICAgJ2Fzayc6IHRpY2tlclsnYXNrJ10sCiAgICAgICAgICAgICAgICAgICAgJ2xhc3QnOiB0aWNrZXJbJ2xhc3QnXQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgIHJldHVybiBwcmljZXMKICAgIAogICAgZGVmIGZpbmRfcHJpY2VfZGlzY3JlcGFuY3koc2VsZiwgc3ltYm9sLCBtaW5fc3ByZWFkPTAuMDAxKToKICAgICAgICAiIiJGaW5kIHByaWNlIGRpc2NyZXBhbmNpZXMgYmV0d2VlbiBleGNoYW5nZXMuIiIiCiAgICAgICAgcHJpY2VzID0gc2VsZi5nZXRfYWxsX3ByaWNlcyhzeW1ib2wpCiAgICAgICAgCiAgICAgICAgaWYgbGVuKHByaWNlcykgPCAyOgogICAgICAgICAgICByZXR1cm4gTm9uZQogICAgICAgIAogICAgICAgICMgRmluZCBiZXN0IGJpZCAod2hlcmUgdG8gc2VsbCkgYW5kIGJlc3QgYXNrICh3aGVyZSB0byBidXkpCiAgICAgICAgYmVzdF9iaWQgPSBtYXgocHJpY2VzLml0ZW1zKCksIGtleT1sYW1iZGEgeDogeFsxXVsnYmlkJ10pCiAgICAgICAgYmVzdF9hc2sgPSBtaW4ocHJpY2VzLml0ZW1zKCksIGtleT1sYW1iZGEgeDogeFsxXVsnYXNrJ10pCiAgICAgICAgCiAgICAgICAgc3ByZWFkID0gKGJlc3RfYmlkWzFdWydiaWQnXSAtIGJlc3RfYXNrWzFdWydhc2snXSkgLyBiZXN0X2Fza1sxXVsnYXNrJ10KICAgICAgICAKICAgICAgICBpZiBzcHJlYWQgPiBtaW5fc3ByZWFkOgogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgJ2J1eV9vbic6IGJlc3RfYXNrWzBdLAogICAgICAgICAgICAgICAgJ2J1eV9wcmljZSc6IGJlc3RfYXNrWzFdWydhc2snXSwKICAgICAgICAgICAgICAgICdzZWxsX29uJzogYmVzdF9iaWRbMF0sCiAgICAgICAgICAgICAgICAnc2VsbF9wcmljZSc6IGJlc3RfYmlkWzFdWydiaWQnXSwKICAgICAgICAgICAgICAgICdzcHJlYWRfcGN0Jzogc3ByZWFkICogMTAwLAogICAgICAgICAgICAgICAgJ2FsbF9wcmljZXMnOiBwcmljZXMKICAgICAgICAgICAgfQogICAgICAgIHJldHVybiBOb25lCiAgICAKICAgIGRlZiBjYWxjdWxhdGVfYXJiaXRyYWdlX3Byb2ZpdChzZWxmLCBvcHBvcnR1bml0eSwgYW1vdW50LCBmZWVzKToKICAgICAgICAiIiIKICAgICAgICBDYWxjdWxhdGUgbmV0IHByb2ZpdCBmcm9tIGNyb3NzLWV4Y2hhbmdlIGFyYml0cmFnZS4KICAgICAgICAKICAgICAgICBmZWVzOiBkaWN0IHdpdGggZXhjaGFuZ2UgZmVlcwogICAgICAgICIiIgogICAgICAgIGJ1eV9jb3N0ID0gYW1vdW50ICogb3Bwb3J0dW5pdHlbJ2J1eV9wcmljZSddICogKDEgKyBmZWVzLmdldChvcHBvcnR1bml0eVsnYnV5X29uJ10sIDAuMDAxKSkKICAgICAgICBzZWxsX3JldmVudWUgPSBhbW91bnQgKiBvcHBvcnR1bml0eVsnc2VsbF9wcmljZSddICogKDEgLSBmZWVzLmdldChvcHBvcnR1bml0eVsnc2VsbF9vbiddLCAwLjAwMSkpCiAgICAgICAgCiAgICAgICAgZ3Jvc3NfcHJvZml0ID0gc2VsbF9yZXZlbnVlIC0gYnV5X2Nvc3QKICAgICAgICAKICAgICAgICAjIFdpdGhkcmF3YWwvdHJhbnNmZXIgZmVlcwogICAgICAgIHRyYW5zZmVyX2ZlZSA9IGZlZXMuZ2V0KCd0cmFuc2ZlcicsIDApCiAgICAgICAgCiAgICAgICAgbmV0X3Byb2ZpdCA9IGdyb3NzX3Byb2ZpdCAtIHRyYW5zZmVyX2ZlZQogICAgICAgIAogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICdncm9zc19wcm9maXQnOiBncm9zc19wcm9maXQsCiAgICAgICAgICAgICduZXRfcHJvZml0JzogbmV0X3Byb2ZpdCwKICAgICAgICAgICAgJ3Byb2ZpdGFibGUnOiBuZXRfcHJvZml0ID4gMCwKICAgICAgICAgICAgJ3JldHVybl9wY3QnOiBuZXRfcHJvZml0IC8gYnV5X2Nvc3QgKiAxMDAKICAgICAgICB9"><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-15-7')" type="button">Run</button></div><pre><code><span class="k">class</span> <span class="nc">CrossExchangeTrader</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Trade across multiple exchanges.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exchanges</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">balances</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="k">def</span> <span class="nf">add_exchange</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">api</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exchanges</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">api</span>
    
    <span class="k">def</span> <span class="nf">get_all_prices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get prices from all exchanges.&quot;&quot;&quot;</span>
        <span class="n">prices</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">api</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">exchanges</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ticker</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">fetch_ticker</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
                <span class="n">prices</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;bid&#39;</span><span class="p">:</span> <span class="n">ticker</span><span class="p">[</span><span class="s1">&#39;bid&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;ask&#39;</span><span class="p">:</span> <span class="n">ticker</span><span class="p">[</span><span class="s1">&#39;ask&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;last&#39;</span><span class="p">:</span> <span class="n">ticker</span><span class="p">[</span><span class="s1">&#39;last&#39;</span><span class="p">]</span>
                <span class="p">}</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">continue</span>
        <span class="k">return</span> <span class="n">prices</span>
    
    <span class="k">def</span> <span class="nf">find_price_discrepancy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">min_spread</span><span class="o">=</span><span class="mf">0.001</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Find price discrepancies between exchanges.&quot;&quot;&quot;</span>
        <span class="n">prices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_all_prices</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        
        <span class="c1"># Find best bid (where to sell) and best ask (where to buy)</span>
        <span class="n">best_bid</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">prices</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;bid&#39;</span><span class="p">])</span>
        <span class="n">best_ask</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">prices</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;ask&#39;</span><span class="p">])</span>
        
        <span class="n">spread</span> <span class="o">=</span> <span class="p">(</span><span class="n">best_bid</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;bid&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">best_ask</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;ask&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="n">best_ask</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;ask&#39;</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="n">spread</span> <span class="o">&gt;</span> <span class="n">min_spread</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s1">&#39;buy_on&#39;</span><span class="p">:</span> <span class="n">best_ask</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="s1">&#39;buy_price&#39;</span><span class="p">:</span> <span class="n">best_ask</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;ask&#39;</span><span class="p">],</span>
                <span class="s1">&#39;sell_on&#39;</span><span class="p">:</span> <span class="n">best_bid</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="s1">&#39;sell_price&#39;</span><span class="p">:</span> <span class="n">best_bid</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;bid&#39;</span><span class="p">],</span>
                <span class="s1">&#39;spread_pct&#39;</span><span class="p">:</span> <span class="n">spread</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
                <span class="s1">&#39;all_prices&#39;</span><span class="p">:</span> <span class="n">prices</span>
            <span class="p">}</span>
        <span class="k">return</span> <span class="kc">None</span>
    
    <span class="k">def</span> <span class="nf">calculate_arbitrage_profit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">opportunity</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">fees</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate net profit from cross-exchange arbitrage.</span>
<span class="sd">        </span>
<span class="sd">        fees: dict with exchange fees</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">buy_cost</span> <span class="o">=</span> <span class="n">amount</span> <span class="o">*</span> <span class="n">opportunity</span><span class="p">[</span><span class="s1">&#39;buy_price&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">fees</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">opportunity</span><span class="p">[</span><span class="s1">&#39;buy_on&#39;</span><span class="p">],</span> <span class="mf">0.001</span><span class="p">))</span>
        <span class="n">sell_revenue</span> <span class="o">=</span> <span class="n">amount</span> <span class="o">*</span> <span class="n">opportunity</span><span class="p">[</span><span class="s1">&#39;sell_price&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">fees</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">opportunity</span><span class="p">[</span><span class="s1">&#39;sell_on&#39;</span><span class="p">],</span> <span class="mf">0.001</span><span class="p">))</span>
        
        <span class="n">gross_profit</span> <span class="o">=</span> <span class="n">sell_revenue</span> <span class="o">-</span> <span class="n">buy_cost</span>
        
        <span class="c1"># Withdrawal/transfer fees</span>
        <span class="n">transfer_fee</span> <span class="o">=</span> <span class="n">fees</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;transfer&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        
        <span class="n">net_profit</span> <span class="o">=</span> <span class="n">gross_profit</span> <span class="o">-</span> <span class="n">transfer_fee</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;gross_profit&#39;</span><span class="p">:</span> <span class="n">gross_profit</span><span class="p">,</span>
            <span class="s1">&#39;net_profit&#39;</span><span class="p">:</span> <span class="n">net_profit</span><span class="p">,</span>
            <span class="s1">&#39;profitable&#39;</span><span class="p">:</span> <span class="n">net_profit</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;return_pct&#39;</span><span class="p">:</span> <span class="n">net_profit</span> <span class="o">/</span> <span class="n">buy_cost</span> <span class="o">*</span> <span class="mi">100</span>
        <span class="p">}</span>
</code></pre><div class="code-output" id="output-cell-15-7"></div></div>
<div class="md-cell"><h3>âœï¸ Exercise 15.4: Cross-Exchange Monitor</h3>
<p>Build a cross-exchange monitoring system.</p></div>
<div class="code-cell" id="cell-15-8" data-source="IyBFeGVyY2lzZSAxNS40CmNsYXNzIENyb3NzRXhjaGFuZ2VNb25pdG9yOgogICAgZGVmIF9faW5pdF9fKHNlbGYpOgogICAgICAgIHNlbGYuZXhjaGFuZ2VzID0ge30KICAgICAgICBzZWxmLm9wcG9ydHVuaXRpZXMgPSBbXQogICAgCiAgICBkZWYgYWRkX2V4Y2hhbmdlKHNlbGYsIG5hbWUsIGFwaSk6CiAgICAgICAgIyBUT0RPCiAgICAgICAgcGFzcwogICAgCiAgICBkZWYgc2Nhbl9mb3Jfb3Bwb3J0dW5pdGllcyhzZWxmLCBzeW1ib2xzKToKICAgICAgICAjIFRPRE86IFNjYW4gYWxsIHN5bWJvbHMgYWNyb3NzIGFsbCBleGNoYW5nZXMKICAgICAgICBwYXNzCiAgICAKICAgIGRlZiBhbGVydF9vbl9vcHBvcnR1bml0eShzZWxmLCBtaW5fcHJvZml0X3BjdD0wLjMpOgogICAgICAgICMgVE9ETzogQWxlcnQgd2hlbiBwcm9maXRhYmxlIG9wcG9ydHVuaXR5IGZvdW5kCiAgICAgICAgcGFzcwogICAgCiAgICBkZWYgZ2VuZXJhdGVfcmVwb3J0KHNlbGYpOgogICAgICAgICMgVE9ETzogU3VtbWFyeSBvZiBhbGwgb3Bwb3J0dW5pdGllcwogICAgICAgIHBhc3M="><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-15-8')" type="button">Run</button></div><pre><code><span class="c1"># Exercise 15.4</span>
<span class="k">class</span> <span class="nc">CrossExchangeMonitor</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exchanges</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">opportunities</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">def</span> <span class="nf">add_exchange</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">api</span><span class="p">):</span>
        <span class="c1"># TODO</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">scan_for_opportunities</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbols</span><span class="p">):</span>
        <span class="c1"># TODO: Scan all symbols across all exchanges</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">alert_on_opportunity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">min_profit_pct</span><span class="o">=</span><span class="mf">0.3</span><span class="p">):</span>
        <span class="c1"># TODO: Alert when profitable opportunity found</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">generate_report</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># TODO: Summary of all opportunities</span>
        <span class="k">pass</span>
</code></pre><div class="code-output" id="output-cell-15-8"></div></div>
<div class="md-cell solution-block"><details>
<summary>ğŸ’¡ Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">CrossExchangeMonitor</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exchanges</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">opportunities</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trader</span> <span class="o">=</span> <span class="n">CrossExchangeTrader</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fees</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">add_exchange</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">api</span><span class="p">,</span> <span class="n">fee</span><span class="o">=</span><span class="mf">0.001</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exchanges</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">api</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trader</span><span class="o">.</span><span class="n">add_exchange</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">api</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fees</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">fee</span>

    <span class="k">def</span> <span class="nf">scan_for_opportunities</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbols</span><span class="p">,</span> <span class="n">min_spread</span><span class="o">=</span><span class="mf">0.002</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">opportunities</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="n">symbols</span><span class="p">:</span>
            <span class="n">opp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trader</span><span class="o">.</span><span class="n">find_price_discrepancy</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">min_spread</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">opp</span><span class="p">:</span>
                <span class="c1"># Calculate profit</span>
                <span class="n">profit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trader</span><span class="o">.</span><span class="n">calculate_arbitrage_profit</span><span class="p">(</span><span class="n">opp</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fees</span><span class="p">)</span>
                <span class="n">opp</span><span class="p">[</span><span class="s1">&#39;profit_info&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">profit</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">opportunities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">opp</span><span class="p">)</span>

        <span class="c1"># Sort by spread</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">opportunities</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;spread_pct&#39;</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">opportunities</span>

    <span class="k">def</span> <span class="nf">alert_on_opportunity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">min_profit_pct</span><span class="o">=</span><span class="mf">0.3</span><span class="p">):</span>
        <span class="n">alerts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">opp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">opportunities</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">opp</span><span class="p">[</span><span class="s1">&#39;profit_info&#39;</span><span class="p">][</span><span class="s1">&#39;return_pct&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">min_profit_pct</span><span class="p">:</span>
                <span class="n">alerts</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s1">&#39;alert&#39;</span><span class="p">:</span> <span class="s1">&#39;ARBITRAGE OPPORTUNITY&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;buy&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">opp</span><span class="p">[</span><span class="s1">&#39;buy_on&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> @ </span><span class="si">{</span><span class="n">opp</span><span class="p">[</span><span class="s1">&#39;buy_price&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="s1">&#39;sell&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">opp</span><span class="p">[</span><span class="s1">&#39;sell_on&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> @ </span><span class="si">{</span><span class="n">opp</span><span class="p">[</span><span class="s1">&#39;sell_price&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="s1">&#39;profit_pct&#39;</span><span class="p">:</span> <span class="n">opp</span><span class="p">[</span><span class="s1">&#39;profit_info&#39;</span><span class="p">][</span><span class="s1">&#39;return_pct&#39;</span><span class="p">]</span>
                <span class="p">})</span>
        <span class="k">return</span> <span class="n">alerts</span>

    <span class="k">def</span> <span class="nf">generate_report</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">report</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;=&#39;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;     CROSS-EXCHANGE OPPORTUNITY REPORT&#39;</span><span class="p">)</span>
        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;=&#39;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Exchanges: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exchanges</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Opportunities found: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">opportunities</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">opp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">opportunities</span><span class="p">[:</span><span class="mi">5</span><span class="p">]):</span>
            <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s1">. Spread: </span><span class="si">{</span><span class="n">opp</span><span class="p">[</span><span class="s2">&quot;spread_pct&quot;</span><span class="p">]</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">%&#39;</span><span class="p">)</span>
            <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;   Buy on </span><span class="si">{</span><span class="n">opp</span><span class="p">[</span><span class="s2">&quot;buy_on&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1"> @ </span><span class="si">{</span><span class="n">opp</span><span class="p">[</span><span class="s2">&quot;buy_price&quot;</span><span class="p">]</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;   Sell on </span><span class="si">{</span><span class="n">opp</span><span class="p">[</span><span class="s2">&quot;sell_on&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1"> @ </span><span class="si">{</span><span class="n">opp</span><span class="p">[</span><span class="s2">&quot;sell_price&quot;</span><span class="p">]</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;   Net Profit: </span><span class="si">{</span><span class="n">opp</span><span class="p">[</span><span class="s2">&quot;profit_info&quot;</span><span class="p">][</span><span class="s2">&quot;return_pct&quot;</span><span class="p">]</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">%&#39;</span><span class="p">)</span>
            <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;=&#39;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">report</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>ğŸ—ï¸ Module Project: Advanced Strategy Toolkit</h1>
<p>Build a comprehensive advanced trading toolkit.</p></div>
<div class="code-cell" id="cell-15-9" data-source="IyBNb2R1bGUgUHJvamVjdApjbGFzcyBBZHZhbmNlZFN0cmF0ZWd5VG9vbGtpdDoKICAgIGRlZiBfX2luaXRfXyhzZWxmKToKICAgICAgICBzZWxmLmZ1bmRpbmdfdHJhY2tlciA9IEZ1bmRpbmdSYXRlVHJhY2tlcigpCiAgICAgICAgc2VsZi5vcHRpb25zX2FuYWx5emVyID0gT3B0aW9uc1N0cmF0ZWd5QW5hbHl6ZXIoKQogICAgICAgIHNlbGYubWFya2V0X21ha2VyID0gQWR2YW5jZWRNYXJrZXRNYWtlcih7J2Jhc2Vfc3ByZWFkJzogMC4wMDF9KQogICAgICAgIHNlbGYuY3Jvc3NfZXhjaGFuZ2UgPSBDcm9zc0V4Y2hhbmdlTW9uaXRvcigpCiAgICAKICAgIGRlZiBzY2FuX2FsbF9vcHBvcnR1bml0aWVzKHNlbGYpOgogICAgICAgICMgVE9ETzogU2NhbiBmdW5kaW5nLCBvcHRpb25zLCBjcm9zcy1leGNoYW5nZQogICAgICAgIHBhc3MKICAgIAogICAgZGVmIHJlY29tbWVuZF9zdHJhdGVneShzZWxmLCBjYXBpdGFsLCByaXNrX3RvbGVyYW5jZSk6CiAgICAgICAgIyBUT0RPOiBSZWNvbW1lbmQgYmVzdCBzdHJhdGVneSBiYXNlZCBvbiBtYXJrZXQgY29uZGl0aW9ucwogICAgICAgIHBhc3MKICAgIAogICAgZGVmIGdlbmVyYXRlX2RhaWx5X3JlcG9ydChzZWxmKToKICAgICAgICAjIFRPRE86IENvbXByZWhlbnNpdmUgZGFpbHkgcmVwb3J0CiAgICAgICAgcGFzcw=="><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-15-9')" type="button">Run</button></div><pre><code><span class="c1"># Module Project</span>
<span class="k">class</span> <span class="nc">AdvancedStrategyToolkit</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">funding_tracker</span> <span class="o">=</span> <span class="n">FundingRateTracker</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options_analyzer</span> <span class="o">=</span> <span class="n">OptionsStrategyAnalyzer</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">market_maker</span> <span class="o">=</span> <span class="n">AdvancedMarketMaker</span><span class="p">({</span><span class="s1">&#39;base_spread&#39;</span><span class="p">:</span> <span class="mf">0.001</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cross_exchange</span> <span class="o">=</span> <span class="n">CrossExchangeMonitor</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">scan_all_opportunities</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># TODO: Scan funding, options, cross-exchange</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">recommend_strategy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">capital</span><span class="p">,</span> <span class="n">risk_tolerance</span><span class="p">):</span>
        <span class="c1"># TODO: Recommend best strategy based on market conditions</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">generate_daily_report</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># TODO: Comprehensive daily report</span>
        <span class="k">pass</span>
</code></pre><div class="code-output" id="output-cell-15-9"></div></div>
<div class="md-cell"><hr />
<h1>ğŸ“ Key Takeaways</h1>
<ol>
<li><strong>Funding Rates</strong>: Cash and carry earns 20-100%+ APY in crypto</li>
<li><strong>Options</strong>: High volatility = expensive options, good for selling</li>
<li><strong>Market Making</strong>: Profit from spreads, manage inventory risk carefully</li>
<li><strong>Cross-Exchange</strong>: Price differences exist, but speed and fees matter</li>
</ol>
<hr />
<p><em>Part 4 Complete! Next: Capstone Project</em></p></div>
        <div class="nav-buttons">
            <button class="nav-btn prev-btn disabled" type="button">
                <span class="nav-btn-label">â† Previous</span>
                <span class="nav-btn-name"></span>
            </button>
            <button class="nav-btn next-btn disabled" type="button">
                <span class="nav-btn-label">Next â†’</span>
                <span class="nav-btn-name"></span>
            </button>
        </div>
        </div>
<div class="module-section" data-idx="16"><div class="md-cell module-header"><h1>ğŸ† Capstone Project: Complete Crypto Trading System</h1>
<h2>Course 1: Crypto Algorithmic Trading</h2>
<hr />
<div class="table-wrapper"><table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>â±ï¸ <strong>Duration</strong></td>
<td>~8-12 hours</td>
</tr>
<tr>
<td>ğŸ“‹ <strong>Prerequisites</strong></td>
<td>All modules (1-15)</td>
</tr>
<tr>
<td>ğŸ¯ <strong>Outcome</strong></td>
<td>Production-ready trading system</td>
</tr>
</tbody>
</table></div></div>
<div class="md-cell"><h2>ğŸ¯ Project Overview</h2>
<p>Build a <strong>complete crypto trading system</strong> that integrates everything you've learned:</p>
<ol>
<li><strong>Multi-Exchange Connectivity</strong> - CEX + DEX integration</li>
<li><strong>Signal Generation</strong> - Technical + on-chain signals</li>
<li><strong>DeFi Monitoring</strong> - Yield and arbitrage opportunities</li>
<li><strong>Automated Execution</strong> - Order management with safety checks</li>
<li><strong>Risk Management</strong> - Position sizing, stops, portfolio limits</li>
<li><strong>Real-Time Monitoring</strong> - Dashboard with alerts</li>
<li><strong>Performance Analytics</strong> - Tracking and reporting</li>
</ol>
<hr /></div>
<div class="md-cell"><h2>ğŸ“ Project Structure</h2>
<div class="highlight"><pre><span></span><code>crypto_trading_system/
â”œâ”€â”€ config/
â”‚   â”œâ”€â”€ settings.py
â”‚   â””â”€â”€ .env.example
â”œâ”€â”€ data/
â”‚   â”œâ”€â”€ market_data.py
â”‚   â”œâ”€â”€ onchain_data.py
â”‚   â””â”€â”€ defi_data.py
â”œâ”€â”€ strategies/
â”‚   â”œâ”€â”€ base_strategy.py
â”‚   â”œâ”€â”€ trend_strategy.py
â”‚   â”œâ”€â”€ mean_reversion.py
â”‚   â””â”€â”€ defi_strategy.py
â”œâ”€â”€ execution/
â”‚   â”œâ”€â”€ cex_executor.py
â”‚   â”œâ”€â”€ dex_executor.py
â”‚   â””â”€â”€ order_manager.py
â”œâ”€â”€ risk/
â”‚   â”œâ”€â”€ position_sizer.py
â”‚   â”œâ”€â”€ risk_manager.py
â”‚   â””â”€â”€ portfolio_manager.py
â”œâ”€â”€ monitoring/
â”‚   â”œâ”€â”€ dashboard.py
â”‚   â”œâ”€â”€ alerts.py
â”‚   â””â”€â”€ performance.py
â”œâ”€â”€ utils/
â”‚   â”œâ”€â”€ logger.py
â”‚   â””â”€â”€ helpers.py
â”œâ”€â”€ main.py
â””â”€â”€ requirements.txt
</code></pre></div></div>
<div class="md-cell"><hr />
<h1>Part 1: Core Infrastructure</h1>
<h2>1.1 Configuration Management</h2></div>
<div class="code-cell" id="cell-16-0" data-source="IyBjb25maWcvc2V0dGluZ3MucHkKaW1wb3J0IG9zCmZyb20gZG90ZW52IGltcG9ydCBsb2FkX2RvdGVudgpmcm9tIGRhdGFjbGFzc2VzIGltcG9ydCBkYXRhY2xhc3MKZnJvbSB0eXBpbmcgaW1wb3J0IExpc3QsIERpY3QKCmxvYWRfZG90ZW52KCkKCkBkYXRhY2xhc3MKY2xhc3MgRXhjaGFuZ2VDb25maWc6CiAgICBuYW1lOiBzdHIKICAgIGFwaV9rZXk6IHN0cgogICAgYXBpX3NlY3JldDogc3RyCiAgICBzYW5kYm94OiBib29sID0gVHJ1ZQogICAgcmF0ZV9saW1pdDogaW50ID0gMTAKCkBkYXRhY2xhc3MKY2xhc3MgVHJhZGluZ0NvbmZpZzoKICAgIHN5bWJvbHM6IExpc3Rbc3RyXQogICAgdGltZWZyYW1lczogTGlzdFtzdHJdCiAgICBtYXhfcG9zaXRpb25fc2l6ZTogZmxvYXQKICAgIG1heF9kYWlseV9sb3NzOiBmbG9hdAogICAgZGVmYXVsdF9sZXZlcmFnZTogZmxvYXQgPSAxLjAKCkBkYXRhY2xhc3MKY2xhc3MgUmlza0NvbmZpZzoKICAgIG1heF9wb3NpdGlvbl9wY3Q6IGZsb2F0ID0gMC4xICAjIDEwJSBtYXggcGVyIHBvc2l0aW9uCiAgICBtYXhfcG9ydGZvbGlvX3Jpc2s6IGZsb2F0ID0gMC4yICAjIDIwJSBtYXggdG90YWwgcmlzawogICAgc3RvcF9sb3NzX3BjdDogZmxvYXQgPSAwLjAyICAjIDIlIHN0b3AgbG9zcwogICAgbWF4X2NvcnJlbGF0aW9uOiBmbG9hdCA9IDAuNwoKY2xhc3MgU2V0dGluZ3M6CiAgICAiIiJDZW50cmFsIGNvbmZpZ3VyYXRpb24gbWFuYWdlbWVudC4iIiIKICAgIAogICAgZGVmIF9faW5pdF9fKHNlbGYpOgogICAgICAgIHNlbGYuZXhjaGFuZ2VzID0gc2VsZi5fbG9hZF9leGNoYW5nZXMoKQogICAgICAgIHNlbGYudHJhZGluZyA9IHNlbGYuX2xvYWRfdHJhZGluZ19jb25maWcoKQogICAgICAgIHNlbGYucmlzayA9IFJpc2tDb25maWcoKQogICAgICAgIHNlbGYud2ViM19ycGMgPSBvcy5nZXRlbnYoJ0VUSF9SUENfVVJMJywgJ2h0dHBzOi8vZXRoLmxsYW1hcnBjLmNvbScpCiAgICAKICAgIGRlZiBfbG9hZF9leGNoYW5nZXMoc2VsZikgLT4gRGljdFtzdHIsIEV4Y2hhbmdlQ29uZmlnXToKICAgICAgICBleGNoYW5nZXMgPSB7fQogICAgICAgIAogICAgICAgICMgQmluYW5jZQogICAgICAgIGlmIG9zLmdldGVudignQklOQU5DRV9BUElfS0VZJyk6CiAgICAgICAgICAgIGV4Y2hhbmdlc1snYmluYW5jZSddID0gRXhjaGFuZ2VDb25maWcoCiAgICAgICAgICAgICAgICBuYW1lPSdiaW5hbmNlJywKICAgICAgICAgICAgICAgIGFwaV9rZXk9b3MuZ2V0ZW52KCdCSU5BTkNFX0FQSV9LRVknKSwKICAgICAgICAgICAgICAgIGFwaV9zZWNyZXQ9b3MuZ2V0ZW52KCdCSU5BTkNFX0FQSV9TRUNSRVQnKSwKICAgICAgICAgICAgICAgIHNhbmRib3g9b3MuZ2V0ZW52KCdCSU5BTkNFX1NBTkRCT1gnLCAndHJ1ZScpLmxvd2VyKCkgPT0gJ3RydWUnCiAgICAgICAgICAgICkKICAgICAgICAKICAgICAgICByZXR1cm4gZXhjaGFuZ2VzCiAgICAKICAgIGRlZiBfbG9hZF90cmFkaW5nX2NvbmZpZyhzZWxmKSAtPiBUcmFkaW5nQ29uZmlnOgogICAgICAgIHJldHVybiBUcmFkaW5nQ29uZmlnKAogICAgICAgICAgICBzeW1ib2xzPVsnQlRDL1VTRFQnLCAnRVRIL1VTRFQnXSwKICAgICAgICAgICAgdGltZWZyYW1lcz1bJzFoJywgJzRoJywgJzFkJ10sCiAgICAgICAgICAgIG1heF9wb3NpdGlvbl9zaXplPWZsb2F0KG9zLmdldGVudignTUFYX1BPU0lUSU9OX1NJWkUnLCAnMTAwMCcpKSwKICAgICAgICAgICAgbWF4X2RhaWx5X2xvc3M9ZmxvYXQob3MuZ2V0ZW52KCdNQVhfREFJTFlfTE9TUycsICcxMDAnKSkKICAgICAgICApCgojIEdsb2JhbCBzZXR0aW5ncyBpbnN0YW5jZQpzZXR0aW5ncyA9IFNldHRpbmdzKCk="><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-16-0')" type="button">Run</button></div><pre><code><span class="c1"># config/settings.py</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">dotenv</span> <span class="kn">import</span> <span class="n">load_dotenv</span>
<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span>

<span class="n">load_dotenv</span><span class="p">()</span>

<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">ExchangeConfig</span><span class="p">:</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">api_key</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">api_secret</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">sandbox</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">rate_limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span>

<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">TradingConfig</span><span class="p">:</span>
    <span class="n">symbols</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
    <span class="n">timeframes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
    <span class="n">max_position_size</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">max_daily_loss</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">default_leverage</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span>

<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">RiskConfig</span><span class="p">:</span>
    <span class="n">max_position_pct</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span>  <span class="c1"># 10% max per position</span>
    <span class="n">max_portfolio_risk</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.2</span>  <span class="c1"># 20% max total risk</span>
    <span class="n">stop_loss_pct</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.02</span>  <span class="c1"># 2% stop loss</span>
    <span class="n">max_correlation</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.7</span>

<span class="k">class</span> <span class="nc">Settings</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Central configuration management.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exchanges</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_exchanges</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trading</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_trading_config</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">risk</span> <span class="o">=</span> <span class="n">RiskConfig</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">web3_rpc</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;ETH_RPC_URL&#39;</span><span class="p">,</span> <span class="s1">&#39;https://eth.llamarpc.com&#39;</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">_load_exchanges</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ExchangeConfig</span><span class="p">]:</span>
        <span class="n">exchanges</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="c1"># Binance</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;BINANCE_API_KEY&#39;</span><span class="p">):</span>
            <span class="n">exchanges</span><span class="p">[</span><span class="s1">&#39;binance&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ExchangeConfig</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s1">&#39;binance&#39;</span><span class="p">,</span>
                <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;BINANCE_API_KEY&#39;</span><span class="p">),</span>
                <span class="n">api_secret</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;BINANCE_API_SECRET&#39;</span><span class="p">),</span>
                <span class="n">sandbox</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;BINANCE_SANDBOX&#39;</span><span class="p">,</span> <span class="s1">&#39;true&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span>
            <span class="p">)</span>
        
        <span class="k">return</span> <span class="n">exchanges</span>
    
    <span class="k">def</span> <span class="nf">_load_trading_config</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TradingConfig</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">TradingConfig</span><span class="p">(</span>
            <span class="n">symbols</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;BTC/USDT&#39;</span><span class="p">,</span> <span class="s1">&#39;ETH/USDT&#39;</span><span class="p">],</span>
            <span class="n">timeframes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;1h&#39;</span><span class="p">,</span> <span class="s1">&#39;4h&#39;</span><span class="p">,</span> <span class="s1">&#39;1d&#39;</span><span class="p">],</span>
            <span class="n">max_position_size</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;MAX_POSITION_SIZE&#39;</span><span class="p">,</span> <span class="s1">&#39;1000&#39;</span><span class="p">)),</span>
            <span class="n">max_daily_loss</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;MAX_DAILY_LOSS&#39;</span><span class="p">,</span> <span class="s1">&#39;100&#39;</span><span class="p">))</span>
        <span class="p">)</span>

<span class="c1"># Global settings instance</span>
<span class="n">settings</span> <span class="o">=</span> <span class="n">Settings</span><span class="p">()</span>
</code></pre><div class="code-output" id="output-cell-16-0"></div></div>
<div class="md-cell"><h2>1.2 Logging Setup</h2></div>
<div class="code-cell" id="cell-16-1" data-source="IyB1dGlscy9sb2dnZXIucHkKaW1wb3J0IGxvZ2dpbmcKZnJvbSBkYXRldGltZSBpbXBvcnQgZGF0ZXRpbWUKaW1wb3J0IGpzb24KCmNsYXNzIFRyYWRpbmdMb2dnZXI6CiAgICAiIiJTdHJ1Y3R1cmVkIGxvZ2dpbmcgZm9yIHRyYWRpbmcgc3lzdGVtLiIiIgogICAgCiAgICBkZWYgX19pbml0X18oc2VsZiwgbmFtZT0ndHJhZGluZ19zeXN0ZW0nKToKICAgICAgICBzZWxmLmxvZ2dlciA9IGxvZ2dpbmcuZ2V0TG9nZ2VyKG5hbWUpCiAgICAgICAgc2VsZi5sb2dnZXIuc2V0TGV2ZWwobG9nZ2luZy5ERUJVRykKICAgICAgICAKICAgICAgICAjIENvbnNvbGUgaGFuZGxlcgogICAgICAgIGNvbnNvbGUgPSBsb2dnaW5nLlN0cmVhbUhhbmRsZXIoKQogICAgICAgIGNvbnNvbGUuc2V0TGV2ZWwobG9nZ2luZy5JTkZPKQogICAgICAgIGNvbnNvbGUuc2V0Rm9ybWF0dGVyKGxvZ2dpbmcuRm9ybWF0dGVyKAogICAgICAgICAgICAnJShhc2N0aW1lKXMgfCAlKGxldmVsbmFtZSlzIHwgJShtZXNzYWdlKXMnCiAgICAgICAgKSkKICAgICAgICBzZWxmLmxvZ2dlci5hZGRIYW5kbGVyKGNvbnNvbGUpCiAgICAgICAgCiAgICAgICAgIyBGaWxlIGhhbmRsZXIgZm9yIHRyYWRlcwogICAgICAgIHRyYWRlX2hhbmRsZXIgPSBsb2dnaW5nLkZpbGVIYW5kbGVyKCd0cmFkZXMubG9nJykKICAgICAgICB0cmFkZV9oYW5kbGVyLnNldExldmVsKGxvZ2dpbmcuSU5GTykKICAgICAgICBzZWxmLmxvZ2dlci5hZGRIYW5kbGVyKHRyYWRlX2hhbmRsZXIpCiAgICAKICAgIGRlZiBsb2dfdHJhZGUoc2VsZiwgdHJhZGVfaW5mbzogZGljdCk6CiAgICAgICAgIiIiTG9nIHRyYWRlIGV4ZWN1dGlvbi4iIiIKICAgICAgICB0cmFkZV9pbmZvWyd0aW1lc3RhbXAnXSA9IGRhdGV0aW1lLm5vdygpLmlzb2Zvcm1hdCgpCiAgICAgICAgc2VsZi5sb2dnZXIuaW5mbyhmIlRSQURFOiB7anNvbi5kdW1wcyh0cmFkZV9pbmZvKX0iKQogICAgCiAgICBkZWYgbG9nX3NpZ25hbChzZWxmLCBzaWduYWxfaW5mbzogZGljdCk6CiAgICAgICAgIiIiTG9nIHRyYWRpbmcgc2lnbmFsLiIiIgogICAgICAgIHNlbGYubG9nZ2VyLmluZm8oZiJTSUdOQUw6IHtqc29uLmR1bXBzKHNpZ25hbF9pbmZvKX0iKQogICAgCiAgICBkZWYgbG9nX2Vycm9yKHNlbGYsIGVycm9yX21zZzogc3RyLCBjb250ZXh0OiBkaWN0ID0gTm9uZSk6CiAgICAgICAgIiIiTG9nIGVycm9yIHdpdGggY29udGV4dC4iIiIKICAgICAgICBzZWxmLmxvZ2dlci5lcnJvcihmIkVSUk9SOiB7ZXJyb3JfbXNnfSB8IENvbnRleHQ6IHtjb250ZXh0fSIpCiAgICAKICAgIGRlZiBsb2dfcmlza19ldmVudChzZWxmLCBldmVudDogc3RyLCBkZXRhaWxzOiBkaWN0KToKICAgICAgICAiIiJMb2cgcmlzayBtYW5hZ2VtZW50IGV2ZW50cy4iIiIKICAgICAgICBzZWxmLmxvZ2dlci53YXJuaW5nKGYiUklTSzoge2V2ZW50fSB8IHtqc29uLmR1bXBzKGRldGFpbHMpfSIpCgpsb2dnZXIgPSBUcmFkaW5nTG9nZ2VyKCk="><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-16-1')" type="button">Run</button></div><pre><code><span class="c1"># utils/logger.py</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">import</span> <span class="nn">json</span>

<span class="k">class</span> <span class="nc">TradingLogger</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Structured logging for trading system.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;trading_system&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
        
        <span class="c1"># Console handler</span>
        <span class="n">console</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">()</span>
        <span class="n">console</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
        <span class="n">console</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span>
            <span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1"> | </span><span class="si">%(levelname)s</span><span class="s1"> | </span><span class="si">%(message)s</span><span class="s1">&#39;</span>
        <span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">console</span><span class="p">)</span>
        
        <span class="c1"># File handler for trades</span>
        <span class="n">trade_handler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">FileHandler</span><span class="p">(</span><span class="s1">&#39;trades.log&#39;</span><span class="p">)</span>
        <span class="n">trade_handler</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">trade_handler</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">log_trade</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trade_info</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Log trade execution.&quot;&quot;&quot;</span>
        <span class="n">trade_info</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;TRADE: </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">trade_info</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">log_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">signal_info</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Log trading signal.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SIGNAL: </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">signal_info</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">log_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">error_msg</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Log error with context.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ERROR: </span><span class="si">{</span><span class="n">error_msg</span><span class="si">}</span><span class="s2"> | Context: </span><span class="si">{</span><span class="n">context</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">log_risk_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">details</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Log risk management events.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;RISK: </span><span class="si">{</span><span class="n">event</span><span class="si">}</span><span class="s2"> | </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">details</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">TradingLogger</span><span class="p">()</span>
</code></pre><div class="code-output" id="output-cell-16-1"></div></div>
<div class="md-cell"><hr />
<h1>Part 2: Data Layer</h1>
<h2>2.1 Multi-Source Market Data</h2></div>
<div class="code-cell" id="cell-16-2" data-source="IyBkYXRhL21hcmtldF9kYXRhLnB5CmltcG9ydCBjY3h0CmltcG9ydCBwYW5kYXMgYXMgcGQKZnJvbSBkYXRldGltZSBpbXBvcnQgZGF0ZXRpbWUsIHRpbWVkZWx0YQpmcm9tIHR5cGluZyBpbXBvcnQgRGljdCwgTGlzdCwgT3B0aW9uYWwKaW1wb3J0IHRpbWUKCmNsYXNzIE1hcmtldERhdGFNYW5hZ2VyOgogICAgIiIiVW5pZmllZCBtYXJrZXQgZGF0YSBmcm9tIG11bHRpcGxlIGV4Y2hhbmdlcy4iIiIKICAgIAogICAgZGVmIF9faW5pdF9fKHNlbGYsIHNldHRpbmdzKToKICAgICAgICBzZWxmLnNldHRpbmdzID0gc2V0dGluZ3MKICAgICAgICBzZWxmLmV4Y2hhbmdlcyA9IHt9CiAgICAgICAgc2VsZi5jYWNoZSA9IHt9CiAgICAgICAgc2VsZi5jYWNoZV90dGwgPSA1ICAjIHNlY29uZHMKICAgICAgICBzZWxmLl9pbml0X2V4Y2hhbmdlcygpCiAgICAKICAgIGRlZiBfaW5pdF9leGNoYW5nZXMoc2VsZik6CiAgICAgICAgZm9yIG5hbWUsIGNvbmZpZyBpbiBzZWxmLnNldHRpbmdzLmV4Y2hhbmdlcy5pdGVtcygpOgogICAgICAgICAgICBleGNoYW5nZV9jbGFzcyA9IGdldGF0dHIoY2N4dCwgbmFtZSkKICAgICAgICAgICAgc2VsZi5leGNoYW5nZXNbbmFtZV0gPSBleGNoYW5nZV9jbGFzcyh7CiAgICAgICAgICAgICAgICAnYXBpS2V5JzogY29uZmlnLmFwaV9rZXksCiAgICAgICAgICAgICAgICAnc2VjcmV0JzogY29uZmlnLmFwaV9zZWNyZXQsCiAgICAgICAgICAgICAgICAnc2FuZGJveCc6IGNvbmZpZy5zYW5kYm94LAogICAgICAgICAgICAgICAgJ2VuYWJsZVJhdGVMaW1pdCc6IFRydWUKICAgICAgICAgICAgfSkKICAgIAogICAgZGVmIGdldF90aWNrZXIoc2VsZiwgc3ltYm9sOiBzdHIsIGV4Y2hhbmdlOiBzdHIgPSBOb25lKSAtPiBEaWN0OgogICAgICAgICIiIkdldCBjdXJyZW50IHRpY2tlciBmcm9tIGJlc3QgZXhjaGFuZ2UuIiIiCiAgICAgICAgZXhjaGFuZ2UgPSBleGNoYW5nZSBvciBsaXN0KHNlbGYuZXhjaGFuZ2VzLmtleXMoKSlbMF0KICAgICAgICAKICAgICAgICBjYWNoZV9rZXkgPSBmJ3RpY2tlcl97ZXhjaGFuZ2V9X3tzeW1ib2x9JwogICAgICAgIGlmIHNlbGYuX2lzX2NhY2hlX3ZhbGlkKGNhY2hlX2tleSk6CiAgICAgICAgICAgIHJldHVybiBzZWxmLmNhY2hlW2NhY2hlX2tleV1bJ2RhdGEnXQogICAgICAgIAogICAgICAgIHRpY2tlciA9IHNlbGYuZXhjaGFuZ2VzW2V4Y2hhbmdlXS5mZXRjaF90aWNrZXIoc3ltYm9sKQogICAgICAgIHNlbGYuX3VwZGF0ZV9jYWNoZShjYWNoZV9rZXksIHRpY2tlcikKICAgICAgICAKICAgICAgICByZXR1cm4gewogICAgICAgICAgICAnc3ltYm9sJzogc3ltYm9sLAogICAgICAgICAgICAnZXhjaGFuZ2UnOiBleGNoYW5nZSwKICAgICAgICAgICAgJ3ByaWNlJzogdGlja2VyWydsYXN0J10sCiAgICAgICAgICAgICdiaWQnOiB0aWNrZXJbJ2JpZCddLAogICAgICAgICAgICAnYXNrJzogdGlja2VyWydhc2snXSwKICAgICAgICAgICAgJ3ZvbHVtZSc6IHRpY2tlclsnYmFzZVZvbHVtZSddLAogICAgICAgICAgICAnY2hhbmdlXzI0aCc6IHRpY2tlclsncGVyY2VudGFnZSddCiAgICAgICAgfQogICAgCiAgICBkZWYgZ2V0X29obGN2KHNlbGYsIHN5bWJvbDogc3RyLCB0aW1lZnJhbWU6IHN0ciA9ICcxaCcsIAogICAgICAgICAgICAgICAgICBsaW1pdDogaW50ID0gMTAwLCBleGNoYW5nZTogc3RyID0gTm9uZSkgLT4gcGQuRGF0YUZyYW1lOgogICAgICAgICIiIkdldCBPSExDViBkYXRhIGFzIERhdGFGcmFtZS4iIiIKICAgICAgICBleGNoYW5nZSA9IGV4Y2hhbmdlIG9yIGxpc3Qoc2VsZi5leGNoYW5nZXMua2V5cygpKVswXQogICAgICAgIAogICAgICAgIG9obGN2ID0gc2VsZi5leGNoYW5nZXNbZXhjaGFuZ2VdLmZldGNoX29obGN2KHN5bWJvbCwgdGltZWZyYW1lLCBsaW1pdD1saW1pdCkKICAgICAgICAKICAgICAgICBkZiA9IHBkLkRhdGFGcmFtZShvaGxjdiwgY29sdW1ucz1bJ3RpbWVzdGFtcCcsICdvcGVuJywgJ2hpZ2gnLCAnbG93JywgJ2Nsb3NlJywgJ3ZvbHVtZSddKQogICAgICAgIGRmWyd0aW1lc3RhbXAnXSA9IHBkLnRvX2RhdGV0aW1lKGRmWyd0aW1lc3RhbXAnXSwgdW5pdD0nbXMnKQogICAgICAgIGRmLnNldF9pbmRleCgndGltZXN0YW1wJywgaW5wbGFjZT1UcnVlKQogICAgICAgIAogICAgICAgIHJldHVybiBkZgogICAgCiAgICBkZWYgZ2V0X29yZGVyX2Jvb2soc2VsZiwgc3ltYm9sOiBzdHIsIGxpbWl0OiBpbnQgPSAyMCwgZXhjaGFuZ2U6IHN0ciA9IE5vbmUpIC0+IERpY3Q6CiAgICAgICAgIiIiR2V0IG9yZGVyIGJvb2sgZGF0YS4iIiIKICAgICAgICBleGNoYW5nZSA9IGV4Y2hhbmdlIG9yIGxpc3Qoc2VsZi5leGNoYW5nZXMua2V5cygpKVswXQogICAgICAgIGJvb2sgPSBzZWxmLmV4Y2hhbmdlc1tleGNoYW5nZV0uZmV0Y2hfb3JkZXJfYm9vayhzeW1ib2wsIGxpbWl0KQogICAgICAgIAogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICdiaWRzJzogYm9va1snYmlkcyddWzoxMF0sCiAgICAgICAgICAgICdhc2tzJzogYm9va1snYXNrcyddWzoxMF0sCiAgICAgICAgICAgICdzcHJlYWQnOiBib29rWydhc2tzJ11bMF1bMF0gLSBib29rWydiaWRzJ11bMF1bMF0gaWYgYm9va1snYXNrcyddIGFuZCBib29rWydiaWRzJ10gZWxzZSAwCiAgICAgICAgfQogICAgCiAgICBkZWYgZ2V0X211bHRpX2V4Y2hhbmdlX3ByaWNlcyhzZWxmLCBzeW1ib2w6IHN0cikgLT4gRGljdDoKICAgICAgICAiIiJHZXQgcHJpY2VzIGZyb20gYWxsIGNvbm5lY3RlZCBleGNoYW5nZXMuIiIiCiAgICAgICAgcHJpY2VzID0ge30KICAgICAgICBmb3IgbmFtZSwgZXhjaGFuZ2UgaW4gc2VsZi5leGNoYW5nZXMuaXRlbXMoKToKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgdGlja2VyID0gZXhjaGFuZ2UuZmV0Y2hfdGlja2VyKHN5bWJvbCkKICAgICAgICAgICAgICAgIHByaWNlc1tuYW1lXSA9IHsnYmlkJzogdGlja2VyWydiaWQnXSwgJ2Fzayc6IHRpY2tlclsnYXNrJ10sICdsYXN0JzogdGlja2VyWydsYXN0J119CiAgICAgICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgcmV0dXJuIHByaWNlcwogICAgCiAgICBkZWYgX2lzX2NhY2hlX3ZhbGlkKHNlbGYsIGtleTogc3RyKSAtPiBib29sOgogICAgICAgIGlmIGtleSBub3QgaW4gc2VsZi5jYWNoZToKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgcmV0dXJuIChkYXRldGltZS5ub3coKS50aW1lc3RhbXAoKSAtIHNlbGYuY2FjaGVba2V5XVsndGltZSddKSA8IHNlbGYuY2FjaGVfdHRsCiAgICAKICAgIGRlZiBfdXBkYXRlX2NhY2hlKHNlbGYsIGtleTogc3RyLCBkYXRhKToKICAgICAgICBzZWxmLmNhY2hlW2tleV0gPSB7J2RhdGEnOiBkYXRhLCAndGltZSc6IGRhdGV0aW1lLm5vdygpLnRpbWVzdGFtcCgpfQ=="><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-16-2')" type="button">Run</button></div><pre><code><span class="c1"># data/market_data.py</span>
<span class="kn">import</span> <span class="nn">ccxt</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="k">class</span> <span class="nc">MarketDataManager</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Unified market data from multiple exchanges.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">settings</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">settings</span> <span class="o">=</span> <span class="n">settings</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exchanges</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache_ttl</span> <span class="o">=</span> <span class="mi">5</span>  <span class="c1"># seconds</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_exchanges</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">_init_exchanges</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">config</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">exchanges</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">exchange_class</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">ccxt</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exchanges</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">exchange_class</span><span class="p">({</span>
                <span class="s1">&#39;apiKey&#39;</span><span class="p">:</span> <span class="n">config</span><span class="o">.</span><span class="n">api_key</span><span class="p">,</span>
                <span class="s1">&#39;secret&#39;</span><span class="p">:</span> <span class="n">config</span><span class="o">.</span><span class="n">api_secret</span><span class="p">,</span>
                <span class="s1">&#39;sandbox&#39;</span><span class="p">:</span> <span class="n">config</span><span class="o">.</span><span class="n">sandbox</span><span class="p">,</span>
                <span class="s1">&#39;enableRateLimit&#39;</span><span class="p">:</span> <span class="kc">True</span>
            <span class="p">})</span>
    
    <span class="k">def</span> <span class="nf">get_ticker</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">exchange</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get current ticker from best exchange.&quot;&quot;&quot;</span>
        <span class="n">exchange</span> <span class="o">=</span> <span class="n">exchange</span> <span class="ow">or</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exchanges</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
        
        <span class="n">cache_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;ticker_</span><span class="si">{</span><span class="n">exchange</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">symbol</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_cache_valid</span><span class="p">(</span><span class="n">cache_key</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">cache_key</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">]</span>
        
        <span class="n">ticker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exchanges</span><span class="p">[</span><span class="n">exchange</span><span class="p">]</span><span class="o">.</span><span class="n">fetch_ticker</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_cache</span><span class="p">(</span><span class="n">cache_key</span><span class="p">,</span> <span class="n">ticker</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span>
            <span class="s1">&#39;exchange&#39;</span><span class="p">:</span> <span class="n">exchange</span><span class="p">,</span>
            <span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="n">ticker</span><span class="p">[</span><span class="s1">&#39;last&#39;</span><span class="p">],</span>
            <span class="s1">&#39;bid&#39;</span><span class="p">:</span> <span class="n">ticker</span><span class="p">[</span><span class="s1">&#39;bid&#39;</span><span class="p">],</span>
            <span class="s1">&#39;ask&#39;</span><span class="p">:</span> <span class="n">ticker</span><span class="p">[</span><span class="s1">&#39;ask&#39;</span><span class="p">],</span>
            <span class="s1">&#39;volume&#39;</span><span class="p">:</span> <span class="n">ticker</span><span class="p">[</span><span class="s1">&#39;baseVolume&#39;</span><span class="p">],</span>
            <span class="s1">&#39;change_24h&#39;</span><span class="p">:</span> <span class="n">ticker</span><span class="p">[</span><span class="s1">&#39;percentage&#39;</span><span class="p">]</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">get_ohlcv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">timeframe</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;1h&#39;</span><span class="p">,</span> 
                  <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span> <span class="n">exchange</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get OHLCV data as DataFrame.&quot;&quot;&quot;</span>
        <span class="n">exchange</span> <span class="o">=</span> <span class="n">exchange</span> <span class="ow">or</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exchanges</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
        
        <span class="n">ohlcv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exchanges</span><span class="p">[</span><span class="n">exchange</span><span class="p">]</span><span class="o">.</span><span class="n">fetch_ohlcv</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">timeframe</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">)</span>
        
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">ohlcv</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">,</span> <span class="s1">&#39;open&#39;</span><span class="p">,</span> <span class="s1">&#39;high&#39;</span><span class="p">,</span> <span class="s1">&#39;low&#39;</span><span class="p">,</span> <span class="s1">&#39;close&#39;</span><span class="p">,</span> <span class="s1">&#39;volume&#39;</span><span class="p">])</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">],</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;ms&#39;</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;timestamp&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">df</span>
    
    <span class="k">def</span> <span class="nf">get_order_book</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span> <span class="n">exchange</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get order book data.&quot;&quot;&quot;</span>
        <span class="n">exchange</span> <span class="o">=</span> <span class="n">exchange</span> <span class="ow">or</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exchanges</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">book</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exchanges</span><span class="p">[</span><span class="n">exchange</span><span class="p">]</span><span class="o">.</span><span class="n">fetch_order_book</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">limit</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;bids&#39;</span><span class="p">:</span> <span class="n">book</span><span class="p">[</span><span class="s1">&#39;bids&#39;</span><span class="p">][:</span><span class="mi">10</span><span class="p">],</span>
            <span class="s1">&#39;asks&#39;</span><span class="p">:</span> <span class="n">book</span><span class="p">[</span><span class="s1">&#39;asks&#39;</span><span class="p">][:</span><span class="mi">10</span><span class="p">],</span>
            <span class="s1">&#39;spread&#39;</span><span class="p">:</span> <span class="n">book</span><span class="p">[</span><span class="s1">&#39;asks&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">book</span><span class="p">[</span><span class="s1">&#39;bids&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">book</span><span class="p">[</span><span class="s1">&#39;asks&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">book</span><span class="p">[</span><span class="s1">&#39;bids&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">get_multi_exchange_prices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get prices from all connected exchanges.&quot;&quot;&quot;</span>
        <span class="n">prices</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">exchange</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">exchanges</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ticker</span> <span class="o">=</span> <span class="n">exchange</span><span class="o">.</span><span class="n">fetch_ticker</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
                <span class="n">prices</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;bid&#39;</span><span class="p">:</span> <span class="n">ticker</span><span class="p">[</span><span class="s1">&#39;bid&#39;</span><span class="p">],</span> <span class="s1">&#39;ask&#39;</span><span class="p">:</span> <span class="n">ticker</span><span class="p">[</span><span class="s1">&#39;ask&#39;</span><span class="p">],</span> <span class="s1">&#39;last&#39;</span><span class="p">:</span> <span class="n">ticker</span><span class="p">[</span><span class="s1">&#39;last&#39;</span><span class="p">]}</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">continue</span>
        <span class="k">return</span> <span class="n">prices</span>
    
    <span class="k">def</span> <span class="nf">_is_cache_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">timestamp</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;time&#39;</span><span class="p">])</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_ttl</span>
    
    <span class="k">def</span> <span class="nf">_update_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">timestamp</span><span class="p">()}</span>
</code></pre><div class="code-output" id="output-cell-16-2"></div></div>
<div class="md-cell"><h2>2.2 On-Chain Data Integration</h2></div>
<div class="code-cell" id="cell-16-3" data-source="IyBkYXRhL29uY2hhaW5fZGF0YS5weQpmcm9tIHdlYjMgaW1wb3J0IFdlYjMKaW1wb3J0IHJlcXVlc3RzCmZyb20gdHlwaW5nIGltcG9ydCBEaWN0LCBPcHRpb25hbAoKY2xhc3MgT25DaGFpbkRhdGFNYW5hZ2VyOgogICAgIiIiT24tY2hhaW4gYW5hbHl0aWNzIGRhdGEuIiIiCiAgICAKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBycGNfdXJsOiBzdHIpOgogICAgICAgIHNlbGYudzMgPSBXZWIzKFdlYjMuSFRUUFByb3ZpZGVyKHJwY191cmwpKQogICAgICAgIHNlbGYuY29ubmVjdGVkID0gc2VsZi53My5pc19jb25uZWN0ZWQoKQogICAgCiAgICBkZWYgZ2V0X2dhc19wcmljZShzZWxmKSAtPiBEaWN0OgogICAgICAgICIiIkdldCBjdXJyZW50IGdhcyBwcmljZXMuIiIiCiAgICAgICAgZ2FzX3dlaSA9IHNlbGYudzMuZXRoLmdhc19wcmljZQogICAgICAgIGdhc19nd2VpID0gZmxvYXQoc2VsZi53My5mcm9tX3dlaShnYXNfd2VpLCAnZ3dlaScpKQogICAgICAgIAogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICdnYXNfZ3dlaSc6IGdhc19nd2VpLAogICAgICAgICAgICAnZmFzdCc6IGdhc19nd2VpICogMS4yLAogICAgICAgICAgICAnc2xvdyc6IGdhc19nd2VpICogMC44CiAgICAgICAgfQogICAgCiAgICBkZWYgZ2V0X3doYWxlX3RyYW5zYWN0aW9ucyhzZWxmLCBtaW5fdmFsdWVfZXRoOiBmbG9hdCA9IDEwMCkgLT4gbGlzdDoKICAgICAgICAiIiJNb25pdG9yIGxhcmdlIHRyYW5zYWN0aW9ucyAoc2ltcGxpZmllZCkuIiIiCiAgICAgICAgIyBJbiBwcm9kdWN0aW9uLCB1c2Ugc2VydmljZXMgbGlrZSBXaGFsZSBBbGVydCBBUEkKICAgICAgICByZXR1cm4gW10KICAgIAogICAgZGVmIGdldF9leGNoYW5nZV9mbG93cyhzZWxmKSAtPiBEaWN0OgogICAgICAgICIiIkdldCBleGNoYW5nZSBpbmZsb3cvb3V0ZmxvdyBkYXRhLiIiIgogICAgICAgICMgSW4gcHJvZHVjdGlvbiwgdXNlIEdsYXNzbm9kZSwgQ3J5cHRvUXVhbnQsIGV0Yy4KICAgICAgICByZXR1cm4gewogICAgICAgICAgICAnYnRjX2V4Y2hhbmdlX25ldGZsb3cnOiAwLAogICAgICAgICAgICAnZXRoX2V4Y2hhbmdlX25ldGZsb3cnOiAwLAogICAgICAgICAgICAnaW50ZXJwcmV0YXRpb24nOiAnbmV1dHJhbCcKICAgICAgICB9"><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-16-3')" type="button">Run</button></div><pre><code><span class="c1"># data/onchain_data.py</span>
<span class="kn">from</span> <span class="nn">web3</span> <span class="kn">import</span> <span class="n">Web3</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Optional</span>

<span class="k">class</span> <span class="nc">OnChainDataManager</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;On-chain analytics data.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rpc_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w3</span> <span class="o">=</span> <span class="n">Web3</span><span class="p">(</span><span class="n">Web3</span><span class="o">.</span><span class="n">HTTPProvider</span><span class="p">(</span><span class="n">rpc_url</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connected</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">w3</span><span class="o">.</span><span class="n">is_connected</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">get_gas_price</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get current gas prices.&quot;&quot;&quot;</span>
        <span class="n">gas_wei</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">gas_price</span>
        <span class="n">gas_gwei</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">w3</span><span class="o">.</span><span class="n">from_wei</span><span class="p">(</span><span class="n">gas_wei</span><span class="p">,</span> <span class="s1">&#39;gwei&#39;</span><span class="p">))</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;gas_gwei&#39;</span><span class="p">:</span> <span class="n">gas_gwei</span><span class="p">,</span>
            <span class="s1">&#39;fast&#39;</span><span class="p">:</span> <span class="n">gas_gwei</span> <span class="o">*</span> <span class="mf">1.2</span><span class="p">,</span>
            <span class="s1">&#39;slow&#39;</span><span class="p">:</span> <span class="n">gas_gwei</span> <span class="o">*</span> <span class="mf">0.8</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">get_whale_transactions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">min_value_eth</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">100</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Monitor large transactions (simplified).&quot;&quot;&quot;</span>
        <span class="c1"># In production, use services like Whale Alert API</span>
        <span class="k">return</span> <span class="p">[]</span>
    
    <span class="k">def</span> <span class="nf">get_exchange_flows</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get exchange inflow/outflow data.&quot;&quot;&quot;</span>
        <span class="c1"># In production, use Glassnode, CryptoQuant, etc.</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;btc_exchange_netflow&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;eth_exchange_netflow&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;interpretation&#39;</span><span class="p">:</span> <span class="s1">&#39;neutral&#39;</span>
        <span class="p">}</span>
</code></pre><div class="code-output" id="output-cell-16-3"></div></div>
<div class="md-cell"><h2>2.3 DeFi Data</h2></div>
<div class="code-cell" id="cell-16-4" data-source="IyBkYXRhL2RlZmlfZGF0YS5weQppbXBvcnQgcmVxdWVzdHMKZnJvbSB0eXBpbmcgaW1wb3J0IERpY3QsIExpc3QKCmNsYXNzIERlRmlEYXRhTWFuYWdlcjoKICAgICIiIkRlRmkgcHJvdG9jb2wgZGF0YSBmcm9tIHZhcmlvdXMgc291cmNlcy4iIiIKICAgIAogICAgZGVmIF9faW5pdF9fKHNlbGYpOgogICAgICAgIHNlbGYubGxhbWFfYmFzZSA9ICdodHRwczovL2FwaS5sbGFtYS5maScKICAgICAgICBzZWxmLnlpZWxkc19iYXNlID0gJ2h0dHBzOi8veWllbGRzLmxsYW1hLmZpJwogICAgCiAgICBkZWYgZ2V0X3RvcF95aWVsZHMoc2VsZiwgbWluX3R2bDogZmxvYXQgPSAxXzAwMF8wMDAsIG1heF9yZXN1bHRzOiBpbnQgPSAxMCkgLT4gTGlzdFtEaWN0XToKICAgICAgICAiIiJHZXQgdG9wIHlpZWxkIG9wcG9ydHVuaXRpZXMuIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICByZXNwb25zZSA9IHJlcXVlc3RzLmdldChmJ3tzZWxmLnlpZWxkc19iYXNlfS9wb29scycpCiAgICAgICAgICAgIGlmIHJlc3BvbnNlLnN0YXR1c19jb2RlICE9IDIwMDoKICAgICAgICAgICAgICAgIHJldHVybiBbXQogICAgICAgICAgICAKICAgICAgICAgICAgcG9vbHMgPSByZXNwb25zZS5qc29uKCkuZ2V0KCdkYXRhJywgW10pCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEZpbHRlciBhbmQgc29ydAogICAgICAgICAgICBmaWx0ZXJlZCA9IFsKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAncG9vbCc6IHAuZ2V0KCdwb29sJyksCiAgICAgICAgICAgICAgICAgICAgJ3Byb2plY3QnOiBwLmdldCgncHJvamVjdCcpLAogICAgICAgICAgICAgICAgICAgICdjaGFpbic6IHAuZ2V0KCdjaGFpbicpLAogICAgICAgICAgICAgICAgICAgICdzeW1ib2wnOiBwLmdldCgnc3ltYm9sJyksCiAgICAgICAgICAgICAgICAgICAgJ3R2bCc6IHAuZ2V0KCd0dmxVc2QnLCAwKSwKICAgICAgICAgICAgICAgICAgICAnYXB5JzogcC5nZXQoJ2FweScsIDApCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBmb3IgcCBpbiBwb29scwogICAgICAgICAgICAgICAgaWYgcC5nZXQoJ3R2bFVzZCcsIDApID49IG1pbl90dmwgYW5kIHAuZ2V0KCdhcHknLCAwKSA+IDAKICAgICAgICAgICAgXQogICAgICAgICAgICAKICAgICAgICAgICAgcmV0dXJuIHNvcnRlZChmaWx0ZXJlZCwga2V5PWxhbWJkYSB4OiB4WydhcHknXSwgcmV2ZXJzZT1UcnVlKVs6bWF4X3Jlc3VsdHNdCiAgICAgICAgZXhjZXB0OgogICAgICAgICAgICByZXR1cm4gW10KICAgIAogICAgZGVmIGdldF9wcm90b2NvbF90dmwoc2VsZiwgcHJvdG9jb2w6IHN0cikgLT4gRGljdDoKICAgICAgICAiIiJHZXQgVFZMIGZvciBzcGVjaWZpYyBwcm90b2NvbC4iIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgIHJlc3BvbnNlID0gcmVxdWVzdHMuZ2V0KGYne3NlbGYubGxhbWFfYmFzZX0vcHJvdG9jb2wve3Byb3RvY29sfScpCiAgICAgICAgICAgIGlmIHJlc3BvbnNlLnN0YXR1c19jb2RlID09IDIwMDoKICAgICAgICAgICAgICAgIGRhdGEgPSByZXNwb25zZS5qc29uKCkKICAgICAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICAgICAgJ25hbWUnOiBkYXRhLmdldCgnbmFtZScpLAogICAgICAgICAgICAgICAgICAgICd0dmwnOiBkYXRhLmdldCgndHZsJywgMCksCiAgICAgICAgICAgICAgICAgICAgJ2NoYWlucyc6IGxpc3QoZGF0YS5nZXQoJ2NoYWluVHZscycsIHt9KS5rZXlzKCkpCiAgICAgICAgICAgICAgICB9CiAgICAgICAgZXhjZXB0OgogICAgICAgICAgICBwYXNzCiAgICAgICAgcmV0dXJuIHt9"><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-16-4')" type="button">Run</button></div><pre><code><span class="c1"># data/defi_data.py</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span>

<span class="k">class</span> <span class="nc">DeFiDataManager</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;DeFi protocol data from various sources.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">llama_base</span> <span class="o">=</span> <span class="s1">&#39;https://api.llama.fi&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">yields_base</span> <span class="o">=</span> <span class="s1">&#39;https://yields.llama.fi&#39;</span>
    
    <span class="k">def</span> <span class="nf">get_top_yields</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">min_tvl</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">1_000_000</span><span class="p">,</span> <span class="n">max_results</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Get top yield opportunities.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">yields_base</span><span class="si">}</span><span class="s1">/pools&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">[]</span>
            
            <span class="n">pools</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="p">[])</span>
            
            <span class="c1"># Filter and sort</span>
            <span class="n">filtered</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s1">&#39;pool&#39;</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pool&#39;</span><span class="p">),</span>
                    <span class="s1">&#39;project&#39;</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;project&#39;</span><span class="p">),</span>
                    <span class="s1">&#39;chain&#39;</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;chain&#39;</span><span class="p">),</span>
                    <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;symbol&#39;</span><span class="p">),</span>
                    <span class="s1">&#39;tvl&#39;</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tvlUsd&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                    <span class="s1">&#39;apy&#39;</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;apy&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="p">}</span>
                <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pools</span>
                <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tvlUsd&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">min_tvl</span> <span class="ow">and</span> <span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;apy&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="p">]</span>
            
            <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">filtered</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;apy&#39;</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)[:</span><span class="n">max_results</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>
    
    <span class="k">def</span> <span class="nf">get_protocol_tvl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">protocol</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get TVL for specific protocol.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">llama_base</span><span class="si">}</span><span class="s1">/protocol/</span><span class="si">{</span><span class="n">protocol</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
                <span class="k">return</span> <span class="p">{</span>
                    <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">),</span>
                    <span class="s1">&#39;tvl&#39;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tvl&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                    <span class="s1">&#39;chains&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;chainTvls&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                <span class="p">}</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">return</span> <span class="p">{}</span>
</code></pre><div class="code-output" id="output-cell-16-4"></div></div>
<div class="md-cell"><hr />
<h1>Part 3: Strategy Engine</h1>
<h2>3.1 Base Strategy Class</h2></div>
<div class="code-cell" id="cell-16-5" data-source="IyBzdHJhdGVnaWVzL2Jhc2Vfc3RyYXRlZ3kucHkKZnJvbSBhYmMgaW1wb3J0IEFCQywgYWJzdHJhY3RtZXRob2QKZnJvbSBkYXRhY2xhc3NlcyBpbXBvcnQgZGF0YWNsYXNzCmZyb20gdHlwaW5nIGltcG9ydCBPcHRpb25hbCwgRGljdApmcm9tIGVudW0gaW1wb3J0IEVudW0KaW1wb3J0IHBhbmRhcyBhcyBwZAoKY2xhc3MgU2lnbmFsVHlwZShFbnVtKToKICAgIEJVWSA9ICdidXknCiAgICBTRUxMID0gJ3NlbGwnCiAgICBIT0xEID0gJ2hvbGQnCgpAZGF0YWNsYXNzCmNsYXNzIFNpZ25hbDoKICAgIHN5bWJvbDogc3RyCiAgICBzaWduYWxfdHlwZTogU2lnbmFsVHlwZQogICAgc3RyZW5ndGg6IGZsb2F0ICAjIDAtMQogICAgcHJpY2U6IGZsb2F0CiAgICBzdG9wX2xvc3M6IE9wdGlvbmFsW2Zsb2F0XSA9IE5vbmUKICAgIHRha2VfcHJvZml0OiBPcHRpb25hbFtmbG9hdF0gPSBOb25lCiAgICBtZXRhZGF0YTogRGljdCA9IE5vbmUKCmNsYXNzIEJhc2VTdHJhdGVneShBQkMpOgogICAgIiIiQmFzZSBjbGFzcyBmb3IgYWxsIHRyYWRpbmcgc3RyYXRlZ2llcy4iIiIKICAgIAogICAgZGVmIF9faW5pdF9fKHNlbGYsIG5hbWU6IHN0ciwgcGFyYW1zOiBEaWN0ID0gTm9uZSk6CiAgICAgICAgc2VsZi5uYW1lID0gbmFtZQogICAgICAgIHNlbGYucGFyYW1zID0gcGFyYW1zIG9yIHt9CiAgICAgICAgc2VsZi5zaWduYWxzX2dlbmVyYXRlZCA9IDAKICAgIAogICAgQGFic3RyYWN0bWV0aG9kCiAgICBkZWYgZ2VuZXJhdGVfc2lnbmFsKHNlbGYsIGRhdGE6IHBkLkRhdGFGcmFtZSwgc3ltYm9sOiBzdHIpIC0+IE9wdGlvbmFsW1NpZ25hbF06CiAgICAgICAgIiIiR2VuZXJhdGUgdHJhZGluZyBzaWduYWwgZnJvbSBkYXRhLiIiIgogICAgICAgIHBhc3MKICAgIAogICAgQGFic3RyYWN0bWV0aG9kCiAgICBkZWYgY2FsY3VsYXRlX2luZGljYXRvcnMoc2VsZiwgZGF0YTogcGQuRGF0YUZyYW1lKSAtPiBwZC5EYXRhRnJhbWU6CiAgICAgICAgIiIiQ2FsY3VsYXRlIHN0cmF0ZWd5LXNwZWNpZmljIGluZGljYXRvcnMuIiIiCiAgICAgICAgcGFzcwogICAgCiAgICBkZWYgdmFsaWRhdGVfc2lnbmFsKHNlbGYsIHNpZ25hbDogU2lnbmFsKSAtPiBib29sOgogICAgICAgICIiIlZhbGlkYXRlIHNpZ25hbCBiZWZvcmUgcmV0dXJuaW5nLiIiIgogICAgICAgIGlmIHNpZ25hbCBpcyBOb25lOgogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICBpZiBzaWduYWwuc3RyZW5ndGggPCBzZWxmLnBhcmFtcy5nZXQoJ21pbl9zdHJlbmd0aCcsIDAuNSk6CiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgIHJldHVybiBUcnVl"><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-16-5')" type="button">Run</button></div><pre><code><span class="c1"># strategies/base_strategy.py</span>
<span class="kn">from</span> <span class="nn">abc</span> <span class="kn">import</span> <span class="n">ABC</span><span class="p">,</span> <span class="n">abstractmethod</span>
<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Dict</span>
<span class="kn">from</span> <span class="nn">enum</span> <span class="kn">import</span> <span class="n">Enum</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="k">class</span> <span class="nc">SignalType</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
    <span class="n">BUY</span> <span class="o">=</span> <span class="s1">&#39;buy&#39;</span>
    <span class="n">SELL</span> <span class="o">=</span> <span class="s1">&#39;sell&#39;</span>
    <span class="n">HOLD</span> <span class="o">=</span> <span class="s1">&#39;hold&#39;</span>

<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">Signal</span><span class="p">:</span>
    <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">signal_type</span><span class="p">:</span> <span class="n">SignalType</span>
    <span class="n">strength</span><span class="p">:</span> <span class="nb">float</span>  <span class="c1"># 0-1</span>
    <span class="n">price</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">stop_loss</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">take_profit</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">metadata</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="kc">None</span>

<span class="k">class</span> <span class="nc">BaseStrategy</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Base class for all trading strategies.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">params</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">signals_generated</span> <span class="o">=</span> <span class="mi">0</span>
    
    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">generate_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Signal</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Generate trading signal from data.&quot;&quot;&quot;</span>
        <span class="k">pass</span>
    
    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">calculate_indicators</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate strategy-specific indicators.&quot;&quot;&quot;</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">validate_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">signal</span><span class="p">:</span> <span class="n">Signal</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Validate signal before returning.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">signal</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">signal</span><span class="o">.</span><span class="n">strength</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;min_strength&#39;</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span>
</code></pre><div class="code-output" id="output-cell-16-5"></div></div>
<div class="md-cell"><h2>3.2 Trend Following Strategy</h2></div>
<div class="code-cell" id="cell-16-6" data-source="IyBzdHJhdGVnaWVzL3RyZW5kX3N0cmF0ZWd5LnB5CmltcG9ydCBwYW5kYXMgYXMgcGQKaW1wb3J0IG51bXB5IGFzIG5wCmZyb20gdHlwaW5nIGltcG9ydCBPcHRpb25hbAoKY2xhc3MgVHJlbmRTdHJhdGVneShCYXNlU3RyYXRlZ3kpOgogICAgIiIiVHJlbmQgZm9sbG93aW5nIHVzaW5nIG11bHRpcGxlIG1vdmluZyBhdmVyYWdlcy4iIiIKICAgIAogICAgZGVmIF9faW5pdF9fKHNlbGYsIHBhcmFtczogRGljdCA9IE5vbmUpOgogICAgICAgIGRlZmF1bHRfcGFyYW1zID0gewogICAgICAgICAgICAnZmFzdF9tYSc6IDIwLAogICAgICAgICAgICAnc2xvd19tYSc6IDUwLAogICAgICAgICAgICAnYXRyX3BlcmlvZCc6IDE0LAogICAgICAgICAgICAnYXRyX211bHRpcGxpZXInOiAyLjAsCiAgICAgICAgICAgICdtaW5fc3RyZW5ndGgnOiAwLjYKICAgICAgICB9CiAgICAgICAgcGFyYW1zID0geyoqZGVmYXVsdF9wYXJhbXMsICoqKHBhcmFtcyBvciB7fSl9CiAgICAgICAgc3VwZXIoKS5fX2luaXRfXygnVHJlbmRGb2xsb3dpbmcnLCBwYXJhbXMpCiAgICAKICAgIGRlZiBjYWxjdWxhdGVfaW5kaWNhdG9ycyhzZWxmLCBkYXRhOiBwZC5EYXRhRnJhbWUpIC0+IHBkLkRhdGFGcmFtZToKICAgICAgICBkZiA9IGRhdGEuY29weSgpCiAgICAgICAgCiAgICAgICAgIyBNb3ZpbmcgYXZlcmFnZXMKICAgICAgICBkZlsnZmFzdF9tYSddID0gZGZbJ2Nsb3NlJ10ucm9sbGluZyhzZWxmLnBhcmFtc1snZmFzdF9tYSddKS5tZWFuKCkKICAgICAgICBkZlsnc2xvd19tYSddID0gZGZbJ2Nsb3NlJ10ucm9sbGluZyhzZWxmLnBhcmFtc1snc2xvd19tYSddKS5tZWFuKCkKICAgICAgICAKICAgICAgICAjIEFUUiBmb3Igc3RvcHMKICAgICAgICBoaWdoX2xvdyA9IGRmWydoaWdoJ10gLSBkZlsnbG93J10KICAgICAgICBoaWdoX2Nsb3NlID0gYWJzKGRmWydoaWdoJ10gLSBkZlsnY2xvc2UnXS5zaGlmdCgpKQogICAgICAgIGxvd19jbG9zZSA9IGFicyhkZlsnbG93J10gLSBkZlsnY2xvc2UnXS5zaGlmdCgpKQogICAgICAgIHRyID0gcGQuY29uY2F0KFtoaWdoX2xvdywgaGlnaF9jbG9zZSwgbG93X2Nsb3NlXSwgYXhpcz0xKS5tYXgoYXhpcz0xKQogICAgICAgIGRmWydhdHInXSA9IHRyLnJvbGxpbmcoc2VsZi5wYXJhbXNbJ2F0cl9wZXJpb2QnXSkubWVhbigpCiAgICAgICAgCiAgICAgICAgIyBUcmVuZCBzdHJlbmd0aAogICAgICAgIGRmWyd0cmVuZCddID0gbnAud2hlcmUoZGZbJ2Zhc3RfbWEnXSA+IGRmWydzbG93X21hJ10sIDEsIC0xKQogICAgICAgIGRmWydtYV9kaWZmJ10gPSAoZGZbJ2Zhc3RfbWEnXSAtIGRmWydzbG93X21hJ10pIC8gZGZbJ3Nsb3dfbWEnXQogICAgICAgIAogICAgICAgIHJldHVybiBkZgogICAgCiAgICBkZWYgZ2VuZXJhdGVfc2lnbmFsKHNlbGYsIGRhdGE6IHBkLkRhdGFGcmFtZSwgc3ltYm9sOiBzdHIpIC0+IE9wdGlvbmFsW1NpZ25hbF06CiAgICAgICAgZGYgPSBzZWxmLmNhbGN1bGF0ZV9pbmRpY2F0b3JzKGRhdGEpCiAgICAgICAgCiAgICAgICAgaWYgbGVuKGRmKSA8IHNlbGYucGFyYW1zWydzbG93X21hJ10gKyAxOgogICAgICAgICAgICByZXR1cm4gTm9uZQogICAgICAgIAogICAgICAgIGN1cnJlbnQgPSBkZi5pbG9jWy0xXQogICAgICAgIHByZXZpb3VzID0gZGYuaWxvY1stMl0KICAgICAgICAKICAgICAgICAjIENyb3Nzb3ZlciBkZXRlY3Rpb24KICAgICAgICBidWxsaXNoX2Nyb3NzID0gcHJldmlvdXNbJ2Zhc3RfbWEnXSA8PSBwcmV2aW91c1snc2xvd19tYSddIGFuZCBjdXJyZW50WydmYXN0X21hJ10gPiBjdXJyZW50WydzbG93X21hJ10KICAgICAgICBiZWFyaXNoX2Nyb3NzID0gcHJldmlvdXNbJ2Zhc3RfbWEnXSA+PSBwcmV2aW91c1snc2xvd19tYSddIGFuZCBjdXJyZW50WydmYXN0X21hJ10gPCBjdXJyZW50WydzbG93X21hJ10KICAgICAgICAKICAgICAgICBpZiBidWxsaXNoX2Nyb3NzOgogICAgICAgICAgICBzdHJlbmd0aCA9IG1pbihhYnMoY3VycmVudFsnbWFfZGlmZiddKSAqIDEwLCAxLjApCiAgICAgICAgICAgIHN0b3BfbG9zcyA9IGN1cnJlbnRbJ2Nsb3NlJ10gLSBjdXJyZW50WydhdHInXSAqIHNlbGYucGFyYW1zWydhdHJfbXVsdGlwbGllciddCiAgICAgICAgICAgIHRha2VfcHJvZml0ID0gY3VycmVudFsnY2xvc2UnXSArIGN1cnJlbnRbJ2F0ciddICogc2VsZi5wYXJhbXNbJ2F0cl9tdWx0aXBsaWVyJ10gKiAyCiAgICAgICAgICAgIAogICAgICAgICAgICBzaWduYWwgPSBTaWduYWwoCiAgICAgICAgICAgICAgICBzeW1ib2w9c3ltYm9sLAogICAgICAgICAgICAgICAgc2lnbmFsX3R5cGU9U2lnbmFsVHlwZS5CVVksCiAgICAgICAgICAgICAgICBzdHJlbmd0aD1zdHJlbmd0aCwKICAgICAgICAgICAgICAgIHByaWNlPWN1cnJlbnRbJ2Nsb3NlJ10sCiAgICAgICAgICAgICAgICBzdG9wX2xvc3M9c3RvcF9sb3NzLAogICAgICAgICAgICAgICAgdGFrZV9wcm9maXQ9dGFrZV9wcm9maXQsCiAgICAgICAgICAgICAgICBtZXRhZGF0YT17J3N0cmF0ZWd5Jzogc2VsZi5uYW1lLCAnbWFfZGlmZic6IGN1cnJlbnRbJ21hX2RpZmYnXX0KICAgICAgICAgICAgKQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgc2VsZi52YWxpZGF0ZV9zaWduYWwoc2lnbmFsKToKICAgICAgICAgICAgICAgIHNlbGYuc2lnbmFsc19nZW5lcmF0ZWQgKz0gMQogICAgICAgICAgICAgICAgcmV0dXJuIHNpZ25hbAogICAgICAgIAogICAgICAgIGVsaWYgYmVhcmlzaF9jcm9zczoKICAgICAgICAgICAgc3RyZW5ndGggPSBtaW4oYWJzKGN1cnJlbnRbJ21hX2RpZmYnXSkgKiAxMCwgMS4wKQogICAgICAgICAgICBzdG9wX2xvc3MgPSBjdXJyZW50WydjbG9zZSddICsgY3VycmVudFsnYXRyJ10gKiBzZWxmLnBhcmFtc1snYXRyX211bHRpcGxpZXInXQogICAgICAgICAgICB0YWtlX3Byb2ZpdCA9IGN1cnJlbnRbJ2Nsb3NlJ10gLSBjdXJyZW50WydhdHInXSAqIHNlbGYucGFyYW1zWydhdHJfbXVsdGlwbGllciddICogMgogICAgICAgICAgICAKICAgICAgICAgICAgc2lnbmFsID0gU2lnbmFsKAogICAgICAgICAgICAgICAgc3ltYm9sPXN5bWJvbCwKICAgICAgICAgICAgICAgIHNpZ25hbF90eXBlPVNpZ25hbFR5cGUuU0VMTCwKICAgICAgICAgICAgICAgIHN0cmVuZ3RoPXN0cmVuZ3RoLAogICAgICAgICAgICAgICAgcHJpY2U9Y3VycmVudFsnY2xvc2UnXSwKICAgICAgICAgICAgICAgIHN0b3BfbG9zcz1zdG9wX2xvc3MsCiAgICAgICAgICAgICAgICB0YWtlX3Byb2ZpdD10YWtlX3Byb2ZpdCwKICAgICAgICAgICAgICAgIG1ldGFkYXRhPXsnc3RyYXRlZ3knOiBzZWxmLm5hbWUsICdtYV9kaWZmJzogY3VycmVudFsnbWFfZGlmZiddfQogICAgICAgICAgICApCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiBzZWxmLnZhbGlkYXRlX3NpZ25hbChzaWduYWwpOgogICAgICAgICAgICAgICAgc2VsZi5zaWduYWxzX2dlbmVyYXRlZCArPSAxCiAgICAgICAgICAgICAgICByZXR1cm4gc2lnbmFsCiAgICAgICAgCiAgICAgICAgcmV0dXJuIE5vbmU="><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-16-6')" type="button">Run</button></div><pre><code><span class="c1"># strategies/trend_strategy.py</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span>

<span class="k">class</span> <span class="nc">TrendStrategy</span><span class="p">(</span><span class="n">BaseStrategy</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Trend following using multiple moving averages.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">default_params</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;fast_ma&#39;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
            <span class="s1">&#39;slow_ma&#39;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span>
            <span class="s1">&#39;atr_period&#39;</span><span class="p">:</span> <span class="mi">14</span><span class="p">,</span>
            <span class="s1">&#39;atr_multiplier&#39;</span><span class="p">:</span> <span class="mf">2.0</span><span class="p">,</span>
            <span class="s1">&#39;min_strength&#39;</span><span class="p">:</span> <span class="mf">0.6</span>
        <span class="p">}</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">default_params</span><span class="p">,</span> <span class="o">**</span><span class="p">(</span><span class="n">params</span> <span class="ow">or</span> <span class="p">{})}</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s1">&#39;TrendFollowing&#39;</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">calculate_indicators</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        
        <span class="c1"># Moving averages</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;fast_ma&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;fast_ma&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;slow_ma&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;slow_ma&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        
        <span class="c1"># ATR for stops</span>
        <span class="n">high_low</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;high&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;low&#39;</span><span class="p">]</span>
        <span class="n">high_close</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;high&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">())</span>
        <span class="n">low_close</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;low&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">())</span>
        <span class="n">tr</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">high_low</span><span class="p">,</span> <span class="n">high_close</span><span class="p">,</span> <span class="n">low_close</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;atr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tr</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;atr_period&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        
        <span class="c1"># Trend strength</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;trend&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;fast_ma&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;slow_ma&#39;</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;ma_diff&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;fast_ma&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;slow_ma&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;slow_ma&#39;</span><span class="p">]</span>
        
        <span class="k">return</span> <span class="n">df</span>
    
    <span class="k">def</span> <span class="nf">generate_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Signal</span><span class="p">]:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_indicators</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;slow_ma&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        
        <span class="n">current</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">previous</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
        
        <span class="c1"># Crossover detection</span>
        <span class="n">bullish_cross</span> <span class="o">=</span> <span class="n">previous</span><span class="p">[</span><span class="s1">&#39;fast_ma&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">previous</span><span class="p">[</span><span class="s1">&#39;slow_ma&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">current</span><span class="p">[</span><span class="s1">&#39;fast_ma&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">current</span><span class="p">[</span><span class="s1">&#39;slow_ma&#39;</span><span class="p">]</span>
        <span class="n">bearish_cross</span> <span class="o">=</span> <span class="n">previous</span><span class="p">[</span><span class="s1">&#39;fast_ma&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">previous</span><span class="p">[</span><span class="s1">&#39;slow_ma&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">current</span><span class="p">[</span><span class="s1">&#39;fast_ma&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">current</span><span class="p">[</span><span class="s1">&#39;slow_ma&#39;</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="n">bullish_cross</span><span class="p">:</span>
            <span class="n">strength</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">current</span><span class="p">[</span><span class="s1">&#39;ma_diff&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="mi">10</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
            <span class="n">stop_loss</span> <span class="o">=</span> <span class="n">current</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">current</span><span class="p">[</span><span class="s1">&#39;atr&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;atr_multiplier&#39;</span><span class="p">]</span>
            <span class="n">take_profit</span> <span class="o">=</span> <span class="n">current</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">current</span><span class="p">[</span><span class="s1">&#39;atr&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;atr_multiplier&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span>
            
            <span class="n">signal</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">(</span>
                <span class="n">symbol</span><span class="o">=</span><span class="n">symbol</span><span class="p">,</span>
                <span class="n">signal_type</span><span class="o">=</span><span class="n">SignalType</span><span class="o">.</span><span class="n">BUY</span><span class="p">,</span>
                <span class="n">strength</span><span class="o">=</span><span class="n">strength</span><span class="p">,</span>
                <span class="n">price</span><span class="o">=</span><span class="n">current</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">],</span>
                <span class="n">stop_loss</span><span class="o">=</span><span class="n">stop_loss</span><span class="p">,</span>
                <span class="n">take_profit</span><span class="o">=</span><span class="n">take_profit</span><span class="p">,</span>
                <span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;strategy&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;ma_diff&#39;</span><span class="p">:</span> <span class="n">current</span><span class="p">[</span><span class="s1">&#39;ma_diff&#39;</span><span class="p">]}</span>
            <span class="p">)</span>
            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_signal</span><span class="p">(</span><span class="n">signal</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">signals_generated</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">return</span> <span class="n">signal</span>
        
        <span class="k">elif</span> <span class="n">bearish_cross</span><span class="p">:</span>
            <span class="n">strength</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">current</span><span class="p">[</span><span class="s1">&#39;ma_diff&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="mi">10</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
            <span class="n">stop_loss</span> <span class="o">=</span> <span class="n">current</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">current</span><span class="p">[</span><span class="s1">&#39;atr&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;atr_multiplier&#39;</span><span class="p">]</span>
            <span class="n">take_profit</span> <span class="o">=</span> <span class="n">current</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">current</span><span class="p">[</span><span class="s1">&#39;atr&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;atr_multiplier&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span>
            
            <span class="n">signal</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">(</span>
                <span class="n">symbol</span><span class="o">=</span><span class="n">symbol</span><span class="p">,</span>
                <span class="n">signal_type</span><span class="o">=</span><span class="n">SignalType</span><span class="o">.</span><span class="n">SELL</span><span class="p">,</span>
                <span class="n">strength</span><span class="o">=</span><span class="n">strength</span><span class="p">,</span>
                <span class="n">price</span><span class="o">=</span><span class="n">current</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">],</span>
                <span class="n">stop_loss</span><span class="o">=</span><span class="n">stop_loss</span><span class="p">,</span>
                <span class="n">take_profit</span><span class="o">=</span><span class="n">take_profit</span><span class="p">,</span>
                <span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;strategy&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;ma_diff&#39;</span><span class="p">:</span> <span class="n">current</span><span class="p">[</span><span class="s1">&#39;ma_diff&#39;</span><span class="p">]}</span>
            <span class="p">)</span>
            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_signal</span><span class="p">(</span><span class="n">signal</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">signals_generated</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">return</span> <span class="n">signal</span>
        
        <span class="k">return</span> <span class="kc">None</span>
</code></pre><div class="code-output" id="output-cell-16-6"></div></div>
<div class="md-cell"><h2>3.3 Mean Reversion Strategy</h2></div>
<div class="code-cell" id="cell-16-7" data-source="IyBzdHJhdGVnaWVzL21lYW5fcmV2ZXJzaW9uLnB5CgpjbGFzcyBNZWFuUmV2ZXJzaW9uU3RyYXRlZ3koQmFzZVN0cmF0ZWd5KToKICAgICIiIk1lYW4gcmV2ZXJzaW9uIHVzaW5nIFJTSSBhbmQgQm9sbGluZ2VyIEJhbmRzLiIiIgogICAgCiAgICBkZWYgX19pbml0X18oc2VsZiwgcGFyYW1zOiBEaWN0ID0gTm9uZSk6CiAgICAgICAgZGVmYXVsdF9wYXJhbXMgPSB7CiAgICAgICAgICAgICdyc2lfcGVyaW9kJzogMTQsCiAgICAgICAgICAgICdyc2lfb3ZlcnNvbGQnOiAzMCwKICAgICAgICAgICAgJ3JzaV9vdmVyYm91Z2h0JzogNzAsCiAgICAgICAgICAgICdiYl9wZXJpb2QnOiAyMCwKICAgICAgICAgICAgJ2JiX3N0ZCc6IDIuMCwKICAgICAgICAgICAgJ21pbl9zdHJlbmd0aCc6IDAuNgogICAgICAgIH0KICAgICAgICBwYXJhbXMgPSB7KipkZWZhdWx0X3BhcmFtcywgKioocGFyYW1zIG9yIHt9KX0KICAgICAgICBzdXBlcigpLl9faW5pdF9fKCdNZWFuUmV2ZXJzaW9uJywgcGFyYW1zKQogICAgCiAgICBkZWYgY2FsY3VsYXRlX2luZGljYXRvcnMoc2VsZiwgZGF0YTogcGQuRGF0YUZyYW1lKSAtPiBwZC5EYXRhRnJhbWU6CiAgICAgICAgZGYgPSBkYXRhLmNvcHkoKQogICAgICAgIAogICAgICAgICMgUlNJCiAgICAgICAgZGVsdGEgPSBkZlsnY2xvc2UnXS5kaWZmKCkKICAgICAgICBnYWluID0gZGVsdGEud2hlcmUoZGVsdGEgPiAwLCAwKS5yb2xsaW5nKHNlbGYucGFyYW1zWydyc2lfcGVyaW9kJ10pLm1lYW4oKQogICAgICAgIGxvc3MgPSAoLWRlbHRhLndoZXJlKGRlbHRhIDwgMCwgMCkpLnJvbGxpbmcoc2VsZi5wYXJhbXNbJ3JzaV9wZXJpb2QnXSkubWVhbigpCiAgICAgICAgcnMgPSBnYWluIC8gbG9zcwogICAgICAgIGRmWydyc2knXSA9IDEwMCAtICgxMDAgLyAoMSArIHJzKSkKICAgICAgICAKICAgICAgICAjIEJvbGxpbmdlciBCYW5kcwogICAgICAgIGRmWydiYl9taWQnXSA9IGRmWydjbG9zZSddLnJvbGxpbmcoc2VsZi5wYXJhbXNbJ2JiX3BlcmlvZCddKS5tZWFuKCkKICAgICAgICBkZlsnYmJfc3RkJ10gPSBkZlsnY2xvc2UnXS5yb2xsaW5nKHNlbGYucGFyYW1zWydiYl9wZXJpb2QnXSkuc3RkKCkKICAgICAgICBkZlsnYmJfdXBwZXInXSA9IGRmWydiYl9taWQnXSArIHNlbGYucGFyYW1zWydiYl9zdGQnXSAqIGRmWydiYl9zdGQnXQogICAgICAgIGRmWydiYl9sb3dlciddID0gZGZbJ2JiX21pZCddIC0gc2VsZi5wYXJhbXNbJ2JiX3N0ZCddICogZGZbJ2JiX3N0ZCddCiAgICAgICAgCiAgICAgICAgIyBCQiBwb3NpdGlvbiAoMCA9IGF0IGxvd2VyLCAxID0gYXQgdXBwZXIpCiAgICAgICAgZGZbJ2JiX3Bvc2l0aW9uJ10gPSAoZGZbJ2Nsb3NlJ10gLSBkZlsnYmJfbG93ZXInXSkgLyAoZGZbJ2JiX3VwcGVyJ10gLSBkZlsnYmJfbG93ZXInXSkKICAgICAgICAKICAgICAgICByZXR1cm4gZGYKICAgIAogICAgZGVmIGdlbmVyYXRlX3NpZ25hbChzZWxmLCBkYXRhOiBwZC5EYXRhRnJhbWUsIHN5bWJvbDogc3RyKSAtPiBPcHRpb25hbFtTaWduYWxdOgogICAgICAgIGRmID0gc2VsZi5jYWxjdWxhdGVfaW5kaWNhdG9ycyhkYXRhKQogICAgICAgIAogICAgICAgIGlmIGxlbihkZikgPCBzZWxmLnBhcmFtc1snYmJfcGVyaW9kJ10gKyAxOgogICAgICAgICAgICByZXR1cm4gTm9uZQogICAgICAgIAogICAgICAgIGN1cnJlbnQgPSBkZi5pbG9jWy0xXQogICAgICAgIAogICAgICAgICMgT3ZlcnNvbGQgY29uZGl0aW9uCiAgICAgICAgaWYgY3VycmVudFsncnNpJ10gPCBzZWxmLnBhcmFtc1sncnNpX292ZXJzb2xkJ10gYW5kIGN1cnJlbnRbJ2JiX3Bvc2l0aW9uJ10gPCAwLjE6CiAgICAgICAgICAgIHN0cmVuZ3RoID0gKHNlbGYucGFyYW1zWydyc2lfb3ZlcnNvbGQnXSAtIGN1cnJlbnRbJ3JzaSddKSAvIHNlbGYucGFyYW1zWydyc2lfb3ZlcnNvbGQnXQogICAgICAgICAgICAKICAgICAgICAgICAgc2lnbmFsID0gU2lnbmFsKAogICAgICAgICAgICAgICAgc3ltYm9sPXN5bWJvbCwKICAgICAgICAgICAgICAgIHNpZ25hbF90eXBlPVNpZ25hbFR5cGUuQlVZLAogICAgICAgICAgICAgICAgc3RyZW5ndGg9bWluKHN0cmVuZ3RoLCAxLjApLAogICAgICAgICAgICAgICAgcHJpY2U9Y3VycmVudFsnY2xvc2UnXSwKICAgICAgICAgICAgICAgIHN0b3BfbG9zcz1jdXJyZW50WydiYl9sb3dlciddICogMC45OCwKICAgICAgICAgICAgICAgIHRha2VfcHJvZml0PWN1cnJlbnRbJ2JiX21pZCddLAogICAgICAgICAgICAgICAgbWV0YWRhdGE9eydzdHJhdGVneSc6IHNlbGYubmFtZSwgJ3JzaSc6IGN1cnJlbnRbJ3JzaSddLCAnYmJfcG9zJzogY3VycmVudFsnYmJfcG9zaXRpb24nXX0KICAgICAgICAgICAgKQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgc2VsZi52YWxpZGF0ZV9zaWduYWwoc2lnbmFsKToKICAgICAgICAgICAgICAgIHJldHVybiBzaWduYWwKICAgICAgICAKICAgICAgICAjIE92ZXJib3VnaHQgY29uZGl0aW9uCiAgICAgICAgZWxpZiBjdXJyZW50Wydyc2knXSA+IHNlbGYucGFyYW1zWydyc2lfb3ZlcmJvdWdodCddIGFuZCBjdXJyZW50WydiYl9wb3NpdGlvbiddID4gMC45OgogICAgICAgICAgICBzdHJlbmd0aCA9IChjdXJyZW50Wydyc2knXSAtIHNlbGYucGFyYW1zWydyc2lfb3ZlcmJvdWdodCddKSAvICgxMDAgLSBzZWxmLnBhcmFtc1sncnNpX292ZXJib3VnaHQnXSkKICAgICAgICAgICAgCiAgICAgICAgICAgIHNpZ25hbCA9IFNpZ25hbCgKICAgICAgICAgICAgICAgIHN5bWJvbD1zeW1ib2wsCiAgICAgICAgICAgICAgICBzaWduYWxfdHlwZT1TaWduYWxUeXBlLlNFTEwsCiAgICAgICAgICAgICAgICBzdHJlbmd0aD1taW4oc3RyZW5ndGgsIDEuMCksCiAgICAgICAgICAgICAgICBwcmljZT1jdXJyZW50WydjbG9zZSddLAogICAgICAgICAgICAgICAgc3RvcF9sb3NzPWN1cnJlbnRbJ2JiX3VwcGVyJ10gKiAxLjAyLAogICAgICAgICAgICAgICAgdGFrZV9wcm9maXQ9Y3VycmVudFsnYmJfbWlkJ10sCiAgICAgICAgICAgICAgICBtZXRhZGF0YT17J3N0cmF0ZWd5Jzogc2VsZi5uYW1lLCAncnNpJzogY3VycmVudFsncnNpJ10sICdiYl9wb3MnOiBjdXJyZW50WydiYl9wb3NpdGlvbiddfQogICAgICAgICAgICApCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiBzZWxmLnZhbGlkYXRlX3NpZ25hbChzaWduYWwpOgogICAgICAgICAgICAgICAgcmV0dXJuIHNpZ25hbAogICAgICAgIAogICAgICAgIHJldHVybiBOb25l"><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-16-7')" type="button">Run</button></div><pre><code><span class="c1"># strategies/mean_reversion.py</span>

<span class="k">class</span> <span class="nc">MeanReversionStrategy</span><span class="p">(</span><span class="n">BaseStrategy</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Mean reversion using RSI and Bollinger Bands.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">default_params</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;rsi_period&#39;</span><span class="p">:</span> <span class="mi">14</span><span class="p">,</span>
            <span class="s1">&#39;rsi_oversold&#39;</span><span class="p">:</span> <span class="mi">30</span><span class="p">,</span>
            <span class="s1">&#39;rsi_overbought&#39;</span><span class="p">:</span> <span class="mi">70</span><span class="p">,</span>
            <span class="s1">&#39;bb_period&#39;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
            <span class="s1">&#39;bb_std&#39;</span><span class="p">:</span> <span class="mf">2.0</span><span class="p">,</span>
            <span class="s1">&#39;min_strength&#39;</span><span class="p">:</span> <span class="mf">0.6</span>
        <span class="p">}</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">default_params</span><span class="p">,</span> <span class="o">**</span><span class="p">(</span><span class="n">params</span> <span class="ow">or</span> <span class="p">{})}</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s1">&#39;MeanReversion&#39;</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">calculate_indicators</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        
        <span class="c1"># RSI</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span>
        <span class="n">gain</span> <span class="o">=</span> <span class="n">delta</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">delta</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;rsi_period&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">delta</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">delta</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;rsi_period&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">rs</span> <span class="o">=</span> <span class="n">gain</span> <span class="o">/</span> <span class="n">loss</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;rsi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">-</span> <span class="p">(</span><span class="mi">100</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">rs</span><span class="p">))</span>
        
        <span class="c1"># Bollinger Bands</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;bb_mid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;bb_period&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;bb_std&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;bb_period&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;bb_upper&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;bb_mid&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;bb_std&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;bb_std&#39;</span><span class="p">]</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;bb_lower&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;bb_mid&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;bb_std&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;bb_std&#39;</span><span class="p">]</span>
        
        <span class="c1"># BB position (0 = at lower, 1 = at upper)</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;bb_position&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;bb_lower&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;bb_upper&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;bb_lower&#39;</span><span class="p">])</span>
        
        <span class="k">return</span> <span class="n">df</span>
    
    <span class="k">def</span> <span class="nf">generate_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Signal</span><span class="p">]:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_indicators</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;bb_period&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        
        <span class="n">current</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        
        <span class="c1"># Oversold condition</span>
        <span class="k">if</span> <span class="n">current</span><span class="p">[</span><span class="s1">&#39;rsi&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;rsi_oversold&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">current</span><span class="p">[</span><span class="s1">&#39;bb_position&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.1</span><span class="p">:</span>
            <span class="n">strength</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;rsi_oversold&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">current</span><span class="p">[</span><span class="s1">&#39;rsi&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;rsi_oversold&#39;</span><span class="p">]</span>
            
            <span class="n">signal</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">(</span>
                <span class="n">symbol</span><span class="o">=</span><span class="n">symbol</span><span class="p">,</span>
                <span class="n">signal_type</span><span class="o">=</span><span class="n">SignalType</span><span class="o">.</span><span class="n">BUY</span><span class="p">,</span>
                <span class="n">strength</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="n">strength</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span>
                <span class="n">price</span><span class="o">=</span><span class="n">current</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">],</span>
                <span class="n">stop_loss</span><span class="o">=</span><span class="n">current</span><span class="p">[</span><span class="s1">&#39;bb_lower&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.98</span><span class="p">,</span>
                <span class="n">take_profit</span><span class="o">=</span><span class="n">current</span><span class="p">[</span><span class="s1">&#39;bb_mid&#39;</span><span class="p">],</span>
                <span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;strategy&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;rsi&#39;</span><span class="p">:</span> <span class="n">current</span><span class="p">[</span><span class="s1">&#39;rsi&#39;</span><span class="p">],</span> <span class="s1">&#39;bb_pos&#39;</span><span class="p">:</span> <span class="n">current</span><span class="p">[</span><span class="s1">&#39;bb_position&#39;</span><span class="p">]}</span>
            <span class="p">)</span>
            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_signal</span><span class="p">(</span><span class="n">signal</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">signal</span>
        
        <span class="c1"># Overbought condition</span>
        <span class="k">elif</span> <span class="n">current</span><span class="p">[</span><span class="s1">&#39;rsi&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;rsi_overbought&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">current</span><span class="p">[</span><span class="s1">&#39;bb_position&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.9</span><span class="p">:</span>
            <span class="n">strength</span> <span class="o">=</span> <span class="p">(</span><span class="n">current</span><span class="p">[</span><span class="s1">&#39;rsi&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;rsi_overbought&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="mi">100</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;rsi_overbought&#39;</span><span class="p">])</span>
            
            <span class="n">signal</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">(</span>
                <span class="n">symbol</span><span class="o">=</span><span class="n">symbol</span><span class="p">,</span>
                <span class="n">signal_type</span><span class="o">=</span><span class="n">SignalType</span><span class="o">.</span><span class="n">SELL</span><span class="p">,</span>
                <span class="n">strength</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="n">strength</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span>
                <span class="n">price</span><span class="o">=</span><span class="n">current</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">],</span>
                <span class="n">stop_loss</span><span class="o">=</span><span class="n">current</span><span class="p">[</span><span class="s1">&#39;bb_upper&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1.02</span><span class="p">,</span>
                <span class="n">take_profit</span><span class="o">=</span><span class="n">current</span><span class="p">[</span><span class="s1">&#39;bb_mid&#39;</span><span class="p">],</span>
                <span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;strategy&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;rsi&#39;</span><span class="p">:</span> <span class="n">current</span><span class="p">[</span><span class="s1">&#39;rsi&#39;</span><span class="p">],</span> <span class="s1">&#39;bb_pos&#39;</span><span class="p">:</span> <span class="n">current</span><span class="p">[</span><span class="s1">&#39;bb_position&#39;</span><span class="p">]}</span>
            <span class="p">)</span>
            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_signal</span><span class="p">(</span><span class="n">signal</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">signal</span>
        
        <span class="k">return</span> <span class="kc">None</span>
</code></pre><div class="code-output" id="output-cell-16-7"></div></div>
<div class="md-cell"><h2>3.4 Strategy Manager</h2></div>
<div class="code-cell" id="cell-16-8" data-source="IyBzdHJhdGVnaWVzL3N0cmF0ZWd5X21hbmFnZXIucHkKZnJvbSB0eXBpbmcgaW1wb3J0IExpc3QsIERpY3QsIE9wdGlvbmFsCgpjbGFzcyBTdHJhdGVneU1hbmFnZXI6CiAgICAiIiJNYW5hZ2UgbXVsdGlwbGUgc3RyYXRlZ2llcyBhbmQgY29tYmluZSBzaWduYWxzLiIiIgogICAgCiAgICBkZWYgX19pbml0X18oc2VsZik6CiAgICAgICAgc2VsZi5zdHJhdGVnaWVzOiBEaWN0W3N0ciwgQmFzZVN0cmF0ZWd5XSA9IHt9CiAgICAgICAgc2VsZi53ZWlnaHRzOiBEaWN0W3N0ciwgZmxvYXRdID0ge30KICAgIAogICAgZGVmIGFkZF9zdHJhdGVneShzZWxmLCBzdHJhdGVneTogQmFzZVN0cmF0ZWd5LCB3ZWlnaHQ6IGZsb2F0ID0gMS4wKToKICAgICAgICBzZWxmLnN0cmF0ZWdpZXNbc3RyYXRlZ3kubmFtZV0gPSBzdHJhdGVneQogICAgICAgIHNlbGYud2VpZ2h0c1tzdHJhdGVneS5uYW1lXSA9IHdlaWdodAogICAgCiAgICBkZWYgZ2V0X3NpZ25hbHMoc2VsZiwgZGF0YTogcGQuRGF0YUZyYW1lLCBzeW1ib2w6IHN0cikgLT4gTGlzdFtTaWduYWxdOgogICAgICAgICIiIkdldCBzaWduYWxzIGZyb20gYWxsIHN0cmF0ZWdpZXMuIiIiCiAgICAgICAgc2lnbmFscyA9IFtdCiAgICAgICAgZm9yIG5hbWUsIHN0cmF0ZWd5IGluIHNlbGYuc3RyYXRlZ2llcy5pdGVtcygpOgogICAgICAgICAgICBzaWduYWwgPSBzdHJhdGVneS5nZW5lcmF0ZV9zaWduYWwoZGF0YSwgc3ltYm9sKQogICAgICAgICAgICBpZiBzaWduYWw6CiAgICAgICAgICAgICAgICBzaWduYWwubWV0YWRhdGFbJ3dlaWdodCddID0gc2VsZi53ZWlnaHRzW25hbWVdCiAgICAgICAgICAgICAgICBzaWduYWxzLmFwcGVuZChzaWduYWwpCiAgICAgICAgcmV0dXJuIHNpZ25hbHMKICAgIAogICAgZGVmIGdldF9jb21iaW5lZF9zaWduYWwoc2VsZiwgZGF0YTogcGQuRGF0YUZyYW1lLCBzeW1ib2w6IHN0cikgLT4gT3B0aW9uYWxbU2lnbmFsXToKICAgICAgICAiIiJDb21iaW5lIHNpZ25hbHMgZnJvbSBhbGwgc3RyYXRlZ2llcy4iIiIKICAgICAgICBzaWduYWxzID0gc2VsZi5nZXRfc2lnbmFscyhkYXRhLCBzeW1ib2wpCiAgICAgICAgCiAgICAgICAgaWYgbm90IHNpZ25hbHM6CiAgICAgICAgICAgIHJldHVybiBOb25lCiAgICAgICAgCiAgICAgICAgIyBXZWlnaHQgc2lnbmFscwogICAgICAgIGJ1eV9zY29yZSA9IDAKICAgICAgICBzZWxsX3Njb3JlID0gMAogICAgICAgIHRvdGFsX3dlaWdodCA9IDAKICAgICAgICAKICAgICAgICBmb3Igc2lnbmFsIGluIHNpZ25hbHM6CiAgICAgICAgICAgIHdlaWdodCA9IHNpZ25hbC5tZXRhZGF0YS5nZXQoJ3dlaWdodCcsIDEuMCkKICAgICAgICAgICAgaWYgc2lnbmFsLnNpZ25hbF90eXBlID09IFNpZ25hbFR5cGUuQlVZOgogICAgICAgICAgICAgICAgYnV5X3Njb3JlICs9IHNpZ25hbC5zdHJlbmd0aCAqIHdlaWdodAogICAgICAgICAgICBlbGlmIHNpZ25hbC5zaWduYWxfdHlwZSA9PSBTaWduYWxUeXBlLlNFTEw6CiAgICAgICAgICAgICAgICBzZWxsX3Njb3JlICs9IHNpZ25hbC5zdHJlbmd0aCAqIHdlaWdodAogICAgICAgICAgICB0b3RhbF93ZWlnaHQgKz0gd2VpZ2h0CiAgICAgICAgCiAgICAgICAgaWYgdG90YWxfd2VpZ2h0ID09IDA6CiAgICAgICAgICAgIHJldHVybiBOb25lCiAgICAgICAgCiAgICAgICAgIyBEZXRlcm1pbmUgY29tYmluZWQgc2lnbmFsCiAgICAgICAgYnV5X3Njb3JlIC89IHRvdGFsX3dlaWdodAogICAgICAgIHNlbGxfc2NvcmUgLz0gdG90YWxfd2VpZ2h0CiAgICAgICAgCiAgICAgICAgaWYgYnV5X3Njb3JlID4gc2VsbF9zY29yZSBhbmQgYnV5X3Njb3JlID4gMC41OgogICAgICAgICAgICAjIFVzZSBhdmVyYWdlIG9mIGJ1eSBzaWduYWxzIGZvciBzdG9wcwogICAgICAgICAgICBidXlfc2lnbmFscyA9IFtzIGZvciBzIGluIHNpZ25hbHMgaWYgcy5zaWduYWxfdHlwZSA9PSBTaWduYWxUeXBlLkJVWV0KICAgICAgICAgICAgYXZnX3N0b3AgPSBzdW0ocy5zdG9wX2xvc3MgZm9yIHMgaW4gYnV5X3NpZ25hbHMgaWYgcy5zdG9wX2xvc3MpIC8gbGVuKGJ1eV9zaWduYWxzKQogICAgICAgICAgICBhdmdfdHAgPSBzdW0ocy50YWtlX3Byb2ZpdCBmb3IgcyBpbiBidXlfc2lnbmFscyBpZiBzLnRha2VfcHJvZml0KSAvIGxlbihidXlfc2lnbmFscykKICAgICAgICAgICAgCiAgICAgICAgICAgIHJldHVybiBTaWduYWwoCiAgICAgICAgICAgICAgICBzeW1ib2w9c3ltYm9sLAogICAgICAgICAgICAgICAgc2lnbmFsX3R5cGU9U2lnbmFsVHlwZS5CVVksCiAgICAgICAgICAgICAgICBzdHJlbmd0aD1idXlfc2NvcmUsCiAgICAgICAgICAgICAgICBwcmljZT1zaWduYWxzWzBdLnByaWNlLAogICAgICAgICAgICAgICAgc3RvcF9sb3NzPWF2Z19zdG9wLAogICAgICAgICAgICAgICAgdGFrZV9wcm9maXQ9YXZnX3RwLAogICAgICAgICAgICAgICAgbWV0YWRhdGE9eydjb21iaW5lZCc6IFRydWUsICdzdHJhdGVnaWVzJzogW3MubWV0YWRhdGEuZ2V0KCdzdHJhdGVneScpIGZvciBzIGluIGJ1eV9zaWduYWxzXX0KICAgICAgICAgICAgKQogICAgICAgIGVsaWYgc2VsbF9zY29yZSA+IGJ1eV9zY29yZSBhbmQgc2VsbF9zY29yZSA+IDAuNToKICAgICAgICAgICAgc2VsbF9zaWduYWxzID0gW3MgZm9yIHMgaW4gc2lnbmFscyBpZiBzLnNpZ25hbF90eXBlID09IFNpZ25hbFR5cGUuU0VMTF0KICAgICAgICAgICAgYXZnX3N0b3AgPSBzdW0ocy5zdG9wX2xvc3MgZm9yIHMgaW4gc2VsbF9zaWduYWxzIGlmIHMuc3RvcF9sb3NzKSAvIGxlbihzZWxsX3NpZ25hbHMpCiAgICAgICAgICAgIGF2Z190cCA9IHN1bShzLnRha2VfcHJvZml0IGZvciBzIGluIHNlbGxfc2lnbmFscyBpZiBzLnRha2VfcHJvZml0KSAvIGxlbihzZWxsX3NpZ25hbHMpCiAgICAgICAgICAgIAogICAgICAgICAgICByZXR1cm4gU2lnbmFsKAogICAgICAgICAgICAgICAgc3ltYm9sPXN5bWJvbCwKICAgICAgICAgICAgICAgIHNpZ25hbF90eXBlPVNpZ25hbFR5cGUuU0VMTCwKICAgICAgICAgICAgICAgIHN0cmVuZ3RoPXNlbGxfc2NvcmUsCiAgICAgICAgICAgICAgICBwcmljZT1zaWduYWxzWzBdLnByaWNlLAogICAgICAgICAgICAgICAgc3RvcF9sb3NzPWF2Z19zdG9wLAogICAgICAgICAgICAgICAgdGFrZV9wcm9maXQ9YXZnX3RwLAogICAgICAgICAgICAgICAgbWV0YWRhdGE9eydjb21iaW5lZCc6IFRydWUsICdzdHJhdGVnaWVzJzogW3MubWV0YWRhdGEuZ2V0KCdzdHJhdGVneScpIGZvciBzIGluIHNlbGxfc2lnbmFsc119CiAgICAgICAgICAgICkKICAgICAgICAKICAgICAgICByZXR1cm4gTm9uZQ=="><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-16-8')" type="button">Run</button></div><pre><code><span class="c1"># strategies/strategy_manager.py</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Optional</span>

<span class="k">class</span> <span class="nc">StrategyManager</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Manage multiple strategies and combine signals.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">strategies</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">BaseStrategy</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="k">def</span> <span class="nf">add_strategy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">strategy</span><span class="p">:</span> <span class="n">BaseStrategy</span><span class="p">,</span> <span class="n">weight</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">strategies</span><span class="p">[</span><span class="n">strategy</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">strategy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">[</span><span class="n">strategy</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">weight</span>
    
    <span class="k">def</span> <span class="nf">get_signals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Signal</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Get signals from all strategies.&quot;&quot;&quot;</span>
        <span class="n">signals</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">strategy</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">strategies</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">signal</span> <span class="o">=</span> <span class="n">strategy</span><span class="o">.</span><span class="n">generate_signal</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">symbol</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">signal</span><span class="p">:</span>
                <span class="n">signal</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;weight&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
                <span class="n">signals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">signal</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">signals</span>
    
    <span class="k">def</span> <span class="nf">get_combined_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Signal</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Combine signals from all strategies.&quot;&quot;&quot;</span>
        <span class="n">signals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_signals</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">symbol</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">signals</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        
        <span class="c1"># Weight signals</span>
        <span class="n">buy_score</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">sell_score</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">total_weight</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="k">for</span> <span class="n">signal</span> <span class="ow">in</span> <span class="n">signals</span><span class="p">:</span>
            <span class="n">weight</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;weight&#39;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">signal</span><span class="o">.</span><span class="n">signal_type</span> <span class="o">==</span> <span class="n">SignalType</span><span class="o">.</span><span class="n">BUY</span><span class="p">:</span>
                <span class="n">buy_score</span> <span class="o">+=</span> <span class="n">signal</span><span class="o">.</span><span class="n">strength</span> <span class="o">*</span> <span class="n">weight</span>
            <span class="k">elif</span> <span class="n">signal</span><span class="o">.</span><span class="n">signal_type</span> <span class="o">==</span> <span class="n">SignalType</span><span class="o">.</span><span class="n">SELL</span><span class="p">:</span>
                <span class="n">sell_score</span> <span class="o">+=</span> <span class="n">signal</span><span class="o">.</span><span class="n">strength</span> <span class="o">*</span> <span class="n">weight</span>
            <span class="n">total_weight</span> <span class="o">+=</span> <span class="n">weight</span>
        
        <span class="k">if</span> <span class="n">total_weight</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        
        <span class="c1"># Determine combined signal</span>
        <span class="n">buy_score</span> <span class="o">/=</span> <span class="n">total_weight</span>
        <span class="n">sell_score</span> <span class="o">/=</span> <span class="n">total_weight</span>
        
        <span class="k">if</span> <span class="n">buy_score</span> <span class="o">&gt;</span> <span class="n">sell_score</span> <span class="ow">and</span> <span class="n">buy_score</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">:</span>
            <span class="c1"># Use average of buy signals for stops</span>
            <span class="n">buy_signals</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">signals</span> <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">signal_type</span> <span class="o">==</span> <span class="n">SignalType</span><span class="o">.</span><span class="n">BUY</span><span class="p">]</span>
            <span class="n">avg_stop</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">stop_loss</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">buy_signals</span> <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">stop_loss</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">buy_signals</span><span class="p">)</span>
            <span class="n">avg_tp</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">take_profit</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">buy_signals</span> <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">take_profit</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">buy_signals</span><span class="p">)</span>
            
            <span class="k">return</span> <span class="n">Signal</span><span class="p">(</span>
                <span class="n">symbol</span><span class="o">=</span><span class="n">symbol</span><span class="p">,</span>
                <span class="n">signal_type</span><span class="o">=</span><span class="n">SignalType</span><span class="o">.</span><span class="n">BUY</span><span class="p">,</span>
                <span class="n">strength</span><span class="o">=</span><span class="n">buy_score</span><span class="p">,</span>
                <span class="n">price</span><span class="o">=</span><span class="n">signals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">price</span><span class="p">,</span>
                <span class="n">stop_loss</span><span class="o">=</span><span class="n">avg_stop</span><span class="p">,</span>
                <span class="n">take_profit</span><span class="o">=</span><span class="n">avg_tp</span><span class="p">,</span>
                <span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;combined&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;strategies&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;strategy&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">buy_signals</span><span class="p">]}</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">sell_score</span> <span class="o">&gt;</span> <span class="n">buy_score</span> <span class="ow">and</span> <span class="n">sell_score</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">:</span>
            <span class="n">sell_signals</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">signals</span> <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">signal_type</span> <span class="o">==</span> <span class="n">SignalType</span><span class="o">.</span><span class="n">SELL</span><span class="p">]</span>
            <span class="n">avg_stop</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">stop_loss</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sell_signals</span> <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">stop_loss</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">sell_signals</span><span class="p">)</span>
            <span class="n">avg_tp</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">take_profit</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sell_signals</span> <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">take_profit</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">sell_signals</span><span class="p">)</span>
            
            <span class="k">return</span> <span class="n">Signal</span><span class="p">(</span>
                <span class="n">symbol</span><span class="o">=</span><span class="n">symbol</span><span class="p">,</span>
                <span class="n">signal_type</span><span class="o">=</span><span class="n">SignalType</span><span class="o">.</span><span class="n">SELL</span><span class="p">,</span>
                <span class="n">strength</span><span class="o">=</span><span class="n">sell_score</span><span class="p">,</span>
                <span class="n">price</span><span class="o">=</span><span class="n">signals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">price</span><span class="p">,</span>
                <span class="n">stop_loss</span><span class="o">=</span><span class="n">avg_stop</span><span class="p">,</span>
                <span class="n">take_profit</span><span class="o">=</span><span class="n">avg_tp</span><span class="p">,</span>
                <span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;combined&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;strategies&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;strategy&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sell_signals</span><span class="p">]}</span>
            <span class="p">)</span>
        
        <span class="k">return</span> <span class="kc">None</span>
</code></pre><div class="code-output" id="output-cell-16-8"></div></div>
<div class="md-cell"><hr />
<h1>Part 4: Execution Engine</h1>
<h2>4.1 Order Manager</h2></div>
<div class="code-cell" id="cell-16-9" data-source="IyBleGVjdXRpb24vb3JkZXJfbWFuYWdlci5weQpmcm9tIGRhdGFjbGFzc2VzIGltcG9ydCBkYXRhY2xhc3MKZnJvbSB0eXBpbmcgaW1wb3J0IERpY3QsIExpc3QsIE9wdGlvbmFsCmZyb20gZGF0ZXRpbWUgaW1wb3J0IGRhdGV0aW1lCmZyb20gZW51bSBpbXBvcnQgRW51bQoKY2xhc3MgT3JkZXJTdGF0dXMoRW51bSk6CiAgICBQRU5ESU5HID0gJ3BlbmRpbmcnCiAgICBPUEVOID0gJ29wZW4nCiAgICBGSUxMRUQgPSAnZmlsbGVkJwogICAgQ0FOQ0VMTEVEID0gJ2NhbmNlbGxlZCcKICAgIEZBSUxFRCA9ICdmYWlsZWQnCgpAZGF0YWNsYXNzCmNsYXNzIE9yZGVyOgogICAgaWQ6IHN0cgogICAgc3ltYm9sOiBzdHIKICAgIHNpZGU6IHN0cgogICAgb3JkZXJfdHlwZTogc3RyCiAgICBhbW91bnQ6IGZsb2F0CiAgICBwcmljZTogT3B0aW9uYWxbZmxvYXRdCiAgICBzdGF0dXM6IE9yZGVyU3RhdHVzCiAgICBjcmVhdGVkX2F0OiBkYXRldGltZQogICAgZmlsbGVkX2F0OiBPcHRpb25hbFtkYXRldGltZV0gPSBOb25lCiAgICBmaWxsZWRfcHJpY2U6IE9wdGlvbmFsW2Zsb2F0XSA9IE5vbmUKICAgIGV4Y2hhbmdlOiBzdHIgPSAnYmluYW5jZScKCmNsYXNzIE9yZGVyTWFuYWdlcjoKICAgICIiIk1hbmFnZSBvcmRlciBsaWZlY3ljbGUuIiIiCiAgICAKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBleGNoYW5nZSwgbG9nZ2VyKToKICAgICAgICBzZWxmLmV4Y2hhbmdlID0gZXhjaGFuZ2UKICAgICAgICBzZWxmLmxvZ2dlciA9IGxvZ2dlcgogICAgICAgIHNlbGYub3JkZXJzOiBEaWN0W3N0ciwgT3JkZXJdID0ge30KICAgICAgICBzZWxmLnBlbmRpbmdfb3JkZXJzOiBMaXN0W3N0cl0gPSBbXQogICAgCiAgICBkZWYgY3JlYXRlX21hcmtldF9vcmRlcihzZWxmLCBzeW1ib2w6IHN0ciwgc2lkZTogc3RyLCBhbW91bnQ6IGZsb2F0KSAtPiBPcmRlcjoKICAgICAgICAiIiJDcmVhdGUgYW5kIHN1Ym1pdCBtYXJrZXQgb3JkZXIuIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICByZXN1bHQgPSBzZWxmLmV4Y2hhbmdlLmNyZWF0ZV9tYXJrZXRfb3JkZXIoc3ltYm9sLCBzaWRlLCBhbW91bnQpCiAgICAgICAgICAgIAogICAgICAgICAgICBvcmRlciA9IE9yZGVyKAogICAgICAgICAgICAgICAgaWQ9cmVzdWx0WydpZCddLAogICAgICAgICAgICAgICAgc3ltYm9sPXN5bWJvbCwKICAgICAgICAgICAgICAgIHNpZGU9c2lkZSwKICAgICAgICAgICAgICAgIG9yZGVyX3R5cGU9J21hcmtldCcsCiAgICAgICAgICAgICAgICBhbW91bnQ9YW1vdW50LAogICAgICAgICAgICAgICAgcHJpY2U9Tm9uZSwKICAgICAgICAgICAgICAgIHN0YXR1cz1PcmRlclN0YXR1cy5GSUxMRUQsCiAgICAgICAgICAgICAgICBjcmVhdGVkX2F0PWRhdGV0aW1lLm5vdygpLAogICAgICAgICAgICAgICAgZmlsbGVkX2F0PWRhdGV0aW1lLm5vdygpLAogICAgICAgICAgICAgICAgZmlsbGVkX3ByaWNlPXJlc3VsdC5nZXQoJ2F2ZXJhZ2UnLCByZXN1bHQuZ2V0KCdwcmljZScpKQogICAgICAgICAgICApCiAgICAgICAgICAgIAogICAgICAgICAgICBzZWxmLm9yZGVyc1tvcmRlci5pZF0gPSBvcmRlcgogICAgICAgICAgICBzZWxmLmxvZ2dlci5sb2dfdHJhZGUoewogICAgICAgICAgICAgICAgJ29yZGVyX2lkJzogb3JkZXIuaWQsCiAgICAgICAgICAgICAgICAnc3ltYm9sJzogc3ltYm9sLAogICAgICAgICAgICAgICAgJ3NpZGUnOiBzaWRlLAogICAgICAgICAgICAgICAgJ2Ftb3VudCc6IGFtb3VudCwKICAgICAgICAgICAgICAgICdwcmljZSc6IG9yZGVyLmZpbGxlZF9wcmljZQogICAgICAgICAgICB9KQogICAgICAgICAgICAKICAgICAgICAgICAgcmV0dXJuIG9yZGVyCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBzZWxmLmxvZ2dlci5sb2dfZXJyb3IoZidPcmRlciBmYWlsZWQ6IHtlfScsIHsnc3ltYm9sJzogc3ltYm9sLCAnc2lkZSc6IHNpZGV9KQogICAgICAgICAgICByYWlzZQogICAgCiAgICBkZWYgY3JlYXRlX2xpbWl0X29yZGVyKHNlbGYsIHN5bWJvbDogc3RyLCBzaWRlOiBzdHIsIGFtb3VudDogZmxvYXQsIHByaWNlOiBmbG9hdCkgLT4gT3JkZXI6CiAgICAgICAgIiIiQ3JlYXRlIGxpbWl0IG9yZGVyLiIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgcmVzdWx0ID0gc2VsZi5leGNoYW5nZS5jcmVhdGVfbGltaXRfb3JkZXIoc3ltYm9sLCBzaWRlLCBhbW91bnQsIHByaWNlKQogICAgICAgICAgICAKICAgICAgICAgICAgb3JkZXIgPSBPcmRlcigKICAgICAgICAgICAgICAgIGlkPXJlc3VsdFsnaWQnXSwKICAgICAgICAgICAgICAgIHN5bWJvbD1zeW1ib2wsCiAgICAgICAgICAgICAgICBzaWRlPXNpZGUsCiAgICAgICAgICAgICAgICBvcmRlcl90eXBlPSdsaW1pdCcsCiAgICAgICAgICAgICAgICBhbW91bnQ9YW1vdW50LAogICAgICAgICAgICAgICAgcHJpY2U9cHJpY2UsCiAgICAgICAgICAgICAgICBzdGF0dXM9T3JkZXJTdGF0dXMuT1BFTiwKICAgICAgICAgICAgICAgIGNyZWF0ZWRfYXQ9ZGF0ZXRpbWUubm93KCkKICAgICAgICAgICAgKQogICAgICAgICAgICAKICAgICAgICAgICAgc2VsZi5vcmRlcnNbb3JkZXIuaWRdID0gb3JkZXIKICAgICAgICAgICAgc2VsZi5wZW5kaW5nX29yZGVycy5hcHBlbmQob3JkZXIuaWQpCiAgICAgICAgICAgIAogICAgICAgICAgICByZXR1cm4gb3JkZXIKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHNlbGYubG9nZ2VyLmxvZ19lcnJvcihmJ0xpbWl0IG9yZGVyIGZhaWxlZDoge2V9JywgeydzeW1ib2wnOiBzeW1ib2x9KQogICAgICAgICAgICByYWlzZQogICAgCiAgICBkZWYgY2FuY2VsX29yZGVyKHNlbGYsIG9yZGVyX2lkOiBzdHIsIHN5bWJvbDogc3RyKSAtPiBib29sOgogICAgICAgICIiIkNhbmNlbCBhbiBvcGVuIG9yZGVyLiIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgc2VsZi5leGNoYW5nZS5jYW5jZWxfb3JkZXIob3JkZXJfaWQsIHN5bWJvbCkKICAgICAgICAgICAgaWYgb3JkZXJfaWQgaW4gc2VsZi5vcmRlcnM6CiAgICAgICAgICAgICAgICBzZWxmLm9yZGVyc1tvcmRlcl9pZF0uc3RhdHVzID0gT3JkZXJTdGF0dXMuQ0FOQ0VMTEVECiAgICAgICAgICAgIGlmIG9yZGVyX2lkIGluIHNlbGYucGVuZGluZ19vcmRlcnM6CiAgICAgICAgICAgICAgICBzZWxmLnBlbmRpbmdfb3JkZXJzLnJlbW92ZShvcmRlcl9pZCkKICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHNlbGYubG9nZ2VyLmxvZ19lcnJvcihmJ0NhbmNlbCBmYWlsZWQ6IHtlfScsIHsnb3JkZXJfaWQnOiBvcmRlcl9pZH0pCiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgCiAgICBkZWYgdXBkYXRlX29yZGVyX3N0YXR1cyhzZWxmLCBvcmRlcl9pZDogc3RyLCBzeW1ib2w6IHN0cik6CiAgICAgICAgIiIiVXBkYXRlIHN0YXR1cyBvZiBwZW5kaW5nIG9yZGVyLiIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgcmVzdWx0ID0gc2VsZi5leGNoYW5nZS5mZXRjaF9vcmRlcihvcmRlcl9pZCwgc3ltYm9sKQogICAgICAgICAgICBpZiBvcmRlcl9pZCBpbiBzZWxmLm9yZGVyczoKICAgICAgICAgICAgICAgIGlmIHJlc3VsdFsnc3RhdHVzJ10gPT0gJ2Nsb3NlZCc6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5vcmRlcnNbb3JkZXJfaWRdLnN0YXR1cyA9IE9yZGVyU3RhdHVzLkZJTExFRAogICAgICAgICAgICAgICAgICAgIHNlbGYub3JkZXJzW29yZGVyX2lkXS5maWxsZWRfYXQgPSBkYXRldGltZS5ub3coKQogICAgICAgICAgICAgICAgICAgIHNlbGYub3JkZXJzW29yZGVyX2lkXS5maWxsZWRfcHJpY2UgPSByZXN1bHQuZ2V0KCdhdmVyYWdlJykKICAgICAgICAgICAgICAgICAgICBpZiBvcmRlcl9pZCBpbiBzZWxmLnBlbmRpbmdfb3JkZXJzOgogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLnBlbmRpbmdfb3JkZXJzLnJlbW92ZShvcmRlcl9pZCkKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHNlbGYubG9nZ2VyLmxvZ19lcnJvcihmJ1N0YXR1cyB1cGRhdGUgZmFpbGVkOiB7ZX0nLCB7J29yZGVyX2lkJzogb3JkZXJfaWR9KQ=="><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-16-9')" type="button">Run</button></div><pre><code><span class="c1"># execution/order_manager.py</span>
<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">enum</span> <span class="kn">import</span> <span class="n">Enum</span>

<span class="k">class</span> <span class="nc">OrderStatus</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
    <span class="n">PENDING</span> <span class="o">=</span> <span class="s1">&#39;pending&#39;</span>
    <span class="n">OPEN</span> <span class="o">=</span> <span class="s1">&#39;open&#39;</span>
    <span class="n">FILLED</span> <span class="o">=</span> <span class="s1">&#39;filled&#39;</span>
    <span class="n">CANCELLED</span> <span class="o">=</span> <span class="s1">&#39;cancelled&#39;</span>
    <span class="n">FAILED</span> <span class="o">=</span> <span class="s1">&#39;failed&#39;</span>

<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">Order</span><span class="p">:</span>
    <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">side</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">order_type</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">amount</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">price</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span>
    <span class="n">status</span><span class="p">:</span> <span class="n">OrderStatus</span>
    <span class="n">created_at</span><span class="p">:</span> <span class="n">datetime</span>
    <span class="n">filled_at</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">datetime</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">filled_price</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">exchange</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;binance&#39;</span>

<span class="k">class</span> <span class="nc">OrderManager</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Manage order lifecycle.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exchange</span><span class="p">,</span> <span class="n">logger</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span> <span class="o">=</span> <span class="n">exchange</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logger</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">orders</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Order</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pending_orders</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">def</span> <span class="nf">create_market_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">side</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">amount</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Order</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Create and submit market order.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="o">.</span><span class="n">create_market_order</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">side</span><span class="p">,</span> <span class="n">amount</span><span class="p">)</span>
            
            <span class="n">order</span> <span class="o">=</span> <span class="n">Order</span><span class="p">(</span>
                <span class="nb">id</span><span class="o">=</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span>
                <span class="n">symbol</span><span class="o">=</span><span class="n">symbol</span><span class="p">,</span>
                <span class="n">side</span><span class="o">=</span><span class="n">side</span><span class="p">,</span>
                <span class="n">order_type</span><span class="o">=</span><span class="s1">&#39;market&#39;</span><span class="p">,</span>
                <span class="n">amount</span><span class="o">=</span><span class="n">amount</span><span class="p">,</span>
                <span class="n">price</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">status</span><span class="o">=</span><span class="n">OrderStatus</span><span class="o">.</span><span class="n">FILLED</span><span class="p">,</span>
                <span class="n">created_at</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
                <span class="n">filled_at</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
                <span class="n">filled_price</span><span class="o">=</span><span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;average&#39;</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;price&#39;</span><span class="p">))</span>
            <span class="p">)</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">orders</span><span class="p">[</span><span class="n">order</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">order</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log_trade</span><span class="p">({</span>
                <span class="s1">&#39;order_id&#39;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span>
                <span class="s1">&#39;side&#39;</span><span class="p">:</span> <span class="n">side</span><span class="p">,</span>
                <span class="s1">&#39;amount&#39;</span><span class="p">:</span> <span class="n">amount</span><span class="p">,</span>
                <span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">filled_price</span>
            <span class="p">})</span>
            
            <span class="k">return</span> <span class="n">order</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log_error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Order failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span> <span class="s1">&#39;side&#39;</span><span class="p">:</span> <span class="n">side</span><span class="p">})</span>
            <span class="k">raise</span>
    
    <span class="k">def</span> <span class="nf">create_limit_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">side</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">amount</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">price</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Order</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Create limit order.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="o">.</span><span class="n">create_limit_order</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">side</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">price</span><span class="p">)</span>
            
            <span class="n">order</span> <span class="o">=</span> <span class="n">Order</span><span class="p">(</span>
                <span class="nb">id</span><span class="o">=</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span>
                <span class="n">symbol</span><span class="o">=</span><span class="n">symbol</span><span class="p">,</span>
                <span class="n">side</span><span class="o">=</span><span class="n">side</span><span class="p">,</span>
                <span class="n">order_type</span><span class="o">=</span><span class="s1">&#39;limit&#39;</span><span class="p">,</span>
                <span class="n">amount</span><span class="o">=</span><span class="n">amount</span><span class="p">,</span>
                <span class="n">price</span><span class="o">=</span><span class="n">price</span><span class="p">,</span>
                <span class="n">status</span><span class="o">=</span><span class="n">OrderStatus</span><span class="o">.</span><span class="n">OPEN</span><span class="p">,</span>
                <span class="n">created_at</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
            <span class="p">)</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">orders</span><span class="p">[</span><span class="n">order</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">order</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pending_orders</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">order</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
            
            <span class="k">return</span> <span class="n">order</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log_error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Limit order failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">})</span>
            <span class="k">raise</span>
    
    <span class="k">def</span> <span class="nf">cancel_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Cancel an open order.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="o">.</span><span class="n">cancel_order</span><span class="p">(</span><span class="n">order_id</span><span class="p">,</span> <span class="n">symbol</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">order_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">orders</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">orders</span><span class="p">[</span><span class="n">order_id</span><span class="p">]</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">OrderStatus</span><span class="o">.</span><span class="n">CANCELLED</span>
            <span class="k">if</span> <span class="n">order_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pending_orders</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pending_orders</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">order_id</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log_error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Cancel failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;order_id&#39;</span><span class="p">:</span> <span class="n">order_id</span><span class="p">})</span>
            <span class="k">return</span> <span class="kc">False</span>
    
    <span class="k">def</span> <span class="nf">update_order_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update status of pending order.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="o">.</span><span class="n">fetch_order</span><span class="p">(</span><span class="n">order_id</span><span class="p">,</span> <span class="n">symbol</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">order_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">orders</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;closed&#39;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">orders</span><span class="p">[</span><span class="n">order_id</span><span class="p">]</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">OrderStatus</span><span class="o">.</span><span class="n">FILLED</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">orders</span><span class="p">[</span><span class="n">order_id</span><span class="p">]</span><span class="o">.</span><span class="n">filled_at</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">orders</span><span class="p">[</span><span class="n">order_id</span><span class="p">]</span><span class="o">.</span><span class="n">filled_price</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;average&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">order_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pending_orders</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">pending_orders</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">order_id</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log_error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Status update failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;order_id&#39;</span><span class="p">:</span> <span class="n">order_id</span><span class="p">})</span>
</code></pre><div class="code-output" id="output-cell-16-9"></div></div>
<div class="md-cell"><hr />
<h1>Part 5: Risk Management</h1>
<h2>5.1 Position Sizer</h2></div>
<div class="code-cell" id="cell-16-10" data-source="IyByaXNrL3Bvc2l0aW9uX3NpemVyLnB5CmZyb20gdHlwaW5nIGltcG9ydCBEaWN0CgpjbGFzcyBQb3NpdGlvblNpemVyOgogICAgIiIiQ2FsY3VsYXRlIHBvc2l0aW9uIHNpemVzIGJhc2VkIG9uIHJpc2sgcGFyYW1ldGVycy4iIiIKICAgIAogICAgZGVmIF9faW5pdF9fKHNlbGYsIGNvbmZpZyk6CiAgICAgICAgc2VsZi5tYXhfcG9zaXRpb25fcGN0ID0gY29uZmlnLm1heF9wb3NpdGlvbl9wY3QKICAgICAgICBzZWxmLm1heF9yaXNrX3Blcl90cmFkZSA9IDAuMDIgICMgMiUgcmlzayBwZXIgdHJhZGUKICAgIAogICAgZGVmIGNhbGN1bGF0ZV9wb3NpdGlvbl9zaXplKHNlbGYsIGNhcGl0YWw6IGZsb2F0LCBlbnRyeV9wcmljZTogZmxvYXQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdG9wX2xvc3M6IGZsb2F0LCBzaWduYWxfc3RyZW5ndGg6IGZsb2F0ID0gMS4wKSAtPiBEaWN0OgogICAgICAgICIiIgogICAgICAgIENhbGN1bGF0ZSBwb3NpdGlvbiBzaXplIGJhc2VkIG9uIHJpc2suCiAgICAgICAgCiAgICAgICAgVXNlcyB0aGUgZm9ybXVsYTogUG9zaXRpb24gPSAoQ2FwaXRhbCAqIFJpc2slKSAvIChFbnRyeSAtIFN0b3ApCiAgICAgICAgIiIiCiAgICAgICAgIyBSaXNrIGFtb3VudAogICAgICAgIHJpc2tfYW1vdW50ID0gY2FwaXRhbCAqIHNlbGYubWF4X3Jpc2tfcGVyX3RyYWRlICogc2lnbmFsX3N0cmVuZ3RoCiAgICAgICAgCiAgICAgICAgIyBEaXN0YW5jZSB0byBzdG9wCiAgICAgICAgc3RvcF9kaXN0YW5jZSA9IGFicyhlbnRyeV9wcmljZSAtIHN0b3BfbG9zcykKICAgICAgICBzdG9wX3BjdCA9IHN0b3BfZGlzdGFuY2UgLyBlbnRyeV9wcmljZQogICAgICAgIAogICAgICAgIGlmIHN0b3BfZGlzdGFuY2UgPT0gMDoKICAgICAgICAgICAgcmV0dXJuIHsnZXJyb3InOiAnSW52YWxpZCBzdG9wIGxvc3MnfQogICAgICAgIAogICAgICAgICMgUG9zaXRpb24gc2l6ZSBpbiB1bml0cwogICAgICAgIHBvc2l0aW9uX3VuaXRzID0gcmlza19hbW91bnQgLyBzdG9wX2Rpc3RhbmNlCiAgICAgICAgcG9zaXRpb25fdmFsdWUgPSBwb3NpdGlvbl91bml0cyAqIGVudHJ5X3ByaWNlCiAgICAgICAgCiAgICAgICAgIyBBcHBseSBtYXhpbXVtIHBvc2l0aW9uIGxpbWl0CiAgICAgICAgbWF4X3Bvc2l0aW9uID0gY2FwaXRhbCAqIHNlbGYubWF4X3Bvc2l0aW9uX3BjdAogICAgICAgIGlmIHBvc2l0aW9uX3ZhbHVlID4gbWF4X3Bvc2l0aW9uOgogICAgICAgICAgICBwb3NpdGlvbl92YWx1ZSA9IG1heF9wb3NpdGlvbgogICAgICAgICAgICBwb3NpdGlvbl91bml0cyA9IHBvc2l0aW9uX3ZhbHVlIC8gZW50cnlfcHJpY2UKICAgICAgICAKICAgICAgICByZXR1cm4gewogICAgICAgICAgICAndW5pdHMnOiBwb3NpdGlvbl91bml0cywKICAgICAgICAgICAgJ3ZhbHVlJzogcG9zaXRpb25fdmFsdWUsCiAgICAgICAgICAgICdyaXNrX2Ftb3VudCc6IG1pbihyaXNrX2Ftb3VudCwgcG9zaXRpb25fdmFsdWUgKiBzdG9wX3BjdCksCiAgICAgICAgICAgICdyaXNrX3BjdCc6IG1pbihzZWxmLm1heF9yaXNrX3Blcl90cmFkZSwgcG9zaXRpb25fdmFsdWUgKiBzdG9wX3BjdCAvIGNhcGl0YWwpICogMTAwLAogICAgICAgICAgICAncG9zaXRpb25fcGN0JzogcG9zaXRpb25fdmFsdWUgLyBjYXBpdGFsICogMTAwCiAgICAgICAgfQ=="><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-16-10')" type="button">Run</button></div><pre><code><span class="c1"># risk/position_sizer.py</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span>

<span class="k">class</span> <span class="nc">PositionSizer</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Calculate position sizes based on risk parameters.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_position_pct</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">max_position_pct</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_risk_per_trade</span> <span class="o">=</span> <span class="mf">0.02</span>  <span class="c1"># 2% risk per trade</span>
    
    <span class="k">def</span> <span class="nf">calculate_position_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">capital</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">entry_price</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                                  <span class="n">stop_loss</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">signal_strength</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate position size based on risk.</span>
<span class="sd">        </span>
<span class="sd">        Uses the formula: Position = (Capital * Risk%) / (Entry - Stop)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Risk amount</span>
        <span class="n">risk_amount</span> <span class="o">=</span> <span class="n">capital</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_risk_per_trade</span> <span class="o">*</span> <span class="n">signal_strength</span>
        
        <span class="c1"># Distance to stop</span>
        <span class="n">stop_distance</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">entry_price</span> <span class="o">-</span> <span class="n">stop_loss</span><span class="p">)</span>
        <span class="n">stop_pct</span> <span class="o">=</span> <span class="n">stop_distance</span> <span class="o">/</span> <span class="n">entry_price</span>
        
        <span class="k">if</span> <span class="n">stop_distance</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Invalid stop loss&#39;</span><span class="p">}</span>
        
        <span class="c1"># Position size in units</span>
        <span class="n">position_units</span> <span class="o">=</span> <span class="n">risk_amount</span> <span class="o">/</span> <span class="n">stop_distance</span>
        <span class="n">position_value</span> <span class="o">=</span> <span class="n">position_units</span> <span class="o">*</span> <span class="n">entry_price</span>
        
        <span class="c1"># Apply maximum position limit</span>
        <span class="n">max_position</span> <span class="o">=</span> <span class="n">capital</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_position_pct</span>
        <span class="k">if</span> <span class="n">position_value</span> <span class="o">&gt;</span> <span class="n">max_position</span><span class="p">:</span>
            <span class="n">position_value</span> <span class="o">=</span> <span class="n">max_position</span>
            <span class="n">position_units</span> <span class="o">=</span> <span class="n">position_value</span> <span class="o">/</span> <span class="n">entry_price</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="n">position_units</span><span class="p">,</span>
            <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">position_value</span><span class="p">,</span>
            <span class="s1">&#39;risk_amount&#39;</span><span class="p">:</span> <span class="nb">min</span><span class="p">(</span><span class="n">risk_amount</span><span class="p">,</span> <span class="n">position_value</span> <span class="o">*</span> <span class="n">stop_pct</span><span class="p">),</span>
            <span class="s1">&#39;risk_pct&#39;</span><span class="p">:</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_risk_per_trade</span><span class="p">,</span> <span class="n">position_value</span> <span class="o">*</span> <span class="n">stop_pct</span> <span class="o">/</span> <span class="n">capital</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
            <span class="s1">&#39;position_pct&#39;</span><span class="p">:</span> <span class="n">position_value</span> <span class="o">/</span> <span class="n">capital</span> <span class="o">*</span> <span class="mi">100</span>
        <span class="p">}</span>
</code></pre><div class="code-output" id="output-cell-16-10"></div></div>
<div class="md-cell"><h2>5.2 Risk Manager</h2></div>
<div class="code-cell" id="cell-16-11" data-source="IyByaXNrL3Jpc2tfbWFuYWdlci5weQpmcm9tIHR5cGluZyBpbXBvcnQgRGljdCwgTGlzdCwgT3B0aW9uYWwKZnJvbSBkYXRldGltZSBpbXBvcnQgZGF0ZXRpbWUsIHRpbWVkZWx0YQoKY2xhc3MgUmlza01hbmFnZXI6CiAgICAiIiJDZW50cmFsIHJpc2sgbWFuYWdlbWVudC4iIiIKICAgIAogICAgZGVmIF9faW5pdF9fKHNlbGYsIGNvbmZpZywgbG9nZ2VyKToKICAgICAgICBzZWxmLmNvbmZpZyA9IGNvbmZpZwogICAgICAgIHNlbGYubG9nZ2VyID0gbG9nZ2VyCiAgICAgICAgc2VsZi5kYWlseV9wbmwgPSAwCiAgICAgICAgc2VsZi5kYWlseV90cmFkZXMgPSAwCiAgICAgICAgc2VsZi5sYXN0X3Jlc2V0ID0gZGF0ZXRpbWUubm93KCkuZGF0ZSgpCiAgICAgICAgc2VsZi5wb3NpdGlvbl90cmFja2VyOiBEaWN0W3N0ciwgRGljdF0gPSB7fQogICAgCiAgICBkZWYgY2FuX3RyYWRlKHNlbGYsIHNpZ25hbCwgY3VycmVudF9wb3NpdGlvbnM6IERpY3QpIC0+IERpY3Q6CiAgICAgICAgIiIiQ2hlY2sgaWYgdHJhZGUgaXMgYWxsb3dlZCBiYXNlZCBvbiByaXNrIHJ1bGVzLiIiIgogICAgICAgIHNlbGYuX2NoZWNrX2RhaWx5X3Jlc2V0KCkKICAgICAgICAKICAgICAgICBjaGVja3MgPSB7CiAgICAgICAgICAgICdhbGxvd2VkJzogVHJ1ZSwKICAgICAgICAgICAgJ3JlYXNvbnMnOiBbXQogICAgICAgIH0KICAgICAgICAKICAgICAgICAjIENoZWNrIGRhaWx5IGxvc3MgbGltaXQKICAgICAgICBpZiBzZWxmLmRhaWx5X3BubCA8PSAtc2VsZi5jb25maWcubWF4X2RhaWx5X2xvc3M6CiAgICAgICAgICAgIGNoZWNrc1snYWxsb3dlZCddID0gRmFsc2UKICAgICAgICAgICAgY2hlY2tzWydyZWFzb25zJ10uYXBwZW5kKGYnRGFpbHkgbG9zcyBsaW1pdCByZWFjaGVkOiAke3NlbGYuZGFpbHlfcG5sOi4yZn0nKQogICAgICAgICAgICBzZWxmLmxvZ2dlci5sb2dfcmlza19ldmVudCgnREFJTFlfTE9TU19MSU1JVCcsIHsncG5sJzogc2VsZi5kYWlseV9wbmx9KQogICAgICAgIAogICAgICAgICMgQ2hlY2sgaWYgYWxyZWFkeSBpbiBwb3NpdGlvbiBmb3IgdGhpcyBzeW1ib2wKICAgICAgICBpZiBzaWduYWwuc3ltYm9sIGluIGN1cnJlbnRfcG9zaXRpb25zOgogICAgICAgICAgICBleGlzdGluZyA9IGN1cnJlbnRfcG9zaXRpb25zW3NpZ25hbC5zeW1ib2xdCiAgICAgICAgICAgICMgRG9uJ3QgYWRkIHRvIGxvc2luZyBwb3NpdGlvbnMKICAgICAgICAgICAgaWYgZXhpc3RpbmcuZ2V0KCd1bnJlYWxpemVkX3BubCcsIDApIDwgMDoKICAgICAgICAgICAgICAgIGNoZWNrc1snYWxsb3dlZCddID0gRmFsc2UKICAgICAgICAgICAgICAgIGNoZWNrc1sncmVhc29ucyddLmFwcGVuZCgnQWxyZWFkeSBpbiBsb3NpbmcgcG9zaXRpb24gZm9yIHRoaXMgc3ltYm9sJykKICAgICAgICAKICAgICAgICAjIENoZWNrIHBvcnRmb2xpbyBjb25jZW50cmF0aW9uCiAgICAgICAgdG90YWxfZXhwb3N1cmUgPSBzdW0ocC5nZXQoJ3ZhbHVlJywgMCkgZm9yIHAgaW4gY3VycmVudF9wb3NpdGlvbnMudmFsdWVzKCkpCiAgICAgICAgaWYgdG90YWxfZXhwb3N1cmUgPiBzZWxmLmNvbmZpZy5tYXhfcG9ydGZvbGlvX3Jpc2s6CiAgICAgICAgICAgIGNoZWNrc1snYWxsb3dlZCddID0gRmFsc2UKICAgICAgICAgICAgY2hlY2tzWydyZWFzb25zJ10uYXBwZW5kKCdQb3J0Zm9saW8gZXhwb3N1cmUgbGltaXQgcmVhY2hlZCcpCiAgICAgICAgCiAgICAgICAgcmV0dXJuIGNoZWNrcwogICAgCiAgICBkZWYgcmVjb3JkX3RyYWRlX3Jlc3VsdChzZWxmLCBwbmw6IGZsb2F0KToKICAgICAgICAiIiJSZWNvcmQgdHJhZGUgUG5MLiIiIgogICAgICAgIHNlbGYuZGFpbHlfcG5sICs9IHBubAogICAgICAgIHNlbGYuZGFpbHlfdHJhZGVzICs9IDEKICAgIAogICAgZGVmIGNoZWNrX3N0b3BfbG9zcyhzZWxmLCBwb3NpdGlvbjogRGljdCwgY3VycmVudF9wcmljZTogZmxvYXQpIC0+IGJvb2w6CiAgICAgICAgIiIiQ2hlY2sgaWYgc3RvcCBsb3NzIGlzIGhpdC4iIiIKICAgICAgICBpZiBwb3NpdGlvblsnc2lkZSddID09ICdsb25nJzoKICAgICAgICAgICAgcmV0dXJuIGN1cnJlbnRfcHJpY2UgPD0gcG9zaXRpb25bJ3N0b3BfbG9zcyddCiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmV0dXJuIGN1cnJlbnRfcHJpY2UgPj0gcG9zaXRpb25bJ3N0b3BfbG9zcyddCiAgICAKICAgIGRlZiBfY2hlY2tfZGFpbHlfcmVzZXQoc2VsZik6CiAgICAgICAgIiIiUmVzZXQgZGFpbHkgY291bnRlcnMgaWYgbmV3IGRheS4iIiIKICAgICAgICB0b2RheSA9IGRhdGV0aW1lLm5vdygpLmRhdGUoKQogICAgICAgIGlmIHRvZGF5ID4gc2VsZi5sYXN0X3Jlc2V0OgogICAgICAgICAgICBzZWxmLmRhaWx5X3BubCA9IDAKICAgICAgICAgICAgc2VsZi5kYWlseV90cmFkZXMgPSAwCiAgICAgICAgICAgIHNlbGYubGFzdF9yZXNldCA9IHRvZGF5"><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-16-11')" type="button">Run</button></div><pre><code><span class="c1"># risk/risk_manager.py</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>

<span class="k">class</span> <span class="nc">RiskManager</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Central risk management.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">logger</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logger</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">daily_pnl</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">daily_trades</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_reset</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">position_tracker</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="k">def</span> <span class="nf">can_trade</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">signal</span><span class="p">,</span> <span class="n">current_positions</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Check if trade is allowed based on risk rules.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_daily_reset</span><span class="p">()</span>
        
        <span class="n">checks</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;allowed&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s1">&#39;reasons&#39;</span><span class="p">:</span> <span class="p">[]</span>
        <span class="p">}</span>
        
        <span class="c1"># Check daily loss limit</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">daily_pnl</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">max_daily_loss</span><span class="p">:</span>
            <span class="n">checks</span><span class="p">[</span><span class="s1">&#39;allowed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">checks</span><span class="p">[</span><span class="s1">&#39;reasons&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Daily loss limit reached: $</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">daily_pnl</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log_risk_event</span><span class="p">(</span><span class="s1">&#39;DAILY_LOSS_LIMIT&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;pnl&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">daily_pnl</span><span class="p">})</span>
        
        <span class="c1"># Check if already in position for this symbol</span>
        <span class="k">if</span> <span class="n">signal</span><span class="o">.</span><span class="n">symbol</span> <span class="ow">in</span> <span class="n">current_positions</span><span class="p">:</span>
            <span class="n">existing</span> <span class="o">=</span> <span class="n">current_positions</span><span class="p">[</span><span class="n">signal</span><span class="o">.</span><span class="n">symbol</span><span class="p">]</span>
            <span class="c1"># Don&#39;t add to losing positions</span>
            <span class="k">if</span> <span class="n">existing</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;unrealized_pnl&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">checks</span><span class="p">[</span><span class="s1">&#39;allowed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">checks</span><span class="p">[</span><span class="s1">&#39;reasons&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Already in losing position for this symbol&#39;</span><span class="p">)</span>
        
        <span class="c1"># Check portfolio concentration</span>
        <span class="n">total_exposure</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">current_positions</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">total_exposure</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">max_portfolio_risk</span><span class="p">:</span>
            <span class="n">checks</span><span class="p">[</span><span class="s1">&#39;allowed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">checks</span><span class="p">[</span><span class="s1">&#39;reasons&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Portfolio exposure limit reached&#39;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">checks</span>
    
    <span class="k">def</span> <span class="nf">record_trade_result</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pnl</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Record trade PnL.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">daily_pnl</span> <span class="o">+=</span> <span class="n">pnl</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">daily_trades</span> <span class="o">+=</span> <span class="mi">1</span>
    
    <span class="k">def</span> <span class="nf">check_stop_loss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">position</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">current_price</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Check if stop loss is hit.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">position</span><span class="p">[</span><span class="s1">&#39;side&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;long&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">current_price</span> <span class="o">&lt;=</span> <span class="n">position</span><span class="p">[</span><span class="s1">&#39;stop_loss&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">current_price</span> <span class="o">&gt;=</span> <span class="n">position</span><span class="p">[</span><span class="s1">&#39;stop_loss&#39;</span><span class="p">]</span>
    
    <span class="k">def</span> <span class="nf">_check_daily_reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Reset daily counters if new day.&quot;&quot;&quot;</span>
        <span class="n">today</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">today</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_reset</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">daily_pnl</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">daily_trades</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">last_reset</span> <span class="o">=</span> <span class="n">today</span>
</code></pre><div class="code-output" id="output-cell-16-11"></div></div>
<div class="md-cell"><hr />
<h1>Part 6: Monitoring &amp; Dashboard</h1>
<h2>6.1 Performance Tracker</h2></div>
<div class="code-cell" id="cell-16-12" data-source="IyBtb25pdG9yaW5nL3BlcmZvcm1hbmNlLnB5CmltcG9ydCBudW1weSBhcyBucApmcm9tIHR5cGluZyBpbXBvcnQgTGlzdCwgRGljdApmcm9tIGRhdGV0aW1lIGltcG9ydCBkYXRldGltZQoKY2xhc3MgUGVyZm9ybWFuY2VUcmFja2VyOgogICAgIiIiVHJhY2sgYW5kIGFuYWx5emUgdHJhZGluZyBwZXJmb3JtYW5jZS4iIiIKICAgIAogICAgZGVmIF9faW5pdF9fKHNlbGYsIGluaXRpYWxfY2FwaXRhbDogZmxvYXQpOgogICAgICAgIHNlbGYuaW5pdGlhbF9jYXBpdGFsID0gaW5pdGlhbF9jYXBpdGFsCiAgICAgICAgc2VsZi5jdXJyZW50X2NhcGl0YWwgPSBpbml0aWFsX2NhcGl0YWwKICAgICAgICBzZWxmLnRyYWRlczogTGlzdFtEaWN0XSA9IFtdCiAgICAgICAgc2VsZi5lcXVpdHlfY3VydmU6IExpc3RbZmxvYXRdID0gW2luaXRpYWxfY2FwaXRhbF0KICAgICAgICBzZWxmLmRhaWx5X3JldHVybnM6IExpc3RbZmxvYXRdID0gW10KICAgIAogICAgZGVmIHJlY29yZF90cmFkZShzZWxmLCB0cmFkZTogRGljdCk6CiAgICAgICAgIiIiUmVjb3JkIGNvbXBsZXRlZCB0cmFkZS4iIiIKICAgICAgICB0cmFkZVsndGltZXN0YW1wJ10gPSBkYXRldGltZS5ub3coKQogICAgICAgIHNlbGYudHJhZGVzLmFwcGVuZCh0cmFkZSkKICAgICAgICBzZWxmLmN1cnJlbnRfY2FwaXRhbCArPSB0cmFkZS5nZXQoJ3BubCcsIDApCiAgICAgICAgc2VsZi5lcXVpdHlfY3VydmUuYXBwZW5kKHNlbGYuY3VycmVudF9jYXBpdGFsKQogICAgCiAgICBkZWYgY2FsY3VsYXRlX21ldHJpY3Moc2VsZikgLT4gRGljdDoKICAgICAgICAiIiJDYWxjdWxhdGUgcGVyZm9ybWFuY2UgbWV0cmljcy4iIiIKICAgICAgICBpZiBub3Qgc2VsZi50cmFkZXM6CiAgICAgICAgICAgIHJldHVybiB7J2Vycm9yJzogJ05vIHRyYWRlcyd9CiAgICAgICAgCiAgICAgICAgcG5scyA9IFt0LmdldCgncG5sJywgMCkgZm9yIHQgaW4gc2VsZi50cmFkZXNdCiAgICAgICAgd2lubmVycyA9IFtwIGZvciBwIGluIHBubHMgaWYgcCA+IDBdCiAgICAgICAgbG9zZXJzID0gW3AgZm9yIHAgaW4gcG5scyBpZiBwIDwgMF0KICAgICAgICAKICAgICAgICB0b3RhbF9yZXR1cm4gPSAoc2VsZi5jdXJyZW50X2NhcGl0YWwgLSBzZWxmLmluaXRpYWxfY2FwaXRhbCkgLyBzZWxmLmluaXRpYWxfY2FwaXRhbCAqIDEwMAogICAgICAgIAogICAgICAgICMgU2hhcnBlIHJhdGlvIChzaW1wbGlmaWVkKQogICAgICAgIGlmIGxlbihwbmxzKSA+IDEgYW5kIG5wLnN0ZChwbmxzKSA+IDA6CiAgICAgICAgICAgIHNoYXJwZSA9IG5wLm1lYW4ocG5scykgLyBucC5zdGQocG5scykgKiBucC5zcXJ0KDM2NSkKICAgICAgICBlbHNlOgogICAgICAgICAgICBzaGFycGUgPSAwCiAgICAgICAgCiAgICAgICAgIyBNYXggZHJhd2Rvd24KICAgICAgICBlcXVpdHkgPSBucC5hcnJheShzZWxmLmVxdWl0eV9jdXJ2ZSkKICAgICAgICBwZWFrID0gbnAubWF4aW11bS5hY2N1bXVsYXRlKGVxdWl0eSkKICAgICAgICBkcmF3ZG93biA9IChlcXVpdHkgLSBwZWFrKSAvIHBlYWsKICAgICAgICBtYXhfZGQgPSBucC5taW4oZHJhd2Rvd24pICogMTAwCiAgICAgICAgCiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgJ3RvdGFsX3RyYWRlcyc6IGxlbihzZWxmLnRyYWRlcyksCiAgICAgICAgICAgICd3aW5uaW5nX3RyYWRlcyc6IGxlbih3aW5uZXJzKSwKICAgICAgICAgICAgJ2xvc2luZ190cmFkZXMnOiBsZW4obG9zZXJzKSwKICAgICAgICAgICAgJ3dpbl9yYXRlJzogbGVuKHdpbm5lcnMpIC8gbGVuKHNlbGYudHJhZGVzKSAqIDEwMCBpZiBzZWxmLnRyYWRlcyBlbHNlIDAsCiAgICAgICAgICAgICd0b3RhbF9wbmwnOiBzdW0ocG5scyksCiAgICAgICAgICAgICd0b3RhbF9yZXR1cm5fcGN0JzogdG90YWxfcmV0dXJuLAogICAgICAgICAgICAnYXZlcmFnZV93aW4nOiBucC5tZWFuKHdpbm5lcnMpIGlmIHdpbm5lcnMgZWxzZSAwLAogICAgICAgICAgICAnYXZlcmFnZV9sb3NzJzogbnAubWVhbihsb3NlcnMpIGlmIGxvc2VycyBlbHNlIDAsCiAgICAgICAgICAgICdwcm9maXRfZmFjdG9yJzogYWJzKHN1bSh3aW5uZXJzKSAvIHN1bShsb3NlcnMpKSBpZiBsb3NlcnMgYW5kIHN1bShsb3NlcnMpICE9IDAgZWxzZSBmbG9hdCgnaW5mJyksCiAgICAgICAgICAgICdzaGFycGVfcmF0aW8nOiBzaGFycGUsCiAgICAgICAgICAgICdtYXhfZHJhd2Rvd25fcGN0JzogbWF4X2RkLAogICAgICAgICAgICAnY3VycmVudF9jYXBpdGFsJzogc2VsZi5jdXJyZW50X2NhcGl0YWwKICAgICAgICB9CiAgICAKICAgIGRlZiBnZW5lcmF0ZV9yZXBvcnQoc2VsZikgLT4gc3RyOgogICAgICAgICIiIkdlbmVyYXRlIHBlcmZvcm1hbmNlIHJlcG9ydC4iIiIKICAgICAgICBtZXRyaWNzID0gc2VsZi5jYWxjdWxhdGVfbWV0cmljcygpCiAgICAgICAgCiAgICAgICAgcmVwb3J0ID0gW10KICAgICAgICByZXBvcnQuYXBwZW5kKCc9JyAqIDYwKQogICAgICAgIHJlcG9ydC5hcHBlbmQoJyAgICAgICAgIFBFUkZPUk1BTkNFIFJFUE9SVCcpCiAgICAgICAgcmVwb3J0LmFwcGVuZCgnPScgKiA2MCkKICAgICAgICByZXBvcnQuYXBwZW5kKGYiSW5pdGlhbCBDYXBpdGFsOiAke3NlbGYuaW5pdGlhbF9jYXBpdGFsOiwuMmZ9IikKICAgICAgICByZXBvcnQuYXBwZW5kKGYiQ3VycmVudCBDYXBpdGFsOiAke21ldHJpY3MuZ2V0KCdjdXJyZW50X2NhcGl0YWwnLCAwKTosLjJmfSIpCiAgICAgICAgcmVwb3J0LmFwcGVuZChmIlRvdGFsIFJldHVybjoge21ldHJpY3MuZ2V0KCd0b3RhbF9yZXR1cm5fcGN0JywgMCk6LjJmfSUiKQogICAgICAgIHJlcG9ydC5hcHBlbmQoJy0nICogNjApCiAgICAgICAgcmVwb3J0LmFwcGVuZChmIlRvdGFsIFRyYWRlczoge21ldHJpY3MuZ2V0KCd0b3RhbF90cmFkZXMnLCAwKX0iKQogICAgICAgIHJlcG9ydC5hcHBlbmQoZiJXaW4gUmF0ZToge21ldHJpY3MuZ2V0KCd3aW5fcmF0ZScsIDApOi4xZn0lIikKICAgICAgICByZXBvcnQuYXBwZW5kKGYiUHJvZml0IEZhY3Rvcjoge21ldHJpY3MuZ2V0KCdwcm9maXRfZmFjdG9yJywgMCk6LjJmfSIpCiAgICAgICAgcmVwb3J0LmFwcGVuZChmIlNoYXJwZSBSYXRpbzoge21ldHJpY3MuZ2V0KCdzaGFycGVfcmF0aW8nLCAwKTouMmZ9IikKICAgICAgICByZXBvcnQuYXBwZW5kKGYiTWF4IERyYXdkb3duOiB7bWV0cmljcy5nZXQoJ21heF9kcmF3ZG93bl9wY3QnLCAwKTouMmZ9JSIpCiAgICAgICAgcmVwb3J0LmFwcGVuZCgnPScgKiA2MCkKICAgICAgICAKICAgICAgICByZXR1cm4gJ1xuJy5qb2luKHJlcG9ydCk="><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-16-12')" type="button">Run</button></div><pre><code><span class="c1"># monitoring/performance.py</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>

<span class="k">class</span> <span class="nc">PerformanceTracker</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Track and analyze trading performance.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">initial_capital</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initial_capital</span> <span class="o">=</span> <span class="n">initial_capital</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_capital</span> <span class="o">=</span> <span class="n">initial_capital</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trades</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">equity_curve</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">initial_capital</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">daily_returns</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">def</span> <span class="nf">record_trade</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trade</span><span class="p">:</span> <span class="n">Dict</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Record completed trade.&quot;&quot;&quot;</span>
        <span class="n">trade</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trades</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">trade</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_capital</span> <span class="o">+=</span> <span class="n">trade</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pnl&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">equity_curve</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_capital</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">calculate_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate performance metrics.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">trades</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;No trades&#39;</span><span class="p">}</span>
        
        <span class="n">pnls</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pnl&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trades</span><span class="p">]</span>
        <span class="n">winners</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pnls</span> <span class="k">if</span> <span class="n">p</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">losers</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pnls</span> <span class="k">if</span> <span class="n">p</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span>
        
        <span class="n">total_return</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_capital</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_capital</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_capital</span> <span class="o">*</span> <span class="mi">100</span>
        
        <span class="c1"># Sharpe ratio (simplified)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pnls</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">pnls</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">sharpe</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">pnls</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">pnls</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">365</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sharpe</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="c1"># Max drawdown</span>
        <span class="n">equity</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">equity_curve</span><span class="p">)</span>
        <span class="n">peak</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="o">.</span><span class="n">accumulate</span><span class="p">(</span><span class="n">equity</span><span class="p">)</span>
        <span class="n">drawdown</span> <span class="o">=</span> <span class="p">(</span><span class="n">equity</span> <span class="o">-</span> <span class="n">peak</span><span class="p">)</span> <span class="o">/</span> <span class="n">peak</span>
        <span class="n">max_dd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">drawdown</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;total_trades&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trades</span><span class="p">),</span>
            <span class="s1">&#39;winning_trades&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">winners</span><span class="p">),</span>
            <span class="s1">&#39;losing_trades&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">losers</span><span class="p">),</span>
            <span class="s1">&#39;win_rate&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">winners</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trades</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">trades</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;total_pnl&#39;</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="n">pnls</span><span class="p">),</span>
            <span class="s1">&#39;total_return_pct&#39;</span><span class="p">:</span> <span class="n">total_return</span><span class="p">,</span>
            <span class="s1">&#39;average_win&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">winners</span><span class="p">)</span> <span class="k">if</span> <span class="n">winners</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;average_loss&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">losers</span><span class="p">)</span> <span class="k">if</span> <span class="n">losers</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;profit_factor&#39;</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">winners</span><span class="p">)</span> <span class="o">/</span> <span class="nb">sum</span><span class="p">(</span><span class="n">losers</span><span class="p">))</span> <span class="k">if</span> <span class="n">losers</span> <span class="ow">and</span> <span class="nb">sum</span><span class="p">(</span><span class="n">losers</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">),</span>
            <span class="s1">&#39;sharpe_ratio&#39;</span><span class="p">:</span> <span class="n">sharpe</span><span class="p">,</span>
            <span class="s1">&#39;max_drawdown_pct&#39;</span><span class="p">:</span> <span class="n">max_dd</span><span class="p">,</span>
            <span class="s1">&#39;current_capital&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_capital</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">generate_report</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Generate performance report.&quot;&quot;&quot;</span>
        <span class="n">metrics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_metrics</span><span class="p">()</span>
        
        <span class="n">report</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;=&#39;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;         PERFORMANCE REPORT&#39;</span><span class="p">)</span>
        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;=&#39;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Initial Capital: $</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">initial_capital</span><span class="si">:</span><span class="s2">,.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Current Capital: $</span><span class="si">{</span><span class="n">metrics</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;current_capital&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="si">:</span><span class="s2">,.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total Return: </span><span class="si">{</span><span class="n">metrics</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;total_return_pct&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;-&#39;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total Trades: </span><span class="si">{</span><span class="n">metrics</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;total_trades&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Win Rate: </span><span class="si">{</span><span class="n">metrics</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;win_rate&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Profit Factor: </span><span class="si">{</span><span class="n">metrics</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;profit_factor&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sharpe Ratio: </span><span class="si">{</span><span class="n">metrics</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sharpe_ratio&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Max Drawdown: </span><span class="si">{</span><span class="n">metrics</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;max_drawdown_pct&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;=&#39;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">report</span><span class="p">)</span>
</code></pre><div class="code-output" id="output-cell-16-12"></div></div>
<div class="md-cell"><h2>6.2 Alert System</h2></div>
<div class="code-cell" id="cell-16-13" data-source="IyBtb25pdG9yaW5nL2FsZXJ0cy5weQpmcm9tIHR5cGluZyBpbXBvcnQgQ2FsbGFibGUsIERpY3QsIExpc3QKZnJvbSBkYXRldGltZSBpbXBvcnQgZGF0ZXRpbWUKCmNsYXNzIEFsZXJ0U3lzdGVtOgogICAgIiIiTXVsdGktY2hhbm5lbCBhbGVydCBzeXN0ZW0uIiIiCiAgICAKICAgIGRlZiBfX2luaXRfXyhzZWxmKToKICAgICAgICBzZWxmLmhhbmRsZXJzOiBEaWN0W3N0ciwgQ2FsbGFibGVdID0ge30KICAgICAgICBzZWxmLmFsZXJ0X2hpc3Rvcnk6IExpc3RbRGljdF0gPSBbXQogICAgICAgIHNlbGYudGhyZXNob2xkczogRGljdFtzdHIsIERpY3RdID0ge30KICAgIAogICAgZGVmIGFkZF9oYW5kbGVyKHNlbGYsIG5hbWU6IHN0ciwgaGFuZGxlcjogQ2FsbGFibGUpOgogICAgICAgICIiIkFkZCBhbGVydCBoYW5kbGVyIChlbWFpbCwgdGVsZWdyYW0sIGV0Yy4pLiIiIgogICAgICAgIHNlbGYuaGFuZGxlcnNbbmFtZV0gPSBoYW5kbGVyCiAgICAKICAgIGRlZiBzZXRfdGhyZXNob2xkKHNlbGYsIG1ldHJpYzogc3RyLCB2YWx1ZTogZmxvYXQsIGRpcmVjdGlvbjogc3RyID0gJ2Fib3ZlJyk6CiAgICAgICAgIiIiU2V0IGFsZXJ0IHRocmVzaG9sZC4iIiIKICAgICAgICBzZWxmLnRocmVzaG9sZHNbbWV0cmljXSA9IHsndmFsdWUnOiB2YWx1ZSwgJ2RpcmVjdGlvbic6IGRpcmVjdGlvbiwgJ3RyaWdnZXJlZCc6IEZhbHNlfQogICAgCiAgICBkZWYgY2hlY2tfdGhyZXNob2xkcyhzZWxmLCBjdXJyZW50X3ZhbHVlczogRGljdCk6CiAgICAgICAgIiIiQ2hlY2sgYWxsIHRocmVzaG9sZHMgYW5kIHRyaWdnZXIgYWxlcnRzLiIiIgogICAgICAgIGZvciBtZXRyaWMsIGNvbmZpZyBpbiBzZWxmLnRocmVzaG9sZHMuaXRlbXMoKToKICAgICAgICAgICAgaWYgbWV0cmljIG5vdCBpbiBjdXJyZW50X3ZhbHVlczoKICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgIAogICAgICAgICAgICB2YWx1ZSA9IGN1cnJlbnRfdmFsdWVzW21ldHJpY10KICAgICAgICAgICAgc2hvdWxkX3RyaWdnZXIgPSBGYWxzZQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgY29uZmlnWydkaXJlY3Rpb24nXSA9PSAnYWJvdmUnIGFuZCB2YWx1ZSA+IGNvbmZpZ1sndmFsdWUnXToKICAgICAgICAgICAgICAgIHNob3VsZF90cmlnZ2VyID0gVHJ1ZQogICAgICAgICAgICBlbGlmIGNvbmZpZ1snZGlyZWN0aW9uJ10gPT0gJ2JlbG93JyBhbmQgdmFsdWUgPCBjb25maWdbJ3ZhbHVlJ106CiAgICAgICAgICAgICAgICBzaG91bGRfdHJpZ2dlciA9IFRydWUKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIHNob3VsZF90cmlnZ2VyIGFuZCBub3QgY29uZmlnWyd0cmlnZ2VyZWQnXToKICAgICAgICAgICAgICAgIHNlbGYuc2VuZF9hbGVydChmIlRIUkVTSE9MRDoge21ldHJpY30gPSB7dmFsdWV9ICh7Y29uZmlnWydkaXJlY3Rpb24nXX0ge2NvbmZpZ1sndmFsdWUnXX0pIikKICAgICAgICAgICAgICAgIGNvbmZpZ1sndHJpZ2dlcmVkJ10gPSBUcnVlCiAgICAgICAgICAgIGVsaWYgbm90IHNob3VsZF90cmlnZ2VyOgogICAgICAgICAgICAgICAgY29uZmlnWyd0cmlnZ2VyZWQnXSA9IEZhbHNlCiAgICAKICAgIGRlZiBzZW5kX2FsZXJ0KHNlbGYsIG1lc3NhZ2U6IHN0ciwgbGV2ZWw6IHN0ciA9ICdJTkZPJyk6CiAgICAgICAgIiIiU2VuZCBhbGVydCB0aHJvdWdoIGFsbCBoYW5kbGVycy4iIiIKICAgICAgICBhbGVydCA9IHsKICAgICAgICAgICAgJ3RpbWVzdGFtcCc6IGRhdGV0aW1lLm5vdygpLAogICAgICAgICAgICAnbGV2ZWwnOiBsZXZlbCwKICAgICAgICAgICAgJ21lc3NhZ2UnOiBtZXNzYWdlCiAgICAgICAgfQogICAgICAgIHNlbGYuYWxlcnRfaGlzdG9yeS5hcHBlbmQoYWxlcnQpCiAgICAgICAgCiAgICAgICAgZm9yIG5hbWUsIGhhbmRsZXIgaW4gc2VsZi5oYW5kbGVycy5pdGVtcygpOgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBoYW5kbGVyKG1lc3NhZ2UsIGxldmVsKQogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgICAgICBwcmludChmJ0FsZXJ0IGhhbmRsZXIge25hbWV9IGZhaWxlZDoge2V9JykKICAgIAogICAgZGVmIHNlbmRfdHJhZGVfYWxlcnQoc2VsZiwgdHJhZGU6IERpY3QpOgogICAgICAgICIiIlNlbmQgdHJhZGUgZXhlY3V0aW9uIGFsZXJ0LiIiIgogICAgICAgIG1lc3NhZ2UgPSBmIlRSQURFOiB7dHJhZGVbJ3NpZGUnXS51cHBlcigpfSB7dHJhZGVbJ2Ftb3VudCddfSB7dHJhZGVbJ3N5bWJvbCddfSBAIHt0cmFkZVsncHJpY2UnXX0iCiAgICAgICAgc2VsZi5zZW5kX2FsZXJ0KG1lc3NhZ2UsICdUUkFERScp"><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-16-13')" type="button">Run</button></div><pre><code><span class="c1"># monitoring/alerts.py</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>

<span class="k">class</span> <span class="nc">AlertSystem</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Multi-channel alert system.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">handlers</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alert_history</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thresholds</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="k">def</span> <span class="nf">add_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">handler</span><span class="p">:</span> <span class="n">Callable</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add alert handler (email, telegram, etc.).&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">handlers</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">handler</span>
    
    <span class="k">def</span> <span class="nf">set_threshold</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metric</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">direction</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;above&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set alert threshold.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thresholds</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">value</span><span class="p">,</span> <span class="s1">&#39;direction&#39;</span><span class="p">:</span> <span class="n">direction</span><span class="p">,</span> <span class="s1">&#39;triggered&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">check_thresholds</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current_values</span><span class="p">:</span> <span class="n">Dict</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check all thresholds and trigger alerts.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">metric</span><span class="p">,</span> <span class="n">config</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">thresholds</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">metric</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">current_values</span><span class="p">:</span>
                <span class="k">continue</span>
            
            <span class="n">value</span> <span class="o">=</span> <span class="n">current_values</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span>
            <span class="n">should_trigger</span> <span class="o">=</span> <span class="kc">False</span>
            
            <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;direction&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;above&#39;</span> <span class="ow">and</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]:</span>
                <span class="n">should_trigger</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">elif</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;direction&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;below&#39;</span> <span class="ow">and</span> <span class="n">value</span> <span class="o">&lt;</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]:</span>
                <span class="n">should_trigger</span> <span class="o">=</span> <span class="kc">True</span>
            
            <span class="k">if</span> <span class="n">should_trigger</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;triggered&#39;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">send_alert</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;THRESHOLD: </span><span class="si">{</span><span class="n">metric</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;direction&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
                <span class="n">config</span><span class="p">[</span><span class="s1">&#39;triggered&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">should_trigger</span><span class="p">:</span>
                <span class="n">config</span><span class="p">[</span><span class="s1">&#39;triggered&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    
    <span class="k">def</span> <span class="nf">send_alert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">level</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;INFO&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Send alert through all handlers.&quot;&quot;&quot;</span>
        <span class="n">alert</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
            <span class="s1">&#39;level&#39;</span><span class="p">:</span> <span class="n">level</span><span class="p">,</span>
            <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="n">message</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alert_history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">alert</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">handler</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">handlers</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">handler</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">level</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Alert handler </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1"> failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">send_trade_alert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trade</span><span class="p">:</span> <span class="n">Dict</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Send trade execution alert.&quot;&quot;&quot;</span>
        <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;TRADE: </span><span class="si">{</span><span class="n">trade</span><span class="p">[</span><span class="s1">&#39;side&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">trade</span><span class="p">[</span><span class="s1">&#39;amount&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">trade</span><span class="p">[</span><span class="s1">&#39;symbol&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> @ </span><span class="si">{</span><span class="n">trade</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_alert</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="s1">&#39;TRADE&#39;</span><span class="p">)</span>
</code></pre><div class="code-output" id="output-cell-16-13"></div></div>
<div class="md-cell"><hr />
<h1>Part 7: Main Trading System</h1>
<h2>7.1 Complete System Integration</h2></div>
<div class="code-cell" id="cell-16-14" data-source="IyBtYWluLnB5CmltcG9ydCB0aW1lCmZyb20gZGF0ZXRpbWUgaW1wb3J0IGRhdGV0aW1lCgpjbGFzcyBDcnlwdG9UcmFkaW5nU3lzdGVtOgogICAgIiIiQ29tcGxldGUgY3J5cHRvIHRyYWRpbmcgc3lzdGVtLiIiIgogICAgCiAgICBkZWYgX19pbml0X18oc2VsZiwgY29uZmlnKToKICAgICAgICBzZWxmLmNvbmZpZyA9IGNvbmZpZwogICAgICAgIHNlbGYucnVubmluZyA9IEZhbHNlCiAgICAgICAgCiAgICAgICAgIyBJbml0aWFsaXplIGNvbXBvbmVudHMKICAgICAgICBzZWxmLmxvZ2dlciA9IFRyYWRpbmdMb2dnZXIoKQogICAgICAgIHNlbGYubWFya2V0X2RhdGEgPSBNYXJrZXREYXRhTWFuYWdlcihjb25maWcpCiAgICAgICAgc2VsZi5vbmNoYWluX2RhdGEgPSBPbkNoYWluRGF0YU1hbmFnZXIoY29uZmlnLndlYjNfcnBjKQogICAgICAgIHNlbGYuZGVmaV9kYXRhID0gRGVGaURhdGFNYW5hZ2VyKCkKICAgICAgICAKICAgICAgICAjIFN0cmF0ZWdpZXMKICAgICAgICBzZWxmLnN0cmF0ZWd5X21hbmFnZXIgPSBTdHJhdGVneU1hbmFnZXIoKQogICAgICAgIHNlbGYuc3RyYXRlZ3lfbWFuYWdlci5hZGRfc3RyYXRlZ3koVHJlbmRTdHJhdGVneSgpLCB3ZWlnaHQ9MS4wKQogICAgICAgIHNlbGYuc3RyYXRlZ3lfbWFuYWdlci5hZGRfc3RyYXRlZ3koTWVhblJldmVyc2lvblN0cmF0ZWd5KCksIHdlaWdodD0wLjgpCiAgICAgICAgCiAgICAgICAgIyBFeGVjdXRpb24KICAgICAgICBzZWxmLm9yZGVyX21hbmFnZXIgPSBOb25lICAjIEluaXRpYWxpemUgd2hlbiBydW5uaW5nCiAgICAgICAgc2VsZi5wb3NpdGlvbl9zaXplciA9IFBvc2l0aW9uU2l6ZXIoY29uZmlnLnJpc2spCiAgICAgICAgc2VsZi5yaXNrX21hbmFnZXIgPSBSaXNrTWFuYWdlcihjb25maWcucmlzaywgc2VsZi5sb2dnZXIpCiAgICAgICAgCiAgICAgICAgIyBNb25pdG9yaW5nCiAgICAgICAgc2VsZi5wZXJmb3JtYW5jZSA9IFBlcmZvcm1hbmNlVHJhY2tlcihjb25maWcudHJhZGluZy5tYXhfcG9zaXRpb25fc2l6ZSAqIDEwKQogICAgICAgIHNlbGYuYWxlcnRzID0gQWxlcnRTeXN0ZW0oKQogICAgICAgIAogICAgICAgICMgU3RhdGUKICAgICAgICBzZWxmLnBvc2l0aW9ucyA9IHt9CiAgICAgICAgc2VsZi5sYXN0X3NpZ25hbHMgPSB7fQogICAgCiAgICBkZWYgaW5pdGlhbGl6ZShzZWxmKToKICAgICAgICAiIiJJbml0aWFsaXplIGFsbCBjb21wb25lbnRzLiIiIgogICAgICAgIHNlbGYubG9nZ2VyLmxvZ2dlci5pbmZvKCdJbml0aWFsaXppbmcgdHJhZGluZyBzeXN0ZW0uLi4nKQogICAgICAgIAogICAgICAgICMgU2V0IHVwIGFsZXJ0cwogICAgICAgIHNlbGYuYWxlcnRzLmFkZF9oYW5kbGVyKCdjb25zb2xlJywgbGFtYmRhIG1zZywgbHZsOiBwcmludChmJ1t7bHZsfV0ge21zZ30nKSkKICAgICAgICBzZWxmLmFsZXJ0cy5zZXRfdGhyZXNob2xkKCdkYWlseV9wbmwnLCAtc2VsZi5jb25maWcudHJhZGluZy5tYXhfZGFpbHlfbG9zcywgJ2JlbG93JykKICAgICAgICAKICAgICAgICAjIEluaXRpYWxpemUgb3JkZXIgbWFuYWdlciB3aXRoIGZpcnN0IGV4Y2hhbmdlCiAgICAgICAgaWYgc2VsZi5tYXJrZXRfZGF0YS5leGNoYW5nZXM6CiAgICAgICAgICAgIGV4Y2hhbmdlID0gbGlzdChzZWxmLm1hcmtldF9kYXRhLmV4Y2hhbmdlcy52YWx1ZXMoKSlbMF0KICAgICAgICAgICAgc2VsZi5vcmRlcl9tYW5hZ2VyID0gT3JkZXJNYW5hZ2VyKGV4Y2hhbmdlLCBzZWxmLmxvZ2dlcikKICAgICAgICAKICAgICAgICBzZWxmLmxvZ2dlci5sb2dnZXIuaW5mbygnU3lzdGVtIGluaXRpYWxpemVkJykKICAgICAgICByZXR1cm4gVHJ1ZQogICAgCiAgICBkZWYgcnVuX2N5Y2xlKHNlbGYpOgogICAgICAgICIiIlJ1biBvbmUgdHJhZGluZyBjeWNsZS4iIiIKICAgICAgICBmb3Igc3ltYm9sIGluIHNlbGYuY29uZmlnLnRyYWRpbmcuc3ltYm9sczoKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgIyBHZXQgbWFya2V0IGRhdGEKICAgICAgICAgICAgICAgIGRhdGEgPSBzZWxmLm1hcmtldF9kYXRhLmdldF9vaGxjdihzeW1ib2wsICcxaCcsIDEwMCkKICAgICAgICAgICAgICAgIHRpY2tlciA9IHNlbGYubWFya2V0X2RhdGEuZ2V0X3RpY2tlcihzeW1ib2wpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgR2VuZXJhdGUgc2lnbmFscwogICAgICAgICAgICAgICAgc2lnbmFsID0gc2VsZi5zdHJhdGVneV9tYW5hZ2VyLmdldF9jb21iaW5lZF9zaWduYWwoZGF0YSwgc3ltYm9sKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiBzaWduYWw6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIubG9nX3NpZ25hbCh7CiAgICAgICAgICAgICAgICAgICAgICAgICdzeW1ib2wnOiBzeW1ib2wsCiAgICAgICAgICAgICAgICAgICAgICAgICd0eXBlJzogc2lnbmFsLnNpZ25hbF90eXBlLnZhbHVlLAogICAgICAgICAgICAgICAgICAgICAgICAnc3RyZW5ndGgnOiBzaWduYWwuc3RyZW5ndGgsCiAgICAgICAgICAgICAgICAgICAgICAgICdwcmljZSc6IHNpZ25hbC5wcmljZQogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgIyBDaGVjayByaXNrCiAgICAgICAgICAgICAgICAgICAgcmlza19jaGVjayA9IHNlbGYucmlza19tYW5hZ2VyLmNhbl90cmFkZShzaWduYWwsIHNlbGYucG9zaXRpb25zKQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGlmIHJpc2tfY2hlY2tbJ2FsbG93ZWQnXToKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5fZXhlY3V0ZV9zaWduYWwoc2lnbmFsLCB0aWNrZXIpCiAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIubG9nZ2VyLmluZm8oZiJTaWduYWwgYmxvY2tlZDoge3Jpc2tfY2hlY2tbJ3JlYXNvbnMnXX0iKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIENoZWNrIGV4aXN0aW5nIHBvc2l0aW9ucyBmb3Igc3RvcHMKICAgICAgICAgICAgICAgIHNlbGYuX2NoZWNrX3Bvc2l0aW9ucyhzeW1ib2wsIHRpY2tlclsncHJpY2UnXSkKICAgICAgICAgICAgICAgIAogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5sb2dfZXJyb3IoZidDeWNsZSBlcnJvciBmb3Ige3N5bWJvbH0nLCB7J2Vycm9yJzogc3RyKGUpfSkKICAgICAgICAKICAgICAgICAjIENoZWNrIGFsZXJ0cwogICAgICAgIHNlbGYuYWxlcnRzLmNoZWNrX3RocmVzaG9sZHMoeydkYWlseV9wbmwnOiBzZWxmLnJpc2tfbWFuYWdlci5kYWlseV9wbmx9KQogICAgCiAgICBkZWYgX2V4ZWN1dGVfc2lnbmFsKHNlbGYsIHNpZ25hbCwgdGlja2VyKToKICAgICAgICAiIiJFeGVjdXRlIHRyYWRpbmcgc2lnbmFsLiIiIgogICAgICAgICMgQ2FsY3VsYXRlIHBvc2l0aW9uIHNpemUKICAgICAgICBzaXppbmcgPSBzZWxmLnBvc2l0aW9uX3NpemVyLmNhbGN1bGF0ZV9wb3NpdGlvbl9zaXplKAogICAgICAgICAgICBzZWxmLnBlcmZvcm1hbmNlLmN1cnJlbnRfY2FwaXRhbCwKICAgICAgICAgICAgc2lnbmFsLnByaWNlLAogICAgICAgICAgICBzaWduYWwuc3RvcF9sb3NzLAogICAgICAgICAgICBzaWduYWwuc3RyZW5ndGgKICAgICAgICApCiAgICAgICAgCiAgICAgICAgaWYgJ2Vycm9yJyBpbiBzaXppbmc6CiAgICAgICAgICAgIHJldHVybgogICAgICAgIAogICAgICAgICMgRXhlY3V0ZSB0cmFkZQogICAgICAgIHNpZGUgPSAnYnV5JyBpZiBzaWduYWwuc2lnbmFsX3R5cGUgPT0gU2lnbmFsVHlwZS5CVVkgZWxzZSAnc2VsbCcKICAgICAgICAKICAgICAgICB0cnk6CiAgICAgICAgICAgIG9yZGVyID0gc2VsZi5vcmRlcl9tYW5hZ2VyLmNyZWF0ZV9tYXJrZXRfb3JkZXIoCiAgICAgICAgICAgICAgICBzaWduYWwuc3ltYm9sLAogICAgICAgICAgICAgICAgc2lkZSwKICAgICAgICAgICAgICAgIHNpemluZ1sndW5pdHMnXQogICAgICAgICAgICApCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFRyYWNrIHBvc2l0aW9uCiAgICAgICAgICAgIHNlbGYucG9zaXRpb25zW3NpZ25hbC5zeW1ib2xdID0gewogICAgICAgICAgICAgICAgJ3NpZGUnOiAnbG9uZycgaWYgc2lkZSA9PSAnYnV5JyBlbHNlICdzaG9ydCcsCiAgICAgICAgICAgICAgICAnZW50cnlfcHJpY2UnOiBvcmRlci5maWxsZWRfcHJpY2UsCiAgICAgICAgICAgICAgICAnc2l6ZSc6IHNpemluZ1sndW5pdHMnXSwKICAgICAgICAgICAgICAgICdzdG9wX2xvc3MnOiBzaWduYWwuc3RvcF9sb3NzLAogICAgICAgICAgICAgICAgJ3Rha2VfcHJvZml0Jzogc2lnbmFsLnRha2VfcHJvZml0LAogICAgICAgICAgICAgICAgJ3ZhbHVlJzogc2l6aW5nWyd2YWx1ZSddCiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIHNlbGYuYWxlcnRzLnNlbmRfdHJhZGVfYWxlcnQoewogICAgICAgICAgICAgICAgJ3N5bWJvbCc6IHNpZ25hbC5zeW1ib2wsCiAgICAgICAgICAgICAgICAnc2lkZSc6IHNpZGUsCiAgICAgICAgICAgICAgICAnYW1vdW50Jzogc2l6aW5nWyd1bml0cyddLAogICAgICAgICAgICAgICAgJ3ByaWNlJzogb3JkZXIuZmlsbGVkX3ByaWNlCiAgICAgICAgICAgIH0pCiAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgc2VsZi5sb2dnZXIubG9nX2Vycm9yKGYnRXhlY3V0aW9uIGZhaWxlZCcsIHsnZXJyb3InOiBzdHIoZSl9KQogICAgCiAgICBkZWYgX2NoZWNrX3Bvc2l0aW9ucyhzZWxmLCBzeW1ib2w6IHN0ciwgY3VycmVudF9wcmljZTogZmxvYXQpOgogICAgICAgICIiIkNoZWNrIHBvc2l0aW9ucyBmb3Igc3RvcCBsb3NzL3Rha2UgcHJvZml0LiIiIgogICAgICAgIGlmIHN5bWJvbCBub3QgaW4gc2VsZi5wb3NpdGlvbnM6CiAgICAgICAgICAgIHJldHVybgogICAgICAgIAogICAgICAgIHBvc2l0aW9uID0gc2VsZi5wb3NpdGlvbnNbc3ltYm9sXQogICAgICAgIAogICAgICAgICMgQ2hlY2sgc3RvcCBsb3NzCiAgICAgICAgaWYgc2VsZi5yaXNrX21hbmFnZXIuY2hlY2tfc3RvcF9sb3NzKHBvc2l0aW9uLCBjdXJyZW50X3ByaWNlKToKICAgICAgICAgICAgc2VsZi5fY2xvc2VfcG9zaXRpb24oc3ltYm9sLCBjdXJyZW50X3ByaWNlLCAnU1RPUF9MT1NTJykKICAgICAgICAKICAgICAgICAjIENoZWNrIHRha2UgcHJvZml0CiAgICAgICAgaWYgcG9zaXRpb25bJ3NpZGUnXSA9PSAnbG9uZycgYW5kIGN1cnJlbnRfcHJpY2UgPj0gcG9zaXRpb25bJ3Rha2VfcHJvZml0J106CiAgICAgICAgICAgIHNlbGYuX2Nsb3NlX3Bvc2l0aW9uKHN5bWJvbCwgY3VycmVudF9wcmljZSwgJ1RBS0VfUFJPRklUJykKICAgICAgICBlbGlmIHBvc2l0aW9uWydzaWRlJ10gPT0gJ3Nob3J0JyBhbmQgY3VycmVudF9wcmljZSA8PSBwb3NpdGlvblsndGFrZV9wcm9maXQnXToKICAgICAgICAgICAgc2VsZi5fY2xvc2VfcG9zaXRpb24oc3ltYm9sLCBjdXJyZW50X3ByaWNlLCAnVEFLRV9QUk9GSVQnKQogICAgCiAgICBkZWYgX2Nsb3NlX3Bvc2l0aW9uKHNlbGYsIHN5bWJvbDogc3RyLCBwcmljZTogZmxvYXQsIHJlYXNvbjogc3RyKToKICAgICAgICAiIiJDbG9zZSBhIHBvc2l0aW9uLiIiIgogICAgICAgIGlmIHN5bWJvbCBub3QgaW4gc2VsZi5wb3NpdGlvbnM6CiAgICAgICAgICAgIHJldHVybgogICAgICAgIAogICAgICAgIHBvc2l0aW9uID0gc2VsZi5wb3NpdGlvbnNbc3ltYm9sXQogICAgICAgIHNpZGUgPSAnc2VsbCcgaWYgcG9zaXRpb25bJ3NpZGUnXSA9PSAnbG9uZycgZWxzZSAnYnV5JwogICAgICAgIAogICAgICAgIHRyeToKICAgICAgICAgICAgb3JkZXIgPSBzZWxmLm9yZGVyX21hbmFnZXIuY3JlYXRlX21hcmtldF9vcmRlcihzeW1ib2wsIHNpZGUsIHBvc2l0aW9uWydzaXplJ10pCiAgICAgICAgICAgIAogICAgICAgICAgICAjIENhbGN1bGF0ZSBQbkwKICAgICAgICAgICAgaWYgcG9zaXRpb25bJ3NpZGUnXSA9PSAnbG9uZyc6CiAgICAgICAgICAgICAgICBwbmwgPSAocHJpY2UgLSBwb3NpdGlvblsnZW50cnlfcHJpY2UnXSkgKiBwb3NpdGlvblsnc2l6ZSddCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBwbmwgPSAocG9zaXRpb25bJ2VudHJ5X3ByaWNlJ10gLSBwcmljZSkgKiBwb3NpdGlvblsnc2l6ZSddCiAgICAgICAgICAgIAogICAgICAgICAgICBzZWxmLnBlcmZvcm1hbmNlLnJlY29yZF90cmFkZSh7CiAgICAgICAgICAgICAgICAnc3ltYm9sJzogc3ltYm9sLAogICAgICAgICAgICAgICAgJ3NpZGUnOiBwb3NpdGlvblsnc2lkZSddLAogICAgICAgICAgICAgICAgJ2VudHJ5X3ByaWNlJzogcG9zaXRpb25bJ2VudHJ5X3ByaWNlJ10sCiAgICAgICAgICAgICAgICAnZXhpdF9wcmljZSc6IHByaWNlLAogICAgICAgICAgICAgICAgJ3NpemUnOiBwb3NpdGlvblsnc2l6ZSddLAogICAgICAgICAgICAgICAgJ3BubCc6IHBubCwKICAgICAgICAgICAgICAgICdyZWFzb24nOiByZWFzb24KICAgICAgICAgICAgfSkKICAgICAgICAgICAgCiAgICAgICAgICAgIHNlbGYucmlza19tYW5hZ2VyLnJlY29yZF90cmFkZV9yZXN1bHQocG5sKQogICAgICAgICAgICBkZWwgc2VsZi5wb3NpdGlvbnNbc3ltYm9sXQogICAgICAgICAgICAKICAgICAgICAgICAgc2VsZi5sb2dnZXIubG9nX3RyYWRlKHsKICAgICAgICAgICAgICAgICdhY3Rpb24nOiAnQ0xPU0UnLAogICAgICAgICAgICAgICAgJ3N5bWJvbCc6IHN5bWJvbCwKICAgICAgICAgICAgICAgICdyZWFzb24nOiByZWFzb24sCiAgICAgICAgICAgICAgICAncG5sJzogcG5sCiAgICAgICAgICAgIH0pCiAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgc2VsZi5sb2dnZXIubG9nX2Vycm9yKGYnQ2xvc2UgcG9zaXRpb24gZmFpbGVkJywgeydlcnJvcic6IHN0cihlKX0pCiAgICAKICAgIGRlZiBydW4oc2VsZiwgaW50ZXJ2YWxfc2Vjb25kczogaW50ID0gNjApOgogICAgICAgICIiIlJ1biB0aGUgdHJhZGluZyBzeXN0ZW0uIiIiCiAgICAgICAgc2VsZi5ydW5uaW5nID0gVHJ1ZQogICAgICAgIHNlbGYubG9nZ2VyLmxvZ2dlci5pbmZvKGYnU3RhcnRpbmcgdHJhZGluZyBzeXN0ZW0sIGludGVydmFsOiB7aW50ZXJ2YWxfc2Vjb25kc31zJykKICAgICAgICAKICAgICAgICB3aGlsZSBzZWxmLnJ1bm5pbmc6CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIGN5Y2xlX3N0YXJ0ID0gdGltZS50aW1lKCkKICAgICAgICAgICAgICAgIHNlbGYucnVuX2N5Y2xlKCkKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBXYWl0IGZvciBuZXh0IGN5Y2xlCiAgICAgICAgICAgICAgICBlbGFwc2VkID0gdGltZS50aW1lKCkgLSBjeWNsZV9zdGFydAogICAgICAgICAgICAgICAgc2xlZXBfdGltZSA9IG1heCgwLCBpbnRlcnZhbF9zZWNvbmRzIC0gZWxhcHNlZCkKICAgICAgICAgICAgICAgIHRpbWUuc2xlZXAoc2xlZXBfdGltZSkKICAgICAgICAgICAgICAgIAogICAgICAgICAgICBleGNlcHQgS2V5Ym9hcmRJbnRlcnJ1cHQ6CiAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5sb2dnZXIuaW5mbygnU2h1dGRvd24gcmVxdWVzdGVkJykKICAgICAgICAgICAgICAgIHNlbGYuc2h1dGRvd24oKQogICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIubG9nX2Vycm9yKGYnTWFpbiBsb29wIGVycm9yJywgeydlcnJvcic6IHN0cihlKX0pCiAgICAgICAgICAgICAgICB0aW1lLnNsZWVwKDUpCiAgICAKICAgIGRlZiBzaHV0ZG93bihzZWxmKToKICAgICAgICAiIiJHcmFjZWZ1bCBzaHV0ZG93bi4iIiIKICAgICAgICBzZWxmLnJ1bm5pbmcgPSBGYWxzZQogICAgICAgIHNlbGYubG9nZ2VyLmxvZ2dlci5pbmZvKCdTaHV0dGluZyBkb3duLi4uJykKICAgICAgICAKICAgICAgICAjIENsb3NlIGFsbCBwb3NpdGlvbnMKICAgICAgICBmb3Igc3ltYm9sIGluIGxpc3Qoc2VsZi5wb3NpdGlvbnMua2V5cygpKToKICAgICAgICAgICAgdGlja2VyID0gc2VsZi5tYXJrZXRfZGF0YS5nZXRfdGlja2VyKHN5bWJvbCkKICAgICAgICAgICAgc2VsZi5fY2xvc2VfcG9zaXRpb24oc3ltYm9sLCB0aWNrZXJbJ3ByaWNlJ10sICdTSFVURE9XTicpCiAgICAgICAgCiAgICAgICAgIyBHZW5lcmF0ZSBmaW5hbCByZXBvcnQKICAgICAgICBwcmludChzZWxmLnBlcmZvcm1hbmNlLmdlbmVyYXRlX3JlcG9ydCgpKQogICAgICAgIHNlbGYubG9nZ2VyLmxvZ2dlci5pbmZvKCdTaHV0ZG93biBjb21wbGV0ZScp"><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-16-14')" type="button">Run</button></div><pre><code><span class="c1"># main.py</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>

<span class="k">class</span> <span class="nc">CryptoTradingSystem</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Complete crypto trading system.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="kc">False</span>
        
        <span class="c1"># Initialize components</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">TradingLogger</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">market_data</span> <span class="o">=</span> <span class="n">MarketDataManager</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">onchain_data</span> <span class="o">=</span> <span class="n">OnChainDataManager</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">web3_rpc</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">defi_data</span> <span class="o">=</span> <span class="n">DeFiDataManager</span><span class="p">()</span>
        
        <span class="c1"># Strategies</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">strategy_manager</span> <span class="o">=</span> <span class="n">StrategyManager</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">strategy_manager</span><span class="o">.</span><span class="n">add_strategy</span><span class="p">(</span><span class="n">TrendStrategy</span><span class="p">(),</span> <span class="n">weight</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">strategy_manager</span><span class="o">.</span><span class="n">add_strategy</span><span class="p">(</span><span class="n">MeanReversionStrategy</span><span class="p">(),</span> <span class="n">weight</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
        
        <span class="c1"># Execution</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">order_manager</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Initialize when running</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">position_sizer</span> <span class="o">=</span> <span class="n">PositionSizer</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">risk</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">risk_manager</span> <span class="o">=</span> <span class="n">RiskManager</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">risk</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">)</span>
        
        <span class="c1"># Monitoring</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">performance</span> <span class="o">=</span> <span class="n">PerformanceTracker</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">trading</span><span class="o">.</span><span class="n">max_position_size</span> <span class="o">*</span> <span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alerts</span> <span class="o">=</span> <span class="n">AlertSystem</span><span class="p">()</span>
        
        <span class="c1"># State</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">positions</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_signals</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize all components.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Initializing trading system...&#39;</span><span class="p">)</span>
        
        <span class="c1"># Set up alerts</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alerts</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="s1">&#39;console&#39;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">msg</span><span class="p">,</span> <span class="n">lvl</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;[</span><span class="si">{</span><span class="n">lvl</span><span class="si">}</span><span class="s1">] </span><span class="si">{</span><span class="n">msg</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alerts</span><span class="o">.</span><span class="n">set_threshold</span><span class="p">(</span><span class="s1">&#39;daily_pnl&#39;</span><span class="p">,</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">trading</span><span class="o">.</span><span class="n">max_daily_loss</span><span class="p">,</span> <span class="s1">&#39;below&#39;</span><span class="p">)</span>
        
        <span class="c1"># Initialize order manager with first exchange</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">market_data</span><span class="o">.</span><span class="n">exchanges</span><span class="p">:</span>
            <span class="n">exchange</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">market_data</span><span class="o">.</span><span class="n">exchanges</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">order_manager</span> <span class="o">=</span> <span class="n">OrderManager</span><span class="p">(</span><span class="n">exchange</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;System initialized&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>
    
    <span class="k">def</span> <span class="nf">run_cycle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Run one trading cycle.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">trading</span><span class="o">.</span><span class="n">symbols</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Get market data</span>
                <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">market_data</span><span class="o">.</span><span class="n">get_ohlcv</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="s1">&#39;1h&#39;</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
                <span class="n">ticker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">market_data</span><span class="o">.</span><span class="n">get_ticker</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
                
                <span class="c1"># Generate signals</span>
                <span class="n">signal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">strategy_manager</span><span class="o">.</span><span class="n">get_combined_signal</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">symbol</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="n">signal</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log_signal</span><span class="p">({</span>
                        <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span>
                        <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="n">signal</span><span class="o">.</span><span class="n">signal_type</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                        <span class="s1">&#39;strength&#39;</span><span class="p">:</span> <span class="n">signal</span><span class="o">.</span><span class="n">strength</span><span class="p">,</span>
                        <span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="n">signal</span><span class="o">.</span><span class="n">price</span>
                    <span class="p">})</span>
                    
                    <span class="c1"># Check risk</span>
                    <span class="n">risk_check</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">risk_manager</span><span class="o">.</span><span class="n">can_trade</span><span class="p">(</span><span class="n">signal</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">)</span>
                    
                    <span class="k">if</span> <span class="n">risk_check</span><span class="p">[</span><span class="s1">&#39;allowed&#39;</span><span class="p">]:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_execute_signal</span><span class="p">(</span><span class="n">signal</span><span class="p">,</span> <span class="n">ticker</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Signal blocked: </span><span class="si">{</span><span class="n">risk_check</span><span class="p">[</span><span class="s1">&#39;reasons&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                
                <span class="c1"># Check existing positions for stops</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_check_positions</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">ticker</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">])</span>
                
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log_error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Cycle error for </span><span class="si">{</span><span class="n">symbol</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)})</span>
        
        <span class="c1"># Check alerts</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alerts</span><span class="o">.</span><span class="n">check_thresholds</span><span class="p">({</span><span class="s1">&#39;daily_pnl&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">risk_manager</span><span class="o">.</span><span class="n">daily_pnl</span><span class="p">})</span>
    
    <span class="k">def</span> <span class="nf">_execute_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">signal</span><span class="p">,</span> <span class="n">ticker</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Execute trading signal.&quot;&quot;&quot;</span>
        <span class="c1"># Calculate position size</span>
        <span class="n">sizing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">position_sizer</span><span class="o">.</span><span class="n">calculate_position_size</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">performance</span><span class="o">.</span><span class="n">current_capital</span><span class="p">,</span>
            <span class="n">signal</span><span class="o">.</span><span class="n">price</span><span class="p">,</span>
            <span class="n">signal</span><span class="o">.</span><span class="n">stop_loss</span><span class="p">,</span>
            <span class="n">signal</span><span class="o">.</span><span class="n">strength</span>
        <span class="p">)</span>
        
        <span class="k">if</span> <span class="s1">&#39;error&#39;</span> <span class="ow">in</span> <span class="n">sizing</span><span class="p">:</span>
            <span class="k">return</span>
        
        <span class="c1"># Execute trade</span>
        <span class="n">side</span> <span class="o">=</span> <span class="s1">&#39;buy&#39;</span> <span class="k">if</span> <span class="n">signal</span><span class="o">.</span><span class="n">signal_type</span> <span class="o">==</span> <span class="n">SignalType</span><span class="o">.</span><span class="n">BUY</span> <span class="k">else</span> <span class="s1">&#39;sell&#39;</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="n">order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">order_manager</span><span class="o">.</span><span class="n">create_market_order</span><span class="p">(</span>
                <span class="n">signal</span><span class="o">.</span><span class="n">symbol</span><span class="p">,</span>
                <span class="n">side</span><span class="p">,</span>
                <span class="n">sizing</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span>
            <span class="p">)</span>
            
            <span class="c1"># Track position</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">signal</span><span class="o">.</span><span class="n">symbol</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;side&#39;</span><span class="p">:</span> <span class="s1">&#39;long&#39;</span> <span class="k">if</span> <span class="n">side</span> <span class="o">==</span> <span class="s1">&#39;buy&#39;</span> <span class="k">else</span> <span class="s1">&#39;short&#39;</span><span class="p">,</span>
                <span class="s1">&#39;entry_price&#39;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">filled_price</span><span class="p">,</span>
                <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="n">sizing</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">],</span>
                <span class="s1">&#39;stop_loss&#39;</span><span class="p">:</span> <span class="n">signal</span><span class="o">.</span><span class="n">stop_loss</span><span class="p">,</span>
                <span class="s1">&#39;take_profit&#39;</span><span class="p">:</span> <span class="n">signal</span><span class="o">.</span><span class="n">take_profit</span><span class="p">,</span>
                <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">sizing</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
            <span class="p">}</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">alerts</span><span class="o">.</span><span class="n">send_trade_alert</span><span class="p">({</span>
                <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">signal</span><span class="o">.</span><span class="n">symbol</span><span class="p">,</span>
                <span class="s1">&#39;side&#39;</span><span class="p">:</span> <span class="n">side</span><span class="p">,</span>
                <span class="s1">&#39;amount&#39;</span><span class="p">:</span> <span class="n">sizing</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">],</span>
                <span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">filled_price</span>
            <span class="p">})</span>
            
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log_error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Execution failed&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)})</span>
    
    <span class="k">def</span> <span class="nf">_check_positions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">current_price</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check positions for stop loss/take profit.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">symbol</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">:</span>
            <span class="k">return</span>
        
        <span class="n">position</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span>
        
        <span class="c1"># Check stop loss</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">risk_manager</span><span class="o">.</span><span class="n">check_stop_loss</span><span class="p">(</span><span class="n">position</span><span class="p">,</span> <span class="n">current_price</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_close_position</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">current_price</span><span class="p">,</span> <span class="s1">&#39;STOP_LOSS&#39;</span><span class="p">)</span>
        
        <span class="c1"># Check take profit</span>
        <span class="k">if</span> <span class="n">position</span><span class="p">[</span><span class="s1">&#39;side&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;long&#39;</span> <span class="ow">and</span> <span class="n">current_price</span> <span class="o">&gt;=</span> <span class="n">position</span><span class="p">[</span><span class="s1">&#39;take_profit&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_close_position</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">current_price</span><span class="p">,</span> <span class="s1">&#39;TAKE_PROFIT&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">position</span><span class="p">[</span><span class="s1">&#39;side&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;short&#39;</span> <span class="ow">and</span> <span class="n">current_price</span> <span class="o">&lt;=</span> <span class="n">position</span><span class="p">[</span><span class="s1">&#39;take_profit&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_close_position</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">current_price</span><span class="p">,</span> <span class="s1">&#39;TAKE_PROFIT&#39;</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">_close_position</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">price</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">reason</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Close a position.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">symbol</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">:</span>
            <span class="k">return</span>
        
        <span class="n">position</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span>
        <span class="n">side</span> <span class="o">=</span> <span class="s1">&#39;sell&#39;</span> <span class="k">if</span> <span class="n">position</span><span class="p">[</span><span class="s1">&#39;side&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;long&#39;</span> <span class="k">else</span> <span class="s1">&#39;buy&#39;</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="n">order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">order_manager</span><span class="o">.</span><span class="n">create_market_order</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">side</span><span class="p">,</span> <span class="n">position</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">])</span>
            
            <span class="c1"># Calculate PnL</span>
            <span class="k">if</span> <span class="n">position</span><span class="p">[</span><span class="s1">&#39;side&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;long&#39;</span><span class="p">:</span>
                <span class="n">pnl</span> <span class="o">=</span> <span class="p">(</span><span class="n">price</span> <span class="o">-</span> <span class="n">position</span><span class="p">[</span><span class="s1">&#39;entry_price&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="n">position</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pnl</span> <span class="o">=</span> <span class="p">(</span><span class="n">position</span><span class="p">[</span><span class="s1">&#39;entry_price&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">price</span><span class="p">)</span> <span class="o">*</span> <span class="n">position</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">]</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">performance</span><span class="o">.</span><span class="n">record_trade</span><span class="p">({</span>
                <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span>
                <span class="s1">&#39;side&#39;</span><span class="p">:</span> <span class="n">position</span><span class="p">[</span><span class="s1">&#39;side&#39;</span><span class="p">],</span>
                <span class="s1">&#39;entry_price&#39;</span><span class="p">:</span> <span class="n">position</span><span class="p">[</span><span class="s1">&#39;entry_price&#39;</span><span class="p">],</span>
                <span class="s1">&#39;exit_price&#39;</span><span class="p">:</span> <span class="n">price</span><span class="p">,</span>
                <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="n">position</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">],</span>
                <span class="s1">&#39;pnl&#39;</span><span class="p">:</span> <span class="n">pnl</span><span class="p">,</span>
                <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="n">reason</span>
            <span class="p">})</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">risk_manager</span><span class="o">.</span><span class="n">record_trade_result</span><span class="p">(</span><span class="n">pnl</span><span class="p">)</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log_trade</span><span class="p">({</span>
                <span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="s1">&#39;CLOSE&#39;</span><span class="p">,</span>
                <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span>
                <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="n">reason</span><span class="p">,</span>
                <span class="s1">&#39;pnl&#39;</span><span class="p">:</span> <span class="n">pnl</span>
            <span class="p">})</span>
            
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log_error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Close position failed&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)})</span>
    
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">interval_seconds</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">60</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Run the trading system.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Starting trading system, interval: </span><span class="si">{</span><span class="n">interval_seconds</span><span class="si">}</span><span class="s1">s&#39;</span><span class="p">)</span>
        
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">running</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">cycle_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">run_cycle</span><span class="p">()</span>
                
                <span class="c1"># Wait for next cycle</span>
                <span class="n">elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">cycle_start</span>
                <span class="n">sleep_time</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">interval_seconds</span> <span class="o">-</span> <span class="n">elapsed</span><span class="p">)</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">sleep_time</span><span class="p">)</span>
                
            <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Shutdown requested&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
                <span class="k">break</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log_error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Main loop error&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)})</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">shutdown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Graceful shutdown.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Shutting down...&#39;</span><span class="p">)</span>
        
        <span class="c1"># Close all positions</span>
        <span class="k">for</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="n">ticker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">market_data</span><span class="o">.</span><span class="n">get_ticker</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_close_position</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">ticker</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">],</span> <span class="s1">&#39;SHUTDOWN&#39;</span><span class="p">)</span>
        
        <span class="c1"># Generate final report</span>
        <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">performance</span><span class="o">.</span><span class="n">generate_report</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Shutdown complete&#39;</span><span class="p">)</span>
</code></pre><div class="code-output" id="output-cell-16-14"></div></div>
<div class="md-cell"><hr />
<h1>Part 8: Running the System</h1></div>
<div class="code-cell" id="cell-16-15" data-source="IyBFeGFtcGxlIHVzYWdlCmlmIF9fbmFtZV9fID09ICdfX21haW5fXyc6CiAgICAjIExvYWQgc2V0dGluZ3MKICAgIHNldHRpbmdzID0gU2V0dGluZ3MoKQogICAgCiAgICAjIENyZWF0ZSBzeXN0ZW0KICAgIHN5c3RlbSA9IENyeXB0b1RyYWRpbmdTeXN0ZW0oc2V0dGluZ3MpCiAgICAKICAgICMgSW5pdGlhbGl6ZQogICAgaWYgc3lzdGVtLmluaXRpYWxpemUoKToKICAgICAgICBwcmludCgnU3lzdGVtIGluaXRpYWxpemVkIHN1Y2Nlc3NmdWxseScpCiAgICAgICAgCiAgICAgICAgIyBSdW4gaW4gcGFwZXIgdHJhZGluZyBtb2RlIGZpcnN0IQogICAgICAgICMgc3lzdGVtLnJ1bihpbnRlcnZhbF9zZWNvbmRzPTYwKQogICAgICAgIAogICAgICAgICMgRm9yIHRlc3RpbmcsIGp1c3QgcnVuIG9uZSBjeWNsZQogICAgICAgIHN5c3RlbS5ydW5fY3ljbGUoKQogICAgICAgIAogICAgICAgICMgU2hvdyBwZXJmb3JtYW5jZQogICAgICAgIHByaW50KHN5c3RlbS5wZXJmb3JtYW5jZS5nZW5lcmF0ZV9yZXBvcnQoKSkKICAgIGVsc2U6CiAgICAgICAgcHJpbnQoJ0luaXRpYWxpemF0aW9uIGZhaWxlZCcp"><div class="cell-toolbar"><button class="copy-btn" onclick="copyCode(this)" type="button">Copy</button><button class="run-btn" onclick="runCell('cell-16-15')" type="button">Run</button></div><pre><code><span class="c1"># Example usage</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="c1"># Load settings</span>
    <span class="n">settings</span> <span class="o">=</span> <span class="n">Settings</span><span class="p">()</span>
    
    <span class="c1"># Create system</span>
    <span class="n">system</span> <span class="o">=</span> <span class="n">CryptoTradingSystem</span><span class="p">(</span><span class="n">settings</span><span class="p">)</span>
    
    <span class="c1"># Initialize</span>
    <span class="k">if</span> <span class="n">system</span><span class="o">.</span><span class="n">initialize</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;System initialized successfully&#39;</span><span class="p">)</span>
        
        <span class="c1"># Run in paper trading mode first!</span>
        <span class="c1"># system.run(interval_seconds=60)</span>
        
        <span class="c1"># For testing, just run one cycle</span>
        <span class="n">system</span><span class="o">.</span><span class="n">run_cycle</span><span class="p">()</span>
        
        <span class="c1"># Show performance</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">system</span><span class="o">.</span><span class="n">performance</span><span class="o">.</span><span class="n">generate_report</span><span class="p">())</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Initialization failed&#39;</span><span class="p">)</span>
</code></pre><div class="code-output" id="output-cell-16-15"></div></div>
<div class="md-cell"><hr />
<h1>ğŸ“‹ Capstone Checklist</h1>
<h2>Core Features</h2>
<ul>
<li>[ ] Multi-exchange connectivity (CCXT)</li>
<li>[ ] Real-time market data</li>
<li>[ ] Technical indicators (MA, RSI, Bollinger)</li>
<li>[ ] Multiple strategy support</li>
<li>[ ] Signal combination/weighting</li>
<li>[ ] Order execution with error handling</li>
<li>[ ] Position tracking</li>
<li>[ ] Stop loss/take profit management</li>
</ul>
<h2>Risk Management</h2>
<ul>
<li>[ ] Position sizing based on risk</li>
<li>[ ] Maximum position limits</li>
<li>[ ] Daily loss limits</li>
<li>[ ] Portfolio exposure limits</li>
</ul>
<h2>Monitoring</h2>
<ul>
<li>[ ] Trade logging</li>
<li>[ ] Performance tracking</li>
<li>[ ] Alert system</li>
<li>[ ] Performance reports</li>
</ul>
<h2>Advanced (Optional)</h2>
<ul>
<li>[ ] On-chain data integration</li>
<li>[ ] DeFi yield monitoring</li>
<li>[ ] Web dashboard (Streamlit)</li>
<li>[ ] Telegram/Discord alerts</li>
<li>[ ] Database storage</li>
<li>[ ] Backtesting framework</li>
</ul>
<hr />
<h1>ğŸ‰ Congratulations!</h1>
<p>You've completed the <strong>Crypto Algorithmic Trading</strong> course!</p>
<h2>What You've Learned:</h2>
<ol>
<li>Cryptocurrency market fundamentals</li>
<li>Data sourcing and technical analysis</li>
<li>On-chain analytics</li>
<li>Strategy development and backtesting</li>
<li>Risk management</li>
<li>Exchange API integration</li>
<li>DeFi protocols and DEX trading</li>
<li>Advanced strategies (funding, options, market making)</li>
<li>Production system development</li>
</ol>
<h2>Next Steps:</h2>
<ol>
<li><strong>Paper Trade</strong> - Run your system in paper trading mode</li>
<li><strong>Iterate</strong> - Improve strategies based on results</li>
<li><strong>Go Live</strong> - Start with small capital</li>
<li><strong>Continue Learning</strong> - Course 2 (Stocks), Course 3 (Quant Finance), Course 4 (ML)</li>
</ol></div>
        <div class="nav-buttons">
            <button class="nav-btn prev-btn disabled" type="button">
                <span class="nav-btn-label">â† Previous</span>
                <span class="nav-btn-name"></span>
            </button>
            <button class="nav-btn next-btn disabled" type="button">
                <span class="nav-btn-label">Next â†’</span>
                <span class="nav-btn-name"></span>
            </button>
        </div>
        </div>
    </main>

    <script>
        window.courseId = 'course1_crypto_trading';
        
// State
let currentModule = 0;
const modules = document.querySelectorAll('.module-section');
const sidebarItems = document.querySelectorAll('.sidebar-item');
const sidebar = document.querySelector('.sidebar');
const overlay = document.querySelector('.sidebar-overlay');
const headerModule = document.querySelector('.header-module');

function showModule(idx) {
    if (idx < 0 || idx >= modules.length) return;

    // Hide all, show target
    modules.forEach(m => m.classList.remove('active'));
    modules[idx].classList.add('active');

    // Update sidebar active state
    sidebarItems.forEach(s => s.classList.remove('active'));
    sidebarItems[idx].classList.add('active');

    // Update header
    const label = sidebarItems[idx].textContent.trim();
    if (headerModule) headerModule.textContent = label;

    // Update prev/next buttons
    updateNavButtons(idx);

    // Save & scroll
    currentModule = idx;
    try { localStorage.setItem(window.courseId + '_module', idx); } catch(e) {}
    window.scrollTo(0, 0);

    // Close sidebar on mobile
    closeSidebar();
}

function updateNavButtons(idx) {
    const section = modules[idx];
    const prevBtn = section.querySelector('.prev-btn');
    const nextBtn = section.querySelector('.next-btn');

    if (prevBtn) {
        // Clone to remove old listeners
        const newPrev = prevBtn.cloneNode(true);
        prevBtn.parentNode.replaceChild(newPrev, prevBtn);
        if (idx === 0) {
            newPrev.classList.add('disabled');
            newPrev.querySelector('.nav-btn-name').textContent = '';
        } else {
            newPrev.classList.remove('disabled');
            newPrev.querySelector('.nav-btn-name').textContent = sidebarItems[idx - 1].textContent.trim();
            newPrev.addEventListener('click', () => showModule(idx - 1));
        }
    }
    if (nextBtn) {
        const newNext = nextBtn.cloneNode(true);
        nextBtn.parentNode.replaceChild(newNext, nextBtn);
        if (idx === modules.length - 1) {
            newNext.classList.add('disabled');
            newNext.querySelector('.nav-btn-name').textContent = '';
        } else {
            newNext.classList.remove('disabled');
            newNext.querySelector('.nav-btn-name').textContent = sidebarItems[idx + 1].textContent.trim();
            newNext.addEventListener('click', () => showModule(idx + 1));
        }
    }
}

function toggleSidebar() {
    sidebar.classList.toggle('open');
    overlay.classList.toggle('open');
}

function closeSidebar() {
    sidebar.classList.remove('open');
    overlay.classList.remove('open');
}

// Copy code button
function copyCode(btn) {
    const cell = btn.closest('.code-cell');
    const code = cell.querySelector('pre code');
    if (!code) return;
    const text = code.textContent;
    navigator.clipboard.writeText(text).then(() => {
        btn.textContent = 'Copied';
        btn.classList.add('copied');
        setTimeout(() => { btn.textContent = 'Copy'; btn.classList.remove('copied'); }, 1500);
    }).catch(() => {
        const ta = document.createElement('textarea');
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand('copy');
        document.body.removeChild(ta);
        btn.textContent = 'Copied';
        btn.classList.add('copied');
        setTimeout(() => { btn.textContent = 'Copy'; btn.classList.remove('copied'); }, 1500);
    });
}

// ============================================================
// Pyodide Runtime
// ============================================================
let pyodideReady = false;
let pyodideLoading = false;
let pyodide = null;
const moduleNamespaces = {};

async function ensurePyodideScript() {
    if (window.loadPyodide) return;
    return new Promise((resolve, reject) => {
        const s = document.createElement('script');
        s.src = 'https://cdn.jsdelivr.net/pyodide/v0.27.5/full/pyodide.js';
        s.onload = resolve;
        s.onerror = () => reject(new Error('Failed to load Pyodide from CDN'));
        document.head.appendChild(s);
    });
}

async function initPyodide() {
    if (pyodideReady) return;
    if (pyodideLoading) {
        while (pyodideLoading) await new Promise(r => setTimeout(r, 100));
        return;
    }
    pyodideLoading = true;
    try {
        await ensurePyodideScript();
        pyodide = await loadPyodide({
            indexURL: 'https://cdn.jsdelivr.net/pyodide/v0.27.5/full/'
        });
        await pyodide.loadPackage(['numpy', 'pandas', 'scipy', 'matplotlib']);
        await pyodide.runPythonAsync(`
import matplotlib
matplotlib.use('AGG')
import matplotlib.pyplot as plt
import io, base64

def _finqt_show_plot():
    buf = io.BytesIO()
    plt.savefig(buf, format='png', dpi=100, bbox_inches='tight',
                facecolor='#0c0c14', edgecolor='none')
    buf.seek(0)
    img_b64 = base64.b64encode(buf.read()).decode('utf-8')
    buf.close()
    plt.close('all')
    return img_b64
`);
        pyodideReady = true;
    } catch (err) {
        console.error('Pyodide init failed:', err);
        throw err;
    } finally {
        pyodideLoading = false;
    }
}

function getModuleIdx(cellId) {
    return parseInt(cellId.split('-')[1]);
}

function getNamespace(moduleIdx) {
    if (!moduleNamespaces[moduleIdx]) {
        moduleNamespaces[moduleIdx] = pyodide.globals.get('dict')();
    }
    return moduleNamespaces[moduleIdx];
}

function escapeHtml(text) {
    const d = document.createElement('div');
    d.textContent = text;
    return d.innerHTML;
}

async function runCell(cellId) {
    const cellDiv = document.getElementById(cellId);
    if (!cellDiv) return;
    const runBtn = cellDiv.querySelector('.run-btn:not(.run-above-btn)');
    const outputDiv = document.getElementById('output-' + cellId);

    // Get source
    let source;
    const editor = cellDiv.querySelector('.code-editor');
    if (editor) {
        source = editor.value;
    } else {
        source = atob(cellDiv.dataset.source);
    }
    if (!source.trim()) return;

    // Loading state
    if (runBtn) { runBtn.classList.add('running'); runBtn.textContent = '...'; }
    outputDiv.innerHTML = '';
    outputDiv.classList.add('visible');

    try {
        if (!pyodideReady) {
            outputDiv.innerHTML = '<div class="pyodide-loading"><div class="spinner"></div>Loading Python environment...</div>';
            await initPyodide();
        }
        outputDiv.innerHTML = '<div class="pyodide-loading"><div class="spinner"></div>Running...</div>';

        const moduleIdx = getModuleIdx(cellId);
        const ns = getNamespace(moduleIdx);

        // Redirect stdout/stderr
        await pyodide.runPythonAsync(`
import sys, io
sys.stdout = io.StringIO()
sys.stderr = io.StringIO()
`, { globals: ns });

        // Handle plt.show()
        const hasPlot = source.includes('plt.show()');
        let execSource = source;
        if (hasPlot) {
            execSource = source.replace(/plt\.show\(\)/g, '_finqt_plot_data = _finqt_show_plot()');
        }

        let result;
        try {
            result = await pyodide.runPythonAsync(execSource, { globals: ns });
        } catch (pyErr) {
            await pyodide.runPythonAsync('sys.stdout = sys.__stdout__; sys.stderr = sys.__stderr__', { globals: ns });
            outputDiv.innerHTML = '<span class="error">' + escapeHtml(pyErr.message) + '</span>';
            return;
        }

        // Collect output
        const stdout = await pyodide.runPythonAsync('sys.stdout.getvalue()', { globals: ns });
        const stderr = await pyodide.runPythonAsync('sys.stderr.getvalue()', { globals: ns });
        await pyodide.runPythonAsync('sys.stdout = sys.__stdout__; sys.stderr = sys.__stderr__', { globals: ns });

        let outputHtml = '';
        if (stdout) outputHtml += escapeHtml(stdout);
        if (stderr) outputHtml += '<span class="error">' + escapeHtml(stderr) + '</span>';

        if (hasPlot) {
            try {
                const plotData = await pyodide.runPythonAsync('_finqt_plot_data', { globals: ns });
                if (plotData) {
                    outputHtml += '<img class="plot-image" src="data:image/png;base64,' + plotData + '" alt="Plot">';
                }
            } catch (e) {}
        }

        // Show expression result (like Jupyter)
        if (!stdout && result !== undefined && result !== null) {
            const rs = String(result);
            if (rs && rs !== 'None' && rs !== 'undefined') {
                outputHtml += escapeHtml(rs);
            }
        }

        if (outputHtml) {
            outputDiv.innerHTML = outputHtml;
        } else {
            outputDiv.innerHTML = '';
            outputDiv.classList.remove('visible');
        }
    } catch (err) {
        outputDiv.innerHTML = '<span class="error">Error: ' + escapeHtml(err.message) + '</span>';
    } finally {
        if (runBtn) { runBtn.classList.remove('running'); runBtn.textContent = 'Run'; }
    }
}

function resetCell(cellId) {
    const cellDiv = document.getElementById(cellId);
    if (!cellDiv) return;
    const editor = cellDiv.querySelector('.code-editor');
    const outputDiv = document.getElementById('output-' + cellId);
    if (editor && cellDiv.dataset.originalSource) {
        editor.value = atob(cellDiv.dataset.originalSource);
    }
    if (outputDiv) {
        outputDiv.innerHTML = '';
        outputDiv.classList.remove('visible');
    }
}

async function runAllAbove(cellId) {
    const moduleIdx = getModuleIdx(cellId);
    const moduleSection = document.querySelector('.module-section[data-idx="' + moduleIdx + '"]');
    if (!moduleSection) return;
    const allCells = moduleSection.querySelectorAll('.code-cell');
    for (const cell of allCells) {
        if (cell.id === cellId) break;
        await runCell(cell.id);
    }
}

// Tab key inserts spaces in code editors
document.addEventListener('keydown', function(e) {
    if (e.key === 'Tab' && e.target.classList.contains('code-editor')) {
        e.preventDefault();
        const ta = e.target;
        const start = ta.selectionStart;
        const end = ta.selectionEnd;
        ta.value = ta.value.substring(0, start) + '    ' + ta.value.substring(end);
        ta.selectionStart = ta.selectionEnd = start + 4;
    }
});

// Init: bind sidebar items
sidebarItems.forEach((item, idx) => {
    item.addEventListener('click', () => showModule(idx));
});

// Restore last viewed module
document.addEventListener('DOMContentLoaded', () => {
    let saved = 0;
    try { saved = parseInt(localStorage.getItem(window.courseId + '_module')) || 0; } catch(e) {}
    if (saved >= 0 && saved < modules.length) {
        showModule(saved);
    } else {
        showModule(0);
    }
});

// Keyboard navigation (only when not in a textarea)
document.addEventListener('keydown', (e) => {
    if (e.target.tagName === 'TEXTAREA') return;
    if (e.key === 'ArrowLeft' && currentModule > 0) showModule(currentModule - 1);
    if (e.key === 'ArrowRight' && currentModule < modules.length - 1) showModule(currentModule + 1);
    if (e.key === 'Escape') closeSidebar();
});

    </script>
</body>
</html>